using BarcodeLib;
using ClosedXML.Excel;
using Com.Mayaminer;
using Newtonsoft.Json;
using NIS.Data;
using NIS.Models;
using NIS.UtilTool;
using NuGet;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Drawing.Imaging;
using System.IO;
using System.Linq;
using System.Runtime.Serialization;
using System.Web.Mvc;
using System.Web.Script.Serialization;
using static NIS.Models.Obstetrics;

namespace NIS.Controllers
{
    public class ObstetricsController : BaseController
    {
        private string DirectUrl;
        private CommData cd;    //常用資料Module
        Obstetrics obs_m = new Obstetrics();
        private DBConnector link;
        private HISViewController his;
        private PdfEMRController PdfEmr;

        public ObstetricsController()
        {
            this.cd = new CommData();
            this.link = new DBConnector();
            this.DirectUrl = AppDomain.CurrentDomain.BaseDirectory;
            PdfEmr = new PdfEMRController();
            this.his = new HISViewController();
        }

        #region 首頁
        public ActionResult Index(string active, string mode, string show, string Type)
        {
            if (Session["PatInfo"] != null)
            {
                ViewBag.RootDocument = GetSourceUrl();
                DataTable dt_His = obs_m.sel_bthhis(ptinfo.FeeNo);
                DataTable dt_Chid_Birth = obs_m.sel_bthsta(ptinfo.FeeNo);
                DataTable dt_Chid_NB = obs_m.sel_nb(ptinfo.FeeNo);
                GAssessment GAssessmentInfo = new GAssessment();
                if (dt_Chid_Birth.Rows.Count > 0)
                {
                    var sta_rows = dt_Chid_Birth.Rows[0];
                    GAssessmentInfo.GP = sta_rows["PARITY_N"].ToString();
                    GAssessmentInfo.LBTotalN = sta_rows["LB_TOTAL_N"].ToString();

                    GAssessmentInfo.GWeek = sta_rows["GEST_M"].ToString() + "+" + sta_rows["GEST_D"].ToString();
                    if (sta_rows["RFM_TIME"].ToString() != "")
                        GAssessmentInfo.GRFMTime = Convert.ToDateTime(sta_rows["RFM_TIME"]).ToString("yyyy/MM/dd HH:mm");
                    if (sta_rows["BIRTH"].ToString() != "" && sta_rows["RFM_TIME"].ToString() != "")
                    {
                        var GRuptureTime = Convert.ToDateTime(sta_rows["BIRTH"]).Subtract(Convert.ToDateTime(sta_rows["RFM_TIME"]));
                        GAssessmentInfo.GRuptureTime = GRuptureTime.Days.ToString() + "天" + GRuptureTime.Hours.ToString() + "小時" + GRuptureTime.Minutes.ToString() + "分鐘" + GRuptureTime.Seconds.ToString() + "秒";
                    }
                    if (sta_rows["PAIN_ST"].ToString() != "")
                        GAssessmentInfo.GThroeTime = Convert.ToDateTime(sta_rows["PAIN_ST"]).ToString("yyyy/MM/dd HH:mm");
                    if (sta_rows["CERFO_TIME"].ToString() != "")
                        GAssessmentInfo.GCervicalTime = Convert.ToDateTime(sta_rows["CERFO_TIME"]).ToString("yyyy/MM/dd HH:mm");
                    if (sta_rows["DOP_TIME"].ToString() != "")
                        GAssessmentInfo.GPlacentaTime = Convert.ToDateTime(sta_rows["DOP_TIME"]).ToString("yyyy/MM/dd HH:mm");
                    if (sta_rows["CERFO_TIME"].ToString() != "" && sta_rows["PAIN_ST"].ToString() != "")
                    {
                        var GOneBth = Convert.ToDateTime(sta_rows["CERFO_TIME"]).Subtract(Convert.ToDateTime(sta_rows["PAIN_ST"]));
                        GAssessmentInfo.GOneBth = GOneBth.Days.ToString() + "天" + GOneBth.Hours.ToString() + "小時" + GOneBth.Minutes.ToString() + "分鐘" + GOneBth.Seconds.ToString() + "秒";
                    }
                    if (sta_rows["BIRTH"].ToString() != "" && sta_rows["CERFO_TIME"].ToString() != "")
                    {
                        var GTwoBth = Convert.ToDateTime(sta_rows["BIRTH"]).Subtract(Convert.ToDateTime(sta_rows["CERFO_TIME"]));
                        GAssessmentInfo.GTwoBth = GTwoBth.Days.ToString() + "天" + GTwoBth.Hours.ToString() + "小時" + GTwoBth.Minutes.ToString() + "分鐘" + GTwoBth.Seconds.ToString() + "秒";
                    }
                    if (sta_rows["DOP_TIME"].ToString() != "" && sta_rows["BIRTH"].ToString() != "")
                    {
                        var GThreeBth = Convert.ToDateTime(sta_rows["DOP_TIME"]).Subtract(Convert.ToDateTime(sta_rows["BIRTH"]));
                        GAssessmentInfo.GThreeBth = GThreeBth.Days.ToString() + "天" + GThreeBth.Hours.ToString() + "小時" + GThreeBth.Minutes.ToString() + "分鐘" + GThreeBth.Seconds.ToString() + "秒";
                    }
                    if (sta_rows["DOP_TIME"].ToString() != "" && sta_rows["PAIN_ST"].ToString() != "")
                    {
                        var GTotalBth = Convert.ToDateTime(sta_rows["DOP_TIME"]).Subtract(Convert.ToDateTime(sta_rows["PAIN_ST"]));
                        GAssessmentInfo.GTotalBth = GTotalBth.Days.ToString() + "天" + GTotalBth.Hours.ToString() + "小時" + GTotalBth.Minutes.ToString() + "分鐘" + GTotalBth.Seconds.ToString() + "秒";
                    }
                }

                if (dt_His.Rows.Count > 0)
                {
                    var his_rows = dt_His.Rows[0];
                    {
                        if (his_rows["EDC"].ToString() != "")
                            GAssessmentInfo.GExpectedDate = Convert.ToDateTime(his_rows["EDC"]).ToString("yyyy/MM/dd");
                        GAssessmentInfo.GG = his_rows["GRAVIDA"].ToString();
                    }
                }

                byte[] BaByPatInfolistByteCode = webService.GetBaByPatInfo(ptinfo?.FeeNo);
                if (BaByPatInfolistByteCode == null)
                    GAssessmentInfo.GPREG = "";
                else
                {
                    string listJsonArray = CompressTool.DecompressString(BaByPatInfolistByteCode);
                    BaByPatInfo_FeeNo[] baByPatInfo = JsonConvert.DeserializeObject<BaByPatInfo_FeeNo[]>(listJsonArray);
                    GAssessmentInfo.GPREG = baByPatInfo[0].PATPregnancy;
                }

                if (dt_Chid_NB.Rows.Count > 0)
                {
                    var CHILD_SENT = new List<string>();
                    var BIRTH_TYPE = new List<string>();
                    var BIRTH_TIME = new List<string>();
                    foreach (DataRow i in dt_Chid_NB.Rows)
                    {
                        #region 新生兒動向
                        if (i["CHILD_SENT"].ToString() == "0")
                            CHILD_SENT.Add("嬰兒室");
                        if (i["CHILD_SENT"].ToString() == "1")
                            CHILD_SENT.Add("PICU-" + i["CHILD_SENT_MEMO"].ToString());
                        if (i["CHILD_SENT"].ToString() == "2")
                            CHILD_SENT.Add("NBC-" + i["CHILD_SENT_MEMO"].ToString());
                        if (i["CHILD_SENT"].ToString() == "3")
                            CHILD_SENT.Add("太平間");
                        if (i["CHILD_SENT"].ToString() == "4")
                            CHILD_SENT.Add("家屬帶回");
                        #endregion

                        #region 生產方式
                        if (i["BIRTH_TYPE"].ToString() == "0")
                            BIRTH_TYPE.Add("NSD");
                        if (i["BIRTH_TYPE"].ToString() == "1")
                            BIRTH_TYPE.Add("C/S");
                        #endregion

                        if (i["BIRTH_DAY"].ToString() != "")
                            BIRTH_TIME.Add(Convert.ToDateTime(i["BIRTH_DAY"]).ToString("yyyy/MM/dd HH:mm"));
                    }
                    GAssessmentInfo.CHILD_SENT = String.Join(",", CHILD_SENT);
                    GAssessmentInfo.BirthType = String.Join(",", BIRTH_TYPE);
                    GAssessmentInfo.GBirthTime = String.Join(",", BIRTH_TIME);
                }

                if (ptinfo.Age > 1)
                {
                    if (mode != "" && mode != null)
                        ViewBag.active = $"{((active == null) ? "Instantly_Be_Birth_List" : active)}?mode={mode}?show={((show == "") ? "Y" : show)}"; /*Instantly_Be_Birth_List*/
                    else if (Type != "" && Type != null)
                        ViewBag.active = $"{((active == null) ? "Instantly_Be_Birth_List" : active)}?Type={Type}?show={((show == "") ? "Y" : show)}"; /*Instantly_Be_Birth_List*/
                    else
                        ViewBag.active = $"{((active == null) ? "Instantly_Be_Birth_List" : active)}"; /*Instantly_Be_Birth_List*/
                }
                else if (ptinfo.Age < 1)
                {
                    if (mode != "" && mode != null)
                        ViewBag.active = $"{((active == null) ? "Partial_Child_Brith" : active)}?mode={mode}?show={((show == "") ? "N" : show)}";
                    else if (Type != "" && Type != null)
                        ViewBag.active = $"{((active == null) ? "Partial_Child_Brith" : active)}?Type={Type}?show={((show == "") ? "Y" : show)}";
                    else
                        ViewBag.active = (active == null) ? "Partial_Child_Brith" : active;
                }
                ViewData["GAData"] = GAssessmentInfo;
                ViewBag.feeno = ptinfo.FeeNo;//20150506 列印
                ViewBag.userno = userinfo.EmployeesNo;//20190821 簽章用
                ViewBag.age = ptinfo.Age;
                ViewBag.assessment = ptinfo.Assessment;
                ViewBag.mode = mode;
                if (active == null && show == null)
                {
                    ViewBag.show = "Y";
                    if (ptinfo.Age < 1 || (ptinfo.Age >= 1 && ptinfo.Assessment == "E"))
                        ViewBag.show = "N";
                }
                else
                    ViewBag.show = show;

                #region 是否簽章提示
                if (dt_Chid_Birth != null && dt_Chid_Birth.Rows.Count > 0)
                {
                    if (dt_Chid_Birth.Rows[0]["EMR_SIGN"].ToString() != "" && dt_Chid_Birth.Rows[0]["EMR_TIME"].ToString() != "")
                        ViewBag.STAEMR = "1";
                    else
                        ViewBag.STAEMR = "0";
                }
                else
                    ViewBag.STAEMR = "0";

                if (ptinfo.Age < 1)
                {
                    DataTable dt_nb = obs_m.sel_nb("", ptinfo.ChartNo);
                    if (dt_nb != null && dt_nb.Rows.Count > 0)
                    {
                        var r = dt_nb.Rows[0];
                        if (r["EMR_SIGN"].ToString() != "" && r["EMR_TIME"].ToString() != "")
                            ViewBag.NBEMR = "1";
                        else
                            ViewBag.NBEMR = "0";
                    }
                    else
                        ViewBag.NBEMR = "0";
                }
                else
                {
                    ViewBag.NBEMR = "0";
                    DataTable dt_nb = obs_m.sel_nb(ptinfo.FeeNo);
                    if (dt_nb != null && dt_nb.Rows.Count > 0)
                    {
                        foreach (DataRow r in dt_nb.Rows)
                        {
                            if (r["EMR_SIGN"].ToString() != "" && r["EMR_TIME"].ToString() != "")
                            {
                                ViewBag.NBEMR = "1";
                            }
                        }
                    }
                    else
                    {
                        ViewBag.NBEMR = "0";
                    }
                }

                #endregion
                return View();
            }

            Response.Write("<script>alert('請重新選擇病患');</script>");
            return new EmptyResult();
        }
        #endregion

        #region GetPatInfo取得執行輸入資訊
        /// <summary>
        /// 呼叫WebService取得執行輸入資訊
        /// </summary>
        /// <param name="userno"></param>
        /// <returns></returns>
        public string Get_PatInfo(string IID)
        {
            byte[] listByteCode = webService.GetPatInfo(IID);
            if (listByteCode == null)
                return "";
            else
            {
                string listJsonArray = CompressTool.DecompressString(listByteCode);
                BaByPatInfo_IID[] patinfo = JsonConvert.DeserializeObject<BaByPatInfo_IID[]>(listJsonArray);
                return JsonConvert.SerializeObject(patinfo[0]);
            }
        }

        public string Get_PatInfo1(string ChartNo, bool isShowJson = false)
        {
            byte[] listByteCode = webService.GetPatInfo1(ChartNo);
            if (listByteCode == null)
                return "";
            else
            {
                string listJsonArray = CompressTool.DecompressString(listByteCode);
                if (isShowJson)
                    return listJsonArray;
                else
                {
                    BaByPatInfo_IID[] patinfo = JsonConvert.DeserializeObject<BaByPatInfo_IID[]>(listJsonArray);
                    return JsonConvert.SerializeObject(patinfo[0]);
                }
            }
        }
        #endregion

        #region GetBaByPatInfo取得產婦資訊
        public string Get_BaByPatInfo(string feeNo)
        {
            //GetBaByPatInfo
            byte[] BaByPatInfolistByteCode = webService.GetBaByPatInfo(feeNo);
            if (BaByPatInfolistByteCode == null)
                return "";
            else
            {
                string listJsonArray = CompressTool.DecompressString(BaByPatInfolistByteCode);
                BaByPatInfo_FeeNo[] baByPatInfo = JsonConvert.DeserializeObject<BaByPatInfo_FeeNo[]>(listJsonArray);
                return JsonConvert.SerializeObject(baByPatInfo[0]);
            }
        }
        #endregion

        #region GetBaByMatInfo取得配偶資訊
        public string Get_BabyMatInfo(string IID)
        {
            byte[] listByteCode = webService.GetBaByMatInfo(IID);
            if (listByteCode == null)
                return "";
            else
            {
                string listJsonArray = CompressTool.DecompressString(listByteCode);
                BaByMatInfo[] patinfo = JsonConvert.DeserializeObject<BaByMatInfo[]>(listJsonArray);
                if (patinfo != null && patinfo.Count() > 0)
                {
                    patinfo[0].PATBirthday = patinfo[0].PATBirthday.ToString();
                }
                return JsonConvert.SerializeObject(patinfo[0]);
            }
        }
        #endregion

        #region GetINSPTList 檢驗院所代碼對應
        public string Get_INSPTList(string INSPTNo)
        {
            byte[] INSPTListByteCode = webService.GetINSPTList();
            if (INSPTListByteCode == null)
                return "";
            else
            {
                string listJsonArray = CompressTool.DecompressString(INSPTListByteCode);
                INSPTList[] iNSPTList = JsonConvert.DeserializeObject<INSPTList[]>(listJsonArray);
                return iNSPTList.Where(x => x.INSPTNo.Trim() == INSPTNo.Trim()).FirstOrDefault()?.INSPTName.Trim();
            }
        }
        #endregion

        #region 檢驗院所代碼開窗選擇
        /// <summary>
        /// 檢驗院所代碼開窗選擇
        /// </summary>
        /// <param name="page"></param>
        /// <param name="value"></param>
        /// <returns></returns>
        public ActionResult Select_INSPT_List(string name, string INSPTNo, string INSPTName)
        {
            if (IsNoEmpty(INSPTNo) || IsNoEmpty(INSPTName))
            {
                byte[] INSPTListByteCode = webService.GetINSPTList();
                if (INSPTListByteCode == null)
                    ViewBag.dt = "";
                else
                {
                    string listJsonArray = CompressTool.DecompressString(INSPTListByteCode);
                    INSPTList[] iNSPTList = JsonConvert.DeserializeObject<INSPTList[]>(listJsonArray);

                    if (IsNoEmpty(INSPTNo) && IsNoEmpty(INSPTName))
                    {
                        iNSPTList = iNSPTList.Where(x => x.INSPTNo.Trim().Contains(INSPTNo.Trim()) || x.INSPTName.Trim().Contains(INSPTName.Trim())).ToArray();
                        ViewBag.dt = iNSPTList;
                    }
                    else
                    {
                        if (IsNoEmpty(INSPTNo))
                            iNSPTList = iNSPTList.Where(x => x.INSPTNo.Trim().Contains(INSPTNo.Trim())).ToArray();
                        else if (IsNoEmpty(INSPTName))
                            iNSPTList = iNSPTList.Where(x => x.INSPTName.Trim().Contains(INSPTName.Trim())).ToArray();
                        ViewBag.dt = iNSPTList;
                    }
                }
            }

            ViewBag.INSPTNo = INSPTNo;
            ViewBag.INSPTName = INSPTName;
            ViewBag.name = name;
            return View();
        }
        #endregion

        #region 居住地開窗選擇
        /// <summary>
        /// 居住地開窗選擇
        /// </summary>
        /// <param name="name"></param>
        /// <returns></returns>
        public ActionResult Select_AREA_List(string name, string AREAName)
        {
            if (IsNoEmpty(AREAName))
            {
                DataTable dt = obs_m.sel_v_area(AREAName);
                ViewBag.dt = dt;
            }
            ViewBag.AREAName = AREAName;
            ViewBag.name = name;
            return View();
        }
        #endregion

        #region UserName取得員工姓名
        /// <summary>
        /// 呼叫WebService取得員工姓名
        /// </summary>
        /// <param name="userno"></param>
        /// <returns></returns>
        public string Get_Employee_Name(string userno)
        {
            byte[] listByteCode = webService.UserName(userno);
            if (listByteCode == null)
                return "";
            string listJsonArray = CompressTool.DecompressString(listByteCode);
            UserInfo user = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
            return user.EmployeesName;
        }
        #endregion

        #region 取得病人資訊
        /// <summary>
        /// 呼叫WebService取得病人資訊
        /// </summary>
        /// <param name="userno"></param>
        /// <returns></returns>
        public PatientInfo Get_Patient_Info(string feeno)
        {
            byte[] listByteCode = webService.GetPatientInfo(feeno);
            if (listByteCode == null)
                return null;
            string listJsonArray = CompressTool.DecompressString(listByteCode);
            PatientInfo user = JsonConvert.DeserializeObject<PatientInfo>(listJsonArray);
            return user;
        }
        #endregion

        #region UserName取得員工資訊
        /// <summary>
        /// 呼叫WebService取得員工資訊
        /// </summary>
        /// <param name="userno"></param>
        /// <returns></returns>
        public UserInfo Get_Employee_Info(string userno)
        {
            byte[] listByteCode = webService.UserName(userno);
            if (listByteCode == null)
                return null;
            string listJsonArray = CompressTool.DecompressString(listByteCode);
            UserInfo user = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
            return user;
        }
        #endregion


        #region 執行檢查畫面
        public ActionResult Production(string mode, FormCollection form)
        {
            ViewBag.mode = mode;
            ViewBag.ptinfo = ptinfo;

            var sDT = Convert.ToDateTime(DateTime.Now.ToString("yyyy/MM/dd 00:00"));
            var eDT = DateTime.Now;

            if (form["TXT_Q_CHECKST_DAY"] != null && form["TXT_Q_CHECKST_DAY"] != "" && form["TXT_Q_CHECKST_TIME"] != null && form["TXT_Q_CHECKST_TIME"] != "")
                sDT = Convert.ToDateTime(form["TXT_Q_CHECKST_DAY"] + " " + form["TXT_Q_CHECKST_TIME"]);
            if (form["TXT_Q_CHECKET_DAY"] != null && form["TXT_Q_CHECKET_DAY"] != "" && form["TXT_Q_CHECKET_TIME"] != null && form["TXT_Q_CHECKET_TIME"] != "")
                eDT = Convert.ToDateTime(form["TXT_Q_CHECKET_DAY"] + " " + form["TXT_Q_CHECKET_TIME"]);
            DataTable dt = obs_m.sel_exechk("", form["TXT_Q_PP_CHARTNO"], form["TXT_Q_PP_ID"], sDT, eDT);
            ViewBag.dt = set_dt(dt);

            #region 回帶查詢的值
            if (form["TXT_Q_CHECKST_DAY"] != null && form["TXT_Q_CHECKST_TIME"] != null && form["TXT_Q_CHECKET_DAY"] != null && form["TXT_Q_CHECKET_TIME"] != null)
            {
                ViewBag.PageJs = $@"
	$('#TXT_Q_PP_CHARTNO').val('{form["TXT_Q_PP_CHARTNO"]}');
	$('#TXT_Q_PP_ID').val('{form["TXT_Q_PP_ID"]}');
	$('#TXT_Q_CHECKST_DAY').val('{form["TXT_Q_CHECKST_DAY"]}');
	$('#TXT_Q_CHECKST_TIME').val('{form["TXT_Q_CHECKST_TIME"]}');
	$('#TXT_Q_CHECKET_DAY').val('{form["TXT_Q_CHECKET_DAY"]}');
	$('#TXT_Q_CHECKET_TIME').val('{form["TXT_Q_CHECKET_TIME"]}');";
            }
            else
            {
                ViewBag.PageJs = $@"
	$('#TXT_Q_PP_CHARTNO').val('{form["TXT_Q_PP_CHARTNO"]}');
	$('#TXT_Q_PP_ID').val('{form["TXT_Q_PP_ID"]}');";
            }
            #endregion

            return View();
        }
        #endregion

        #region 執行檢查輸入畫面
        public ActionResult Upd_Production(string IID)
        {
            if (IID != "")
            {
                DataTable dt = obs_m.sel_exechk("", "", "", null, null, IID);
                ViewBag.dt = set_dt(dt);
            }
            return View();
        }
        #endregion

        #region 執行檢查輸入新增
        public ActionResult Insert_Production(FormCollection form)
        {
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo?.FeeNo;
            string id = base.creatid("OBS_EXECHK", userno, feeno, "0");
            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("IID", id, DBItem.DBDataType.String)); //序號
            insertDataList.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String)); //批價序號
            insertDataList.Add(new DBItem("PP_FROM", form["DDL_PP_FROM"], DBItem.DBDataType.String)); //病患來源
            insertDataList.Add(new DBItem("PP_CHARTNO", form["TXT_PP_CHARTNO"], DBItem.DBDataType.String)); //病歷號
            insertDataList.Add(new DBItem("PP_ID", form["TXT_PP_ID"], DBItem.DBDataType.String)); //身分證字號
            insertDataList.Add(new DBItem("PP_NAME", form["TXT_PP_NAME"], DBItem.DBDataType.String)); //姓名
            insertDataList.Add(new DBItem("PP_BD", form["TXT_PP_BD"], DBItem.DBDataType.DataTime)); //出生日期

            insertDataList.Add(new DBItem("PP_ADD", form["TXT_PP_ADD"], DBItem.DBDataType.String)); //聯絡地址
            insertDataList.Add(new DBItem("PP_TEL", form["TXT_PP_TEL"], DBItem.DBDataType.String)); //電話

            insertDataList.Add(new DBItem("CHECKST", form["TXT_CHECKST_DAY"] + " " + form["TXT_CHECKST_TIME"], DBItem.DBDataType.DataTime)); //開始日期時間
            insertDataList.Add(new DBItem("CHECKET", form["TXT_CHECKET_DAY"] + " " + form["TXT_CHECKET_TIME"], DBItem.DBDataType.DataTime)); //結束日期時間
            insertDataList.Add(new DBItem("PP_CHECKITEM", form["DDL_PP_CHECKITEM"], DBItem.DBDataType.String)); //檢查項目
            string PP_CHECKITEM = form["DDL_PP_CHECKITEM"]; //檢查項目

            if (PP_CHECKITEM != "" && PP_CHECKITEM == "1")
            { //[檢查項目]為「胎心音檢視」時填寫

                insertDataList.Add(new DBItem("REP1_FH_FH1", form["TXT_REP1_FH_FH1"], DBItem.DBDataType.String));//胎心音1
                insertDataList.Add(new DBItem("REP1_FH_FH2", form["TXT_REP1_FH_FH2"], DBItem.DBDataType.String));//胎心音2
                insertDataList.Add(new DBItem("REP1_FH_FHT", form["RB_REP1_FH_FHT"], DBItem.DBDataType.String));//胎心音減速型態

                insertDataList.Add(new DBItem("REP1_FH_FH1_2", form["TXT_REP1_FH_FH1_2"], DBItem.DBDataType.String));//胎心音1
                insertDataList.Add(new DBItem("REP1_FH_FH2_2", form["TXT_REP1_FH_FH2_2"], DBItem.DBDataType.String));//胎心音2
                insertDataList.Add(new DBItem("REP1_FH_FHT_2", form["RB_REP1_FH_FHT_2"], DBItem.DBDataType.String));//胎心音減速型態

                insertDataList.Add(new DBItem("REP1_FH_UCDU1", form["TXT_REP1_FH_UCDU1"], DBItem.DBDataType.String));//宮縮持續時間1
                insertDataList.Add(new DBItem("REP1_FH_UCDU2", form["TXT_REP1_FH_UCDU2"], DBItem.DBDataType.String));//宮縮持續時間2
                insertDataList.Add(new DBItem("REP1_FH_UCINT1", form["TXT_REP1_FH_UCINT1"], DBItem.DBDataType.String));//宮縮間隔時間1
                insertDataList.Add(new DBItem("REP1_FH_UCINT2", form["TXT_REP1_FH_UCINT2"], DBItem.DBDataType.String));//宮縮間隔時間2
                insertDataList.Add(new DBItem("REP1_FH_UCSTR", form["RB_REP1_FH_UCSTR"], DBItem.DBDataType.String));//宮縮強度
                insertDataList.Add(new DBItem("REP1_FH_UCE", form["RB_REP1_FH_UCE"], DBItem.DBDataType.String));//子宮頸擴張1
                insertDataList.Add(new DBItem("REP1_FH_UCT", form["RB_REP1_FH_UCT"], DBItem.DBDataType.String));//子宮頸變薄1
                insertDataList.Add(new DBItem("REP1_FH_UCH", form["RB_REP1_FH_UCH"], DBItem.DBDataType.String));//子宮頸高度1
                insertDataList.Add(new DBItem("REP1_FH_ROM", form["RB_REP1_FH_ROM"], DBItem.DBDataType.String));//破水1


                insertDataList.Add(new DBItem("REP2_FH_FH1", form["TXT_REP2_FH_FH1"], DBItem.DBDataType.String));//胎心音1
                insertDataList.Add(new DBItem("REP2_FH_FH2", form["TXT_REP2_FH_FH2"], DBItem.DBDataType.String));//胎心音2
                insertDataList.Add(new DBItem("REP2_FH_FHT", form["RB_REP2_FH_FHT"], DBItem.DBDataType.String));//胎心音減速型態

                insertDataList.Add(new DBItem("REP2_FH_FH1_2", form["TXT_REP2_FH_FH1_2"], DBItem.DBDataType.String));//胎心音1
                insertDataList.Add(new DBItem("REP2_FH_FH2_2", form["TXT_REP2_FH_FH2_2"], DBItem.DBDataType.String));//胎心音2
                insertDataList.Add(new DBItem("REP2_FH_FHT_2", form["RB_REP2_FH_FHT_2"], DBItem.DBDataType.String));//胎心音減速型態

                insertDataList.Add(new DBItem("REP2_FH_UCDU1", form["TXT_REP2_FH_UCDU1"], DBItem.DBDataType.String));//宮縮持續時間1
                insertDataList.Add(new DBItem("REP2_FH_UCDU2", form["TXT_REP2_FH_UCDU2"], DBItem.DBDataType.String));//宮縮持續時間2
                insertDataList.Add(new DBItem("REP2_FH_UCINT1", form["TXT_REP2_FH_UCINT1"], DBItem.DBDataType.String));//宮縮間隔時間1
                insertDataList.Add(new DBItem("REP2_FH_UCINT2", form["TXT_REP2_FH_UCINT2"], DBItem.DBDataType.String));//宮縮間隔時間2
                insertDataList.Add(new DBItem("REP2_FH_UCSTR", form["RB_REP2_FH_UCSTR"], DBItem.DBDataType.String));//宮縮強度
                insertDataList.Add(new DBItem("REP2_FH_UCE", form["RB_REP2_FH_UCE"], DBItem.DBDataType.String));//子宮頸擴張1
                insertDataList.Add(new DBItem("REP2_FH_UCT", form["RB_REP2_FH_UCT"], DBItem.DBDataType.String));//子宮頸變薄1
                insertDataList.Add(new DBItem("REP2_FH_UCH", form["RB_REP2_FH_UCH"], DBItem.DBDataType.String));//子宮頸高度1
                insertDataList.Add(new DBItem("REP2_FH_ROM", form["RB_REP2_FH_ROM"], DBItem.DBDataType.String));//破水1
            }
            if (PP_CHECKITEM != "" && PP_CHECKITEM != "1")
            {
                insertDataList.Add(new DBItem("CHECK_REP1", form["TXT_CHECK_REP1"], DBItem.DBDataType.String));//檢查結果1
                insertDataList.Add(new DBItem("CHECK_REP2", form["TXT_CHECK_REP2"], DBItem.DBDataType.String));//檢查結果2
            }
            if (PP_CHECKITEM != "" && PP_CHECKITEM == "5")
            {
                insertDataList.Add(new DBItem("PP_CHECKOTH", form["TXT_PP_CHECKOTH"], DBItem.DBDataType.String));
            }
            insertDataList.Add(new DBItem("PP_TO", form["DDL_PP_TO"], DBItem.DBDataType.String));//病患動向
            string PP_TO = form["DDL_PP_TO"]; //病患動向
            if (PP_TO == "9")
            { //[病患動向]選擇其他
                insertDataList.Add(new DBItem("PP_TO_OTH", form["TXT_PP_TO_OTH"], DBItem.DBDataType.String));//病患動向-其他
            }
            insertDataList.Add(new DBItem("PP_TO_MEMO", form["TXT_PP_TO_MEMO"], DBItem.DBDataType.String)); //病患動向備註
            insertDataList.Add(new DBItem("CREATNO", userno, DBItem.DBDataType.String)); //建立者員編
            insertDataList.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間

            insertDataList.Add(new DBItem("UPDNO", userno, DBItem.DBDataType.String)); //更新者員編
            insertDataList.Add(new DBItem("RECORDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間
            insertDataList.Add(new DBItem("UPDTIME", null, DBItem.DBDataType.DataTime)); //更新時間

            insertDataList.Add(new DBItem("RECORD", null, DBItem.DBDataType.String)); //內容
            insertDataList.Add(new DBItem("DELETED", null, DBItem.DBDataType.String)); //刪除註記
            insertDataList = setNullToEmpty(insertDataList);
            int erow = obs_m.DBExecInsert("OBS_EXECHK", insertDataList);
            if (erow > 0)
                Response.Write("<script>alert('新增成功');window.location.href='Production?mode=0'</script>");
            else
                Response.Write("<script>alert('新增失敗');window.location.href='Production?mode=0'</script>");
            return new EmptyResult();
        }
        #endregion

        #region 執行檢查輸入編輯
        [HttpPost]
        public ActionResult Upd_Production(FormCollection form)
        {
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo?.FeeNo;
            string id_list = form["IID"];

            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("PP_FROM", form["DDL_PP_FROM"], DBItem.DBDataType.String)); //病患來源
            insertDataList.Add(new DBItem("PP_CHARTNO", form["TXT_PP_CHARTNO"], DBItem.DBDataType.String)); //病歷號
            insertDataList.Add(new DBItem("PP_ID", form["TXT_PP_ID"], DBItem.DBDataType.String)); //身分證字號
            insertDataList.Add(new DBItem("PP_NAME", form["TXT_PP_NAME"], DBItem.DBDataType.String)); //姓名
            insertDataList.Add(new DBItem("PP_BD", form["TXT_PP_BD"], DBItem.DBDataType.DataTime)); //出生日期

            insertDataList.Add(new DBItem("PP_ADD", form["TXT_PP_ADD"], DBItem.DBDataType.String)); //聯絡地址
            insertDataList.Add(new DBItem("PP_TEL", form["TXT_PP_TEL"], DBItem.DBDataType.String)); //電話

            insertDataList.Add(new DBItem("CHECKST", form["TXT_CHECKST_DAY"] + " " + form["TXT_CHECKST_TIME"], DBItem.DBDataType.DataTime)); //開始日期時間
            insertDataList.Add(new DBItem("CHECKET", form["TXT_CHECKET_DAY"] + " " + form["TXT_CHECKET_TIME"], DBItem.DBDataType.DataTime)); //結束日期時間
            insertDataList.Add(new DBItem("PP_CHECKITEM", form["DDL_PP_CHECKITEM"], DBItem.DBDataType.String)); //檢查項目
            string PP_CHECKITEM = form["DDL_PP_CHECKITEM"]; //檢查項目

            if (PP_CHECKITEM != "" && PP_CHECKITEM == "1")
            { //[檢查項目]為「胎心音檢視」時填寫

                insertDataList.Add(new DBItem("REP1_FH_FH1", form["TXT_REP1_FH_FH1"], DBItem.DBDataType.String));//胎心音1
                insertDataList.Add(new DBItem("REP1_FH_FH2", form["TXT_REP1_FH_FH2"], DBItem.DBDataType.String));//胎心音2
                insertDataList.Add(new DBItem("REP1_FH_FHT", form["RB_REP1_FH_FHT"], DBItem.DBDataType.String));//胎心音減速型態

                insertDataList.Add(new DBItem("REP1_FH_FH1_2", form["TXT_REP1_FH_FH1_2"], DBItem.DBDataType.String));//胎心音1
                insertDataList.Add(new DBItem("REP1_FH_FH2_2", form["TXT_REP1_FH_FH2_2"], DBItem.DBDataType.String));//胎心音2
                insertDataList.Add(new DBItem("REP1_FH_FHT_2", form["RB_REP1_FH_FHT_2"], DBItem.DBDataType.String));//胎心音減速型態


                insertDataList.Add(new DBItem("REP1_FH_UCDU1", form["TXT_REP1_FH_UCDU1"], DBItem.DBDataType.String));//宮縮持續時間1
                insertDataList.Add(new DBItem("REP1_FH_UCDU2", form["TXT_REP1_FH_UCDU2"], DBItem.DBDataType.String));//宮縮持續時間2
                insertDataList.Add(new DBItem("REP1_FH_UCINT1", form["TXT_REP1_FH_UCINT1"], DBItem.DBDataType.String));//宮縮間隔時間1
                insertDataList.Add(new DBItem("REP1_FH_UCINT2", form["TXT_REP1_FH_UCINT2"], DBItem.DBDataType.String));//宮縮間隔時間2
                insertDataList.Add(new DBItem("REP1_FH_UCSTR", form["RB_REP1_FH_UCSTR"], DBItem.DBDataType.String));//宮縮強度
                insertDataList.Add(new DBItem("REP1_FH_UCE", form["RB_REP1_FH_UCE"], DBItem.DBDataType.String));//子宮頸擴張1
                insertDataList.Add(new DBItem("REP1_FH_UCT", form["RB_REP1_FH_UCT"], DBItem.DBDataType.String));//子宮頸變薄1
                insertDataList.Add(new DBItem("REP1_FH_UCH", form["RB_REP1_FH_UCH"], DBItem.DBDataType.String));//子宮頸高度1
                insertDataList.Add(new DBItem("REP1_FH_ROM", form["RB_REP1_FH_ROM"], DBItem.DBDataType.String));//破水1

                insertDataList.Add(new DBItem("REP2_FH_FH1", form["TXT_REP2_FH_FH1"], DBItem.DBDataType.String));//胎心音1
                insertDataList.Add(new DBItem("REP2_FH_FH2", form["TXT_REP2_FH_FH2"], DBItem.DBDataType.String));//胎心音2
                insertDataList.Add(new DBItem("REP2_FH_FHT", form["RB_REP2_FH_FHT"], DBItem.DBDataType.String));//胎心音減速型態

                insertDataList.Add(new DBItem("REP2_FH_FH1_2", form["TXT_REP2_FH_FH1_2"], DBItem.DBDataType.String));//胎心音1
                insertDataList.Add(new DBItem("REP2_FH_FH2_2", form["TXT_REP2_FH_FH2_2"], DBItem.DBDataType.String));//胎心音2
                insertDataList.Add(new DBItem("REP2_FH_FHT_2", form["RB_REP2_FH_FHT_2"], DBItem.DBDataType.String));//胎心音減速型態

                insertDataList.Add(new DBItem("REP2_FH_UCDU1", form["TXT_REP2_FH_UCDU1"], DBItem.DBDataType.String));//宮縮持續時間1
                insertDataList.Add(new DBItem("REP2_FH_UCDU2", form["TXT_REP2_FH_UCDU2"], DBItem.DBDataType.String));//宮縮持續時間2
                insertDataList.Add(new DBItem("REP2_FH_UCINT1", form["TXT_REP2_FH_UCINT1"], DBItem.DBDataType.String));//宮縮間隔時間1
                insertDataList.Add(new DBItem("REP2_FH_UCINT2", form["TXT_REP2_FH_UCINT2"], DBItem.DBDataType.String));//宮縮間隔時間2
                insertDataList.Add(new DBItem("REP2_FH_UCSTR", form["RB_REP2_FH_UCSTR"], DBItem.DBDataType.String));//宮縮強度
                insertDataList.Add(new DBItem("REP2_FH_UCE", form["RB_REP2_FH_UCE"], DBItem.DBDataType.String));//子宮頸擴張1
                insertDataList.Add(new DBItem("REP2_FH_UCT", form["RB_REP2_FH_UCT"], DBItem.DBDataType.String));//子宮頸變薄1
                insertDataList.Add(new DBItem("REP2_FH_UCH", form["RB_REP2_FH_UCH"], DBItem.DBDataType.String));//子宮頸高度1
                insertDataList.Add(new DBItem("REP2_FH_ROM", form["RB_REP2_FH_ROM"], DBItem.DBDataType.String));//破水1
            }
            if (PP_CHECKITEM != "" && PP_CHECKITEM != "1")
            {
                insertDataList.Add(new DBItem("CHECK_REP1", form["TXT_CHECK_REP1"], DBItem.DBDataType.String));//檢查結果1
                insertDataList.Add(new DBItem("CHECK_REP2", form["TXT_CHECK_REP2"], DBItem.DBDataType.String));//檢查結果2
            }
            if (PP_CHECKITEM != "" && PP_CHECKITEM == "5")
            {
                insertDataList.Add(new DBItem("PP_CHECKOTH", form["TXT_PP_CHECKOTH"], DBItem.DBDataType.String));
            }

            insertDataList.Add(new DBItem("PP_TO", form["DDL_PP_TO"], DBItem.DBDataType.String));//病患動向
            string PP_TO = form["DDL_PP_TO"]; //病患動向
            if (PP_TO == "9")
            { //[病患動向]選擇其他
                insertDataList.Add(new DBItem("PP_TO_OTH", form["TXT_PP_TO_OTH"], DBItem.DBDataType.String));//病患動向-其他
            }
            insertDataList.Add(new DBItem("PP_TO_MEMO", form["TXT_PP_TO_MEMO"], DBItem.DBDataType.String)); //病患動向備註
            insertDataList.Add(new DBItem("CREATNO", userno, DBItem.DBDataType.String)); //建立者員編
            insertDataList.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間

            insertDataList.Add(new DBItem("UPDNO", userno, DBItem.DBDataType.String)); //更新者員編
            insertDataList.Add(new DBItem("RECORDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間
            insertDataList.Add(new DBItem("UPDTIME", null, DBItem.DBDataType.DataTime)); //更新時間

            insertDataList.Add(new DBItem("RECORD", null, DBItem.DBDataType.String)); //內容
            insertDataList.Add(new DBItem("DELETED", null, DBItem.DBDataType.String)); //刪除註記

            string where = " IID = '" + id_list + "' ";
            insertDataList = setNullToEmpty(insertDataList);
            int erow = link.DBExecUpdate("OBS_EXECHK", insertDataList, where);

            if (erow > 0)
                Response.Write("<script>alert('修改成功');window.opener.location.href='Production?mode=1';window.close();</script>");
            else
                Response.Write("<script>alert('修改失敗');window.opener.location.href='Production?mode=1';window.close();</script>");
            return new EmptyResult();
        }
        #endregion

        #region 執行檢查輸入刪除
        /// <summary>
        /// 執行檢查輸入刪除
        /// </summary>
        /// <param name="form"></param>
        /// <returns></returns>
        [HttpPost]
        public string Del_Production(FormCollection form)
        {
            string[] id_list = Request["IID"].ToString().Split(',');
            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("DELETED", userinfo.EmployeesNo, DBItem.DBDataType.String));
            string where = " IID IN ('" + String.Join("','", id_list) + "')";
            insertDataList = setNullToEmpty(insertDataList);
            int erow = obs_m.DBExecUpdate("OBS_EXECHK", insertDataList, where);
            return erow.ToString();
        }
        #endregion

        #region 產程監測紀錄畫面
        /// <summary>
        /// 產程監測 List
        /// </summary>
        /// <returns></returns>
        public ActionResult Instantly_Be_Birth_List(string feeno, string chartno, bool Kardex = false, bool IsHisView = false)
        {
            ViewBag.IsHisView = IsHisView;
            if (IsHisView)
            {
                his.ControllerContext = ControllerContext;
                his.getSession(feeno);
            }

            if (Session["PatInfo"] != null)
            {
                if (feeno == "" || feeno == null)
                    feeno = ptinfo.FeeNo;

                ViewBag.Kardex = Kardex;

                DataTable dt = obs_m.sel_Instantly_Be_Birth(feeno, "", "");
                dt.Columns.Add("PE_NAME");
                dt.Columns.Add("CREATNO_NAME");
                //藥物調配
                dt.Columns.Add("BP_DISP");
                foreach (DataRow r in dt.Rows)
                {
                    if (r["PE"].ToString() != "")
                    {
                        byte[] listByteCode = webService.UserName(r["PE"].ToString());
                        if (listByteCode == null)
                            r["PE_NAME"] = "";
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(listByteCode);
                            UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                            r["PE_NAME"] = user_name.EmployeesName;
                        }
                    }

                    if (r["CREATNO"].ToString() != "")
                    {
                        byte[] listByteCode = webService.UserName(r["CREATNO"].ToString());
                        if (listByteCode == null)
                            r["CREATNO_NAME"] = "";
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(listByteCode);
                            UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                            r["CREATNO_NAME"] = user_name.EmployeesName;
                        }
                    }

                    // 抓取藥物調配
                    DataTable dt_Bp_Disp = obs_m.sel_bp_disp(feeno, r["IID"].ToString());
                    dt_Bp_Disp.Columns.Add("TM_MED_SPEED");

                    var result = "";
                    foreach (DataRow r_Bp in dt_Bp_Disp.Rows)
                    {

                        if (r_Bp["TM_MED_A"].ToString() != "")
                            result += $"{r_Bp["TM_MED_A"]}/{r_Bp["TM_MED_A_AMT"]}";

                        if (r_Bp["TM_MED_B"].ToString() != "")
                            result += $"<br/>{r_Bp["TM_MED_B"]}/{r_Bp["TM_MED_B_AMT"]}";

                        if (r_Bp["TM_MED_USE"].ToString() != "")
                            result += $"<br/>總用量：{r_Bp["TM_MED_USE"]}";

                        //抓取每筆藥物調配的最新流速
                        DataTable dt_Bp_Disp_Dtl = obs_m.sel_bp_disp_detail(feeno, r["IID"].ToString(), r_Bp["SNOM"].ToString());
                        if (dt_Bp_Disp_Dtl.Rows.Count > 0)
                        {
                            var speed = new List<string>();
                            foreach (DataRow disp in dt_Bp_Disp_Dtl.Rows)
                                speed.Add(disp["TM_MED_SPEED"].ToString());

                            result += $"<br/>流速：{String.Join("/", speed)}";
                        }
                        else
                            result += $"<br/>流速：";

                        if (r_Bp["TM_MED_USE_STAT"].ToString() != "" && r_Bp["TM_MED_USE_STAT"].ToString() == "0")
                        {
                            result += $"<br/>狀態：啟用<br/>";
                        }
                        if (r_Bp["TM_MED_USE_STAT"].ToString() != "" && r_Bp["TM_MED_USE_STAT"].ToString() == "1")
                        {
                            result += $"<br/>狀態：停止<br/>";
                        }
                        if (r_Bp["TM_MED_USE_STAT"].ToString() != "" && r_Bp["TM_MED_USE_STAT"].ToString() == "2")
                        {
                            result += $"<br/>狀態：一次性給藥<br/>";
                        }
                        if (r_Bp["TM_MED_ANTIBIOTIC"].ToString() != "")
                        {
                            var ANTIBIOTICV = new List<string>();
                            var ANTIBIOTIC = r_Bp["TM_MED_ANTIBIOTIC"].ToString();
                            for (var a = 0; a < ANTIBIOTIC.ToString().Length; a++)
                            {
                                if (ANTIBIOTIC[a] == '1')
                                {
                                    if (a == 0)
                                    {
                                        ANTIBIOTICV.Add("GBS");
                                    }
                                    if (a == 1)
                                    {
                                        ANTIBIOTICV.Add("發燒");
                                    }
                                    if (a == 2)
                                    {
                                        ANTIBIOTICV.Add("破水");
                                    }
                                    if (a == 3)
                                    {
                                        ANTIBIOTICV.Add("感染");
                                    }
                                    if (a == 4)
                                    {
                                        ANTIBIOTICV.Add("其他");
                                    }
                                }
                            }
                            if (ANTIBIOTICV.Count() > 0)
                            {
                                result += $"抗生素：{String.Join(",", ANTIBIOTICV)}<br/>";
                            }
                        }
                    }
                    r["BP_DISP"] = result;
                }
                ViewBag.dt = set_dt(dt);
                return View();
            }
            Response.Write("<script>alert('請重新選擇病患');</script>");
            return new EmptyResult();
        }
        #endregion

        #region 新增/編輯 產程監測畫面
        /// <summary>
        /// 新增/編輯 產程監測畫面
        /// </summary>
        /// <param name="del_ID"></param>
        /// <returns></returns>
        public ActionResult Insert_Instantly_Be_Birth(string del_ID)
        {
            if (del_ID != "" && del_ID != null)
            {
                DataTable dt = obs_m.sel_Instantly_Be_Birth("", "", del_ID);
                dt.Columns.Add("PE_NAME");
                dt.Columns.Add("CREATNO_NAME");
                if (dt != null && dt.Rows.Count > 0)
                {
                    foreach (DataRow r in dt.Rows)
                    {
                        if (r["CREATNO"].ToString().Trim() != userinfo.EmployeesNo)
                        {
                            Response.Write("<script>alert('無權限修改!');window.close();</script>");
                            return new EmptyResult();
                        }

                        if (r["PE"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["PE"].ToString());
                            if (listByteCode == null)
                                r["PE_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["PE_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["CREATNO"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["CREATNO"].ToString());
                            if (listByteCode == null)
                                r["CREATNO_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["CREATNO_NAME"] = user_name.EmployeesName;
                            }
                        }
                    }
                }

                // 抓取藥物調配
                DataTable dt_Bp_Disp = obs_m.sel_bp_disp(ptinfo.FeeNo, del_ID);
                dt_Bp_Disp.Columns.Add("TM_MED_SPEED");
                foreach (DataRow r_Bp in dt_Bp_Disp.Rows)
                {
                    //抓取每筆藥物調配的最新流速
                    DataTable dt_Bp_Disp_Dtl = obs_m.sel_bp_disp_detail(ptinfo.FeeNo, del_ID, r_Bp["SNOM"].ToString());
                    if (dt_Bp_Disp_Dtl != null && dt_Bp_Disp_Dtl.Rows.Count > 0)
                        r_Bp["TM_MED_SPEED"] = dt_Bp_Disp_Dtl.Rows[0]["TM_MED_SPEED"];
                    else
                        r_Bp["TM_MED_SPEED"] = "";
                }
                ViewBag.dt = set_dt(dt);
                ViewBag.dtBp_Disp = set_dt(dt_Bp_Disp);
            }
            else
            {
                DataTable dt = obs_m.sel_Instantly_Be_Birth(ptinfo.FeeNo, userinfo.EmployeesNo, "");
                if (dt != null && dt.Rows.Count > 0)
                {
                    var first = dt.Rows[0];
                    // 抓取藥物調配
                    DataTable dt_Bp_Disp = obs_m.sel_bp_disp(ptinfo.FeeNo, first["IID"].ToString(), "", true);
                    dt_Bp_Disp.Columns.Add("TM_MED_SPEED");
                    foreach (DataRow r_Bp in dt_Bp_Disp.Rows)
                    {
                        //抓取每筆藥物調配的最新流速
                        DataTable dt_Bp_Disp_Dtl = obs_m.sel_bp_disp_detail(ptinfo.FeeNo, r_Bp["IID"].ToString(), r_Bp["SNOM"].ToString());
                        if (dt_Bp_Disp_Dtl != null && dt_Bp_Disp_Dtl.Rows.Count > 0)
                            r_Bp["TM_MED_SPEED"] = dt_Bp_Disp_Dtl.Rows[0]["TM_MED_SPEED"];
                        else
                            r_Bp["TM_MED_SPEED"] = "";
                    }
                    ViewBag.dt_new = set_dt(dt);
                    ViewBag.dtBp_Disp_new = set_dt(dt_Bp_Disp);
                }
                //抓取上一次資料
                string feeno = ptinfo.FeeNo;
                string identity = "";
                string sql = "SELECT * FROM OBS_BTHPRC WHERE FEENO = '" + feeno + "' AND IDENTITY IS NOT NULL ORDER BY RECORDTIME DESC";
                DataTable dtID = new DataTable();
                link.DBExecSQL(sql, ref dtID);

                if(dtID.Rows.Count > 0)
                {
                    identity = dtID.Rows[0]["IDENTITY"].ToString();
                }

                ViewBag.identity = identity;
                ViewBag.userno = userinfo.EmployeesNo;
                ViewBag.username = userinfo.EmployeesName;
            }
            return View();
        }
        #endregion

        #region 挑選胎心音
        /// <summary>
        /// 挑選胎心音
        /// </summary>
        /// <returns></returns>
        public ActionResult Pick_FHB()
        {
            return View();
        }
        #endregion

        #region 新增產程監測資料
        /// <summary>
        /// 新增產程監測資料
        /// </summary>
        /// <param name="form"></param>
        /// <returns></returns>
        [HttpPost]
        public string Insert_Instantly_Be_Birth(FormCollection form)
        {
            link.DBOpen();
            int erow = 0;
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo.FeeNo;
            string id = base.creatid("OBS_BTHPRC", userno, feeno, "0");

            var PE = form["TXT_PE"];
            byte[] listByteCode = webService.UserName(userno);
            if (listByteCode == null)
                Response.Write("<script>alert('查無此執行者員工編號!');</script>");

            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("IID", id, DBItem.DBDataType.String)); //流水號
            insertDataList.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String)); //批價序號
            insertDataList.Add(new DBItem("CREATNO", form["TXT_CREATNO"], DBItem.DBDataType.String)); //評估者員編
            insertDataList.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
            insertDataList.Add(new DBItem("RECORDTIME", form["TXT_RECORDTIME_DAY"] + " " + form["TXT_RECORDTIME_TIME"], DBItem.DBDataType.DataTime));//紀錄時間

            insertDataList.Add(new DBItem("FH1", form["TXT_FH1"], DBItem.DBDataType.String));//胎心音1
            insertDataList.Add(new DBItem("FH2", form["TXT_FH2"], DBItem.DBDataType.String));//胎心音2
            insertDataList.Add(new DBItem("FH_T", form["RB_FH_T"], DBItem.DBDataType.String));//胎心音減速型態
            insertDataList.Add(new DBItem("FH_MEMO", form["TXT_FH_MEMO"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("FH1_2", form["TXT_FH1_2"], DBItem.DBDataType.String));//胎心音1
            insertDataList.Add(new DBItem("FH2_2", form["TXT_FH2_2"], DBItem.DBDataType.String));//胎心音2
            insertDataList.Add(new DBItem("FH_T_2", form["RB_FH_T_2"], DBItem.DBDataType.String));//胎心音減速型態
            insertDataList.Add(new DBItem("FH_MEMO_2", form["TXT_FH_MEMO_2"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("UC_DU1", form["TXT_UC_DU1"], DBItem.DBDataType.String));//宮縮持續時間1
            insertDataList.Add(new DBItem("UC_DU2", form["TXT_UC_DU2"], DBItem.DBDataType.String));//宮縮持續時間2
            insertDataList.Add(new DBItem("UC_INT1", form["TXT_UC_INT1"], DBItem.DBDataType.String));//宮縮間隔時間1
            insertDataList.Add(new DBItem("UC_INT2", form["TXT_UC_INT2"], DBItem.DBDataType.String));//宮縮間隔時間2
            insertDataList.Add(new DBItem("UC_STR", form["RB_UC_STR"], DBItem.DBDataType.String));//宮縮強度

            insertDataList.Add(new DBItem("UC_E", form["RB_UC_E"], DBItem.DBDataType.String));//子宮頸擴張
            insertDataList.Add(new DBItem("UC_T", form["RB_UC_T"], DBItem.DBDataType.String));//子宮頸厚度
            insertDataList.Add(new DBItem("UC_H", form["RB_UC_H"], DBItem.DBDataType.String));//子宮頸高度
            insertDataList.Add(new DBItem("PE", form["TXT_PE"], DBItem.DBDataType.String));//內診執行者

            insertDataList.Add(new DBItem("IDENTITY", form["RB_IDENTITY"], DBItem.DBDataType.String));//身份

            var identity = form["RB_IDENTITY"];

            //產程監測 計價
            if(identity != "1" && identity != "3" && (form["TXT_FH1"] != null || form["TXT_FH2"] != null))
            {
                //
                string ho_id = "6518014";
                DateTime startTime; DateTime nowTime;
                string startTimeTemp = ""; string nowTimeTemp = "";
                nowTimeTemp = form["TXT_RECORDTIME_DAY"] + " " + form["TXT_RECORDTIME_TIME"];
                double differenceTime = 0;


                string sql = "SELECT * FROM ( SELECT * FROM OBS_BTHPRC WHERE FEENO = '" + feeno + "' AND (IDENTITY = '2' OR IDENTITY = '0') AND (FH1 IS NOT NULL OR FH2 IS NOT NULL )  ORDER BY RECORDTIME ASC) WHERE ROWNUM =1";
                DataTable dt = new DataTable();
                link.DBExecSQL(sql, ref dt);

                if(dt.Rows.Count > 0)
                {
                    startTimeTemp = dt.Rows[0]["RECORDTIME"].ToString();
                }

                if (startTimeTemp != "" && nowTimeTemp != "")
                {
                    startTime = DateTime.Parse(startTimeTemp);
                    nowTime = DateTime.Parse(nowTimeTemp);
                    int count = 0;

                    differenceTime = (nowTime - startTime).TotalHours;


                    if (differenceTime > 3 && differenceTime <= 4)
                    {
                        //檢查這個區間
                        count += countBTHPRC(startTime.ToString(), 3 ,4);
                    }
                    else if (differenceTime > 4 && differenceTime <= 5)
                    {
                        //檢查上一個區間有無拋過帳
                        count += countBTHPRC(startTime.ToString(), 3, 4);

                        //檢查這個區間
                        count += countBTHPRC(startTime.ToString(), 4, 5);

                    }
                    else if (differenceTime > 5)
                    {
                        int check = 0;


                        //檢查上一個區間有無拋過帳
                        check += countBTHPRC(startTime.ToString(), 4, 5);
                        if (check == 1)
                        {
                            count += 1;

                            //檢查上兩個區間有無拋過帳
                            check = countBTHPRC(startTime.ToString(), 3, 4);
                            if(check == 1)
                            {
                                count += 1;
                            }
                        }

                        //檢查這個區間
                        count += countBTHPRC(startTime.ToString(), 5);
                    }

                    if(count > 0)
                    {
                        List<Bill_RECORD> billDataList = new List<Bill_RECORD>();
                        Bill_RECORD billData = new Bill_RECORD();

   
                        billData.HO_ID = ho_id;
                        billData.COUNT = count.ToString();

                        billDataList.Add(billData);

                        SaveBillingRecord(billDataList);
                    }

                }

            }

            var Urine = form["RB_URINE"];
            insertDataList.Add(new DBItem("URINE", Urine, DBItem.DBDataType.String));//解尿

            if (Urine != null)
            {
                insertDataList.Add(new DBItem("URINE_M", form["RB_URINE_M"], DBItem.DBDataType.String));//解尿-方式
                var Urine_M = form["RB_URINE_M"];
                var name = "";
                if (Urine_M == "0")
                    name = "自解量";
                if (Urine_M == "1")
                    name = "單次導尿量";
                if (Urine_M == "2")
                    name = "留置導尿量";

                var urineSql = "SELECT * FROM IO_ITEM WHERE TYPEID = '6' AND NAME = '" + name + "'";
                var u_dt = obs_m.DBExecSQL(urineSql);
                if (u_dt != null && u_dt.Rows.Count > 0)
                {
                    var itemid = u_dt.Rows[0]["ITEMID"].ToString();
                    if (Urine_M == "0")
                    {
                        Insert_IO_DATA_ForOther(ptinfo.FeeNo, form["TXT_RECORDTIME_DAY"] + " " + form["TXT_RECORDTIME_TIME"], id, "6", itemid, "", "1", id, "OBS_BTHPRC", "Loss");
                        base.Insert_CareRecord(form["TXT_RECORDTIME_DAY"] + " " + form["TXT_RECORDTIME_TIME"], id + "_IO", "Output", "", "", "尿液 自解量 Loss。", "", "", "OBS_BTHPRC");
                    }
                    else
                    {
                        Insert_IO_DATA(form["TXT_RECORDTIME_DAY"] + " " + form["TXT_RECORDTIME_TIME"], id, "6", itemid, form["TXT_URINE_AMT"], "1", id, "OBS_BTHPRC");
                        base.Insert_CareRecord(form["TXT_RECORDTIME_DAY"] + " " + form["TXT_RECORDTIME_TIME"], id + "_IO", "Output", "", "", "尿液 " + name + " " + form["TXT_URINE_AMT"] + "ml。", "", "", "OBS_BTHPRC");
                    }
                }
                insertDataList.Add(new DBItem("URINE_AMT", form["TXT_URINE_AMT"], DBItem.DBDataType.String));//解尿-量
            }

            insertDataList.Add(new DBItem("MED_P", form["TXT_MED_P"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("NUR_P", form["TXT_NUR_P"], DBItem.DBDataType.String));//護理處置


            var TM_MED_A = form["TXT_TM_MED_A"]?.Split(',');
            var TM_MED_A_AMT = form["TXT_TM_MED_A_AMT"]?.Split(',');
            var TM_MED_B = form["TXT_TM_MED_B"]?.Split(',');
            var TM_MED_B_AMT = form["TXT_TM_MED_B_AMT"]?.Split(',');
            var TM_MED_USE = form["TXT_TM_MED_USE"]?.Split(',');
            var TM_MED_USE_STAT = form["TXT_TM_MED_USE_STAT"]?.Split(',');
            var TM_MED_SPEED = form["TXT_TM_MED_SPEED"]?.Split(',');
            var TM_MED_ANTIBIOTIC = form["TXT_TM_MED_ANTIBIOTIC"]?.Split(',');

            #region 護理紀錄
            if (IsNoEmpty(form["CK_PAT_CARE_RECORD"]) && form["CK_PAT_CARE_RECORD"] == "1")
            {
                //TODO CareRecord Title
                List<string> content = new List<string>();
                var field = "";

                #region 胎心音速率
                switch ((form["RB_FH_T"] ?? "").ToString())
                {
                    case "0":
                        field = "早期減速";
                        break;
                    case "1":
                        field = "晚期減速";
                        break;
                    case "2":
                        field = "變異性減速";
                        break;
                    default:
                        field = "";
                        break;
                }
                if (field != "")
                    content.Add(field);
                #endregion

                #region 胎心音 次/分
                field = "";
                if (IsNoEmpty(form["TXT_FH1"]) && IsNoEmpty(form["TXT_FH2"]))
                    field += $"{(!IsNoEmpty(form["RB_FH_T_2"]) && !IsNoEmpty(form["TXT_FH1_2"]) && !IsNoEmpty(form["TXT_FH2_2"]) ? "" : "雙胞胎1")}胎心音:{form["TXT_FH1"]}~{form["TXT_FH2"]}次/分";
                else
                    field += "";

                if (field != "")
                    content.Add(field);
                #endregion

                switch ((form["RB_FH_T_2"] ?? "").ToString())
                {
                    case "0":
                        field = "早期減速";
                        break;
                    case "1":
                        field = "晚期減速";
                        break;
                    case "2":
                        field = "變異性減速";
                        break;
                    default:
                        field = "";
                        break;
                }
                if (field != "")
                    content.Add(field);

                field = "";
                if (IsNoEmpty(form["TXT_FH1_2"]) && IsNoEmpty(form["TXT_FH2_2"]))
                    field += $"雙胞胎2胎心音:{form["TXT_FH1_2"]}~{form["TXT_FH2_2"]}次/分";
                else
                    field += "";

                if (field != "")
                    content.Add(field);


                #region 宮縮持續時間: 秒
                field = "";
                if (IsNoEmpty(form["TXT_UC_DU1"]) && IsNoEmpty(form["TXT_UC_DU2"]))
                    field += "宮縮持續時間:" + form["TXT_UC_DU1"] + "~" + form["TXT_UC_DU2"] + "秒";
                else
                    field += "";
                if (field != "")
                    content.Add(field);
                #endregion

                #region 間隔時間: 秒
                field = "";
                if (IsNoEmpty(form["TXT_UC_INT1"]) && IsNoEmpty(form["TXT_UC_INT2"]))
                    field += "間隔時間:" + form["TXT_UC_INT1"] + "~" + form["TXT_UC_INT2"] + "分鐘";
                else
                    field += "";

                if (field != "")
                    content.Add(field);
                #endregion

                #region 強度
                field = "";
                switch ((form["RB_UC_STR"] ?? "").ToString())
                {
                    case "0":
                        field = "強度:無";
                        break;
                    case "1":
                        field = "強度:弱";
                        break;
                    case "2":
                        field = "強度:中";
                        break;
                    case "3":
                        field = "強度:強";
                        break;
                    case "4":
                        field = "強度:弱中";
                        break;
                    case "5":
                        field = "強度:中強";
                        break;
                    case "6":
                        field = "強度:偶";
                        break;
                    case "7":
                        field = "強度:不規則";
                        break;
                    default:
                        field = "";
                        break;
                }
                if (field != "")
                    content.Add(field);
                #endregion

                #region 內診檢查子宮頸變化
                field = "";
                if (!IsNoEmpty(form["RB_UC_E"]) && !IsNoEmpty(form["RB_UC_T"]) && !IsNoEmpty(form["RB_UC_H"]))
                    field = "";
                else
                {
                    var commaflag = true;
                    var userName = Get_Employee_Name(form["TXT_PE"]);
                    field = $"由{userName}內診檢查子宮頸變化:";
                    if (IsNoEmpty(form["RB_UC_E"]))
                    {
                        field += $"擴張{form["RB_UC_E"]}公分";
                        commaflag = false;
                    }

                    if (IsNoEmpty(form["RB_UC_T"]))
                    {
                        if (!commaflag)
                            field += "、";
                        field += $"厚度:{Convert.ToInt32(form["RB_UC_T"].ToString()) * 10}%";
                        commaflag = false;
                    }

                    if (IsNoEmpty(form["RB_UC_H"]))
                    {
                        if (!commaflag)
                            field += "、";
                        var Height = Convert.ToInt32(form["RB_UC_H"].ToString()) - 4;
                        if (Height > 0)
                            field += $"高度:+{Convert.ToInt32(form["RB_UC_H"].ToString()) - 4}";
                        else
                            field += $"高度:{Convert.ToInt32(form["RB_UC_H"].ToString()) - 4}";
                        commaflag = false;
                    }
                }
                if (field != "")
                    content.Add(field);
                #endregion

                #region 解尿
                switch (form["RB_URINE"])
                {
                    case "0":
                        field = "無解尿";
                        break;
                    case "1":
                        field = "有解尿";
                        break;
                    default:
                        field = "";
                        break;
                }
                if (field != "")
                    content.Add(field);

                if (IsNoEmpty(form["RB_URINE_M"]))
                {
                    field = "";
                    switch (form["RB_URINE_M"] ?? "")
                    {
                        case "0":
                            field += "自解";
                            break;
                        case "1":
                            field += "單次導尿";
                            break;
                        case "2":
                            field += "留置導尿";
                            break;
                        default:
                            break;
                    }
                    if (form["RB_URINE_M"] == "1" || form["RB_URINE_M"] == "2")
                    {
                        if (IsNoEmpty(form["TXT_URINE_AMT"]))
                            field += form["TXT_URINE_AMT"];
                        else
                            field += "0";
                        field += "ml";
                    }
                    content.Add(field);
                }
                #endregion

                #region 醫囑
                field = "";
                var medIndex = 0;
                if (TM_MED_A != null && TM_MED_A.Length > 0)
                {
                    field = "依醫囑";
                    for (var d = 0; d < TM_MED_A?.Length; d++)
                    {
                        field += TM_MED_USE_STAT[d];
                        field += $"{TM_MED_A[d]} {TM_MED_A_AMT[d]}";
                        if (TM_MED_B[d] != "")
                        {
                            field += $"+{TM_MED_B[d]}  {TM_MED_B_AMT[d]}";
                        }
                        if (TM_MED_SPEED[d].ToString() != "")
                            field += $"流速{TM_MED_SPEED[d]} ml/hr";

                        if (medIndex != TM_MED_A.Length - 1)
                            field += "。";
                        medIndex++;
                    }
                    content.Add(field);
                }
                #endregion

                #region 醫療處置
                field = "";
                if (IsNoEmpty(form["TXT_MED_P"]))
                {
                    field += form["TXT_MED_P"];
                    content.Add(field);
                }
                #endregion

                #region 護理處置
                field = "";
                if (IsNoEmpty(form["TXT_NUR_P"]))
                    field += $"執行護理處置：{form["TXT_NUR_P"]}";
                else
                    field += "";
                if (field != "")
                    content.Add(field);
                #endregion

                var result = String.Join("，", content) == "" ? String.Join("，", content) : String.Join("，", content) + "。";
                if (result != "")
                {
                    insertDataList.Add(new DBItem("PAT_CARE_RECORD", form["CK_PAT_CARE_RECORD"] == null ? "0" : form["CK_PAT_CARE_RECORD"], DBItem.DBDataType.String));//帶護理紀錄
                    insertDataList = setNullToEmpty(insertDataList);
                    erow = link.DBExecInsertTns("OBS_BTHPRC", insertDataList);

                    erow += base.Insert_CareRecordTns(form["TXT_RECORDTIME_DAY"] + " " + form["TXT_RECORDTIME_TIME"], id, "產程監測紀錄", result, "", "", "", "", "OBS_BTHPRC", ref link);
                }
                else
                {
                    insertDataList.Add(new DBItem("PAT_CARE_RECORD", "0", DBItem.DBDataType.String));//帶護理紀錄
                    insertDataList = setNullToEmpty(insertDataList);
                    erow = link.DBExecInsertTns("OBS_BTHPRC", insertDataList);
                }
            }
            #endregion
            else
            {
                insertDataList.Add(new DBItem("PAT_CARE_RECORD", form["CK_PAT_CARE_RECORD"] == null ? "0" : form["CK_PAT_CARE_RECORD"], DBItem.DBDataType.String));//帶護理紀錄
                insertDataList = setNullToEmpty(insertDataList);
                erow = link.DBExecInsertTns("OBS_BTHPRC", insertDataList);
            }

            #region 新增藥物調配

            for (var d = 0; d < TM_MED_A?.Length; d++)
            {
                List<DBItem> insertDataListM = new List<DBItem>();
                insertDataListM.Add(new DBItem("IID", id, DBItem.DBDataType.String)); //流水號
                insertDataListM.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String)); //批價序號
                insertDataListM.Add(new DBItem("SNOM", (d + 1).ToString(), DBItem.DBDataType.String)); //序號
                insertDataListM.Add(new DBItem("CREATNO", form["TXT_CREATNO"], DBItem.DBDataType.String)); //評估者員編
                insertDataListM.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
                insertDataListM.Add(new DBItem("RECORDTIME", form["TXT_RECORDTIME_DAY"] + " " + form["TXT_RECORDTIME_TIME"], DBItem.DBDataType.DataTime));//紀錄時間

                insertDataListM.Add(new DBItem("TM_MED_A", TM_MED_A[d], DBItem.DBDataType.String)); //醫療處置-調配-A藥品種類
                insertDataListM.Add(new DBItem("TM_MED_A_AMT", TM_MED_A_AMT[d], DBItem.DBDataType.String)); //醫療處置-調配-A藥品劑量
                insertDataListM.Add(new DBItem("TM_MED_B", TM_MED_B[d], DBItem.DBDataType.String)); //醫療處置-調配-B藥品種類
                insertDataListM.Add(new DBItem("TM_MED_B_AMT", TM_MED_B_AMT[d], DBItem.DBDataType.String)); //醫療處置-調配-B藥品劑量
                insertDataListM.Add(new DBItem("TM_MED_USE", TM_MED_USE[d], DBItem.DBDataType.String)); //醫療處置-A+B組合總用量
                if (TM_MED_USE_STAT[d].Trim() == "啟用")
                    insertDataListM.Add(new DBItem("TM_MED_USE_STAT", "0", DBItem.DBDataType.String)); //醫療處置-A+B組合狀態
                else if (TM_MED_USE_STAT[d].Trim() == "停止")
                    insertDataListM.Add(new DBItem("TM_MED_USE_STAT", "1", DBItem.DBDataType.String)); //醫療處置-A+B組合狀態
                else if (TM_MED_USE_STAT[d].Trim() == "一次性給藥")
                    insertDataListM.Add(new DBItem("TM_MED_USE_STAT", "2", DBItem.DBDataType.String)); //醫療處置-A+B組合狀態
                else
                    insertDataListM.Add(new DBItem("TM_MED_USE_STAT", null, DBItem.DBDataType.String)); //醫療處置-A+B組合狀態

                if (TM_MED_ANTIBIOTIC != null && TM_MED_ANTIBIOTIC[d] != null && TM_MED_ANTIBIOTIC[d] != "")
                {
                    var ANTIBIOTIC = new List<string>() { "0", "0", "0", "0", "0" };
                    var ANTIBIOTICs = TM_MED_ANTIBIOTIC[d].Split('/');
                    for (var a = 0; a < ANTIBIOTICs.Length; a++)
                    {
                        if (ANTIBIOTICs[a].Trim() == "GBS")
                        {
                            ANTIBIOTIC[0] = "1";
                        }
                        else if (ANTIBIOTICs[a].Trim() == "發燒")
                        {
                            ANTIBIOTIC[1] = "1";
                        }
                        else if (ANTIBIOTICs[a].Trim() == "破水")
                        {
                            ANTIBIOTIC[2] = "1";
                        }
                        else if (ANTIBIOTICs[a].Trim() == "感染")
                        {
                            ANTIBIOTIC[3] = "1";
                        }
                        else if (ANTIBIOTICs[a].Trim() == "其他")
                        {
                            ANTIBIOTIC[4] = "1";
                        }
                    }
                    insertDataListM.Add(new DBItem("TM_MED_ANTIBIOTIC", String.Join("", ANTIBIOTIC), DBItem.DBDataType.String)); //醫療處置-A+B組合狀態
                }

                insertDataListM = setNullToEmpty(insertDataListM);
                erow += link.DBExecInsertTns("OBS_BPDISP", insertDataListM);
                #endregion

                #region 新增藥物調配明細
                List<DBItem> insertDataListD = new List<DBItem>();
                insertDataListD.Add(new DBItem("IID", id, DBItem.DBDataType.String)); //流水號
                insertDataListD.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String)); //批價序號
                insertDataListD.Add(new DBItem("SNOM", (d + 1).ToString(), DBItem.DBDataType.String)); //產程藥物調配序號
                insertDataListD.Add(new DBItem("SNOD", "1", DBItem.DBDataType.String)); //序號
                insertDataListD.Add(new DBItem("CREATNO", form["TXT_CREATNO"], DBItem.DBDataType.String)); //評估者員編
                insertDataListD.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
                insertDataListD.Add(new DBItem("RECORDTIME", form["TXT_RECORDTIME_DAY"] + " " + form["TXT_RECORDTIME_TIME"], DBItem.DBDataType.DataTime));//紀錄時間

                insertDataListD.Add(new DBItem("TM_MED_SPEED", TM_MED_SPEED[d], DBItem.DBDataType.Number)); //醫療處置-A+B組合流速
                insertDataListD = setNullToEmpty(insertDataListD);
                erow += link.DBExecInsertTns("OBS_BPDISP_DETAIL", insertDataListD);
                #endregion
            }

            if (erow > 0)
            {
                link.DBCommit();
                //Response.Write("<script>alert('新增成功');window.opener.location.href='Index?active=Instantly_Be_Birth_List&show=Y';window.close();</script>");
                return "Y";

            }
            else
            {
                link.DBRollBack();
                //Response.Write("<script>alert('新增失敗');window.opener.location.href='Index?active=Instantly_Be_Birth_List&show=Y';window.close();</script>");
                return "N";

            }
        }
        #endregion

        public int countBTHPRC (string startTimeTemp ,int before , int after = 0)
        {

            //檢查這個區間
            DateTime startTime = DateTime.Parse(startTimeTemp);
            DataTable dt = new DataTable();
            string feeno = ptinfo.FeeNo;
            int count = 0;

            string start = startTime.AddHours(before).ToString("yyyy/MM/dd HH:mm:ss");
            string end = startTime.AddHours(after).ToString("yyyy/MM/dd HH:mm:ss");

            string sql = "SELECT * FROM OBS_BTHPRC WHERE FEENO='" + feeno + "' AND DELETED IS NULL ";

            if(before != 0 && after != 0)
            {
                sql += "AND RECORDTIME BETWEEN TO_DATE('" + start + "' , 'yyyy/MM/dd HH24:mi:ss') AND TO_DATE('" + end + "' , 'yyyy/MM/dd HH24:mi:ss')";
            }
            else
            {
                sql += "AND RECORDTIME > TO_DATE('" + start + "' , 'yyyy/MM/dd HH24:mi:ss')";

            }

            link.DBExecSQL(sql, ref dt);
            if (dt.Rows.Count > 0)
            {
                count = 0;
            }
            else
            {
                count = 1;

            }
            return count;
        }



        #region 編輯產程監測資料
        [HttpPost]
        public string Upd_Instantly_Be_Birth(FormCollection form)
        {
            link.DBOpen();
            int erow = 0;
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo.FeeNo;
            string[] id_list = form["id"].Split(',');


            for (int i = 0; i < id_list.Length; i++)
            {
                DataTable dt = obs_m.sel_Instantly_Be_Birth(ptinfo.FeeNo, "", id_list[i]);

                List<DBItem> insertDataList = new List<DBItem>();
                insertDataList.Add(new DBItem("CREATNO", form["TXT_CREATNO" + id_list[i]], DBItem.DBDataType.String)); //編輯者員編
                insertDataList.Add(new DBItem("UPDNO", form["TXT_CREATNO" + id_list[i]], DBItem.DBDataType.String)); //編輯者員編
                insertDataList.Add(new DBItem("UPDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //更新時間
                insertDataList.Add(new DBItem("RECORDTIME", form["TXT_RECORDTIME_DAY" + id_list[i]] + " " + form["TXT_RECORDTIME_TIME" + id_list[i]], DBItem.DBDataType.DataTime));//紀錄時間

                insertDataList.Add(new DBItem("FH1", form["TXT_FH1" + id_list[i]], DBItem.DBDataType.String));//胎心音1
                insertDataList.Add(new DBItem("FH2", form["TXT_FH2" + id_list[i]], DBItem.DBDataType.String));//胎心音2
                insertDataList.Add(new DBItem("FH_T", form["RB_FH_T" + id_list[i]], DBItem.DBDataType.String));//胎心音減速型態
                insertDataList.Add(new DBItem("FH_MEMO", form["TXT_FH_MEMO" + id_list[i]], DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("FH1_2", form["TXT_FH1_2" + id_list[i]], DBItem.DBDataType.String));//胎心音1
                insertDataList.Add(new DBItem("FH2_2", form["TXT_FH2_2" + id_list[i]], DBItem.DBDataType.String));//胎心音2
                insertDataList.Add(new DBItem("FH_T_2", form["RB_FH_T_2" + id_list[i]], DBItem.DBDataType.String));//胎心音減速型態
                insertDataList.Add(new DBItem("FH_MEMO_2", form["TXT_FH_MEMO_2" + id_list[i]], DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("UC_DU1", form["TXT_UC_DU1" + id_list[i]], DBItem.DBDataType.String));//宮縮持續時間1
                insertDataList.Add(new DBItem("UC_DU2", form["TXT_UC_DU2" + id_list[i]], DBItem.DBDataType.String));//宮縮持續時間2
                insertDataList.Add(new DBItem("UC_INT1", form["TXT_UC_INT1" + id_list[i]], DBItem.DBDataType.String));//宮縮間隔時間1
                insertDataList.Add(new DBItem("UC_INT2", form["TXT_UC_INT2" + id_list[i]], DBItem.DBDataType.String));//宮縮間隔時間2
                insertDataList.Add(new DBItem("UC_STR", form["RB_UC_STR" + id_list[i]], DBItem.DBDataType.String));//宮縮強度

                insertDataList.Add(new DBItem("UC_E", form["RB_UC_E" + id_list[i]], DBItem.DBDataType.String));//子宮頸擴張
                insertDataList.Add(new DBItem("UC_T", form["RB_UC_T" + id_list[i]], DBItem.DBDataType.String));//子宮頸厚度
                insertDataList.Add(new DBItem("UC_H", form["RB_UC_H" + id_list[i]], DBItem.DBDataType.String));//子宮頸高度
                insertDataList.Add(new DBItem("PE", form["TXT_PE" + id_list[i]], DBItem.DBDataType.String));//內診執行者

                var Urine = form["RB_URINE" + id_list[i]];
                insertDataList.Add(new DBItem("URINE", Urine, DBItem.DBDataType.String));//解尿

                if (Urine != null)
                {
                    insertDataList.Add(new DBItem("URINE_M", form["RB_URINE_M" + id_list[i]], DBItem.DBDataType.String));//解尿-方式
                    var Urine_M = form["RB_URINE_M" + id_list[i]];
                    var name = "";
                    if (Urine_M == "0")
                        name = "自解量";
                    if (Urine_M == "1")
                        name = "單次導尿量";
                    if (Urine_M == "2")
                        name = "留置導尿量";

                    var urineSql = "SELECT * FROM IO_ITEM WHERE TYPEID = '6' AND NAME = '" + name + "'";
                    var u_dt = obs_m.DBExecSQL(urineSql);
                    if (u_dt != null && u_dt.Rows.Count > 0)
                    {
                        var itemid = u_dt.Rows[0]["ITEMID"].ToString();

                        if (dt.Rows[0]["URINE_M"].ToString() != "")
                        {
                            if (Urine_M == "0")
                            {
                                Update_IO_DATA_ForOther(ptinfo.FeeNo, form["TXT_RECORDTIME_DAY" + id_list[i]] + " " + form["TXT_RECORDTIME_TIME" + id_list[i]], id_list[i], "6", itemid, "", "1", id_list[i], "OBS_BTHPRC", "Loss");
                                base.Upd_CareRecord(form["TXT_RECORDTIME_DAY" + id_list[i]] + " " + form["TXT_RECORDTIME_TIME" + id_list[i]], id_list[i] + "_IO", "Output", "", "", "尿液 " + name + " Loss。", "", "", "OBS_BTHPRC");
                            }
                            else
                            {
                                Update_IO_DATA_ForOther(ptinfo.FeeNo, form["TXT_RECORDTIME_DAY" + id_list[i]] + " " + form["TXT_RECORDTIME_TIME" + id_list[i]], id_list[i], "6", itemid, form["TXT_URINE_AMT" + id_list[i]], "1", id_list[i], "OBS_BTHPRC", "");
                                base.Upd_CareRecord(form["TXT_RECORDTIME_DAY" + id_list[i]] + " " + form["TXT_RECORDTIME_TIME" + id_list[i]], id_list[i] + "_IO", "Output", "", "", "尿液 " + name + " " + form["TXT_URINE_AMT" + id_list[i]] + "ml。", "", "", "OBS_BTHPRC");
                            }
                        }
                        else
                        {
                            if (Urine_M == "0")
                            {
                                Insert_IO_DATA_ForOther(ptinfo.FeeNo, form["TXT_RECORDTIME_DAY" + id_list[i]] + " " + form["TXT_RECORDTIME_TIME" + id_list[i]], id_list[i], "6", itemid, "", "1", id_list[i], "OBS_BTHPRC", "Loss");
                                base.Insert_CareRecord(form["TXT_RECORDTIME_DAY" + id_list[i]] + " " + form["TXT_RECORDTIME_TIME" + id_list[i]], id_list[i] + "_IO", "Output", "", "", "尿液 " + name + " Loss。", "", "", "OBS_BTHPRC");
                            }
                            else
                            {
                                Insert_IO_DATA(form["TXT_RECORDTIME_DAY" + id_list[i]] + " " + form["TXT_RECORDTIME_TIME" + id_list[i]], id_list[i], "6", itemid, form["TXT_URINE_AMT" + id_list[i]], "1", id_list[i], "OBS_BTHPRC");
                                base.Insert_CareRecord(form["TXT_RECORDTIME_DAY" + id_list[i]] + " " + form["TXT_RECORDTIME_TIME" + id_list[i]], id_list[i] + "_IO", "Output", "", "", "尿液 " + name + " " + form["TXT_URINE_AMT" + id_list[i]] + "ml。", "", "", "OBS_BTHPRC");
                            }
                        }
                    }

                    insertDataList.Add(new DBItem("URINE_AMT", form["TXT_URINE_AMT" + id_list[i]], DBItem.DBDataType.String));//解尿-量
                }

                insertDataList.Add(new DBItem("MED_P", form["TXT_MED_P" + id_list[i]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("NUR_P", form["TXT_NUR_P" + id_list[i]], DBItem.DBDataType.String));//護理處置

                //insertDataList.Add(new DBItem("PAT_CARE_RECORD", form["CK_PAT_CARE_RECORD" + id_list[i]] == null ? "0" : form["CK_PAT_CARE_RECORD" + id_list[i]], DBItem.DBDataType.String));//帶護理紀錄

                string where = " IID = '" + id_list[i] + "' ";


                #region 護理紀錄
                if (IsNoEmpty(form["CK_PAT_CARE_RECORD" + id_list[i]]) && form["CK_PAT_CARE_RECORD" + id_list[i]] == "1")
                {
                    //TODO CareRecord Title
                    List<string> content = new List<string>();
                    var field = "";

                    #region 胎心音速率
                    switch ((form["RB_FH_T" + id_list[i]] ?? "").ToString())
                    {
                        case "0":
                            field = "早期減速";
                            break;
                        case "1":
                            field = "晚期減速";
                            break;
                        case "2":
                            field = "變異性減速";
                            break;
                        default:
                            field = "";
                            break;
                    }
                    if (field != "")
                        content.Add(field);
                    #endregion

                    #region 胎心音 次/分
                    field = "";
                    if (IsNoEmpty(form["TXT_FH1" + id_list[i]]) && IsNoEmpty(form["TXT_FH2" + id_list[i]]))
                        field += $"{(!IsNoEmpty(form["RB_FH_T_2" + id_list[i]]) && !IsNoEmpty(form["TXT_FH1_2" + id_list[i]]) && !IsNoEmpty(form["TXT_FH2_2" + id_list[i]]) ? "" : "雙胞胎1")}胎心音:{form["TXT_FH1" + id_list[i]]}~{form["TXT_FH2" + id_list[i]]}次/分";
                    else
                        field += "";

                    if (field != "")
                        content.Add(field);
                    #endregion

                    switch ((form["RB_FH_T_2" + id_list[i]] ?? "").ToString())
                    {
                        case "0":
                            field = "早期減速";
                            break;
                        case "1":
                            field = "晚期減速";
                            break;
                        case "2":
                            field = "變異性減速";
                            break;
                        default:
                            field = "";
                            break;
                    }
                    if (field != "")
                        content.Add(field);

                    field = "";
                    if (IsNoEmpty(form["TXT_FH1_2" + id_list[i]]) && IsNoEmpty(form["TXT_FH2_2" + id_list[i]]))
                        field += $"雙胞胎2胎心音:{form["TXT_FH1_2" + id_list[i]]}~{form["TXT_FH2_2" + id_list[i]]}次/分";
                    else
                        field += "";

                    if (field != "")
                        content.Add(field);

                    #region 宮縮持續時間: 秒
                    field = "";
                    if (IsNoEmpty(form["TXT_UC_DU1" + id_list[i]]) && IsNoEmpty(form["TXT_UC_DU2" + id_list[i]]))
                        field += "宮縮持續時間:" + form["TXT_UC_DU1" + id_list[i]] + "~" + form["TXT_UC_DU2" + id_list[i]] + "秒";
                    else
                        field += "";
                    if (field != "")
                        content.Add(field);
                    #endregion

                    #region 間隔時間: 秒
                    field = "";
                    if (IsNoEmpty(form["TXT_UC_INT1" + id_list[i]]) && IsNoEmpty(form["TXT_UC_INT2" + id_list[i]]))
                        field += "間隔時間:" + form["TXT_UC_INT1" + id_list[i]] + "~" + form["TXT_UC_INT2" + id_list[i]] + "分鐘";
                    else
                        field += "";

                    if (field != "")
                        content.Add(field);
                    #endregion

                    #region 強度:
                    field = "";
                    switch ((form["RB_UC_STR" + id_list[i]] ?? "").ToString())
                    {
                        case "0":
                            field = "強度:無";
                            break;
                        case "1":
                            field = "強度:弱";
                            break;
                        case "2":
                            field = "強度:中";
                            break;
                        case "3":
                            field = "強度:強";
                            break;
                        case "4":
                            field = "強度:弱中";
                            break;
                        case "5":
                            field = "強度:中強";
                            break;
                        case "6":
                            field = "強度:偶";
                            break;
                        case "7":
                            field = "強度:不規則";
                            break;
                        default:
                            field = "";
                            break;
                    }
                    if (field != "")
                        content.Add(field);
                    #endregion

                    #region 內診檢查子宮頸變化
                    field = "";
                    if (!IsNoEmpty(form["RB_UC_E" + id_list[i]]) && !IsNoEmpty(form["RB_UC_T" + id_list[i]]) && !IsNoEmpty(form["RB_UC_H" + id_list[i]]))
                        field = "";
                    else
                    {
                        var commaflag = true;
                        var userName = Get_Employee_Name(form["TXT_PE" + id_list[i]]);
                        field = $"由{userName}內診檢查子宮頸變化:";
                        if (IsNoEmpty(form["RB_UC_E" + id_list[i]]))
                        {
                            field += $"擴張{form["RB_UC_E" + id_list[i]]}公分";
                            commaflag = false;
                        }

                        if (IsNoEmpty(form["RB_UC_T" + id_list[i]]))
                        {
                            if (!commaflag)
                                field += "、";
                            field += $"厚度:{Convert.ToInt32(form["RB_UC_T" + id_list[i]].ToString()) * 10}%";
                            commaflag = false;
                        }

                        if (IsNoEmpty(form["RB_UC_H" + id_list[i]]))
                        {
                            if (!commaflag)
                                field += "、";
                            var Height = Convert.ToInt32(form["RB_UC_H" + id_list[i]].ToString()) - 4;
                            if (Height > 0)
                                field += $"高度:+{Convert.ToInt32(form["RB_UC_H" + id_list[i]].ToString()) - 4}";
                            else
                                field += $"高度:{Convert.ToInt32(form["RB_UC_H" + id_list[i]].ToString()) - 4}";
                            commaflag = false;
                        }
                    }
                    if (field != "")
                        content.Add(field);
                    #endregion

                    #region 解尿
                    switch (form["RB_URINE" + id_list[i]])
                    {
                        case "0":
                            field = "無解尿";
                            break;
                        case "1":
                            field = "有解尿";
                            break;
                        default:
                            field = "";
                            break;
                    }
                    if (field != "")
                        content.Add(field);

                    if (IsNoEmpty(form["RB_URINE_M" + id_list[i]]))
                    {
                        field = "";
                        switch (form["RB_URINE_M" + id_list[i]] ?? "")
                        {
                            case "0":
                                field += "自解";
                                break;
                            case "1":
                                field += "單次導尿";
                                break;
                            case "2":
                                field += "留置導尿";
                                break;
                            default:
                                break;
                        }
                        if (form["RB_URINE_M" + id_list[i]] == "1" || form["RB_URINE_M" + id_list[i]] == "2")
                        {
                            if (IsNoEmpty(form["TXT_URINE_AMT" + id_list[i]]))
                                field += form["TXT_URINE_AMT" + id_list[i]];
                            else
                                field += "0";
                            field += "ml";
                        }
                        content.Add(field);
                    }

                    #endregion

                    #region 醫囑
                    field = "";
                    DataTable bp_dt = obs_m.sel_bp_disp(ptinfo?.FeeNo, id_list[i]);
                    if (bp_dt != null && bp_dt.Rows.Count > 0)
                    {
                        var medIndex = 0;
                        field = "依醫囑";
                        foreach (DataRow r in bp_dt.Rows)
                        {
                            if (r["TM_MED_USE_STAT"].ToString() == "0")
                                field += "啟用";
                            else if (r["TM_MED_USE_STAT"].ToString() == "1")
                                field += "停止";
                            else if (r["TM_MED_USE_STAT"].ToString() == "2")
                                field += "一次性給藥";

                            field += $"{r["TM_MED_A"]} {r["TM_MED_A_AMT"]}";
                            if (r["TM_MED_B"].ToString() != "")
                            {
                                field += $"+{r["TM_MED_B"]}  {r["TM_MED_B_AMT"]}";
                            }

                            DataTable bp_dtl_dt = obs_m.sel_bp_disp_detail(ptinfo?.FeeNo, id_list[i], r["SNOM"].ToString());
                            if (bp_dtl_dt != null && bp_dtl_dt.Rows.Count > 0)
                            {
                                if (bp_dtl_dt.Rows[0]["TM_MED_SPEED"].ToString() != "")
                                {
                                    field += $"流速{bp_dtl_dt.Rows[0]["TM_MED_SPEED"]} ml/hr";
                                }
                            }
                            if (medIndex != bp_dt.Rows.Count - 1)
                                field += "。";
                            medIndex++;
                        }
                        if (field != "")
                            content.Add(field);
                    }
                    #endregion

                    #region 醫療處置
                    field = "";
                    if (IsNoEmpty(form["TXT_MED_P" + id_list[i]]))
                    {
                        field += form["TXT_MED_P" + id_list[i]];
                        content.Add(field);
                    }
                    #endregion

                    #region 護理處置
                    field = "";
                    if (IsNoEmpty(form["TXT_NUR_P" + id_list[i]]))
                        field += $"執行護理處置：{form["TXT_NUR_P" + id_list[i]]}";
                    else
                        field += "";
                    if (field != "")
                        content.Add(field);
                    #endregion

                    var result = String.Join("，", content) == "" ? String.Join("，", content) : String.Join("，", content) + "。";

                    if (result != "")
                    {
                        insertDataList.Add(new DBItem("PAT_CARE_RECORD", form["CK_PAT_CARE_RECORD" + id_list[i]] == null ? "0" : form["CK_PAT_CARE_RECORD" + id_list[i]], DBItem.DBDataType.String));//帶護理紀錄
                        insertDataList = setNullToEmpty(insertDataList);
                        erow += link.DBExecUpdate("OBS_BTHPRC", insertDataList, where);

                        var careSql = $"SELECT * FROM CARERECORD_DATA where DELETED IS NULL AND CARERECORD_ID = '{id_list[i]}'";
                        DataTable care = obs_m.DBExecSQL(careSql);
                        if (care != null && care.Rows.Count > 0)
                        {
                            base.Upd_CareRecord(form["TXT_RECORDTIME_DAY" + id_list[i]] + " " + form["TXT_RECORDTIME_TIME" + id_list[i]], id_list[i], "產程監測紀錄", result, "", "", "", "", "OBS_BTHPRC");
                        }
                        else
                        {
                            base.Insert_CareRecord(form["TXT_RECORDTIME_DAY" + id_list[i]] + " " + form["TXT_RECORDTIME_TIME" + id_list[i]], id_list[i], "產程監測紀錄", result, "", "", "", "", "OBS_BTHPRC");
                        }
                    }
                    else
                    {
                        insertDataList.Add(new DBItem("PAT_CARE_RECORD", "0", DBItem.DBDataType.String));//帶護理紀錄
                        insertDataList = setNullToEmpty(insertDataList);
                        erow += link.DBExecUpdate("OBS_BTHPRC", insertDataList, where);
                        //base.Del_CareRecordTns(id_list[i], "OBS_BTHPRC", ref link);
                        base.Del_CareRecord(id_list[i], "OBS_BTHPRC");
                    }
                }
                else
                {
                    insertDataList.Add(new DBItem("PAT_CARE_RECORD", "0", DBItem.DBDataType.String));//帶護理紀錄
                    insertDataList = setNullToEmpty(insertDataList);
                    erow += link.DBExecUpdate("OBS_BTHPRC", insertDataList, where);
                    //base.Del_CareRecordTns(id_list[i], "OBS_BTHPRC", ref link);
                    base.Del_CareRecord(id_list[i], "OBS_BTHPRC");
                }
                #endregion
            }
            if (erow > 0)
                //Response.Write("<script>alert('修改成功');window.opener.location.href='Index?active=Instantly_Be_Birth_List&show=Y';window.close();</script>");
                return "Y";
            else
                //Response.Write("<script>alert('修改失敗');window.opener.location.href='Index?active=Instantly_Be_Birth_List&show=Y';window.close();</script>");
                return "N";

            //return new EmptyResult();
        }
        #endregion

        #region 刪除產程監測資料
        [HttpPost]
        public string Del_Instantly_Be_Birth()
        {
            link.DBOpen();
            string[] id = Request["del_ID"].ToString().Split(',');

            bool UnAuthorized = false;
            for (var i = 0; i < id.Length; i++)
            {
                DataTable dt = obs_m.sel_Instantly_Be_Birth("", userinfo.EmployeesNo, id[i]);
                if (dt == null || dt.Rows.Count == 0)
                {
                    //Response.Write("<script>alert('無權限修改!');window.close();</script>");
                    UnAuthorized = true;
                    break;
                }
            }
            if (!UnAuthorized)
            {
                List<DBItem> insertDataList = new List<DBItem>();
                insertDataList.Add(new DBItem("DELETED", userinfo.EmployeesNo, DBItem.DBDataType.String));
                string where = " IID IN ('" + String.Join("','", id) + "')";
                insertDataList = setNullToEmpty(insertDataList);
                int erow = link.DBExecUpdate("OBS_BTHPRC", insertDataList, where);
                //erow += link.DBExecUpdate("OBS_BPDISP", insertDataList, where);
                //erow += link.DBExecUpdate("OBS_BPDISP_DETAIL", insertDataList, where);
                if (erow > 0)
                {
                    for (int i = 0; i < id.Length; i++)
                    {
                        //base.Del_CareRecordTns(id[i], "OBS_BTHPRC", ref link);
                        base.Del_CareRecord(id[i], "OBS_BTHPRC");
                        Delete_IO_DATA(id[i], "OBS_BTHPRC");
                        base.Del_CareRecord(id[i] + "_IO", "OBS_BTHPRC");
                    }
                    return "1";
                }
                else
                    return "-1";
            }
            else
            {
                return "-501";
            }
        }
        #endregion

        #region 產程監測流速畫面
        public ActionResult BP_Disp(string IID, string SNOM)
        {
            if (SNOM != null && SNOM != "")
            {
                DataTable dt = obs_m.sel_bp_disp(ptinfo.FeeNo, IID, SNOM);
                dt.Columns.Add("TM_MED_SPEED");
                foreach (DataRow r in dt.Rows)
                {
                    //抓取每筆藥物調配的最新流速
                    DataTable dt_Bp_Disp_Dtl = obs_m.sel_bp_disp_detail(ptinfo.FeeNo, IID, SNOM);
                    if (dt_Bp_Disp_Dtl != null && dt_Bp_Disp_Dtl.Rows.Count > 0)
                        r["TM_MED_SPEED"] = dt_Bp_Disp_Dtl.Rows[0]["TM_MED_SPEED"];
                    else
                        r["TM_MED_SPEED"] = "";
                }
                ViewBag.dt = set_dt(dt);
            }
            ViewBag.SNOM = SNOM;
            ViewBag.IID = IID;
            return View();
        }
        #endregion

        #region 新增產程監測流速
        public ActionResult Insert_BP_Disp(FormCollection form)
        {
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo.FeeNo;
            string IID = form["IID"];

            var lastSeq = 0;
            DataTable dt_bp_disp = obs_m.sel_bp_disp_seq(feeno, IID);
            if (dt_bp_disp != null && dt_bp_disp.Rows.Count == 1)
                lastSeq = Convert.ToInt32(dt_bp_disp.Rows[0]["SNOM"]);
            var seq = (Convert.ToInt32(lastSeq) + 1).ToString();

            List<DBItem> insertDataListM = new List<DBItem>();
            insertDataListM.Add(new DBItem("IID", IID, DBItem.DBDataType.String)); //流水號
            insertDataListM.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String)); //批價序號
            insertDataListM.Add(new DBItem("SNOM", seq, DBItem.DBDataType.String)); //序號
            insertDataListM.Add(new DBItem("CREATNO", form["TXT_CREATNO"], DBItem.DBDataType.String)); //評估者員編
            insertDataListM.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
            insertDataListM.Add(new DBItem("RECORDTIME", form["TXT_RECORDTIME_DAY"] + " " + form["TXT_RECORDTIME_TIME"], DBItem.DBDataType.DataTime));//紀錄時間
            insertDataListM.Add(new DBItem("TM_MED_A", form["TXT_TM_MED_A"], DBItem.DBDataType.String)); //醫療處置-調配-A藥品種類
            insertDataListM.Add(new DBItem("TM_MED_A_AMT", form["TXT_TM_MED_A_AMT"], DBItem.DBDataType.String)); //醫療處置-調配-A藥品劑量
            insertDataListM.Add(new DBItem("TM_MED_B", form["TXT_TM_MED_B"], DBItem.DBDataType.String)); //醫療處置-調配-B藥品種類
            insertDataListM.Add(new DBItem("TM_MED_B_AMT", form["TXT_TM_MED_B_AMT"], DBItem.DBDataType.String)); //醫療處置-調配-B藥品劑量
            insertDataListM.Add(new DBItem("TM_MED_USE", form["TXT_TM_MED_USE"], DBItem.DBDataType.String)); //醫療處置-A+B組合總用量
            insertDataListM.Add(new DBItem("TM_MED_USE_STAT", form["RB_TM_MED_USE_STAT"], DBItem.DBDataType.String)); //醫療處置-A+B組合狀態
            var ANTIBIOTIC = form["CK_TM_MED_ANTIBIOTIC"];
            var ANTIBIOTICV = new List<string>() { "0", "0", "0", "0", "0" };
            if (ANTIBIOTIC == null)
                insertDataListM.Add(new DBItem("TM_MED_ANTIBIOTIC", String.Join("", ANTIBIOTICV), DBItem.DBDataType.String));
            else
            {
                var ANTIBIOTIC_SP = ANTIBIOTIC.Split(',');
                foreach (var v in ANTIBIOTIC_SP)
                    ANTIBIOTICV[Convert.ToInt32(v)] = "1";
                insertDataListM.Add(new DBItem("TM_MED_ANTIBIOTIC", String.Join("", ANTIBIOTICV), DBItem.DBDataType.String));
            }

            insertDataListM = setNullToEmpty(insertDataListM);
            int erowM = obs_m.DBExecInsert("OBS_BPDISP", insertDataListM);

            if (erowM > 0)
            {
                //新增藥物調配明細
                List<DBItem> insertDataListD = new List<DBItem>();
                insertDataListD.Add(new DBItem("IID", IID, DBItem.DBDataType.String)); //流水號
                insertDataListD.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String)); //批價序號
                insertDataListD.Add(new DBItem("SNOM", seq, DBItem.DBDataType.String)); //產程藥物調配序號
                insertDataListD.Add(new DBItem("SNOD", "1", DBItem.DBDataType.String)); //序號
                insertDataListD.Add(new DBItem("CREATNO", userno, DBItem.DBDataType.String)); //評估者員編
                insertDataListD.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
                insertDataListD.Add(new DBItem("RECORDTIME", form["TXT_RECORDTIME_DAY"] + " " + form["TXT_RECORDTIME_TIME"], DBItem.DBDataType.DataTime));//紀錄時間

                insertDataListD.Add(new DBItem("TM_MED_SPEED", form["TXT_TM_MED_SPEED"], DBItem.DBDataType.Number)); //醫療處置-A+B組合流速
                insertDataListD = setNullToEmpty(insertDataListD);
                int erowD = obs_m.DBExecInsert("OBS_BPDISP_DETAIL", insertDataListD);
                if (erowD > 0)
                    Response.Write("<script>alert('新增成功');window.opener.location.href=window.opener.location.href;window.close();</script>");
                else
                    Response.Write("<script>alert('藥物調配明細新增失敗');window.opener.location.href=window.opener.location.href;window.close();</script>");
            }
            else
                Response.Write("<script>alert('新增失敗');window.opener.location.href=window.opener.location.href;window.close();</script>");

            return new EmptyResult();
        }
        #endregion

        #region 編輯產程監測流速
        public ActionResult Upd_BP_Disp(FormCollection form)
        {
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo.FeeNo;
            string id = form["IID"];
            string snom = form["SNOM"];
            int erow = 0;

            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("UPDNO", form["TXT_CREATNO"], DBItem.DBDataType.String)); //編輯者員編
            insertDataList.Add(new DBItem("UPDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //更新時間
            insertDataList.Add(new DBItem("RECORDTIME", form["TXT_RECORDTIME_DAY" + id + snom] + " " + form["TXT_RECORDTIME_TIME" + id + snom], DBItem.DBDataType.DataTime));//紀錄時間
                                                                                                                                                                             //藥物調配僅能修改狀態
            insertDataList.Add(new DBItem("TM_MED_A_AMT", form["TXT_TM_MED_A_AMT" + id + snom], DBItem.DBDataType.String)); //醫療處置-A+B組合狀態
            insertDataList.Add(new DBItem("TM_MED_B_AMT", form["TXT_TM_MED_B_AMT" + id + snom], DBItem.DBDataType.String)); //醫療處置-A+B組合狀態
            insertDataList.Add(new DBItem("TM_MED_USE", form["TXT_TM_MED_USE" + id + snom], DBItem.DBDataType.String)); //醫療處置-A+B組合狀態
            insertDataList.Add(new DBItem("TM_MED_USE_STAT", form["RB_TM_MED_USE_STAT" + id + snom], DBItem.DBDataType.String)); //醫療處置-A+B組合狀態
            var ANTIBIOTIC = form["CK_TM_MED_ANTIBIOTIC" + id + snom];
            var ANTIBIOTICV = new List<string>() { "0", "0", "0", "0", "0" };
            if (ANTIBIOTIC == null)
                insertDataList.Add(new DBItem("TM_MED_ANTIBIOTIC", String.Join("", ANTIBIOTICV), DBItem.DBDataType.String));
            else
            {
                var ANTIBIOTIC_SP = ANTIBIOTIC.Split(',');
                foreach (var v in ANTIBIOTIC_SP)
                    ANTIBIOTICV[Convert.ToInt32(v)] = "1";
                insertDataList.Add(new DBItem("TM_MED_ANTIBIOTIC", String.Join("", ANTIBIOTICV), DBItem.DBDataType.String));
            }
            string where = " IID = '" + id + "' AND SNOM = '" + snom + "' ";
            insertDataList = setNullToEmpty(insertDataList);
            erow = obs_m.DBExecUpdate("OBS_BPDISP", insertDataList, where);
            if (erow > 0)
            {
                //取出流速最後一筆的序號及流速
                var lastSeq = 0;
                var lastSpeed = "";
                DataTable dt_bp_disp_dtl = obs_m.sel_bp_disp_detail_seq(feeno, id, snom);
                if (dt_bp_disp_dtl != null && dt_bp_disp_dtl.Rows.Count == 1)
                {
                    lastSeq = Convert.ToInt32(dt_bp_disp_dtl.Rows[0]["SNOD"]);
                    lastSpeed = dt_bp_disp_dtl.Rows[0]["TM_MED_SPEED"].ToString();
                }

                //流速改變才新增，沒有不動作
                if (lastSpeed != form["TXT_TM_MED_SPEED" + id + snom])
                {
                    var seq = (Convert.ToInt32(lastSeq) + 1).ToString();
                    //新增藥物調配明細
                    List<DBItem> insertDataListD = new List<DBItem>();
                    insertDataListD.Add(new DBItem("IID", id, DBItem.DBDataType.String)); //流水號
                    insertDataListD.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String)); //批價序號
                    insertDataListD.Add(new DBItem("SNOM", snom, DBItem.DBDataType.String)); //產程藥物調配序號
                    insertDataListD.Add(new DBItem("SNOD", seq, DBItem.DBDataType.String)); //序號
                    insertDataListD.Add(new DBItem("CREATNO", form["TXT_CREATNO"], DBItem.DBDataType.String)); //評估者員編
                    insertDataListD.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
                    insertDataList.Add(new DBItem("RECORDTIME", form["TXT_RECORDTIME_DAY" + id + snom] + " " + form["TXT_RECORDTIME_TIME" + id + snom], DBItem.DBDataType.DataTime));//紀錄時間
                    insertDataListD.Add(new DBItem("TM_MED_SPEED", form["TXT_TM_MED_SPEED" + id + snom], DBItem.DBDataType.Number)); //醫療處置-A+B組合流速
                    insertDataListD = setNullToEmpty(insertDataListD);
                    int erowD = obs_m.DBExecInsert("OBS_BPDISP_DETAIL", insertDataListD);
                    if (erowD <= 0)
                        Response.Write("<script>alert('藥物調配明細新增失敗');window.opener.location.href=window.opener.location.href;window.close();</script>");
                    else
                        Response.Write("<script>alert('修改成功');window.opener.location.href=window.opener.location.href;window.close();</script>");
                }
                else
                    Response.Write("<script>alert('修改成功');window.opener.location.href=window.opener.location.href;window.close();</script>");
            }
            else
                Response.Write("<script>alert('修改失敗');window.opener.location.href=window.opener.location.href;window.close();</script>");

            return new EmptyResult();
        }
        #endregion

        #region 選取給藥紀錄已做調配(產程監測及產後護理用)
        private DataTable dt_all = new DataTable();
        private CommonMedication cm = new CommonMedication();
        private DataTable dt_udorder = new DataTable();
        private DataTable dt_stat = new DataTable();
        private DataTable dt_reg = new DataTable();
        private DataTable dt_prn = new DataTable();
        private DataTable dt_iv = new DataTable();

        public ActionResult Med_QueryExecLog(FormCollection form, string feeno, bool? medtype, string TypeFlag, string ExecFlag = "new")
        {
            if (Check_Session(ExecFlag))
                return Redirect("../VitalSign/VitalSignSingle");
            else if (ExecFlag == "weberror")
                return View();

            if (medtype == null)
                medtype = Convert.ToBoolean(form["medtype"]);

            //宣告病患_取得住院序號
            PatientInfo ptInfo = (PatientInfo)Session["PatInfo"];
            if (string.IsNullOrEmpty(feeno))
                feeno = ptInfo.FeeNo;
            string start = "", end = "";
            start = DateTime.Now.ToString("yyyy/MM/dd 00:00:00");
            end = DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss");
            if (ExecFlag == "quiryInterval")
            {
                start = Convert.ToDateTime(form["start_date"] + " " + form["start_time"]).ToString("yyyy/MM/dd HH:mm:ss");    //查詢_開始日期時間
                end = Convert.ToDateTime(form["end_date"] + " " + form["end_time"]).ToString("yyyy/MM/dd HH:mm:ss");          //查詢_結束日期時間
                ViewBag.start_date = Convert.ToDateTime(form["start_date"]).ToString("yyyy/MM/dd");
                ViewBag.start_time = Convert.ToDateTime(form["start_time"]).ToString("HH:mm");
                ViewBag.end_date = Convert.ToDateTime(form["end_date"]).ToString("yyyy/MM/dd");
                ViewBag.end_time = Convert.ToDateTime(form["end_time"]).ToString("HH:mm");
            }
            if (ExecFlag == "new")
            {
                start = DateTime.Now.ToString("yyyy/MM/dd 00:00:00");    //查詢_開始日期時間
                end = DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss");        //查詢_結束日期時間
                ViewBag.start_date = DateTime.Now.ToString("yyyy/MM/dd");
                ViewBag.end_date = DateTime.Now.ToString("yyyy/MM/dd");
                ViewBag.start_time = "00:00";
                ViewBag.end_time = DateTime.Now.ToString("HH:mm");
                ExecFlag = "quiryInterval";

            }
            #region 取得用藥明細
            //PROCESS UD FORM WEB SERVICE
            var str1 = WebS_UdOrder(feeno, start, end, ExecFlag, "", medtype);
            if (str1 == "weberror")
                return Redirect("../CommonMedication/Med_QueryExecLog?ExecFlag=weberror");

            if (dt_all.Rows.Count > 0)
            {
                dt_all.Columns.Add("use_t");//使用時間
                dt_all.Columns.Add("use_s");//使用順序
                dt_all.Columns.Add("use_d");
                dt_all.Columns.Add("use_execname");
                dt_all.Columns.Add("use_execdate");
                dt_all.Columns.Add("use_exectime");
                dt_all.Columns.Add("use_reason");
                //=============
                dt_all.Columns.Add("check_execname"); //執行覆核給藥的人
                dt_all.Columns.Add("check_execdate");   //執行覆核給藥的日期
                dt_all.Columns.Add("check_exectime");   //執行覆核給藥的時間
                                                        //====
                dt_all.Columns.Add("insulin");   //胰島素注射部位 
                foreach (DataRow dr in dt_all.Rows)
                {
                    DataTable dtt = cm.get_QueryExecLogTime(feeno, dr["UD_SEQ"].ToString(), start, end, TypeFlag, ExecFlag);
                    if (dtt != null && dtt.Rows.Count > 0)
                    {
                        dr["use_s"] = dtt.Rows[0]["use_s"].ToString().TrimEnd(',');
                        dr["use_t"] = dtt.Rows[0]["use_t"].ToString().TrimEnd(',');
                        dr["use_d"] = dtt.Rows[0]["use_d"].ToString().TrimEnd(',');
                        dr["use_execname"] = dtt.Rows[0]["use_execname"].ToString().TrimEnd(',');
                        dr["use_execdate"] = dtt.Rows[0]["use_execdate"].ToString().TrimEnd(',');
                        dr["use_exectime"] = dtt.Rows[0]["use_exectime"].ToString().TrimEnd(',');
                        dr["use_reason"] = dtt.Rows[0]["use_reason"].ToString().TrimEnd(',');
                        //===========
                        dr["check_execname"] = dtt.Rows[0]["check_execname"].ToString().TrimEnd(',');
                        dr["check_execdate"] = dtt.Rows[0]["check_execdate"].ToString().TrimEnd(',');
                        dr["check_exectime"] = dtt.Rows[0]["check_exectime"].ToString().TrimEnd(',');
                        dr["insulin"] = dtt.Rows[0]["insulin"].ToString().TrimEnd(',');
                    }
                }
                ViewBag.dt_all = dt_all;
            }
            #endregion
            ViewBag.feeno = feeno;
            ViewBag.medtype = medtype;
            return View();
        }

        //病人用藥
        public string WebS_UdOrder(string feeno, string start, string end, string ExecFlag, string medcode, bool? medtype)
        {
            byte[] doByteCode = webService.GetUdOrder(feeno, "A");
            if (doByteCode == null)
            { return ("weberror"); }
            string doJsonArr = CompressTool.DecompressString(doByteCode);
            List<UdOrder> GetUdOrderList = JsonConvert.DeserializeObject<List<UdOrder>>(doJsonArr);

            dt_udorder = ConvertToDataTable(GetUdOrderList);

            if (ExecFlag == "quiryAll" || ExecFlag == "quiryInterval")
            {   //給藥查詢
                dt_all = cm.get_drugtable();
                dt_udorder.DefaultView.Sort = "UD_SEQ, BEGIN_DATE";
                dt_udorder = dt_udorder.DefaultView.ToTable();

                if (medtype == true)
                {
                    DataTable tempTable = new DataTable();
                    tempTable = dt_udorder.Clone();
                    foreach (DataRow dt_udorder_r in dt_udorder.Rows)
                        if (dt_udorder_r["UD_TYPE"].ToString() == "IV")
                            tempTable.ImportRow(dt_udorder_r);

                    dt_all = tempTable.Copy();
                }
                else
                    dt_all = dt_udorder.Copy();
            }
            return ("OK");
        }

        public DataTable ConvertToDataTable<T>(IList<T> data)
        {
            System.ComponentModel.PropertyDescriptorCollection properties = System.ComponentModel.TypeDescriptor.GetProperties(typeof(T));
            DataTable table = new DataTable();
            foreach (System.ComponentModel.PropertyDescriptor prop in properties)
                table.Columns.Add(prop.Name, Nullable.GetUnderlyingType(prop.PropertyType) ?? prop.PropertyType);
            foreach (T item in data)
            {
                DataRow row = table.NewRow();
                foreach (System.ComponentModel.PropertyDescriptor prop in properties)
                    row[prop.Name] = prop.GetValue(item) ?? DBNull.Value;
                table.Rows.Add(row);
            }
            return table;

        }

        //Session 檢查
        public bool Check_Session(string success)
        {
            if (Session["PatInfo"] != null)
            {
                if (success == "yes")
                    Response.Write("<script>alert('儲存成功!')</script>");
                else if (success == "no")
                    Response.Write("<script>alert('儲存失敗!')</script>");
                else if (success == "ck")
                    Response.Write("<script>alert('未勾選給藥時間!')</script>");
                else if (success == "unselcet_pat")
                    Response.Write("<script>alert('尚未選擇病患!')</script>");
                else if (success == "overdue")
                    Response.Write("<script>alert('Session過期!')</script>");
                else if (success == "weberror")
                    Response.Write("<script>alert('此病人尚未開立任何藥囑!')</script>");
                return false;
            }
            else
            {
                return true;
            }
        }
        #endregion


        #region 生產紀錄
        public ActionResult Before_Birth_List(string mode, string feeno, string chartno, bool IsHisView = false)
        {
            ViewBag.IsHisView = IsHisView;

            if (IsHisView)
            {
                his.ControllerContext = ControllerContext;
                his.getSession(feeno);
            }

            if (Session["PatInfo"] != null)
            {
                if (feeno == "" || feeno == null)
                    feeno = ptinfo.FeeNo;
                if (chartno == "" || chartno == null)
                    chartno = ptinfo.ChartNo;

                #region 產檢資料
                //GetBabyLab
                byte[] BabyLablistByteCode = webService.GetBabyLab(feeno, DateTime.Now.AddMonths(-8).ToString("yyyy/MM/dd"), DateTime.Now.ToString("yyyy/MM/dd"));
                if (BabyLablistByteCode == null)
                    ViewBag.BabyLab = new BabyLab();
                else
                {
                    string listJsonArray = CompressTool.DecompressString(BabyLablistByteCode);
                    BabyLab[] BabyLab = JsonConvert.DeserializeObject<BabyLab[]>(listJsonArray);

                    //'6314032' - HBsAg
                    ViewBag.HBsAg = BabyLab.Where(x => x.LabCode.Trim() == "6314032").FirstOrDefault();
                    //'6314035' - HBeAg
                    ViewBag.HBeAg = BabyLab.Where(x => x.LabCode.Trim() == "6314035").FirstOrDefault();
                    //'6312001' - VDRL
                    var VDRL = BabyLab.Where(x => x.LabCode.Trim() == "6312001").ToList();
                    if (VDRL.Count() == 1)
                        ViewBag.VDRL1 = VDRL[0];
                    else if (VDRL.Count() > 1)
                    {
                        ViewBag.VDRL1 = VDRL[0];
                        ViewBag.VDRL2 = VDRL[1];
                    }
                    //'6314044' - Rubella IgG
                    ViewBag.IgG = BabyLab.Where(x => x.LabCode.Trim() == "6314044").FirstOrDefault();
                    //'6399049' - HIV
                    ViewBag.HIV = BabyLab.Where(x => x.LabCode.Trim() == "6399049").FirstOrDefault();
                    //'6313905' - GBS乙型鏈球菌
                    ViewBag.GBS = BabyLab.Where(x => x.LabCode.Trim() == "6313905").FirstOrDefault();

                    //'6399063' - Low range Total-IgE(新生兒)
                    ViewBag.IgE = BabyLab.Where(x => x.LabCode.Trim() == "6399063").FirstOrDefault();
                    //'6399121' - 糞便潛血 - 定量免疫法
                    //ViewBag. = BabyLab.Where(x => x.LabCode.Trim() == "6399121").FirstOrDefault();
                }
                #endregion

                #region 患者資料（生產史產婦資料）
                //GetBaByPatInfo
                byte[] BaByPatInfolistByteCode = webService.GetBaByPatInfo(feeno);
                if (BaByPatInfolistByteCode == null)
                    ViewBag.BaByPatInfo = new BaByPatInfo_FeeNo();
                else
                {
                    string listJsonArray = CompressTool.DecompressString(BaByPatInfolistByteCode);
                    BaByPatInfo_FeeNo[] baByPatInfo = JsonConvert.DeserializeObject<BaByPatInfo_FeeNo[]>(listJsonArray);
                    ViewBag.BaByPatInfo = baByPatInfo[0];
                }
                #endregion

                #region 門診SDM資料
                //GetSDM
                byte[] SDMlistByteCode = webService.GetSDM(chartno);
                if (SDMlistByteCode == null)
                {
                    ViewBag.SDMFEED = "門診(無)";
                    ViewBag.SDMROOM_IN = "門診(無)";
                }
                else
                {
                    string listJsonArray = CompressTool.DecompressString(SDMlistByteCode);
                    SDMInfo[] SDMInfo = JsonConvert.DeserializeObject<SDMInfo[]>(listJsonArray);

                    var SDM = SDMInfo[0];

                    if (SDM.SDM1 == "1")
                        ViewBag.SDMROOM_IN = "門診(24小時)";
                    else if (SDM.SDM1 == "2")
                        ViewBag.SDMROOM_IN = "門診(部分時段)";
                    else if (SDM.SDM1 == "3")
                        ViewBag.SDMROOM_IN = "門診(分離照顧)";
                    else if (SDM.SDM1 == "4")
                        ViewBag.SDMROOM_IN = "門診(尚未決定)";
                    else
                        ViewBag.SDMROOM_IN = "門診(無)";

                    if (SDM.SDM2 == "1")
                        ViewBag.SDMFEED = "門診(純母乳)";
                    else if (SDM.SDM2 == "2")
                        ViewBag.SDMFEED = "門診(混合乳)";
                    else if (SDM.SDM2 == "3")
                        ViewBag.SDMFEED = "門診(配方奶)";
                    else if (SDM.SDM1 == "4")
                        ViewBag.SDMFEED = "門診(尚未決定)";
                    else
                        ViewBag.SDMFEED = "門診(無)";
                }
                #endregion

                #region 成人入評
                var sql = "SELECT * FROM (SELECT TABLEID, NATYPE FROM ASSESSMENTMASTER "
                        + "WHERE FEENO = '" + feeno + "' AND NATYPE = 'A' AND DELETED IS NULL "
                        + "AND STATUS NOT IN ('TEMPORARY','DELETE') "
                        + "ORDER BY CREATETIME DESC, MODIFYTIME DESC) WHERE ROWNUM <= 1 ";
                string TableId = string.Empty, NaType = string.Empty;

                DataTable Dt2 = link.DBExecSQL(sql); //上面已有Dt變數
                if (Dt2.Rows.Count > 0)
                {
                    for (int i = 0; i < Dt2.Rows.Count; i++)

                    {
                        TableId = Dt2.Rows[i]["TABLEID"].ToString();
                        NaType = Dt2.Rows[i]["NATYPE"].ToString();

                    }
                }

                if (TableId != string.Empty && NaType != string.Empty)
                {
                    //取得所有入評值
                    sql = "SELECT * FROM ASSESSMENTDETAIL WHERE TABLEID = '" + TableId + "' ";

                    Dt2 = link.DBExecSQL(sql);
                    if (Dt2.Rows.Count > 0)
                    {
                        for (int i = 0; i < Dt2.Rows.Count; i++)
                        {
                            if (Dt2.Rows[i]["ITEMID"].ToString() == "param_job")
                            {
                                ViewBag.Career = Dt2.Rows[i]["ITEMVALUE"].ToString();
                            }
                            //懷孕次數(G)
                            if (Dt2.Rows[i]["ITEMID"].ToString() == "param_BornHistory_G")
                            {
                                ViewBag.BornHistory_G = Dt2.Rows[i]["ITEMVALUE"].ToString();
                            }
                            //活產數(P)
                            if (Dt2.Rows[i]["ITEMID"].ToString() == "param_BornHistory_P")
                            {
                                ViewBag.BornHistory_P = Dt2.Rows[i]["ITEMVALUE"].ToString();
                            }
                            //流產數(A)
                            if (Dt2.Rows[i]["ITEMID"].ToString() == "param_BornHistory_A")
                            {
                                ViewBag.BornHistory_A = Dt2.Rows[i]["ITEMVALUE"].ToString();
                            }
                            //子宮外孕(E)
                            if (Dt2.Rows[i]["ITEMID"].ToString() == "param_BornHistory_E")
                            {
                                ViewBag.BornHistory_E = Dt2.Rows[i]["ITEMVALUE"].ToString();
                            }
                            //妊娠週數
                            if (Dt2.Rows[i]["ITEMID"].ToString() == "param_BornHistory_W")
                            {
                                ViewBag.BornHistory_W = Dt2.Rows[i]["ITEMVALUE"].ToString();
                            }
                            //總活產數
                            if (Dt2.Rows[i]["ITEMID"].ToString() == "param_BornHistory_T")
                            {
                                ViewBag.BornHistory_T = Dt2.Rows[i]["ITEMVALUE"].ToString();
                            }
                            //服藥
                            if (Dt2.Rows[i]["ITEMID"].ToString() == "param_med")
                            {
                                ViewBag.Med = Dt2.Rows[i]["ITEMVALUE"].ToString();
                            }
                            if (Dt2.Rows[i]["ITEMID"].ToString() == "param_med_name")
                            {
                                ViewBag.Med_Name = Dt2.Rows[i]["ITEMVALUE"].ToString();
                            }
                        }
                    }
                }
                #endregion

                #region 產程監測 抗生素時間
                DataTable dtPrc = obs_m.sel_Instantly_Be_Birth(feeno, "", "");
                if (dtPrc != null && dtPrc.Rows.Count > 0)
                {
                    for (var a = dtPrc.Rows.Count - 1; a >= 0; a--)
                    {
                        var iid = dtPrc.Rows[a]["IID"].ToString();

                        var dtlSql = $@"SELECT * FROM OBS_BPDISP 
WHERE IID = '{iid}' AND TM_MED_ANTIBIOTIC != '00000'";
                        DataTable DtBpDisp = obs_m.DBExecSQL(dtlSql);
                        if (DtBpDisp != null && DtBpDisp.Rows.Count > 0)
                        {
                            ViewBag.GBS_AB = dtPrc.Rows[a]["RECORDTIME"].ToString();
                            break;
                        }
                    }
                }
                #endregion

                #region 生產史
                DataTable dt = obs_m.sel_bthhis(feeno);
                dt.Columns.Add("CREATNO_NAME");
                dt.Columns.Add("CREATNO2_NAME");
                dt.Columns.Add("HBSAG_INST_NAME");
                dt.Columns.Add("HBEAG_INST_NAME");
                dt.Columns.Add("RUBELLA_INST_NAME");
                dt.Columns.Add("VDRL1_INST_NAME");
                dt.Columns.Add("VDRL2_INST_NAME");
                dt.Columns.Add("HIV_INST_NAME");
                dt.Columns.Add("GBS_INST_NAME");
                dt.Columns.Add("PAT_ZONEC");
                dt.Columns.Add("MAT_ZONEC");
                if (dt != null && dt.Rows.Count > 0)
                {
                    foreach (DataRow r in dt.Rows)
                    {
                        ViewBag.O_GBS_AB = r["GBS_AB"].ToString();
                        ViewBag.O_GBS_AB_TYPE = r["GBS_AB_TYP"].ToString();

                        DataTable pat_area = obs_m.sel_v_area("", r["PAT_ZONE"].ToString());
                        if (pat_area != null && pat_area.Rows.Count > 0)
                            r["PAT_ZONEC"] = pat_area.Rows[0]["AREA_NAME"];
                        DataTable mat_area = obs_m.sel_v_area("", r["MAT_ZONE"].ToString());
                        if (mat_area != null && mat_area.Rows.Count > 0)
                            r["MAT_ZONEC"] = mat_area.Rows[0]["AREA_NAME"];

                        r["HBSAG_INST_NAME"] = Get_INSPTList(r["HBSAG_INST"].ToString());
                        r["HBEAG_INST_NAME"] = Get_INSPTList(r["HBEAG_INST"].ToString());
                        r["RUBELLA_INST_NAME"] = Get_INSPTList(r["RUBELLA_INST"].ToString());
                        r["VDRL1_INST_NAME"] = Get_INSPTList(r["VDRL1_INST"].ToString());
                        r["VDRL2_INST_NAME"] = Get_INSPTList(r["VDRL2_INST"].ToString());
                        r["HIV_INST_NAME"] = Get_INSPTList(r["HIV_INST"].ToString());
                        r["GBS_INST_NAME"] = Get_INSPTList(r["GBS_INST"].ToString());

                        if (r["CREATNO"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["CREATNO"].ToString());
                            if (listByteCode == null)
                                r["CREATNO_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["CREATNO_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["CREATNO2"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["CREATNO2"].ToString());
                            if (listByteCode == null)
                                r["CREATNO2_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["CREATNO2_NAME"] = user_name.EmployeesName;
                            }
                        }
                    }
                }
                ViewBag.dt = set_dt(dt);
                #endregion

                #region 第二、三產程
                DataTable stadt = obs_m.sel_bthsta(feeno);
                stadt.Columns.Add("PHYSICIAN_1_NAME");
                stadt.Columns.Add("PHYSICIAN_2_NAME");
                stadt.Columns.Add("CLNURSE_1_NAME");
                stadt.Columns.Add("CLNURSE_2_NAME");
                stadt.Columns.Add("SRNURSE_1_NAME");
                stadt.Columns.Add("SRNURSE_2_NAME");
                stadt.Columns.Add("NNP_1_NAME");
                stadt.Columns.Add("NNP_2_NAME");
                if (stadt != null && stadt.Rows.Count > 0)
                {
                    foreach (DataRow r in stadt.Rows)
                    {
                        if (r["EMR_SIGN"].ToString() == "" && r["EMR_TIME"].ToString() == "")
                        {
                            ViewBag.IsEMR = false;
                        }
                        else
                        {
                            ViewBag.IsEMR = true;
                        }

                        if (r["PHYSICIAN_1"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["PHYSICIAN_1"].ToString());
                            if (listByteCode == null)
                                r["PHYSICIAN_1_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["PHYSICIAN_1_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["PHYSICIAN_2"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["PHYSICIAN_2"].ToString());
                            if (listByteCode == null)
                                r["PHYSICIAN_2_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["PHYSICIAN_2_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["CLNURSE_1"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["CLNURSE_1"].ToString());
                            if (listByteCode == null)
                                r["CLNURSE_1_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["CLNURSE_1_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["CLNURSE_2"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["CLNURSE_2"].ToString());
                            if (listByteCode == null)
                                r["CLNURSE_2_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["CLNURSE_2_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["SRNURSE_1"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["SRNURSE_1"].ToString());
                            if (listByteCode == null)
                                r["SRNURSE_1_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["SRNURSE_1_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["SRNURSE_2"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["SRNURSE_2"].ToString());
                            if (listByteCode == null)
                                r["SRNURSE_2_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["SRNURSE_2_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["NNP_1"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["NNP_1"].ToString());
                            if (listByteCode == null)
                                r["NNP_1_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["NNP_1_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["NNP_2"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["NNP_2"].ToString());
                            if (listByteCode == null)
                                r["NNP_2_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["NNP_2_NAME"] = user_name.EmployeesName;
                            }
                        }
                    }
                }
                ViewBag.stadt = set_dt(stadt);

                #endregion

                DataTable nbdt = obs_m.sel_nb(feeno);
                ViewBag.nbdt = set_dt(nbdt);

                if (nbdt != null)
                    ViewBag.count = nbdt.Rows.Count;
                else
                    ViewBag.count = 0;

                ViewBag.mode = mode;

                ViewBag.ptinfo = Session["PatInfo"] as PatientInfo;
                if (!IsHisView)
                {
                    ViewBag.userno = userinfo.EmployeesNo;//20190821 簽章用
                }
                ViewBag.RootDocument = GetSourceUrl();//20190821 簽章用

                return View();
            }
            Response.Write("<script>alert('請重新選擇病患');</script>");
            return new EmptyResult();
        }
        #endregion

        #region 新增生產史及相關資料
        /// <summary>
        /// 新增生產史
        /// </summary>
        /// <param name="form"></param>
        /// <returns></returns>
        public ActionResult Insert_Before_Birth_History(FormCollection form)
        {
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo?.FeeNo;
            string id = base.creatid("OBS_BTHHIS", userno, feeno, "0");
            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("IID", id, DBItem.DBDataType.String)); //序號
            insertDataList.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String)); //批價序號
            insertDataList.Add(new DBItem("CREATNO", form["TXT_CREATNO"], DBItem.DBDataType.String)); //建立者員編
            insertDataList.Add(new DBItem("CREATNO2", form["TXT_CREATNO2"], DBItem.DBDataType.String)); //建立者員編
            insertDataList.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
            insertDataList.Add(new DBItem("RECORDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間
            insertDataList.Add(new DBItem("DELETED", null, DBItem.DBDataType.String)); //刪除註記

            insertDataList.Add(new DBItem("PAT_ID", form["TXT_PAT_ID"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("PAT_NAME", form["TXT_PAT_NAME"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("PAT_BIRTH", form["TXT_PAT_BIRTH"], DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("PAT_AGE", form["TXT_PAT_AGE"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("PAT_ZONE", form["TXT_PAT_ZONE"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("PAT_NAT", form["TXT_PAT_NAT"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("PAT_BT", form["TXT_PAT_BT"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("PAT_EDU", form["DDL_PAT_EDU"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("PAT_TEL", form["TXT_PAT_TEL"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("PAT_OCU", form["TXT_PAT_OCU"], DBItem.DBDataType.String));

            var MAT_STA = form["DDL_MAT_STA"];
            insertDataList.Add(new DBItem("MAT_STA", MAT_STA, DBItem.DBDataType.String));

            if (MAT_STA == "2")
            {
                insertDataList.Add(new DBItem("MAT_ID", form["TXT_MAT_ID"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("MAT_NAME", form["TXT_MAT_NAME"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("MAT_BIRTH", form["TXT_MAT_BIRTH"], DBItem.DBDataType.DataTime));
                insertDataList.Add(new DBItem("MAT_AGE", form["TXT_MAT_AGE"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("MAT_ZONE", form["TXT_MAT_ZONE"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("MAT_NAT", form["TXT_MAT_NAT"], DBItem.DBDataType.String));

                var MAT_BT_N = form["RB_MAT_BT_N"];
                insertDataList.Add(new DBItem("MAT_BT_N", MAT_BT_N, DBItem.DBDataType.String));
                if (MAT_BT_N != "1")
                {
                    insertDataList.Add(new DBItem("MAT_BT", form["TXT_MAT_BT"], DBItem.DBDataType.String));
                }
                insertDataList.Add(new DBItem("MAT_EDU", form["DDL_MAT_EDU"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("MAT_TEL", form["TXT_MAT_TEL"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("MAT_OCU", form["TXT_MAT_OCU"], DBItem.DBDataType.String));
            }

            insertDataList.Add(new DBItem("EDC", form["TXT_EDC"], DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("GA_W", form["TXT_GA_W"], DBItem.DBDataType.Number));
            insertDataList.Add(new DBItem("GA_D", form["TXT_GA_D"], DBItem.DBDataType.Number));

            insertDataList.Add(new DBItem("GRAVIDA", form["TXT_GRAVIDA"], DBItem.DBDataType.Number));
            insertDataList.Add(new DBItem("PARITY", form["TXT_PARITY"], DBItem.DBDataType.Number));
            insertDataList.Add(new DBItem("ABORTION", form["TXT_ABORTION"], DBItem.DBDataType.Number));
            insertDataList.Add(new DBItem("ECCYESIS", form["TXT_ECCYESIS"], DBItem.DBDataType.Number));
            insertDataList.Add(new DBItem("LB_TOTAL", form["TXT_LB_TOTAL"], DBItem.DBDataType.Number));

            insertDataList.Add(new DBItem("VBAC", form["RB_VBAC"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("HBSAG", form["DDL_HBSAG"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("HBSAG_INST", form["TXT_HBSAG_INST"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("HBEAG", form["DDL_HBEAG"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("HBEAG_INST", form["TXT_HBEAG_INST"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("RUBELLA", form["DDL_RUBELLA"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("RUBELLA_INST", form["TXT_RUBELLA_INST"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("VDRL1", form["DDL_VDRL1"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("VDRL1_INST", form["TXT_VDRL1_INST"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("VDRL2", form["DDL_VDRL2"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("VDRL2_INST", form["TXT_VDRL2_INST"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("HIV", form["DDL_HIV"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("HIV_INST", form["TXT_HIV_INST"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("HIVPT_R", form["RB_HIVPT_R"], DBItem.DBDataType.String));

            var GBS = form["DDL_GBS"];
            insertDataList.Add(new DBItem("GBS", GBS, DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("GBS_INST", form["TXT_GBS_INST"], DBItem.DBDataType.String));

            if (form["TXT_GBS_AB_DAY"] + " " + form["TXT_GBS_AB_TIME"] != " ")
                insertDataList.Add(new DBItem("GBS_AB", form["TXT_GBS_AB_DAY"] + " " + form["TXT_GBS_AB_TIME"], DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("GBS_AB_TYP", form["RB_GBS_AB_TYP"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("ROOM_IN", form["RB_ROOM_IN"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("FEED", form["RB_FEED"], DBItem.DBDataType.String));

            var PREG = form["RB_PREG"];
            insertDataList.Add(new DBItem("PREG", PREG, DBItem.DBDataType.String));
            if (PREG == "1")
            {
                var PREG_ITM = form["CK_PREG_ITM"];
                var PREG_ITMV = new List<string>() { "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0" };
                if (PREG_ITM == null)
                    insertDataList.Add(new DBItem("PREG_ITM", String.Join("", PREG_ITMV), DBItem.DBDataType.String));
                else
                {
                    var PREG_ITM_SP = PREG_ITM.Split(',');
                    foreach (var v in PREG_ITM_SP)
                        PREG_ITMV[Convert.ToInt32(v)] = "1";
                    insertDataList.Add(new DBItem("PREG_ITM", String.Join("", PREG_ITMV), DBItem.DBDataType.String));
                }

                if (PREG_ITMV[11] == "1")
                    insertDataList.Add(new DBItem("PREG_OTH", form["TXT_PREG_OTH"], DBItem.DBDataType.String));
            }

            var DISE = form["RB_DISE"];
            insertDataList.Add(new DBItem("DISE", DISE, DBItem.DBDataType.String));
            if (DISE == "1")
            {
                var DISE_ITM = form["CK_DISE_ITM"];
                var DISE_ITMV = new List<string>() { "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0" };
                if (DISE_ITM == null)
                    insertDataList.Add(new DBItem("DISE_ITM", String.Join("", DISE_ITMV), DBItem.DBDataType.String));
                else
                {
                    var DISE_ITM_SP = DISE_ITM.Split(',');
                    foreach (var v in DISE_ITM_SP)
                        DISE_ITMV[Convert.ToInt32(v)] = "1";
                    insertDataList.Add(new DBItem("DISE_ITM", String.Join("", DISE_ITMV), DBItem.DBDataType.String));
                }

                if (DISE_ITMV[13] == "1")
                    insertDataList.Add(new DBItem("DISE_OTH", form["TXT_DISE_OTH"], DBItem.DBDataType.String));
            }

            insertDataList.Add(new DBItem("MED_REC_YN", form["RB_MED_REC_YN"], DBItem.DBDataType.String));
            if (form["RB_MED_REC_YN"] == "1")
                insertDataList.Add(new DBItem("MED_REC", form["TXT_MED_REC"], DBItem.DBDataType.String));
            insertDataList = setNullToEmpty(insertDataList);
            int erow = obs_m.DBExecInsert("OBS_BTHHIS", insertDataList);
            if (erow > 0)
                Response.Write("<script>alert('新增成功');window.location.href='Index?active=Before_Birth_List&show=Y'</script>");
            else
                Response.Write("<script>alert('新增失敗');window.location.href='Index?active=Before_Birth_List&show=Y'</script>");
            return new EmptyResult();
        }
        #endregion

        #region 編輯生產史及相關資料
        /// <summary>
        /// 編輯生產史
        /// </summary>
        /// <param name="form"></param>
        /// <returns></returns>
        public ActionResult Upd_Before_Birth_History(FormCollection form)
        {
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo?.FeeNo;
            string id = form["IID"];
            var UnAuthorize = false;

            DataTable dt_bthsta = obs_m.sel_bthsta(ptinfo.FeeNo);
            if (dt_bthsta != null && dt_bthsta.Rows.Count > 0)
            {
                DataRow r = dt_bthsta.Rows[0];
                if (r["EMR_SIGN"].ToString() != "" && r["EMR_TIME"].ToString() != "")
                {
                    if (r["CLNURSE_1"].ToString() != userinfo.EmployeesNo && r["CLNURSE_2"].ToString() != userinfo.EmployeesNo)
                    {
                        Response.Write("<script>alert('無權限修改');window.location.href='Index?active=Before_Birth_List&show=Y'</script>");
                        return new EmptyResult();
                    }
                }
                else
                {
                    DataTable dt = obs_m.sel_bthhis("", id);
                    if (dt != null && dt.Rows.Count > 0)
                    {
                        foreach (DataRow row in dt.Rows)
                        {
                            if (row["CREATNO"].ToString().Trim() != userinfo.EmployeesNo && row["CREATNO2"].ToString().Trim() != userinfo.EmployeesNo)
                            {
                                UnAuthorize = true;
                            }
                        }
                    }
                }
            }
            else
            {
                DataTable dt = obs_m.sel_bthhis("", id);
                if (dt != null && dt.Rows.Count > 0)
                {
                    foreach (DataRow r in dt.Rows)
                    {
                        if (r["CREATNO"].ToString().Trim() != userinfo.EmployeesNo && r["CREATNO2"].ToString().Trim() != userinfo.EmployeesNo)
                        {
                            UnAuthorize = true;
                        }
                    }
                }
            }

            if (UnAuthorize)
            {
                Response.Write("<script>alert('無權限修改');window.location.href='Index?active=Before_Birth_List&show=Y'</script>");
            }
            else
            {
                List<DBItem> insertDataList = new List<DBItem>();
                insertDataList.Add(new DBItem("CREATNO", form["TXT_CREATNO"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("UPDNO", form["TXT_CREATNO"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("CREATNO2", form["TXT_CREATNO2"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("UPDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
                insertDataList.Add(new DBItem("RECORDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間
                insertDataList.Add(new DBItem("DELETED", null, DBItem.DBDataType.String)); //刪除註記

                insertDataList.Add(new DBItem("PAT_ID", form["TXT_PAT_ID"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("PAT_NAME", form["TXT_PAT_NAME"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("PAT_BIRTH", form["TXT_PAT_BIRTH"], DBItem.DBDataType.DataTime));
                insertDataList.Add(new DBItem("PAT_AGE", form["TXT_PAT_AGE"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("PAT_ZONE", form["TXT_PAT_ZONE"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("PAT_NAT", form["TXT_PAT_NAT"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("PAT_BT", form["TXT_PAT_BT"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("PAT_EDU", form["DDL_PAT_EDU"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("PAT_TEL", form["TXT_PAT_TEL"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("PAT_OCU", form["TXT_PAT_OCU"], DBItem.DBDataType.String));

                var MAT_STA = form["DDL_MAT_STA"];
                insertDataList.Add(new DBItem("MAT_STA", MAT_STA, DBItem.DBDataType.String));

                if (MAT_STA == "2")
                {
                    insertDataList.Add(new DBItem("MAT_ID", form["TXT_MAT_ID"], DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("MAT_NAME", form["TXT_MAT_NAME"], DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("MAT_BIRTH", form["TXT_MAT_BIRTH"], DBItem.DBDataType.DataTime));
                    insertDataList.Add(new DBItem("MAT_AGE", form["TXT_MAT_AGE"], DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("MAT_ZONE", form["TXT_MAT_ZONE"], DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("MAT_NAT", form["TXT_MAT_NAT"], DBItem.DBDataType.String));

                    var MAT_BT_N = form["RB_MAT_BT_N"];
                    insertDataList.Add(new DBItem("MAT_BT_N", MAT_BT_N, DBItem.DBDataType.String));
                    if (MAT_BT_N != "1")
                        insertDataList.Add(new DBItem("MAT_BT", form["TXT_MAT_BT"], DBItem.DBDataType.String));

                    insertDataList.Add(new DBItem("MAT_EDU", form["DDL_MAT_EDU"], DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("MAT_TEL", form["TXT_MAT_TEL"], DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("MAT_OCU", form["TXT_MAT_OCU"], DBItem.DBDataType.String));
                }
                else
                {
                    //20200930
                    insertDataList.Add(new DBItem("MAT_ID", "", DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("MAT_NAME", "", DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("MAT_BIRTH", "", DBItem.DBDataType.DataTime));
                    insertDataList.Add(new DBItem("MAT_AGE", "", DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("MAT_ZONE", "", DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("MAT_NAT", "", DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("MAT_BT_N", "", DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("MAT_BT", "", DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("MAT_EDU", "", DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("MAT_TEL", "", DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("MAT_OCU", "", DBItem.DBDataType.String));

                }

                insertDataList.Add(new DBItem("EDC", form["TXT_EDC"], DBItem.DBDataType.DataTime));
                insertDataList.Add(new DBItem("GA_W", form["TXT_GA_W"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("GA_D", form["TXT_GA_D"], DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("GRAVIDA", form["TXT_GRAVIDA"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("PARITY", form["TXT_PARITY"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("ABORTION", form["TXT_ABORTION"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("ECCYESIS", form["TXT_ECCYESIS"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("LB_TOTAL", form["TXT_LB_TOTAL"], DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("VBAC", form["RB_VBAC"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("HBSAG", form["DDL_HBSAG"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("HBSAG_INST", form["TXT_HBSAG_INST"], DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("HBEAG", form["DDL_HBEAG"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("HBEAG_INST", form["TXT_HBEAG_INST"], DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("RUBELLA", form["DDL_RUBELLA"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("RUBELLA_INST", form["TXT_RUBELLA_INST"], DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("VDRL1", form["DDL_VDRL1"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("VDRL1_INST", form["TXT_VDRL1_INST"], DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("VDRL2", form["DDL_VDRL2"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("VDRL2_INST", form["TXT_VDRL2_INST"], DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("HIV", form["DDL_HIV"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("HIV_INST", form["TXT_HIV_INST"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("HIVPT_R", form["RB_HIVPT_R"], DBItem.DBDataType.String));

                var GBS = form["DDL_GBS"];
                insertDataList.Add(new DBItem("GBS", GBS, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("GBS_INST", form["TXT_GBS_INST"], DBItem.DBDataType.String));

                if (form["TXT_GBS_AB_DAY"] + " " + form["TXT_GBS_AB_TIME"] != " ")
                    insertDataList.Add(new DBItem("GBS_AB", form["TXT_GBS_AB_DAY"] + " " + form["TXT_GBS_AB_TIME"], DBItem.DBDataType.DataTime));

                insertDataList.Add(new DBItem("GBS_AB_TYP", form["RB_GBS_AB_TYP"], DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("ROOM_IN", form["RB_ROOM_IN"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("FEED", form["RB_FEED"], DBItem.DBDataType.String));

                var PREG = form["RB_PREG"];
                insertDataList.Add(new DBItem("PREG", PREG, DBItem.DBDataType.String));
                if (PREG == "1")
                {
                    var PREG_ITM = form["CK_PREG_ITM"];
                    var PREG_ITMV = new List<string>() { "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0" };
                    if (PREG_ITM == null)
                        insertDataList.Add(new DBItem("PREG_ITM", String.Join("", PREG_ITMV), DBItem.DBDataType.String));
                    else
                    {
                        var PREG_ITM_SP = PREG_ITM.Split(',');
                        foreach (var v in PREG_ITM_SP)
                            PREG_ITMV[Convert.ToInt32(v)] = "1";
                        insertDataList.Add(new DBItem("PREG_ITM", String.Join("", PREG_ITMV), DBItem.DBDataType.String));
                    }

                    if (PREG_ITMV[11] == "1")
                        insertDataList.Add(new DBItem("PREG_OTH", form["TXT_PREG_OTH"], DBItem.DBDataType.String));
                }

                var DISE = form["RB_DISE"];
                insertDataList.Add(new DBItem("DISE", DISE, DBItem.DBDataType.String));
                if (DISE == "1")
                {
                    var DISE_ITM = form["CK_DISE_ITM"];
                    var DISE_ITMV = new List<string>() { "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0" };
                    if (DISE_ITM == null)
                        insertDataList.Add(new DBItem("DISE_ITM", String.Join("", DISE_ITMV), DBItem.DBDataType.String));
                    else
                    {
                        var DISE_ITM_SP = DISE_ITM.Split(',');
                        foreach (var v in DISE_ITM_SP)
                            DISE_ITMV[Convert.ToInt32(v)] = "1";
                        insertDataList.Add(new DBItem("DISE_ITM", String.Join("", DISE_ITMV), DBItem.DBDataType.String));
                    }

                    if (DISE_ITMV[13] == "1")
                        insertDataList.Add(new DBItem("DISE_OTH", form["TXT_DISE_OTH"], DBItem.DBDataType.String));
                }
                insertDataList.Add(new DBItem("MED_REC_YN", form["RB_MED_REC_YN"], DBItem.DBDataType.String));
                if (form["RB_MED_REC_YN"] == "1")
                    insertDataList.Add(new DBItem("MED_REC", form["TXT_MED_REC"], DBItem.DBDataType.String));
                else
                    insertDataList.Add(new DBItem("MED_REC", null, DBItem.DBDataType.String));
                string where = " IID = '" + id + "' ";
                insertDataList = setNullToEmpty(insertDataList);
                int erow = obs_m.DBExecUpdate("OBS_BTHHIS", insertDataList, where);
                if (erow > 0)
                    Response.Write("<script>alert('修改成功');window.location.href='Index?active=Before_Birth_List&show=Y'</script>");
                else
                    Response.Write("<script>alert('修改失敗');window.location.href='Index?active=Before_Birth_List&show=Y'</script>");
            }
            return new EmptyResult();
        }
        #endregion


        #region 剖腹產(C/S)原因維護檔畫面
        /// <summary>
        /// C/S維護檔 List
        /// </summary>
        /// <returns></returns>
        public ActionResult CS_R_List()
        {
            DataTable dt = obs_m.sel_csreason();
            ViewBag.dt = set_dt(dt);
            return View();
        }
        #endregion

        #region 新增/編輯 C/S畫面
        /// <summary>
        /// 新增/編輯 C/S畫面
        /// </summary>
        /// <param name="IID"></param>
        /// <returns></returns>
        public ActionResult Insert_CS_Reason(string IID = "")
        {
            if (IID != "" && IID != null)
            {
                DataTable dt = obs_m.sel_csreason(IID);
                ViewBag.dt = set_dt(dt);
            }
            return View();
        }
        #endregion

        #region CS原因新增
        /// <summary>
        /// CS原因新增
        /// </summary>
        /// <param name="form"></param>
        /// <returns></returns>
        [HttpPost]
        public ActionResult Insert_CS_Reason(FormCollection form)
        {
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo?.FeeNo;
            string id = base.creatid("OBS_CS", userno, feeno, "0");
            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("IID", id, DBItem.DBDataType.String)); //序號
            insertDataList.Add(new DBItem("CREATNO", userno, DBItem.DBDataType.String)); //建立者員編
            insertDataList.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
            insertDataList.Add(new DBItem("RECORDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間
            insertDataList.Add(new DBItem("DELETED", null, DBItem.DBDataType.String)); //刪除註記

            insertDataList.Add(new DBItem("CSRS_CHT", form["CSRS_CHT"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("CSRS_ENG", form["CSRS_ENG"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("CSRS_SEQ", form["CSRS_SEQ"], DBItem.DBDataType.String));
            insertDataList = setNullToEmpty(insertDataList);
            int erow = obs_m.DBExecInsert("OBS_CS", insertDataList);
            if (erow > 0)
                Response.Write("<script>alert('新增成功');window.opener.location.href='CS_R_List';window.close();</script>");
            else
                Response.Write("<script>alert('新增失敗');window.opener.location.href='CS_R_List';window.close();</script>");

            return new EmptyResult();
        }
        #endregion

        #region CS原因編輯
        /// <summary>
        /// CS原因編輯
        /// </summary>
        /// <param name="form"></param>
        /// <returns></returns>
        [HttpPost]
        public ActionResult Upd_CS_Reason(FormCollection form)
        {
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo?.FeeNo;
            string id = form["IID"];

            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("UPDNO", userno, DBItem.DBDataType.String)); //建立者員編
            insertDataList.Add(new DBItem("UPDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
            insertDataList.Add(new DBItem("RECORDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間
            insertDataList.Add(new DBItem("DELETED", null, DBItem.DBDataType.String)); //刪除註記

            insertDataList.Add(new DBItem("CSRS_CHT", form["CSRS_CHT"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("CSRS_ENG", form["CSRS_ENG"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("CSRS_SEQ", form["CSRS_SEQ"], DBItem.DBDataType.String));

            string where = " IID = '" + id + "' ";
            insertDataList = setNullToEmpty(insertDataList);
            int erow = obs_m.DBExecUpdate("OBS_CS", insertDataList, where);

            if (erow > 0)
                Response.Write("<script>alert('修改成功');window.opener.location.href='CS_R_List';window.close();</script>");
            else
                Response.Write("<script>alert('修改成功');window.opener.location.href='CS_R_List';window.close();</script>");

            return new EmptyResult();
        }

        #endregion


        #region 第二、三產程紀錄(底下小孩資訊)
        public ActionResult Add_New_Child(string count, bool IsHisView = false)
        {
            ViewBag.IsHisView = IsHisView;

            DataTable nbdt = obs_m.sel_nb(ptinfo.FeeNo);
            ViewBag.nbdt = set_dt(nbdt);

            DataTable stadt = obs_m.sel_bthsta(ptinfo.FeeNo);
            ViewBag.stadt = set_dt(stadt);

            ViewBag.count = count == null ? "0" : count;
            return View();
        }
        #endregion

        #region C/S開窗選擇
        /// <summary>
        /// C/S開窗選擇
        /// </summary>
        /// <param name="page"></param>
        /// <param name="value"></param>
        /// <returns></returns>
        public ActionResult CS_Reason_List(string page, string value)
        {
            DataTable dt = obs_m.sel_csreason();
            ViewBag.dt = set_dt(dt);
            ViewBag.page = page;
            ViewBag.value = value;
            return View();
        }
        #endregion

        #region 新增第二、三產程
        /// <summary>
        /// 新增第二、三產程
        /// </summary>
        /// <param name="form"></param>
        /// <returns></returns>
        [HttpPost]
        public ActionResult Insert_Child_Brith(FormCollection form)
        {
            link.DBOpen();
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo?.FeeNo;
            string id = base.creatid("OBS_BTHSTA", userno, feeno, "0");
            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("IID", id, DBItem.DBDataType.String)); //序號
            insertDataList.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String)); //批價序號
            insertDataList.Add(new DBItem("CREATNO", userno, DBItem.DBDataType.String)); //建立者員編
            insertDataList.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
            insertDataList.Add(new DBItem("RECORDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間
            insertDataList.Add(new DBItem("DELETED", null, DBItem.DBDataType.String)); //刪除註記

            insertDataList.Add(new DBItem("PLACE", form["RB_PLACE"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("PAIN_ST_YN", form["RB_PAIN_ST_YN"], DBItem.DBDataType.String));
            if (form["RB_PAIN_ST_YN"] == "1")
            {
                if (form["TXT_PAIN_ST_DAY"] + " " + form["TXT_PAIN_ST_TIME"] != " ")
                    insertDataList.Add(new DBItem("PAIN_ST", form["TXT_PAIN_ST_DAY"] + " " + form["TXT_PAIN_ST_TIME"], DBItem.DBDataType.DataTime));
                insertDataList.Add(new DBItem("PAIN_ST_NA", form["CK_PAIN_ST_NA"], DBItem.DBDataType.String));
            }

            insertDataList.Add(new DBItem("CERFO_TIME_YN", form["RB_CERFO_TIME_YN"], DBItem.DBDataType.String));
            if (form["RB_CERFO_TIME_YN"] == "1")
            {
                DataTable dt = obs_m.sel_Instantly_Be_Birth(ptinfo?.FeeNo, "", "", "10");
                if (dt != null && dt.Rows.Count > 0)
                {
                    insertDataList.Add(new DBItem("CERFO_TIME", Convert.ToDateTime(dt.Rows[dt.Rows.Count - 1]["RECORDTIME"].ToString()).ToString("yyyy/MM/dd HH:mm"), DBItem.DBDataType.DataTime));
                }
                else
                {
                    if (form["TXT_CERFO_TIME_DAY"] + " " + form["TXT_CERFO_TIME_TIME"] != " ")
                        insertDataList.Add(new DBItem("CERFO_TIME", form["TXT_CERFO_TIME_DAY"] + " " + form["TXT_CERFO_TIME_TIME"], DBItem.DBDataType.DataTime));
                }
                insertDataList.Add(new DBItem("CERFO_TIME_NA", form["CK_CERFO_TIME_NA"], DBItem.DBDataType.String));
            }
            if (form["TXT_RFM_TIME_DAY"] + " " + form["TXT_RFM_TIME_TIME"] != " ")
                insertDataList.Add(new DBItem("RFM_TIME", form["TXT_RFM_TIME_DAY"] + " " + form["TXT_RFM_TIME_TIME"], DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("RFM_TIME_NA", form["CK_RFM_TIME_NA"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("RFM", form["RB_RFM"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("RUPTURETYPE", form["RB_RUPTURETYPE"], DBItem.DBDataType.String));
            if (form["RB_RUPTURETYPE"] == "2")
                insertDataList.Add(new DBItem("MECONIUM_COLOR", form["RB_MECONIUM_COLOR"], DBItem.DBDataType.String));
            else
                insertDataList.Add(new DBItem("MECONIUM_COLOR", null, DBItem.DBDataType.String));

            if (form["TXT_DR_ETTIME_DAY"] + " " + form["TXT_DR_ETTIME_TIME"] != " ")
                insertDataList.Add(new DBItem("DR_ETTIME", form["TXT_DR_ETTIME_DAY"] + " " + form["TXT_DR_ETTIME_TIME"], DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("DR_ETTIME_NA", form["CK_DR_ETTIME_NA"], DBItem.DBDataType.String));

            if (form["TXT_BIRTH_DAY"] + " " + form["TXT_BIRTH_TIME"] != " ")
                insertDataList.Add(new DBItem("BIRTH", form["TXT_BIRTH_DAY"] + " " + form["TXT_BIRTH_TIME"], DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("BIRTH_NA", form["RB_BIRTH_NA"], DBItem.DBDataType.String));

            var BIRTH_TYPE = form["RB_BIRTH_TYPE"];
            insertDataList.Add(new DBItem("BIRTH_TYPE", BIRTH_TYPE, DBItem.DBDataType.String));
            //NSD
            if (BIRTH_TYPE == "0")
            {
                insertDataList.Add(new DBItem("VACUUM_NSD", form["RB_VACUUM_NSD"], DBItem.DBDataType.String));
            }//C/S
            else if (BIRTH_TYPE == "1")
            {
                insertDataList.Add(new DBItem("VACUUM_CS", form["RB_VACUUM_CS"], DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("CS_NOTE", form["RB_CS_NOTE"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("CS_MR", form["TXT_CS_MR"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("CS_OR", form["TXT_CS_OR"], DBItem.DBDataType.String));
            }
            if (form["TXT_DOP_TIME_DAY"] + " " + form["TXT_DOP_TIME_TIME"] != " ")
                insertDataList.Add(new DBItem("DOP_TIME", form["TXT_DOP_TIME_DAY"] + " " + form["TXT_DOP_TIME_TIME"], DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("DOP_TIME_NA", form["CK_DOP_TIME_NA"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("DOP", form["RB_DOP"], DBItem.DBDataType.String));

            if (form["TXT_DR_LVTIME_DAY"] + " " + form["TXT_DR_LVTIME_TIME"] != " ")
                insertDataList.Add(new DBItem("DR_LVTIME", form["TXT_DR_LVTIME_DAY"] + " " + form["TXT_DR_LVTIME_TIME"], DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("DR_LVTIME_NA", form["CK_DR_LVTIME_NA"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("GEST_M", form["TXT_GEST_M"], DBItem.DBDataType.Number));
            insertDataList.Add(new DBItem("GEST_D", form["TXT_GEST_D"], DBItem.DBDataType.Number));
            insertDataList.Add(new DBItem("LB_TOTAL_N", form["TXT_LB_TOTAL_N"], DBItem.DBDataType.Number));

            insertDataList.Add(new DBItem("TOP", form["RB_TOP"], DBItem.DBDataType.String));
            if (form["RB_TOP"] == "1")
            {
                var TOP_RS = form["CK_TOP_RS"];
                var TOP_RSV = new List<string>() { "0", "0", "0", "0", "0", "0" };
                if (TOP_RS == null)
                    insertDataList.Add(new DBItem("TOP_RS", String.Join("", TOP_RSV), DBItem.DBDataType.String));
                else
                {
                    var TOP_RS_SP = TOP_RS.Split(',');
                    foreach (var v in TOP_RS_SP)
                        TOP_RSV[Convert.ToInt32(v)] = "1";
                    insertDataList.Add(new DBItem("TOP_RS", String.Join("", TOP_RSV), DBItem.DBDataType.String));
                }

                if (TOP_RSV[5] == "1")
                    insertDataList.Add(new DBItem("TOP_RS_O", form["TXT_TOP_RS_O"], DBItem.DBDataType.String));
            }

            insertDataList.Add(new DBItem("ABORTION", form["TXT_ABORTION"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("PARITY_N", form["TXT_PARITY_N"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("REMARK", form["TXT_REMARK"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("CORDBLOOD", form["RB_CORDBLOOD"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("EPIDURAL", form["RB_EPIDURAL"], DBItem.DBDataType.String));

            var PATERNITY = form["RB_PATERNITY"];
            insertDataList.Add(new DBItem("PATERNITY", PATERNITY, DBItem.DBDataType.String));
            if (PATERNITY == "0")
            {
                var NP_RS = form["CK_NP_RS"];
                var NP_RSV = new List<string>() { "0", "0", "0", "0", "0", "0" };
                if (NP_RS == null)
                    insertDataList.Add(new DBItem("NP_RS", String.Join("", NP_RSV), DBItem.DBDataType.String));
                else
                {
                    var NP_RS_SP = NP_RS.Split(',');
                    foreach (var v in NP_RS_SP)
                        NP_RSV[Convert.ToInt32(v)] = "1";
                    insertDataList.Add(new DBItem("NP_RS", String.Join("", NP_RSV), DBItem.DBDataType.String));
                }

                if (NP_RSV[5] == "1")
                    insertDataList.Add(new DBItem("NP_RS_OTH", form["TXT_NP_RS_OTH"], DBItem.DBDataType.String));
            }

            insertDataList.Add(new DBItem("CORDCLAMP", form["RB_CORDCLAMP"], DBItem.DBDataType.String));

            var PERINEUM = form["RB_PERINEUM"];
            insertDataList.Add(new DBItem("PERINEUM", PERINEUM, DBItem.DBDataType.String));
            if (PERINEUM == "1" || PERINEUM == "2")
            {
                //傷口評估新增會陰傷口
                var reason = PERINEUM == "1" ? "自然裂傷" : "正中切開術";
                if (form["TXT_BIRTH_DAY"] + " " + form["TXT_BIRTH_TIME"] != " ")
                    Insert_Wound(id + "0", form["TXT_BIRTH_DAY"] + " " + form["TXT_BIRTH_TIME"], "生產", "會陰", 0, "", reason);
                else
                    Insert_Wound(id + "0", DateTime.Now.ToString("yyyy/MM/dd HH:mm"), "生產", "會陰", 0, "", reason);
            }
            if (PERINEUM == "3")
            {
                insertDataList.Add(new DBItem("PERINEUM_OTH", form["TXT_PERINEUM_OTH"], DBItem.DBDataType.String));
            }

            insertDataList.Add(new DBItem("PERI_LAC", form["RB_PERI_LAC"], DBItem.DBDataType.String));

            var ABD_WND = form["RB_ABD_WND"];
            insertDataList.Add(new DBItem("ABD_WND", ABD_WND, DBItem.DBDataType.String));
            if (ABD_WND == "1")
            {
                //傷口評估新增腹部傷口
                if (form["TXT_BIRTH_DAY"] + " " + form["TXT_BIRTH_TIME"] != " ")
                    Insert_Wound(id + "1", form["TXT_BIRTH_DAY"] + " " + form["TXT_BIRTH_TIME"], "手術", "腹部", 0, "", "");
                else
                    Insert_Wound(id + "1", DateTime.Now.ToString("yyyy/MM/dd HH:mm"), "手術", "腹部", 0, "", "");
            }

            insertDataList.Add(new DBItem("PHYSICIAN_1", form["TXT_PHYSICIAN_1"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("PHYSICIAN_2", form["TXT_PHYSICIAN_2"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("CLNURSE_1", form["TXT_CLNURSE_1"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("CLNURSE_2", form["TXT_CLNURSE_2"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("SRNURSE_1", form["TXT_SRNURSE_1"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("SRNURSE_2", form["TXT_SRNURSE_2"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("NNP_1", form["TXT_NNP_1"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("NNP_2", form["TXT_NNP_2"], DBItem.DBDataType.String));

            if (form["TXT_RR_ETTIME_DAY"] + " " + form["TXT_RR_ETTIME_TIME"] != " ")
                insertDataList.Add(new DBItem("RR_ETTIME", form["TXT_RR_ETTIME_DAY"] + " " + form["TXT_RR_ETTIME_TIME"], DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("RR_ETTIME_NA", form["CK_RR_ETTIME_NA"], DBItem.DBDataType.String));

            if (form["TXT_RR_LVTIME_DAY"] + " " + form["TXT_RR_LVTIME_TIME"] != " ")
                insertDataList.Add(new DBItem("RR_LVTIME", form["TXT_RR_LVTIME_DAY"] + " " + form["TXT_RR_LVTIME_TIME"], DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("RR_LVTIME_NA", form["CK_RR_LVTIME_NA"], DBItem.DBDataType.String));
            insertDataList = setNullToEmpty(insertDataList);
            int erow = link.DBExecInsertTns("OBS_BTHSTA", insertDataList);

            if (erow > 0)
            {
                link.DBCommit();
                Response.Write("<script>alert('新增成功');window.location.href='Index?active=Before_Birth_List&mode=1&show=Y'</script>");
            }
            else
            {
                link.DBRollBack();
                Response.Write("<script>alert('新增失敗');window.location.href='Index?active=Before_Birth_List&mode=1&show=Y'</script>");
            }

            return new EmptyResult();
        }
        #endregion

        #region 編輯第二、三產程
        /// <summary>
        /// 編輯第二、三產程
        /// </summary>
        /// <param name="form"></param>
        /// <returns></returns>
        [HttpPost]
        public ActionResult Upd_Child_Brith(FormCollection form)
        {
            RESPONSE_MSG json_result = new RESPONSE_MSG();
            string action_type = form["action_type"].ToString();
            link.DBOpen();
            var UnAuthorize = false;
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo?.FeeNo;
            string id = form["ID"];
            DateTime now_datetime = DateTime.Now;
            DataTable dt = obs_m.sel_bthsta("", null, null, id);
            if (dt != null && dt.Rows.Count > 0)
            {
                foreach (DataRow r in dt.Rows)
                {
                    if (r["CLNURSE_1"].ToString().Trim() != userinfo.EmployeesNo && r["CLNURSE_2"].ToString().Trim() != userinfo.EmployeesNo)
                    {
                        UnAuthorize = true;
                        if (UnAuthorize && action_type.ToLower() == "emr")
                        {
                            json_result.status = RESPONSE_STATUS.ERROR;
                            json_result.message = "無權限送簽";

                            return Content(JsonConvert.SerializeObject(json_result), "application/json");
                        }

                    }
                }
            }

            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("UPDNO", userno, DBItem.DBDataType.String)); //建立者員編
            insertDataList.Add(new DBItem("UPDTIME", now_datetime.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
            insertDataList.Add(new DBItem("RECORDTIME", now_datetime.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間
            insertDataList.Add(new DBItem("DELETED", null, DBItem.DBDataType.String)); //刪除註記

            insertDataList.Add(new DBItem("PLACE", form["RB_PLACE"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("PAIN_ST_YN", form["RB_PAIN_ST_YN"], DBItem.DBDataType.String));
            if (form["RB_PAIN_ST_YN"] == "1")
            {
                if (form["TXT_PAIN_ST_DAY"] + " " + form["TXT_PAIN_ST_TIME"] != " ")
                    insertDataList.Add(new DBItem("PAIN_ST", form["TXT_PAIN_ST_DAY"] + " " + form["TXT_PAIN_ST_TIME"], DBItem.DBDataType.DataTime));
                insertDataList.Add(new DBItem("PAIN_ST_NA", form["CK_PAIN_ST_NA"], DBItem.DBDataType.String));
            }
            else
            {
                insertDataList.Add(new DBItem("PAIN_ST", null, DBItem.DBDataType.DataTime));
                insertDataList.Add(new DBItem("PAIN_ST_NA", null, DBItem.DBDataType.String));
            }

            insertDataList.Add(new DBItem("CERFO_TIME_YN", form["RB_CERFO_TIME_YN"], DBItem.DBDataType.String));

            if (form["RB_CERFO_TIME_YN"] == "1")
            {
                DataTable dt1 = obs_m.sel_Instantly_Be_Birth(ptinfo?.FeeNo, "", "", "10");
                if (dt1 != null && dt1.Rows.Count > 0)
                {
                    insertDataList.Add(new DBItem("CERFO_TIME", Convert.ToDateTime(dt1.Rows[dt1.Rows.Count - 1]["RECORDTIME"].ToString()).ToString("yyyy/MM/dd HH:mm"), DBItem.DBDataType.DataTime));
                }
                else
                {
                    if (form["TXT_CERFO_TIME_DAY"] + " " + form["TXT_CERFO_TIME_TIME"] != " ")
                        insertDataList.Add(new DBItem("CERFO_TIME", form["TXT_CERFO_TIME_DAY"] + " " + form["TXT_CERFO_TIME_TIME"], DBItem.DBDataType.DataTime));
                }
                insertDataList.Add(new DBItem("CERFO_TIME_NA", form["CK_CERFO_TIME_NA"], DBItem.DBDataType.String));
            }
            else
            {
                insertDataList.Add(new DBItem("CERFO_TIME", null, DBItem.DBDataType.DataTime));
                insertDataList.Add(new DBItem("CERFO_TIME_NA", null, DBItem.DBDataType.String));
            }

            if (form["TXT_RFM_TIME_DAY"] + " " + form["TXT_RFM_TIME_TIME"] != " ")
                insertDataList.Add(new DBItem("RFM_TIME", form["TXT_RFM_TIME_DAY"] + " " + form["TXT_RFM_TIME_TIME"], DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("RFM_TIME_NA", form["CK_RFM_TIME_NA"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("RFM", form["RB_RFM"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("RUPTURETYPE", form["RB_RUPTURETYPE"], DBItem.DBDataType.String));
            if (form["RB_RUPTURETYPE"] == "2")
                insertDataList.Add(new DBItem("MECONIUM_COLOR", form["RB_MECONIUM_COLOR"], DBItem.DBDataType.String));
            else
                insertDataList.Add(new DBItem("MECONIUM_COLOR", null, DBItem.DBDataType.String));

            if (form["TXT_DR_ETTIME_DAY"] + " " + form["TXT_DR_ETTIME_TIME"] != " ")
                insertDataList.Add(new DBItem("DR_ETTIME", form["TXT_DR_ETTIME_DAY"] + " " + form["TXT_DR_ETTIME_TIME"], DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("DR_ETTIME_NA", form["CK_DR_ETTIME_NA"], DBItem.DBDataType.String));

            if (form["TXT_BIRTH_DAY"] + " " + form["TXT_BIRTH_TIME"] != " ")
                insertDataList.Add(new DBItem("BIRTH", form["TXT_BIRTH_DAY"] + " " + form["TXT_BIRTH_TIME"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("BIRTH", null, DBItem.DBDataType.DataTime));


            insertDataList.Add(new DBItem("BIRTH_NA", form["RB_BIRTH_NA"], DBItem.DBDataType.String));

            var BIRTH_TYPE = form["RB_BIRTH_TYPE"];
            insertDataList.Add(new DBItem("BIRTH_TYPE", BIRTH_TYPE, DBItem.DBDataType.String));
            //NSD
            if (BIRTH_TYPE == "0")
            {
                insertDataList.Add(new DBItem("VACUUM_NSD", form["RB_VACUUM_NSD"], DBItem.DBDataType.String));
            }//C/S
            else if (BIRTH_TYPE == "1")
            {
                insertDataList.Add(new DBItem("VACUUM_CS", form["RB_VACUUM_CS"], DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("CS_NOTE", form["RB_CS_NOTE"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("CS_MR", form["TXT_CS_MR"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("CS_OR", form["TXT_CS_OR"], DBItem.DBDataType.String));
            }
            if (form["TXT_DOP_TIME_DAY"] + " " + form["TXT_DOP_TIME_TIME"] != " ")
                insertDataList.Add(new DBItem("DOP_TIME", form["TXT_DOP_TIME_DAY"] + " " + form["TXT_DOP_TIME_TIME"], DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("DOP_TIME_NA", form["CK_DOP_TIME_NA"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("DOP", form["RB_DOP"], DBItem.DBDataType.String));

            if (form["TXT_DR_LVTIME_DAY"] + " " + form["TXT_DR_LVTIME_TIME"] != " ")
                insertDataList.Add(new DBItem("DR_LVTIME", form["TXT_DR_LVTIME_DAY"] + " " + form["TXT_DR_LVTIME_TIME"], DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("DR_LVTIME_NA", form["CK_DR_LVTIME_NA"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("GEST_M", form["TXT_GEST_M"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("GEST_D", form["TXT_GEST_D"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("LB_TOTAL_N", form["TXT_LB_TOTAL_N"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("TOP", form["RB_TOP"], DBItem.DBDataType.String));
            if (form["RB_TOP"] == "1")
            {
                var TOP_RS = form["CK_TOP_RS"];
                var TOP_RSV = new List<string>() { "0", "0", "0", "0", "0", "0" };
                if (TOP_RS == null)
                    insertDataList.Add(new DBItem("TOP_RS", String.Join("", TOP_RSV), DBItem.DBDataType.String));
                else
                {
                    var TOP_RS_SP = TOP_RS.Split(',');
                    foreach (var v in TOP_RS_SP)
                        TOP_RSV[Convert.ToInt32(v)] = "1";
                    insertDataList.Add(new DBItem("TOP_RS", String.Join("", TOP_RSV), DBItem.DBDataType.String));
                }

                if (TOP_RSV[5] == "1")
                    insertDataList.Add(new DBItem("TOP_RS_O", form["TXT_TOP_RS_O"], DBItem.DBDataType.String));
            }

            insertDataList.Add(new DBItem("ABORTION", form["TXT_ABORTION"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("PARITY_N", form["TXT_PARITY_N"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("REMARK", form["TXT_REMARK"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("CORDBLOOD", form["RB_CORDBLOOD"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("EPIDURAL", form["RB_EPIDURAL"], DBItem.DBDataType.String));

            var PATERNITY = form["RB_PATERNITY"];
            insertDataList.Add(new DBItem("PATERNITY", PATERNITY, DBItem.DBDataType.String));
            if (PATERNITY == "0")
            {
                var NP_RS = form["CK_NP_RS"];
                var NP_RSV = new List<string>() { "0", "0", "0", "0", "0", "0" };
                if (NP_RS == null)
                    insertDataList.Add(new DBItem("NP_RS", String.Join("", NP_RSV), DBItem.DBDataType.String));
                else
                {
                    var NP_RS_SP = NP_RS.Split(',');
                    foreach (var v in NP_RS_SP)
                        NP_RSV[Convert.ToInt32(v)] = "1";
                    insertDataList.Add(new DBItem("NP_RS", String.Join("", NP_RSV), DBItem.DBDataType.String));
                }

                if (NP_RSV[5] == "1")
                    insertDataList.Add(new DBItem("NP_RS_OTH", form["TXT_NP_RS_OTH"], DBItem.DBDataType.String));
            }

            insertDataList.Add(new DBItem("CORDCLAMP", form["RB_CORDCLAMP"], DBItem.DBDataType.String));

            var PERINEUM = form["RB_PERINEUM"];
            insertDataList.Add(new DBItem("PERINEUM", PERINEUM, DBItem.DBDataType.String));
            if (PERINEUM == "1" || PERINEUM == "2")
            {
                //傷口評估新增會陰傷口
                var sql = "SELECT * FROM WOUND_DATA WHERE WOUND_ID = '" + id + "0'";
                DataTable wound = obs_m.DBExecSQL(sql);
                if (wound != null && wound.Rows.Count > 0)
                {
                    var reason = PERINEUM == "1" ? "自然裂傷" : "正中切開術";
                    if (form["TXT_BIRTH_DAY"] + " " + form["TXT_BIRTH_TIME"] != " ")
                        Upd_Wound(id + "0", form["TXT_BIRTH_DAY"] + " " + form["TXT_BIRTH_TIME"], "生產", "會陰", 0, "", reason);
                    else
                        Upd_Wound(id + "0", now_datetime.ToString("yyyy/MM/dd HH:mm"), "生產", "會陰", 0, "", reason);
                }
                else
                {
                    var reason = PERINEUM == "1" ? "自然裂傷" : "正中切開術";
                    if (form["TXT_BIRTH_DAY"] + " " + form["TXT_BIRTH_TIME"] != " ")
                        Insert_Wound(id + "0", form["TXT_BIRTH_DAY"] + " " + form["TXT_BIRTH_TIME"], "生產", "會陰", 0, "", reason);
                    else
                        Insert_Wound(id + "0", now_datetime.ToString("yyyy/MM/dd HH:mm"), "生產", "會陰", 0, "", reason);
                }
            }

            if (PERINEUM == "3")
            {
                insertDataList.Add(new DBItem("PERINEUM_OTH", form["TXT_PERINEUM_OTH"], DBItem.DBDataType.String));
            }
            else
            {
                insertDataList.Add(new DBItem("PERINEUM_OTH", null, DBItem.DBDataType.String));
            }

            insertDataList.Add(new DBItem("PERI_LAC", form["RB_PERI_LAC"], DBItem.DBDataType.String));

            var ABD_WND = form["RB_ABD_WND"];
            insertDataList.Add(new DBItem("ABD_WND", ABD_WND, DBItem.DBDataType.String));
            if (ABD_WND == "1")
            {
                //傷口評估新增腹部傷口
                if (dt != null && dt.Rows.Count > 0)
                {
                    var sql = "SELECT * FROM WOUND_DATA WHERE WOUND_ID = '" + id + "1'";
                    DataTable wound = obs_m.DBExecSQL(sql);
                    if (wound != null && wound.Rows.Count > 0)
                    {
                        if (form["TXT_BIRTH_DAY"] + " " + form["TXT_BIRTH_TIME"] != " ")
                            Upd_Wound(id + "1", form["TXT_BIRTH_DAY"] + " " + form["TXT_BIRTH_TIME"], "手術", "腹部", 0, "", "");
                        else
                            Upd_Wound(id + "1", now_datetime.ToString("yyyy/MM/dd HH:mm"), "手術", "腹部", 0, "", "");
                    }
                    else
                    {
                        if (form["TXT_BIRTH_DAY"] + " " + form["TXT_BIRTH_TIME"] != " ")
                            Insert_Wound(id + "1", form["TXT_BIRTH_DAY"] + " " + form["TXT_BIRTH_TIME"], "手術", "腹部", 0, "", "");
                        else
                            Insert_Wound(id + "1", now_datetime.ToString("yyyy/MM/dd HH:mm"), "手術", "腹部", 0, "", "");
                    }
                }
            }

            insertDataList.Add(new DBItem("PHYSICIAN_1", form["TXT_PHYSICIAN_1"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("PHYSICIAN_2", form["TXT_PHYSICIAN_2"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("CLNURSE_1", form["TXT_CLNURSE_1"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("CLNURSE_2", form["TXT_CLNURSE_2"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("SRNURSE_1", form["TXT_SRNURSE_1"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("SRNURSE_2", form["TXT_SRNURSE_2"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("NNP_1", form["TXT_NNP_1"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("NNP_2", form["TXT_NNP_2"], DBItem.DBDataType.String));

            if (form["TXT_RR_ETTIME_DAY"] + " " + form["TXT_RR_ETTIME_TIME"] != " ")
            {
                insertDataList.Add(new DBItem("RR_ETTIME", form["TXT_RR_ETTIME_DAY"] + " " + form["TXT_RR_ETTIME_TIME"], DBItem.DBDataType.DataTime));
            }
            else
            {
                insertDataList.Add(new DBItem("RR_ETTIME", null, DBItem.DBDataType.DataTime));
            }
            insertDataList.Add(new DBItem("RR_ETTIME_NA", form["CK_RR_ETTIME_NA"], DBItem.DBDataType.String));

            if (form["TXT_RR_LVTIME_DAY"] + " " + form["TXT_RR_LVTIME_TIME"] != " ")
            {
                insertDataList.Add(new DBItem("RR_LVTIME", form["TXT_RR_LVTIME_DAY"] + " " + form["TXT_RR_LVTIME_TIME"], DBItem.DBDataType.DataTime));
            }
            else
            {
                insertDataList.Add(new DBItem("RR_LVTIME", null, DBItem.DBDataType.DataTime));
            }

            insertDataList.Add(new DBItem("RR_LVTIME_NA", form["CK_RR_LVTIME_NA"], DBItem.DBDataType.String));

            string where = " IID = '" + id + "' ";
            insertDataList = setNullToEmpty(insertDataList);
            int erow = link.DBExecUpdate("OBS_BTHSTA", insertDataList, where);

            //20210804 add by chih
            if (form["TXT_RFM_TIME_DAY"] + " " + form["TXT_RFM_TIME_TIME"] != " ")
            {
                if (form["TXT_BIRTH_DAY"] + " " + form["TXT_BIRTH_TIME"] != " ")
                {
                    var RFM_VALUE = form["TXT_RFM_TIME_DAY"] + " " + form["TXT_RFM_TIME_TIME"];
                    var BIRTH_VALUE = form["TXT_BIRTH_DAY"] + " " + form["TXT_BIRTH_TIME"];
                    var ROM_TT = Convert.ToDateTime(BIRTH_VALUE).Subtract(Convert.ToDateTime(RFM_VALUE));
                    List<DBItem> insertDataList_NB = new List<DBItem>();
                    insertDataList_NB.Add(new DBItem("ROM_TT", ROM_TT.Days.ToString() + "天" + ROM_TT.Hours.ToString() + "小時" + ROM_TT.Minutes.ToString() + "分鐘" + ROM_TT.Seconds.ToString() + "秒", DBItem.DBDataType.String));

                    DataTable dtNB = obs_m.sel_nb(ptinfo?.FeeNo);
                    if (dtNB != null && dtNB.Rows.Count > 0)
                    {
                        string whereNB = " IID = '" + dtNB.Rows[0]["IID"].ToString() + "' ";
                        int erowNB = link.DBExecUpdate("OBS_NB", insertDataList_NB, whereNB);
                    }

                }
            }

            #region 護理紀錄
            DataTable dtnb = obs_m.sel_nb(ptinfo?.FeeNo);
            if (dtnb != null && dtnb.Rows.Count > 0)
            {
                var count = dtnb.Rows.Count;

                DataTable dtHis = obs_m.sel_bthhis(ptinfo?.FeeNo);
                if (dtHis == null || dtHis.Rows.Count == 0)
                {
                    //Response.Write("<script>alert('沒有生產史資料!');window.location.href='Index?active=Before_Birth_List&mode=1&show=Y'</script>");
                    json_result.status = RESPONSE_STATUS.ERROR;
                    json_result.message = "沒有生產史資料";

                    return Content(JsonConvert.SerializeObject(json_result), "application/json");
                }
                DataRow hisrow = dtHis.Rows[0];
                DataTable dtBth = obs_m.sel_bthsta(ptinfo?.FeeNo);
                if (dtBth == null || dtBth.Rows.Count == 0)
                {
                    //Response.Write("<script>alert('沒有第二、三產程資料!');window.location.href='Index?active=Before_Birth_List&mode=1&show=Y'</script>");
                    json_result.status = RESPONSE_STATUS.ERROR;
                    json_result.message = "沒有第二、三產程資料!";

                    return Content(JsonConvert.SerializeObject(json_result), "application/json");
                }
                DataRow row = dtBth.Rows[0];
                var title = $"生產紀錄單-{(count <= 1 ? "單胞胎" : "雙胞胎")}";
                var contents = new List<string>();
                var field = "";

                #region 產前
                field = "預產期";
                field += hisrow["EDC"].ToString() == "" ? "" : Convert.ToDateTime(hisrow["EDC"].ToString()).ToString("yyyy/MM/dd");
                contents.Add(field);

                field = $"生產週數{row["GEST_M"]}+{row["GEST_D"]}週";
                contents.Add(field);

                field = $"於{(hisrow["GBS_AB_TYP"].ToString() == "0" ? "住院" : "急診")}{(hisrow["GBS_AB"].ToString() == "" ? "" : Convert.ToDateTime(hisrow["GBS_AB"].ToString()).ToString("yyyy/MM/dd HH:mm"))}始依醫囑打抗生素";
                contents.Add(field);

                field = $"G{hisrow["GRAVIDA"]}P{row["PARITY_N"]}A{hisrow["ABORTION"]}E{hisrow["ECCYESIS"]}";
                contents.Add(field);

                field = $"總活產數{row["LB_TOTAL_N"]}";
                contents.Add(field);

                field = $"先生{(row["PATERNITY"].ToString() == "1" ? $"有陪產{(row["CORDCLAMP"].ToString() == "1" ? "有斷臍" : "無斷臍")}" : "無陪產")}";
                contents.Add(field);
                #endregion

                #region 生產
                //單胞胎
                if (count == 1)
                {
                    if (row["BIRTH_NA"].ToString() == "1")
                        field = $"生產時間不詳";
                    else
                        field = $"生產時間{(row["BIRTH"].ToString() == "" ? "" : Convert.ToDateTime(row["BIRTH"].ToString()).ToString("yyyy/MM/dd HH:mm"))} {(row["BIRTH_NA"].ToString() == "0" ? "口述" : "")}";
                    contents.Add(field);
                }

                field = $"生產方式{(row["BIRTH_TYPE"].ToString() == "0" ? "NSD" : "C/S")}";
                if (row["BIRTH_TYPE"].ToString() == "1")
                {
                    if (row["BIRTH_TYPE"].ToString() == "0" && row["VACUUM_NSD"].ToString() != "" && row["VACUUM_NSD"].ToString() == "0")
                    {
                        field += "+VACUUM";
                    }

                    if (row["BIRTH_TYPE"].ToString() == "1" && row["VACUUM_CS"].ToString() != "" && row["VACUUM_CS"].ToString() == "0")
                    {
                        field += "+VACUUM";
                    }

                    if (row["CS_NOTE"].ToString() != "")
                    {
                        field += $"{(row["CS_NOTE"].ToString() == "0" ? "{註記：初次剖腹產}" : "{註記：前胎剖腹產}")}";
                    }
                }
                contents.Add(field);

                #endregion

                if (count > 1)
                {
                    field = "";
                    foreach (DataRow r in dtnb.Rows)
                    {
                        var NB_NAME = r["NB_NAME"].ToString();
                        field = $"{NB_NAME.Replace("新生兒", "")}生產時間{r["BIRTH_DAY"]}";
                        contents.Add(field);
                    }
                }

                if (row["DOP_TIME_NA"].ToString() == "1")
                    field = $"胎盤娩出時間：不詳";
                else
                    field = $"胎盤娩出時間：{(row["DOP_TIME"].ToString() == "" ? "" : Convert.ToDateTime(row["DOP_TIME"].ToString()).ToString("yyyy/MM/dd HH:mm"))} {(row["DOP_TIME_NA"].ToString() == "0" ? "口述" : "")}";
                contents.Add(field);

                field = "";
                switch (row["DOP"].ToString())
                {
                    case "0":
                        field = "稀氏";
                        break;
                    case "1":
                        field = "鄧氏";
                        break;
                    case "2":
                        field = "混合剝離";
                        break;
                    case "3":
                        field = "人工剝離";
                        break;
                    default:
                        field = "";
                        break;
                }
                contents.Add(field);

                if (row["DR_LVTIME_NA"].ToString() == "1")
                    field = $"離開分娩室時間：不詳";
                else
                    field = $"離開分娩室時間：{(row["DR_LVTIME"].ToString() == "" ? "" : Convert.ToDateTime(row["DR_LVTIME"].ToString()).ToString("yyyy/MM/dd HH:mm"))} {(row["DR_LVTIME_NA"].ToString() == "0" ? "口述" : "")}";
                contents.Add(field);

                if (row["BIRTH"].ToString() != "")
                    erow += base.Upd_CareRecord(Convert.ToDateTime(row["BIRTH"].ToString()).ToString("yyyy/MM/dd HH:mm:ss"), dtBth.Rows[0]["IID"].ToString(), title, String.Join("，", contents) + "。", "", "", "", "", "OBS_BTHSTA");
                else
                    erow += base.Upd_CareRecord(now_datetime.ToString("yyyy/MM/dd HH:mm:ss"), dtBth.Rows[0]["IID"].ToString(), title, String.Join("，", contents) + "。", "", "", "", "", "OBS_BTHSTA");
            }
            #endregion

            if (erow > 0)
            {
                link.DBCommit();

                if (action_type.ToLower() == "emr")
                {
                    string return_jsonstr = string.Empty;
                    if (!UnAuthorize)
                    {
                        PdfEmr.ControllerContext = ControllerContext;
                        PdfEmr.userinfo = userinfo;
                        PdfEmr.ptinfo = ptinfo;
                        return_jsonstr = PdfEmr.GetPDF_EMR("Save", feeno, userno, "Production_Record", id);
                        json_result = JsonConvert.DeserializeObject<RESPONSE_MSG>(return_jsonstr);
                        if (json_result.status == RESPONSE_STATUS.SUCCESS)
                        {
                            insertDataList = new List<DBItem>();
                            insertDataList.Add(new DBItem("EMR_SIGN", userno, DBItem.DBDataType.String));
                            insertDataList.Add(new DBItem("EMR_TIME", now_datetime.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime));
                            where = " IID = '" + id + "' ";
                            erow += link.DBExecUpdateTns("OBS_BTHSTA", insertDataList, where);

                        }

                    }
                }
                else
                {
                    json_result.status = RESPONSE_STATUS.SUCCESS;
                    json_result.message = "";
                }

            }
            else
            {
                link.DBRollBack();
                json_result.status = RESPONSE_STATUS.ERROR;
                json_result.message = "修改失敗";
            }
            return Content(JsonConvert.SerializeObject(json_result), "application/json");
        }
        #endregion

        #region 出恢復室時間
        [HttpPost]
        public ActionResult Upd_Child_Brith_RR_LVTIME(FormCollection form)
        {
            RESPONSE_MSG json_result = new RESPONSE_MSG();

            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo?.FeeNo;
            string id = form["ID"];
            DateTime now_datetime = DateTime.Now;

            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("UPDNO", userno, DBItem.DBDataType.String)); //建立者員編
            insertDataList.Add(new DBItem("UPDTIME", now_datetime.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間


            if (form["TXT_RR_LVTIME_DAY"] + " " + form["TXT_RR_LVTIME_TIME"] != " ")
            {
                insertDataList.Add(new DBItem("RR_LVTIME", form["TXT_RR_LVTIME_DAY"] + " " + form["TXT_RR_LVTIME_TIME"], DBItem.DBDataType.DataTime));
            }
            else
            {
                insertDataList.Add(new DBItem("RR_LVTIME", null, DBItem.DBDataType.DataTime));
            }
            insertDataList.Add(new DBItem("RR_LVTIME_NA", form["CK_RR_LVTIME_NA"], DBItem.DBDataType.String));

            string where = " IID = '" + id + "' ";
            insertDataList = setNullToEmpty(insertDataList);
            int erow = link.DBExecUpdate("OBS_BTHSTA", insertDataList, where);

            if (erow > 0)
            {
                link.DBCommit();
                json_result.status = RESPONSE_STATUS.SUCCESS;
                json_result.message = "修改成功";
            }
            else
            {
                link.DBRollBack();
                json_result.status = RESPONSE_STATUS.ERROR;
                json_result.message = "修改失敗";
            }
            return Content(JsonConvert.SerializeObject(json_result), "application/json");
        }
        #endregion

        #region  拋轉傷口
        /// <summary>
        /// 拋轉傷口
        /// </summary>
        /// <param name="type">傷口種類</param>
        /// <param name="position">傷口部位</param>
        /// <param name="wound_cound">傷口順序</param>
        private int Insert_Wound(string IID, string date, string type, string position, int wound_cound, string location, string reason, bool isCr = true)
        {
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo.FeeNo;
            //string id = base.creatid("WOUND_DATA", userno, feeno, wound_cound.ToString());
            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("WOUND_ROW", "WOUND_DATA_SEQUENCE.NEXTVAL", DBItem.DBDataType.Number));
            insertDataList.Add(new DBItem("WOUND_ID", IID, DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("CREANO", userno, DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String));
            if (date != null && date != "")
                insertDataList.Add(new DBItem("CREATTIME", date, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("NUM", "(SELECT (COUNT(*) + 1) FROM WOUND_DATA WHERE FEENO = '" + feeno + "')", DBItem.DBDataType.Number));
            insertDataList.Add(new DBItem("TYPE", type, DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("POSITION", position, DBItem.DBDataType.String));
            if (location != "")
                insertDataList.Add(new DBItem("LOCATION", location, DBItem.DBDataType.String));
            if (reason != "")
                insertDataList.Add(new DBItem("REASON", reason, DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("UPDNO", userno, DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("UPDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime));
            int erow = obs_m.DBExecInsert("WOUND_DATA", insertDataList);
            #region --帶入護理記錄-傷口--
            string Str = "";

            //於【部位】發生一【傷口類別】傷口。
            Str += "於" + position + "發生一" + type + "傷口。";
            if (isCr)
            {
                if (date != null && date != "")
                    erow += Insert_CareRecord(date, IID, "", "", "", Str, "", "", "Wound");//(date, id, "Intake", "", "", Str, "", "", "IO_DATA");
            }
            #endregion
            return erow;
        }


        private int Upd_Wound(string IID, string date, string type, string position, int wound_cound, string location, string reason, bool isCr = true)
        {
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo.FeeNo;
            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("TYPE", type, DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("POSITION", position, DBItem.DBDataType.String));
            if (location != "")
                insertDataList.Add(new DBItem("LOCATION", location, DBItem.DBDataType.String));
            if (reason != "")
                insertDataList.Add(new DBItem("REASON", reason, DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("UPDNO", userno, DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("UPDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime));

            string where = " WOUND_ID = '" + IID + "' ";
            insertDataList = setNullToEmpty(insertDataList);
            int erow = link.DBExecUpdate("WOUND_DATA", insertDataList, where);
            #region --帶入護理記錄-傷口--
            string Str = "";

            //於【部位】發生一【傷口類別】傷口。
            Str += "於" + position + "發生一" + type + "傷口。";
            if (isCr)
            {
                if (date != null && date != "")
                    erow += Upd_CareRecord(date, IID, "", "", "", Str, "", "", "Wound");
            }
            #endregion
            return erow;
        }


        public class PERINEUM
        {
            public string PERINEUM_RANGE { set; get; }
            public string PERINEUM_RED { set; get; }
            public string PERINEUM_SWOLLEN { set; get; }
            public string SWOLLEN_RANGE { set; get; }
            public string PERINEUM_BRUISE { set; get; }
            public string PERINEUM_SECRETION { set; get; }
        }

        public class ABD
        {
            public string range_YN { set; get; } //範圍是否可測量
            public string RANGE_HEIGHT { set; get; }//長
            public string RANGE_WIDTH { set; get; }//寬
            public string RANGE_DEPTH { set; get; }//高
            public string EXTERIOR { set; get; }//外觀
            public string EXTERIOR_OTHER { set; get; }//外觀-其他
            public string exudate_YN { set; get; }//滲出液
            public string EXUDATE_AMOUNT { set; get; }//滲出物量
            public string EXUDATE_NATURE { set; get; }//性狀
            public string EXUDATE_NATURE_OTHER { set; get; }//性狀-其他
            public string EXUDATE_COLOR { set; get; }//顏色
            public string EXUDATE_COLOR_OTHER { set; get; }//顏色-其他
            public string sutures_YN { set; get; }//是否有縫線
            public string pin { set; get; }//逢幾針
            public string handle_YN { set; get; }//處置 
            public string handle_item { set; get; }//處置選項
            public string handle_other { set; get; } //處置選項-其他
        }

        /// <summary>
        /// 
        /// </summary>
        /// <param name="Type">0:會陰 1:腹部</param>
        /// <param name="WOUND_ID"></param>
        /// <param name="IID"></param>
        /// <param name="date"></param>
        /// <returns></returns>
        public int AddWoundRecordData(string Type, string WOUND_ID, string IID, string date, PERINEUM data = null, ABD abd = null)
        {
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo.FeeNo;
            List<DBItem> DBItemDataList = new List<DBItem>();
            string woundType = string.Empty;

            //新增
            //RecordID = base.creatid("DIGI_FLAP_RECORD", userno, feeno, "0");
            DBItemDataList.Add(new DBItem("RECORD_ID", IID, DBItem.DBDataType.String));
            DBItemDataList.Add(new DBItem("WOUND_ID", WOUND_ID, DBItem.DBDataType.String));
            DBItemDataList.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String));
            DBItemDataList.Add(new DBItem("RECORDTIME", date, DBItem.DBDataType.DataTime));
            if (Type == "0") //會陰
            {
                if (data.PERINEUM_RANGE == "" && data.PERINEUM_RED == "" && data.PERINEUM_SWOLLEN == "" && data.SWOLLEN_RANGE == "" &&
                   data.PERINEUM_BRUISE == "" && data.PERINEUM_SECRETION == "")
                    return 0;

                woundType = "會陰";
                DBItemDataList.Add(new DBItem("PERINEUM_RANGE", data.PERINEUM_RANGE, DBItem.DBDataType.String)); //傷口邊緣
                DBItemDataList.Add(new DBItem("PERINEUM_RED", data.PERINEUM_RED, DBItem.DBDataType.String)); //紅
                DBItemDataList.Add(new DBItem("PERINEUM_SWOLLEN", data.PERINEUM_SWOLLEN, DBItem.DBDataType.String)); //水腫
                DBItemDataList.Add(new DBItem("SWOLLEN_RANGE", data.SWOLLEN_RANGE, DBItem.DBDataType.String)); //水腫範圍
                DBItemDataList.Add(new DBItem("PERINEUM_BRUISE", data.PERINEUM_BRUISE, DBItem.DBDataType.String)); //瘀血
                DBItemDataList.Add(new DBItem("PERINEUM_SECRETION", data.PERINEUM_SECRETION, DBItem.DBDataType.String)); //分泌物
            }
            else
            {
                if (abd.range_YN == "" && abd.RANGE_HEIGHT == "" && abd.RANGE_WIDTH == "" && abd.RANGE_DEPTH == "" &&
                  abd.EXTERIOR == "" && abd.EXTERIOR_OTHER == "" &&
                  abd.exudate_YN == "" && abd.EXUDATE_AMOUNT == "" &&
                   abd.EXUDATE_NATURE == "" && abd.EXUDATE_NATURE_OTHER == "" &&
                    abd.EXUDATE_COLOR == "" && abd.EXUDATE_COLOR_OTHER == "" &&
                     abd.sutures_YN == "" && abd.pin == "" &&
                      abd.handle_YN == "" && abd.handle_item == "" &&
                       abd.handle_other == "")
                    return 0;

                woundType = "腹部";
                DBItemDataList.Add(new DBItem("range_YN", abd.range_YN, DBItem.DBDataType.String)); //範圍是否可測量
                DBItemDataList.Add(new DBItem("RANGE_HEIGHT", abd.RANGE_HEIGHT, DBItem.DBDataType.String)); //長
                DBItemDataList.Add(new DBItem("RANGE_WIDTH", abd.RANGE_WIDTH, DBItem.DBDataType.String)); //寬
                DBItemDataList.Add(new DBItem("RANGE_DEPTH", abd.RANGE_DEPTH, DBItem.DBDataType.String)); //高
                DBItemDataList.Add(new DBItem("EXTERIOR", abd.EXTERIOR, DBItem.DBDataType.String)); //外觀
                DBItemDataList.Add(new DBItem("EXTERIOR_OTHER", abd.EXTERIOR_OTHER, DBItem.DBDataType.String)); //外觀-其他

                DBItemDataList.Add(new DBItem("exudate_YN", abd.exudate_YN, DBItem.DBDataType.String)); //滲出液
                DBItemDataList.Add(new DBItem("EXUDATE_AMOUNT", abd.EXUDATE_AMOUNT, DBItem.DBDataType.String)); //滲出物量
                DBItemDataList.Add(new DBItem("EXUDATE_NATURE", abd.EXUDATE_NATURE, DBItem.DBDataType.String)); //性狀
                DBItemDataList.Add(new DBItem("EXUDATE_NATURE_OTHER", abd.EXUDATE_NATURE_OTHER, DBItem.DBDataType.String)); //性狀-其他
                DBItemDataList.Add(new DBItem("EXUDATE_COLOR", abd.EXUDATE_COLOR, DBItem.DBDataType.String)); //顏色
                DBItemDataList.Add(new DBItem("EXUDATE_COLOR_OTHER", abd.EXUDATE_COLOR_OTHER, DBItem.DBDataType.String)); //顏色-其他
                DBItemDataList.Add(new DBItem("sutures_YN", abd.sutures_YN, DBItem.DBDataType.String)); //是否有縫線

                DBItemDataList.Add(new DBItem("pin", abd.pin, DBItem.DBDataType.String)); //縫幾針
                DBItemDataList.Add(new DBItem("handle_YN", abd.handle_YN, DBItem.DBDataType.String)); //處置 
                DBItemDataList.Add(new DBItem("handle_item", abd.handle_item, DBItem.DBDataType.String)); //處置選項
                DBItemDataList.Add(new DBItem("handle_other", abd.handle_other, DBItem.DBDataType.String)); //處置選項-其他
            }

            DBItemDataList.Add(new DBItem("CREANO", userno, DBItem.DBDataType.String));
            DBItemDataList.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm"), DBItem.DBDataType.DataTime));
            var erow = this.obs_m.DBExecInsert("WOUND_RECORD", DBItemDataList);
            if (erow > 0)
            {
                var CareRecordContI = string.Empty;
                var CareRecordTitle = string.Empty;

                if (Type == "0")
                {
                    CareRecordTitle = "會陰傷口護理";
                    CareRecordContI = " 無給予護理措施，持續觀察。";

                    var ObsRangeCont = " 傷口邊緣" + data.PERINEUM_RANGE;//有無縫線
                    var ObsRedCont = "，紅：" + data.PERINEUM_RED;//
                    var ObsSwollenCont = "，水腫：" + data.PERINEUM_SWOLLEN;
                    if (data.SWOLLEN_RANGE != "")
                    {
                        ObsSwollenCont += "，範圍:" + data.SWOLLEN_RANGE;
                    }
                    var ObsBruiseCont = "，瘀血：" + data.PERINEUM_BRUISE;
                    var ObsSecretionCont = "，分泌物：" + data.PERINEUM_SECRETION;

                    var CareRecordContE = "會陰 生產傷口";
                    CareRecordContE += ObsRangeCont + ObsRedCont + ObsSwollenCont + ObsBruiseCont + ObsSecretionCont;
                    CareRecordContE += "。";
                    base.Insert_CareRecord(date, IID, CareRecordTitle, "", "", "", CareRecordContI, CareRecordContE, "WOUND_RECORD");
                }
                else
                {
                    var Temp_Wound_Size = string.Empty;
                    var TxtExterior = (abd.EXTERIOR_OTHER != "") ? abd.EXTERIOR + ":" + abd.EXTERIOR_OTHER : abd.EXTERIOR;

                    CareRecordTitle = "傷口護理";
                    if (abd.handle_YN == "是")
                    {
                        CareRecordContI = "給予 " + abd.handle_item;
                        if (abd.handle_other != "")
                        {
                            CareRecordContI += ":" + abd.handle_other;
                        }
                        CareRecordContI += " 等護理處置，並持續觀察傷口狀況。";
                    }
                    else
                    {
                        CareRecordContI = " 無給予護理措施，持續觀察。";
                    }
                    var SuturesYNCont = " 傷口" + abd.sutures_YN;//有無縫線
                    var ExudateNatureColorCont = "，性質：" + abd.EXUDATE_NATURE;//
                    if (abd.EXUDATE_NATURE_OTHER != "")
                    {
                        ExudateNatureColorCont += ":" + abd.EXUDATE_NATURE_OTHER;
                    }
                    ExudateNatureColorCont += "，顏色：" + abd.EXUDATE_COLOR;
                    if (abd.EXUDATE_COLOR_OTHER != "")
                    {
                        ExudateNatureColorCont += ":" + abd.EXUDATE_COLOR_OTHER;
                    }
                    if (abd.range_YN != "否")
                    {
                        Temp_Wound_Size = " (大小" + abd.RANGE_HEIGHT + "cm" + "*" + abd.RANGE_WIDTH + "cm";
                        if (abd.RANGE_DEPTH != "")
                        {
                            Temp_Wound_Size += "*" + abd.RANGE_DEPTH + "cm";
                        }
                        Temp_Wound_Size += ")";
                    }
                    else
                    {
                        //if (BackoutYN[i] == "傷口敷料暫不拆包")
                        //{
                        //    Temp_Wound_Size = "(傷口敷料暫不拆包)";
                        //}
                        //else
                        //{//如果有其他: <-----  加在這
                        // //BackoutYNCont = ")";
                        //}
                    }
                    //【部位】【傷口類別】大小(【長】x【寬】x【深】/手術傷口暫不拆包)，傷口【是否有縫線】，周圍皮膚【外觀】，傷口滲出液量【量】，性質【滲出液性質】，顏色【顏色】。
                    var CareRecordContE = "腹部 手術傷口";
                    CareRecordContE += Temp_Wound_Size + SuturesYNCont + "，周圍皮膚 " + TxtExterior;
                    if (abd.exudate_YN != "無")
                    {
                        // CareRecordContE += "，傷口滲出液，" + ExudateNatureColorCont;
                        CareRecordContE += "，傷口滲出液量" + abd.EXUDATE_AMOUNT + ExudateNatureColorCont;
                    }
                    else
                    {
                        CareRecordContE += "，無滲液";
                    }
                    CareRecordContE += "。";
                    base.Insert_CareRecord(date, IID, CareRecordTitle, "", "", "", CareRecordContI, CareRecordContE, "WOUND_RECORD");
                }
            }
            return erow;
        }

        /// <summary>
        /// 
        /// </summary>
        /// <param name="Type">0:會陰 1:腹部</param>
        /// <param name="WOUND_ID"></param>
        /// <param name="IID"></param>
        /// <param name="date"></param>
        /// <returns></returns>
        public int UpdWoundRecordData(string Type, string WOUND_ID, string IID, string date, PERINEUM data = null, ABD abd = null)
        {
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo.FeeNo;
            List<DBItem> DBItemDataList = new List<DBItem>();

            //RecordID = base.creatid("DIGI_FLAP_RECORD", userno, feeno, "0");
            DBItemDataList.Add(new DBItem("RECORDTIME", date, DBItem.DBDataType.DataTime));
            //if (SuturesYN[i] == "有縫線")
            //    DBItemDataList.Add(new DBItem("pin", SuturesYOther[i], DBItem.DBDataType.String));
            //else if (SuturesYN[i] == "縫線已拆")
            //    DBItemDataList.Add(new DBItem("pin", PinVal[i], DBItem.DBDataType.String));
            //DBItemDataList.Add(new DBItem("handle_YN", HandleYN[i], DBItem.DBDataType.String));
            if (Type == "0") //會陰
            {
                DBItemDataList.Add(new DBItem("PERINEUM_RANGE", data.PERINEUM_RANGE, DBItem.DBDataType.String)); //傷口邊緣
                DBItemDataList.Add(new DBItem("PERINEUM_RED", data.PERINEUM_RED, DBItem.DBDataType.String)); //紅
                DBItemDataList.Add(new DBItem("PERINEUM_SWOLLEN", data.PERINEUM_SWOLLEN, DBItem.DBDataType.String)); //水腫
                DBItemDataList.Add(new DBItem("SWOLLEN_RANGE", data.SWOLLEN_RANGE, DBItem.DBDataType.String)); //水腫範圍
                DBItemDataList.Add(new DBItem("PERINEUM_BRUISE", data.PERINEUM_BRUISE, DBItem.DBDataType.String)); //瘀血
                DBItemDataList.Add(new DBItem("PERINEUM_SECRETION", data.PERINEUM_SECRETION, DBItem.DBDataType.String)); //分泌物
            }
            else
            {
                DBItemDataList.Add(new DBItem("range_YN", abd.range_YN, DBItem.DBDataType.String)); //範圍是否可測量
                DBItemDataList.Add(new DBItem("RANGE_HEIGHT", abd.RANGE_HEIGHT, DBItem.DBDataType.String)); //長
                DBItemDataList.Add(new DBItem("RANGE_WIDTH", abd.RANGE_WIDTH, DBItem.DBDataType.String)); //寬
                DBItemDataList.Add(new DBItem("RANGE_DEPTH", abd.RANGE_DEPTH, DBItem.DBDataType.String)); //高
                DBItemDataList.Add(new DBItem("EXTERIOR", abd.EXTERIOR, DBItem.DBDataType.String)); //外觀
                DBItemDataList.Add(new DBItem("EXTERIOR_OTHER", abd.EXTERIOR_OTHER, DBItem.DBDataType.String)); //外觀-其他

                DBItemDataList.Add(new DBItem("exudate_YN", abd.exudate_YN, DBItem.DBDataType.String)); //滲出液
                DBItemDataList.Add(new DBItem("EXUDATE_AMOUNT", abd.EXUDATE_AMOUNT, DBItem.DBDataType.String)); //滲出物量
                DBItemDataList.Add(new DBItem("EXUDATE_NATURE", abd.EXUDATE_NATURE, DBItem.DBDataType.String)); //性狀
                DBItemDataList.Add(new DBItem("EXUDATE_NATURE_OTHER", abd.EXUDATE_NATURE_OTHER, DBItem.DBDataType.String)); //性狀-其他
                DBItemDataList.Add(new DBItem("EXUDATE_COLOR", abd.EXUDATE_COLOR, DBItem.DBDataType.String)); //顏色
                DBItemDataList.Add(new DBItem("EXUDATE_COLOR_OTHER", abd.EXUDATE_COLOR_OTHER, DBItem.DBDataType.String)); //顏色-其他
                DBItemDataList.Add(new DBItem("sutures_YN", abd.sutures_YN, DBItem.DBDataType.String)); //是否有縫線

                DBItemDataList.Add(new DBItem("pin", abd.pin, DBItem.DBDataType.String)); //縫幾針
                DBItemDataList.Add(new DBItem("handle_YN", abd.handle_YN, DBItem.DBDataType.String)); //處置 
                DBItemDataList.Add(new DBItem("handle_item", abd.handle_item, DBItem.DBDataType.String)); //處置選項
                DBItemDataList.Add(new DBItem("handle_other", abd.handle_other, DBItem.DBDataType.String)); //處置選項-其他
            }

            DBItemDataList.Add(new DBItem("CREANO", userno, DBItem.DBDataType.String));
            DBItemDataList.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm"), DBItem.DBDataType.DataTime));

            string where = " WOUND_ID = '" + WOUND_ID + "' AND RECORD_ID = '" + IID + "' ";
            DBItemDataList = setNullToEmpty(DBItemDataList);
            int erow = link.DBExecUpdate("WOUND_RECORD", DBItemDataList, where);
            if (erow > 0)
            {
                var CareRecordContI = string.Empty;
                var CareRecordTitle = string.Empty;

                if (Type == "0")
                {
                    CareRecordTitle = "會陰傷口護理";
                    CareRecordContI = " 無給予護理措施，持續觀察。";

                    var ObsRangeCont = " 傷口邊緣" + data.PERINEUM_RANGE;//有無縫線
                    var ObsRedCont = "，紅：" + data.PERINEUM_RED;//
                    var ObsSwollenCont = "，水腫：" + data.PERINEUM_SWOLLEN;
                    if (data.SWOLLEN_RANGE != "")
                    {
                        ObsSwollenCont += "，範圍:" + data.SWOLLEN_RANGE;
                    }
                    var ObsBruiseCont = "，瘀血：" + data.PERINEUM_BRUISE;
                    var ObsSecretionCont = "，分泌物：" + data.PERINEUM_SECRETION;

                    var CareRecordContE = "會陰 生產傷口";
                    CareRecordContE += ObsRangeCont + ObsRedCont + ObsSwollenCont + ObsBruiseCont + ObsSecretionCont;
                    CareRecordContE += "。";
                    base.Upd_CareRecord(date, IID, CareRecordTitle, "", "", "", CareRecordContI, CareRecordContE, "WOUND_RECORD");
                }
                else
                {
                    var Temp_Wound_Size = string.Empty;
                    var TxtExterior = (abd.EXTERIOR_OTHER != "") ? abd.EXTERIOR + ":" + abd.EXTERIOR_OTHER : abd.EXTERIOR;

                    CareRecordTitle = "傷口護理";
                    if (abd.handle_YN == "是")
                    {
                        CareRecordContI = "給予 " + abd.handle_item;
                        if (abd.handle_other != "")
                        {
                            CareRecordContI += ":" + abd.handle_other;
                        }
                        CareRecordContI += " 等護理處置，並持續觀察傷口狀況。";
                    }
                    else
                    {
                        CareRecordContI = " 無給予護理措施，持續觀察。";
                    }
                    var SuturesYNCont = " 傷口" + abd.sutures_YN;//有無縫線
                    var ExudateNatureColorCont = "，性質：" + abd.EXUDATE_NATURE;//
                    if (abd.EXUDATE_NATURE_OTHER != "")
                    {
                        ExudateNatureColorCont += ":" + abd.EXUDATE_NATURE_OTHER;
                    }
                    ExudateNatureColorCont += "，顏色：" + abd.EXUDATE_COLOR;
                    if (abd.EXUDATE_COLOR_OTHER != "")
                    {
                        ExudateNatureColorCont += ":" + abd.EXUDATE_COLOR_OTHER;
                    }
                    if (abd.range_YN != "否")
                    {
                        Temp_Wound_Size = " (大小" + abd.RANGE_HEIGHT + "cm" + "*" + abd.RANGE_WIDTH + "cm";
                        if (abd.RANGE_DEPTH != "")
                        {
                            Temp_Wound_Size += "*" + abd.RANGE_DEPTH + "cm";
                        }
                        Temp_Wound_Size += ")";
                    }
                    else
                    {
                        //if (BackoutYN[i] == "傷口敷料暫不拆包")
                        //{
                        //    Temp_Wound_Size = "(傷口敷料暫不拆包)";
                        //}
                        //else
                        //{//如果有其他: <-----  加在這
                        // //BackoutYNCont = ")";
                        //}
                    }
                    //【部位】【傷口類別】大小(【長】x【寬】x【深】/手術傷口暫不拆包)，傷口【是否有縫線】，周圍皮膚【外觀】，傷口滲出液量【量】，性質【滲出液性質】，顏色【顏色】。
                    var CareRecordContE = "腹部 手術傷口";
                    CareRecordContE += Temp_Wound_Size + SuturesYNCont + "，周圍皮膚 " + TxtExterior;
                    if (abd.exudate_YN != "無")
                    {
                        // CareRecordContE += "，傷口滲出液，" + ExudateNatureColorCont;
                        CareRecordContE += "，傷口滲出液量" + abd.EXUDATE_AMOUNT + ExudateNatureColorCont;
                    }
                    else
                    {
                        CareRecordContE += "，無滲液";
                    }
                    CareRecordContE += "。";
                    base.Upd_CareRecord(date, IID, CareRecordTitle, "", "", "", CareRecordContI, CareRecordContE, "WOUND_RECORD");
                }
            }
            return erow;
        }

        //刪除傷口
        public void Delete_Wound_Data(string wound_id, string IID)
        {
            List<DBItem> dbItem = new List<DBItem>();
            dbItem.Add(new DBItem("DELETED", base.userinfo.EmployeesNo, DBItem.DBDataType.String));
            //dbItem.Add(new DBItem("DEL_REASON", txt_del_reason, DBItem.DBDataType.String));
            dbItem.Add(new DBItem("UPDNO", userinfo.EmployeesNo, DBItem.DBDataType.String));
            dbItem.Add(new DBItem("UPDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime));
            string where = "FEENO = '" + base.ptinfo.FeeNo + "' AND WOUND_ID = '" + wound_id + "' " + "AND RECORD_ID = '" + IID + "' ";
            int erow = obs_m.DBExecUpdate("WOUND_RECORD", dbItem, where);
            if (erow > 0)
            {
                try
                {
                    base.Del_CareRecord(IID, "WOUND_RECORD");//刪除傷口紀錄的護理紀錄
                }
                catch { }
            }
        }

        #endregion

        #region 新生兒腳印列印單總表
        public ActionResult Child_foot_Print_List()
        {
            DataTable dt = obs_m.sel_bthhis(ptinfo.FeeNo);
            ViewBag.dt = set_dt(dt);

            DataTable foot_dt = obs_m.sel_nbfoot(ptinfo.FeeNo);
            ViewBag.foot_dt = set_dt(foot_dt);
            foot_dt.Columns.Add("UPDNO_NAME");
            if (foot_dt != null && foot_dt.Rows.Count > 0)
            {
                foreach (DataRow r in foot_dt.Rows)
                {
                    if (r["UPDNO"].ToString() != "")
                    {
                        byte[] listByteCode = webService.UserName(r["UPDNO"].ToString());
                        if (listByteCode == null)
                            r["UPDNO_NAME"] = "";
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(listByteCode);
                            UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                            r["UPDNO_NAME"] = user_name.EmployeesName;
                        }
                    }
                }
            }

            ViewBag.chartNo = ptinfo.ChartNo;
            ViewBag.feeno = ptinfo.FeeNo;
            ViewBag.userno = userinfo.EmployeesNo;
            ViewBag.RootDocument = GetSourceUrl();
            return View();
        }
        #endregion

        #region 新生兒腳印列印單
        public ActionResult Child_foot_Print(string feeno, string chartno, string babySeq, string printCount, string userno)
        {
            DataTable dt = obs_m.sel_bthhis(feeno);
            dt.Columns.Add("PAT_ZONEC");
            dt.Columns.Add("MAT_ZONEC");
            if (dt != null && dt.Rows.Count > 0)
            {
                foreach (DataRow r in dt.Rows)
                {
                    if (r["PAT_ZONE"].ToString() != "")
                    {
                        DataTable area = obs_m.sel_v_area("", r["PAT_ZONE"].ToString());
                        if (area != null && area.Rows.Count > 0)
                        {
                            r["PAT_ZONEC"] = area.Rows[0]["AREA_NAME"];
                        }
                    }

                    if (r["MAT_ZONE"].ToString() != "")
                    {
                        DataTable area = obs_m.sel_v_area("", r["MAT_ZONE"].ToString());
                        if (area != null && area.Rows.Count > 0)
                        {
                            r["MAT_ZONEC"] = area.Rows[0]["AREA_NAME"];
                        }
                    }
                }
            }
            ViewBag.dt = set_dt(dt);
            ViewBag.chartNo = chartno;
            ViewBag.babySeq = babySeq;
            ViewBag.BarCode = feeno + babySeq;

            DataTable foot_dt = obs_m.sel_nbfoot(feeno);
            ViewBag.foot_dt = set_dt(foot_dt);

            if (foot_dt == null || foot_dt.Rows.Count == 0)
            {//Insert
                int erow = 0;
                for (var i = 0; i < 10; i++)
                {
                    string id = base.creatid("OBS_NBFOOT", userno, feeno, "0");
                    List<DBItem> insertDataList = new List<DBItem>();
                    insertDataList.Add(new DBItem("IID", id, DBItem.DBDataType.String)); //序號
                    insertDataList.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String)); //建立者員編
                    insertDataList.Add(new DBItem("CREATNO", userno, DBItem.DBDataType.String)); //建立者員編
                    insertDataList.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
                    insertDataList.Add(new DBItem("RECORDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間
                    insertDataList.Add(new DBItem("DELETED", null, DBItem.DBDataType.String)); //刪除註記

                    insertDataList.Add(new DBItem("BABY_SEQ", Convert.ToChar(i + 65).ToString(), DBItem.DBDataType.String));
                    if (Convert.ToChar(i + 65).ToString() == babySeq)
                    {
                        insertDataList.Add(new DBItem("UPDNO", userno, DBItem.DBDataType.String));
                        insertDataList.Add(new DBItem("PRINTDATE", DateTime.Now.ToString("yyyy/MM/dd HH:mm"), DBItem.DBDataType.DataTime));
                        insertDataList.Add(new DBItem("PRINTCOUNT", (Convert.ToInt32(printCount) + 1).ToString(), DBItem.DBDataType.String));
                    }
                    else
                        insertDataList.Add(new DBItem("PRINTCOUNT", "0", DBItem.DBDataType.String));

                    insertDataList = setNullToEmpty(insertDataList);
                    erow += link.DBExecInsert("OBS_NBFOOT", insertDataList);
                }
            }
            else
            {//Upd
                DataTable old_dt = obs_m.sel_nbfoot(feeno, babySeq);
                if (old_dt != null && old_dt.Rows.Count > 0)
                    printCount = old_dt.Rows[0]["PRINTCOUNT"].ToString();

                List<DBItem> insertDataList = new List<DBItem>();
                insertDataList.Add(new DBItem("UPDNO", userno, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("RECORDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間
                insertDataList.Add(new DBItem("PRINTDATE", DateTime.Now.ToString("yyyy/MM/dd HH:mm"), DBItem.DBDataType.DataTime));
                insertDataList.Add(new DBItem("PRINTCOUNT", (Convert.ToInt32(printCount) + 1).ToString(), DBItem.DBDataType.String));
                if (printCount == "0")
                {
                    insertDataList.Add(new DBItem("CREATNO", userno, DBItem.DBDataType.String)); //建立者員編
                    insertDataList.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
                }

                insertDataList = setNullToEmpty(insertDataList);
                string where = " FEENO = '" + feeno + "' AND BABY_SEQ = '" + babySeq + "'";
                int erow = link.DBExecUpdate("OBS_NBFOOT", insertDataList, where);
            }
            return View();
        }
        #endregion

        #region Barcode
        public void Barcode(string barCode)
        {
            Response.ContentType = "image/gif";
            Barcode bc = new Barcode();
            bc.IncludeLabel = true;//顯示文字標籤
            bc.LabelFont = new Font("Verdana", 9f);//文字標籤字型、大小
            bc.Width = 180;//寬度
            bc.Height = 40;//高度
            System.Drawing.Image img = bc.Encode(TYPE.CODE39, $"*{barCode}*", bc.Width, bc.Height);//產生影像
            img.Save(Response.OutputStream, ImageFormat.Gif);
            Response.End();
        }
        #endregion

        #region 早產兒體重列印單
        public ActionResult Child_Weight_Print(string feeno, string chartno, bool IsHisView = false)
        {
            ViewBag.IsHisView = IsHisView;

            if (IsHisView)
            {
                his.ControllerContext = ControllerContext;
                his.getSession(feeno);
            }

            if (Session["PatInfo"] != null)
            {
                if (feeno == "" || feeno == null)
                    feeno = ptinfo.FeeNo;

                var birthDay = (Session["PatInfo"] as PatientInfo).Birthday;

                List<DataPoint> childWgPoints = new List<DataPoint>();
                List<Dictionary<string, string>> VitalSignList = new List<Dictionary<string, string>>();

                //modified by yijie
                var sql = "SELECT CREATE_DATE, VS_ITEM, VS_PART, VS_RECORD, VS_MEMO,VS_REASON  "
            + " FROM ( "
            + "     SELECT CREATE_DATE, VS_ITEM, VS_PART, VS_RECORD, VS_MEMO,VS_REASON, "
            + "     ROW_NUMBER() OVER(PARTITION BY t.VS_ITEM, to_char(CREATE_DATE, 'yyyy/MM/dd') ORDER BY t.CREATE_DATE desc) NUM "
            + "     FROM DATA_VITALSIGN t "
            + "     WHERE FEE_NO = '" + feeno + "' "
            + "     AND CREATE_DATE >= to_date('" + birthDay.ToString("yyyy/MM/dd HH:mm:ss") + "','yyyy/MM/dd hh24:mi:ss') "
            + "     AND CREATE_DATE <= to_date('" + birthDay.AddDays(100).ToString("yyyy/MM/dd HH:mm:ss") + "','yyyy/MM/dd hh24:mi:ss') "
            + "     ORDER BY CREATE_DATE DESC ) MAIN "
            + " WHERE MAIN.NUM = 1 ";
                //end modified by yijie,20191015
                var Temp = new List<Dictionary<string, string>>();

                DataTable Dt2 = link.DBExecSQL(sql);
                if (Dt2.Rows.Count > 0)
                {
                    for (int i = 0; i < Dt2.Rows.Count; i++)
                    {
                        var temp = new Dictionary<string, string>();
                        temp["CREATE_DATE"] = Dt2.Rows[i]["CREATE_DATE"].ToString();
                        temp["VS_ITEM"] = Dt2.Rows[i]["VS_ITEM"].ToString();
                        temp["VS_PART"] = Dt2.Rows[i]["VS_PART"].ToString();
                        temp["VS_REASON"] = Dt2.Rows[i]["VS_REASON"].ToString();
                        temp["VS_RECORD"] = Dt2.Rows[i]["VS_RECORD"].ToString();
                        temp["VS_MEMO"] = Dt2.Rows[i]["VS_MEMO"].ToString();
                        Temp.Add(temp);
                    }
                }
                if (Temp.Count > 0)
                {
                    VitalSignList = Temp.FindAll(x => x["VS_ITEM"] == "bw" && !string.IsNullOrEmpty(x["VS_RECORD"]));
                    foreach (var r in VitalSignList)
                    {
                        TimeSpan diff = Convert.ToDateTime(r["CREATE_DATE"].ToString()).Subtract(birthDay);
                        var weight = r["VS_RECORD"].ToString().Replace("|", "").Replace("g", "").Replace("kg", "").Replace("請選擇", "");
                        if (weight != "")
                            childWgPoints.Add(new DataPoint(diff.Days, Convert.ToDouble(weight)));
                    }
                }
                var tableData = Temp.FindAll(x => (x["VS_ITEM"] == "bw" || x["VS_ITEM"] == "bh" || x["VS_ITEM"] == "gthr" || x["VS_ITEM"] == "gtbu") && !string.IsNullOrEmpty(x["VS_RECORD"]));
                ViewBag.TableData = tableData.GroupBy(x => Convert.ToDateTime(x["CREATE_DATE"].ToString()).ToString("yyyy/MM/dd"));

                List<string> WeightData = new List<string>() {
                                   "725,700,680,660,640,625,610,595,580,570,560,555,550,555,560,570,575,590,600,610,625,635,650,660,675,685,695,710,720,735,745,755,770,780,790,800,810,825,835,850,860,875,885,900,910,920,935,945,950,960",
                    "980,960,940,930,920,915,910,910,915,920,930,940,950,970,980,1000,1020,1040,1055,1080,1100,1125,1145,1165,1190,1210,1230,1250,1270,1295,1310,1330,1350,1375,1400,1420,1440,1460,1480,1500,1525,1550,1570,1590,1610,1630,1650,1670,1690,1710",
                    "1225,1200,1190,1175,1170,1170,1170,1175,1185,1190,1200,1215,1230,1250,1270,1285,1305,1330,1350,1375,1400,1420,1445,1470,1495,1520,1542,1570,1590,1615,1635,1660,1680,1700,1725,1750,1770,1795,1820,1840,1860,1885,1910,1935,1955,1980,2010,2030,2050,2065",
                    "1475,1440,1425,1410,1400,1400,1410,1420,1435,1450,1470,1495,1520,1545,1575,1600,1620,1645,1670,1695,1720,1745,1765,1790,1810,1835,1855,1880,1910,1935,1960,1980,2010,2035,2060,2085,2115,2140,2160,2180,2210,2240,2260,2285,2310,2330,2355,2380,2410,2430",
                    "1700,1680,1660,1650,1650,1660,1670,1690,1710,1730,1760,1790,1820,1850,1870,1900,1930,1950,1980,2000,2030,2060,2090,2120,2145,2170,2200,2220,2250,2280,2310,2340,2370,2400,2430,2460,2485,2510,2535,2560,2590,2620,2650,2680,2710,2735,2760,2790,2810,2840",
                    "1950,1930,1910,1895,1900,1910,1930,1950,1980,2010,2040,2070,2100,2130,2160,2195,2225,2250,2280,2310,2350,2380,2410,2440,2470,2500,2530,2560,2585,2620,2650,2680,2710,2745,2770,2800,2830,2860,2890,2920,2950,2990,3020,3050,3080,3110,3140,3170,3200,3240",
                    "2200,2160,2150,2145,2150,2160,2190,2220,2250,2290,2325,2360,2400,2440,2470,2505,2550,2590,2620,2660,2695,2730,2765,2810,2845,2875,2915,2950,2990,3025,3060,3100,3140,3175,3205,3250",
                    "2450,2400,2385,2375,2395,2420,2450,2500,2550,2600,2645,2690,2735,2775,2820,2860,2900,2950,3000,3045,3090,3130,3175,3220"
                    };
                Dictionary<int, string> DictData = new Dictionary<int, string>();
                int count = 0;
                foreach (var line in WeightData)
                {
                    List<DataPoint> dataPoints = new List<DataPoint>();
                    count = count + 1;
                    var points = line.Split(',');

                    for (var i = 1; i <= points.Count(); i++)
                        dataPoints.Add(new DataPoint(i, Convert.ToDouble(points[i - 1])));

                    DictData.Add(count, JsonConvert.SerializeObject(dataPoints));
                }
                ViewBag.DataPoints = DictData;

                //add by yijie,20191015
                List<DataPoint> childWgPoints2 = new List<DataPoint>();
                foreach (var item in childWgPoints)
                {
                    //20200420 modified 
                    //if (item.X > 50 && item.Y <= 3260)
                    if (item.X >= 50 && item.Y <= 3260)
                    {
                        childWgPoints2.Add(new DataPoint(Convert.ToDouble(item.X), Convert.ToDouble(item.Y)));
                    }
                }
                for (int i = childWgPoints.Count - 1; i >= 0; i--)
                {
                    if (childWgPoints[i].X > 50 || childWgPoints[i].Y > 3260)
                    {
                        childWgPoints.RemoveAt(i);
                    }
                }
                ViewBag.childWgPoints2 = childWgPoints2;
                //end add by yijie,20191015

                ViewBag.childWgPoints = childWgPoints;
                return View();
            }
            Response.Write("<script>alert('請重新選擇病患');</script>");
            return new EmptyResult();
        }
        #endregion


        #region 生產紀錄列印單
        public ActionResult Production_Record_Print(string fee_no)
        {
            if (ptinfo == null)
            {
                ptinfo = new PatientInfo();
                byte[] ByteCode = webService.GetPatientInfo(fee_no);
                string JosnArr = "";
                //病人資訊
                if (ByteCode != null)
                {
                    JosnArr = CompressTool.DecompressString(ByteCode);
                    ptinfo = JsonConvert.DeserializeObject<PatientInfo>(JosnArr);
                }

            }
            #region 生產史
            DataTable dt = obs_m.sel_bthhis(ptinfo.FeeNo);
            if (dt != null && dt.Rows.Count != 0)
            {
                var inst = new List<string>() { "+", "-", "偽陽", "X", "外院" };

                if (dt.Rows[0]["HBSAG"].ToString() != "")
                    ViewBag.HBSAG = inst[Convert.ToInt32(dt.Rows[0]["HBSAG"].ToString())];
                if (dt.Rows[0]["HBEAG"].ToString() != "")
                    ViewBag.HBEAG = inst[Convert.ToInt32(dt.Rows[0]["HBEAG"].ToString())];
                if (dt.Rows[0]["RUBELLA"].ToString() != "")
                    ViewBag.RUBELLA = inst[Convert.ToInt32(dt.Rows[0]["RUBELLA"].ToString())];
                if (dt.Rows[0]["VDRL1"].ToString() != "")
                    ViewBag.VDRL1 = inst[Convert.ToInt32(dt.Rows[0]["VDRL1"].ToString())];
                if (dt.Rows[0]["VDRL2"].ToString() != "")
                    ViewBag.VDRL2 = inst[Convert.ToInt32(dt.Rows[0]["VDRL2"].ToString())];
                if (dt.Rows[0]["HIV"].ToString() != "")
                    ViewBag.HIV = inst[Convert.ToInt32(dt.Rows[0]["HIV"].ToString())];
                if (dt.Rows[0]["GBS"].ToString() != "")
                {
                    ViewBag.GBS = inst[Convert.ToInt32(dt.Rows[0]["GBS"].ToString())];
                    if (dt.Rows[0]["GBS"].ToString() == "0" && dt.Rows[0]["GBS_AB"].ToString() != "")
                        ViewBag.GBSAB = $"(抗生素施打時間：{Convert.ToDateTime(dt.Rows[0]["GBS_AB"].ToString()).ToString("yyyy/MM/dd HH:mm")})";
                    else
                        ViewBag.GBSAB = "(抗生素施打時間：無)";
                }
            }
            else
            {
                Response.Write("<script>alert('請先新增生產史!');window.close();</script>");
                return new EmptyResult();
            }
            ViewBag.dt = set_dt(dt);

            #endregion

            #region 第二、三產程
            DataTable dt_sta = obs_m.sel_bthsta(ptinfo.FeeNo);
            dt_sta.Columns.Add("PHYSICIAN_1_NAME");
            dt_sta.Columns.Add("PHYSICIAN_2_NAME");
            dt_sta.Columns.Add("CLNURSE_1_NAME");
            dt_sta.Columns.Add("CLNURSE_2_NAME");
            dt_sta.Columns.Add("SRNURSE_1_NAME");
            dt_sta.Columns.Add("SRNURSE_2_NAME");
            dt_sta.Columns.Add("NNP_1_NAME");
            dt_sta.Columns.Add("NNP_2_NAME");
            if (dt_sta != null && dt_sta.Rows.Count > 0)
            {
                DataRow sta_rows = dt_sta.Rows[0];
                if (sta_rows["BIRTH"].ToString() != "" && sta_rows["RFM_TIME"].ToString() != "")
                {
                    var GRuptureTime = Convert.ToDateTime(sta_rows["BIRTH"]).Subtract(Convert.ToDateTime(sta_rows["RFM_TIME"]));
                    ViewBag.GRuptureTime = ((int)GRuptureTime.TotalHours).ToString() + "小時" + GRuptureTime.Minutes.ToString() + "分";
                }

                foreach (DataRow r in dt_sta.Rows)
                {
                    if (r["PHYSICIAN_1"].ToString() != "")
                    {
                        byte[] listByteCode = webService.UserName(r["PHYSICIAN_1"].ToString());
                        if (listByteCode == null)
                            r["PHYSICIAN_1_NAME"] = "";
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(listByteCode);
                            UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                            r["PHYSICIAN_1_NAME"] = user_name.EmployeesName;
                        }
                    }

                    if (r["PHYSICIAN_2"].ToString() != "")
                    {
                        byte[] listByteCode = webService.UserName(r["PHYSICIAN_2"].ToString());
                        if (listByteCode == null)
                            r["PHYSICIAN_2_NAME"] = "";
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(listByteCode);
                            UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                            r["PHYSICIAN_2_NAME"] = user_name.EmployeesName;
                        }
                    }

                    if (r["CLNURSE_1"].ToString() != "")
                    {
                        byte[] listByteCode = webService.UserName(r["CLNURSE_1"].ToString());
                        if (listByteCode == null)
                            r["CLNURSE_1_NAME"] = "";
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(listByteCode);
                            UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                            r["CLNURSE_1_NAME"] = user_name.EmployeesName;
                        }
                    }

                    if (r["CLNURSE_2"].ToString() != "")
                    {
                        byte[] listByteCode = webService.UserName(r["CLNURSE_2"].ToString());
                        if (listByteCode == null)
                            r["CLNURSE_2_NAME"] = "";
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(listByteCode);
                            UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                            r["CLNURSE_2_NAME"] = user_name.EmployeesName;
                        }
                    }

                    if (r["SRNURSE_1"].ToString() != "")
                    {
                        byte[] listByteCode = webService.UserName(r["SRNURSE_1"].ToString());
                        if (listByteCode == null)
                            r["SRNURSE_1_NAME"] = "";
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(listByteCode);
                            UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                            r["SRNURSE_1_NAME"] = user_name.EmployeesName;
                        }
                    }

                    if (r["SRNURSE_2"].ToString() != "")
                    {
                        byte[] listByteCode = webService.UserName(r["SRNURSE_2"].ToString());
                        if (listByteCode == null)
                            r["SRNURSE_2_NAME"] = "";
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(listByteCode);
                            UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                            r["SRNURSE_2_NAME"] = user_name.EmployeesName;
                        }
                    }

                    if (r["NNP_1"].ToString() != "")
                    {
                        byte[] listByteCode = webService.UserName(r["NNP_1"].ToString());
                        if (listByteCode == null)
                            r["NNP_1_NAME"] = "";
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(listByteCode);
                            UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                            r["NNP_1_NAME"] = user_name.EmployeesName;
                        }
                    }

                    if (r["NNP_2"].ToString() != "")
                    {
                        byte[] listByteCode = webService.UserName(r["NNP_2"].ToString());
                        if (listByteCode == null)
                            r["NNP_2_NAME"] = "";
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(listByteCode);
                            UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                            r["NNP_2_NAME"] = user_name.EmployeesName;
                        }
                    }
                }
            }
            else
            {
                Response.Write("<script>alert('請先新增二、三產程!');window.close();</script>");
                return new EmptyResult();
            }
            ViewBag.dt_sta = set_dt(dt_sta);
            #endregion

            #region 新生兒
            var live = 0;
            DataTable dt_nb = obs_m.sel_nb(ptinfo.FeeNo);
            dt_nb.Columns.Add("TPR");
            dt_nb.Columns.Add("CREATNO_NAME");
            dt_nb.Columns.Add("CREATNO_2_NAME");
            dt_nb.Columns.Add("DIRECTOR_NAME");
            dt_nb.Columns.Add("RB_AS_1_WHO_NAME");
            dt_nb.Columns.Add("RB_AS_5_WHO_NAME");
            dt_nb.Columns.Add("RB_AS_10_WHO_NAME");
            dt_nb.Columns.Add("RB_AS_OTH_WHO_NAME");
            if (dt_nb != null && dt_nb.Rows.Count > 0)
            {
                foreach (DataRow r_nb in dt_nb.Rows)
                {
                    if (r_nb["CREATNO"].ToString() != "")
                    {
                        byte[] listByteCode = webService.UserName(r_nb["CREATNO"].ToString());
                        if (listByteCode == null)
                            r_nb["CREATNO_NAME"] = "";
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(listByteCode);
                            UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                            r_nb["CREATNO_NAME"] = user_name.EmployeesName;
                        }
                    }

                    if (r_nb["CREATNO_2"].ToString() != "")
                    {
                        byte[] listByteCode = webService.UserName(r_nb["CREATNO_2"].ToString());
                        if (listByteCode == null)
                            r_nb["CREATNO_2_NAME"] = "";
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(listByteCode);
                            UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                            r_nb["CREATNO_2_NAME"] = user_name.EmployeesName;
                        }
                    }

                    if (r_nb["DIRECTOR"].ToString() != "")
                    {
                        byte[] listByteCode = webService.UserName(r_nb["DIRECTOR"].ToString());
                        if (listByteCode == null)
                            r_nb["DIRECTOR_NAME"] = "";
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(listByteCode);
                            UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                            r_nb["DIRECTOR_NAME"] = user_name.EmployeesName;
                        }
                    }

                    if (r_nb["RB_AS_1_WHO"].ToString() != "")
                    {
                        byte[] listByteCode = webService.UserName(r_nb["RB_AS_1_WHO"].ToString());
                        if (listByteCode == null)
                            r_nb["RB_AS_1_WHO_NAME"] = "";
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(listByteCode);
                            UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                            r_nb["RB_AS_1_WHO_NAME"] = user_name.EmployeesName;
                        }
                    }

                    if (r_nb["RB_AS_5_WHO"].ToString() != "")
                    {
                        byte[] listByteCode = webService.UserName(r_nb["RB_AS_5_WHO"].ToString());
                        if (listByteCode == null)
                            r_nb["RB_AS_5_WHO_NAME"] = "";
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(listByteCode);
                            UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                            r_nb["RB_AS_5_WHO_NAME"] = user_name.EmployeesName;
                        }
                    }

                    if (r_nb["RB_AS_10_WHO"].ToString() != "")
                    {
                        byte[] listByteCode = webService.UserName(r_nb["RB_AS_10_WHO"].ToString());
                        if (listByteCode == null)
                            r_nb["RB_AS_10_WHO_NAME"] = "";
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(listByteCode);
                            UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                            r_nb["RB_AS_10_WHO_NAME"] = user_name.EmployeesName;
                        }
                    }

                    if (r_nb["RB_AS_OTH_WHO"].ToString() != "")
                    {
                        byte[] listByteCode = webService.UserName(r_nb["RB_AS_OTH_WHO"].ToString());
                        if (listByteCode == null)
                            r_nb["RB_AS_OTH_WHO_NAME"] = "";
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(listByteCode);
                            UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                            r_nb["RB_AS_OTH_WHO_NAME"] = user_name.EmployeesName;
                        }
                    }

                    if (r_nb["RB_AS_1_NUM"].ToString() == "0")
                    {
                        if (r_nb["RB_AS_1_1"].ToString() == "" && r_nb["RB_AS_1_2"].ToString() == "" &&
                            r_nb["RB_AS_1_3"].ToString() == "" && r_nb["RB_AS_1_4"].ToString() == "" &&
                            r_nb["RB_AS_1_5"].ToString() == "")
                        {
                            r_nb["RB_AS_1_NUM"] = "-";
                        }
                    }

                    if (r_nb["RB_AS_5_NUM"].ToString() == "0")
                    {
                        if (r_nb["RB_AS_5_1"].ToString() == "" && r_nb["RB_AS_5_2"].ToString() == "" &&
                            r_nb["RB_AS_5_3"].ToString() == "" && r_nb["RB_AS_5_4"].ToString() == "" &&
                            r_nb["RB_AS_5_5"].ToString() == "")
                        {
                            r_nb["RB_AS_5_NUM"] = "-";
                        }
                    }

                    if (r_nb["RB_AS_10_NUM"].ToString() == "0")
                    {
                        if (r_nb["RB_AS_10_1"].ToString() == "" && r_nb["RB_AS_10_2"].ToString() == "" &&
                            r_nb["RB_AS_10_3"].ToString() == "" && r_nb["RB_AS_10_4"].ToString() == "" &&
                            r_nb["RB_AS_10_5"].ToString() == "")
                        {
                            r_nb["RB_AS_10_NUM"] = "-";
                        }
                    }

                    if (r_nb["NB_STAT"].ToString() == "1")
                    {
                        live += 1;
                    }
                }
            }
            else
            {
                Response.Write("<script>alert('請先新增新生兒出生紀錄!');window.close();</script>");
                return new EmptyResult();
            }
            ViewBag.Live = live.ToString();
            ViewBag.dt_nb = set_dt(dt_nb);
            #endregion

            ViewBag.ptinfo = ptinfo;
            return View();
        }
        #endregion


        #region 新生兒出生紀錄畫面
        /// <summary>
        /// 新生兒出生紀錄畫面
        /// </summary>
        /// <param name="count"></param>
        /// <param name="Amniotic"></param>
        /// <param name="sexList"></param>
        /// <param name="id"></param>
        /// <param name="liveList"></param>
        /// <returns></returns>
        public ActionResult Partial_Child_Brith(string feeno, string chartno, bool Kardex = false, bool IsHisView = false)
        {
            ViewBag.IsHisView = IsHisView;
            ViewBag.Kardex = Kardex;

            if (IsHisView)
            {
                his.ControllerContext = ControllerContext;
                his.getSession(feeno);
            }

            if (Session["PatInfo"] != null)
            {
                var age = 0;

                age = (Session["PatInfo"] as PatientInfo).Age;

                if (feeno == "" || feeno == null)
                    feeno = ptinfo.FeeNo;
                if (chartno == "" || chartno == null)
                    chartno = ptinfo.ChartNo;

                var babyChartNo = "";
                var seq = "";
                if (age < 1)
                {
                    DataTable babylink = obs_m.sel_nbcha("", chartno.PadLeft(10, '0'));
                    if (babylink != null && babylink.Rows.Count > 0)
                    {
                        feeno = babylink.Rows[0]["MOM_FEE_NO"].ToString();
                        seq = babylink.Rows[0]["BABY_SEQ"].ToString();
                        babyChartNo = babylink.Rows[0]["BABY_CHART_NO"].ToString();
                    }
                }

                DataTable dt = obs_m.sel_nb(feeno, babyChartNo);
                dt.Columns.Add("CREATNO_NAME");
                dt.Columns.Add("CREATNO_2_NAME");
                dt.Columns.Add("DIRECTOR_NAME");
                dt.Columns.Add("RB_AS_1_WHO_NAME");
                dt.Columns.Add("RB_AS_5_WHO_NAME");
                dt.Columns.Add("RB_AS_10_WHO_NAME");
                dt.Columns.Add("RB_AS_OTH_WHO_NAME");
                if (dt != null && dt.Rows.Count > 0)
                {
                    foreach (DataRow r in dt.Rows)
                    {
                        if (r["CREATNO"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["CREATNO"].ToString());
                            if (listByteCode == null)
                                r["CREATNO_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["CREATNO_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["CREATNO_2"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["CREATNO_2"].ToString());
                            if (listByteCode == null)
                                r["CREATNO_2_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["CREATNO_2_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["DIRECTOR"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["DIRECTOR"].ToString());
                            if (listByteCode == null)
                                r["DIRECTOR_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["DIRECTOR_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["RB_AS_1_WHO"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["RB_AS_1_WHO"].ToString());
                            if (listByteCode == null)
                                r["RB_AS_1_WHO_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["RB_AS_1_WHO_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["RB_AS_5_WHO"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["RB_AS_5_WHO"].ToString());
                            if (listByteCode == null)
                                r["RB_AS_5_WHO_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["RB_AS_5_WHO_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["RB_AS_10_WHO"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["RB_AS_10_WHO"].ToString());
                            if (listByteCode == null)
                                r["RB_AS_10_WHO_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["RB_AS_10_WHO_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["RB_AS_OTH_WHO"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["RB_AS_OTH_WHO"].ToString());
                            if (listByteCode == null)
                                r["RB_AS_OTH_WHO_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["RB_AS_OTH_WHO_NAME"] = user_name.EmployeesName;
                            }
                        }
                    }
                }

                ViewBag.dt = set_dt(dt);

                if (dt != null)
                    ViewBag.count = dt.Rows.Count;
                else
                    ViewBag.count = 0;

                DataTable dt_emr = obs_m.sel_nb_emr(feeno, "", "");
                dt_emr.Columns.Add("CREATNO_ET_NAME");
                if (dt_emr != null && dt_emr.Rows.Count > 0)
                {
                    foreach (DataRow r in dt_emr.Rows)
                    {
                        if (r["CREATNO_ET"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["CREATNO_ET"].ToString());
                            if (listByteCode == null)
                                r["CREATNO_ET_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["CREATNO_ET_NAME"] = user_name.EmployeesName;
                            }
                        }
                    }
                }
                ViewBag.dt_emr = set_dt(dt_emr);
                ViewBag.ptinfo = ptinfo;
                ViewBag.userinfo = userinfo;
                return View();
            }
            Response.Write("<script>alert('請重新選擇病患');</script>");
            return new EmptyResult();
        }
        #endregion

        #region 第一次產生出生紀錄(第二、三產程底下)
        /// <summary>
        /// 第一次產生出生紀錄
        /// </summary>
        /// <returns></returns>
        [HttpPost]
        public ActionResult Insert_Partial_Child_Brith(FormCollection form)
        {
            link.DBOpen();
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo?.FeeNo;
            DataRow bthstaRow = null;
            DataTable stadt = obs_m.sel_bthsta(ptinfo.FeeNo);
            if (stadt == null || stadt.Rows.Count == 0)
            {
                Response.Write("<script>alert('新增失敗，請先新增二、三產程資料!');window.location.href='Index?active=Before_Birth_List&mode=1&show=Y'</script>");
                return new EmptyResult();
            }
            else
                bthstaRow = stadt.Rows[0];

            int count = Convert.ToInt32(form["COUNT"]);
            int erow = 0;
            for (var i = 1; i <= count; i++)
            {
                string id = base.creatid("OBS_NB", userno, feeno, "0");
                List<DBItem> insertDataList = new List<DBItem>();
                insertDataList.Add(new DBItem("IID", id, DBItem.DBDataType.String)); //序號
                insertDataList.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String)); //批價序號
                insertDataList.Add(new DBItem("CREATNO", userno, DBItem.DBDataType.String)); //建立者員編
                insertDataList.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
                insertDataList.Add(new DBItem("RECORDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間
                insertDataList.Add(new DBItem("DELETED", null, DBItem.DBDataType.String)); //刪除註記

                var NB_NAME = form["TXT_NB_NAME_" + i];
                insertDataList.Add(new DBItem("NB_NAME", form["TXT_NB_NAME_" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("NB_TEMPNO", feeno + NB_NAME.Replace("新生兒", ""), DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("GENDER", form["RB_GENDER_" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("BIRTH_DAY", form["TXT_BIRTH_DAY_C_DAY" + i] + " " + form["TXT_BIRTH_DAY_C_TIME" + i], DBItem.DBDataType.DataTime));

                insertDataList.Add(new DBItem("BIRTH_TYPE", bthstaRow["BIRTH_TYPE"].ToString(), DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("VACUUM_NSD", bthstaRow["VACUUM_NSD"].ToString(), DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("VACUUM_CS", bthstaRow["VACUUM_CS"].ToString(), DBItem.DBDataType.String));

                if (bthstaRow["RUPTURETYPE"].ToString() == "2")
                    insertDataList.Add(new DBItem("MECONIUM_COLOR", (Convert.ToInt32(bthstaRow["MECONIUM_COLOR"].ToString()) + 1).ToString(), DBItem.DBDataType.String));
                else
                    insertDataList.Add(new DBItem("MECONIUM_COLOR", "0", DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("RB_AS_1_WHO", bthstaRow["PHYSICIAN_1"].ToString(), DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("RB_AS_5_WHO", bthstaRow["PHYSICIAN_1"].ToString(), DBItem.DBDataType.String));


                if (bthstaRow["BIRTH"].ToString() != "" && bthstaRow["RFM_TIME"].ToString() != "")
                {
                    var ROM_TT = Convert.ToDateTime(bthstaRow["BIRTH"]).Subtract(Convert.ToDateTime(bthstaRow["RFM_TIME"]));
                    insertDataList.Add(new DBItem("ROM_TT", ROM_TT.Days.ToString() + "天" + ROM_TT.Hours.ToString() + "小時" + ROM_TT.Minutes.ToString() + "分鐘" + ROM_TT.Seconds.ToString() + "秒", DBItem.DBDataType.String));
                }

                var NB_STAT = form["RB_NB_STAT_" + i];
                insertDataList.Add(new DBItem("NB_STAT", NB_STAT, DBItem.DBDataType.String));

                if (NB_STAT == "0")
                {
                    var NB_STAT_RS = form["CK_NB_STAT_RS_" + i];
                    if (NB_STAT_RS == null)
                    {
                        Response.Write("<script>alert('新增失敗，" + NB_NAME + "需填寫歿-原因');window.location.href='Index?active=Before_Birth_List&mode=1&show=Y'</script>");
                        break;
                    }
                    var NB_STAT_RSV = new List<string>() { "0", "0", "0", "0", "0" };
                    if (NB_STAT_RS == null)
                        insertDataList.Add(new DBItem("NB_STAT_RS", String.Join("", NB_STAT_RSV), DBItem.DBDataType.String));
                    else
                    {
                        var NB_STAT_RS_SP = NB_STAT_RS.Split(',');
                        foreach (var v in NB_STAT_RS_SP)
                            NB_STAT_RSV[Convert.ToInt32(v)] = "1";
                        insertDataList.Add(new DBItem("NB_STAT_RS", String.Join("", NB_STAT_RSV), DBItem.DBDataType.String));
                    }

                    if (NB_STAT_RSV[4] == "1")
                        insertDataList.Add(new DBItem("NB_STAT_RS_OTH", form["TXT_NB_STAT_RS_OTH_" + i], DBItem.DBDataType.String));
                }
                if (NB_STAT == "1")
                {
                    insertDataList.Add(new DBItem("NB_STAT_RS", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("NB_STAT_RS_OTH", null, DBItem.DBDataType.String));
                }
                insertDataList = setNullToEmpty(insertDataList);
                erow += link.DBExecInsert("OBS_NB", insertDataList);

                if (erow != i)
                {
                    Response.Write("<script>alert('新增失敗');window.location.href='Index?active=Before_Birth_List&mode=1&show=Y'</script>");
                    return new EmptyResult();
                }

                #region 溝通NIS表
                List<DBItem> insertDataList_CHA = new List<DBItem>();
                insertDataList_CHA.Add(new DBItem("MOM_FEE_NO", feeno, DBItem.DBDataType.String)); //產婦住院號
                insertDataList_CHA.Add(new DBItem("BABY_SEQ", NB_NAME.Replace("新生兒", ""), DBItem.DBDataType.String)); //新生兒胎序

                insertDataList_CHA.Add(new DBItem("BABY_GENDER", form["RB_GENDER_" + i], DBItem.DBDataType.String)); //新生兒性別
                insertDataList_CHA.Add(new DBItem("BABY_BIRTH_DAY", form["TXT_BIRTH_DAY_C_DAY" + i], DBItem.DBDataType.String)); //新生兒出生日期
                insertDataList_CHA.Add(new DBItem("BABY_BIRTH_TIME", form["TXT_BIRTH_DAY_C_TIME" + i], DBItem.DBDataType.String)); //新生兒出生時間

                insertDataList_CHA.Add(new DBItem("CREATE_DATE", DateTime.Now.ToString("yyyy/MM/dd"), DBItem.DBDataType.String)); //建立時間
                insertDataList_CHA.Add(new DBItem("CREATE_NAME", Get_Employee_Name(userno), DBItem.DBDataType.String));
                insertDataList_CHA.Add(new DBItem("CREATE_CLERK", userno, DBItem.DBDataType.String));

                insertDataList_CHA = setNullToEmpty(insertDataList_CHA);
                link.DBExecInsert("OBS_BABYLINK_DATA", insertDataList_CHA);
                #endregion

                #region 出生紀錄護理紀錄
                var content = $"出生時間：{form["TXT_BIRTH_DAY_C_DAY" + i] + " " + form["TXT_BIRTH_DAY_C_TIME" + i]}。";
                content += $"性別：{form["RB_GENDER_" + i]}。生產方式：{(bthstaRow["BIRTH_TYPE"].ToString() == "0" ? "陰道產" : "剖腹產")}。";
                content += $"妊娠週數：{bthstaRow["GEST_M"].ToString()}+{bthstaRow["GEST_D"].ToString()}週。";
                //content += "身高：未填寫。體重：未填寫。頭圍：未填寫。胸圍：未填寫。";
                //content += " Apgar Score：第一分鐘：未填寫、第五分鐘：未填寫、第十分鐘：未填寫。";

                base.Insert_CareRecordTns(form["TXT_BIRTH_DAY_C_DAY" + i] + " " + form["TXT_BIRTH_DAY_C_TIME" + i], id, $"新生兒出生紀錄-{(ptinfo.Age < 1 ? "小孩" : "母親")}", content, "", "", "", "", "OBS_NB", ref link);
                #endregion
            }

            #region 護理紀錄

            DataTable dtHis = obs_m.sel_bthhis(ptinfo?.FeeNo);
            DataRow hisrow = dtHis.Rows[0];
            DataTable dtBth = obs_m.sel_bthsta(ptinfo?.FeeNo);
            DataRow row = dtBth.Rows[0];
            var title = $"生產紀錄單-{(count <= 1 ? "單胞胎" : "雙胞胎")}";
            var contents = new List<string>();
            var field = "";

            #region 產前
            field = "預產期";
            field += hisrow["EDC"].ToString() == "" ? "" : Convert.ToDateTime(hisrow["EDC"].ToString()).ToString("yyyy/MM/dd");
            contents.Add(field);

            field = $"生產週數{row["GEST_M"]}+{row["GEST_D"]}週";
            contents.Add(field);

            field = $"於{(hisrow["GBS_AB_TYP"].ToString() == "0" ? "住院" : "急診")}{(hisrow["GBS_AB"].ToString() == "" ? "" : Convert.ToDateTime(hisrow["GBS_AB"].ToString()).ToString("yyyy/MM/dd HH:mm"))}始依醫囑打抗生素";
            contents.Add(field);

            field = $"G{hisrow["GRAVIDA"]}P{row["PARITY_N"]}A{hisrow["ABORTION"]}E{hisrow["ECCYESIS"]}";
            contents.Add(field);

            field = $"總活產數{row["LB_TOTAL_N"]}";
            contents.Add(field);

            field = $"先生{(row["PATERNITY"].ToString() == "1" ? $"有陪產{(row["CORDCLAMP"].ToString() == "1" ? "有斷臍" : "無斷臍")}" : "無陪產")}";
            contents.Add(field);
            #endregion

            #region 生產
            //單胞胎
            if (count == 1)
            {
                if (row["BIRTH_NA"].ToString() == "1")
                    field = $"生產時間不詳";
                else
                    field = $"生產時間{(row["BIRTH"].ToString() == "" ? "" : Convert.ToDateTime(row["BIRTH"].ToString()).ToString("yyyy/MM/dd HH:mm"))} {(row["BIRTH_NA"].ToString() == "0" ? "口述" : "")}";
                contents.Add(field);
            }

            field = $"生產方式{(row["BIRTH_TYPE"].ToString() == "0" ? "NSD" : "C/S")}";
            if (row["BIRTH_TYPE"].ToString() == "0" && row["VACUUM_NSD"].ToString() != "" && row["VACUUM_NSD"].ToString() == "0")
            {
                field += "+VACUUM";
            }

            if (row["BIRTH_TYPE"].ToString() == "1" && row["VACUUM_CS"].ToString() != "" && row["VACUUM_CS"].ToString() == "0")
            {
                field += "+VACUUM";
            }

            if (row["CS_NOTE"].ToString() != "")
            {
                field += $"{(row["CS_NOTE"].ToString() == "0" ? "{註記：初次剖腹產}" : "{註記：前胎剖腹產}")}";
            }
            contents.Add(field);

            #endregion

            if (count > 1)
            {
                field = "";
                for (var j = 1; j <= count; j++)
                {
                    var NB_NAME = form["TXT_NB_NAME_" + j];
                    field = $"{NB_NAME.Replace("新生兒", "")}生產時間{form["TXT_BIRTH_DAY_C_DAY" + j] + " " + form["TXT_BIRTH_DAY_C_TIME" + j]}";
                    contents.Add(field);
                }
            }

            if (row["DOP_TIME_NA"].ToString() == "1")
                field = $"胎盤娩出時間：不詳";
            else
                field = $"胎盤娩出時間：{(row["DOP_TIME"].ToString() == "" ? "" : Convert.ToDateTime(row["DOP_TIME"].ToString()).ToString("yyyy/MM/dd HH:mm"))}";
            contents.Add(field);

            field = "";
            switch (row["DOP"].ToString())
            {
                case "0":
                    field = "稀氏";
                    break;
                case "1":
                    field = "鄧氏";
                    break;
                case "2":
                    field = "混合剝離";
                    break;
                case "3":
                    field = "人工剝離";
                    break;
                default:
                    field = "";
                    break;
            }
            contents.Add(field);

            if (row["DR_LVTIME_NA"].ToString() == "1")
                field = $"離開分娩室時間：不詳";
            else
                field = $"離開分娩室時間：{(row["DR_LVTIME"].ToString() == "" ? "" : Convert.ToDateTime(row["DR_LVTIME"].ToString()).ToString("yyyy/MM/dd HH:mm"))}";
            contents.Add(field);

            base.Insert_CareRecordTns(Convert.ToDateTime(row["BIRTH"].ToString()).ToString("yyyy/MM/dd HH:mm:ss"), dtBth.Rows[0]["IID"].ToString(), title, String.Join("，", contents) + "。", "", "", "", "", "OBS_BTHSTA", ref link);

            #endregion

            if (erow > 0)
            {
                link.DBCommit();
                Response.Write("<script>alert('新增成功');window.location.href='Index?active=Partial_Child_Brith'</script>");
            }
            else
            {
                link.DBRollBack();
                Response.Write("<script>alert('新增失敗');window.location.href='Index?active=Partial_Child_Brith'</script>");
            }

            return new EmptyResult();
        }
        #endregion

        #region 編輯出生紀錄(第二、三產程底下)
        /// <summary>
        /// 編輯出生紀錄
        /// </summary>
        /// <param name="form"></param>
        /// <returns></returns>
        [HttpPost]
        public ActionResult Upd_Partial_Child_Brith(FormCollection form)
        {
            link.DBOpen();
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo?.FeeNo;

            DataRow bthstaRow = null;
            DataTable stadt = obs_m.sel_bthsta(ptinfo.FeeNo);
            if (stadt == null || stadt.Rows.Count == 0)
            {
                Response.Write("<script>alert('新增失敗，請先新增二、三產程資料!');window.location.href='Index?active=Before_Birth_List&mode=1&show=Y'</script>");
                return new EmptyResult();
            }
            else
                bthstaRow = stadt.Rows[0];

            if (bthstaRow["CLNURSE_1"].ToString() != userinfo.EmployeesNo && bthstaRow["CLNURSE_2"].ToString() != userinfo.EmployeesNo)
            {
                Response.Write("<script>alert('非流動護理師，無法修改!');window.location.href='Index?active=Before_Birth_List&mode=1&show=Y'</script>");
                return new EmptyResult();
            }

            string[] id_list = form["IID"].Split(',');
            int erow = 0;
            foreach (var i in id_list)
            {
                List<DBItem> insertDataList = new List<DBItem>();
                insertDataList.Add(new DBItem("UPDNO", userno, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("UPDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime));
                insertDataList.Add(new DBItem("RECORDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間
                insertDataList.Add(new DBItem("DELETED", null, DBItem.DBDataType.String)); //刪除註記

                insertDataList.Add(new DBItem("NB_NAME", form["TXT_NB_NAME_" + i], DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("GENDER", form["RB_GENDER_" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("BIRTH_DAY", form["TXT_BIRTH_DAY_C_DAY" + i] + " " + form["TXT_BIRTH_DAY_C_TIME" + i], DBItem.DBDataType.DataTime));

                var NB_STAT = form["RB_NB_STAT_" + i];
                insertDataList.Add(new DBItem("NB_STAT", NB_STAT, DBItem.DBDataType.String));

                if (NB_STAT == "0")
                {
                    var NB_STAT_RS = form["CK_NB_STAT_RS_" + i];
                    var NB_STAT_RSV = new List<string>() { "0", "0", "0", "0", "0" };
                    if (NB_STAT_RS == null)
                        insertDataList.Add(new DBItem("NB_STAT_RS", String.Join("", NB_STAT_RSV), DBItem.DBDataType.String));
                    else
                    {
                        var NB_STAT_RS_SP = NB_STAT_RS.Split(',');
                        foreach (var v in NB_STAT_RS_SP)
                            NB_STAT_RSV[Convert.ToInt32(v)] = "1";
                        insertDataList.Add(new DBItem("NB_STAT_RS", String.Join("", NB_STAT_RSV), DBItem.DBDataType.String));
                    }

                    if (NB_STAT_RSV[4] == "1")
                        insertDataList.Add(new DBItem("NB_STAT_RS_OTH", form["TXT_NB_STAT_RS_OTH_" + i], DBItem.DBDataType.String));
                }
                if (NB_STAT == "1")
                {
                    insertDataList.Add(new DBItem("NB_STAT_RS", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("NB_STAT_RS_OTH", null, DBItem.DBDataType.String));
                }

                string where = " IID = '" + i + "' ";
                insertDataList = setNullToEmpty(insertDataList);
                erow += link.DBExecUpdate("OBS_NB", insertDataList, where);

                #region 出生紀錄護理紀錄
                DataTable childdt = obs_m.sel_nb(ptinfo.FeeNo, "", i);

                var content = $"出生時間：#出生時間#。";
                content += $"性別：#性別#。生產方式：{(childdt.Rows[0]["BIRTH_TYPE"].ToString() == "0" ? "陰道產" : "剖腹產")}。";
                content += $"妊娠週數：{bthstaRow["GEST_M"].ToString()}+{bthstaRow["GEST_D"].ToString()}週。";
                content += $"身高：{(childdt.Rows[0]["HEIGHT"].ToString() == "" ? "0" : childdt.Rows[0]["HEIGHT"])}公分。體重：{(childdt.Rows[0]["WEIGHT"].ToString() == "" ? "0" : childdt.Rows[0]["WEIGHT"].ToString())}公克。";
                content += $"頭圍：{(childdt.Rows[0]["HEAD"].ToString() == "" ? "0" : childdt.Rows[0]["HEAD"])}公分。胸圍：{(childdt.Rows[0]["CHEST"].ToString() == "" ? "0" : childdt.Rows[0]["CHEST"].ToString())}公分。";

                var apgar = new List<string>();

                if (childdt.Rows[0]["RB_AS_1_1"].ToString() != "" || childdt.Rows[0]["RB_AS_1_2"].ToString() != "" || childdt.Rows[0]["RB_AS_1_3"].ToString() != ""
                               || childdt.Rows[0]["RB_AS_1_4"].ToString() != "" || childdt.Rows[0]["RB_AS_1_5"].ToString() != "")
                {
                    apgar.Add($"第一分鐘：{(childdt.Rows[0]["RB_AS_1_NUM"].ToString() == "" ? "0" : childdt.Rows[0]["RB_AS_1_NUM"])}分");
                }

                if (childdt.Rows[0]["RB_AS_5_1"].ToString() != "" || childdt.Rows[0]["RB_AS_5_2"].ToString() != "" || childdt.Rows[0]["RB_AS_5_3"].ToString() != ""
                               || childdt.Rows[0]["RB_AS_5_4"].ToString() != "" || childdt.Rows[0]["RB_AS_5_5"].ToString() != "")
                {
                    apgar.Add($"第五分鐘：{(childdt.Rows[0]["RB_AS_5_NUM"].ToString() == "" ? "0" : childdt.Rows[0]["RB_AS_5_NUM"])}分");
                }

                if (childdt.Rows[0]["RB_AS_10_1"].ToString() != "" || childdt.Rows[0]["RB_AS_10_2"].ToString() != "" || childdt.Rows[0]["RB_AS_10_3"].ToString() != ""
                               || childdt.Rows[0]["RB_AS_10_4"].ToString() != "" || childdt.Rows[0]["RB_AS_10_5"].ToString() != "")
                {
                    apgar.Add($"第十分鐘：{(childdt.Rows[0]["RB_AS_10_NUM"].ToString() == "" ? "0" : childdt.Rows[0]["RB_AS_10_NUM"])}分");
                }
                if (apgar.Count() > 0)
                    content += $"Apgar Score：{String.Join("、", apgar)}";

                //小孩多急救處置
                if (ptinfo.Age < 1)
                {
                    DataTable child_emrdt = obs_m.sel_nb_emr(ptinfo.FeeNo);
                    if (child_emrdt != null && child_emrdt.Rows.Count > 0)
                    {
                        foreach (DataRow r in child_emrdt.Rows)
                        {
                            content += r["ET"].ToString() + "。";
                        }
                    }
                }

                content = content.Replace("#出生時間#", form["TXT_BIRTH_DAY_C_DAY" + i] + " " + form["TXT_BIRTH_DAY_C_TIME" + i]);
                content = content.Replace("#性別#", form["RB_GENDER_" + i]);

                erow += base.Upd_CareRecord(form["TXT_BIRTH_DAY_C_DAY" + i] + " " + form["TXT_BIRTH_DAY_C_TIME" + i], i, $"新生兒出生紀錄-{(ptinfo.Age < 1 ? "小孩" : "母親")}", content, "", "", "", "", "OBS_NB");
                #endregion
            }

            #region 護理紀錄

            DataTable dtHis = obs_m.sel_bthhis(ptinfo?.FeeNo);
            DataRow hisrow = dtHis.Rows[0];
            DataTable dtBth = obs_m.sel_bthsta(ptinfo?.FeeNo);
            DataRow row = dtBth.Rows[0];
            var title = $"生產紀錄單-{(id_list.Count() <= 1 ? "單胞胎" : "雙胞胎")}";
            var contents = new List<string>();
            var field = "";

            #region 產前
            field = "預產期";
            field += hisrow["EDC"].ToString() == "" ? "" : Convert.ToDateTime(hisrow["EDC"].ToString()).ToString("yyyy/MM/dd");
            contents.Add(field);

            field = $"生產週數{row["GEST_M"]}+{row["GEST_D"]}週";
            contents.Add(field);

            field = $"於{(hisrow["GBS_AB_TYP"].ToString() == "0" ? "住院" : "急診")}{(hisrow["GBS_AB"].ToString() == "" ? "" : Convert.ToDateTime(hisrow["GBS_AB"].ToString()).ToString("yyyy/MM/dd HH:mm"))}始依醫囑打抗生素";
            contents.Add(field);

            field = $"G{hisrow["GRAVIDA"]}P{row["PARITY_N"]}A{hisrow["ABORTION"]}E{hisrow["ECCYESIS"]}";
            contents.Add(field);

            field = $"總活產數{row["LB_TOTAL_N"]}";
            contents.Add(field);

            field = $"先生{(row["PATERNITY"].ToString() == "1" ? $"有陪產{(row["CORDCLAMP"].ToString() == "1" ? "有斷臍" : "無斷臍")}" : "無陪產")}";
            contents.Add(field);
            #endregion

            #region 生產
            //單胞胎
            if (id_list.Count() == 1)
            {
                if (row["BIRTH_NA"].ToString() == "1")
                    field = $"生產時間不詳";
                else
                    field = $"生產時間{(row["BIRTH"].ToString() == "" ? "" : Convert.ToDateTime(row["BIRTH"].ToString()).ToString("yyyy/MM/dd HH:mm"))} {(row["BIRTH_NA"].ToString() == "0" ? "口述" : "")}";
                contents.Add(field);
            }

            field = $"生產方式{(row["BIRTH_TYPE"].ToString() == "0" ? "NSD" : "C/S")}";
            if (row["BIRTH_TYPE"].ToString() == "1")
            {
                if (row["BIRTH_TYPE"].ToString() == "0" && row["VACUUM_NSD"].ToString() != "" && row["VACUUM_NSD"].ToString() == "0")
                {
                    field += "+VACUUM";
                }

                if (row["BIRTH_TYPE"].ToString() == "1" && row["VACUUM_CS"].ToString() != "" && row["VACUUM_CS"].ToString() == "0")
                {
                    field += "+VACUUM";
                }

                if (row["CS_NOTE"].ToString() != "")
                {
                    field += $"{(row["CS_NOTE"].ToString() == "0" ? "{註記：初次剖腹產}" : "{註記：前胎剖腹產}")}";
                }
            }
            contents.Add(field);

            #endregion

            if (id_list.Count() > 1)
            {
                field = "";
                foreach (var j in id_list)
                {
                    var NB_NAME = form["TXT_NB_NAME_" + j];
                    field = $"{NB_NAME.Replace("新生兒", "")}生產時間{form["TXT_BIRTH_DAY_C_DAY" + j] + " " + form["TXT_BIRTH_DAY_C_TIME" + j]}";
                    contents.Add(field);
                }
            }

            if (row["DOP_TIME_NA"].ToString() == "1")
                field = $"胎盤娩出時間：不詳";
            else
                field = $"胎盤娩出時間：{(row["DOP_TIME"].ToString() == "" ? "" : Convert.ToDateTime(row["DOP_TIME"].ToString()).ToString("yyyy/MM/dd HH:mm"))} {(row["DOP_TIME_NA"].ToString() == "0" ? "口述" : "")}";
            contents.Add(field);

            field = "";
            switch (row["DOP"].ToString())
            {
                case "0":
                    field = "稀氏";
                    break;
                case "1":
                    field = "鄧氏";
                    break;
                case "2":
                    field = "混合剝離";
                    break;
                case "3":
                    field = "人工剝離";
                    break;
                default:
                    field = "";
                    break;
            }
            contents.Add(field);

            if (row["DR_LVTIME_NA"].ToString() == "1")
                field = $"離開分娩室時間：不詳";
            else
                field = $"離開分娩室時間：{(row["DR_LVTIME"].ToString() == "" ? "" : Convert.ToDateTime(row["DR_LVTIME"].ToString()).ToString("yyyy/MM/dd HH:mm"))} {(row["DR_LVTIME_NA"].ToString() == "0" ? "口述" : "")}";
            contents.Add(field);

            erow += base.Upd_CareRecord(Convert.ToDateTime(row["BIRTH"].ToString()).ToString("yyyy/MM/dd HH:mm:ss"), dtBth.Rows[0]["IID"].ToString(), title, String.Join("，", contents) + "。", "", "", "", "", "OBS_BTHSTA");

            #endregion

            if (erow > 0)
                Response.Write("<script>alert('修改成功');window.location.href='Index?active=Partial_Child_Brith'</script>");
            else
                Response.Write("<script>alert('修改失敗');window.location.href='Index?active=Partial_Child_Brith'</script>");

            return new EmptyResult();
        }
        #endregion

        #region 編輯新生兒出生紀錄
        /// <summary>
        /// 編輯新生兒出生紀錄
        /// </summary>
        /// <param name="form"></param>
        /// <returns></returns>
        [HttpPost]
        public ActionResult Upd_Partial_Child_Brith_All(FormCollection form)
        {
            link.DBOpen();
            RESPONSE_MSG json_result = new RESPONSE_MSG();
            List<string> id_list = new List<string>();

            string action_type = form["action_type"].ToString();
            string child_seq = form["child_seq"].ToString();
            if (IsNoEmpty(child_seq))
            {
                id_list.Add(child_seq);
            }
            else
            {
                id_list = form["I"].Split(',').ToList();
            }

            var UnAuthorize = false;
            string tableid = string.Empty; //簽章用 此處以存檔僅會單筆為基礎  多筆則不適用需改寫法
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo?.FeeNo;
            int erow = 0;
            List<DBItem> insertDataList = new List<DBItem>();
            DateTime now_datetime = DateTime.Now;
            foreach (var i in id_list)
            {
                tableid = form["IID" + i].ToString();

                DataTable dt_nb = obs_m.sel_nb("", "", tableid);
                if (dt_nb != null && dt_nb.Rows.Count > 0)
                {
                    var r = dt_nb.Rows[0];
                    if (r["EMR_SIGN"].ToString() != "" && r["EMR_TIME"].ToString() != "")
                    {
                        if (r["CREATNO_2"].ToString() != userinfo.EmployeesNo && r["DIRECTOR"].ToString() != userinfo.EmployeesNo && r["EMR_SIGN"].ToString() != userinfo.EmployeesNo)
                        {
                            json_result.status = RESPONSE_STATUS.ERROR;
                            json_result.message = "無權限修改!";
                            return Content(JsonConvert.SerializeObject(json_result), "application/json");
                        }
                    }
                }

                if (action_type == "emr")
                {
                    UnAuthorize = (userinfo.EmployeesNo == form["TXT_CREATNO_2" + i]) ? false : true;
                    if (UnAuthorize)
                    {
                        json_result.status = RESPONSE_STATUS.ERROR;
                        json_result.message = "無權限送簽";

                        return Content(JsonConvert.SerializeObject(json_result), "application/json");
                    }
                }
                insertDataList = new List<DBItem>();
                insertDataList.Add(new DBItem("CREATNO", form["TXT_CREATNO" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("UPDNO", userno, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("UPDTIME", now_datetime.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime));
                insertDataList.Add(new DBItem("RECORDTIME", now_datetime.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間

                var BIRTH_TYPE = form["RB_BIRTH_TYPE" + i];
                insertDataList.Add(new DBItem("BIRTH_TYPE", BIRTH_TYPE, DBItem.DBDataType.String));
                if (BIRTH_TYPE == "0")
                {
                    insertDataList.Add(new DBItem("VACUUM_NSD", form["RB_VACUUM_NSD" + i], DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("VACUUM_CS", null, DBItem.DBDataType.String));
                }
                else if (BIRTH_TYPE == "1")
                {
                    insertDataList.Add(new DBItem("VACUUM_NSD", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("VACUUM_CS", form["RB_VACUUM_CS" + i], DBItem.DBDataType.String));
                }

                insertDataList.Add(new DBItem("BIRTH_DAY", form["TXT_BIRTH_DAY_DAY" + i] + " " + form["TXT_BIRTH_DAY_TIME" + i], DBItem.DBDataType.DataTime));

                var FETAL = form["RB_FETAL" + i];
                insertDataList.Add(new DBItem("FETAL", FETAL, DBItem.DBDataType.String));
                if (FETAL == "11")
                    insertDataList.Add(new DBItem("FETAL_OTH", form["TXT_FETAL_OTH" + i], DBItem.DBDataType.String));
                else
                    insertDataList.Add(new DBItem("FETAL_OTH", null, DBItem.DBDataType.String));


                var CORD_ENTANGLEMENT = form["RB_CORD_ENTANGLEMENT" + i];
                insertDataList.Add(new DBItem("CORD_ENTANGLEMENT", CORD_ENTANGLEMENT, DBItem.DBDataType.String));
                if (CORD_ENTANGLEMENT == "1")
                {
                    insertDataList.Add(new DBItem("CORD_ENTANGLEMENT_NECK", form["TXT_CORD_ENTANGLEMENT_NECK" + i], DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("CORD_ENTANGLEMENT_HAND", form["TXT_CORD_ENTANGLEMENT_HAND" + i], DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("CORD_ENTANGLEMENT_FOOT", form["TXT_CORD_ENTANGLEMENT_FOOT" + i], DBItem.DBDataType.String));
                }
                else if (CORD_ENTANGLEMENT == "0")
                {
                    insertDataList.Add(new DBItem("CORD_ENTANGLEMENT_NECK", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("CORD_ENTANGLEMENT_HAND", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("CORD_ENTANGLEMENT_FOOT", null, DBItem.DBDataType.String));
                }

                var SKIN_CONTACT = form["RB_SKIN_CONTACT" + i];
                insertDataList.Add(new DBItem("SKIN_CONTACT", SKIN_CONTACT, DBItem.DBDataType.String));

                //母嬰皮膚接觸 無
                if (SKIN_CONTACT == "0")
                {
                    var SKIN_CONTACT_RS = form["CK_SKIN_CONTACT_RS" + i];
                    var SKIN_CONTACT_RSV = new List<string>() { "0", "0" };
                    if (SKIN_CONTACT_RS == null)
                        insertDataList.Add(new DBItem("SKIN_CONTACT_RS", String.Join("", SKIN_CONTACT_RSV), DBItem.DBDataType.String));
                    else
                    {
                        var SKIN_CONTACT_RS_SP = SKIN_CONTACT_RS.Split(',');
                        foreach (var v in SKIN_CONTACT_RS_SP)
                            SKIN_CONTACT_RSV[Convert.ToInt32(v)] = "1";
                        insertDataList.Add(new DBItem("SKIN_CONTACT_RS", String.Join("", SKIN_CONTACT_RSV), DBItem.DBDataType.String));
                    }

                    // 無母嬰皮膚接觸-產婦原因
                    if (SKIN_CONTACT_RSV[0] == "1")
                    {
                        var CONTACT_N_MOM = form["CK_CONTACT_N_MOM" + i];
                        var CONTACT_N_MOMV = new List<string>() { "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0" };
                        if (CONTACT_N_MOM == null)
                            insertDataList.Add(new DBItem("CONTACT_N_MOM", String.Join("", CONTACT_N_MOMV), DBItem.DBDataType.String));
                        else
                        {
                            var CONTACT_N_MOM_SP = CONTACT_N_MOM.Split(',');
                            foreach (var v in CONTACT_N_MOM_SP)
                                CONTACT_N_MOMV[Convert.ToInt32(v)] = "1";
                            insertDataList.Add(new DBItem("CONTACT_N_MOM", String.Join("", CONTACT_N_MOMV), DBItem.DBDataType.String));
                        }
                        if (CONTACT_N_MOMV[7] == "1")
                        {
                            insertDataList.Add(new DBItem("CONTACT_N_MOM_ID", form["RB_CONTACT_N_MOM_ID" + i], DBItem.DBDataType.String));
                        }
                        if (CONTACT_N_MOMV[9] == "1")
                            insertDataList.Add(new DBItem("CONTACT_N_MOM_OTH", form["TXT_CONTACT_N_MOM_OTH" + i], DBItem.DBDataType.String));
                    }
                    else if (SKIN_CONTACT_RSV[0] == "0")
                    {
                        insertDataList.Add(new DBItem("CONTACT_N_MOM", null, DBItem.DBDataType.String));
                        insertDataList.Add(new DBItem("CONTACT_N_MOM_ID", null, DBItem.DBDataType.String));
                        insertDataList.Add(new DBItem("CONTACT_N_MOM_OTH", null, DBItem.DBDataType.String));
                    }
                    // 無母嬰皮膚接觸-新生兒原因
                    if (SKIN_CONTACT_RSV[1] == "1")
                    {
                        var CONTACT_N_NB = form["CK_CONTACT_N_NB" + i];
                        var CONTACT_N_NBV = new List<string>() { "0", "0", "0", "0", "0" };
                        if (CONTACT_N_NB == null)
                            insertDataList.Add(new DBItem("CONTACT_N_NB", String.Join("", CONTACT_N_NBV), DBItem.DBDataType.String));
                        else
                        {
                            var CONTACT_N_NB_SP = CONTACT_N_NB.Split(',');
                            foreach (var r in CONTACT_N_NB_SP)
                                CONTACT_N_NBV[Convert.ToInt32(r)] = "1";
                            insertDataList.Add(new DBItem("CONTACT_N_NB", String.Join("", CONTACT_N_NBV), DBItem.DBDataType.String));
                        }
                        if (CONTACT_N_NBV[3] == "1")
                            insertDataList.Add(new DBItem("CONTACT_N_NB_OTH", form["TXT_CONTACT_N_NB_OTH" + i], DBItem.DBDataType.String));
                    }
                    else if (SKIN_CONTACT_RSV[1] == "0")
                    {
                        insertDataList.Add(new DBItem("CONTACT_N_NB", null, DBItem.DBDataType.String));
                        insertDataList.Add(new DBItem("CONTACT_N_NB_OTH", null, DBItem.DBDataType.String));
                    }

                    insertDataList.Add(new DBItem("CONTACT_START_DAY", null, DBItem.DBDataType.DataTime));
                    insertDataList.Add(new DBItem("CONTACT_END_DAY", null, DBItem.DBDataType.DataTime));
                    insertDataList.Add(new DBItem("CONTACT_E_RS", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("CONTACT_E_MOM", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("CONTACT_E_MOM_OTH", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("CONTACT_E_NB", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("CONTACT_E_NB_OTH", null, DBItem.DBDataType.String));
                }
                //母嬰皮膚接觸 有
                else if (SKIN_CONTACT == "1")
                {
                    //接觸時間
                    if (form["TXT_CONTACT_START_DAY_DAY" + i] != "" && form["TXT_CONTACT_START_DAY_DAY" + i] != null && form["TXT_CONTACT_START_DAY_TIME" + i] != "" && form["TXT_CONTACT_START_DAY_TIME" + i] != null)
                        insertDataList.Add(new DBItem("CONTACT_START_DAY", form["TXT_CONTACT_START_DAY_DAY" + i] + " " + form["TXT_CONTACT_START_DAY_TIME" + i], DBItem.DBDataType.DataTime));
                    if (form["TXT_CONTACT_END_DAY_DAY" + i] != "" && form["TXT_CONTACT_END_DAY_DAY" + i] != null && form["TXT_CONTACT_END_DAY_TIME" + i] != "" && form["TXT_CONTACT_END_DAY_TIME" + i] != null)
                        insertDataList.Add(new DBItem("CONTACT_END_DAY", form["TXT_CONTACT_END_DAY_DAY" + i] + " " + form["TXT_CONTACT_END_DAY_TIME" + i], DBItem.DBDataType.DataTime));

                    var CONTACT_E_RS = form["CK_CONTACT_E_RS" + i];
                    var CONTACT_E_RSV = new List<string>() { "0", "0" };
                    if (CONTACT_E_RS == null)
                        insertDataList.Add(new DBItem("CONTACT_E_RS", String.Join("", CONTACT_E_RSV), DBItem.DBDataType.String));
                    else
                    {
                        var CONTACT_E_RS_SP = CONTACT_E_RS.Split(',');
                        foreach (var r in CONTACT_E_RS_SP)
                            CONTACT_E_RSV[Convert.ToInt32(r)] = "1";
                        insertDataList.Add(new DBItem("CONTACT_E_RS", String.Join("", CONTACT_E_RSV), DBItem.DBDataType.String));
                    }

                    // 有母嬰皮膚接觸-產婦原因
                    if (CONTACT_E_RSV[0] == "1")
                    {
                        var CONTACT_E_MOM = form["CK_CONTACT_E_MOM" + i];
                        var CONTACT_E_MOMV = new List<string>() { "0", "0", "0", "0", "0", "0", "0", "0", "0" };
                        if (CONTACT_E_MOM == null)
                            insertDataList.Add(new DBItem("CONTACT_E_MOM", String.Join("", CONTACT_E_MOMV), DBItem.DBDataType.String));
                        else
                        {
                            var CONTACT_E_MOM_SP = CONTACT_E_MOM.Split(',');
                            foreach (var r in CONTACT_E_MOM_SP)
                                CONTACT_E_MOMV[Convert.ToInt32(r)] = "1";
                            insertDataList.Add(new DBItem("CONTACT_E_MOM", String.Join("", CONTACT_E_MOMV), DBItem.DBDataType.String));
                        }

                        if (CONTACT_E_MOMV[7] == "1")
                            insertDataList.Add(new DBItem("CONTACT_E_MOM_OTH", form["TXT_CONTACT_E_MOM_OTH" + i], DBItem.DBDataType.String));
                    }
                    else if (CONTACT_E_RSV[0] == "0")
                    {
                        insertDataList.Add(new DBItem("CONTACT_E_MOM", null, DBItem.DBDataType.String));
                        insertDataList.Add(new DBItem("CONTACT_E_MOM_OTH", null, DBItem.DBDataType.String));
                    }
                    // 有母嬰皮膚接觸-新生兒原因
                    if (CONTACT_E_RSV[1] == "1")
                    {
                        var CONTACT_E_NB = form["CK_CONTACT_E_NB" + i];
                        var CONTACT_E_NBV = new List<string>() { "0", "0", "0", "0", "0" };
                        if (CONTACT_E_NB == null)
                            insertDataList.Add(new DBItem("CONTACT_E_NB", String.Join("", CONTACT_E_NBV), DBItem.DBDataType.String));
                        else
                        {
                            var CONTACT_E_NB_SP = CONTACT_E_NB.Split(',');
                            foreach (var r in CONTACT_E_NB_SP)
                                CONTACT_E_NBV[Convert.ToInt32(r)] = "1";
                            insertDataList.Add(new DBItem("CONTACT_E_NB", String.Join("", CONTACT_E_NBV), DBItem.DBDataType.String));
                        }
                        if (CONTACT_E_NBV[3] == "1")
                            insertDataList.Add(new DBItem("CONTACT_E_NB_OTH", form["TXT_CONTACT_E_NB_OTH" + i], DBItem.DBDataType.String));
                    }
                    else if (CONTACT_E_RSV[1] == "0")
                    {
                        insertDataList.Add(new DBItem("CONTACT_E_NB", null, DBItem.DBDataType.String));
                        insertDataList.Add(new DBItem("CONTACT_E_NB_OTH", null, DBItem.DBDataType.String));
                    }

                    insertDataList.Add(new DBItem("SKIN_CONTACT_RS", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("CONTACT_N_MOM", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("CONTACT_N_MOM_ID", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("CONTACT_N_MOM_OTH", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("CONTACT_N_NB", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("CONTACT_N_NB_OTH", null, DBItem.DBDataType.String));
                }

                insertDataList.Add(new DBItem("MECONIUM_COLOR", form["RB_MECONIUM_COLOR" + i], DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("RB_AS_1_1", form["RB_RB_AS_1_1" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("RB_AS_1_2", form["RB_RB_AS_1_2" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("RB_AS_1_3", form["RB_RB_AS_1_3" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("RB_AS_1_4", form["RB_RB_AS_1_4" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("RB_AS_1_5", form["RB_RB_AS_1_5" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("RB_AS_1_NUM", form["TXT_RB_AS_1_NUM" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("RB_AS_1_WHO", form["TXT_RB_AS_1_WHO" + i], DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("RB_AS_5_1", form["RB_RB_AS_5_1" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("RB_AS_5_2", form["RB_RB_AS_5_2" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("RB_AS_5_3", form["RB_RB_AS_5_3" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("RB_AS_5_4", form["RB_RB_AS_5_4" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("RB_AS_5_5", form["RB_RB_AS_5_5" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("RB_AS_5_NUM", form["TXT_RB_AS_5_NUM" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("RB_AS_5_WHO", form["TXT_RB_AS_5_WHO" + i], DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("RB_AS_10_1", form["RB_RB_AS_10_1" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("RB_AS_10_2", form["RB_RB_AS_10_2" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("RB_AS_10_3", form["RB_RB_AS_10_3" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("RB_AS_10_4", form["RB_RB_AS_10_4" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("RB_AS_10_5", form["RB_RB_AS_10_5" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("RB_AS_10_NUM", form["TXT_RB_AS_10_NUM" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("RB_AS_10_WHO", form["TXT_RB_AS_10_WHO" + i], DBItem.DBDataType.String));

                //接觸時間
                if (form["TXT_RB_AS_OTH_T_DAY" + i] != "" && form["TXT_RB_AS_OTH_T_DAY" + i] != null && form["TXT_RB_AS_OTH_T_TIME" + i] != "" && form["TXT_RB_AS_OTH_T_TIME" + i] != null)
                    insertDataList.Add(new DBItem("RB_AS_OTH_T", form["TXT_RB_AS_OTH_T_DAY" + i] + " " + form["TXT_RB_AS_OTH_T_TIME" + i], DBItem.DBDataType.DataTime));

                insertDataList.Add(new DBItem("RB_AS_OTH_1", form["RB_RB_AS_OTH_1" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("RB_AS_OTH_2", form["RB_RB_AS_OTH_2" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("RB_AS_OTH_3", form["RB_RB_AS_OTH_3" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("RB_AS_OTH_4", form["RB_RB_AS_OTH_4" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("RB_AS_OTH_5", form["RB_RB_AS_OTH_5" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("RB_AS_OTH_NUM", form["TXT_RB_AS_OTH_NUM" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("RB_AS_OTH_WHO", form["TXT_RB_AS_OTH_WHO" + i], DBItem.DBDataType.String));

                var CHILD_SENT = form["RB_CHILD_SENT" + i];
                insertDataList.Add(new DBItem("CHILD_SENT", form["RB_CHILD_SENT" + i], DBItem.DBDataType.String));

                var CHILD_SENT_MEMO = form["TXT_CHILD_SENT_MEMO" + i].Split(',');

                if (CHILD_SENT == "1")
                    insertDataList.Add(new DBItem("CHILD_SENT_MEMO", CHILD_SENT_MEMO[0], DBItem.DBDataType.String));
                else if (CHILD_SENT == "2")
                    insertDataList.Add(new DBItem("CHILD_SENT_MEMO", CHILD_SENT_MEMO[1], DBItem.DBDataType.String));
                else
                    insertDataList.Add(new DBItem("CHILD_SENT_MEMO", null, DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("MECONIUM", form["RB_MECONIUM" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("URINE", form["RB_URINE" + i], DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("HEIGHT", form["TXT_HEIGHT" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("WEIGHT", form["TXT_WEIGHT" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("HEAD", form["TXT_HEAD" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("CHEST", form["TXT_CHEST" + i], DBItem.DBDataType.String));

                #region 四肢
                // 外觀(四肢)-足內翻
                var CLUBFOOT = form["RB_CLUBFOOT" + i];
                insertDataList.Add(new DBItem("CLUBFOOT", CLUBFOOT, DBItem.DBDataType.String));
                if (CLUBFOOT == "1")
                {
                    var CLUBFOOT_LR = form["CK_CLUBFOOT_LR" + i];
                    var CLUBFOOT_LRV = new List<string>() { "0", "0" };
                    if (CLUBFOOT_LR == null)
                        insertDataList.Add(new DBItem("CLUBFOOT_LR", String.Join("", CLUBFOOT_LRV), DBItem.DBDataType.String));
                    else
                    {
                        var CLUBFOOT_LR_SP = CLUBFOOT_LR.Split(',');
                        //20200319
                        //foreach (var r in CLUBFOOT_LR_SP)
                        //    CLUBFOOT_LRV[Convert.ToInt32(i)] = "1";
                        foreach (var r in CLUBFOOT_LR_SP)
                            CLUBFOOT_LRV[Convert.ToInt32(r)] = "1";
                        insertDataList.Add(new DBItem("CLUBFOOT_LR", String.Join("", CLUBFOOT_LRV), DBItem.DBDataType.String));
                    }
                }
                else if (CLUBFOOT == "0")
                {
                    insertDataList.Add(new DBItem("CLUBFOOT_LR", null, DBItem.DBDataType.String));
                }
                // 外觀(四肢) - 足外翻
                var VALGUS = form["RB_VALGUS" + i];
                insertDataList.Add(new DBItem("VALGUS", VALGUS, DBItem.DBDataType.String));
                if (VALGUS == "1")
                {
                    var VALGUS_LR = form["CK_VALGUS_LR" + i];
                    var VALGUS_LRV = new List<string>() { "0", "0" };
                    if (VALGUS_LR == null)
                        insertDataList.Add(new DBItem("VALGUS_LR", String.Join("", VALGUS_LRV), DBItem.DBDataType.String));
                    else
                    {
                        var VALGUS_LR_SP = VALGUS_LR.Split(',');
                        foreach (var r in VALGUS_LR_SP)
                            VALGUS_LRV[Convert.ToInt32(r)] = "1";
                        insertDataList.Add(new DBItem("VALGUS_LR", String.Join("", VALGUS_LRV), DBItem.DBDataType.String));
                    }
                }
                else if (VALGUS == "0")
                {
                    insertDataList.Add(new DBItem("VALGUS_LR", null, DBItem.DBDataType.String));
                }

                //外觀(四肢)-斷掌
                var STPC = form["RB_STPC" + i];
                insertDataList.Add(new DBItem("STPC", STPC, DBItem.DBDataType.String));
                if (STPC == "1")
                {
                    var STPC_LR = form["CK_STPC_LR" + i];
                    var STPC_LRV = new List<string>() { "0", "0" };
                    if (STPC_LR == null)
                        insertDataList.Add(new DBItem("STPC_LR", String.Join("", STPC_LRV), DBItem.DBDataType.String));
                    else
                    {
                        var STPC_LR_SP = STPC_LR.Split(',');
                        foreach (var r in STPC_LR_SP)
                            STPC_LRV[Convert.ToInt32(r)] = "1";
                        insertDataList.Add(new DBItem("STPC_LR", String.Join("", STPC_LRV), DBItem.DBDataType.String));
                    }
                }
                else if (STPC == "0")
                {
                    insertDataList.Add(new DBItem("STPC_LR", null, DBItem.DBDataType.String));
                }

                // 外觀(四肢)-手指
                var FINGERS = form["RB_FINGERS" + i];
                insertDataList.Add(new DBItem("FINGERS", FINGERS, DBItem.DBDataType.String));
                if (FINGERS == "1")
                {
                    var FINGERS_UN = form["CK_FINGERS_UN" + i];
                    var FINGERS_UNV = new List<string>() { "0", "0", "0", "0", "0", "0", "0", "0" };
                    if (FINGERS_UNV == null)
                        insertDataList.Add(new DBItem("FINGERS_UN", String.Join("", FINGERS_UNV), DBItem.DBDataType.String));
                    else
                    {
                        var FINGERS_UN_SP = FINGERS_UN.Split(',');
                        foreach (var r in FINGERS_UN_SP)
                            FINGERS_UNV[Convert.ToInt32(r)] = "1";
                        insertDataList.Add(new DBItem("FINGERS_UN", String.Join("", FINGERS_UNV), DBItem.DBDataType.String));

                        if (FINGERS_UNV[0] == "1")
                            insertDataList.Add(new DBItem("OLIGO_LH", form["TXT_OLIGO_LH" + i], DBItem.DBDataType.String));
                        else
                            insertDataList.Add(new DBItem("OLIGO_LH", null, DBItem.DBDataType.String));
                        if (FINGERS_UNV[1] == "1")
                            insertDataList.Add(new DBItem("POLY_LH", form["TXT_POLY_LH" + i], DBItem.DBDataType.String));
                        else
                            insertDataList.Add(new DBItem("POLY_LH", null, DBItem.DBDataType.String));
                        if (FINGERS_UNV[2] == "1")
                            insertDataList.Add(new DBItem("SYN_LH", form["TXT_SYN_LH" + i], DBItem.DBDataType.String));
                        else
                            insertDataList.Add(new DBItem("SYN_LH", null, DBItem.DBDataType.String));
                        if (FINGERS_UNV[3] == "1")
                            insertDataList.Add(new DBItem("WEBBING_LH", form["TXT_WEBBING_LH" + i], DBItem.DBDataType.String));
                        else
                            insertDataList.Add(new DBItem("WEBBING_LH", null, DBItem.DBDataType.String));
                        if (FINGERS_UNV[4] == "1")
                            insertDataList.Add(new DBItem("OLIGO_RH", form["TXT_OLIGO_RH" + i], DBItem.DBDataType.String));
                        else
                            insertDataList.Add(new DBItem("OLIGO_RH", null, DBItem.DBDataType.String));
                        if (FINGERS_UNV[5] == "1")
                            insertDataList.Add(new DBItem("POLY_RH", form["TXT_POLY_RH" + i], DBItem.DBDataType.String));
                        else
                            insertDataList.Add(new DBItem("POLY_RH", null, DBItem.DBDataType.String));
                        if (FINGERS_UNV[6] == "1")
                            insertDataList.Add(new DBItem("SYN_RH", form["TXT_SYN_RH" + i], DBItem.DBDataType.String));
                        else
                            insertDataList.Add(new DBItem("SYN_RH", null, DBItem.DBDataType.String));
                        if (FINGERS_UNV[7] == "1")
                            insertDataList.Add(new DBItem("WEBBING_RH", form["TXT_WEBBING_RH" + i], DBItem.DBDataType.String));
                        else
                            insertDataList.Add(new DBItem("WEBBING_RH", null, DBItem.DBDataType.String));
                    }
                }
                else if (FINGERS == "0")
                {
                    insertDataList.Add(new DBItem("FINGERS_UN", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("OLIGO_LH", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("POLY_LH", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("SYN_LH", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("WEBBING_LH", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("OLIGO_RH", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("POLY_RH", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("SYN_RH", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("WEBBING_RH", null, DBItem.DBDataType.String));
                }

                // 外觀(四肢)-腳趾
                var TOES = form["RB_TOES" + i];
                insertDataList.Add(new DBItem("TOES", TOES, DBItem.DBDataType.String));
                if (TOES == "1")
                {
                    var TOES_UN = form["CK_TOES_UN" + i];
                    var TOES_UNV = new List<string>() { "0", "0", "0", "0", "0", "0", "0", "0" };
                    if (TOES_UNV == null)
                        insertDataList.Add(new DBItem("TOES_UN", String.Join("", TOES_UNV), DBItem.DBDataType.String));
                    else
                    {
                        var TOES_UN_SP = TOES_UN.Split(',');
                        foreach (var r in TOES_UN_SP)
                            TOES_UNV[Convert.ToInt32(r)] = "1";
                        insertDataList.Add(new DBItem("TOES_UN", String.Join("", TOES_UNV), DBItem.DBDataType.String));

                        if (TOES_UNV[0] == "1")
                            insertDataList.Add(new DBItem("OLIGO_LT", form["TXT_OLIGO_LT" + i], DBItem.DBDataType.String));
                        else
                            insertDataList.Add(new DBItem("OLIGO_LT", null, DBItem.DBDataType.String));
                        if (TOES_UNV[1] == "1")
                            insertDataList.Add(new DBItem("POLY_LT", form["TXT_POLY_LT" + i], DBItem.DBDataType.String));
                        else
                            insertDataList.Add(new DBItem("POLY_LT", null, DBItem.DBDataType.String));

                        if (TOES_UNV[2] == "1")
                            insertDataList.Add(new DBItem("SYN_LT", form["TXT_SYN_LT" + i], DBItem.DBDataType.String));
                        else
                            insertDataList.Add(new DBItem("SYN_LT", null, DBItem.DBDataType.String));

                        if (TOES_UNV[3] == "1")
                            insertDataList.Add(new DBItem("OLIGO_RT", form["TXT_OLIGO_RT" + i], DBItem.DBDataType.String));
                        else
                            insertDataList.Add(new DBItem("OLIGO_RT", null, DBItem.DBDataType.String));

                        if (TOES_UNV[4] == "1")
                            insertDataList.Add(new DBItem("POLY_RT", form["TXT_POLY_RT" + i], DBItem.DBDataType.String));
                        else
                            insertDataList.Add(new DBItem("POLY_RT", null, DBItem.DBDataType.String));

                        if (TOES_UNV[5] == "1")
                            insertDataList.Add(new DBItem("SYN_RT", form["TXT_SYN_RT" + i], DBItem.DBDataType.String));
                        else
                            insertDataList.Add(new DBItem("SYN_RT", null, DBItem.DBDataType.String));
                    }
                }
                else if (TOES == "0")
                {
                    insertDataList.Add(new DBItem("TOES_UN", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("OLIGO_LT", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("POLY_LT", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("SYN_LT", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("WEBBING_LT", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("OLIGO_RT", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("POLY_RT", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("SYN_RT", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("WEBBING_RT", null, DBItem.DBDataType.String));
                }

                // 外觀(胎記)
                var BIRTHMARK = form["RB_BIRTHMARK" + i];
                insertDataList.Add(new DBItem("BIRTHMARK", BIRTHMARK, DBItem.DBDataType.String));
                if (BIRTHMARK == "1")
                {
                    var BM_SHAPE = form["CK_BM_SHAPE" + i];
                    var BM_SHAPEV = new List<string>() { "0", "0", "0", "0" };
                    if (BM_SHAPEV == null)
                        insertDataList.Add(new DBItem("BM_SHAPE", String.Join("", BM_SHAPEV), DBItem.DBDataType.String));
                    else
                    {
                        var BM_SHAPE_SP = BM_SHAPE.Split(',');
                        foreach (var r in BM_SHAPE_SP)
                            BM_SHAPEV[Convert.ToInt32(r)] = "1";
                        insertDataList.Add(new DBItem("BM_SHAPE", String.Join("", BM_SHAPEV), DBItem.DBDataType.String));

                        if (BM_SHAPEV[0] == "1")
                            insertDataList.Add(new DBItem("BM_MONG", form["TXT_BM_MONG" + i], DBItem.DBDataType.String));
                        else
                            insertDataList.Add(new DBItem("BM_MONG", null, DBItem.DBDataType.String));

                        if (BM_SHAPEV[1] == "1")
                            insertDataList.Add(new DBItem("BM_PS", form["TXT_BM_PS" + i], DBItem.DBDataType.String));
                        else
                            insertDataList.Add(new DBItem("BM_PS", null, DBItem.DBDataType.String));

                        if (BM_SHAPEV[2] == "1")
                            insertDataList.Add(new DBItem("BM_PPV", form["TXT_BM_PPV" + i], DBItem.DBDataType.String));
                        else
                            insertDataList.Add(new DBItem("BM_PPV", null, DBItem.DBDataType.String));

                        if (BM_SHAPEV[3] == "1")
                            insertDataList.Add(new DBItem("BM_OTH", form["TXT_BM_OTH" + i], DBItem.DBDataType.String));
                        else
                            insertDataList.Add(new DBItem("BM_OTH", null, DBItem.DBDataType.String));

                    }
                }
                else if (BIRTHMARK == "0")
                {
                    insertDataList.Add(new DBItem("BM_SHAPE", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("BM_MONG", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("BM_PS", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("BM_PPV", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("BM_OTH", null, DBItem.DBDataType.String));
                }

                insertDataList.Add(new DBItem("EXTERIOR_OTHER", form["TXT_EXTERIOR_OTHER" + i], DBItem.DBDataType.String));
                #endregion

                //膚色發紺
                insertDataList.Add(new DBItem("CYANOSIS", form["RB_CYANOSIS" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("OXYGEN", form["RB_OXYGEN" + i], DBItem.DBDataType.String));

                var NAS_SUC = form["RB_NAS_SUC" + i];
                insertDataList.Add(new DBItem("NAS_SUC", NAS_SUC, DBItem.DBDataType.String));
                if (NAS_SUC == "1")
                {
                    insertDataList.Add(new DBItem("NAS_SUC_AMT", form["RB_NAS_SUC_AMT" + i], DBItem.DBDataType.String));
                    var NAS_SUC_COL = form["RB_NAS_SUC_COL" + i];
                    insertDataList.Add(new DBItem("NAS_SUC_COL", NAS_SUC_COL, DBItem.DBDataType.String));
                    if (NAS_SUC_COL == "3")
                        insertDataList.Add(new DBItem("NAS_SUC_COL_OTH", form["TXT_NAS_SUC_COL_OTH" + i], DBItem.DBDataType.String));
                    if (NAS_SUC_COL != "3")
                        insertDataList.Add(new DBItem("NAS_SUC_COL_OTH", null, DBItem.DBDataType.String));

                    insertDataList.Add(new DBItem("NAS_SUC_STA", form["RB_NAS_SUC_STA" + i], DBItem.DBDataType.String));
                }
                else if (NAS_SUC == "0")
                {
                    insertDataList.Add(new DBItem("NAS_SUC_AMT", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("NAS_SUC_COL", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("NAS_SUC_STA", null, DBItem.DBDataType.String));
                }

                insertDataList.Add(new DBItem("ET_CARE_RECORD", form["CK_ET_CARE_RECORD" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("CREATNO_2", form["TXT_CREATNO_2" + i], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("DIRECTOR", form["TXT_DIRECTOR" + i], DBItem.DBDataType.String));

                DataTable dt = obs_m.sel_nb("", "", form["IID" + i]);

                string where = " IID = '" + form["IID" + i] + "' ";
                insertDataList = setNullToEmpty(insertDataList);
                erow += link.DBExecUpdateTns("OBS_NB", insertDataList, where);

                #region 出生紀錄護理紀錄
                var mom_feeno = ptinfo.FeeNo;
                var seq = '0';
                if (ptinfo.Age < 1)
                {
                    DataTable babylink = obs_m.sel_nbcha("", ptinfo.ChartNo.PadLeft(10, '0'));
                    if (babylink != null && babylink.Rows.Count > 0)
                    {
                        mom_feeno = babylink.Rows[0]["MOM_FEE_NO"].ToString();
                        seq = Convert.ToChar(babylink.Rows[0]["BABY_SEQ"].ToString());
                    }
                }
                DataRow bthstaRow = null;
                DataTable stadt = obs_m.sel_bthsta(mom_feeno);
                if (stadt != null)
                    bthstaRow = stadt.Rows[0];

                var content = $"出生時間：{form["TXT_BIRTH_DAY_DAY" + i] + " " + form["TXT_BIRTH_DAY_TIME" + i]}。";
                content += $"性別：{form["GENDER" + i]}。生產方式：{(form["RB_BIRTH_TYPE" + i] == "0" ? "陰道產" : "剖腹產")}。";
                content += $"妊娠週數：{bthstaRow["GEST_M"].ToString()}+{bthstaRow["GEST_D"].ToString()}週。";
                content += $"身高：{(form["TXT_HEIGHT" + i] == "" ? "0" : form["TXT_HEIGHT" + i])}公分。體重：{(form["TXT_WEIGHT" + i] == "" ? "0" : form["TXT_WEIGHT" + i])}公克。";
                content += $"頭圍：{(form["TXT_HEAD" + i] == "" ? "0" : form["TXT_HEAD" + i])}公分。胸圍：{(form["TXT_CHEST" + i] == "" ? "0" : form["TXT_CHEST" + i])}公分。";

                var apgar = new List<string>();

                if (IsNoEmpty(form["RB_RB_AS_1_1" + i]) || IsNoEmpty(form["RB_RB_AS_1_2" + i]) || IsNoEmpty(form["RB_RB_AS_1_3" + i])
                              || IsNoEmpty(form["RB_RB_AS_1_4" + i]) || IsNoEmpty(form["RB_RB_AS_1_5" + i]))
                {
                    apgar.Add($"第一分鐘：{(form["TXT_RB_AS_1_NUM" + i].ToString() == "" ? "0" : form["TXT_RB_AS_1_NUM" + i])}分");
                }

                if (IsNoEmpty(form["RB_RB_AS_5_1" + i]) || IsNoEmpty(form["RB_RB_AS_5_2" + i]) || IsNoEmpty(form["RB_RB_AS_5_3" + i])
                               || IsNoEmpty(form["RB_RB_AS_5_4" + i]) || IsNoEmpty(form["RB_RB_AS_5_5" + i]))
                {
                    apgar.Add($"第五分鐘：{(form["TXT_RB_AS_5_NUM" + i].ToString() == "" ? "0" : form["TXT_RB_AS_5_NUM" + i])}分");
                }

                if (IsNoEmpty(form["RB_RB_AS_10_1" + i]) || IsNoEmpty(form["RB_RB_AS_10_2" + i]) || IsNoEmpty(form["RB_RB_AS_10_3" + i])
                                             || IsNoEmpty(form["RB_RB_AS_10_4" + i]) || IsNoEmpty(form["RB_RB_AS_10_5" + i]))
                {
                    apgar.Add($"第十分鐘：{(form["TXT_RB_AS_10_NUM" + i].ToString() == "" ? "0" : form["TXT_RB_AS_10_NUM" + i])}分");
                }
                if (apgar.Count() > 0)
                    content += $"Apgar Score：{String.Join("、", apgar)}";


                //小孩多急救處置
                if (ptinfo.Age < 1)
                {
                    DataTable child_emrdt = obs_m.sel_nb_emr(ptinfo.FeeNo, "", (Convert.ToInt32(seq) - 64).ToString());
                    if (child_emrdt != null && child_emrdt.Rows.Count > 0)
                    {
                        foreach (DataRow r in child_emrdt.Rows)
                        {
                            content += r["ET"].ToString() + "。";
                        }
                    }
                }

                erow += base.Upd_CareRecord(form["TXT_BIRTH_DAY_DAY" + i] + " " + form["TXT_BIRTH_DAY_TIME" + i], form["IID" + i], $"新生兒出生紀錄-{(ptinfo.Age < 1 ? "小孩" : "母親")}", content, "", "", "", "", "OBS_NB");
                #endregion

                #region 皮膚接觸
                if (dt != null && dt.Rows.Count > 0)
                {
                    var momfeeno = "";
                    var NBFeeno = "";
                    var momInfo = new PatientInfo();
                    var data = dt.Rows[0];
                    if (form["RB_SKIN_CONTACT" + i] == "1")
                    {
                        //新增開始皮膚接觸
                        List<DBItem> insertDataList_1 = new List<DBItem>();
                        insertDataList_1.Add(new DBItem("RECORDTIME", now_datetime.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間
                        if (ptinfo.Age >= 1)
                        {
                            insertDataList_1.Add(new DBItem("PAT_FEENO", ptinfo?.ChartNo.PadLeft(10, '0'), DBItem.DBDataType.String));
                            DataTable dtnbcha = obs_m.sel_nbcha("", "", ptinfo.FeeNo, Convert.ToChar(Convert.ToInt32(i) + 65).ToString());
                            if (dtnbcha != null && dtnbcha.Rows.Count > 0)
                            {
                                momfeeno = dtnbcha.Rows[0]["MOM_FEE_NO"].ToString();
                                momInfo = Get_Patient_Info(momfeeno);
                                NBFeeno = dtnbcha.Rows[0]["BABY_FEE_NO"].ToString();
                            }
                        }
                        else
                        {
                            DataTable dtnbcha = obs_m.sel_nbcha("", ptinfo?.ChartNo.PadLeft(10, '0'));
                            if (dtnbcha != null && dtnbcha.Rows.Count > 0)
                            {
                                momfeeno = dtnbcha.Rows[0]["MOM_FEE_NO"].ToString();
                                momInfo = Get_Patient_Info(momfeeno);
                                NBFeeno = dtnbcha.Rows[0]["BABY_FEE_NO"].ToString();

                                insertDataList_1.Add(new DBItem("PAT_FEENO", momInfo?.ChartNo.PadLeft(10, '0'), DBItem.DBDataType.String));
                            }
                        }
                        insertDataList_1.Add(new DBItem("SEQ_OF_NB", data["NB_TEMPNO"].ToString().Substring(data["NB_TEMPNO"].ToString().Length - 1, 1), DBItem.DBDataType.String));
                        insertDataList_1.Add(new DBItem("NB_CHARTNO", data["NB_CHARTNO"].ToString(), DBItem.DBDataType.String));
                        insertDataList_1.Add(new DBItem("LOCATION", "0", DBItem.DBDataType.String));
                        var LOCATION_NAME = "產房";

                        insertDataList_1.Add(new DBItem("WHO", "0", DBItem.DBDataType.String));
                        var Obj = "母親";

                        if (form["TXT_CONTACT_START_DAY_DAY" + i] != "" && form["TXT_CONTACT_START_DAY_DAY" + i] != null && form["TXT_CONTACT_START_DAY_TIME" + i] != "" && form["TXT_CONTACT_START_DAY_TIME" + i] != null)
                            insertDataList_1.Add(new DBItem("START_TIME", form["TXT_CONTACT_START_DAY_DAY" + i] + " " + form["TXT_CONTACT_START_DAY_TIME" + i], DBItem.DBDataType.DataTime));


                        var STA_REASON_C = new List<string>();
                        var STA_REASON_NB = new List<string>();

                        if (form["TXT_CONTACT_END_DAY_DAY" + i] != "" && form["TXT_CONTACT_END_DAY_DAY" + i] != null && form["TXT_CONTACT_END_DAY_TIME" + i] != "" && form["TXT_CONTACT_END_DAY_TIME" + i] != null)
                        {
                            insertDataList_1.Add(new DBItem("END_TIME", form["TXT_CONTACT_END_DAY_DAY" + i] + " " + form["TXT_CONTACT_END_DAY_TIME" + i], DBItem.DBDataType.DataTime));

                            var CONTACT_E_RS = form["CK_CONTACT_E_RS" + i];
                            var CONTACT_E_RSV = new List<string>() { "0", "0" };
                            if (CONTACT_E_RS == null)
                                insertDataList_1.Add(new DBItem("END_RS", String.Join("", CONTACT_E_RSV), DBItem.DBDataType.String));
                            else
                            {
                                var CONTACT_E_RS_SP = CONTACT_E_RS.Split(',');
                                foreach (var r in CONTACT_E_RS_SP)
                                    CONTACT_E_RSV[Convert.ToInt32(r)] = "1";
                                insertDataList_1.Add(new DBItem("END_RS", String.Join("", CONTACT_E_RSV), DBItem.DBDataType.String));
                            }
                            //產婦
                            if (CONTACT_E_RSV[0] == "1")
                            {
                                var CONTACT_E_MOM = form["CK_CONTACT_E_MOM" + i];
                                var CONTACT_E_MOMV = new List<string>() { "0", "0", "0", "0", "0", "0", "0", "0", "0" };
                                if (CONTACT_E_MOM == null)
                                    insertDataList_1.Add(new DBItem("END_RS_CT", String.Join("", CONTACT_E_MOMV), DBItem.DBDataType.String));
                                else
                                {
                                    var CONTACT_E_MOM_SP = CONTACT_E_MOM.Split(',');
                                    foreach (var r in CONTACT_E_MOM_SP)
                                        CONTACT_E_MOMV[Convert.ToInt32(r)] = "1";
                                    insertDataList_1.Add(new DBItem("END_RS_CT", String.Join("", CONTACT_E_MOMV), DBItem.DBDataType.String));
                                }

                                if (CONTACT_E_MOMV[7] == "1")
                                    insertDataList_1.Add(new DBItem("END_RS_CT_OTH", form["TXT_CONTACT_E_MOM_OTH" + i], DBItem.DBDataType.String));

                                for (var j = 0; j < CONTACT_E_MOMV.Count; j++)
                                {
                                    if (j == 0 && CONTACT_E_MOMV[j] == "1")
                                    {
                                        STA_REASON_C.Add("生命徵象不穩定");
                                    }
                                    if (j == 1 && CONTACT_E_MOMV[j] == "1")
                                    {
                                        STA_REASON_C.Add("嘔吐");
                                    }
                                    if (j == 2 && CONTACT_E_MOMV[j] == "1")
                                    {
                                        STA_REASON_C.Add("發燒");
                                    }
                                    if (j == 3 && CONTACT_E_MOMV[j] == "1")
                                    {
                                        STA_REASON_C.Add("傷口疼痛");
                                    }
                                    if (j == 4 && CONTACT_E_MOMV[j] == "1")
                                    {
                                        STA_REASON_C.Add("有精神疾患");
                                    }
                                    if (j == 5 && CONTACT_E_MOMV[j] == "1")
                                    {
                                        STA_REASON_C.Add("拒絕");
                                    }
                                    if (j == 6 && CONTACT_E_MOMV[j] == "1")
                                    {
                                        STA_REASON_C.Add("疲憊");
                                    }
                                    if (j == 7 && CONTACT_E_MOMV[j] == "1")
                                    {
                                        var d = "其他";
                                        if (form["TXT_CONTACT_E_MOM_OTH" + i] != "")
                                        {
                                            d += $"-{form["TXT_CONTACT_E_MOM_OTH" + i]}";
                                        }
                                        STA_REASON_C.Add(d);
                                    }
                                    if (j == 8 && CONTACT_E_MOMV[j] == "1")
                                    {
                                        STA_REASON_C.Add("返病房");
                                    }
                                }
                            }
                            if (CONTACT_E_RSV[1] == "1")
                            {
                                var CONTACT_E_NB = form["CK_CONTACT_E_NB" + i];
                                var CONTACT_E_NBV = new List<string>() { "0", "0", "0", "0", "0" };
                                if (CONTACT_E_NB == null)
                                    insertDataList_1.Add(new DBItem("END_RS_NB", String.Join("", CONTACT_E_NBV), DBItem.DBDataType.String));
                                else
                                {
                                    var CONTACT_E_NB_SP = CONTACT_E_NB.Split(',');
                                    foreach (var r in CONTACT_E_NB_SP)
                                        CONTACT_E_NBV[Convert.ToInt32(r)] = "1";
                                    insertDataList_1.Add(new DBItem("END_RS_NB", String.Join("", CONTACT_E_NBV), DBItem.DBDataType.String));
                                }
                                if (CONTACT_E_NBV[3] == "1")
                                    insertDataList_1.Add(new DBItem("END_RS_NB_OTH", form["TXT_CONTACT_E_NB_OTH" + i], DBItem.DBDataType.String));

                                for (var j = 0; j < CONTACT_E_NBV.Count; j++)
                                {
                                    if (j == 0 && CONTACT_E_NBV[j] == "1")
                                    {
                                        STA_REASON_NB.Add("生命徵象不穩定");
                                    }
                                    if (j == 1 && CONTACT_E_NBV[j] == "1")
                                    {
                                        STA_REASON_NB.Add("早產");
                                    }
                                    if (j == 2 && CONTACT_E_NBV[j] == "1")
                                    {
                                        STA_REASON_NB.Add("低血糖");
                                    }
                                    if (j == 3 && CONTACT_E_NBV[j] == "1")
                                    {
                                        var d = "其他";
                                        if (form["TXT_CONTACT_E_NB_OTH" + j] != "")
                                        {
                                            d += $"-{form["TXT_CONTACT_E_NB_OTH" + j]}";
                                        }
                                        STA_REASON_NB.Add(d);
                                    }
                                    if (j == 4 && CONTACT_E_NBV[j] == "1")
                                    {
                                        STA_REASON_NB.Add("返嬰兒室");
                                    }
                                }

                            }
                        }

                        var sk_dt = obs_m.sel_sktsk("", form["IID" + i]);
                        if (sk_dt != null && sk_dt.Rows.Count > 0)
                        {
                            insertDataList_1.Add(new DBItem("UPDNO", userno, DBItem.DBDataType.String));
                            insertDataList_1.Add(new DBItem("UPDTIME", now_datetime.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime));
                            insertDataList_1 = setNullToEmpty(insertDataList_1);
                            string sk_where = " IID = '" + form["IID" + i] + "' ";
                            erow += link.DBExecUpdateTns("OBS_SKTSK", insertDataList_1, sk_where);
                        }
                        else
                        {
                            if (form["TXT_CONTACT_END_DAY_DAY" + i] != "" && form["TXT_CONTACT_END_DAY_DAY" + i] != null && form["TXT_CONTACT_END_DAY_TIME" + i] != "" && form["TXT_CONTACT_END_DAY_TIME" + i] != null)
                            {
                                insertDataList_1.Add(new DBItem("UPDNO", userno, DBItem.DBDataType.String));
                                insertDataList_1.Add(new DBItem("UPDTIME", now_datetime.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime));
                            }

                            insertDataList_1.Add(new DBItem("IID", form["IID" + i], DBItem.DBDataType.String));
                            insertDataList_1.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String));
                            insertDataList_1.Add(new DBItem("CREATNO", userno, DBItem.DBDataType.String));
                            insertDataList_1.Add(new DBItem("CREATTIME", now_datetime.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime));
                            insertDataList_1 = setNullToEmpty(insertDataList_1);
                            int result = obs_m.DBExecInsert("OBS_SKTSK", insertDataList_1);
                        }

                        if (IsNoEmpty(form["TXT_CONTACT_START_DAY_DAY" + i]) && IsNoEmpty(form["TXT_CONTACT_START_DAY_TIME" + i]))
                        {
                            var careSql = $"SELECT * FROM CARERECORD_DATA where DELETED IS NULL AND CARERECORD_ID = '{form["IID" + i] + "START"}'";
                            DataTable care = obs_m.DBExecSQL(careSql);
                            if (care != null && care.Rows.Count > 0)
                            {
                                base.Upd_CareRecord(form["TXT_CONTACT_START_DAY_DAY" + i] + " " + form["TXT_CONTACT_START_DAY_TIME" + i], form["IID" + i] + "START", "皮膚接觸-新增", $"{Obj}於{LOCATION_NAME}執行肌膚接觸。", "", "", "", "", "OBS_SKTSK");
                                if (ptinfo.Age < 1)
                                {
                                    Upd_CareRecord_ForOtherTns(momfeeno, form["TXT_CONTACT_START_DAY_DAY" + i] + " " + form["TXT_CONTACT_START_DAY_TIME" + i], form["IID" + i] + "START", "皮膚接觸-新增", $"{Obj}於{LOCATION_NAME}執行肌膚接觸。", "", "", "", "", "OBS_SKTSK", ref link);
                                }
                                else
                                {
                                    Upd_CareRecord_ForOtherTns(NBFeeno, form["TXT_CONTACT_START_DAY_DAY" + i] + " " + form["TXT_CONTACT_START_DAY_TIME" + i], form["IID" + i] + "START", "皮膚接觸-新增", $"{Obj}於{LOCATION_NAME}執行肌膚接觸。", "", "", "", "", "OBS_SKTSK", ref link);
                                }
                            }
                            else
                            {
                                base.Insert_CareRecord(form["TXT_CONTACT_START_DAY_DAY" + i] + " " + form["TXT_CONTACT_START_DAY_TIME" + i], form["IID" + i] + "START", "皮膚接觸-新增", $"{Obj}於{LOCATION_NAME}執行肌膚接觸。", "", "", "", "", "OBS_SKTSK");
                                if (ptinfo.Age < 1)
                                {
                                    Insert_CareRecord_ForOtherTns(momfeeno, form["TXT_CONTACT_START_DAY_DAY" + i] + " " + form["TXT_CONTACT_START_DAY_TIME" + i], form["IID" + i] + "START", "皮膚接觸-新增", $"{Obj}於{LOCATION_NAME}執行肌膚接觸。", "", "", "", "", "OBS_SKTSK", ref link);
                                }
                                else
                                {
                                    Insert_CareRecord_ForOtherTns(NBFeeno, form["TXT_CONTACT_START_DAY_DAY" + i] + " " + form["TXT_CONTACT_START_DAY_TIME" + i], form["IID" + i] + "START", "皮膚接觸-新增", $"{Obj}於{LOCATION_NAME}執行肌膚接觸。", "", "", "", "", "OBS_SKTSK", ref link);
                                }
                            }
                        }

                        if (IsNoEmpty(form["TXT_CONTACT_END_DAY_DAY" + i]) && IsNoEmpty(form["TXT_CONTACT_END_DAY_TIME" + i]))
                        {
                            var TotalTime = "";
                            var s_time = Convert.ToDateTime(form["TXT_CONTACT_START_DAY_DAY" + i] + " " + form["TXT_CONTACT_START_DAY_TIME" + i]);
                            var e_time = Convert.ToDateTime(form["TXT_CONTACT_END_DAY_DAY" + i] + " " + form["TXT_CONTACT_END_DAY_TIME" + i]);

                            var timediff = e_time - s_time;
                            TotalTime = $"{(timediff.Days == 0 ? "" : $"{timediff.Days}天")}{(timediff.Hours == 0 ? "" : $"{timediff.Hours}小時")}{(timediff.Minutes == 0 ? "" : $"{timediff.Minutes}分鐘")}";

                            var careSql = $"SELECT * FROM CARERECORD_DATA where DELETED IS NULL AND CARERECORD_ID = '{form["IID" + i] + "END"}'";
                            DataTable care = obs_m.DBExecSQL(careSql);
                            if (care != null && care.Rows.Count > 0)
                            {
                                base.Upd_CareRecord(form["TXT_CONTACT_END_DAY_DAY" + i] + " " + form["TXT_CONTACT_END_DAY_TIME" + i], form["IID" + i] + "END", "皮膚接觸-結束", $"{Obj}結束肌膚接觸共{TotalTime}，因{(STA_REASON_C.Count() > 0 ? $"{Obj}{String.Join(", ", STA_REASON_C) + "。"}" : $"")} {(STA_REASON_NB.Count() > 0 ? $"新生兒{String.Join(", ", STA_REASON_NB) + "。"}" : $"")}", "", "", "", "", "OBS_SKTSK");
                                if (ptinfo.Age < 1)
                                {
                                    Upd_CareRecord_ForOtherTns(momfeeno, form["TXT_CONTACT_END_DAY_DAY" + i] + " " + form["TXT_CONTACT_END_DAY_TIME" + i], form["IID" + i] + "END", "皮膚接觸-結束", $"{Obj}結束肌膚接觸共{TotalTime}，因{(STA_REASON_C.Count() > 0 ? $"{Obj}{String.Join(", ", STA_REASON_C) + "。"}" : $"")} {(STA_REASON_NB.Count() > 0 ? $"新生兒{String.Join(", ", STA_REASON_NB) + "。"}" : $"")}", "", "", "", "", "OBS_SKTSK", ref link);
                                }
                                else
                                {
                                    Upd_CareRecord_ForOtherTns(NBFeeno, form["TXT_CONTACT_END_DAY_DAY" + i] + " " + form["TXT_CONTACT_END_DAY_TIME" + i], form["IID" + i] + "END", "皮膚接觸-結束", $"{Obj}結束肌膚接觸共{TotalTime}，因{(STA_REASON_C.Count() > 0 ? $"{Obj}{String.Join(", ", STA_REASON_C) + "。"}" : $"")} {(STA_REASON_NB.Count() > 0 ? $"新生兒{String.Join(", ", STA_REASON_NB) + "。"}" : $"")}", "", "", "", "", "OBS_SKTSK", ref link);
                                }
                            }
                            else
                            {
                                base.Insert_CareRecord(form["TXT_CONTACT_END_DAY_DAY" + i] + " " + form["TXT_CONTACT_END_DAY_TIME" + i], form["IID" + i] + "END", "皮膚接觸-結束", $"{Obj}結束肌膚接觸共{TotalTime}，因{(STA_REASON_C.Count() > 0 ? $"{Obj}{String.Join(", ", STA_REASON_C) + "。"}" : $"")} {(STA_REASON_NB.Count() > 0 ? $"新生兒{String.Join(", ", STA_REASON_NB) + "。"}" : $"")}", "", "", "", "", "OBS_SKTSK");
                                if (ptinfo.Age < 1)
                                {
                                    Insert_CareRecord_ForOtherTns(momfeeno, form["TXT_CONTACT_END_DAY_DAY" + i] + " " + form["TXT_CONTACT_END_DAY_TIME" + i], form["IID" + i] + "END", "皮膚接觸-結束", $"{Obj}結束肌膚接觸共{TotalTime}，因{(STA_REASON_C.Count() > 0 ? $"{Obj}{String.Join(", ", STA_REASON_C) + "。"}" : $"")} {(STA_REASON_NB.Count() > 0 ? $"新生兒{String.Join(", ", STA_REASON_NB) + "。"}" : $"")}", "", "", "", "", "OBS_SKTSK", ref link);
                                }
                                else
                                {
                                    Insert_CareRecord_ForOtherTns(NBFeeno, form["TXT_CONTACT_END_DAY_DAY" + i] + " " + form["TXT_CONTACT_END_DAY_TIME" + i], form["IID" + i] + "END", "皮膚接觸-結束", $"{Obj}結束肌膚接觸共{TotalTime}，因{(STA_REASON_C.Count() > 0 ? $"{Obj}{String.Join(", ", STA_REASON_C) + "。"}" : $"")} {(STA_REASON_NB.Count() > 0 ? $"新生兒{String.Join(", ", STA_REASON_NB) + "。"}" : $"")}", "", "", "", "", "OBS_SKTSK", ref link);
                                }
                            }
                        }
                    }
                    else
                    {
                        Del_CareRecord(form["IID" + i] + "START", "OBS_SKTSK");
                        Del_CareRecord(form["IID" + i] + "END", "OBS_SKTSK");
                    }
                }
                #endregion
            }
            if (erow > 0)
            {
                if (action_type.ToLower() == "emr")
                {
                    DataTable dt_bthsta = new DataTable();
                    if (ptinfo.Age >= 1)
                        dt_bthsta = obs_m.sel_bthsta(ptinfo.FeeNo);
                    else
                    {
                        DataTable dt_nbcha = obs_m.sel_nbcha("", ptinfo.ChartNo);
                        if (dt_nbcha != null && dt_nbcha.Rows.Count > 0)
                        {
                            dt_bthsta = obs_m.sel_bthsta(dt_nbcha.Rows[0]["MOM_FEE_NO"].ToString());
                        }
                    }

                    if (dt_bthsta != null && dt_bthsta.Rows.Count > 0)
                    {
                        DataRow row = dt_bthsta.Rows[0];
                        if (row["PHYSICIAN_1"].ToString() == "")
                        {
                            json_result.status = RESPONSE_STATUS.ERROR;
                            json_result.message = "接生醫師為必填，請至二、三產程補填!";
                        }
                        else if (row["CLNURSE_1"].ToString() == "")
                        {
                            json_result.status = RESPONSE_STATUS.ERROR;
                            json_result.message = "流動護理師為必填，請至二、三產程補填!";
                        }
                        else if (row["SRNURSE_1"].ToString() == "")
                        {
                            json_result.status = RESPONSE_STATUS.ERROR;
                            json_result.message = "刷手護理師為必填，請至二、三產程補填!";
                        }
                        else if (row["NNP_1"].ToString() == "" && row["TOP"].ToString() == "0")
                        {
                            json_result.status = RESPONSE_STATUS.ERROR;
                            json_result.message = "新生兒護理師為必填，請至二、三產程補填!";
                        }
                        else
                        {
                            string return_jsonstr = string.Empty;
                            PdfEmr.ControllerContext = ControllerContext;
                            PdfEmr.userinfo = userinfo;
                            PdfEmr.ptinfo = ptinfo;
                            return_jsonstr = PdfEmr.GetPDF_EMR("Save", feeno, userno, "Child_Birth", tableid);
                            json_result = JsonConvert.DeserializeObject<RESPONSE_MSG>(return_jsonstr);
                            if (json_result.status == RESPONSE_STATUS.SUCCESS)
                            {
                                insertDataList = new List<DBItem>();
                                insertDataList.Add(new DBItem("EMR_SIGN", userno, DBItem.DBDataType.String));
                                insertDataList.Add(new DBItem("EMR_TIME", now_datetime.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime));
                                string where = " IID = '" + tableid + "' ";
                                erow += link.DBExecUpdateTns("OBS_NB", insertDataList, where);
                            }
                        }
                    }
                    else
                    {
                        json_result.status = RESPONSE_STATUS.ERROR;
                        json_result.message = "沒有二、三產程資料，請補填!";
                    }
                }
                else
                {
                    json_result.status = RESPONSE_STATUS.SUCCESS;
                    json_result.message = "";
                }
                //Response.Write("<script>alert('修改成功');window.location.href='Index?active=Partial_Child_Brith'</script>");
            }
            else
            {
                json_result.status = RESPONSE_STATUS.ERROR;
                json_result.message = "修改失敗";

                //Response.Write("<script>alert('修改失敗');window.location.href='Index?active=Partial_Child_Brith'</script>");
            }

            return Content(JsonConvert.SerializeObject(json_result), "application/json");
        }
        #endregion

        #region 新生兒緊急處置新增畫面
        public ActionResult Partial_Child_EMR(string Seq, string IID, string NBIID)
        {
            string feeno = ptinfo?.FeeNo;
            var chartNo = "";

            if (ptinfo.Age < 1)
            //if (ptinfo.ChartNo == "05789469")
            {
                DataTable babylink = obs_m.sel_nbcha("", ptinfo.ChartNo);
                if (babylink != null && babylink.Rows.Count > 0)
                {
                    feeno = babylink.Rows[0]["MOM_FEE_NO"].ToString();
                    chartNo = babylink.Rows[0]["BABY_CHART_NO"].ToString();
                }
            }

            if (IsNoEmpty(IID))
            {
                DataTable dt = obs_m.sel_nb_emr(feeno, IID);
                dt.Columns.Add("CREATNO_ET_NAME");
                if (dt != null && dt.Rows.Count > 0)
                {
                    foreach (DataRow r in dt.Rows)
                    {
                        if (r["CREATNO_ET"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["CREATNO_ET"].ToString());
                            if (listByteCode == null)
                                r["CREATNO_ET_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["CREATNO_ET_NAME"] = user_name.EmployeesName;
                            }
                        }
                    }
                }
                ViewBag.dt = set_dt(dt);
            }

            ViewBag.Seq = Seq;
            ViewBag.NBIID = NBIID;
            return View();
        }
        #endregion

        #region 新生兒緊急處置新增
        [HttpPost]
        public ActionResult Insert_Partial_Child_EMR(FormCollection form)
        {
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo?.FeeNo;
            string babyfeeno = "";
            string id = base.creatid("OBS_NB_EMR", userno, feeno, "0");
            var seq = 1;

            var chartNo = "";
            if (ptinfo.Age < 1)
            //if (ptinfo.ChartNo == "05789469")
            {
                DataTable babylink = obs_m.sel_nbcha("", ptinfo.ChartNo);
                if (babylink != null && babylink.Rows.Count > 0)
                {
                    feeno = babylink.Rows[0]["MOM_FEE_NO"].ToString();
                    chartNo = babylink.Rows[0]["BABY_CHART_NO"].ToString();
                    babyfeeno = babylink.Rows[0]["BABY_FEE_NO"].ToString();
                }
            }

            DataTable dt = obs_m.sel_nb_emr_seq(feeno, "");
            if (dt != null && dt.Rows.Count > 0)
                seq = Convert.ToInt32(dt.Rows[0]["SNOM"]) + 1;

            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("IID", id, DBItem.DBDataType.String)); //序號
            insertDataList.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String)); //建立者員編
            insertDataList.Add(new DBItem("BABY_SEQ", form["SEQ"], DBItem.DBDataType.String)); //建立者員編
            insertDataList.Add(new DBItem("CREATNO", userno, DBItem.DBDataType.String)); //建立者員編
            insertDataList.Add(new DBItem("SNOM", seq.ToString(), DBItem.DBDataType.String)); //建立者員編
            insertDataList.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
            insertDataList.Add(new DBItem("RECORDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間
            insertDataList.Add(new DBItem("DELETED", null, DBItem.DBDataType.String)); //刪除註記

            if (form["ET_DATE_DAY"] != "" && form["ET_DATE_DAY"] != null && form["ET_DATE_TIME"] != "" && form["ET_DATE_TIME"] != null)
                insertDataList.Add(new DBItem("ET_DATE", form["ET_DATE_DAY"] + " " + form["ET_DATE_TIME"], DBItem.DBDataType.DataTime)); //紀錄時間
            insertDataList.Add(new DBItem("ET", form["TXT_ET"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("CREATNO_ET", form["TXT_CREATNO_ET"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("ET_CARE_RECORD", form["CK_ET_CARE_RECORD"], DBItem.DBDataType.String));
            insertDataList = setNullToEmpty(insertDataList);
            int erow = link.DBExecInsert("OBS_NB_EMR", insertDataList);

            if (form["CK_ET_CARE_RECORD"] == "1")
            {
                var result = $"{form["TXT_ET"]}。評估者：{Get_Employee_Name(form["TXT_CREATNO_ET"])}";
                if (ptinfo.Age < 1) //小孩
                //if (ptinfo.ChartNo == "05789469")
                {
                    erow += base.Insert_CareRecord(form["ET_DATE_DAY"] + " " + form["ET_DATE_TIME"], id, "新生兒緊急處置", result, "", "", "", "", "OBS_NB_EMR");
                }
                else //媽媽
                {
                    var babyseq = (Convert.ToInt32(form["SEQ"]) + 65);
                    DataTable baby = obs_m.sel_nbcha("", "", ptinfo.FeeNo, Convert.ToChar(babyseq).ToString());
                    if (baby != null && baby.Rows.Count > 0)
                    {
                        babyfeeno = baby.Rows[0]["BABY_FEE_NO"].ToString();
                        erow += Insert_CareRecord_ForOtherTns(babyfeeno, form["ET_DATE_DAY"] + " " + form["ET_DATE_TIME"], id, "新生兒緊急處置", result, "", "", "", "", "OBS_NB_EMR", ref link);
                    }
                }
            }

            if (erow >= 1)
            {
                link.DBCommit();
                Response.Write("<script>alert('新增成功，需儲存出生紀錄才會生效!');window.close();</script>");
            }
            else
            {
                link.DBRollBack();
                Response.Write("<script>alert('新增失敗');window.close();</script>");
            }

            return new EmptyResult();
        }
        #endregion

        #region 新生兒緊急處置編輯
        public ActionResult Upd_Partial_Child_EMR(FormCollection form)
        {
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo.FeeNo;
            string[] id_list = form["IID"].Split(',');
            int erow = 0;
            for (int v = 0; v < id_list.Length; v++)
            {
                List<DBItem> insertDataList = new List<DBItem>();
                insertDataList.Add(new DBItem("UPDNO", userno, DBItem.DBDataType.String)); //評估者員編
                insertDataList.Add(new DBItem("UPDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
                insertDataList.Add(new DBItem("RECORDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間

                if (form["ET_DATE_DAY" + id_list[v]] != "" && form["ET_DATE_DAY" + id_list[v]] != null && form["ET_DATE_TIME" + id_list[v]] != "" && form["ET_DATE_TIME" + id_list[v]] != null)
                    insertDataList.Add(new DBItem("ET_DATE", form["ET_DATE_DAY" + id_list[v]] + " " + form["ET_DATE_TIME" + id_list[v]], DBItem.DBDataType.DataTime)); //紀錄時間
                insertDataList.Add(new DBItem("ET", form["TXT_ET" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("CREATNO_ET", form["TXT_CREATNO_ET" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("ET_CARE_RECORD", form["CK_ET_CARE_RECORD" + id_list[v]], DBItem.DBDataType.String));
                insertDataList = setNullToEmpty(insertDataList);
                string where = " IID = '" + id_list[v] + "' ";
                erow += link.DBExecUpdate("OBS_NB_EMR", insertDataList, where);

                if (form["CK_ET_CARE_RECORD" + id_list[v]] == "1")
                {
                    var result = $"{form["TXT_ET" + id_list[v]]}。評估者{Get_Employee_Name(form["TXT_CREATNO_ET" + id_list[v]])}";
                    var careSql = $"SELECT * FROM CARERECORD_DATA where DELETED IS NULL AND CARERECORD_ID = '{id_list[v]}'";
                    DataTable care = obs_m.DBExecSQL(careSql);
                    if (care != null && care.Rows.Count > 0)
                    {
                        if (ptinfo.Age < 1) //小孩
                        //if (ptinfo.ChartNo == "05789469")
                        {
                            erow += base.Upd_CareRecord(form["ET_DATE_DAY" + id_list[v]] + " " + form["ET_DATE_TIME" + id_list[v]], id_list[v], "新生兒緊急處置", result, "", "", "", "", "OBS_NB_EMR");
                        }
                        else
                        {
                            var babyseq = (Convert.ToInt32(form["SEQ"]) + 65);
                            DataTable baby = obs_m.sel_nbcha("", "", ptinfo.FeeNo, Convert.ToChar(babyseq).ToString());
                            if (baby != null && baby.Rows.Count > 0)
                            {
                                var babyfeeno = baby.Rows[0]["BABY_FEE_NO"].ToString();
                                erow += Upd_CareRecord_ForOtherTns(babyfeeno, form["ET_DATE_DAY" + id_list[v]] + " " + form["ET_DATE_TIME" + id_list[v]], id_list[v], "新生兒緊急處置", result, "", "", "", "", "OBS_NB_EMR", ref link);
                            }
                        }
                    }
                    else
                    {
                        if (ptinfo.Age < 1) //小孩
                        //if (ptinfo.ChartNo == "05789469")
                        {
                            erow += base.Insert_CareRecord(form["ET_DATE_DAY" + id_list[v]] + " " + form["ET_DATE_TIME" + id_list[v]], id_list[v], "新生兒緊急處置", result, "", "", "", "", "OBS_NB_EMR");
                        }
                        else
                        {
                            var babyseq = (Convert.ToInt32(form["SEQ"]) + 65);
                            DataTable baby = obs_m.sel_nbcha("", "", ptinfo.FeeNo, Convert.ToChar(babyseq).ToString());
                            if (baby != null && baby.Rows.Count > 0)
                            {
                                var babyfeeno = baby.Rows[0]["BABY_FEE_NO"].ToString();
                                erow += Insert_CareRecord_ForOtherTns(babyfeeno, form["ET_DATE_DAY" + id_list[v]] + " " + form["ET_DATE_TIME" + id_list[v]], id_list[v], "新生兒緊急處置", result, "", "", "", "", "OBS_NB_EMR", ref link);
                            }
                        }
                    }
                }
                else
                {
                    erow += base.Del_CareRecord(id_list[v], "OBS_NB_EMR");
                }
            }

            if (erow >= id_list.Length)
            {
                link.DBCommit();
                Response.Write("<script>alert('修改成功，需儲存出生紀錄才會生效!');window.close();</script>");
            }
            else
            {
                link.DBRollBack();
                Response.Write("<script>alert('修改失敗');window.close();</script>");
            }

            return new EmptyResult();
        }
        #endregion

        #region 新生兒緊急處置刪除
        /// <summary>
        /// 新生兒緊急處置刪除
        /// </summary>
        /// <param name="form"></param>
        /// <returns></returns>
        [HttpPost]
        public string Del_Partial_Child_EMR(FormCollection form)
        {
            string[] id_list = form["del_ID"].ToString().Split(',');
            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("DELETED", userinfo.EmployeesNo, DBItem.DBDataType.String));
            string where = " IID IN ('" + String.Join("','", id_list) + "')";
            insertDataList = setNullToEmpty(insertDataList);
            int erow = obs_m.DBExecUpdate("OBS_NB_EMR", insertDataList, where);

            foreach (var v in id_list)
                //base.Del_CareRecordTns(v, "OBS_NB_EMR", ref link);
                base.Del_CareRecord(v, "OBS_NB_EMR");

            return erow.ToString();
        }
        #endregion

        #region 新生兒紀錄列印單
        public ActionResult Child_Birth_Print(string fee_no, string IID)
        {
            var sql = "";
            var Temp = new List<Dictionary<string, string>>();
            DataTable dt_check = null;
            DataTable Dt2 = null;

            var momInfo = new PatientInfo();
            var NBChartNo = "";
            if (!IsNoEmpty(fee_no))
            {
                fee_no = ptinfo.FeeNo;
            }
            if (ptinfo == null)
            {
                ptinfo = Get_Patient_Info(fee_no.ToString());
            }

            if (ptinfo.Age < 1)
            {
                #region 新生兒溝通表
                DataTable babylink = obs_m.sel_nbcha("", ptinfo.ChartNo);
                if (babylink != null && babylink.Rows.Count > 0)
                {
                    NBChartNo = babylink.Rows[0]["BABY_CHART_NO"].ToString();
                    momInfo = Get_Patient_Info(babylink.Rows[0]["MOM_FEE_NO"].ToString());
                    if (momInfo == null)
                    {
                        Response.Write("<script>alert('找不到此新生兒之母親資料!');window.close();</script>");
                        return new EmptyResult();
                    }
                }
                else
                {
                    Response.Write("<script>alert('找不到此新生兒之母親資料!');window.close();</script>");
                    return new EmptyResult();
                }
                #endregion

                #region 生產史
                DataTable dt = obs_m.sel_bthhis(momInfo.FeeNo);
                dt.Columns.Add("PAT_ZONEC");
                dt.Columns.Add("MAT_ZONEC");
                if (dt != null && dt.Rows.Count != 0)
                {
                    if (dt.Rows[0]["PAT_ZONE"].ToString() != "")
                    {
                        DataTable area = obs_m.sel_v_area("", dt.Rows[0]["PAT_ZONE"].ToString());
                        if (area != null && area.Rows.Count > 0)
                        {
                            dt.Rows[0]["PAT_ZONEC"] = area.Rows[0]["AREA_NAME"];
                        }
                    }

                    if (dt.Rows[0]["MAT_ZONE"].ToString() != "")
                    {
                        DataTable area = obs_m.sel_v_area("", dt.Rows[0]["MAT_ZONE"].ToString());
                        if (area != null && area.Rows.Count > 0)
                        {
                            dt.Rows[0]["MAT_ZONEC"] = area.Rows[0]["AREA_NAME"];
                        }
                    }

                    var inst = new List<string>() { "+", "-", "F", "X", "外院" };
                    if (dt.Rows[0]["HBSAG"].ToString() != "")
                        ViewBag.HBSAG = inst[Convert.ToInt32(dt.Rows[0]["HBSAG"].ToString())];
                    if (dt.Rows[0]["HBEAG"].ToString() != "")
                        ViewBag.HBEAG = inst[Convert.ToInt32(dt.Rows[0]["HBEAG"].ToString())];
                    if (dt.Rows[0]["RUBELLA"].ToString() != "")
                        ViewBag.RUBELLA = inst[Convert.ToInt32(dt.Rows[0]["RUBELLA"].ToString())];
                    if (dt.Rows[0]["VDRL1"].ToString() != "")
                        ViewBag.VDRL1 = inst[Convert.ToInt32(dt.Rows[0]["VDRL1"].ToString())];
                    if (dt.Rows[0]["VDRL2"].ToString() != "")
                        ViewBag.VDRL2 = inst[Convert.ToInt32(dt.Rows[0]["VDRL2"].ToString())];
                    if (dt.Rows[0]["HIV"].ToString() != "")
                        ViewBag.HIV = inst[Convert.ToInt32(dt.Rows[0]["HIV"].ToString())];
                    if (dt.Rows[0]["GBS"].ToString() != "")
                        ViewBag.GBS = inst[Convert.ToInt32(dt.Rows[0]["GBS"].ToString())];

                    if (dt.Rows[0]["GBS_AB"].ToString() != "")
                        ViewBag.GBSAB = $"(抗生素施打時間：{Convert.ToDateTime(dt.Rows[0]["GBS_AB"].ToString()).ToString("yyyy/MM/dd HH:mm")})";
                    else
                        ViewBag.GBSAB = "(抗生素施打時間：無)";
                }
                else
                {
                    Response.Write("<script>alert('請先新增生產史!');window.close();</script>");
                    return new EmptyResult();
                }
                ViewBag.dt = set_dt(dt);
                #endregion

                #region 新生兒緊急處置
                DataTable dt_emr = obs_m.sel_nb_emr(momInfo.FeeNo);
                ViewBag.dt_emr = set_dt(dt_emr);
                #endregion

                #region 新生兒
                DataTable dt_nb = obs_m.sel_nb(momInfo.FeeNo, NBChartNo);
                dt_nb.Columns.Add("BABY_CHARTNO");
                dt_nb.Columns.Add("BABY_NAME");
                dt_nb.Columns.Add("BABY_BEDNO");

                dt_nb.Columns.Add("TPR");
                dt_nb.Columns.Add("CREATNO_NAME");
                dt_nb.Columns.Add("CREATNO_2_NAME");
                dt_nb.Columns.Add("DIRECTOR_NAME");
                dt_nb.Columns.Add("RB_AS_1_WHO_NAME");
                dt_nb.Columns.Add("RB_AS_5_WHO_NAME");
                dt_nb.Columns.Add("RB_AS_10_WHO_NAME");
                dt_nb.Columns.Add("RB_AS_OTH_WHO_NAME");
                if (dt_nb != null && dt_nb.Rows.Count > 0)
                {
                    foreach (DataRow r_nb in dt_nb.Rows)
                    {
                        DataTable babyFeeNo = obs_m.sel_nbcha("", r_nb["NB_CHARTNO"].ToString());

                        if (babyFeeNo != null && babyFeeNo.Rows.Count > 0)
                        {
                            var patientInfo = Get_Patient_Info(babyFeeNo.Rows[0]["BABY_FEE_NO"].ToString());
                            r_nb["BABY_CHARTNO"] = patientInfo?.ChartNo;
                            r_nb["BABY_NAME"] = patientInfo?.PatientName;
                            r_nb["BABY_BEDNO"] = patientInfo?.BedNo;

                            #region 生命徵象
                            var TPR = "#T#$#P#$#R#";
                            string type = base.get_check_type(patientInfo); //取得生命徵象異常年紀代號
                                                                            //生命徵象   20181213一天內只取每個項目的最新DATA
                            sql = "SELECT CREATE_DATE, VS_ITEM, VS_PART, VS_RECORD, VS_MEMO,VS_REASON  "
                           + " FROM ( "
                           + "     SELECT CREATE_DATE, VS_ITEM, VS_PART, VS_RECORD, VS_MEMO,VS_REASON, "
                           + "     ROW_NUMBER() OVER(PARTITION BY t.VS_ITEM ORDER BY t.CREATE_DATE) NUM "
                           + "     FROM DATA_VITALSIGN t "
                           + "     WHERE FEE_NO = '" + babyFeeNo.Rows[0]["BABY_FEE_NO"] + "' "
                           + "     AND CREATE_DATE >= to_date('" + patientInfo.Birthday.AddDays(-1).ToString("yyyy/MM/dd HH:mm:ss") + "','yyyy/MM/dd hh24:mi:ss') "
                           + "     AND CREATE_DATE <= to_date('" + patientInfo.Birthday.AddDays(+1).ToString("yyyy/MM/dd HH:mm:ss") + "','yyyy/MM/dd hh24:mi:ss') "
                           + "     ORDER BY CREATE_DATE ) MAIN "
                           + " WHERE MAIN.NUM = 1 ";
                            Temp = new List<Dictionary<string, string>>();
                            dt_check = null;

                            Dt2 = link.DBExecSQL(sql);
                            if (Dt2.Rows.Count > 0)
                            {
                                for (int i = 0; i < Dt2.Rows.Count; i++)
                                {
                                    var temp = new Dictionary<string, string>();
                                    temp["CREATE_DATE"] = Dt2.Rows[i]["CREATE_DATE"].ToString();
                                    temp["VS_ITEM"] = Dt2.Rows[i]["VS_ITEM"].ToString();
                                    temp["VS_PART"] = Dt2.Rows[i]["VS_PART"].ToString();
                                    temp["VS_REASON"] = Dt2.Rows[i]["VS_REASON"].ToString();
                                    temp["VS_RECORD"] = Dt2.Rows[i]["VS_RECORD"].ToString();
                                    temp["VS_MEMO"] = Dt2.Rows[i]["VS_MEMO"].ToString();
                                    Temp.Add(temp);
                                }
                            }

                            if (Temp.Count > 0)
                            {
                                List<Dictionary<string, string>> VitalSignList = new List<Dictionary<string, string>>();

                                #region 體溫
                                VitalSignList = Temp.FindAll(x => x["VS_ITEM"] == "bt" && !string.IsNullOrEmpty(x["VS_RECORD"]));
                                dt_check = Get_Check_Abnormal_dt();
                                string color = "black";
                                if (VitalSignList.Count > 0)
                                {
                                    for (int i = 0; i < 1; i++)
                                    {
                                        color = "black";
                                        string l_check = "btl_e", h_check = "bth_e";
                                        string ck_value = VitalSignList[i]["VS_RECORD"], part = VitalSignList[i]["VS_PART"];
                                        if (part == "腋溫")
                                        {
                                            l_check = "btl_a";
                                            h_check = "bth_a";
                                        }
                                        else if (part == "肛溫")
                                        {
                                            l_check = "btl_r";
                                            h_check = "bth_r";
                                        }
                                        else if (part == "額溫")
                                        {
                                            l_check = "btl_f";
                                            h_check = "bth_f";
                                        }
                                        string measure = VitalSignList[i]["VS_REASON"];
                                        foreach (DataRow r in dt_check.Rows)
                                        {
                                            if (measure == "測不到")
                                            {
                                                color = "red";
                                            }
                                            else
                                            {
                                                if (r["MODEL_ID"].ToString() == l_check || r["MODEL_ID"].ToString() == h_check)
                                                {
                                                    if (r["DECIDE"].ToString() == ">")
                                                    {
                                                        if (double.Parse(ck_value) > double.Parse(r["VALUE_LIMIT"].ToString()))
                                                        {
                                                            color = "red";
                                                        }
                                                    }
                                                    else if (r["DECIDE"].ToString() == "<")
                                                    {
                                                        if (double.Parse(ck_value) < double.Parse(r["VALUE_LIMIT"].ToString()))
                                                        {
                                                            color = "blue";
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        TPR = TPR.Replace("#T#", VitalSignList[i]["VS_RECORD"] + "℃");
                                    }
                                }
                                #endregion

                                #region 脈搏
                                VitalSignList = Temp.FindAll(x => x["VS_ITEM"] == "mp" && !string.IsNullOrEmpty(x["VS_RECORD"]));
                                if (VitalSignList.Count > 0)
                                {
                                    for (int i = 0; i < 1; i++)
                                    {
                                        color = "black";
                                        string ck_value = VitalSignList[i]["VS_RECORD"], part = VitalSignList[i]["VS_PART"];
                                        string measure = VitalSignList[i]["VS_REASON"];
                                        foreach (DataRow r in dt_check.Rows)
                                        {
                                            if (measure == "測不到")
                                            {
                                                color = "red";
                                            }
                                            else
                                            {
                                                if (r["MODEL_ID"].ToString() == "mpl_" + type || r["MODEL_ID"].ToString() == "mph_" + type)
                                                {
                                                    if (r["DECIDE"].ToString() == ">")
                                                    {
                                                        if (double.Parse(ck_value) > double.Parse(r["VALUE_LIMIT"].ToString()))
                                                        {
                                                            color = "red";
                                                        }
                                                    }
                                                    else if (r["DECIDE"].ToString() == "<")
                                                    {
                                                        if (double.Parse(ck_value) < double.Parse(r["VALUE_LIMIT"].ToString()))
                                                        {
                                                            color = "blue";
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        TPR = TPR.Replace("#P#", VitalSignList[i]["VS_RECORD"] + "次/分");
                                    }
                                }

                                #endregion

                                #region 呼吸
                                VitalSignList = Temp.FindAll(x => x["VS_ITEM"] == "bf" && !string.IsNullOrEmpty(x["VS_RECORD"]));
                                if (VitalSignList.Count > 0)
                                {
                                    for (int i = 0; i < 1; i++)
                                    {
                                        color = "black";
                                        string ck_value = VitalSignList[i]["VS_RECORD"], part = VitalSignList[i]["VS_PART"];
                                        string measure = VitalSignList[i]["VS_REASON"];
                                        foreach (DataRow r in dt_check.Rows)
                                        {
                                            if (measure == "測不到")
                                            {
                                                color = "red";
                                            }
                                            else
                                            {
                                                if (r["MODEL_ID"].ToString() == "bfl_" + type || r["MODEL_ID"].ToString() == "bfh_" + type)
                                                {
                                                    if (r["DECIDE"].ToString() == ">")
                                                    {
                                                        if (double.Parse(ck_value) > double.Parse(r["VALUE_LIMIT"].ToString()))
                                                        {
                                                            color = "red";
                                                        }
                                                    }
                                                    else if (r["DECIDE"].ToString() == "<")
                                                    {
                                                        if (double.Parse(ck_value) < double.Parse(r["VALUE_LIMIT"].ToString()))
                                                        {
                                                            color = "blue";
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        TPR = TPR.Replace("#R#", VitalSignList[i]["VS_RECORD"] + "次/分");
                                    }
                                }
                                #endregion
                            }
                            #endregion
                            r_nb["TPR"] = TPR.Replace("#T#", "無").Replace("#P#", "無").Replace("#R#", "無");
                        }

                        if (r_nb["CREATNO"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r_nb["CREATNO"].ToString());
                            if (listByteCode == null)
                                r_nb["CREATNO_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r_nb["CREATNO_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r_nb["CREATNO_2"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r_nb["CREATNO_2"].ToString());
                            if (listByteCode == null)
                                r_nb["CREATNO_2_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r_nb["CREATNO_2_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r_nb["DIRECTOR"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r_nb["DIRECTOR"].ToString());
                            if (listByteCode == null)
                                r_nb["DIRECTOR_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r_nb["DIRECTOR_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r_nb["RB_AS_1_WHO"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r_nb["RB_AS_1_WHO"].ToString());
                            if (listByteCode == null)
                                r_nb["RB_AS_1_WHO_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r_nb["RB_AS_1_WHO_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r_nb["RB_AS_5_WHO"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r_nb["RB_AS_5_WHO"].ToString());
                            if (listByteCode == null)
                                r_nb["RB_AS_5_WHO_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r_nb["RB_AS_5_WHO_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r_nb["RB_AS_10_WHO"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r_nb["RB_AS_10_WHO"].ToString());
                            if (listByteCode == null)
                                r_nb["RB_AS_10_WHO_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r_nb["RB_AS_10_WHO_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r_nb["RB_AS_OTH_WHO"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r_nb["RB_AS_OTH_WHO"].ToString());
                            if (listByteCode == null)
                                r_nb["RB_AS_OTH_WHO_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r_nb["RB_AS_OTH_WHO_NAME"] = user_name.EmployeesName;
                            }
                        }
                    }
                }
                else
                {
                    Response.Write("<script>alert('請先新增新生兒出生紀錄!');window.close();</script>");
                    return new EmptyResult();
                }
                ViewBag.dt_nb = set_dt(dt_nb);
                #endregion

                #region 第二、三產程
                DataTable dt_sta = obs_m.sel_bthsta(momInfo.FeeNo);
                dt_sta.Columns.Add("PHYSICIAN_1_NAME");
                dt_sta.Columns.Add("PHYSICIAN_2_NAME");
                dt_sta.Columns.Add("CLNURSE_1_NAME");
                dt_sta.Columns.Add("CLNURSE_2_NAME");
                dt_sta.Columns.Add("SRNURSE_1_NAME");
                dt_sta.Columns.Add("SRNURSE_2_NAME");
                dt_sta.Columns.Add("NNP_1_NAME");
                dt_sta.Columns.Add("NNP_2_NAME");
                if (dt_sta != null && dt_sta.Rows.Count > 0)
                {
                    DataRow sta_rows = dt_sta.Rows[0];
                    if (sta_rows["BIRTH"].ToString() != "" && sta_rows["RFM_TIME"].ToString() != "")
                    {
                        var GRuptureTime = Convert.ToDateTime(sta_rows["BIRTH"]).Subtract(Convert.ToDateTime(sta_rows["RFM_TIME"]));
                        ViewBag.GRuptureTime = ((int)GRuptureTime.TotalHours).ToString() + "小時" + GRuptureTime.Minutes.ToString() + "分";
                    }

                    foreach (DataRow r in dt_sta.Rows)
                    {
                        if (r["PHYSICIAN_1"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["PHYSICIAN_1"].ToString());
                            if (listByteCode == null)
                                r["PHYSICIAN_1_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["PHYSICIAN_1_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["PHYSICIAN_2"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["PHYSICIAN_2"].ToString());
                            if (listByteCode == null)
                                r["PHYSICIAN_2_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["PHYSICIAN_2_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["CLNURSE_1"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["CLNURSE_1"].ToString());
                            if (listByteCode == null)
                                r["CLNURSE_1_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["CLNURSE_1_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["CLNURSE_2"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["CLNURSE_2"].ToString());
                            if (listByteCode == null)
                                r["CLNURSE_2_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["CLNURSE_2_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["SRNURSE_1"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["SRNURSE_1"].ToString());
                            if (listByteCode == null)
                                r["SRNURSE_1_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["SRNURSE_1_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["SRNURSE_2"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["SRNURSE_2"].ToString());
                            if (listByteCode == null)
                                r["SRNURSE_2_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["SRNURSE_2_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["NNP_1"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["NNP_1"].ToString());
                            if (listByteCode == null)
                                r["NNP_1_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["NNP_1_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["NNP_2"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["NNP_2"].ToString());
                            if (listByteCode == null)
                                r["NNP_2_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["NNP_2_NAME"] = user_name.EmployeesName;
                            }
                        }
                    }
                }
                else
                {
                    Response.Write("<script>alert('請先新增二、三產程!');window.close();</script>");
                    return new EmptyResult();
                }
                ViewBag.dt_sta = set_dt(dt_sta);
                #endregion

                #region 媽媽生命徵象
                sql = "SELECT CREATE_DATE, VS_ITEM, VS_PART, VS_RECORD, VS_MEMO,VS_REASON  "
                          + " FROM ( "
                          + "     SELECT CREATE_DATE, VS_ITEM, VS_PART, VS_RECORD, VS_MEMO,VS_REASON, "
                          + "     ROW_NUMBER() OVER(PARTITION BY t.VS_ITEM ORDER BY t.CREATE_DATE desc) NUM "
                          + "     FROM DATA_VITALSIGN t "
                          + "     WHERE FEE_NO = '" + momInfo.FeeNo + "' "
                          + "     AND VS_ITEM = 'bt' "
                          + "     AND CREATE_DATE >= to_date('" + DateTime.Now.AddDays(-1).ToString("yyyy/MM/dd HH:mm:ss") + "','yyyy/MM/dd hh24:mi:ss') "
                          + "     ORDER BY CREATE_DATE DESC ) MAIN "
                          + "";
                Temp = new List<Dictionary<string, string>>();
                dt_check = null;

                Dt2 = link.DBExecSQL(sql);
                if (Dt2.Rows.Count > 0)
                {
                    for (int i = 0; i < Dt2.Rows.Count; i++)
                    {
                        var temp = new Dictionary<string, string>();
                        temp["CREATE_DATE"] = Dt2.Rows[i]["CREATE_DATE"].ToString();
                        temp["VS_ITEM"] = Dt2.Rows[i]["VS_ITEM"].ToString();
                        temp["VS_PART"] = Dt2.Rows[i]["VS_PART"].ToString();
                        temp["VS_REASON"] = Dt2.Rows[i]["VS_REASON"].ToString();
                        temp["VS_RECORD"] = Dt2.Rows[i]["VS_RECORD"].ToString();
                        temp["VS_MEMO"] = Dt2.Rows[i]["VS_MEMO"].ToString();
                        Temp.Add(temp);
                    }
                }

                if (Temp.Count > 0)
                {
                    int rownum = 3;
                    List<Dictionary<string, string>> VitalSignList = new List<Dictionary<string, string>>();

                    VitalSignList = Temp.FindAll(x => x["VS_ITEM"] == "bt" && !string.IsNullOrEmpty(x["VS_RECORD"]) && Convert.ToDecimal(x["VS_RECORD"].ToString()) >= 38);
                    dt_check = Get_Check_Abnormal_dt();
                    string color = "black";
                    if (VitalSignList.Count > 0)
                    {
                        for (int i = 0; i < ((VitalSignList.Count < rownum) ? VitalSignList.Count : rownum); i++)
                        {
                            color = "black";
                            string l_check = "btl_e", h_check = "bth_e";
                            string ck_value = VitalSignList[i]["VS_RECORD"], part = VitalSignList[i]["VS_PART"];
                            if (part == "腋溫")
                            {
                                l_check = "btl_a";
                                h_check = "bth_a";
                            }
                            else if (part == "肛溫")
                            {
                                l_check = "btl_r";
                                h_check = "bth_r";
                            }
                            else if (part == "額溫")
                            {
                                l_check = "btl_f";
                                h_check = "bth_f";
                            }
                            string measure = VitalSignList[i]["VS_REASON"];
                            foreach (DataRow r in dt_check.Rows)
                            {
                                if (measure == "測不到")
                                {
                                    color = "red";
                                }
                                else
                                {
                                    if (r["MODEL_ID"].ToString() == l_check || r["MODEL_ID"].ToString() == h_check)
                                    {
                                        if (r["DECIDE"].ToString() == ">")
                                        {
                                            if (double.Parse(ck_value) > double.Parse(r["VALUE_LIMIT"].ToString()))
                                            {
                                                color = "red";
                                            }
                                        }
                                        else if (r["DECIDE"].ToString() == "<")
                                        {
                                            if (double.Parse(ck_value) < double.Parse(r["VALUE_LIMIT"].ToString()))
                                            {
                                                color = "blue";
                                            }
                                        }
                                    }
                                }
                            }

                            if (measure == "測不到")
                                continue;
                            else
                                ViewBag.Mom_Temporary += string.Format("{0}<label class='LittleTitle'>：</label>{1}。"
                                    , Convert.ToDateTime(VitalSignList[i]["CREATE_DATE"].ToString()).ToString("yyyy/MM/dd HH:mm")
                                    , VitalSignList[i]["VS_RECORD"] + "℃");
                        }
                    }
                }
                #endregion

                ViewBag.chartNo = momInfo.ChartNo;
                ViewBag.BedNo = momInfo.BedNo;
            }
            else
            {
                if (IID == "")
                {
                    Response.Write("<script>alert('參數[IID]沒有傳入!');window.close();</script>");
                    return new EmptyResult();
                }

                #region 生產史
                DataTable dt = obs_m.sel_bthhis(fee_no);
                dt.Columns.Add("PAT_ZONEC");
                dt.Columns.Add("MAT_ZONEC");
                if (dt != null && dt.Rows.Count != 0)
                {
                    if (dt.Rows[0]["PAT_ZONE"].ToString() != "")
                    {
                        DataTable area = obs_m.sel_v_area("", dt.Rows[0]["PAT_ZONE"].ToString());
                        if (area != null && area.Rows.Count > 0)
                        {
                            dt.Rows[0]["PAT_ZONEC"] = area.Rows[0]["AREA_NAME"];
                        }
                    }

                    if (dt.Rows[0]["MAT_ZONE"].ToString() != "")
                    {
                        DataTable area = obs_m.sel_v_area("", dt.Rows[0]["MAT_ZONE"].ToString());
                        if (area != null && area.Rows.Count > 0)
                        {
                            dt.Rows[0]["MAT_ZONEC"] = area.Rows[0]["AREA_NAME"];
                        }
                    }

                    var inst = new List<string>() { "+", "-", "F", "X", "外院" };
                    if (dt.Rows[0]["HBSAG"].ToString() != "")
                        ViewBag.HBSAG = inst[Convert.ToInt32(dt.Rows[0]["HBSAG"].ToString())];
                    if (dt.Rows[0]["HBEAG"].ToString() != "")
                        ViewBag.HBEAG = inst[Convert.ToInt32(dt.Rows[0]["HBEAG"].ToString())];
                    if (dt.Rows[0]["RUBELLA"].ToString() != "")
                        ViewBag.RUBELLA = inst[Convert.ToInt32(dt.Rows[0]["RUBELLA"].ToString())];
                    if (dt.Rows[0]["VDRL1"].ToString() != "")
                        ViewBag.VDRL1 = inst[Convert.ToInt32(dt.Rows[0]["VDRL1"].ToString())];
                    if (dt.Rows[0]["VDRL2"].ToString() != "")
                        ViewBag.VDRL2 = inst[Convert.ToInt32(dt.Rows[0]["VDRL2"].ToString())];
                    if (dt.Rows[0]["HIV"].ToString() != "")
                        ViewBag.HIV = inst[Convert.ToInt32(dt.Rows[0]["HIV"].ToString())];
                    if (dt.Rows[0]["GBS"].ToString() != "")
                        ViewBag.GBS = inst[Convert.ToInt32(dt.Rows[0]["GBS"].ToString())];

                    if (dt.Rows[0]["GBS_AB"].ToString() != "")
                        ViewBag.GBSAB = $"(抗生素施打時間：{Convert.ToDateTime(dt.Rows[0]["GBS_AB"].ToString()).ToString("yyyy/MM/dd HH:mm")})";
                    else
                        ViewBag.GBSAB = "(抗生素施打時間：無)";
                }
                else
                {
                    Response.Write("<script>alert('請先新增生產史!');window.close();</script>");
                    return new EmptyResult();
                }
                ViewBag.dt = set_dt(dt);
                #endregion

                #region 新生兒緊急處置
                DataTable dt_emr = obs_m.sel_nb_emr(fee_no);
                ViewBag.dt_emr = set_dt(dt_emr);
                #endregion

                #region 新生兒
                DataTable dt_nb = obs_m.sel_nb(fee_no, "", IID);
                dt_nb.Columns.Add("BABY_CHARTNO");
                dt_nb.Columns.Add("BABY_NAME");
                dt_nb.Columns.Add("BABY_BEDNO");

                dt_nb.Columns.Add("TPR");
                dt_nb.Columns.Add("CREATNO_NAME");
                dt_nb.Columns.Add("CREATNO_2_NAME");
                dt_nb.Columns.Add("DIRECTOR_NAME");
                dt_nb.Columns.Add("RB_AS_1_WHO_NAME");
                dt_nb.Columns.Add("RB_AS_5_WHO_NAME");
                dt_nb.Columns.Add("RB_AS_10_WHO_NAME");
                dt_nb.Columns.Add("RB_AS_OTH_WHO_NAME");
                if (dt_nb != null && dt_nb.Rows.Count > 0)
                {
                    foreach (DataRow r_nb in dt_nb.Rows)
                    {
                        DataTable babyFeeNo = obs_m.sel_nbcha("", r_nb["NB_CHARTNO"].ToString(), fee_no);

                        if (babyFeeNo != null && babyFeeNo.Rows.Count > 0)
                        {
                            var patientInfo = Get_Patient_Info(babyFeeNo.Rows[0]["BABY_FEE_NO"].ToString());
                            if (patientInfo != null)
                            {

                                r_nb["BABY_CHARTNO"] = patientInfo?.ChartNo;
                                r_nb["BABY_NAME"] = patientInfo?.PatientName;
                                r_nb["BABY_BEDNO"] = patientInfo?.BedNo;

                                #region 生命徵象
                                var TPR = "#T#$#P#$#R#";
                                string type = base.get_check_type(patientInfo); //取得生命徵象異常年紀代號
                                                                                //生命徵象   20181213一天內只取每個項目的最新DATA
                                sql = "SELECT CREATE_DATE, VS_ITEM, VS_PART, VS_RECORD, VS_MEMO,VS_REASON  "
                               + " FROM ( "
                               + "     SELECT CREATE_DATE, VS_ITEM, VS_PART, VS_RECORD, VS_MEMO,VS_REASON, "
                               + "     ROW_NUMBER() OVER(PARTITION BY t.VS_ITEM ORDER BY t.CREATE_DATE) NUM "
                               + "     FROM DATA_VITALSIGN t "
                               + "     WHERE FEE_NO = '" + babyFeeNo.Rows[0]["BABY_FEE_NO"] + "' "
                               + "     AND CREATE_DATE >= to_date('" + patientInfo.Birthday.AddDays(-1).ToString("yyyy/MM/dd HH:mm:ss") + "','yyyy/MM/dd hh24:mi:ss') "
                               + "     AND CREATE_DATE <= to_date('" + patientInfo.Birthday.AddDays(+1).ToString("yyyy/MM/dd HH:mm:ss") + "','yyyy/MM/dd hh24:mi:ss') "
                               + "     ORDER BY CREATE_DATE ) MAIN "
                               + " WHERE MAIN.NUM = 1 ";
                                Temp = new List<Dictionary<string, string>>();
                                dt_check = null;

                                Dt2 = link.DBExecSQL(sql);
                                if (Dt2.Rows.Count > 0)
                                {
                                    for (int i = 0; i < Dt2.Rows.Count; i++)
                                    {
                                        var temp = new Dictionary<string, string>();
                                        temp["CREATE_DATE"] = Dt2.Rows[i]["CREATE_DATE"].ToString();
                                        temp["VS_ITEM"] = Dt2.Rows[i]["VS_ITEM"].ToString();
                                        temp["VS_PART"] = Dt2.Rows[i]["VS_PART"].ToString();
                                        temp["VS_REASON"] = Dt2.Rows[i]["VS_REASON"].ToString();
                                        temp["VS_RECORD"] = Dt2.Rows[i]["VS_RECORD"].ToString();
                                        temp["VS_MEMO"] = Dt2.Rows[i]["VS_MEMO"].ToString();
                                        Temp.Add(temp);
                                    }
                                }

                                if (Temp.Count > 0)
                                {
                                    List<Dictionary<string, string>> VitalSignList = new List<Dictionary<string, string>>();

                                    #region 體溫
                                    VitalSignList = Temp.FindAll(x => x["VS_ITEM"] == "bt" && !string.IsNullOrEmpty(x["VS_RECORD"]));
                                    dt_check = Get_Check_Abnormal_dt();
                                    string color = "black";
                                    if (VitalSignList.Count > 0)
                                    {
                                        for (int i = 0; i < 1; i++)
                                        {
                                            color = "black";
                                            string l_check = "btl_e", h_check = "bth_e";
                                            string ck_value = VitalSignList[i]["VS_RECORD"], part = VitalSignList[i]["VS_PART"];
                                            if (part == "腋溫")
                                            {
                                                l_check = "btl_a";
                                                h_check = "bth_a";
                                            }
                                            else if (part == "肛溫")
                                            {
                                                l_check = "btl_r";
                                                h_check = "bth_r";
                                            }
                                            else if (part == "額溫")
                                            {
                                                l_check = "btl_f";
                                                h_check = "bth_f";
                                            }
                                            string measure = VitalSignList[i]["VS_REASON"];
                                            foreach (DataRow r in dt_check.Rows)
                                            {
                                                if (measure == "測不到")
                                                {
                                                    color = "red";
                                                }
                                                else
                                                {
                                                    if (r["MODEL_ID"].ToString() == l_check || r["MODEL_ID"].ToString() == h_check)
                                                    {
                                                        if (r["DECIDE"].ToString() == ">")
                                                        {
                                                            if (double.Parse(ck_value) > double.Parse(r["VALUE_LIMIT"].ToString()))
                                                            {
                                                                color = "red";
                                                            }
                                                        }
                                                        else if (r["DECIDE"].ToString() == "<")
                                                        {
                                                            if (double.Parse(ck_value) < double.Parse(r["VALUE_LIMIT"].ToString()))
                                                            {
                                                                color = "blue";
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            TPR = TPR.Replace("#T#", VitalSignList[i]["VS_RECORD"] + "℃");
                                        }
                                    }
                                    #endregion

                                    #region 脈搏
                                    VitalSignList = Temp.FindAll(x => x["VS_ITEM"] == "mp" && !string.IsNullOrEmpty(x["VS_RECORD"]));
                                    if (VitalSignList.Count > 0)
                                    {
                                        for (int i = 0; i < 1; i++)
                                        {
                                            color = "black";
                                            string ck_value = VitalSignList[i]["VS_RECORD"], part = VitalSignList[i]["VS_PART"];
                                            string measure = VitalSignList[i]["VS_REASON"];
                                            foreach (DataRow r in dt_check.Rows)
                                            {
                                                if (measure == "測不到")
                                                {
                                                    color = "red";
                                                }
                                                else
                                                {
                                                    if (r["MODEL_ID"].ToString() == "mpl_" + type || r["MODEL_ID"].ToString() == "mph_" + type)
                                                    {
                                                        if (r["DECIDE"].ToString() == ">")
                                                        {
                                                            if (double.Parse(ck_value) > double.Parse(r["VALUE_LIMIT"].ToString()))
                                                            {
                                                                color = "red";
                                                            }
                                                        }
                                                        else if (r["DECIDE"].ToString() == "<")
                                                        {
                                                            if (double.Parse(ck_value) < double.Parse(r["VALUE_LIMIT"].ToString()))
                                                            {
                                                                color = "blue";
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            TPR = TPR.Replace("#P#", VitalSignList[i]["VS_RECORD"] + "次/分");
                                        }
                                    }

                                    #endregion

                                    #region 呼吸
                                    VitalSignList = Temp.FindAll(x => x["VS_ITEM"] == "bf" && !string.IsNullOrEmpty(x["VS_RECORD"]));
                                    if (VitalSignList.Count > 0)
                                    {
                                        for (int i = 0; i < 1; i++)
                                        {
                                            color = "black";
                                            string ck_value = VitalSignList[i]["VS_RECORD"], part = VitalSignList[i]["VS_PART"];
                                            string measure = VitalSignList[i]["VS_REASON"];
                                            foreach (DataRow r in dt_check.Rows)
                                            {
                                                if (measure == "測不到")
                                                {
                                                    color = "red";
                                                }
                                                else
                                                {
                                                    if (r["MODEL_ID"].ToString() == "bfl_" + type || r["MODEL_ID"].ToString() == "bfh_" + type)
                                                    {
                                                        if (r["DECIDE"].ToString() == ">")
                                                        {
                                                            if (double.Parse(ck_value) > double.Parse(r["VALUE_LIMIT"].ToString()))
                                                            {
                                                                color = "red";
                                                            }
                                                        }
                                                        else if (r["DECIDE"].ToString() == "<")
                                                        {
                                                            if (double.Parse(ck_value) < double.Parse(r["VALUE_LIMIT"].ToString()))
                                                            {
                                                                color = "blue";
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            TPR = TPR.Replace("#R#", VitalSignList[i]["VS_RECORD"] + "次/分");
                                        }
                                    }
                                    #endregion
                                }
                                #endregion
                                r_nb["TPR"] = TPR.Replace("#T#", "無").Replace("#P#", "無").Replace("#R#", "無");
                            }
                        }

                        if (r_nb["CREATNO"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r_nb["CREATNO"].ToString());
                            if (listByteCode == null)
                                r_nb["CREATNO_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r_nb["CREATNO_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r_nb["CREATNO_2"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r_nb["CREATNO_2"].ToString());
                            if (listByteCode == null)
                                r_nb["CREATNO_2_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r_nb["CREATNO_2_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r_nb["DIRECTOR"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r_nb["DIRECTOR"].ToString());
                            if (listByteCode == null)
                                r_nb["DIRECTOR_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r_nb["DIRECTOR_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r_nb["RB_AS_1_WHO"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r_nb["RB_AS_1_WHO"].ToString());
                            if (listByteCode == null)
                                r_nb["RB_AS_1_WHO_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r_nb["RB_AS_1_WHO_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r_nb["RB_AS_5_WHO"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r_nb["RB_AS_5_WHO"].ToString());
                            if (listByteCode == null)
                                r_nb["RB_AS_5_WHO_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r_nb["RB_AS_5_WHO_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r_nb["RB_AS_10_WHO"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r_nb["RB_AS_10_WHO"].ToString());
                            if (listByteCode == null)
                                r_nb["RB_AS_10_WHO_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r_nb["RB_AS_10_WHO_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r_nb["RB_AS_OTH_WHO"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r_nb["RB_AS_OTH_WHO"].ToString());
                            if (listByteCode == null)
                                r_nb["RB_AS_OTH_WHO_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r_nb["RB_AS_OTH_WHO_NAME"] = user_name.EmployeesName;
                            }
                        }
                    }
                }
                else
                {
                    Response.Write("<script>alert('請先新增新生兒出生紀錄!');window.close();</script>");
                    return new EmptyResult();
                }
                ViewBag.dt_nb = set_dt(dt_nb);
                #endregion

                #region 第二、三產程
                DataTable dt_sta = obs_m.sel_bthsta(fee_no);
                dt_sta.Columns.Add("PHYSICIAN_1_NAME");
                dt_sta.Columns.Add("PHYSICIAN_2_NAME");
                dt_sta.Columns.Add("CLNURSE_1_NAME");
                dt_sta.Columns.Add("CLNURSE_2_NAME");
                dt_sta.Columns.Add("SRNURSE_1_NAME");
                dt_sta.Columns.Add("SRNURSE_2_NAME");
                dt_sta.Columns.Add("NNP_1_NAME");
                dt_sta.Columns.Add("NNP_2_NAME");
                if (dt_sta != null && dt_sta.Rows.Count > 0)
                {
                    DataRow sta_rows = dt_sta.Rows[0];
                    if (sta_rows["BIRTH"].ToString() != "" && sta_rows["RFM_TIME"].ToString() != "")
                    {
                        var GRuptureTime = Convert.ToDateTime(sta_rows["BIRTH"]).Subtract(Convert.ToDateTime(sta_rows["RFM_TIME"]));
                        ViewBag.GRuptureTime = ((int)GRuptureTime.TotalHours).ToString() + "小時" + GRuptureTime.Minutes.ToString() + "分";
                    }

                    foreach (DataRow r in dt_sta.Rows)
                    {
                        if (r["PHYSICIAN_1"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["PHYSICIAN_1"].ToString());
                            if (listByteCode == null)
                                r["PHYSICIAN_1_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["PHYSICIAN_1_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["PHYSICIAN_2"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["PHYSICIAN_2"].ToString());
                            if (listByteCode == null)
                                r["PHYSICIAN_2_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["PHYSICIAN_2_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["CLNURSE_1"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["CLNURSE_1"].ToString());
                            if (listByteCode == null)
                                r["CLNURSE_1_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["CLNURSE_1_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["CLNURSE_2"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["CLNURSE_2"].ToString());
                            if (listByteCode == null)
                                r["CLNURSE_2_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["CLNURSE_2_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["SRNURSE_1"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["SRNURSE_1"].ToString());
                            if (listByteCode == null)
                                r["SRNURSE_1_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["SRNURSE_1_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["SRNURSE_2"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["SRNURSE_2"].ToString());
                            if (listByteCode == null)
                                r["SRNURSE_2_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["SRNURSE_2_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["NNP_1"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["NNP_1"].ToString());
                            if (listByteCode == null)
                                r["NNP_1_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["NNP_1_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["NNP_2"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["NNP_2"].ToString());
                            if (listByteCode == null)
                                r["NNP_2_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["NNP_2_NAME"] = user_name.EmployeesName;
                            }
                        }
                    }
                }
                else
                {
                    Response.Write("<script>alert('請先新增二、三產程!');window.close();</script>");
                    return new EmptyResult();
                }
                ViewBag.dt_sta = set_dt(dt_sta);
                #endregion

                #region 媽媽生命徵象
                sql = "SELECT CREATE_DATE, VS_ITEM, VS_PART, VS_RECORD, VS_MEMO,VS_REASON  "
                          + " FROM ( "
                          + "     SELECT CREATE_DATE, VS_ITEM, VS_PART, VS_RECORD, VS_MEMO,VS_REASON, "
                          + "     ROW_NUMBER() OVER(PARTITION BY t.VS_ITEM ORDER BY t.CREATE_DATE desc) NUM "
                          + "     FROM DATA_VITALSIGN t "
                          + "     WHERE FEE_NO = '" + fee_no + "' "
                          + "     AND VS_ITEM = 'bt' "
                          + "     AND CREATE_DATE >= to_date('" + DateTime.Now.AddDays(-1).ToString("yyyy/MM/dd HH:mm:ss") + "','yyyy/MM/dd hh24:mi:ss') "
                          + "     ORDER BY CREATE_DATE DESC ) MAIN "
                          + "";
                Temp = new List<Dictionary<string, string>>();
                dt_check = null;

                Dt2 = link.DBExecSQL(sql);
                if (Dt2.Rows.Count > 0)
                {
                    for (int i = 0; i < Dt2.Rows.Count; i++)
                    {
                        var temp = new Dictionary<string, string>();
                        temp["CREATE_DATE"] = Dt2.Rows[i]["CREATE_DATE"].ToString();
                        temp["VS_ITEM"] = Dt2.Rows[i]["VS_ITEM"].ToString();
                        temp["VS_PART"] = Dt2.Rows[i]["VS_PART"].ToString();
                        temp["VS_REASON"] = Dt2.Rows[i]["VS_REASON"].ToString();
                        temp["VS_RECORD"] = Dt2.Rows[i]["VS_RECORD"].ToString();
                        temp["VS_MEMO"] = Dt2.Rows[i]["VS_MEMO"].ToString();
                        Temp.Add(temp);
                    }
                }

                if (Temp.Count > 0)
                {
                    int rownum = 3;
                    List<Dictionary<string, string>> VitalSignList = new List<Dictionary<string, string>>();

                    VitalSignList = Temp.FindAll(x => x["VS_ITEM"] == "bt" && !string.IsNullOrEmpty(x["VS_RECORD"]) && Convert.ToDecimal(x["VS_RECORD"].ToString()) >= 38);
                    dt_check = Get_Check_Abnormal_dt();
                    string color = "black";
                    if (VitalSignList.Count > 0)
                    {
                        for (int i = 0; i < ((VitalSignList.Count < rownum) ? VitalSignList.Count : rownum); i++)
                        {
                            color = "black";
                            string l_check = "btl_e", h_check = "bth_e";
                            string ck_value = VitalSignList[i]["VS_RECORD"], part = VitalSignList[i]["VS_PART"];
                            if (part == "腋溫")
                            {
                                l_check = "btl_a";
                                h_check = "bth_a";
                            }
                            else if (part == "肛溫")
                            {
                                l_check = "btl_r";
                                h_check = "bth_r";
                            }
                            else if (part == "額溫")
                            {
                                l_check = "btl_f";
                                h_check = "bth_f";
                            }
                            string measure = VitalSignList[i]["VS_REASON"];
                            foreach (DataRow r in dt_check.Rows)
                            {
                                if (measure == "測不到")
                                {
                                    color = "red";
                                }
                                else
                                {
                                    if (r["MODEL_ID"].ToString() == l_check || r["MODEL_ID"].ToString() == h_check)
                                    {
                                        if (r["DECIDE"].ToString() == ">")
                                        {
                                            if (double.Parse(ck_value) > double.Parse(r["VALUE_LIMIT"].ToString()))
                                            {
                                                color = "red";
                                            }
                                        }
                                        else if (r["DECIDE"].ToString() == "<")
                                        {
                                            if (double.Parse(ck_value) < double.Parse(r["VALUE_LIMIT"].ToString()))
                                            {
                                                color = "blue";
                                            }
                                        }
                                    }
                                }
                            }

                            if (measure == "測不到")
                                continue;
                            else
                                ViewBag.Mom_Temporary += string.Format("{0}<label class='LittleTitle'>：</label>{1}。"
                                    , Convert.ToDateTime(VitalSignList[i]["CREATE_DATE"].ToString()).ToString("yyyy/MM/dd HH:mm")
                                    , VitalSignList[i]["VS_RECORD"] + "℃");
                        }
                    }
                }
                #endregion

                ViewBag.chartNo = ptinfo.ChartNo;
                ViewBag.BedNo = ptinfo.BedNo;
            }
            Session["PatInfo"] = ptinfo;

            return View();
        }
        #endregion


        #region 產後護理紀錄畫面
        public ActionResult Postnatal_Record_List(string feeno, string chartno, bool Kardex = false, bool IsHisView = false)
        {
            ViewBag.IsHisView = IsHisView;

            if (IsHisView)
            {
                his.ControllerContext = ControllerContext;
                his.getSession(feeno);
            }

            if (Session["PatInfo"] != null)
            {
                if (feeno == "" || feeno == null)
                    feeno = ptinfo.FeeNo;

                ViewBag.Kardex = Kardex;

                DataTable dt = obs_m.sel_aft_bth(feeno, "");
                dt.Columns.Add("UPDNO_NAME");
                if (dt != null && dt.Rows.Count > 0)
                {
                    foreach (DataRow r in dt.Rows)
                    {
                        if (r["UPDNO"].ToString() != "")
                        {
                            byte[] listByteCode = webService.UserName(r["UPDNO"].ToString());
                            if (listByteCode == null)
                                r["UPDNO_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["UPDNO_NAME"] = user_name.EmployeesName;
                            }
                        }
                    }
                }
                //藥物調配
                dt.Columns.Add("AB_DISP");
                foreach (DataRow r in dt.Rows)
                {
                    // 抓取藥物調配
                    DataTable dt_Ab_Disp = obs_m.sel_ab_disp(feeno, r["IID"].ToString());
                    dt_Ab_Disp.Columns.Add("TM_MED_SPEED");

                    var result = "";
                    foreach (DataRow r_Ab in dt_Ab_Disp.Rows)
                    {
                        if (r_Ab["TM_MED_USE_STAT"].ToString() != "")
                        {
                            if (r_Ab["TM_MED_A"].ToString() != "")
                                result += $"{r_Ab["TM_MED_A"]}/{r_Ab["TM_MED_A_AMT"]}";

                            if (r_Ab["TM_MED_B"].ToString() != "")
                                result += $"<br/>{r_Ab["TM_MED_B"]}/{r_Ab["TM_MED_B_AMT"]}";

                            if (r_Ab["TM_MED_USE"].ToString() != "")
                                result += $"<br/>總用量：{r_Ab["TM_MED_USE"]}";

                            //抓取每筆藥物調配的最新流速
                            DataTable dt_Ab_Disp_Dtl = obs_m.sel_ab_disp_detail(feeno, r["IID"].ToString(), r_Ab["SNOM"].ToString());
                            if (dt_Ab_Disp_Dtl.Rows.Count > 0)
                                result += $"<br/>流速：{dt_Ab_Disp_Dtl.Rows[0]["TM_MED_SPEED"]}";
                            else
                                result += $"<br/>流速：";

                            if (r_Ab["TM_MED_USE_STAT"].ToString() != "" && r_Ab["TM_MED_USE_STAT"].ToString() == "0")
                            {
                                result += $"<br/>狀態：啟用<br/>";
                            }
                            if (r_Ab["TM_MED_USE_STAT"].ToString() != "" && r_Ab["TM_MED_USE_STAT"].ToString() == "1")
                            {
                                result += $"<br/>狀態：停止<br/>";
                            }
                            if (r_Ab["TM_MED_USE_STAT"].ToString() != "" && r_Ab["TM_MED_USE_STAT"].ToString() == "2")
                            {
                                result += $"<br/>狀態：一次性給藥<br/>";
                            }
                        }
                    }
                    r["AB_DISP"] = result;
                }
                ViewBag.dt = set_dt(dt);

                DataTable vy_dt = obs_m.sel_vagyarn(feeno);
                if (vy_dt != null)
                {
                    var sum = 0;
                    foreach (DataRow r in vy_dt.Rows)
                    {
                        if (r["PUTIN_AMT"].ToString() != "")
                            sum += Convert.ToInt32(r["PUTIN_AMT"].ToString());
                        if (r["TAKEOUT_AMT"].ToString() != "")
                            sum -= Convert.ToInt32(r["TAKEOUT_AMT"].ToString());
                    }
                    ViewBag.vy_sum = sum;
                    ViewBag.vy = true;
                }
                else
                {
                    ViewBag.vy = false;
                }


                DataTable dtBthsta = obs_m.sel_bthsta(feeno);
                if (dtBthsta != null && dtBthsta.Rows.Count > 0)
                {
                    var staRow = dtBthsta.Rows[0];
                    if (staRow["BIRTH"].ToString() != "")
                    {
                        var birthType = staRow["BIRTH_TYPE"].ToString() == "0" ? "自然產" : "剖腹產";

                        var timenow = Convert.ToDateTime(DateTime.Now.ToString("yyyy/MM/dd"));
                        var birth = Convert.ToDateTime(Convert.ToDateTime(staRow["BIRTH"].ToString()).ToString("yyyy/MM/dd"));
                        var timediff = timenow - birth;

                        if (timediff.TotalDays == 0)
                        {
                            if (staRow["BIRTH_TYPE"].ToString() == "0")
                            {
                                ViewBag.Description = "生產日";
                            }
                            else
                            {
                                ViewBag.Description = "手術日(生產日)";
                            }
                        }
                        else
                        {
                            ViewBag.Description = $"{birthType}第{timediff.TotalDays}天";
                        }
                    }
                }
                ViewBag.feeno = feeno;
                return View();
            }
            Response.Write("<script>alert('請重新選擇病患');</script>");
            return new EmptyResult();
        }
        #endregion

        #region 新增/編輯產後護理紀錄 畫面
        /// <summary>
        /// 新增/編輯產後護理紀錄 畫面
        /// </summary>
        /// <returns></returns>
        public ActionResult Insert_Postnatal_Record(string del_ID)
        {
            DataTable dtsta = obs_m.sel_bthsta(ptinfo?.FeeNo);
            if (dtsta == null || dtsta.Rows.Count == 0)
            {
                Response.Write("<script>alert('新增失敗，請先新增二、三產程資料!');window.opener.location.href='Index?active=Postnatal_Record_List&show=Y';window.close();</script>");
                return new EmptyResult();
            }

            if (IsNoEmpty(del_ID))
            {
                DataTable dt = obs_m.sel_aft_bth(ptinfo.FeeNo, del_ID);
                if (dt != null && dt.Rows.Count > 0)
                {
                    foreach (DataRow r in dt.Rows)
                    {
                        if (r["UPDNO"].ToString().Trim() != userinfo.EmployeesNo)
                        {
                            Response.Write("<script>alert('無權限修改!');window.close();</script>");
                            return new EmptyResult();
                        }
                    }
                }
                // 抓取藥物調配
                DataTable dt_Ab_Disp = obs_m.sel_ab_disp(ptinfo.FeeNo, del_ID);
                dt_Ab_Disp.Columns.Add("TM_MED_SPEED");
                foreach (DataRow r_Ab in dt_Ab_Disp.Rows)
                {
                    //抓取每筆藥物調配的最新流速
                    DataTable dt_Ab_Disp_Dtl = obs_m.sel_ab_disp_detail(ptinfo.FeeNo, del_ID, r_Ab["SNOM"].ToString());
                    if (dt_Ab_Disp_Dtl != null && dt_Ab_Disp_Dtl.Rows.Count > 0)
                        r_Ab["TM_MED_SPEED"] = dt_Ab_Disp_Dtl.Rows[0]["TM_MED_SPEED"];
                    else
                        r_Ab["TM_MED_SPEED"] = "";
                }
                ViewBag.dt = set_dt(dt);
                ViewBag.dt_Ab_Disp = set_dt(dt_Ab_Disp);
            }
            else
            {
                DataTable dt = obs_m.sel_aft_bth(ptinfo.FeeNo, "");
                if (dt != null && dt.Rows.Count > 0)
                {
                    var first = dt.Rows[0];
                    // 抓取藥物調配
                    DataTable dt_Ab_Disp = obs_m.sel_ab_disp(ptinfo.FeeNo, first["IID"].ToString(), "", true);
                    dt_Ab_Disp.Columns.Add("TM_MED_SPEED");
                    foreach (DataRow r_Ab in dt_Ab_Disp.Rows)
                    {
                        //抓取每筆藥物調配的最新流速
                        DataTable dt_Ab_Disp_Dtl = obs_m.sel_bp_disp_detail(ptinfo.FeeNo, del_ID, r_Ab["SNOM"].ToString());
                        if (dt_Ab_Disp_Dtl != null && dt_Ab_Disp_Dtl.Rows.Count > 0)
                            r_Ab["TM_MED_SPEED"] = dt_Ab_Disp_Dtl.Rows[0]["TM_MED_SPEED"];
                        else
                            r_Ab["TM_MED_SPEED"] = "";
                    }
                    ViewBag.dt_new = set_dt(dt);
                    ViewBag.dtAb_Disp_new = set_dt(dt_Ab_Disp);
                }
            }
            return View();
        }
        #endregion

        #region 新增產後護理紀錄
        /// <summary>
        /// 新增產後護理紀錄
        /// </summary>
        /// <param name="form"></param>
        /// <returns></returns>
        [HttpPost]
        public ActionResult Insert_Postnatal_Record(FormCollection form)
        {
            link.DBOpen();

            DataTable dtsta = obs_m.sel_bthsta(ptinfo?.FeeNo);
            if (dtsta == null || dtsta.Rows.Count == 0)
            {
                Response.Write("<script>alert('新增失敗，請先新增二、三產程資料!');window.opener.location.href='Index?active=Postnatal_Record_List&show=Y';window.close();</script>");
                return new EmptyResult();
            }

            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo.FeeNo;
            string id = base.creatid("OBS_AFTBTH", userno, feeno, "0");

            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("IID", id, DBItem.DBDataType.String)); //流水號
            insertDataList.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String)); //批價序號
            insertDataList.Add(new DBItem("UPDNO", userno, DBItem.DBDataType.String)); //評估者員編
            insertDataList.Add(new DBItem("UPDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
            insertDataList.Add(new DBItem("RECORDTIME", form["TXT_RECORDTIME_DAY"] + " " + form["TXT_RECORDTIME_TIME"], DBItem.DBDataType.DataTime));//紀錄時間

            //子宮硬度
            insertDataList.Add(new DBItem("UTERUS_SHRINK", form["RB_UTERUS_SHRINK"], DBItem.DBDataType.String));
            //子宮高度
            var UTERUS_HEIGHT = form["RB_UTERUS_HEIGHT"];
            insertDataList.Add(new DBItem("UTERUS_HEIGHT", UTERUS_HEIGHT, DBItem.DBDataType.String));
            if (UTERUS_HEIGHT == "8")
                insertDataList.Add(new DBItem("UTERUS_HEIGHT_OTH", form["TXT_UTERUS_HEIGHT_OTH"], DBItem.DBDataType.String));
            else
                insertDataList.Add(new DBItem("UTERUS_HEIGHT_OTH", null, DBItem.DBDataType.String));

            //惡露量
            insertDataList.Add(new DBItem("LOCHIA", form["TXT_LOCHIA"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("LOCHIA_STAT", form["RB_LOCHIA_STAT"], DBItem.DBDataType.String));
            //惡露色
            var LOCHIA_COLOR = form["RB_LOCHIA_COLOR"];
            insertDataList.Add(new DBItem("LOCHIA_COLOR", LOCHIA_COLOR, DBItem.DBDataType.String));
            if (LOCHIA_COLOR == "3")
                insertDataList.Add(new DBItem("LOCHIA_COLOR_OTH", form["TXT_LOCHIA_COLOR_OTH"], DBItem.DBDataType.String));
            else
                insertDataList.Add(new DBItem("LOCHIA_COLOR_OTH", null, DBItem.DBDataType.String));


            PERINEUM PERINEUM = new PERINEUM();
            PERINEUM.PERINEUM_RANGE = ""; PERINEUM.PERINEUM_RED = ""; PERINEUM.PERINEUM_SWOLLEN = "";
            PERINEUM.SWOLLEN_RANGE = ""; PERINEUM.PERINEUM_BRUISE = "";
            PERINEUM.PERINEUM_SECRETION = "";

            //會陰傷口紅
            insertDataList.Add(new DBItem("EPWOUND_RED", form["RB_EPWOUND_RED"], DBItem.DBDataType.String));
            if (form["RB_EPWOUND_RED"] == "0")
                PERINEUM.PERINEUM_RED = "無";
            else if (form["RB_EPWOUND_RED"] == "1")
                PERINEUM.PERINEUM_RED = "傷口周圍邊緣 < 0.25公分";
            else if (form["RB_EPWOUND_RED"] == "2")
                PERINEUM.PERINEUM_RED = "傷口周圍邊緣 < 0.5公分";
            else if (form["RB_EPWOUND_RED"] == "3")
                PERINEUM.PERINEUM_RED = "傷口周圍邊緣 > 0.5公分";

            //會陰傷口水腫
            insertDataList.Add(new DBItem("EPWOUND_EDEMA", form["RB_EPWOUND_EDEMA"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("EPWOUND_EDEMA_AREA", form["TXT_EPWOUND_EDEMA_AREA"], DBItem.DBDataType.String));

            if (form["RB_EPWOUND_EDEMA"] == "0")
                PERINEUM.PERINEUM_SWOLLEN = "無";
            else if (form["RB_EPWOUND_EDEMA"] == "1")
                PERINEUM.PERINEUM_SWOLLEN = "會陰處 < 1公分";
            else if (form["RB_EPWOUND_EDEMA"] == "2")
                PERINEUM.PERINEUM_SWOLLEN = "會陰處 1-2公分";
            else if (form["RB_EPWOUND_EDEMA"] == "3")
                PERINEUM.PERINEUM_SWOLLEN = "會陰處 > 2公分";

            PERINEUM.SWOLLEN_RANGE = form["TXT_EPWOUND_EDEMA_AREA"];

            //會陰傷口瘀血
            insertDataList.Add(new DBItem("EPWOUND_ECC", form["RB_EPWOUND_ECC"], DBItem.DBDataType.String));

            if (form["RB_EPWOUND_ECC"] == "0")
                PERINEUM.PERINEUM_BRUISE = "無";
            else if (form["RB_EPWOUND_ECC"] == "1")
                PERINEUM.PERINEUM_BRUISE = "傷口兩側 < 0.25公分";
            else if (form["RB_EPWOUND_ECC"] == "2")
                PERINEUM.PERINEUM_BRUISE = "傷口兩側 0.25-1公分";
            else if (form["RB_EPWOUND_ECC"] == "3")
                PERINEUM.PERINEUM_BRUISE = "傷口兩側 > 1公分";
            else if (form["RB_EPWOUND_ECC"] == "4")
                PERINEUM.PERINEUM_BRUISE = "左側 < 0.5公分";
            else if (form["RB_EPWOUND_ECC"] == "5")
                PERINEUM.PERINEUM_BRUISE = "左側 0.5-2公分";
            else if (form["RB_EPWOUND_ECC"] == "6")
                PERINEUM.PERINEUM_BRUISE = "左側 > 2公分";
            else if (form["RB_EPWOUND_ECC"] == "7")
                PERINEUM.PERINEUM_BRUISE = "右側 < 0.5公分";
            else if (form["RB_EPWOUND_ECC"] == "8")
                PERINEUM.PERINEUM_BRUISE = "右側 0.5-2公分";
            else if (form["RB_EPWOUND_ECC"] == "9")
                PERINEUM.PERINEUM_BRUISE = "右側 > 2公分";

            //會陰傷口分泌物
            insertDataList.Add(new DBItem("EPWOUND_DISC", form["RB_EPWOUND_DISC"], DBItem.DBDataType.String));
            if (form["RB_EPWOUND_DISC"] == "0")
                PERINEUM.PERINEUM_SECRETION = "無";
            else if (form["RB_EPWOUND_DISC"] == "1")
                PERINEUM.PERINEUM_SECRETION = "漿液性";
            else if (form["RB_EPWOUND_DISC"] == "2")
                PERINEUM.PERINEUM_SECRETION = "漿液性及血濃性";
            else if (form["RB_EPWOUND_DISC"] == "3")
                PERINEUM.PERINEUM_SECRETION = "血濃性";

            //會陰傷口傷口邊緣
            insertDataList.Add(new DBItem("EPWOUND_APPR", form["RB_EPWOUND_APPR"], DBItem.DBDataType.String));
            if (form["RB_EPWOUND_APPR"] == "0")
                PERINEUM.PERINEUM_RANGE = "密合";
            else if (form["RB_EPWOUND_APPR"] == "1")
                PERINEUM.PERINEUM_RANGE = "皮膚裂縫< 0.3公分";
            else if (form["RB_EPWOUND_APPR"] == "2")
                PERINEUM.PERINEUM_RANGE = "皮膚和皮下脂肪有裂縫";
            else if (form["RB_EPWOUND_APPR"] == "3")
                PERINEUM.PERINEUM_RANGE = "皮膚、皮下脂肪、筋膜層裂開";

            AddWoundRecordData("0", dtsta.Rows[0]["IID"].ToString() + "0", id + "0", form["TXT_RECORDTIME_DAY"] + " " + form["TXT_RECORDTIME_TIME"], PERINEUM);

            ABD ABD = new ABD();
            ABD.range_YN = ""; ABD.RANGE_HEIGHT = ""; ABD.RANGE_WIDTH = "";
            ABD.RANGE_DEPTH = ""; ABD.EXTERIOR = ""; ABD.EXTERIOR_OTHER = "";
            ABD.exudate_YN = ""; ABD.EXUDATE_AMOUNT = ""; ABD.EXUDATE_NATURE = "";
            ABD.EXUDATE_NATURE_OTHER = ""; ABD.EXUDATE_COLOR = ""; ABD.EXUDATE_COLOR_OTHER = "";
            ABD.sutures_YN = ""; ABD.pin = ""; ABD.handle_YN = "";
            ABD.handle_item = ""; ABD.handle_other = "";

            //腹部傷口範圍
            var ABD_AREA = form["RB_ABD_AREA"];
            insertDataList.Add(new DBItem("ABD_AREA", ABD_AREA, DBItem.DBDataType.String));
            if (ABD_AREA == "0")
            {
                ABD.range_YN = "是";
                ABD.RANGE_HEIGHT = form["TXT_ABD_AREA_H"];
                ABD.RANGE_WIDTH = form["TXT_ABD_AREA_W"];
                ABD.RANGE_DEPTH = form["TXT_ABD_AREA_L"];

                insertDataList.Add(new DBItem("ABD_AREA_L", form["TXT_ABD_AREA_L"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("ABD_AREA_W", form["TXT_ABD_AREA_W"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("ABD_AREA_H", form["TXT_ABD_AREA_H"], DBItem.DBDataType.String));
            }
            else if (ABD_AREA == "1")
            {
                ABD.range_YN = "否";

                insertDataList.Add(new DBItem("ABD_AREA_L", null, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("ABD_AREA_W", null, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("ABD_AREA_H", null, DBItem.DBDataType.String));
            }
            //腹部傷口外觀
            var ABD_FEA = form["CK_ABD_FEA"];
            var ABD_FEAV = new List<string>() { "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0" };
            var FEA_Reason = new List<string>();
            if (ABD_FEA == null)
            {
                insertDataList.Add(new DBItem("ABD_FEA", String.Join("", ABD_FEAV), DBItem.DBDataType.String));
            }
            else
            {
                var ABD_FEA_SP = ABD_FEA.Split(',');
                foreach (var v in ABD_FEA_SP)
                {
                    ABD_FEAV[Convert.ToInt32(v)] = "1";
                    if (v == "0")
                        FEA_Reason.Add("紅");
                    if (v == "1")
                        FEA_Reason.Add("腫");
                    if (v == "2")
                        FEA_Reason.Add("硬結");
                    if (v == "3")
                        FEA_Reason.Add("浸潤變軟");
                    if (v == "4")
                        FEA_Reason.Add("色素沉著");
                    if (v == "5")
                        FEA_Reason.Add("水腫");
                    if (v == "6")
                        FEA_Reason.Add("過度角化");
                    if (v == "7")
                        FEA_Reason.Add("皮膚壞死呈現黑色");
                    if (v == "8")
                        FEA_Reason.Add("皮膚壞死呈現暗紫色");
                    if (v == "9")
                        FEA_Reason.Add("組織增生");
                    if (v == "10")
                        FEA_Reason.Add("其他");
                    if (v == "11")
                        FEA_Reason.Add("正常");
                }
                insertDataList.Add(new DBItem("ABD_FEA", String.Join("", ABD_FEAV), DBItem.DBDataType.String));
            }
            ABD.EXTERIOR = String.Join("|", FEA_Reason);

            if (ABD_FEAV[10] == "1")
            {
                insertDataList.Add(new DBItem("ABD_FEA_OTH", form["TXT_ABD_FEA_OTH"], DBItem.DBDataType.String));
                ABD.EXTERIOR_OTHER = form["TXT_ABD_FEA_OTH"];
            }
            else
                insertDataList.Add(new DBItem("ABD_FEA_OTH", null, DBItem.DBDataType.String));

            //腹部傷口滲出液
            var ABD_EXU = form["RB_ABD_EXU"];
            insertDataList.Add(new DBItem("ABD_EXU", ABD_EXU, DBItem.DBDataType.String));
            if (ABD_EXU == "1")
            {
                ABD.exudate_YN = "有";

                //滲出物量
                insertDataList.Add(new DBItem("ABD_EXU_AMT", form["RB_ABD_EXU_AMT"], DBItem.DBDataType.String));

                if (form["RB_ABD_EXU_AMT"] == "0")
                    ABD.EXUDATE_AMOUNT = "少";
                else if (form["RB_ABD_EXU_AMT"] == "1")
                    ABD.EXUDATE_AMOUNT = "中";
                else if (form["RB_ABD_EXU_AMT"] == "2")
                    ABD.EXUDATE_AMOUNT = "多";

                //性狀
                var ABD_EXU_TPE = form["CK_ABD_EXU_TPE"];
                var ABD_EXU_TPEV = new List<string>() { "0", "0", "0", "0", "0" };
                var EXU_TPE_Reason = new List<string>();
                if (ABD_EXU_TPE == null)
                    insertDataList.Add(new DBItem("ABD_EXU_TPE", String.Join("", ABD_EXU_TPEV), DBItem.DBDataType.String));
                else
                {
                    var ABD_EXU_TPE_SP = ABD_EXU_TPE.Split(',');
                    foreach (var i in ABD_EXU_TPE_SP)
                    {
                        ABD_EXU_TPEV[Convert.ToInt32(i)] = "1";
                        if (i == "0")
                            EXU_TPE_Reason.Add("漿液");
                        if (i == "1")
                            EXU_TPE_Reason.Add("血液");
                        if (i == "2")
                            EXU_TPE_Reason.Add("化膿");
                        if (i == "3")
                            EXU_TPE_Reason.Add("惡臭");
                        if (i == "4")
                            EXU_TPE_Reason.Add("其他");
                    }
                    insertDataList.Add(new DBItem("ABD_EXU_TPE", String.Join("", ABD_EXU_TPEV), DBItem.DBDataType.String));
                }

                ABD.EXUDATE_NATURE = String.Join("|", EXU_TPE_Reason);
                if (ABD_EXU_TPEV[4] == "1")
                {
                    ABD.EXUDATE_NATURE_OTHER = form["TXT_ABD_EXU_TPE_OTH"];
                    insertDataList.Add(new DBItem("ABD_EXU_TPE_OTH", form["TXT_ABD_EXU_TPE_OTH"], DBItem.DBDataType.String));
                }
                else
                    insertDataList.Add(new DBItem("ABD_EXU_TPE_OTH", null, DBItem.DBDataType.String));

                //顏色
                var ABD_EXU_COL = form["RB_ABD_EXU_COL"];
                insertDataList.Add(new DBItem("ABD_EXU_COL", ABD_EXU_COL, DBItem.DBDataType.String));
                if (ABD_EXU_COL == "12")
                {
                    ABD.EXUDATE_COLOR_OTHER = form["TXT_ABD_EXU_COL_OTH"];
                    insertDataList.Add(new DBItem("ABD_EXU_COL_OTH", form["TXT_ABD_EXU_COL_OTH"], DBItem.DBDataType.String));
                }
                else
                    insertDataList.Add(new DBItem("ABD_EXU_COL_OTH", null, DBItem.DBDataType.String));

                if (ABD_EXU_COL == "0")
                    ABD.EXUDATE_COLOR = "暗紅色";
                else if (ABD_EXU_COL == "1")
                    ABD.EXUDATE_COLOR = "紅色";
                else if (ABD_EXU_COL == "2")
                    ABD.EXUDATE_COLOR = "鮮紅色";
                else if (ABD_EXU_COL == "3")
                    ABD.EXUDATE_COLOR = "淡紅";
                else if (ABD_EXU_COL == "4")
                    ABD.EXUDATE_COLOR = "粉紅";
                else if (ABD_EXU_COL == "5")
                    ABD.EXUDATE_COLOR = "褐色";
                else if (ABD_EXU_COL == "6")
                    ABD.EXUDATE_COLOR = "黃褐";

                else if (ABD_EXU_COL == "7")
                    ABD.EXUDATE_COLOR = "黃綠";
                else if (ABD_EXU_COL == "8")
                    ABD.EXUDATE_COLOR = "黃色";
                else if (ABD_EXU_COL == "9")
                    ABD.EXUDATE_COLOR = "土黃";
                else if (ABD_EXU_COL == "10")
                    ABD.EXUDATE_COLOR = "白";
                else if (ABD_EXU_COL == "11")
                    ABD.EXUDATE_COLOR = "透明";
                else if (ABD_EXU_COL == "12")
                    ABD.EXUDATE_COLOR = "其他";
            }
            else if (ABD_EXU == "0")
            {
                ABD.exudate_YN = "無";
                insertDataList.Add(new DBItem("ABD_EXU_AMT", null, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("ABD_EXU_TPE", null, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("ABD_EXU_TPE_OTH", null, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("ABD_EXU_COL", null, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("ABD_EXU_COL_OTH", null, DBItem.DBDataType.String));
            }

            //腹部傷口是否有縫線
            var ABO_SUT = form["RB_ABO_SUT"];
            if (ABO_SUT == "0")
                ABD.sutures_YN = "無縫線";
            else if (ABO_SUT == "1")
                ABD.sutures_YN = "有縫線";
            else if (ABO_SUT == "2")
                ABD.sutures_YN = "縫線已拆";

            insertDataList.Add(new DBItem("ABO_SUT", ABO_SUT, DBItem.DBDataType.String));
            if (ABO_SUT == "1")
            {
                ABD.pin = form["TXT_ABO_SUT_N"];
                insertDataList.Add(new DBItem("ABO_SUT_N", form["TXT_ABO_SUT_N"], DBItem.DBDataType.String));
            }
            else
                insertDataList.Add(new DBItem("ABO_SUT_N", null, DBItem.DBDataType.String));

            //腹部傷口處置
            var ABO_TRT = form["RB_ABO_TRT"];
            insertDataList.Add(new DBItem("ABO_TRT", ABO_TRT, DBItem.DBDataType.String));
            if (ABO_TRT == "1")
            {
                ABD.handle_YN = "是";

                var ABO_TRT_M = form["CK_ABO_TRT_M"];
                var ABO_TRT_Reason = new List<string>();
                var ABO_TRT_MV = new List<string>() { "0", "0", "0", "0", "0", "0", "0" };
                if (ABO_TRT_M == null)
                    insertDataList.Add(new DBItem("ABO_TRT_M", String.Join("", ABO_TRT_MV), DBItem.DBDataType.String));
                else
                {
                    var ABO_TRT_M_SP = ABO_TRT_M.Split(',');
                    foreach (var i in ABO_TRT_M_SP)
                    {
                        ABO_TRT_MV[Convert.ToInt32(i)] = "1";
                        if (i == "0")
                            ABO_TRT_Reason.Add("CD");
                        if (i == "1")
                            ABO_TRT_Reason.Add("Wet");
                        if (i == "2")
                            ABO_TRT_Reason.Add("Iodoform");
                        if (i == "3")
                            ABO_TRT_Reason.Add("Port-A CD");
                        if (i == "4")
                            ABO_TRT_Reason.Add("導管引流");
                        if (i == "5")
                            ABO_TRT_Reason.Add("燙傷CD");
                        if (i == "6")
                            ABO_TRT_Reason.Add("其他");
                    }
                    insertDataList.Add(new DBItem("ABO_TRT_M", String.Join("", ABO_TRT_MV), DBItem.DBDataType.String));
                }

                ABD.handle_item = String.Join("|", ABO_TRT_Reason);
                if (ABO_TRT_MV[6] == "1")
                {
                    ABD.handle_other = form["TXT_ABO_TRT_M_OTH"];
                    insertDataList.Add(new DBItem("ABO_TRT_M_OTH", form["TXT_ABO_TRT_M_OTH"], DBItem.DBDataType.String));
                }
                else
                    insertDataList.Add(new DBItem("ABO_TRT_M_OTH", null, DBItem.DBDataType.String));
            }
            else if (ABO_TRT == "0")
            {
                ABD.handle_YN = "否";
                insertDataList.Add(new DBItem("ABO_TRT_M", null, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("ABO_TRT_M_OTH", null, DBItem.DBDataType.String));
            }

            #region 傷口評估
            AddWoundRecordData("1", dtsta.Rows[0]["IID"].ToString() + "1", id + "1", form["TXT_RECORDTIME_DAY"] + " " + form["TXT_RECORDTIME_TIME"], null, ABD);
            #endregion

            //下肢紅  
            var LL_RED = form["RB_LL_RED"];
            insertDataList.Add(new DBItem("LL_RED", LL_RED, DBItem.DBDataType.String));
            if (LL_RED == "1")
            {
                var LL_RED_LR = form["CK_LL_RED_LR"];
                var LL_RED_LRV = new List<string>() { "0", "0" };
                if (LL_RED_LR == null)
                    insertDataList.Add(new DBItem("LL_RED_LR", String.Join("", LL_RED_LRV), DBItem.DBDataType.String));
                else
                {
                    var LL_RED_LR_SP = LL_RED_LR.Split(',');
                    foreach (var i in LL_RED_LR_SP)
                        LL_RED_LRV[Convert.ToInt32(i)] = "1";
                    insertDataList.Add(new DBItem("LL_RED_LR", String.Join("", LL_RED_LRV), DBItem.DBDataType.String));
                }
                //左
                if (LL_RED_LRV[0] == "1")
                    insertDataList.Add(new DBItem("LL_RED_LS", form["RB_LL_RED_LS"], DBItem.DBDataType.String));
                else
                    insertDataList.Add(new DBItem("LL_RED_LS", null, DBItem.DBDataType.String));
                //右
                if (LL_RED_LRV[1] == "1")
                    insertDataList.Add(new DBItem("LL_RED_RS", form["RB_LL_RED_LS"], DBItem.DBDataType.String));
                else
                    insertDataList.Add(new DBItem("LL_RED_RS", null, DBItem.DBDataType.String));
            }
            else
            {
                insertDataList.Add(new DBItem("LL_RED_LR", null, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("LL_RED_LS", null, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("LL_RED_RS", null, DBItem.DBDataType.String));
            }

            //下肢腫 
            var LL_SWO = form["RB_LL_SWO"];
            insertDataList.Add(new DBItem("LL_SWO", LL_SWO, DBItem.DBDataType.String));
            if (LL_SWO == "1")
            {
                var LL_SWO_LR = form["CK_LL_SWO_LR"];
                var LL_SWO_LRV = new List<string>() { "0", "0" };
                if (LL_SWO_LR == null)
                    insertDataList.Add(new DBItem("LL_SWO_LR", String.Join("", LL_SWO_LRV), DBItem.DBDataType.String));
                else
                {
                    var LL_SWO_LR_SP = LL_SWO_LR.Split(',');
                    foreach (var i in LL_SWO_LR_SP)
                        LL_SWO_LRV[Convert.ToInt32(i)] = "1";
                    insertDataList.Add(new DBItem("LL_SWO_LR", String.Join("", LL_SWO_LRV), DBItem.DBDataType.String));
                }
                //左
                if (LL_SWO_LRV[0] == "1")
                    insertDataList.Add(new DBItem("LL_SWO_LS", form["RB_LL_SWO_LS"], DBItem.DBDataType.String));
                else
                    insertDataList.Add(new DBItem("LL_SWO_LS", null, DBItem.DBDataType.String));
                //右
                if (LL_SWO_LRV[1] == "1")
                    insertDataList.Add(new DBItem("LL_SWO_RS", form["RB_LL_SWO_RS"], DBItem.DBDataType.String));
                else
                    insertDataList.Add(new DBItem("LL_SWO_RS", null, DBItem.DBDataType.String));
            }
            else
            {
                insertDataList.Add(new DBItem("LL_SWO_LR", null, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("LL_SWO_LS", null, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("LL_SWO_RS", null, DBItem.DBDataType.String));
            }


            //下肢壓痛
            var LL_TEN = form["RB_LL_TEN"];
            insertDataList.Add(new DBItem("LL_TEN", LL_TEN, DBItem.DBDataType.String));
            if (LL_TEN == "1")
            {
                var LL_TEN_LR = form["CK_LL_TEN_LR"];
                var LL_TEN_LRV = new List<string>() { "0", "0" };
                if (LL_TEN_LR == null)
                    insertDataList.Add(new DBItem("LL_TEN_LR", String.Join("", LL_TEN_LRV), DBItem.DBDataType.String));
                else
                {
                    var LL_TEN_LR_SP = LL_TEN_LR.Split(',');
                    foreach (var i in LL_TEN_LR_SP)
                        LL_TEN_LRV[Convert.ToInt32(i)] = "1";
                    insertDataList.Add(new DBItem("LL_TEN_LR", String.Join("", LL_TEN_LRV), DBItem.DBDataType.String));
                }
                //左
                if (LL_TEN_LRV[0] == "1")
                    insertDataList.Add(new DBItem("LL_TEN_LS", form["RB_LL_TEN_LS"], DBItem.DBDataType.String));
                else
                    insertDataList.Add(new DBItem("LL_TEN_LS", null, DBItem.DBDataType.String));
                //右
                if (LL_TEN_LRV[1] == "1")
                    insertDataList.Add(new DBItem("LL_TEN_RS", form["RB_LL_TEN_RS"], DBItem.DBDataType.String));
                else
                    insertDataList.Add(new DBItem("LL_TEN_RS", null, DBItem.DBDataType.String));
            }
            else
            {
                insertDataList.Add(new DBItem("LL_TEN_LR", null, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("LL_TEN_LS", null, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("LL_TEN_RS", null, DBItem.DBDataType.String));
            }

            //下肢霍曼氏徵象
            var LL_HS = form["RB_LL_HS"];
            insertDataList.Add(new DBItem("LL_HS", LL_HS, DBItem.DBDataType.String));
            if (LL_HS == "1")
            {
                var LL_HS_LR = form["CK_LL_HS_LR"];
                var LL_HS_LRV = new List<string>() { "0", "0" };
                if (LL_HS_LR == null)
                    insertDataList.Add(new DBItem("LL_HS_LR", String.Join("", LL_HS_LRV), DBItem.DBDataType.String));
                else
                {
                    var LL_HS_LR_SP = LL_HS_LR.Split(',');
                    foreach (var i in LL_HS_LR_SP)
                        LL_HS_LRV[Convert.ToInt32(i)] = "1";
                    insertDataList.Add(new DBItem("LL_HS_LR", String.Join("", LL_HS_LRV), DBItem.DBDataType.String));
                }
                //左
                if (LL_HS_LRV[0] == "1")
                    insertDataList.Add(new DBItem("LL_HS_LS", form["RB_LL_HS_LS"], DBItem.DBDataType.String));
                else
                    insertDataList.Add(new DBItem("LL_HS_LS", null, DBItem.DBDataType.String));
                //右
                if (LL_HS_LRV[1] == "1")
                    insertDataList.Add(new DBItem("LL_HS_RS", form["RB_LL_HS_RS"], DBItem.DBDataType.String));
                else
                    insertDataList.Add(new DBItem("LL_HS_RS", null, DBItem.DBDataType.String));
            }
            else
            {
                insertDataList.Add(new DBItem("LL_HS_LR", null, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("LL_HS_LS", null, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("LL_HS_RS", null, DBItem.DBDataType.String));
            }

            //排尿自解
            insertDataList.Add(new DBItem("URINE_SELF", form["RB_URINE_SELF"], DBItem.DBDataType.String));
            //排尿單導
            insertDataList.Add(new DBItem("URINE_SINGLE_STAT", form["RB_URINE_SINGLE_STAT"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("URINE_SINGLE_AMT", form["TXT_URINE_SINGLE_AMT"], DBItem.DBDataType.String));
            //排尿導尿管
            insertDataList.Add(new DBItem("URINE_CAT_STAT", form["RB_URINE_CAT_STAT"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("URINE_CAT_AMT", form["TXT_URINE_CAT_AMT"], DBItem.DBDataType.String));

            //護理處置
            insertDataList.Add(new DBItem("NS_TREAT", form["TXT_NS_TREAT"], DBItem.DBDataType.String));

            insertDataList = setNullToEmpty(insertDataList);
            int erow = link.DBExecInsertTns("OBS_AFTBTH", insertDataList);

            #region 護理紀錄
            var title = "產後護理紀錄";
            var content = new List<string>();
            var semicolon = new List<string>();
            var field = "";

            #region 子宮硬度 
            field = "評估子宮收縮";
            switch ((form["RB_UTERUS_SHRINK"] ?? "").ToString())
            {
                case "0":
                    field += "硬";
                    break;
                case "1":
                    field += "中，加強按摩子宮後";
                    break;
                case "2":
                    field += "軟，加強按摩子宮後";
                    break;
                case "3":
                    field += "無法測量";
                    break;
                default:
                    field += "無";
                    break;
            }
            content.Add(field);
            #endregion

            #region 子宮高度 
            field = "宮底高度";
            switch ((form["RB_UTERUS_HEIGHT"] ?? "").ToString())
            {
                case "0":
                    field += "臍上3指";
                    break;
                case "1":
                    field += "臍上2指";
                    break;
                case "2":
                    field += "臍上1指";
                    break;
                case "3":
                    field += "臍平";
                    break;
                case "4":
                    field += "臍下1指";
                    break;
                case "5":
                    field += "臍下2指";
                    break;
                case "6":
                    field += "臍下3指";
                    break;
                case "7":
                    field += "無法測量";
                    break;
                case "8":
                    field += form["TXT_UTERUS_HEIGHT_OTH"] ?? "";
                    break;
                default:
                    field += "無";
                    break;
            }
            content.Add(field);
            #endregion

            #region 惡露量 
            field = "惡露量";
            switch ((form["RB_LOCHIA_STAT"] ?? "").ToString())
            {
                case "0":
                    field += "微量";
                    break;
                case "1":
                    field += "少";
                    break;
                case "2":
                    field += "中";
                    break;
                case "3":
                    field += "多";
                    break;
                default:
                    field += "無";
                    break;
            }

            field += "色";
            switch ((form["RB_LOCHIA_COLOR"] ?? "").ToString())
            {
                case "0":
                    field += "鮮紅";
                    break;
                case "1":
                    field += "深紅";
                    break;
                case "2":
                    field += "淡紅";
                    break;
                case "3":
                    field += form["TXT_LOCHIA_COLOR_OTH"] ?? "";
                    break;
                default:
                    field += "無";
                    break;
            }

            if (IsNoEmpty(form["TXT_LOCHIA"]))
                field += $"，秤重約{(IsNoEmpty(form["TXT_LOCHIA"]) == true ? form["TXT_LOCHIA"] : "0")} g";

            content.Add(field);
            #endregion

            semicolon.Add(String.Join("，", content));

            #region 下肢
            field = "";
            //雙肢都無
            if (form["RB_LL_RED"] == null && form["RB_LL_SWO"] == null && form["RB_LL_TEN"] == null && form["RB_LL_HS"] == null)
                field = "";
            else
            {
                field = "評估";
                if (form["RB_LL_RED"] == "0" && form["RB_LL_SWO"] == "0" && form["RB_LL_TEN"] == "0" && form["RB_LL_HS"] == "0")
                {
                    field += "評估雙下肢無紅、腫、壓痛，霍曼氏徵象無";
                }
                else
                {
                    //左肢都無
                    if (form["CK_LL_RED_LR"]?.IndexOf('0') < 0 && form["CK_LL_SWO_LR"]?.IndexOf('0') < 0 && form["CK_LL_TEN_LR"]?.IndexOf('0') < 0 && form["CK_LL_HS_LR"]?.IndexOf('0') < 0)
                        field += "左下肢無紅、腫、壓痛，霍曼氏徵象無";
                    else
                    {
                        var L_RED = form["RB_LL_RED_LS"];
                        switch ((L_RED ?? "").ToString())
                        {
                            case "0":
                            case "3":
                            case "4":
                                field += "下肢 紅 有 左有紅，";
                                break;
                            case "1":
                                field += "下肢 紅 有 左無紅，";
                                break;
                            case "2":
                                field += "下肢 紅 有 左輕微紅，";
                                break;
                            default:
                                field += "";
                                break;
                        }

                        var L_SWO = form["RB_LL_SWO_LS"];
                        switch ((L_SWO ?? "").ToString())
                        {
                            case "0":
                                field += "下肢 腫 有 左有凹陷性水腫2mm，";
                                break;
                            case "1":
                                field += "下肢 腫 有 左無水腫，";
                                break;
                            case "2":
                                field += "下肢 腫 有 左輕微水腫，";
                                break;
                            case "3":
                                field += "下肢 腫 有 左有凹陷性水腫4mm，";
                                break;
                            case "4":
                                field += "下肢 腫 有 左有凹陷性水腫6mm，";
                                break;
                            case "5":
                                field += "下肢 腫 有 左有凹陷性水腫8mm，";
                                break;
                            default:
                                field += "";
                                break;
                        }

                        switch ((form["RB_LL_TEN_LS"] ?? "").ToString())
                        {
                            case "0":
                            case "3":
                            case "4":
                                field += "下肢 壓痛 有 左按壓時有疼痛，";
                                break;
                            case "1":
                                field += "下肢 壓痛 有 左按壓時無疼痛，";
                                break;
                            case "2":
                                field += "下肢 壓痛 有 左按壓時輕微疼痛，";
                                break;
                            default:
                                field += "";
                                break;
                        }

                        switch ((form["RB_LL_HS_LS"] ?? "").ToString())
                        {
                            case "0":
                            case "3":
                            case "4":
                                field += "下肢 霍曼氏徵象 有 左有；";
                                break;
                            case "1":
                                field += "下肢 霍曼氏徵象 有 左無；";
                                break;
                            case "2":
                                field += "下肢 霍曼氏徵象 有 左無法判斷；";
                                break;
                            default:
                                field += "";
                                break;
                        }
                    }
                    //右肢都無
                    if (form["CK_LL_RED_LR"]?.IndexOf('1') < 0 && form["CK_LL_SWO_LR"]?.IndexOf('1') < 0 && form["CK_LL_TEN_LR"]?.IndexOf('1') < 0 && form["CK_LL_HS_LR"]?.IndexOf('1') < 0)
                        field += "右下肢無紅、腫、壓痛，霍曼氏徵象無";
                    else
                    {
                        var R_RED = form["RB_LL_RED_RS"];
                        switch ((R_RED ?? "").ToString())
                        {
                            case "0":
                            case "3":
                            case "4":
                                field += "下肢 紅 有 右有紅，";
                                break;
                            case "1":
                                field += "下肢 紅 有 右無紅，";
                                break;
                            case "2":
                                field += "下肢 紅 有 右輕微紅，";
                                break;
                            default:
                                field += "";
                                break;
                        }

                        var R_SWO = form["RB_LL_SWO_RS"];
                        switch ((R_SWO ?? "").ToString())
                        {
                            case "0":
                                field += "下肢 腫 有 右有凹陷性水腫2mm，";
                                break;
                            case "1":
                                field += "下肢 腫 有 右無水腫，";
                                break;
                            case "2":
                                field += "下肢 腫 有 右輕微水腫，";
                                break;
                            case "3":
                                field += "下肢 腫 有 右有凹陷性水腫4mm，";
                                break;
                            case "4":
                                field += "下肢 腫 有 右有凹陷性水腫6mm，";
                                break;
                            case "5":
                                field += "下肢 腫 有 右有凹陷性水腫8mm，";
                                break;
                            default:
                                field += "";
                                break;
                        }

                        switch ((form["RB_LL_TEN_RS"] ?? "").ToString())
                        {
                            case "0":
                            case "3":
                            case "4":
                                field += "下肢 壓痛 有 右按壓時有疼痛，";
                                break;
                            case "1":
                                field += "下肢 壓痛 有 右按壓時無疼痛，";
                                break;
                            case "2":
                                field += "下肢 壓痛 有 右按壓時輕微疼痛，";
                                break;
                            default:
                                field += "";
                                break;
                        }

                        switch ((form["RB_LL_HS_RS"] ?? "").ToString())
                        {
                            case "0":
                            case "3":
                            case "4":
                                field += "下肢 霍曼氏徵象 有 右有；";
                                break;
                            case "1":
                                field += "下肢 霍曼氏徵象 有 右無；";
                                break;
                            case "2":
                                field += "下肢 霍曼氏徵象 有 右無法判斷；";
                                break;
                            default:
                                field += "";
                                break;
                        }
                    }
                }
            }
            #endregion
            if (field != "")
                semicolon.Add(field);

            #region 排尿
            field = "";

            switch ((form["RB_URINE_SELF"] ?? "").ToString())
            {
                case "0":
                    field += "自解尿液順暢";
                    break;
                case "1":
                    field += "尚未自解尿液";
                    break;
                default:
                    field += "";
                    break;
            }

            if (IsNoEmpty(form["TXT_URINE_SINGLE_AMT"]) && IsNoEmpty(form["RB_URINE_SINGLE_STAT"]))
            {
                field += $"無法自解尿液，給予單導，尿液量為{(IsNoEmpty(form["TXT_URINE_SINGLE_AMT"]) == true ? form["TXT_URINE_SINGLE_AMT"] : "0")}cc，色";

                switch ((form["RB_URINE_SINGLE_STAT"] ?? "").ToString())
                {
                    case "0":
                        field += "黃";
                        break;
                    case "1":
                        field += "褐";
                        break;
                    case "2":
                        field += "暗紅";
                        break;
                    case "3":
                        field += "淡紅";
                        break;
                    case "4":
                        field += "鮮紅";
                        break;
                    default:
                        field += "未填寫";
                        break;
                }

                field += "。";
            }

            if (IsNoEmpty(form["TXT_URINE_CAT_AMT"]) && IsNoEmpty(form["RB_URINE_CAT_STAT"]))
            {
                field += $"留置導尿管，尿液量為{(IsNoEmpty(form["TXT_URINE_CAT_AMT"]) == true ? form["TXT_URINE_CAT_AMT"] : "0")}cc，色";
                switch ((form["RB_URINE_CAT_STAT"] ?? "").ToString())
                {
                    case "0":
                        field += "黃";
                        break;
                    case "1":
                        field += "褐";
                        break;
                    case "2":
                        field += "暗紅";
                        break;
                    case "3":
                        field += "淡紅";
                        break;
                    case "4":
                        field += "鮮紅";
                        break;
                    default:
                        field += "未填寫";
                        break;
                }

                field += "。";
            }

            if (IsNoEmpty(field))
                semicolon.Add(field);
            #endregion

            erow += base.Insert_CareRecordTns(form["TXT_RECORDTIME_DAY"] + " " + form["TXT_RECORDTIME_TIME"], id, title, String.Join("；", semicolon), "", "", "", "", "OBS_AFTBTH", ref link);

            #endregion

            var TM_MED_A = form["TXT_TM_MED_A"]?.Split(',');
            var TM_MED_A_AMT = form["TXT_TM_MED_A_AMT"]?.Split(',');
            var TM_MED_B = form["TXT_TM_MED_B"]?.Split(',');
            var TM_MED_B_AMT = form["TXT_TM_MED_B_AMT"]?.Split(',');
            var TM_MED_USE = form["TXT_TM_MED_USE"]?.Split(',');
            var TM_MED_USE_STAT = form["TXT_TM_MED_USE_STAT"]?.Split(',');
            var TM_MED_SPEED = form["TXT_TM_MED_SPEED"]?.Split(',');

            for (var d = 0; d < TM_MED_A?.Length; d++)
            {

                #region 新增藥物調配
                List<DBItem> insertDataListM = new List<DBItem>();
                insertDataListM.Add(new DBItem("IID", id, DBItem.DBDataType.String)); //流水號
                insertDataListM.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String)); //批價序號
                insertDataListM.Add(new DBItem("SNOM", (d + 1).ToString(), DBItem.DBDataType.String)); //序號
                insertDataListM.Add(new DBItem("CREATNO", form["TXT_CREATNO"], DBItem.DBDataType.String)); //評估者員編
                insertDataListM.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
                insertDataListM.Add(new DBItem("RECORDTIME", form["TXT_RECORDTIME_DAY"] + " " + form["TXT_RECORDTIME_TIME"], DBItem.DBDataType.DataTime));//紀錄時間

                insertDataListM.Add(new DBItem("TM_MED_A", TM_MED_A[d], DBItem.DBDataType.String)); //醫療處置-調配-A藥品種類
                insertDataListM.Add(new DBItem("TM_MED_A_AMT", TM_MED_A_AMT[d], DBItem.DBDataType.String)); //醫療處置-調配-A藥品劑量
                insertDataListM.Add(new DBItem("TM_MED_B", TM_MED_B[d], DBItem.DBDataType.String)); //醫療處置-調配-B藥品種類
                insertDataListM.Add(new DBItem("TM_MED_B_AMT", TM_MED_B_AMT[d], DBItem.DBDataType.String)); //醫療處置-調配-B藥品劑量
                insertDataListM.Add(new DBItem("TM_MED_USE", TM_MED_USE[d], DBItem.DBDataType.String)); //醫療處置-A+B組合總用量

                if (TM_MED_USE_STAT[d].Trim() == "啟用")
                    insertDataListM.Add(new DBItem("TM_MED_USE_STAT", "0", DBItem.DBDataType.String)); //醫療處置-A+B組合狀態
                else if (TM_MED_USE_STAT[d].Trim() == "停止")
                    insertDataListM.Add(new DBItem("TM_MED_USE_STAT", "1", DBItem.DBDataType.String)); //醫療處置-A+B組合狀態
                else if (TM_MED_USE_STAT[d].Trim() == "一次性給藥")
                    insertDataListM.Add(new DBItem("TM_MED_USE_STAT", "2", DBItem.DBDataType.String)); //醫療處置-A+B組合狀態
                else
                    insertDataListM.Add(new DBItem("TM_MED_USE_STAT", null, DBItem.DBDataType.String)); //醫療處置-A+B組合狀態
                insertDataListM = setNullToEmpty(insertDataListM);
                erow += link.DBExecInsertTns("OBS_ABDISP", insertDataListM);
                #endregion

                #region 新增藥物調配明細
                List<DBItem> insertDataListD = new List<DBItem>();
                insertDataListD.Add(new DBItem("IID", id, DBItem.DBDataType.String)); //流水號
                insertDataListD.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String)); //批價序號
                insertDataListD.Add(new DBItem("SNOM", (d + 1).ToString(), DBItem.DBDataType.String)); //產程藥物調配序號
                insertDataListD.Add(new DBItem("SNOD", "1", DBItem.DBDataType.String)); //序號
                insertDataListD.Add(new DBItem("CREATNO", form["TXT_CREATNO"], DBItem.DBDataType.String)); //評估者員編
                insertDataListD.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
                insertDataListD.Add(new DBItem("RECORDTIME", form["TXT_RECORDTIME_DAY"] + " " + form["TXT_RECORDTIME_TIME"], DBItem.DBDataType.DataTime));//紀錄時間

                insertDataListD.Add(new DBItem("TM_MED_SPEED", TM_MED_SPEED[d], DBItem.DBDataType.Number)); //醫療處置-A+B組合流速
                insertDataListD = setNullToEmpty(insertDataListD);
                erow += link.DBExecInsertTns("OBS_ABDISP_DETAIL", insertDataListD);

                #endregion
            }
            if (erow > 0)
            {
                link.DBCommit();
                Response.Write("<script>alert('新增成功');window.opener.location.href='Index?active=Postnatal_Record_List&show=Y';window.close();</script>");
            }
            else
            {
                link.DBRollBack();
                Response.Write("<script>alert('新增失敗');window.opener.location.href='Index?active=Postnatal_Record_List&show=Y';window.close();</script>");
            }

            return new EmptyResult();
        }
        #endregion

        #region 編輯產後護理紀錄
        /// <summary>
        /// 編輯產後護理紀錄
        /// </summary>
        /// <param name="form"></param>
        /// <returns></returns>
        [HttpPost]
        public ActionResult Upd_Postnatal_Record(FormCollection form)
        {
            link.DBOpen();

            DataTable dtsta = obs_m.sel_bthsta(ptinfo?.FeeNo);
            if (dtsta == null || dtsta.Rows.Count == 0)
            {
                Response.Write("<script>alert('新增失敗，請先新增二、三產程資料!');window.opener.location.href='Index?active=Postnatal_Record_List&show=Y';window.close();</script>");
                return new EmptyResult();
            }

            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo.FeeNo;
            string[] id_list = form["IID"].Split(',');
            int erow = 0;
            for (int v = 0; v < id_list.Length; v++)
            {
                List<DBItem> insertDataList = new List<DBItem>();
                insertDataList.Add(new DBItem("UPDNO", userno, DBItem.DBDataType.String)); //評估者員編
                insertDataList.Add(new DBItem("UPDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
                insertDataList.Add(new DBItem("RECORDTIME", form["TXT_RECORDTIME_DAY" + id_list[v]] + " " + form["TXT_RECORDTIME_TIME" + id_list[v]], DBItem.DBDataType.DataTime));//紀錄時間

                //子宮硬度
                insertDataList.Add(new DBItem("UTERUS_SHRINK", form["RB_UTERUS_SHRINK" + id_list[v]], DBItem.DBDataType.String));
                //子宮高度
                var UTERUS_HEIGHT = form["RB_UTERUS_HEIGHT" + id_list[v]];
                insertDataList.Add(new DBItem("UTERUS_HEIGHT", UTERUS_HEIGHT, DBItem.DBDataType.String));
                if (UTERUS_HEIGHT == "8")
                    insertDataList.Add(new DBItem("UTERUS_HEIGHT_OTH", form["TXT_UTERUS_HEIGHT_OTH" + id_list[v]], DBItem.DBDataType.String));
                else
                    insertDataList.Add(new DBItem("UTERUS_HEIGHT_OTH", null, DBItem.DBDataType.String));

                //惡露量
                insertDataList.Add(new DBItem("LOCHIA", form["TXT_LOCHIA" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("LOCHIA_STAT", form["RB_LOCHIA_STAT" + id_list[v]], DBItem.DBDataType.String));
                //惡露色
                var LOCHIA_COLOR = form["RB_LOCHIA_COLOR" + id_list[v]];
                insertDataList.Add(new DBItem("LOCHIA_COLOR", LOCHIA_COLOR, DBItem.DBDataType.String));
                if (LOCHIA_COLOR == "3")
                    insertDataList.Add(new DBItem("LOCHIA_COLOR_OTH", form["TXT_LOCHIA_COLOR_OTH" + id_list[v]], DBItem.DBDataType.String));
                else
                    insertDataList.Add(new DBItem("LOCHIA_COLOR_OTH", null, DBItem.DBDataType.String));

                PERINEUM PERINEUM = new PERINEUM();

                PERINEUM.PERINEUM_RANGE = ""; PERINEUM.PERINEUM_RED = ""; PERINEUM.PERINEUM_SWOLLEN = "";
                PERINEUM.SWOLLEN_RANGE = ""; PERINEUM.PERINEUM_BRUISE = "";
                PERINEUM.PERINEUM_SECRETION = "";

                //會陰傷口紅
                insertDataList.Add(new DBItem("EPWOUND_RED", form["RB_EPWOUND_RED" + id_list[v]], DBItem.DBDataType.String));
                if (form["RB_EPWOUND_RED" + id_list[v]] == "0")
                    PERINEUM.PERINEUM_RED = "無";
                else if (form["RB_EPWOUND_RED" + id_list[v]] == "1")
                    PERINEUM.PERINEUM_RED = "傷口周圍邊緣 < 0.25公分";
                else if (form["RB_EPWOUND_RED" + id_list[v]] == "2")
                    PERINEUM.PERINEUM_RED = "傷口周圍邊緣 < 0.5公分";
                else if (form["RB_EPWOUND_RED" + id_list[v]] == "3")
                    PERINEUM.PERINEUM_RED = "傷口周圍邊緣 > 0.5公分";

                PERINEUM.SWOLLEN_RANGE = form["TXT_EPWOUND_EDEMA_AREA" + id_list[v]];

                //會陰傷口水腫
                insertDataList.Add(new DBItem("EPWOUND_EDEMA", form["RB_EPWOUND_EDEMA" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("EPWOUND_EDEMA_AREA", form["TXT_EPWOUND_EDEMA_AREA" + id_list[v]], DBItem.DBDataType.String));
                if (form["RB_EPWOUND_EDEMA" + id_list[v]] == "0")
                    PERINEUM.PERINEUM_SWOLLEN = "無";
                else if (form["RB_EPWOUND_EDEMA" + id_list[v]] == "1")
                    PERINEUM.PERINEUM_SWOLLEN = "會陰處 < 1公分";
                else if (form["RB_EPWOUND_EDEMA" + id_list[v]] == "2")
                    PERINEUM.PERINEUM_SWOLLEN = "會陰處 1-2公分";
                else if (form["RB_EPWOUND_EDEMA" + id_list[v]] == "3")
                    PERINEUM.PERINEUM_SWOLLEN = "會陰處 > 2公分";


                //會陰傷口瘀血
                insertDataList.Add(new DBItem("EPWOUND_ECC", form["RB_EPWOUND_ECC" + id_list[v]], DBItem.DBDataType.String));
                if (form["RB_EPWOUND_ECC" + id_list[v]] == "0")
                    PERINEUM.PERINEUM_BRUISE = "無";
                else if (form["RB_EPWOUND_ECC" + id_list[v]] == "1")
                    PERINEUM.PERINEUM_BRUISE = "傷口兩側 < 0.25公分";
                else if (form["RB_EPWOUND_ECC" + id_list[v]] == "2")
                    PERINEUM.PERINEUM_BRUISE = "傷口兩側 0.25-1公分";
                else if (form["RB_EPWOUND_ECC" + id_list[v]] == "3")
                    PERINEUM.PERINEUM_BRUISE = "傷口兩側 > 1公分";
                else if (form["RB_EPWOUND_ECC" + id_list[v]] == "4")
                    PERINEUM.PERINEUM_BRUISE = "左側 < 0.5公分";
                else if (form["RB_EPWOUND_ECC" + id_list[v]] == "5")
                    PERINEUM.PERINEUM_BRUISE = "左側 0.5-2公分";
                else if (form["RB_EPWOUND_ECC" + id_list[v]] == "6")
                    PERINEUM.PERINEUM_BRUISE = "左側 > 2公分";
                else if (form["RB_EPWOUND_ECC" + id_list[v]] == "7")
                    PERINEUM.PERINEUM_BRUISE = "右側 < 0.5公分";
                else if (form["RB_EPWOUND_ECC" + id_list[v]] == "8")
                    PERINEUM.PERINEUM_BRUISE = "右側 0.5-2公分";
                else if (form["RB_EPWOUND_ECC" + id_list[v]] == "9")
                    PERINEUM.PERINEUM_BRUISE = "右側 > 2公分";
                //會陰傷口分泌物
                insertDataList.Add(new DBItem("EPWOUND_DISC", form["RB_EPWOUND_DISC" + id_list[v]], DBItem.DBDataType.String));
                if (form["RB_EPWOUND_DISC" + id_list[v]] == "0")
                    PERINEUM.PERINEUM_SECRETION = "無";
                else if (form["RB_EPWOUND_DISC" + id_list[v]] == "1")
                    PERINEUM.PERINEUM_SECRETION = "漿液性";
                else if (form["RB_EPWOUND_DISC" + id_list[v]] == "2")
                    PERINEUM.PERINEUM_SECRETION = "漿液性及血濃性";
                else if (form["RB_EPWOUND_DISC" + id_list[v]] == "3")
                    PERINEUM.PERINEUM_SECRETION = "血濃性";
                //會陰傷口傷口邊緣
                insertDataList.Add(new DBItem("EPWOUND_APPR", form["RB_EPWOUND_APPR" + id_list[v]], DBItem.DBDataType.String));
                if (form["RB_EPWOUND_APPR" + id_list[v]] == "0")
                    PERINEUM.PERINEUM_RANGE = "密合";
                else if (form["RB_EPWOUND_APPR" + id_list[v]] == "1")
                    PERINEUM.PERINEUM_RANGE = "皮膚裂縫< 0.3公分";
                else if (form["RB_EPWOUND_APPR" + id_list[v]] == "2")
                    PERINEUM.PERINEUM_RANGE = "皮膚和皮下脂肪有裂縫";
                else if (form["RB_EPWOUND_APPR" + id_list[v]] == "3")
                    PERINEUM.PERINEUM_RANGE = "皮膚、皮下脂肪、筋膜層裂開";

                var pSql = "SELECT * FROM WOUND_RECORD WHERE WOUND_ID = '" + dtsta.Rows[0]["IID"].ToString() + "0" + "' AND RECORD_ID = '" + id_list[v] + "0" + "' ";

                DataTable dt_PERINEUM = obs_m.DBExecSQL(pSql);
                if (dt_PERINEUM != null && dt_PERINEUM.Rows.Count > 0)
                {
                    UpdWoundRecordData("0", dtsta.Rows[0]["IID"].ToString() + "0", id_list[v] + "0", form["TXT_RECORDTIME_DAY" + id_list[v]] + " " + form["TXT_RECORDTIME_TIME" + id_list[v]], PERINEUM);
                }
                else
                {
                    AddWoundRecordData("0", dtsta.Rows[0]["IID"].ToString() + "0", id_list[v] + "0", form["TXT_RECORDTIME_DAY" + id_list[v]] + " " + form["TXT_RECORDTIME_TIME" + id_list[v]], PERINEUM);
                }

                //腹部傷口範圍
                ABD ABD = new ABD();
                ABD.range_YN = ""; ABD.RANGE_HEIGHT = ""; ABD.RANGE_WIDTH = "";
                ABD.RANGE_DEPTH = ""; ABD.EXTERIOR = ""; ABD.EXTERIOR_OTHER = "";
                ABD.exudate_YN = ""; ABD.EXUDATE_AMOUNT = ""; ABD.EXUDATE_NATURE = "";
                ABD.EXUDATE_NATURE_OTHER = ""; ABD.EXUDATE_COLOR = ""; ABD.EXUDATE_COLOR_OTHER = "";
                ABD.sutures_YN = ""; ABD.pin = ""; ABD.handle_YN = "";
                ABD.handle_item = ""; ABD.handle_other = "";

                var ABD_AREA = form["RB_ABD_AREA" + id_list[v]];
                insertDataList.Add(new DBItem("ABD_AREA", ABD_AREA, DBItem.DBDataType.String));
                if (ABD_AREA == "0")
                {
                    insertDataList.Add(new DBItem("ABD_AREA_L", form["TXT_ABD_AREA_L" + id_list[v]], DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("ABD_AREA_W", form["TXT_ABD_AREA_W" + id_list[v]], DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("ABD_AREA_H", form["TXT_ABD_AREA_H" + id_list[v]], DBItem.DBDataType.String));

                    ABD.range_YN = "是";
                    ABD.RANGE_HEIGHT = form["TXT_ABD_AREA_H" + id_list[v]];
                    ABD.RANGE_WIDTH = form["TXT_ABD_AREA_W" + id_list[v]];
                    ABD.RANGE_DEPTH = form["TXT_ABD_AREA_L" + id_list[v]];
                }
                else if (ABD_AREA == "1")
                {
                    ABD.range_YN = "否";

                    insertDataList.Add(new DBItem("ABD_AREA_L", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("ABD_AREA_W", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("ABD_AREA_H", null, DBItem.DBDataType.String));
                }
                //腹部傷口外觀
                var ABD_FEA = form["CK_ABD_FEA" + id_list[v]];

                //var ABD_FEAV = new List<string>() { "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0" };
                var ABD_FEAV = new List<string>() { "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0" };
                var FEA_Reason = new List<string>();
                if (ABD_FEA == null)
                {
                    insertDataList.Add(new DBItem("ABD_FEA", String.Join("", ABD_FEAV), DBItem.DBDataType.String));
                }
                else
                {
                    var ABD_FEA_SP = ABD_FEA.Split(',');
                    foreach (var r in ABD_FEA_SP)
                    {
                        ABD_FEAV[Convert.ToInt32(r)] = "1";
                        if (r == "0")
                            FEA_Reason.Add("紅");
                        if (r == "1")
                            FEA_Reason.Add("腫");
                        if (r == "2")
                            FEA_Reason.Add("硬結");
                        if (r == "3")
                            FEA_Reason.Add("浸潤變軟");
                        if (r == "4")
                            FEA_Reason.Add("色素沉著");
                        if (r == "5")
                            FEA_Reason.Add("水腫");
                        if (r == "6")
                            FEA_Reason.Add("過度角化");
                        if (r == "7")
                            FEA_Reason.Add("皮膚壞死呈現黑色");
                        if (r == "8")
                            FEA_Reason.Add("皮膚壞死呈現暗紫色");
                        if (r == "9")
                            FEA_Reason.Add("組織增生");
                        if (r == "10")
                            FEA_Reason.Add("其他");
                        if (r == "11")
                            FEA_Reason.Add("正常");
                    }
                    insertDataList.Add(new DBItem("ABD_FEA", String.Join("", ABD_FEAV), DBItem.DBDataType.String));
                }

                ABD.EXTERIOR = String.Join("|", FEA_Reason);
                if (ABD_FEAV[10] == "1")
                {
                    ABD.EXTERIOR_OTHER = form["TXT_ABD_FEA_OTH" + id_list[v]];
                    insertDataList.Add(new DBItem("ABD_FEA_OTH", form["TXT_ABD_FEA_OTH" + id_list[v]], DBItem.DBDataType.String));
                }
                else
                    insertDataList.Add(new DBItem("ABD_FEA_OTH", null, DBItem.DBDataType.String));

                //腹部傷口滲出液
                var ABD_EXU = form["RB_ABD_EXU" + id_list[v]];
                insertDataList.Add(new DBItem("ABD_EXU", ABD_EXU, DBItem.DBDataType.String));
                if (ABD_EXU == "1")
                {
                    ABD.exudate_YN = "有";
                    //滲出物量
                    insertDataList.Add(new DBItem("ABD_EXU_AMT", form["RB_ABD_EXU_AMT" + id_list[v]], DBItem.DBDataType.String));

                    if (form["RB_ABD_EXU_AMT" + id_list[v]] == "0")
                        ABD.EXUDATE_AMOUNT = "少";
                    else if (form["RB_ABD_EXU_AMT" + id_list[v]] == "1")
                        ABD.EXUDATE_AMOUNT = "中";
                    else if (form["RB_ABD_EXU_AMT" + id_list[v]] == "2")
                        ABD.EXUDATE_AMOUNT = "多";

                    //性狀
                    var ABD_EXU_TPE = form["CK_ABD_EXU_TPE" + id_list[v]];
                    var ABD_EXU_TPEV = new List<string>() { "0", "0", "0", "0", "0" };
                    var EXU_TPE_Reason = new List<string>();
                    if (ABD_EXU_TPE == null)
                        insertDataList.Add(new DBItem("ABD_EXU_TPE", String.Join("", ABD_EXU_TPEV), DBItem.DBDataType.String));
                    else
                    {
                        var ABD_EXU_TPE_SP = ABD_EXU_TPE.Split(',');
                        foreach (var i in ABD_EXU_TPE_SP)
                        {
                            ABD_EXU_TPEV[Convert.ToInt32(i)] = "1";
                            if (i == "0")
                                EXU_TPE_Reason.Add("漿液");
                            if (i == "1")
                                EXU_TPE_Reason.Add("血液");
                            if (i == "2")
                                EXU_TPE_Reason.Add("化膿");
                            if (i == "3")
                                EXU_TPE_Reason.Add("惡臭");
                            if (i == "4")
                                EXU_TPE_Reason.Add("其他");
                        }
                        insertDataList.Add(new DBItem("ABD_EXU_TPE", String.Join("", ABD_EXU_TPEV), DBItem.DBDataType.String));
                    }

                    ABD.EXUDATE_NATURE = String.Join("|", EXU_TPE_Reason);
                    if (ABD_EXU_TPEV[4] == "1")
                    {
                        ABD.EXUDATE_NATURE_OTHER = form["TXT_ABD_EXU_TPE_OTH" + id_list[v]];
                        insertDataList.Add(new DBItem("ABD_EXU_TPE_OTH", form["TXT_ABD_EXU_TPE_OTH" + id_list[v]], DBItem.DBDataType.String));
                    }
                    else
                        insertDataList.Add(new DBItem("ABD_EXU_TPE_OTH", null, DBItem.DBDataType.String));

                    //顏色
                    var ABD_EXU_COL = form["RB_ABD_EXU_COL" + id_list[v]];
                    insertDataList.Add(new DBItem("ABD_EXU_COL", ABD_EXU_COL, DBItem.DBDataType.String));
                    if (ABD_EXU_COL == "12")
                    {
                        ABD.EXUDATE_COLOR_OTHER = form["TXT_ABD_EXU_COL_OTH" + id_list[v]];
                        insertDataList.Add(new DBItem("ABD_EXU_COL_OTH", form["TXT_ABD_EXU_COL_OTH" + id_list[v]], DBItem.DBDataType.String));
                    }
                    else
                        insertDataList.Add(new DBItem("ABD_EXU_COL_OTH", null, DBItem.DBDataType.String));

                    if (ABD_EXU_COL == "0")
                        ABD.EXUDATE_COLOR = "暗紅色";
                    else if (ABD_EXU_COL == "1")
                        ABD.EXUDATE_COLOR = "紅色";
                    else if (ABD_EXU_COL == "2")
                        ABD.EXUDATE_COLOR = "鮮紅色";
                    else if (ABD_EXU_COL == "3")
                        ABD.EXUDATE_COLOR = "淡紅";
                    else if (ABD_EXU_COL == "4")
                        ABD.EXUDATE_COLOR = "粉紅";
                    else if (ABD_EXU_COL == "5")
                        ABD.EXUDATE_COLOR = "褐色";
                    else if (ABD_EXU_COL == "6")
                        ABD.EXUDATE_COLOR = "黃褐";

                    else if (ABD_EXU_COL == "7")
                        ABD.EXUDATE_COLOR = "黃綠";
                    else if (ABD_EXU_COL == "8")
                        ABD.EXUDATE_COLOR = "黃色";
                    else if (ABD_EXU_COL == "9")
                        ABD.EXUDATE_COLOR = "土黃";
                    else if (ABD_EXU_COL == "10")
                        ABD.EXUDATE_COLOR = "白";
                    else if (ABD_EXU_COL == "11")
                        ABD.EXUDATE_COLOR = "透明";
                    else if (ABD_EXU_COL == "12")
                        ABD.EXUDATE_COLOR = "其他";
                }
                else if (ABD_EXU == "0")
                {
                    ABD.exudate_YN = "無";
                    insertDataList.Add(new DBItem("ABD_EXU_AMT", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("ABD_EXU_TPE", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("ABD_EXU_TPE_OTH", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("ABD_EXU_COL", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("ABD_EXU_COL_OTH", null, DBItem.DBDataType.String));
                }


                //腹部傷口是否有縫線
                var ABO_SUT = form["RB_ABO_SUT" + id_list[v]];
                if (ABO_SUT == "0")
                    ABD.sutures_YN = "無縫線";
                else if (ABO_SUT == "1")
                    ABD.sutures_YN = "有縫線";
                else if (ABO_SUT == "2")
                    ABD.sutures_YN = "縫線已拆";

                insertDataList.Add(new DBItem("ABO_SUT", ABO_SUT, DBItem.DBDataType.String));
                if (ABO_SUT == "1")
                {
                    ABD.pin = form["TXT_ABO_SUT_N" + id_list[v]];
                    insertDataList.Add(new DBItem("ABO_SUT_N", form["TXT_ABO_SUT_N" + id_list[v]], DBItem.DBDataType.String));
                }
                else
                    insertDataList.Add(new DBItem("ABO_SUT_N", null, DBItem.DBDataType.String));

                //腹部傷口處置
                var ABO_TRT = form["RB_ABO_TRT" + id_list[v]];
                insertDataList.Add(new DBItem("ABO_TRT", ABO_TRT, DBItem.DBDataType.String));
                if (ABO_TRT == "1")
                {
                    ABD.handle_YN = "是";

                    var ABO_TRT_M = form["CK_ABO_TRT_M" + id_list[v]];
                    var ABO_TRT_Reason = new List<string>();
                    var ABO_TRT_MV = new List<string>() { "0", "0", "0", "0", "0", "0", "0" };
                    if (ABO_TRT_M == null)
                        insertDataList.Add(new DBItem("ABO_TRT_M", String.Join("", ABO_TRT_MV), DBItem.DBDataType.String));
                    else
                    {
                        var ABO_TRT_M_SP = ABO_TRT_M.Split(',');
                        foreach (var i in ABO_TRT_M_SP)
                        {
                            ABO_TRT_MV[Convert.ToInt32(i)] = "1";
                            if (i == "0")
                                ABO_TRT_Reason.Add("CD");
                            if (i == "1")
                                ABO_TRT_Reason.Add("Wet");
                            if (i == "2")
                                ABO_TRT_Reason.Add("Iodoform");
                            if (i == "3")
                                ABO_TRT_Reason.Add("Port-A CD");
                            if (i == "4")
                                ABO_TRT_Reason.Add("導管引流");
                            if (i == "5")
                                ABO_TRT_Reason.Add("燙傷CD");
                            if (i == "6")
                                ABO_TRT_Reason.Add("其他");
                        }
                        insertDataList.Add(new DBItem("ABO_TRT_M", String.Join("", ABO_TRT_MV), DBItem.DBDataType.String));
                    }
                    ABD.handle_item = String.Join("|", ABO_TRT_Reason);
                    if (ABO_TRT_MV[6] == "1")
                    {
                        ABD.handle_other = form["TXT_ABO_TRT_M_OTH" + id_list[v]];
                        insertDataList.Add(new DBItem("ABO_TRT_M_OTH", form["TXT_ABO_TRT_M_OTH" + id_list[v]], DBItem.DBDataType.String));
                    }
                    else
                        insertDataList.Add(new DBItem("ABO_TRT_M_OTH", null, DBItem.DBDataType.String));
                }
                else if (ABO_TRT == "0")
                {
                    ABD.handle_YN = "否";
                    insertDataList.Add(new DBItem("ABO_TRT_M", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("ABO_TRT_M_OTH", null, DBItem.DBDataType.String));
                }

                #region 腹部傷口
                var aSql = "SELECT * FROM WOUND_RECORD WHERE WOUND_ID = '" + dtsta.Rows[0]["IID"].ToString() + "1" + "' AND RECORD_ID = '" + id_list[v] + "1" + "' ";

                DataTable dt_ABD = obs_m.DBExecSQL(aSql);
                if (dt_ABD != null && dt_ABD.Rows.Count > 0)
                {
                    UpdWoundRecordData("1", dtsta.Rows[0]["IID"].ToString() + "1", id_list[v] + "1", form["TXT_RECORDTIME_DAY" + id_list[v]] + " " + form["TXT_RECORDTIME_TIME" + id_list[v]], null, ABD);
                }
                else
                {
                    AddWoundRecordData("1", dtsta.Rows[0]["IID"].ToString() + "1", id_list[v] + "1", form["TXT_RECORDTIME_DAY" + id_list[v]] + " " + form["TXT_RECORDTIME_TIME" + id_list[v]], null, ABD);
                }
                #endregion

                //下肢紅  
                var LL_RED = form["RB_LL_RED" + id_list[v]];
                insertDataList.Add(new DBItem("LL_RED", LL_RED, DBItem.DBDataType.String));
                if (LL_RED == "1")
                {
                    var LL_RED_LR = form["CK_LL_RED_LR" + id_list[v]];
                    var LL_RED_LRV = new List<string>() { "0", "0" };
                    if (LL_RED_LR == null)
                        insertDataList.Add(new DBItem("LL_RED_LR", String.Join("", LL_RED_LRV), DBItem.DBDataType.String));
                    else
                    {
                        var LL_RED_LR_SP = LL_RED_LR.Split(',');
                        foreach (var i in LL_RED_LR_SP)
                            LL_RED_LRV[Convert.ToInt32(i)] = "1";
                        insertDataList.Add(new DBItem("LL_RED_LR", String.Join("", LL_RED_LRV), DBItem.DBDataType.String));
                    }
                    //左
                    if (LL_RED_LRV[0] == "1")
                        insertDataList.Add(new DBItem("LL_RED_LS", form["RB_LL_RED_LS" + id_list[v]], DBItem.DBDataType.String));
                    else
                        insertDataList.Add(new DBItem("LL_RED_LS", null, DBItem.DBDataType.String));
                    //右
                    if (LL_RED_LRV[1] == "1")
                        insertDataList.Add(new DBItem("LL_RED_RS", form["RB_LL_RED_RS" + id_list[v]], DBItem.DBDataType.String));
                    else
                        insertDataList.Add(new DBItem("LL_RED_RS", null, DBItem.DBDataType.String));
                }
                else
                {
                    insertDataList.Add(new DBItem("LL_RED_LR", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("LL_RED_LS", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("LL_RED_RS", null, DBItem.DBDataType.String));
                }

                //下肢腫 
                var LL_SWO = form["RB_LL_SWO" + id_list[v]];
                insertDataList.Add(new DBItem("LL_SWO", LL_SWO, DBItem.DBDataType.String));
                if (LL_SWO == "1")
                {
                    var LL_SWO_LR = form["CK_LL_SWO_LR" + id_list[v]];
                    var LL_SWO_LRV = new List<string>() { "0", "0" };
                    if (LL_SWO_LR == null)
                        insertDataList.Add(new DBItem("LL_SWO_LR", String.Join("", LL_SWO_LRV), DBItem.DBDataType.String));
                    else
                    {
                        var LL_SWO_LR_SP = LL_SWO_LR.Split(',');
                        foreach (var i in LL_SWO_LR_SP)
                            LL_SWO_LRV[Convert.ToInt32(i)] = "1";
                        insertDataList.Add(new DBItem("LL_SWO_LR", String.Join("", LL_SWO_LRV), DBItem.DBDataType.String));
                    }
                    //左
                    if (LL_SWO_LRV[0] == "1")
                        insertDataList.Add(new DBItem("LL_SWO_LS", form["RB_LL_SWO_LS" + id_list[v]], DBItem.DBDataType.String));
                    else
                        insertDataList.Add(new DBItem("LL_SWO_LS", null, DBItem.DBDataType.String));
                    //右
                    if (LL_SWO_LRV[1] == "1")
                        insertDataList.Add(new DBItem("LL_SWO_RS", form["RB_LL_SWO_RS" + id_list[v]], DBItem.DBDataType.String));
                    else
                        insertDataList.Add(new DBItem("LL_SWO_RS", null, DBItem.DBDataType.String));
                }
                else
                {
                    insertDataList.Add(new DBItem("LL_SWO_LR", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("LL_SWO_LS", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("LL_SWO_RS", null, DBItem.DBDataType.String));
                }


                //下肢壓痛
                var LL_TEN = form["RB_LL_TEN" + id_list[v]];
                insertDataList.Add(new DBItem("LL_TEN", LL_TEN, DBItem.DBDataType.String));
                if (LL_TEN == "1")
                {
                    var LL_TEN_LR = form["CK_LL_TEN_LR" + id_list[v]];
                    var LL_TEN_LRV = new List<string>() { "0", "0" };
                    if (LL_TEN_LR == null)
                        insertDataList.Add(new DBItem("LL_TEN_LR", String.Join("", LL_TEN_LRV), DBItem.DBDataType.String));
                    else
                    {
                        var LL_TEN_LR_SP = LL_TEN_LR.Split(',');
                        foreach (var i in LL_TEN_LR_SP)
                            LL_TEN_LRV[Convert.ToInt32(i)] = "1";
                        insertDataList.Add(new DBItem("LL_TEN_LR", String.Join("", LL_TEN_LRV), DBItem.DBDataType.String));
                    }
                    //左
                    if (LL_TEN_LRV[0] == "1")
                        insertDataList.Add(new DBItem("LL_TEN_LS", form["RB_LL_TEN_LS" + id_list[v]], DBItem.DBDataType.String));
                    else
                        insertDataList.Add(new DBItem("LL_TEN_LS", null, DBItem.DBDataType.String));
                    //右
                    if (LL_TEN_LRV[1] == "1")
                        insertDataList.Add(new DBItem("LL_TEN_RS", form["RB_LL_TEN_RS" + id_list[v]], DBItem.DBDataType.String));
                    else
                        insertDataList.Add(new DBItem("LL_TEN_RS", null, DBItem.DBDataType.String));
                }
                else
                {
                    insertDataList.Add(new DBItem("LL_TEN_LR", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("LL_TEN_LS", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("LL_TEN_RS", null, DBItem.DBDataType.String));
                }

                //下肢霍曼氏徵象
                var LL_HS = form["RB_LL_HS" + id_list[v]];
                insertDataList.Add(new DBItem("LL_HS", LL_HS, DBItem.DBDataType.String));
                if (LL_HS == "1")
                {
                    var LL_HS_LR = form["CK_LL_HS_LR" + id_list[v]];
                    var LL_HS_LRV = new List<string>() { "0", "0" };
                    if (LL_HS_LR == null)
                        insertDataList.Add(new DBItem("LL_HS_LR", String.Join("", LL_HS_LRV), DBItem.DBDataType.String));
                    else
                    {
                        var LL_HS_LR_SP = LL_HS_LR.Split(',');
                        foreach (var i in LL_HS_LR_SP)
                            LL_HS_LRV[Convert.ToInt32(i)] = "1";
                        insertDataList.Add(new DBItem("LL_HS_LR", String.Join("", LL_HS_LRV), DBItem.DBDataType.String));
                    }
                    //左
                    if (LL_HS_LRV[0] == "1")
                        insertDataList.Add(new DBItem("LL_HS_LS", form["RB_LL_HS_LS" + id_list[v]], DBItem.DBDataType.String));
                    else
                        insertDataList.Add(new DBItem("LL_HS_LS", null, DBItem.DBDataType.String));
                    //右
                    if (LL_HS_LRV[1] == "1")
                        insertDataList.Add(new DBItem("LL_HS_RS", form["RB_LL_HS_RS" + id_list[v]], DBItem.DBDataType.String));
                    else
                        insertDataList.Add(new DBItem("LL_HS_RS", null, DBItem.DBDataType.String));
                }
                else
                {
                    insertDataList.Add(new DBItem("LL_HS_LR", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("LL_HS_LS", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("LL_HS_RS", null, DBItem.DBDataType.String));
                }

                //排尿自解
                insertDataList.Add(new DBItem("URINE_SELF", form["RB_URINE_SELF" + id_list[v]], DBItem.DBDataType.String));
                //排尿單導
                insertDataList.Add(new DBItem("URINE_SINGLE_STAT", form["RB_URINE_SINGLE_STAT" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("URINE_SINGLE_AMT", form["TXT_URINE_SINGLE_AMT" + id_list[v]], DBItem.DBDataType.String));
                //排尿導尿管
                insertDataList.Add(new DBItem("URINE_CAT_STAT", form["RB_URINE_CAT_STAT" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("URINE_CAT_AMT", form["TXT_URINE_CAT_AMT" + id_list[v]], DBItem.DBDataType.String));

                //護理處置
                insertDataList.Add(new DBItem("NS_TREAT", form["TXT_NS_TREAT" + id_list[v]], DBItem.DBDataType.String));

                string where = " IID = '" + id_list[v] + "' ";
                insertDataList = setNullToEmpty(insertDataList);
                erow += link.DBExecUpdate("OBS_AFTBTH", insertDataList, where);


                #region 護理紀錄
                var title = "產後護理紀錄";
                var content = new List<string>();
                var semicolon = new List<string>();
                var field = "";

                #region 子宮硬度 
                field = "評估子宮收縮";
                switch ((form["RB_UTERUS_SHRINK" + id_list[v]] ?? "").ToString())
                {
                    case "0":
                        field += "硬";
                        break;
                    case "1":
                        field += "中，加強按摩子宮後";
                        break;
                    case "2":
                        field += "軟，加強按摩子宮後";
                        break;
                    case "3":
                        field += "無法測量";
                        break;
                    default:
                        field += "無";
                        break;
                }
                content.Add(field);
                #endregion

                #region 子宮高度 
                field = "宮底高度";
                switch ((form["RB_UTERUS_HEIGHT" + id_list[v]] ?? "").ToString())
                {
                    case "0":
                        field += "臍上3指";
                        break;
                    case "1":
                        field += "臍上2指";
                        break;
                    case "2":
                        field += "臍上1指";
                        break;
                    case "3":
                        field += "臍平";
                        break;
                    case "4":
                        field += "臍下1指";
                        break;
                    case "5":
                        field += "臍下2指";
                        break;
                    case "6":
                        field += "臍下3指";
                        break;
                    case "7":
                        field += "無法測量";
                        break;
                    case "8":
                        field += form["TXT_UTERUS_HEIGHT_OTH" + id_list[v]] ?? "";
                        break;
                    default:
                        field += "無";
                        break;
                }
                content.Add(field);
                #endregion

                #region 惡露量 
                field = "惡露量";
                switch ((form["RB_LOCHIA_STAT" + id_list[v]] ?? "").ToString())
                {
                    case "0":
                        field += "微量";
                        break;
                    case "1":
                        field += "少";
                        break;
                    case "2":
                        field += "中";
                        break;
                    case "3":
                        field += "多";
                        break;
                    default:
                        field += "無";
                        break;
                }

                field += "色";
                switch ((form["RB_LOCHIA_COLOR" + id_list[v]] ?? "").ToString())
                {
                    case "0":
                        field += "鮮紅";
                        break;
                    case "1":
                        field += "深紅";
                        break;
                    case "2":
                        field += "淡紅";
                        break;
                    case "3":
                        field += form["TXT_LOCHIA_COLOR_OTH" + id_list[v]] ?? "";
                        break;
                    default:
                        field += "無";
                        break;
                }

                if (IsNoEmpty(form["TXT_LOCHIA" + id_list[v]]))
                    field += $"，秤重約{(IsNoEmpty(form["TXT_LOCHIA" + id_list[v]]) == true ? form["TXT_LOCHIA" + id_list[v]] : "0")} g";

                content.Add(field);
                #endregion

                semicolon.Add(String.Join("，", content));

                #region 下肢
                field = "";
                if (form["RB_LL_RED" + id_list[v]] == null && form["RB_LL_SWO" + id_list[v]] == null && form["RB_LL_TEN" + id_list[v]] == null && form["RB_LL_HS" + id_list[v]] == null)
                {
                    field += "";
                }
                else
                {
                    //雙肢都無
                    field = "評估";
                    if (form["RB_LL_RED" + id_list[v]] == "0" && form["RB_LL_SWO" + id_list[v]] == "0" && form["RB_LL_TEN" + id_list[v]] == "0" && form["RB_LL_HS" + id_list[v]] == "0")
                    {
                        field += "雙下肢無紅、腫、壓痛，霍曼氏徵象無";
                    }
                    else
                    {
                        //左肢都無
                        if (form["CK_LL_RED_LR" + id_list[v]]?.IndexOf('0') < 0 && form["CK_LL_SWO_LR" + id_list[v]]?.IndexOf('0') < 0 && form["CK_LL_TEN_LR" + id_list[v]]?.IndexOf('0') < 0 && form["CK_LL_HS_LR" + id_list[v]]?.IndexOf('0') < 0)
                            field += "左下肢無紅、腫、壓痛，霍曼氏徵象無";
                        else
                        {
                            var L_RED = form["RB_LL_RED_LS" + id_list[v]];
                            switch ((L_RED ?? "").ToString())
                            {
                                case "0":
                                case "3":
                                case "4":
                                    field += "下肢 紅 有 左有紅，";
                                    break;
                                case "1":
                                    field += "下肢 紅 有 左無紅，";
                                    break;
                                case "2":
                                    field += "下肢 紅 有 左輕微紅，";
                                    break;
                                default:
                                    field += "";
                                    break;
                            }

                            var L_SWO = form["RB_LL_SWO_LS" + id_list[v]];
                            switch ((L_SWO ?? "").ToString())
                            {
                                case "0":
                                    field += "下肢 腫 有 左有凹陷性水腫2mm，";
                                    break;
                                case "1":
                                    field += "下肢 腫 有 左無水腫，";
                                    break;
                                case "2":
                                    field += "下肢 腫 有 左輕微水腫，";
                                    break;
                                case "3":
                                    field += "下肢 腫 有 左有凹陷性水腫4mm，";
                                    break;
                                case "4":
                                    field += "下肢 腫 有 左有凹陷性水腫6mm，";
                                    break;
                                case "5":
                                    field += "下肢 腫 有 左有凹陷性水腫8mm，";
                                    break;
                                default:
                                    field += "";
                                    break;
                            }

                            switch ((form["RB_LL_TEN_LS" + id_list[v]] ?? "").ToString())
                            {
                                case "0":
                                case "3":
                                case "4":
                                    field += "下肢 壓痛 有 左按壓時有疼痛，";
                                    break;
                                case "1":
                                    field += "下肢 壓痛 有 左按壓時無疼痛，";
                                    break;
                                case "2":
                                    field += "下肢 壓痛 有 左按壓時輕微疼痛，";
                                    break;
                                default:
                                    field += "";
                                    break;
                            }

                            switch ((form["RB_LL_HS_LS" + id_list[v]] ?? "").ToString())
                            {
                                case "0":
                                case "3":
                                case "4":
                                    field += "下肢 霍曼氏徵象 有 左有；";
                                    break;
                                case "1":
                                    field += "下肢 霍曼氏徵象 有 左無；";
                                    break;
                                case "2":
                                    field += "下肢 霍曼氏徵象 有 左無法判斷；";
                                    break;
                                default:
                                    field += "";
                                    break;
                            }
                        }
                        //右肢都無
                        if (form["CK_LL_RED_LR" + id_list[v]]?.IndexOf('1') < 0 && form["CK_LL_SWO_LR" + id_list[v]]?.IndexOf('1') < 0 && form["CK_LL_TEN_LR" + id_list[v]]?.IndexOf('1') < 0 && form["CK_LL_HS_LR" + id_list[v]]?.IndexOf('1') < 0)
                            field += "右下肢無紅、腫、壓痛，霍曼氏徵象無";
                        else
                        {
                            field += "右下肢";

                            var R_RED = form["RB_LL_RED_RS" + id_list[v]];
                            switch ((R_RED ?? "").ToString())
                            {
                                case "0":
                                case "3":
                                case "4":
                                    field += "下肢 紅 有 右有紅，";
                                    break;
                                case "1":
                                    field += "下肢 紅 有 右無紅，";
                                    break;
                                case "2":
                                    field += "下肢 紅 有 右輕微紅，";
                                    break;
                                default:
                                    field += "";
                                    break;
                            }

                            var R_SWO = form["RB_LL_SWO_RS" + id_list[v]];
                            switch ((R_SWO ?? "").ToString())
                            {
                                case "0":
                                    field += "下肢 腫 有 右有凹陷性水腫2mm，";
                                    break;
                                case "1":
                                    field += "下肢 腫 有 右無水腫，";
                                    break;
                                case "2":
                                    field += "下肢 腫 有 右輕微水腫，";
                                    break;
                                case "3":
                                    field += "下肢 腫 有 右有凹陷性水腫4mm，";
                                    break;
                                case "4":
                                    field += "下肢 腫 有 右有凹陷性水腫6mm，";
                                    break;
                                case "5":
                                    field += "下肢 腫 有 右有凹陷性水腫8mm，";
                                    break;
                                default:
                                    field += "";
                                    break;
                            }

                            switch ((form["RB_LL_TEN_RS" + id_list[v]] ?? "").ToString())
                            {
                                case "0":
                                case "3":
                                case "4":
                                    field += "下肢 壓痛 有 右按壓時有疼痛，";
                                    break;
                                case "1":
                                    field += "下肢 壓痛 有 右按壓時無疼痛，";
                                    break;
                                case "2":
                                    field += "下肢 壓痛 有 右按壓時輕微疼痛，";
                                    break;
                                default:
                                    field += "";
                                    break;
                            }

                            switch ((form["RB_LL_HS_RS" + id_list[v]] ?? "").ToString())
                            {
                                case "0":
                                case "3":
                                case "4":
                                    field += "下肢 霍曼氏徵象 有 右有；";
                                    break;
                                case "1":
                                    field += "下肢 霍曼氏徵象 有 右無；";
                                    break;
                                case "2":
                                    field += "下肢 霍曼氏徵象 有 右無法判斷；";
                                    break;
                                default:
                                    field += "";
                                    break;
                            }
                        }
                    }
                }
                #endregion
                if (field != "")
                    semicolon.Add(field);

                #region 排尿
                field = "";

                switch ((form["RB_URINE_SELF" + id_list[v]] ?? "").ToString())
                {
                    case "0":
                        field += "自解尿液順暢";
                        break;
                    case "1":
                        field += "尚未自解尿液";
                        break;
                    default:
                        field += "";
                        break;
                }

                if (IsNoEmpty(form["TXT_URINE_SINGLE_AMT" + id_list[v]]) && IsNoEmpty(form["RB_URINE_SINGLE_STAT" + id_list[v]]))
                {
                    field += $"無法自解尿液，給予單導，尿液量為{(IsNoEmpty(form["TXT_URINE_SINGLE_AMT" + id_list[v]]) == true ? form["TXT_URINE_SINGLE_AMT" + id_list[v]] : "0")}cc，色";

                    switch ((form["RB_URINE_SINGLE_STAT" + id_list[v]] ?? "").ToString())
                    {
                        case "0":
                            field += "黃";
                            break;
                        case "1":
                            field += "褐";
                            break;
                        case "2":
                            field += "暗紅";
                            break;
                        case "3":
                            field += "淡紅";
                            break;
                        case "4":
                            field += "鮮紅";
                            break;
                        default:
                            field += "未填寫";
                            break;
                    }

                    field += "。";
                }

                if (IsNoEmpty(form["TXT_URINE_CAT_AMT" + id_list[v]]) && IsNoEmpty(form["RB_URINE_CAT_STAT" + id_list[v]]))
                {
                    field += $"留置導尿管，尿液量為{(IsNoEmpty(form["TXT_URINE_CAT_AMT" + id_list[v]]) == true ? form["TXT_URINE_CAT_AMT" + id_list[v]] : "0")}cc，色";
                    switch ((form["RB_URINE_CAT_STAT" + id_list[v]] ?? "").ToString())
                    {
                        case "0":
                            field += "黃";
                            break;
                        case "1":
                            field += "褐";
                            break;
                        case "2":
                            field += "暗紅";
                            break;
                        case "3":
                            field += "淡紅";
                            break;
                        case "4":
                            field += "鮮紅";
                            break;
                        default:
                            field += "未填寫";
                            break;
                    }

                    field += "。";
                }

                if (IsNoEmpty(field))
                    semicolon.Add(field);
                #endregion

                erow += base.Upd_CareRecord(form["TXT_RECORDTIME_DAY" + id_list[v]] + " " + form["TXT_RECORDTIME_TIME" + id_list[v]], id_list[v], title, String.Join("；", semicolon), "", "", "", "", "OBS_AFTBTH");

                #endregion
            }
            if (erow > 0 && erow >= id_list.Length)
            {
                link.DBCommit();
                Response.Write("<script>alert('修改成功');window.opener.location.href='Index?active=Postnatal_Record_List&show=Y';window.close();</script>");
            }
            else
            {
                link.DBRollBack();
                Response.Write("<script>alert('修改失敗');window.opener.location.href='Index?active=Postnatal_Record_List&show=Y';window.close();</script>");
            }

            return new EmptyResult();
        }
        #endregion

        #region 刪除產後護理資料
        [HttpPost]
        public string Del_Postnatal_Record()
        {
            link.DBOpen();
            string[] id = Request["del_ID"].ToString().Split(',');

            bool UnAuthorized = false;
            for (var i = 0; i < id.Length; i++)
            {
                DataTable dt = obs_m.sel_aft_bth("", id[i], userinfo.EmployeesNo);
                if (dt == null || dt.Rows.Count == 0)
                {
                    //Response.Write("<script>alert('無權限修改!');window.close();</script>");
                    UnAuthorized = true;
                    break;
                }
            }
            if (!UnAuthorized)
            {
                List<DBItem> insertDataList = new List<DBItem>();
                insertDataList.Add(new DBItem("DELETED", userinfo.EmployeesNo, DBItem.DBDataType.String));
                string where = " IID IN ('" + String.Join("','", id) + "')";
                insertDataList = setNullToEmpty(insertDataList);
                int erow = link.DBExecUpdate("OBS_AFTBTH", insertDataList, where);
                //erow += link.DBExecUpdate("OBS_ABDISP", insertDataList, where);
                //erow += link.DBExecUpdate("OBS_ABDISP_DETAIL", insertDataList, where);

                DataTable sta = obs_m.sel_bthsta(ptinfo.FeeNo);
                if (erow > 0)
                {
                    for (int i = 0; i < id.Length; i++)
                    {
                        if (sta != null && sta.Rows.Count > 0)
                        {
                            Delete_Wound_Data(sta.Rows[0]["IID"].ToString() + "0", id[i] + "0");
                            Delete_Wound_Data(sta.Rows[0]["IID"].ToString() + "1", id[i] + "1");
                        }
                        //base.Del_CareRecordTns(id[i], "OBS_AFTBTH", ref link);
                        base.Del_CareRecord(id[i], "OBS_AFTBTH");
                    }
                    return "1";
                }
                else
                    return "-1";
            }
            else
            {
                return "-501";
            }
        }
        #endregion

        #region 產後護理流速畫面
        public ActionResult AB_Disp(string IID, string SNOM)
        {
            if (SNOM != null && SNOM != "")
            {
                DataTable dt = obs_m.sel_ab_disp(ptinfo.FeeNo, IID, SNOM);
                dt.Columns.Add("TM_MED_SPEED");
                foreach (DataRow r in dt.Rows)
                {
                    //抓取每筆藥物調配的最新流速
                    DataTable dt_Ab_Disp_Dtl = obs_m.sel_ab_disp_detail(ptinfo.FeeNo, IID, SNOM);
                    if (dt_Ab_Disp_Dtl != null && dt_Ab_Disp_Dtl.Rows.Count > 0)
                        r["TM_MED_SPEED"] = dt_Ab_Disp_Dtl.Rows[0]["TM_MED_SPEED"];
                    else
                        r["TM_MED_SPEED"] = "";
                }
                ViewBag.dt = set_dt(dt);
            }
            ViewBag.SNOM = SNOM;
            ViewBag.IID = IID;
            return View();
        }
        #endregion

        #region 產後護理流速新增
        public ActionResult Insert_AB_Disp(FormCollection form)
        {
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo.FeeNo;
            string IID = form["IID"];

            var lastSeq = 0;
            DataTable dt_ab_disp = obs_m.sel_ab_disp_seq(feeno, IID);
            if (dt_ab_disp != null && dt_ab_disp.Rows.Count == 1)
                lastSeq = Convert.ToInt32(dt_ab_disp.Rows[0]["SNOM"]);
            var seq = (Convert.ToInt32(lastSeq) + 1).ToString();

            List<DBItem> insertDataListM = new List<DBItem>();
            insertDataListM.Add(new DBItem("IID", IID, DBItem.DBDataType.String)); //流水號
            insertDataListM.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String)); //批價序號
            insertDataListM.Add(new DBItem("SNOM", seq, DBItem.DBDataType.String)); //序號
            insertDataListM.Add(new DBItem("CREATNO", form["TXT_CREATNO"], DBItem.DBDataType.String)); //評估者員編
            insertDataListM.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
            insertDataListM.Add(new DBItem("RECORDTIME", form["TXT_RECORDTIME_DAY"] + " " + form["TXT_RECORDTIME_TIME"], DBItem.DBDataType.DataTime));//紀錄時間
            insertDataListM.Add(new DBItem("TM_MED_A", form["TXT_TM_MED_A"], DBItem.DBDataType.String)); //醫療處置-調配-A藥品種類
            insertDataListM.Add(new DBItem("TM_MED_A_AMT", form["TXT_TM_MED_A_AMT"], DBItem.DBDataType.String)); //醫療處置-調配-A藥品劑量
            insertDataListM.Add(new DBItem("TM_MED_B", form["TXT_TM_MED_B"], DBItem.DBDataType.String)); //醫療處置-調配-B藥品種類
            insertDataListM.Add(new DBItem("TM_MED_B_AMT", form["TXT_TM_MED_B_AMT"], DBItem.DBDataType.String)); //醫療處置-調配-B藥品劑量
            insertDataListM.Add(new DBItem("TM_MED_USE", form["TXT_TM_MED_USE"], DBItem.DBDataType.String)); //醫療處置-A+B組合總用量
            insertDataListM.Add(new DBItem("TM_MED_USE_STAT", form["RB_TM_MED_USE_STAT"], DBItem.DBDataType.String)); //醫療處置-A+B組合狀態
            insertDataListM = setNullToEmpty(insertDataListM);
            int erowM = obs_m.DBExecInsert("OBS_ABDISP", insertDataListM);

            if (erowM > 0)
            {
                //新增藥物調配明細
                List<DBItem> insertDataListD = new List<DBItem>();
                insertDataListD.Add(new DBItem("IID", IID, DBItem.DBDataType.String)); //流水號
                insertDataListD.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String)); //批價序號
                insertDataListD.Add(new DBItem("SNOM", seq, DBItem.DBDataType.String)); //產程藥物調配序號
                insertDataListD.Add(new DBItem("SNOD", "1", DBItem.DBDataType.String)); //序號
                insertDataListD.Add(new DBItem("CREATNO", userno, DBItem.DBDataType.String)); //評估者員編
                insertDataListD.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
                insertDataListD.Add(new DBItem("RECORDTIME", form["TXT_RECORDTIME_DAY"] + " " + form["TXT_RECORDTIME_TIME"], DBItem.DBDataType.DataTime));//紀錄時間

                insertDataListD.Add(new DBItem("TM_MED_SPEED", form["TXT_TM_MED_SPEED"], DBItem.DBDataType.Number)); //醫療處置-A+B組合流速
                insertDataListD = setNullToEmpty(insertDataListD);
                int erowD = obs_m.DBExecInsert("OBS_ABDISP_DETAIL", insertDataListD);
                if (erowD > 0)
                    Response.Write("<script>alert('新增成功');window.opener.location.href=window.opener.location.href;window.close();</script>");
                else
                    Response.Write("<script>alert('藥物調配明細新增失敗');window.opener.location.href=window.opener.location.href;window.close();</script>");
            }
            else
                Response.Write("<script>alert('新增失敗');window.opener.location.href=window.opener.location.href;window.close();</script>");

            return new EmptyResult();
        }
        #endregion

        #region 產後護理流速編輯
        public ActionResult Upd_AB_Disp(FormCollection form)
        {
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo.FeeNo;
            string id = form["IID"];
            string snom = form["SNOM"];
            int erow = 0;

            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("UPDNO", form["TXT_CREATNO"], DBItem.DBDataType.String)); //編輯者員編
            insertDataList.Add(new DBItem("UPDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //更新時間
            insertDataList.Add(new DBItem("RECORDTIME", form["TXT_RECORDTIME_DAY" + id + snom] + " " + form["TXT_RECORDTIME_TIME" + id + snom], DBItem.DBDataType.DataTime));//紀錄時間
                                                                                                                                                                             //藥物調配僅能修改狀態
            insertDataList.Add(new DBItem("TM_MED_A_AMT", form["TXT_TM_MED_A_AMT" + id + snom], DBItem.DBDataType.String)); //醫療處置-A+B組合狀態
            insertDataList.Add(new DBItem("TM_MED_B_AMT", form["TXT_TM_MED_B_AMT" + id + snom], DBItem.DBDataType.String)); //醫療處置-A+B組合狀態
            insertDataList.Add(new DBItem("TM_MED_USE", form["TXT_TM_MED_USE" + id + snom], DBItem.DBDataType.String)); //醫療處置-A+B組合狀態
            insertDataList.Add(new DBItem("TM_MED_USE_STAT", form["RB_TM_MED_USE_STAT" + id + snom], DBItem.DBDataType.String)); //醫療處置-A+B組合狀態

            string where = " IID = '" + id + "' AND SNOM = '" + snom + "' ";
            insertDataList = setNullToEmpty(insertDataList);
            erow = obs_m.DBExecUpdate("OBS_ABDISP", insertDataList, where);
            if (erow > 0)
            {
                //取出流速最後一筆的序號及流速
                var lastSeq = 0;
                var lastSpeed = "";
                DataTable dt_ab_disp_dtl = obs_m.sel_ab_disp_detail_seq(feeno, id, snom);
                if (dt_ab_disp_dtl != null && dt_ab_disp_dtl.Rows.Count == 1)
                {
                    lastSeq = Convert.ToInt32(dt_ab_disp_dtl.Rows[0]["SNOD"]);
                    lastSpeed = dt_ab_disp_dtl.Rows[0]["TM_MED_SPEED"].ToString();
                }

                //流速改變才新增，沒有不動作
                if (lastSpeed != form["TXT_TM_MED_SPEED" + id + snom])
                {
                    var seq = (Convert.ToInt32(lastSeq) + 1).ToString();
                    //新增藥物調配明細
                    List<DBItem> insertDataListD = new List<DBItem>();
                    insertDataListD.Add(new DBItem("IID", id, DBItem.DBDataType.String)); //流水號
                    insertDataListD.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String)); //批價序號
                    insertDataListD.Add(new DBItem("SNOM", snom, DBItem.DBDataType.String)); //產程藥物調配序號
                    insertDataListD.Add(new DBItem("SNOD", seq, DBItem.DBDataType.String)); //序號
                    insertDataListD.Add(new DBItem("CREATNO", form["TXT_CREATNO"], DBItem.DBDataType.String)); //評估者員編
                    insertDataListD.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
                    insertDataList.Add(new DBItem("RECORDTIME", form["TXT_RECORDTIME_DAY" + id + snom] + " " + form["TXT_RECORDTIME_TIME" + id + snom], DBItem.DBDataType.DataTime));//紀錄時間
                    insertDataListD.Add(new DBItem("TM_MED_SPEED", form["TXT_TM_MED_SPEED" + id + snom], DBItem.DBDataType.Number)); //醫療處置-A+B組合流速
                    insertDataListD = setNullToEmpty(insertDataListD);
                    int erowD = obs_m.DBExecInsert("OBS_ABDISP_DETAIL", insertDataListD);
                    if (erowD <= 0)
                        Response.Write("<script>alert('藥物調配明細新增失敗');window.opener.location.href=window.opener.location.href;window.close();</script>");
                    else
                        Response.Write("<script>alert('修改成功');window.opener.location.href=window.opener.location.href;window.close();</script>");
                }
                else
                    Response.Write("<script>alert('修改成功');window.opener.location.href=window.opener.location.href;window.close();</script>");
            }
            else
                Response.Write("<script>alert('修改失敗');window.opener.location.href=window.opener.location.href;window.close();</script>");

            return new EmptyResult();
        }

        #endregion


        #region 陰道塞紗畫面
        public ActionResult VaginalYam()
        {
            DataTable dt = obs_m.sel_vagyarn(ptinfo?.FeeNo);
            dt.Columns.Add("PUTIN_ID_NAME");
            dt.Columns.Add("TAKEOUT_ID_NAME");
            var sum = 0;
            if (dt != null && dt.Rows.Count > 0)
            {
                foreach (DataRow r in dt.Rows)
                {

                    if (r["PUTIN_ID"].ToString() != "")
                    {
                        byte[] listByteCode = webService.UserName(r["PUTIN_ID"].ToString());
                        if (listByteCode == null)
                            r["PUTIN_ID_NAME"] = "";
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(listByteCode);
                            UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                            r["PUTIN_ID_NAME"] = user_name.EmployeesName;
                        }
                    }

                    if (r["TAKEOUT_ID"].ToString() != "")
                    {
                        byte[] listByteCode = webService.UserName(r["TAKEOUT_ID"].ToString());
                        if (listByteCode == null)
                            r["TAKEOUT_ID_NAME"] = "";
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(listByteCode);
                            UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                            r["TAKEOUT_ID_NAME"] = user_name.EmployeesName;
                        }
                    }

                    if (r["PUTIN_AMT"].ToString() != "")
                        sum += Convert.ToInt32(r["PUTIN_AMT"].ToString());
                    if (r["TAKEOUT_AMT"].ToString() != "")
                        sum -= Convert.ToInt32(r["TAKEOUT_AMT"].ToString());
                }
            }

            ViewBag.sum = sum;
            ViewBag.dt = set_dt(dt);
            return View();
        }
        #endregion

        #region 陰道塞紗新增
        public ActionResult Insert_VagYarn(FormCollection form)
        {
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo?.FeeNo;
            string id = base.creatid("OBS_YAGYARN", userno, feeno, "0");

            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("IID", id, DBItem.DBDataType.String)); //序號
            insertDataList.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String)); //建立者員編
            insertDataList.Add(new DBItem("CREATNO", userno, DBItem.DBDataType.String)); //建立者員編
            insertDataList.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
            insertDataList.Add(new DBItem("RECORDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間
            insertDataList.Add(new DBItem("DELETED", null, DBItem.DBDataType.String)); //刪除註記

            if (form["PUTIN_TIME_DAY"] != "" && form["PUTIN_TIME_DAY"] != null && form["PUTIN_TIME_TIME"] != "" && form["PUTIN_TIME_TIME"] != null)
                insertDataList.Add(new DBItem("PUTIN_TIME", form["PUTIN_TIME_DAY"] + " " + form["PUTIN_TIME_TIME"], DBItem.DBDataType.DataTime)); //紀錄時間
            insertDataList.Add(new DBItem("PUTIN_AMT", form["DDL_PUTIN_AMT"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("PUTIN_ID", form["TXT_PUTIN_ID"], DBItem.DBDataType.String));
            if (form["TAKEOUT_TIME_DAY"] != "" && form["TAKEOUT_TIME_DAY"] != null && form["TAKEOUT_TIME_TIME"] != "" && form["TAKEOUT_TIME_TIME"] != null)
                insertDataList.Add(new DBItem("TAKEOUT_TIME", form["TAKEOUT_TIME_DAY"] + " " + form["TAKEOUT_TIME_TIME"], DBItem.DBDataType.DataTime)); //紀錄時間
            insertDataList.Add(new DBItem("TAKEOUT_AMT", form["DDL_TAKEOUT_AMT"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("TAKEOUT_ID", form["TXT_TAKEOUT_ID"], DBItem.DBDataType.String));
            insertDataList = setNullToEmpty(insertDataList);
            int erow = link.DBExecInsert("OBS_YAGYARN", insertDataList);

            var content = "";
            var user = new UserInfo();
            if (IsNoEmpty(form["DDL_PUTIN_AMT"]) && form["DDL_PUTIN_AMT"] != "0")
            {
                user = Get_Employee_Info(form["TXT_PUTIN_ID"]);
                content = $"{user?.EmployeesName} {user?.JobGrade}，予放置陰道塞紗";
                switch ((form["DDL_PUTIN_AMT"] ?? "").ToString())
                {
                    case "1":
                        content += "1條";
                        break;
                    case "2":
                        content += "2條1串";
                        break;
                    case "3":
                        content += "3條1串";
                        break;
                    case "4":
                        content += "4條1串";
                        break;
                    case "5":
                        content += "5條1串";
                        break;
                    default:
                        content += "";
                        break;
                }
                erow += base.Insert_CareRecordTns(form["PUTIN_TIME_DAY"] + " " + form["PUTIN_TIME_TIME"], id, "陰道塞紗-放置", content + "。", "", "", "", "", "OBS_YAGYARN", ref link);
            }
            else if (IsNoEmpty(form["DDL_TAKEOUT_AMT"]) && form["DDL_TAKEOUT_AMT"] != "0")
            {
                user = Get_Employee_Info(form["TXT_TAKEOUT_ID"]);
                content = $"{user?.EmployeesName} {user?.JobGrade}，予取出陰道塞紗";
                switch ((form["DDL_TAKEOUT_AMT"] ?? "").ToString())
                {
                    case "1":
                        content += "1條";
                        break;
                    case "2":
                        content += "2條1串";
                        break;
                    case "3":
                        content += "3條1串";
                        break;
                    case "4":
                        content += "4條1串";
                        break;
                    case "5":
                        content += "5條1串";
                        break;
                    default:
                        content += "";
                        break;
                }
                erow += base.Insert_CareRecordTns(form["TAKEOUT_TIME_DAY"] + " " + form["TAKEOUT_TIME_TIME"], id, "陰道塞紗-取出", content + "。", "", "", "", "", "OBS_YAGYARN", ref link);
            }

            if (erow == 2)
            {
                link.DBCommit();
                Response.Write("<script>alert('新增成功');window.location.href='VaginalYam';</script>");
            }
            else
            {
                link.DBRollBack();
                Response.Write("<script>alert('新增失敗');window.location.href='VaginalYam';</script>");
            }

            return new EmptyResult();
        }
        #endregion

        #region 陰道塞紗編輯
        [HttpPost]
        public int Upd_VagYarn(FormCollection form)
        {
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo?.FeeNo;
            string[] id_list = form["IID"].Split(',');
            int erow = 0;
            for (int v = 0; v < id_list.Length; v++)
            {
                List<DBItem> insertDataList = new List<DBItem>();
                insertDataList.Add(new DBItem("RECORDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間

                if (form["PUTIN_TIME_DAY"] != "" && form["PUTIN_TIME_DAY"] != null && form["PUTIN_TIME_TIME"] != "" && form["PUTIN_TIME_TIME"] != null)
                    insertDataList.Add(new DBItem("PUTIN_TIME", form["PUTIN_TIME_DAY"] + " " + form["PUTIN_TIME_TIME"], DBItem.DBDataType.DataTime)); //紀錄時間
                insertDataList.Add(new DBItem("PUTIN_AMT", form["DDL_PUTIN_AMT"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("PUTIN_ID", form["TXT_PUTIN_ID"], DBItem.DBDataType.String));
                if (form["TAKEOUT_TIME_DAY"] != "" && form["TAKEOUT_TIME_DAY"] != null && form["TAKEOUT_TIME_TIME"] != "" && form["TAKEOUT_TIME_TIME"] != null)
                    insertDataList.Add(new DBItem("TAKEOUT_TIME", form["TAKEOUT_TIME_DAY"] + " " + form["TAKEOUT_TIME_TIME"], DBItem.DBDataType.DataTime)); //紀錄時間
                insertDataList.Add(new DBItem("TAKEOUT_AMT", form["DDL_TAKEOUT_AMT"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("TAKEOUT_ID", form["TXT_TAKEOUT_ID"], DBItem.DBDataType.String));

                string where = " IID = '" + id_list[v] + "' ";
                insertDataList = setNullToEmpty(insertDataList);
                erow += obs_m.DBExecUpdate("OBS_YAGYARN", insertDataList, where);

                var content = "";
                var user = new UserInfo();
                if (IsNoEmpty(form["DDL_PUTIN_AMT"]) && form["DDL_PUTIN_AMT"] != "0")
                {
                    user = Get_Employee_Info(form["TXT_PUTIN_ID"]);
                    content = $"{user?.EmployeesName} {user?.JobGrade}，予放置陰道塞紗";
                    switch ((form["DDL_PUTIN_AMT"] ?? "").ToString())
                    {
                        case "1":
                            content += "1條";
                            break;
                        case "2":
                            content += "2條1串";
                            break;
                        case "3":
                            content += "3條1串";
                            break;
                        case "4":
                            content += "4條1串";
                            break;
                        case "5":
                            content += "5條1串";
                            break;
                        default:
                            content += "";
                            break;
                    }
                    erow += base.Insert_CareRecordTns(form["PUTIN_TIME_DAY"] + " " + form["PUTIN_TIME_TIME"], id_list[v], "陰道塞紗-放置", content + "。", "", "", "", "", "OBS_YAGYARN", ref link);
                }
                else if (IsNoEmpty(form["DDL_TAKEOUT_AMT"]) && form["DDL_TAKEOUT_AMT"] != "0")
                {
                    user = Get_Employee_Info(form["TXT_TAKEOUT_ID"]);
                    content = $"{user?.EmployeesName} {user?.JobGrade}，予取出陰道塞紗";
                    switch ((form["DDL_TAKEOUT_AMT"] ?? "").ToString())
                    {
                        case "1":
                            content += "1條";
                            break;
                        case "2":
                            content += "2條1串";
                            break;
                        case "3":
                            content += "3條1串";
                            break;
                        case "4":
                            content += "4條1串";
                            break;
                        case "5":
                            content += "5條1串";
                            break;
                        default:
                            content += "";
                            break;
                    }
                    erow += base.Upd_CareRecord(form["TAKEOUT_TIME_DAY"] + " " + form["TAKEOUT_TIME_TIME"], id_list[v], "陰道塞紗-取出", content + "。", "", "", "", "", "OBS_YAGYARN");
                }
            }
            if (erow == 2 * id_list.Length)
            {
                link.DBCommit();
                // Response.Write("<script>alert('修改成功');window.location.href='VaginalYam';</script>");
            }
            else
            {
                link.DBRollBack();
                // Response.Write("<script>alert('修改失敗');window.location.href='VaginalYam';</script>");
            }

            return erow;
        }
        #endregion

        #region 取得單一筆陰道塞紗資料
        public string Get_VaginalYarn(string IID)
        {
            DataTable dt = obs_m.sel_vagyarn(ptinfo?.FeeNo, IID);
            dt.Columns.Add("PUTIN_ID_NAME");
            dt.Columns.Add("TAKEOUT_ID_NAME");
            if (dt != null && dt.Rows.Count > 0)
            {
                foreach (DataRow r in dt.Rows)
                {

                    if (r["PUTIN_ID"].ToString() != "")
                    {
                        byte[] listByteCode = webService.UserName(r["PUTIN_ID"].ToString());
                        if (listByteCode == null)
                            r["PUTIN_ID_NAME"] = "";
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(listByteCode);
                            UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                            r["PUTIN_ID_NAME"] = user_name.EmployeesName;
                        }
                    }

                    if (r["TAKEOUT_ID"].ToString() != "")
                    {
                        byte[] listByteCode = webService.UserName(r["TAKEOUT_ID"].ToString());
                        if (listByteCode == null)
                            r["TAKEOUT_ID_NAME"] = "";
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(listByteCode);
                            UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                            r["TAKEOUT_ID_NAME"] = user_name.EmployeesName;
                        }
                    }
                }
            }
            return JsonConvert.SerializeObject(dt.Rows[0]);
        }
        #endregion


        #region 陰道塞紗刪除
        /// <summary>
        /// 陰道塞紗刪除
        /// </summary>
        /// <param name="form"></param>
        /// <returns></returns>
        [HttpPost]
        public string Del_VagYarn()
        {
            string[] id_list = Request["IID"].ToString().Split(',');
            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("DELETED", userinfo.EmployeesNo, DBItem.DBDataType.String));
            string where = " IID IN ('" + String.Join("','", id_list) + "')";
            insertDataList = setNullToEmpty(insertDataList);
            int erow = obs_m.DBExecUpdate("OBS_YAGYARN", insertDataList, where);

            //20200302 也要刪除護理紀錄
            link.DBOpen();
            foreach (var v in id_list)
                //base.Del_CareRecordTns(v, "OBS_YAGYARN", ref link);
                base.Del_CareRecord(v, "OBS_YAGYARN");

            return erow.ToString();
        }
        #endregion


        #region 共用處置(產程監測、新生兒緊急處置)
        /// <summary>
        /// 共用處置
        /// </summary>
        /// <param name="title"></param>
        /// <returns></returns>
        [HttpGet]
        public ActionResult SharedVitalSign(string title, string checkValue)
        {
            DataTable SVODt = obs_m.sel_SHARED_VITALSIGN_OPTION(title);
            ViewBag.SVODt = SVODt;
            ViewBag.checkValue = checkValue;
            return View();
        }
        #endregion

        #region 母嬰護理與親子同室、皮膚接觸資訊整合開窗
        public ActionResult All_Touch_List(string feeno)
        {
            if (IsNoEmpty(feeno))
            {
                his.ControllerContext = ControllerContext;
                his.getSession(feeno);
            }

            if (Session["PatInfo"] != null)
            {
                var ptInfo = Session["PatInfo"] as PatientInfo;

                if (feeno == "" || feeno == null)
                    feeno = ptInfo.FeeNo;

                if (ptInfo.Age < 1)
                {
                    DataTable dt_babylink = obs_m.sel_nbcha(ptInfo.FeeNo, "", "");
                    if (dt_babylink != null && dt_babylink.Rows.Count > 0)
                    {
                        DataRow babylink = dt_babylink.Rows[0];
                        var mom_feeno = babylink["MOM_FEE_NO"].ToString();

                        #region 母嬰護理
                        DataTable dt_bf = obs_m.sel_Breast_Fedding(mom_feeno, "", "", ptInfo.FeeNo); // mom
                        dt_bf.Columns.Add("SOURCE");
                        foreach (DataRow r in dt_bf.Rows)
                        {
                            r["SOURCE"] = "母親";
                        }

                        DataTable dt_bf_b = obs_m.sel_Breast_Fedding(ptInfo.FeeNo, "", ""); // baby
                        dt_bf_b.Columns.Add("SOURCE");
                        foreach (DataRow r in dt_bf_b.Rows)
                        {
                            r["NB_SEQ_FEENO"] = $"{babylink["BABY_SEQ"].ToString()},新生兒{babylink["BABY_SEQ"].ToString()},{babylink["BABY_FEE_NO"].ToString()}";
                            r["SOURCE"] = "小孩";
                        }
                        dt_bf.Merge(dt_bf_b);
                        #endregion

                        dt_bf.Columns.Add("ROOMIN_Y");
                        dt_bf.Columns.Add("ROOMIN_N");
                        dt_bf.Columns.Add("SKINTOUCH_Y");
                        dt_bf.Columns.Add("SKINTOUCH_N");
                        dt_bf.Columns.Add("LOCATION");

                        #region 親子同室
                        DataTable dt_roomin = obs_m.sel_roomin("", "", "", null, mom_feeno); // mom
                        foreach (DataRow r in dt_roomin.Rows)
                        {
                            if (r["START_TIME"].ToString() != "")
                            {
                                DataRow row = dt_bf.NewRow();
                                row["IID"] = r["IID"];
                                row["FEENO"] = r["FEENO"];
                                row["SOURCE"] = "母親";
                                row["NB_SEQ_FEENO"] = r["SEQ_OF_NB"];
                                row["RECORDTIME"] = Convert.ToDateTime(r["START_TIME"].ToString()).ToString("yyyy/MM/dd HH:mm");
                                row["ROOMIN_Y"] = "V";
                                dt_bf.Rows.Add(row);
                            }
                            if (r["END_TIME"].ToString() != "")
                            {
                                DataRow row = dt_bf.NewRow();
                                row["IID"] = r["IID"];
                                row["FEENO"] = r["FEENO"];
                                row["SOURCE"] = "母親";
                                row["NB_SEQ_FEENO"] = r["SEQ_OF_NB"];
                                row["RECORDTIME"] = Convert.ToDateTime(r["END_TIME"].ToString()).ToString("yyyy/MM/dd HH:mm");
                                row["ROOMIN_N"] = "V";
                                dt_bf.Rows.Add(row);
                            }
                        }

                        DataTable dt_roomin_b = obs_m.sel_roomin("", "", "", null, ptInfo.FeeNo); // baby
                        foreach (DataRow r in dt_roomin_b.Rows)
                        {
                            if (r["START_TIME"].ToString() != "")
                            {
                                DataRow row = dt_bf.NewRow();
                                row["IID"] = r["IID"];
                                row["FEENO"] = r["FEENO"];
                                row["SOURCE"] = "小孩";
                                row["NB_SEQ_FEENO"] = $"{babylink["BABY_SEQ"].ToString()},新生兒{babylink["BABY_SEQ"].ToString()},{babylink["BABY_FEE_NO"].ToString()}";
                                row["ROOMIN_Y"] = "V";
                                row["RECORDTIME"] = Convert.ToDateTime(r["START_TIME"].ToString()).ToString("yyyy/MM/dd HH:mm");
                                dt_bf.Rows.Add(row);
                            }
                            if (r["END_TIME"].ToString() != "")
                            {
                                DataRow row = dt_bf.NewRow();
                                row["IID"] = r["IID"];
                                row["FEENO"] = r["FEENO"];
                                row["SOURCE"] = "小孩";
                                row["NB_SEQ_FEENO"] = $"{babylink["BABY_SEQ"].ToString()},新生兒{babylink["BABY_SEQ"].ToString()},{babylink["BABY_FEE_NO"].ToString()}";
                                row["ROOMIN_N"] = "V";
                                row["RECORDTIME"] = Convert.ToDateTime(r["END_TIME"].ToString()).ToString("yyyy/MM/dd HH:mm");
                                dt_bf.Rows.Add(row);
                            }
                        }
                        #endregion

                        #region 皮膚接觸
                        DataTable dt_sk = obs_m.sel_sktsk("", "", "", null, mom_feeno); // mom
                        foreach (DataRow r in dt_sk.Rows)
                        {
                            if (r["START_TIME"].ToString() != "")
                            {
                                DataRow row = dt_bf.NewRow();
                                row["IID"] = r["IID"];
                                row["FEENO"] = r["FEENO"];
                                row["SOURCE"] = "母親";
                                row["LOCATION"] = r["LOCATION"];
                                row["NB_SEQ_FEENO"] = r["SEQ_OF_NB"];
                                row["SKINTOUCH_Y"] = "V";
                                row["RECORDTIME"] = Convert.ToDateTime(r["START_TIME"].ToString()).ToString("yyyy/MM/dd HH:mm");
                                dt_bf.Rows.Add(row);
                            }

                            if (r["END_TIME"].ToString() != "")
                            {
                                DataRow row = dt_bf.NewRow();
                                row["IID"] = r["IID"];
                                row["FEENO"] = r["FEENO"];
                                row["SOURCE"] = "母親";
                                row["LOCATION"] = r["LOCATION"];
                                row["NB_SEQ_FEENO"] = r["SEQ_OF_NB"];
                                row["SKINTOUCH_N"] = "V";
                                row["RECORDTIME"] = Convert.ToDateTime(r["END_TIME"].ToString()).ToString("yyyy/MM/dd HH:mm");
                                dt_bf.Rows.Add(row);
                            }
                        }

                        DataTable dt_sk_b = obs_m.sel_sktsk("", "", "", null, ptInfo.FeeNo); // baby
                        foreach (DataRow r in dt_sk_b.Rows)
                        {
                            if (r["START_TIME"].ToString() != "")
                            {
                                DataRow row = dt_bf.NewRow();
                                row["IID"] = r["IID"];
                                row["FEENO"] = r["FEENO"];
                                row["SOURCE"] = "小孩";
                                row["LOCATION"] = r["LOCATION"];
                                row["NB_SEQ_FEENO"] = $"{babylink["BABY_SEQ"].ToString()},新生兒{babylink["BABY_SEQ"].ToString()},{babylink["BABY_FEE_NO"].ToString()}";
                                row["SKINTOUCH_Y"] = "V";
                                row["RECORDTIME"] = Convert.ToDateTime(r["START_TIME"].ToString()).ToString("yyyy/MM/dd HH:mm");
                                dt_bf.Rows.Add(row);
                            }
                            if (r["END_TIME"].ToString() != "")
                            {
                                DataRow row = dt_bf.NewRow();
                                row["IID"] = r["IID"];
                                row["FEENO"] = r["FEENO"];
                                row["SOURCE"] = "小孩";
                                row["LOCATION"] = r["LOCATION"];
                                row["NB_SEQ_FEENO"] = $"{babylink["BABY_SEQ"].ToString()},新生兒{babylink["BABY_SEQ"].ToString()},{babylink["BABY_FEE_NO"].ToString()}";
                                row["SKINTOUCH_N"] = "V";
                                row["RECORDTIME"] = Convert.ToDateTime(r["END_TIME"].ToString()).ToString("yyyy/MM/dd HH:mm");
                                dt_bf.Rows.Add(row);
                            }
                        }
                        #endregion

                        DataTable dtCopy = dt_bf.Copy();
                        DataView dv = dt_bf.DefaultView;
                        dv.Sort = "RECORDTIME DESC";
                        dtCopy = dv.ToTable();
                        if (dtCopy != null && dtCopy.Rows.Count > 0)
                            ViewBag.dt = set_dt(dtCopy);
                        else
                        {
                            Response.Write("<script>alert('無資料可顯示!');window.close();</script>");
                            return new EmptyResult();
                        }
                    }
                    else
                    {
                        Response.Write("<script>alert('找不到母親資料!');window.close();</script>");
                        return new EmptyResult();
                    }
                }
                else
                {
                    DataTable dt_babylink = obs_m.sel_nbcha("", "", ptInfo.FeeNo);
                    if (dt_babylink != null && dt_babylink.Rows.Count > 0)
                    {
                        #region 母嬰護理-母親
                        DataTable dt_bf = obs_m.sel_Breast_Fedding(ptInfo.FeeNo, "", "");
                        dt_bf.Columns.Add("SOURCE");
                        dt_bf.Columns.Add("ROOMIN_Y");
                        dt_bf.Columns.Add("ROOMIN_N");
                        dt_bf.Columns.Add("SKINTOUCH_Y");
                        dt_bf.Columns.Add("SKINTOUCH_N");
                        dt_bf.Columns.Add("LOCATION");

                        foreach (DataRow r in dt_bf.Rows)
                        {
                            r["SOURCE"] = "母親";
                        }
                        #endregion

                        #region 親子同室-母親
                        DataTable dt_roomin = obs_m.sel_roomin("", "", "", null, ptInfo.FeeNo);
                        foreach (DataRow r in dt_roomin.Rows)
                        {
                            if (r["START_TIME"].ToString() != "")
                            {
                                DataRow row = dt_bf.NewRow();
                                row["IID"] = r["IID"];
                                row["FEENO"] = r["FEENO"];
                                row["SOURCE"] = "母親";
                                row["NB_SEQ_FEENO"] = r["SEQ_OF_NB"];
                                row["ROOMIN_Y"] = "V";
                                row["RECORDTIME"] = Convert.ToDateTime(r["START_TIME"].ToString()).ToString("yyyy/MM/dd HH:mm");
                                dt_bf.Rows.Add(row);
                            }
                            if (r["END_TIME"].ToString() != "")
                            {
                                DataRow row = dt_bf.NewRow();
                                row["IID"] = r["IID"];
                                row["FEENO"] = r["FEENO"];
                                row["SOURCE"] = "母親";
                                row["NB_SEQ_FEENO"] = r["SEQ_OF_NB"];
                                row["ROOMIN_N"] = "V";
                                row["RECORDTIME"] = Convert.ToDateTime(r["END_TIME"].ToString()).ToString("yyyy/MM/dd HH:mm");
                                dt_bf.Rows.Add(row);
                            }
                        }
                        #endregion

                        #region 皮膚接觸-母親
                        DataTable dt_sk = obs_m.sel_sktsk("", "", "", null, ptInfo.FeeNo);
                        foreach (DataRow r in dt_sk.Rows)
                        {
                            if (r["START_TIME"].ToString() != "")
                            {
                                DataRow row = dt_bf.NewRow();
                                row["IID"] = r["IID"];
                                row["FEENO"] = r["FEENO"];
                                row["SOURCE"] = "母親";
                                row["LOCATION"] = r["LOCATION"];
                                row["NB_SEQ_FEENO"] = r["SEQ_OF_NB"];
                                row["SKINTOUCH_Y"] = "V";
                                row["RECORDTIME"] = Convert.ToDateTime(r["START_TIME"].ToString()).ToString("yyyy/MM/dd HH:mm");
                                dt_bf.Rows.Add(row);
                            }
                            if (r["END_TIME"].ToString() != "")
                            {
                                DataRow row = dt_bf.NewRow();
                                row["IID"] = r["IID"];
                                row["FEENO"] = r["FEENO"];
                                row["SOURCE"] = "母親";
                                row["LOCATION"] = r["LOCATION"];
                                row["NB_SEQ_FEENO"] = r["SEQ_OF_NB"];
                                row["SKINTOUCH_N"] = "V";
                                row["RECORDTIME"] = Convert.ToDateTime(r["END_TIME"].ToString()).ToString("yyyy/MM/dd HH:mm");
                                dt_bf.Rows.Add(row);
                            }
                        }
                        #endregion

                        foreach (DataRow r in dt_babylink.Rows)
                        {
                            var baby_feeno = r["BABY_FEE_NO"].ToString();
                            if (baby_feeno != "" && baby_feeno != null)
                            {
                                #region 母嬰護理-小孩
                                DataTable bf = obs_m.sel_Breast_Fedding(baby_feeno, "", "");
                                bf.Columns.Add("SOURCE");
                                bf.Columns.Add("ROOMIN_Y");
                                bf.Columns.Add("ROOMIN_N");
                                bf.Columns.Add("SKINTOUCH_Y");
                                bf.Columns.Add("SKINTOUCH_N");
                                if (bf != null && bf.Rows.Count > 0)
                                {
                                    foreach (DataRow bf_r in bf.Rows)
                                    {
                                        bf_r["SOURCE"] = "小孩";
                                        bf_r["NB_SEQ_FEENO"] = $"{r["BABY_SEQ"].ToString()},新生兒{r["BABY_SEQ"].ToString()},{r["BABY_FEE_NO"].ToString()}";
                                    }
                                }
                                dt_bf.Merge(bf);
                                #endregion

                                #region 皮膚接觸-小孩
                                DataTable sk = obs_m.sel_sktsk("", "", "", null, baby_feeno);
                                if (sk != null && sk.Rows.Count > 0)
                                {
                                    foreach (DataRow sk_r in sk.Rows)
                                    {
                                        if (sk_r["START_TIME"].ToString() != "")
                                        {
                                            DataRow row = dt_bf.NewRow();
                                            row["IID"] = sk_r["IID"];
                                            row["FEENO"] = sk_r["FEENO"];
                                            row["SOURCE"] = "小孩";
                                            row["LOCATION"] = sk_r["LOCATION"];
                                            row["NB_SEQ_FEENO"] = r["BABY_SEQ"];
                                            row["SKINTOUCH_Y"] = "V";
                                            row["RECORDTIME"] = Convert.ToDateTime(sk_r["START_TIME"].ToString()).ToString("yyyy/MM/dd HH:mm");
                                            dt_bf.Rows.Add(row);
                                        }
                                        if (sk_r["END_TIME"].ToString() != "")
                                        {
                                            DataRow row = dt_bf.NewRow();
                                            row["IID"] = sk_r["IID"];
                                            row["FEENO"] = sk_r["FEENO"];
                                            row["SOURCE"] = "小孩";
                                            row["LOCATION"] = sk_r["LOCATION"];
                                            row["NB_SEQ_FEENO"] = r["BABY_SEQ"];
                                            row["SKINTOUCH_N"] = "V";
                                            row["RECORDTIME"] = Convert.ToDateTime(sk_r["END_TIME"].ToString()).ToString("yyyy/MM/dd HH:mm");
                                            dt_bf.Rows.Add(row);
                                        }
                                    }
                                }
                                #endregion

                                #region 親子同室-小孩
                                DataTable roomin = obs_m.sel_roomin("", "", "", null, baby_feeno);
                                if (roomin != null && roomin.Rows.Count > 0)
                                {
                                    foreach (DataRow roomin_r in roomin.Rows)
                                    {
                                        if (roomin_r["START_TIME"].ToString() != "")
                                        {
                                            DataRow row = dt_bf.NewRow();
                                            row["IID"] = roomin_r["IID"];
                                            row["FEENO"] = roomin_r["FEENO"];
                                            row["SOURCE"] = "小孩";
                                            row["RECORDTIME"] = roomin_r["RECORDTIME"];
                                            row["NB_SEQ_FEENO"] = r["BABY_SEQ"];
                                            row["ROOMIN_Y"] = "V";
                                            row["RECORDTIME"] = Convert.ToDateTime(roomin_r["START_TIME"].ToString()).ToString("yyyy/MM/dd HH:mm");
                                            dt_bf.Rows.Add(row);
                                        }
                                        if (roomin_r["END_TIME"].ToString() != "")
                                        {
                                            DataRow row = dt_bf.NewRow();
                                            row["IID"] = roomin_r["IID"];
                                            row["FEENO"] = roomin_r["FEENO"];
                                            row["SOURCE"] = "小孩";
                                            row["RECORDTIME"] = roomin_r["RECORDTIME"];
                                            row["NB_SEQ_FEENO"] = r["BABY_SEQ"];
                                            row["ROOMIN_N"] = "V";
                                            row["RECORDTIME"] = Convert.ToDateTime(roomin_r["START_TIME"].ToString()).ToString("yyyy/MM/dd HH:mm");
                                            dt_bf.Rows.Add(row);
                                        }
                                    }
                                }
                                #endregion
                            }
                        }

                        DataTable dt_bfCopy = dt_bf.Copy();
                        DataView dv_bf = dt_bf.DefaultView;
                        dv_bf.Sort = "RECORDTIME DESC";
                        dt_bfCopy = dv_bf.ToTable();
                        if (dt_bfCopy != null && dt_bfCopy.Rows.Count > 0)
                            ViewBag.dt = set_dt(dt_bfCopy);
                        else
                        {
                            Response.Write("<script>alert('無資料可顯示!');window.close();</script>");
                            return new EmptyResult();
                        }
                    }
                    else
                    {
                        Response.Write("<script>alert('找不到小孩資料!');window.close();</script>");
                        return new EmptyResult();
                    }
                }

                ViewData["color_drainage"] = this.cd.getSelectItem("io", "outputcolor_Drainage", "");
                ViewData["outputnature_Drainage"] = this.cd.getSelectItem("io", "outputnature_Drainage", "");

                DataTable dt_nb = obs_m.sel_nb(ptinfo.FeeNo);
                if (dt_nb != null && dt_nb.Rows.Count > 0)
                {
                    ViewBag.BirthDay = dt_nb.Rows[0]["BIRTH_DAY"];
                }
                return View();
            }
            Response.Write("<script>alert('請重新選擇病患');</script>");
            return new EmptyResult();
        }
        #endregion

        #region 母嬰親善起始畫面
        /// <summary>
        /// 母嬰親善起始畫面
        /// </summary>
        /// <returns></returns>
        public ActionResult RoomIn_List(string mode, bool Kardex = false)
        {
            ViewBag.mode = mode;
            ViewBag.Kardex = Kardex;
            DataTable dt = null;
            DataTable dt_sk = null;
            if (ptinfo.Age < 1)
            {
                DataTable dt_babylink = obs_m.sel_nbcha(ptinfo?.FeeNo, "", "");
                if (dt_babylink != null && dt_babylink.Rows.Count > 0)
                {
                    var babyChartNo = dt_babylink.Rows[0]["BABY_CHART_NO"].ToString();

                    dt = obs_m.sel_roomin("", "", "", new List<string>() { ptinfo.ChartNo.PadLeft(10, '0') });
                    dt.Columns.Add("UPDNO_NAME");
                    if (dt != null && dt.Rows.Count > 0)
                    {
                        foreach (DataRow r in dt.Rows)
                        {
                            if (r["UPDNO"].ToString() != "")
                            {
                                byte[] listByteCode1 = webService.UserName(r["UPDNO"].ToString());
                                if (listByteCode1 == null)
                                    r["UPDNO_NAME"] = "";
                                else
                                {
                                    string listJsonArray = CompressTool.DecompressString(listByteCode1);
                                    UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                    r["UPDNO_NAME"] = user_name.EmployeesName;
                                }
                            }
                            else
                            {
                                byte[] listByteCode1 = webService.UserName(r["CREATNO"].ToString());
                                if (listByteCode1 == null)
                                    r["UPDNO_NAME"] = "";
                                else
                                {
                                    string listJsonArray = CompressTool.DecompressString(listByteCode1);
                                    UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                    r["UPDNO_NAME"] = user_name.EmployeesName;
                                }
                            }
                        }
                    }
                    ViewBag.dt = set_dt(dt);

                    dt_sk = obs_m.sel_sktsk("", "", "", new List<string>() { ptinfo.ChartNo.PadLeft(10, '0') });
                    dt_sk.Columns.Add("UPDNO_NAME");
                    if (dt_sk != null && dt_sk.Rows.Count > 0)
                    {
                        foreach (DataRow r in dt_sk.Rows)
                        {
                            if (r["UPDNO"].ToString() != "")
                            {
                                byte[] listByteCode1 = webService.UserName(r["UPDNO"].ToString());
                                if (listByteCode1 == null)
                                    r["UPDNO_NAME"] = "";
                                else
                                {
                                    string listJsonArray = CompressTool.DecompressString(listByteCode1);
                                    UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                    r["UPDNO_NAME"] = user_name.EmployeesName;
                                }
                            }
                            else
                            {
                                byte[] listByteCode1 = webService.UserName(r["CREATNO"].ToString());
                                if (listByteCode1 == null)
                                    r["UPDNO_NAME"] = "";
                                else
                                {
                                    string listJsonArray = CompressTool.DecompressString(listByteCode1);
                                    UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                    r["UPDNO_NAME"] = user_name.EmployeesName;
                                }
                            }
                        }
                    }
                    ViewBag.dt_sk = set_dt(dt_sk);
                }
            }
            else
            {
                //20210316,chih
                // dt = obs_m.sel_roomin("", "", ptinfo.ChartNo.PadLeft(10, '0'));

                //20240226 ken 調整撈取方式
                DataTable dt_babylink = obs_m.sel_nbcha("", "", ptinfo.FeeNo);
                if (dt_babylink != null && dt_babylink.Rows.Count > 0)
                {

                }
                dt = obs_m.sel_roomin("", "", "", null, ptinfo.FeeNo);
                //20210316,chih
                dt.Columns.Add("UPDNO_NAME");
                if (dt != null && dt.Rows.Count > 0)
                {
                    foreach (DataRow r in dt.Rows)
                    {
                        if (r["UPDNO"].ToString() != "")
                        {
                            byte[] listByteCode1 = webService.UserName(r["UPDNO"].ToString());
                            if (listByteCode1 == null)
                                r["UPDNO_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode1);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["UPDNO_NAME"] = user_name.EmployeesName;
                            }
                        }
                        else
                        {
                            byte[] listByteCode1 = webService.UserName(r["CREATNO"].ToString());
                            if (listByteCode1 == null)
                                r["UPDNO_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode1);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["UPDNO_NAME"] = user_name.EmployeesName;
                            }
                        }
                    }
                }
                ViewBag.dt = set_dt(dt);
                //20210316,chih 
                //dt_sk = obs_m.sel_sktsk("", "", ptinfo.ChartNo.PadLeft(10, '0'));
                dt_sk = obs_m.sel_sktsk("", "", "", null, ptinfo.FeeNo);
                //20210316,chih
                dt_sk.Columns.Add("UPDNO_NAME");
                if (dt_sk != null && dt_sk.Rows.Count > 0)
                {
                    foreach (DataRow r in dt_sk.Rows)
                    {
                        if (r["UPDNO"].ToString() != "")
                        {
                            byte[] listByteCode1 = webService.UserName(r["UPDNO"].ToString());
                            if (listByteCode1 == null)
                                r["UPDNO_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode1);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["UPDNO_NAME"] = user_name.EmployeesName;
                            }
                        }
                        else
                        {
                            byte[] listByteCode1 = webService.UserName(r["CREATNO"].ToString());
                            if (listByteCode1 == null)
                                r["UPDNO_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode1);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["UPDNO_NAME"] = user_name.EmployeesName;
                            }
                        }
                    }
                }
                ViewBag.dt_sk = set_dt(dt_sk);
            }

            DataTable dt_bredtran = obs_m.sel_bredtran(ptinfo?.FeeNo, "", "");
            dt_bredtran.Columns.Add("UPDNO_NAME");
            dt_bredtran.Columns.Add("APPLYNO_NAME");
            dt_bredtran.Columns.Add("REPLYNO_NAME");
            if (dt_bredtran != null && dt_bredtran.Rows.Count > 0)
            {
                foreach (DataRow r in dt_bredtran.Rows)
                {
                    if (r["UPDNO"].ToString() != "")
                    {
                        byte[] listByteCode1 = webService.UserName(r["UPDNO"].ToString());
                        if (listByteCode1 == null)
                            r["UPDNO_NAME"] = "";
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(listByteCode1);
                            UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                            r["UPDNO_NAME"] = user_name.EmployeesName;
                        }
                    }
                    else
                    {
                        byte[] listByteCode1 = webService.UserName(r["CREATNO"].ToString());
                        if (listByteCode1 == null)
                            r["UPDNO_NAME"] = "";
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(listByteCode1);
                            UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                            r["UPDNO_NAME"] = user_name.EmployeesName;
                        }
                    }

                    if (r["REPLYNO"].ToString() != "")
                    {
                        byte[] listByteCode1 = webService.UserName(r["REPLYNO"].ToString());
                        if (listByteCode1 == null)
                            r["REPLYNO_NAME"] = "";
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(listByteCode1);
                            UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                            r["REPLYNO_NAME"] = user_name.EmployeesName;
                        }
                    }
                    if (r["APPLYNO"].ToString() != "")
                    {
                        byte[] listByteCode1 = webService.UserName(r["APPLYNO"].ToString());
                        if (listByteCode1 == null)
                            r["APPLYNO_NAME"] = "";
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(listByteCode1);
                            UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                            r["APPLYNO_NAME"] = user_name.EmployeesName;
                        }
                    }
                }
            }
            ViewBag.dt_bredtran = set_dt(dt_bredtran);

            DataTable dt_bthhis = obs_m.sel_bthhis(ptinfo.FeeNo);
            if (dt_bthhis != null && dt_bthhis.Rows.Count > 0)
            {
                ViewBag.Roomin = dt_bthhis.Rows[0]["ROOM_IN"].ToString();
                ViewBag.Feed = dt_bthhis.Rows[0]["FEED"].ToString();
            }
            else
            {
                ViewBag.Roomin = "";
                ViewBag.Feed = "";
            }

            DataTable dt_nb = obs_m.sel_nb(ptinfo.FeeNo);
            if (dt_nb != null && dt_nb.Rows.Count > 0)
            {
                ViewBag.BirthDay = dt_nb.Rows[0]["BIRTH_DAY"];
            }

            ViewBag.chartNo = ptinfo.ChartNo;
            ViewBag.feeno = ptinfo.FeeNo;
            ViewBag.userno = userinfo.EmployeesNo;
            ViewBag.RootDocument = GetSourceUrl();

            return View();
        }
        #endregion


        #region 皮膚接觸新增畫面
        public ActionResult Insert_SkinTouch(string IID, string Type)
        {
            //20210513add  -- 出生紀錄帶過來的皮膚接觸不能修改
            ViewBag.disableUpdate = "";
            //end 20210513add  -- 出生紀錄帶過來的皮膚接觸不能修改

            if (IID != null)
            {
                DataTable dt = obs_m.sel_sktsk("", IID);
                if (dt != null && dt.Rows.Count > 0)
                {
                    dt.Columns.Add("UPDNO_NAME");
                    dt.Columns.Add("PAT_FEENO_NAME");
                    dt.Columns.Add("NB_CHARTNO_NAME");
                    foreach (DataRow r in dt.Rows)
                    {
                        if (r["END_TIME"].ToString() != "" && r["UPDNO"].ToString() != userinfo.EmployeesNo)
                        {
                            Response.Write("<script>alert('資料已結案，僅結案者可修改!');window.close();</script>");
                            return new EmptyResult();
                        }

                        //結案時預設結束時間
                        if (Type == "close")
                        {
                            r["END_TIME"] = DateTime.Now;
                        }

                        if (r["UPDNO"].ToString() != "")
                        {
                            byte[] listByteCode1 = webService.UserName(r["UPDNO"].ToString());
                            if (listByteCode1 == null)
                                r["UPDNO_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode1);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["UPDNO_NAME"] = user_name.EmployeesName;
                            }
                        }

                        byte[] listByteCode = webService.GetPatFeeNo(r["PAT_FEENO"].ToString());
                        if (listByteCode == null) { }
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(listByteCode);
                            BabyLab[] patinfo = JsonConvert.DeserializeObject<BabyLab[]>(listJsonArray);
                            var feeNo = "";
                            if (patinfo != null && patinfo.Count() > 0)
                                feeNo = patinfo[0].FEE_NO;

                            byte[] ByteCode = webService.GetPatientInfo(feeNo);
                            if (ByteCode != null)
                                r["PAT_FEENO_NAME"] = JsonConvert.DeserializeObject<PatientInfo>(CompressTool.DecompressString(ByteCode)).PatientName;
                        }

                        DataTable baby_dt = obs_m.sel_nbcha("", r["NB_CHARTNO"].ToString());
                        if (baby_dt != null && baby_dt.Rows.Count > 0)
                        {
                            byte[] listByteCode_b = webService.GetPatientInfo(baby_dt.Rows[0]["BABY_FEE_NO"].ToString());
                            if (listByteCode_b == null) { }
                            string listJsonArray_b = CompressTool.DecompressString(listByteCode_b);
                            PatientInfo patientInfo = JsonConvert.DeserializeObject<PatientInfo>(listJsonArray_b);
                            r["NB_CHARTNO_NAME"] = patientInfo.PatientName;
                        }
                    }
                }
                ViewBag.dt = dt;

                //20210513add  -- 出生紀錄帶過來的皮膚接觸不能修改
                DataTable dtNB = obs_m.sel_nb("", "", IID);
                if (dtNB.Rows.Count > 0)
                {
                    ViewBag.disableUpdate = "disabled";
                }
                //end 20210513add  -- 出生紀錄帶過來的皮膚接觸不能修改

            }
            else
            {
                DataTable dt = null;
                if (ptinfo.Age < 1)
                {
                    dt = obs_m.sel_sktsk("", "", "", new List<string>() { ptinfo.ChartNo.PadLeft(10, '0') }, "", true);
                }
                else
                {
                    DataTable dtnb = obs_m.sel_nb(ptinfo.FeeNo);
                    if (dtnb != null && dtnb.Rows.Count > 0)
                    {
                        if (dtnb.Rows.Count == 1)
                        {
                            dt = obs_m.sel_sktsk("", "", ptinfo.ChartNo.PadLeft(10, '0'), null, "", true);
                        }
                        else
                        {
                            Response.Write($"<script>alert('此產婦有{dtnb.Rows.Count}個小孩，輸入小孩病歷號檢查是否有未結束之資料');</script>");
                        }
                    }
                }

                if (dt != null && dt.Rows.Count > 0)
                {
                    Response.Write("<script>alert('尚有資料未結束!');window.close();</script>");
                    return new EmptyResult();
                }
            }
            return View();
        }
        #endregion

        #region 皮膚接觸新增
        /// <summary>
        /// 皮膚接觸新增
        /// </summary>
        /// <param name="form"></param>
        /// <returns></returns>
        [HttpPost]
        public ActionResult Insert_SkinTouch(FormCollection form)
        {
            RESPONSE_MSG json_result = new RESPONSE_MSG();

            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo.FeeNo;
            string id = base.creatid("OBS_SKTSK", userno, feeno, "0");
            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("IID", id, DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("CREATNO", userno, DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("RECORDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間

            var NB_CHARTNO = form["TXT_NB_CHARTNO"];
            var NBFeeno = "";
            if (!IsNoEmpty(NB_CHARTNO))
            {
                json_result.status = RESPONSE_STATUS.ERROR;
                json_result.message = "新生兒病歷號未填寫!";
                return Content(JsonConvert.SerializeObject(json_result), "application/json");
            }

            DataTable dt_babylink = obs_m.sel_nbcha("", NB_CHARTNO);
            if (dt_babylink == null || dt_babylink.Rows.Count == 0) { }
            else
            {
                NBFeeno = dt_babylink.Rows[0]["BABY_FEE_NO"].ToString();
                byte[] listByteCodeb = webService.GetPatientInfo(NBFeeno);
                if (listByteCodeb == null)
                {
                    json_result.status = RESPONSE_STATUS.ERROR;
                    json_result.message = "查無此新生兒病歷號!";
                    return Content(JsonConvert.SerializeObject(json_result), "application/json");
                }
            }
            insertDataList.Add(new DBItem("NB_CHARTNO", NB_CHARTNO, DBItem.DBDataType.String));

            DataTable dt = obs_m.sel_nbcha("", NB_CHARTNO);
            var momfeeno = "";
            var PAT_FEENO = form["TXT_PAT_FEENO"];
            if (dt != null || dt.Rows.Count > 0)
            {
                momfeeno = dt.Rows[0]["MOM_FEE_NO"].ToString();
                PatientInfo momInfo = Get_Patient_Info(momfeeno);

                insertDataList.Add(new DBItem("SEQ_OF_NB", dt.Rows[0]["BABY_SEQ"].ToString(), DBItem.DBDataType.String));

                if (PAT_FEENO != "")
                {
                    if (PAT_FEENO == momInfo.ChartNo.PadLeft(10, '0'))
                    {
                        insertDataList.Add(new DBItem("PAT_FEENO", PAT_FEENO, DBItem.DBDataType.String));
                    }
                    else
                    {
                        json_result.status = RESPONSE_STATUS.ERROR;
                        json_result.message = "新生兒與母親對應有誤!";
                        return Content(JsonConvert.SerializeObject(json_result), "application/json");
                    }
                }
                else
                {
                    insertDataList.Add(new DBItem("PAT_FEENO", momInfo.ChartNo.PadLeft(10, '0'), DBItem.DBDataType.String));
                }
            }

            var LOCATION = form["RB_LOCATION"];
            if (!IsNoEmpty(LOCATION))
            {
                json_result.status = RESPONSE_STATUS.ERROR;
                json_result.message = "地點未填寫!";
                return Content(JsonConvert.SerializeObject(json_result), "application/json");
            }
            insertDataList.Add(new DBItem("LOCATION", LOCATION, DBItem.DBDataType.String));
            if (LOCATION == "7")
            {
                if (!IsNoEmpty(form["TXT_LOCA_OTH"]))
                {
                    json_result.status = RESPONSE_STATUS.ERROR;
                    json_result.message = "地點-其他未填寫!";
                    return Content(JsonConvert.SerializeObject(json_result), "application/json");
                }
                insertDataList.Add(new DBItem("LOCA_OTH", form["TXT_LOCA_OTH"], DBItem.DBDataType.String));
            }
            else
            {
                insertDataList.Add(new DBItem("LOCA_OTH", null, DBItem.DBDataType.String));
            }
            var LOCATION_NAME = "";
            switch (LOCATION)
            {
                case "0":
                    LOCATION_NAME = "產房";
                    break;
                case "1":
                    LOCATION_NAME = "開刀房";
                    break;
                case "2":
                    LOCATION_NAME = "恢復室";
                    break;
                case "3":
                    LOCATION_NAME = "嬰兒室";
                    break;
                case "4":
                    LOCATION_NAME = "產後病房";
                    break;
                case "5":
                    LOCATION_NAME = "兒科中重度病房";
                    break;
                case "6":
                    LOCATION_NAME = "兒科加護病房";
                    break;
                case "7":
                    LOCATION_NAME = "其他";
                    if (form["TXT_LOCA_OTH"].ToString() != "")
                    {
                        LOCATION_NAME += $"-{form["TXT_LOCA_OTH"]}";
                    }
                    break;
                default:
                    LOCATION_NAME = "";
                    break;
            }

            if (!IsNoEmpty(form["RB_WHO"]))
            {
                json_result.status = RESPONSE_STATUS.ERROR;
                json_result.message = "對象未填寫!";
                return Content(JsonConvert.SerializeObject(json_result), "application/json");
            }
            insertDataList.Add(new DBItem("WHO", form["RB_WHO"], DBItem.DBDataType.String));

            var Obj = "";
            switch (form["RB_WHO"] ?? "")
            {
                case "0":
                    Obj = "母親";
                    break;
                case "1":
                    Obj = "父親";
                    break;
                default:
                    Obj = "";
                    break;
            }

            if (IsNoEmpty(form["TXT_START_TIME_DAY"]) && IsNoEmpty(form["TXT_START_TIME_TIME"]))
            {
                insertDataList.Add(new DBItem("START_TIME", form["TXT_START_TIME_DAY"] + " " + form["TXT_START_TIME_TIME"], DBItem.DBDataType.DataTime));
            }
            else
            {
                json_result.status = RESPONSE_STATUS.ERROR;
                json_result.message = "開始時間未填寫!";
                return Content(JsonConvert.SerializeObject(json_result), "application/json");
            }

            if (IsNoEmpty(form["TXT_START_TIME_DAY"]) && IsNoEmpty(form["TXT_START_TIME_TIME"]) &&
                IsNoEmpty(form["TXT_END_TIME_DAY"]) && IsNoEmpty(form["TXT_END_TIME_TIME"]))
            {
                var s_time = Convert.ToDateTime(form["TXT_START_TIME_DAY"] + " " + form["TXT_START_TIME_TIME"]);
                var e_time = Convert.ToDateTime(form["TXT_END_TIME_DAY"] + " " + form["TXT_END_TIME_TIME"]);

                var timediff = e_time - s_time;
                if (timediff.TotalSeconds < 0)
                {
                    json_result.status = RESPONSE_STATUS.ERROR;
                    json_result.message = "開始時間不得大於結束時間";
                    return Content(JsonConvert.SerializeObject(json_result), "application/json");
                }

                var duplicateSql = $@"SELECT * FROM OBS_SKTSK WHERE 0 = 0 AND (PAT_FEENO = '{PAT_FEENO}' or NB_CHARTNO = '{NB_CHARTNO}') 
 AND SEQ_OF_NB = '{dt.Rows[0]["BABY_SEQ"].ToString()}' 
                    AND DELETED IS NULL 
AND (
START_TIME BETWEEN TO_DATE('{s_time.ToString("yyyy/MM/dd HH:mm")}', 'YYYY/MM/DD HH24:MI') AND TO_DATE('{e_time.ToString("yyyy/MM/dd HH:mm")}', 'YYYY/MM/DD HH24:MI')
OR 
END_TIME BETWEEN TO_DATE('{s_time.ToString("yyyy/MM/dd HH:mm")}', 'YYYY/MM/DD HH24:MI') AND TO_DATE('{e_time.ToString("yyyy/MM/dd HH:mm")}', 'YYYY/MM/DD HH24:MI')
OR
TO_DATE('{s_time.ToString("yyyy/MM/dd HH:mm")}', 'YYYY/MM/DD HH24:MI') BETWEEN START_TIME AND END_TIME
OR
TO_DATE('{e_time.ToString("yyyy/MM/dd HH:mm")}', 'YYYY/MM/DD HH24:MI') BETWEEN START_TIME AND END_TIME
) ORDER BY START_TIME DESC";

                DataTable duplicate = obs_m.DBExecSQL(duplicateSql);
                if (duplicate != null && duplicate.Rows.Count > 0)
                {
                    json_result.status = RESPONSE_STATUS.ERROR;
                    json_result.message = "時間重疊，請確認資料!";
                    return Content(JsonConvert.SerializeObject(json_result), "application/json");
                }
            }
            else
            {
                if (IsNoEmpty(form["TXT_START_TIME_DAY"]) && IsNoEmpty(form["TXT_START_TIME_TIME"]))
                {
                    var s_time = Convert.ToDateTime(form["TXT_START_TIME_DAY"] + " " + form["TXT_START_TIME_TIME"]);
                    var duplicateSql = $@"SELECT * FROM OBS_SKTSK WHERE 0 = 0 AND (PAT_FEENO = '{PAT_FEENO}' or NB_CHARTNO = '{NB_CHARTNO}') 
                    AND SEQ_OF_NB = '{dt.Rows[0]["BABY_SEQ"].ToString()}' 
                    AND DELETED IS NULL AND TO_DATE('{s_time.ToString("yyyy/MM/dd HH:mm")}', 'YYYY/MM/DD HH24:MI') <= END_TIME
                    ORDER BY START_TIME DESC";

                    DataTable duplicate = obs_m.DBExecSQL(duplicateSql);
                    if (duplicate != null && duplicate.Rows.Count > 0)
                    {
                        json_result.status = RESPONSE_STATUS.ERROR;
                        json_result.message = "必須大於最新一筆結束時間，請確認資料!";
                        return Content(JsonConvert.SerializeObject(json_result), "application/json");
                    }
                }
            }

            if (IsNoEmpty(form["TXT_END_TIME_DAY"]) && IsNoEmpty(form["TXT_END_TIME_TIME"]))
            {
                insertDataList.Add(new DBItem("UPDNO", userno, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("UPDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime));

                insertDataList.Add(new DBItem("END_TIME", form["TXT_END_TIME_DAY"] + " " + form["TXT_END_TIME_TIME"], DBItem.DBDataType.DataTime));
            }

            var STA_REASON_C = new List<string>();
            var STA_REASON_NB = new List<string>();
            //結束原因
            var END_RS = form["CK_END_RS"];
            var END_RSV = new List<string>() { "0", "0" };
            if (END_RS == null)
            {
                if (IsNoEmpty(form["TXT_END_TIME_DAY"]) && IsNoEmpty(form["TXT_END_TIME_TIME"]))
                {
                    json_result.status = RESPONSE_STATUS.ERROR;
                    json_result.message = "結束原因未填寫!";
                    return Content(JsonConvert.SerializeObject(json_result), "application/json");
                }
                insertDataList.Add(new DBItem("END_RS", String.Join("", END_RSV), DBItem.DBDataType.String));
            }
            else
            {
                var END_RS_SP = END_RS.Split(',');
                foreach (var i in END_RS_SP)
                    END_RSV[Convert.ToInt32(i)] = "1";
                insertDataList.Add(new DBItem("END_RS", String.Join("", END_RSV), DBItem.DBDataType.String));
            }

            //結束原因-接觸人
            if (END_RSV[0] == "1")
            {
                var END_RS_CT = form["CK_END_RS_CT"];
                var END_RS_CTV = new List<string>() { "0", "0", "0", "0", "0", "0", "0", "0", "0" };
                if (END_RS_CT == null)
                {
                    json_result.status = RESPONSE_STATUS.ERROR;
                    json_result.message = "接觸人原因未填寫!";
                    return Content(JsonConvert.SerializeObject(json_result), "application/json");
                }
                else
                {
                    var END_RS_CT_SP = END_RS_CT.Split(',');
                    foreach (var i in END_RS_CT_SP)
                        END_RS_CTV[Convert.ToInt32(i)] = "1";
                    insertDataList.Add(new DBItem("END_RS_CT", String.Join("", END_RS_CTV), DBItem.DBDataType.String));
                }

                if (END_RS_CTV[7] == "1")
                {
                    if (!IsNoEmpty(form["TXT_END_RS_CT_OTH"]))
                    {
                        json_result.status = RESPONSE_STATUS.ERROR;
                        json_result.message = "接觸人原因-其他未填寫!";
                        return Content(JsonConvert.SerializeObject(json_result), "application/json");
                    }
                    insertDataList.Add(new DBItem("END_RS_CT_OTH", form["TXT_END_RS_CT_OTH"], DBItem.DBDataType.String));
                }
                else
                    insertDataList.Add(new DBItem("END_RS_CT_OTH", null, DBItem.DBDataType.String));

                for (var i = 0; i < END_RS_CTV.Count; i++)
                {
                    if (i == 0 && END_RS_CTV[i] == "1")
                    {
                        STA_REASON_C.Add("生命徵象不穩定");
                    }
                    if (i == 1 && END_RS_CTV[i] == "1")
                    {
                        STA_REASON_C.Add("嘔吐");
                    }
                    if (i == 2 && END_RS_CTV[i] == "1")
                    {
                        STA_REASON_C.Add("發燒");
                    }
                    if (i == 3 && END_RS_CTV[i] == "1")
                    {
                        STA_REASON_C.Add("傷口疼痛");
                    }
                    if (i == 4 && END_RS_CTV[i] == "1")
                    {
                        STA_REASON_C.Add("有精神疾患");
                    }
                    if (i == 5 && END_RS_CTV[i] == "1")
                    {
                        STA_REASON_C.Add("拒絕");
                    }
                    if (i == 6 && END_RS_CTV[i] == "1")
                    {
                        STA_REASON_C.Add("疲憊");
                    }
                    if (i == 7 && END_RS_CTV[i] == "1")
                    {
                        var d = "其他";
                        if (form["TXT_END_RS_CT_OTH"] != "")
                        {
                            d += $"-{form["TXT_END_RS_CT_OTH"]}";
                        }
                        STA_REASON_C.Add(d);
                    }
                    if (i == 8 && END_RS_CTV[i] == "1")
                    {
                        STA_REASON_C.Add("返病房");
                    }
                }
            }
            else
                insertDataList.Add(new DBItem("END_RS_CT", null, DBItem.DBDataType.String));
            //結束原因-新生兒
            if (END_RSV[1] == "1")
            {
                var END_RS_NB = form["CK_END_RS_NB"];
                var END_RS_NBV = new List<string>() { "0", "0", "0", "0", "0" };
                if (END_RS_NB == null)
                {
                    json_result.status = RESPONSE_STATUS.ERROR;
                    json_result.message = "新生兒原因未填寫!";
                    return Content(JsonConvert.SerializeObject(json_result), "application/json");
                }
                else
                {
                    var END_RS_NB_SP = END_RS_NB.Split(',');
                    foreach (var i in END_RS_NB_SP)
                        END_RS_NBV[Convert.ToInt32(i)] = "1";
                    insertDataList.Add(new DBItem("END_RS_NB", String.Join("", END_RS_NBV), DBItem.DBDataType.String));

                    if (END_RS_NBV[3] == "1")
                    {
                        if (!IsNoEmpty(form["TXT_END_RS_NB_OTH"]))
                        {
                            json_result.status = RESPONSE_STATUS.ERROR;
                            json_result.message = "新生兒原因-其他未填寫!";
                            return Content(JsonConvert.SerializeObject(json_result), "application/json");
                        }
                        insertDataList.Add(new DBItem("END_RS_NB_OTH", form["TXT_END_RS_NB_OTH"], DBItem.DBDataType.String));
                    }
                    else
                        insertDataList.Add(new DBItem("END_RS_NB_OTH", null, DBItem.DBDataType.String));
                }

                for (var i = 0; i < END_RS_NBV.Count; i++)
                {
                    if (i == 0 && END_RS_NBV[i] == "1")
                    {
                        STA_REASON_NB.Add("生命徵象不穩定");
                    }
                    if (i == 1 && END_RS_NBV[i] == "1")
                    {
                        STA_REASON_NB.Add("早產");
                    }
                    if (i == 2 && END_RS_NBV[i] == "1")
                    {
                        STA_REASON_NB.Add("低血糖");
                    }
                    if (i == 3 && END_RS_NBV[i] == "1")
                    {
                        var d = "其他";
                        if (form["TXT_END_RS_NB_OTH"] != "")
                        {
                            d += $"-{form["TXT_END_RS_NB_OTH"]}";
                        }
                        STA_REASON_NB.Add(d);
                    }
                    if (i == 4 && END_RS_NBV[i] == "1")
                    {
                        STA_REASON_NB.Add("返嬰兒室");
                    }
                }
            }
            else
            {
                insertDataList.Add(new DBItem("END_RS_NB_OTH", null, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("END_RS_NB", null, DBItem.DBDataType.String));
            }

            insertDataList = setNullToEmpty(insertDataList);
            int erow = obs_m.DBExecInsert("OBS_SKTSK", insertDataList);

            base.Insert_CareRecord(form["TXT_START_TIME_DAY"] + " " + form["TXT_START_TIME_TIME"], id + "START", "皮膚接觸-新增", $"{Obj}於{LOCATION_NAME}執行肌膚接觸。", "", "", "", "", "OBS_SKTSK");
            if (IsNoEmpty(form["TXT_END_TIME_DAY"]) && IsNoEmpty(form["TXT_END_TIME_TIME"]))
            {
                var TotalTime = "";
                var s_time = Convert.ToDateTime(form["TXT_START_TIME_DAY"] + " " + form["TXT_START_TIME_TIME"]);
                var e_time = Convert.ToDateTime(form["TXT_END_TIME_DAY"] + " " + form["TXT_END_TIME_TIME"]);

                var timediff = e_time - s_time;
                TotalTime = $"{(timediff.Days == 0 ? "" : $"{timediff.Days}天")}{(timediff.Hours == 0 ? "" : $"{timediff.Hours}小時")}{(timediff.Minutes == 0 ? "" : $"{timediff.Minutes}分鐘")}";
                base.Insert_CareRecord(form["TXT_END_TIME_DAY"] + " " + form["TXT_END_TIME_TIME"], id + "END", "皮膚接觸-結束", $"{Obj}結束肌膚接觸共{TotalTime}，因{(STA_REASON_C.Count() > 0 ? $"{Obj}{String.Join(", ", STA_REASON_C) + "。"}" : $"")} {(STA_REASON_NB.Count() > 0 ? $"新生兒{String.Join(", ", STA_REASON_NB) + "。"}" : $"")}", "", "", "", "", "OBS_SKTSK");
            }
            if (ptinfo.Age < 1)
            {
                Insert_CareRecord_ForOtherTns(momfeeno, form["TXT_START_TIME_DAY"] + " " + form["TXT_START_TIME_TIME"], id + "START", "皮膚接觸-新增", $"{Obj}於{LOCATION_NAME}執行肌膚接觸。", "", "", "", "", "OBS_SKTSK", ref link);
                if (IsNoEmpty(form["TXT_END_TIME_DAY"]) && IsNoEmpty(form["TXT_END_TIME_TIME"]))
                {
                    var TotalTime = "";
                    var s_time = Convert.ToDateTime(form["TXT_START_TIME_DAY"] + " " + form["TXT_START_TIME_TIME"]);
                    var e_time = Convert.ToDateTime(form["TXT_END_TIME_DAY"] + " " + form["TXT_END_TIME_TIME"]);

                    var timediff = e_time - s_time;
                    TotalTime = $"{(timediff.Days == 0 ? "" : $"{timediff.Days}天")}{(timediff.Hours == 0 ? "" : $"{timediff.Hours}小時")}{(timediff.Minutes == 0 ? "" : $"{timediff.Minutes}分鐘")}";
                    Insert_CareRecord_ForOtherTns(momfeeno, form["TXT_END_TIME_DAY"] + " " + form["TXT_END_TIME_TIME"], id + "END", "皮膚接觸-結束", $"{Obj}結束肌膚接觸共{TotalTime}，因{(STA_REASON_C.Count() > 0 ? $"{Obj}{String.Join(", ", STA_REASON_C) + "。"}" : $"")} {(STA_REASON_NB.Count() > 0 ? $"新生兒{String.Join(", ", STA_REASON_NB) + "。"}" : $"")}", "", "", "", "", "OBS_SKTSK", ref link);
                }
            }
            else
            {
                Insert_CareRecord_ForOtherTns(NBFeeno, form["TXT_START_TIME_DAY"] + " " + form["TXT_START_TIME_TIME"], id + "START", "皮膚接觸-新增", $"{Obj}於{LOCATION_NAME}執行肌膚接觸。", "", "", "", "", "OBS_SKTSK", ref link);
                if (IsNoEmpty(form["TXT_END_TIME_DAY"]) && IsNoEmpty(form["TXT_END_TIME_TIME"]))
                {
                    var TotalTime = "";
                    var s_time = Convert.ToDateTime(form["TXT_START_TIME_DAY"] + " " + form["TXT_START_TIME_TIME"]);
                    var e_time = Convert.ToDateTime(form["TXT_END_TIME_DAY"] + " " + form["TXT_END_TIME_TIME"]);

                    var timediff = e_time - s_time;
                    TotalTime = $"{(timediff.Days == 0 ? "" : $"{timediff.Days}天")}{(timediff.Hours == 0 ? "" : $"{timediff.Hours}小時")}{(timediff.Minutes == 0 ? "" : $"{timediff.Minutes}分鐘")}";
                    Insert_CareRecord_ForOtherTns(NBFeeno, form["TXT_END_TIME_DAY"] + " " + form["TXT_END_TIME_TIME"], id + "END", "皮膚接觸-結束", $"{Obj}結束肌膚接觸共{TotalTime}，因{(STA_REASON_C.Count() > 0 ? $"{Obj}{String.Join(", ", STA_REASON_C) + "。"}" : $"")} {(STA_REASON_NB.Count() > 0 ? $"新生兒{String.Join(", ", STA_REASON_NB) + "。"}" : $"")}", "", "", "", "", "OBS_SKTSK", ref link);
                }
            }

            if (erow > 0)
            {
                json_result.status = RESPONSE_STATUS.SUCCESS;
                json_result.message = "新增成功";
            }
            else
            {
                json_result.status = RESPONSE_STATUS.ERROR;
                json_result.message = "新增失敗";
            }

            return Content(JsonConvert.SerializeObject(json_result), "application/json");
        }
        #endregion

        #region 皮膚接觸編輯
        /// <summary>
        /// 皮膚接觸編輯
        /// </summary>
        /// <param name="form"></param>
        /// <returns></returns>
        [HttpPost]
        public ActionResult Upd_SkinTouch(FormCollection form)
        {
            RESPONSE_MSG json_result = new RESPONSE_MSG();

            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo.FeeNo;
            string[] id_list = form["S_IID"].Split(',');
            int erow = 0;
            for (int v = 0; v < id_list.Length; v++)
            {
                List<DBItem> insertDataList = new List<DBItem>();
                insertDataList.Add(new DBItem("UPDNO", userno, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("UPDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime));
                insertDataList.Add(new DBItem("RECORDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間

                var PAT_FEENO = form["TXT_PAT_FEENO" + id_list[v]];
                var NB_CHARTNO = form["TXT_NB_CHARTNO" + id_list[v]];
                var SEQ_OF_NB = form["SEQ_OF_NB"];

                var NBFeeno = "";
                var momfeeno = "";

                DataTable dt_babylink = obs_m.sel_nbcha("", NB_CHARTNO);
                if (dt_babylink == null || dt_babylink.Rows.Count == 0) { }
                else
                {
                    NBFeeno = dt_babylink.Rows[0]["BABY_FEE_NO"].ToString();
                    momfeeno = dt_babylink.Rows[0]["MOM_FEE_NO"].ToString();
                }

                var LOCATION = form["RB_LOCATION" + id_list[v]];
                insertDataList.Add(new DBItem("LOCATION", LOCATION, DBItem.DBDataType.String));
                if (LOCATION == "7")
                {
                    if (!IsNoEmpty(form["TXT_LOCA_OTH" + id_list[v]]))
                    {
                        json_result.status = RESPONSE_STATUS.ERROR;
                        json_result.message = "地點-其他未填寫!";
                        return Content(JsonConvert.SerializeObject(json_result), "application/json");
                    }
                    insertDataList.Add(new DBItem("LOCA_OTH", form["TXT_LOCA_OTH" + id_list[v]], DBItem.DBDataType.String));
                }
                else
                {
                    insertDataList.Add(new DBItem("LOCA_OTH", null, DBItem.DBDataType.String));
                }
                var LOCATION_NAME = "";
                switch (LOCATION)
                {
                    case "0":
                        LOCATION_NAME = "產房";
                        break;
                    case "1":
                        LOCATION_NAME = "開刀房";
                        break;
                    case "2":
                        LOCATION_NAME = "恢復室";
                        break;
                    case "3":
                        LOCATION_NAME = "嬰兒室";
                        break;
                    case "4":
                        LOCATION_NAME = "產後病房";
                        break;
                    case "5":
                        LOCATION_NAME = "兒科中重度病房";
                        break;
                    case "6":
                        LOCATION_NAME = "兒科加護病房";
                        break;
                    case "7":
                        LOCATION_NAME = "其他";
                        if (form["TXT_LOCA_OTH" + id_list[v]].ToString() != "")
                        {
                            LOCATION_NAME += $"-{form["TXT_LOCA_OTH" + id_list[v]]}";
                        }
                        break;
                    default:
                        LOCATION_NAME = "";
                        break;
                }

                insertDataList.Add(new DBItem("WHO", form["RB_WHO" + id_list[v]], DBItem.DBDataType.String));
                var Obj = "";
                switch (form["RB_WHO" + id_list[v]] ?? "")
                {
                    case "0":
                        Obj = "母親";
                        break;
                    case "1":
                        Obj = "父親";
                        break;
                    default:
                        Obj = "";
                        break;
                }


                if (IsNoEmpty(form["TXT_START_TIME_DAY"]) && IsNoEmpty(form["TXT_START_TIME_TIME"]))
                {
                    insertDataList.Add(new DBItem("START_TIME", form["TXT_START_TIME_DAY"] + " " + form["TXT_START_TIME_TIME"], DBItem.DBDataType.DataTime));
                }

                if (IsNoEmpty(form["TXT_START_TIME_DAY"]) && IsNoEmpty(form["TXT_START_TIME_TIME"]) &&
               IsNoEmpty(form["TXT_END_TIME_DAY"]) && IsNoEmpty(form["TXT_END_TIME_TIME"]))
                {
                    var s_time = Convert.ToDateTime(form["TXT_START_TIME_DAY"] + " " + form["TXT_START_TIME_TIME"]);
                    var e_time = Convert.ToDateTime(form["TXT_END_TIME_DAY"] + " " + form["TXT_END_TIME_TIME"]);

                    var timediff = e_time - s_time;
                    if (timediff.TotalSeconds < 0)
                    {
                        json_result.status = RESPONSE_STATUS.ERROR;
                        json_result.message = "開始時間不得大於結束時間";
                        return Content(JsonConvert.SerializeObject(json_result), "application/json");
                    }

                    var duplicateSql = $@"SELECT * FROM OBS_SKTSK WHERE 0 = 0 AND (PAT_FEENO = '{PAT_FEENO}' or NB_CHARTNO = '{NB_CHARTNO}') 
 AND SEQ_OF_NB = '{SEQ_OF_NB}' 
                    AND DELETED IS NULL AND IID != '{id_list[v]}' 
AND (
START_TIME BETWEEN TO_DATE('{s_time.ToString("yyyy/MM/dd HH:mm")}', 'YYYY/MM/DD HH24:MI') AND TO_DATE('{e_time.ToString("yyyy/MM/dd HH:mm")}', 'YYYY/MM/DD HH24:MI')
OR 
END_TIME BETWEEN TO_DATE('{s_time.ToString("yyyy/MM/dd HH:mm")}', 'YYYY/MM/DD HH24:MI') AND TO_DATE('{e_time.ToString("yyyy/MM/dd HH:mm")}', 'YYYY/MM/DD HH24:MI')
OR
TO_DATE('{s_time.ToString("yyyy/MM/dd HH:mm")}', 'YYYY/MM/DD HH24:MI') BETWEEN START_TIME AND END_TIME
OR
TO_DATE('{e_time.ToString("yyyy/MM/dd HH:mm")}', 'YYYY/MM/DD HH24:MI') BETWEEN START_TIME AND END_TIME
) ORDER BY START_TIME DESC";

                    DataTable duplicate = obs_m.DBExecSQL(duplicateSql);
                    if (duplicate != null && duplicate.Rows.Count > 0)
                    {
                        json_result.status = RESPONSE_STATUS.ERROR;
                        json_result.message = "時間重疊，請確認資料!";
                        return Content(JsonConvert.SerializeObject(json_result), "application/json");
                    }
                }
                else
                {
                    if (IsNoEmpty(form["TXT_START_TIME_DAY"]) && IsNoEmpty(form["TXT_START_TIME_TIME"]))
                    {
                        var s_time = Convert.ToDateTime(form["TXT_START_TIME_DAY"] + " " + form["TXT_START_TIME_TIME"]);
                        var duplicateSql = $@"SELECT * FROM OBS_SKTSK WHERE 0 = 0 AND (PAT_FEENO = '{PAT_FEENO}' or NB_CHARTNO = '{NB_CHARTNO}') 
                    AND SEQ_OF_NB = '{SEQ_OF_NB}' 
                    AND DELETED IS NULL AND IID != '{id_list[v]}' AND TO_DATE('{s_time.ToString("yyyy/MM/dd HH:mm")}', 'YYYY/MM/DD HH24:MI') <= END_TIME
                    ORDER BY START_TIME DESC";

                        DataTable duplicate = obs_m.DBExecSQL(duplicateSql);
                        if (duplicate != null && duplicate.Rows.Count > 0)
                        {
                            json_result.status = RESPONSE_STATUS.ERROR;
                            json_result.message = "必須大於最新一筆結束時間，請確認資料!";
                            return Content(JsonConvert.SerializeObject(json_result), "application/json");
                        }
                    }
                }

                if (IsNoEmpty(form["TXT_END_TIME_DAY"]) && IsNoEmpty(form["TXT_END_TIME_TIME"]))
                {
                    insertDataList.Add(new DBItem("END_TIME", form["TXT_END_TIME_DAY"] + " " + form["TXT_END_TIME_TIME"], DBItem.DBDataType.DataTime));
                }

                var STA_REASON_C = new List<string>();
                var STA_REASON_NB = new List<string>();
                //結束原因
                var END_RS = form["CK_END_RS" + id_list[v]];
                var END_RSV = new List<string>() { "0", "0" };
                if (END_RS == null)
                {
                    if (IsNoEmpty(form["TXT_END_TIME_DAY"]) && IsNoEmpty(form["TXT_END_TIME_TIME"]))
                    {
                        json_result.status = RESPONSE_STATUS.ERROR;
                        json_result.message = "結束原因未填寫!";
                        return Content(JsonConvert.SerializeObject(json_result), "application/json");
                    }
                    insertDataList.Add(new DBItem("END_RS", String.Join("", END_RSV), DBItem.DBDataType.String));
                }
                else
                {
                    var END_RS_SP = END_RS.Split(',');
                    foreach (var i in END_RS_SP)
                        END_RSV[Convert.ToInt32(i)] = "1";
                    insertDataList.Add(new DBItem("END_RS", String.Join("", END_RSV), DBItem.DBDataType.String));
                }

                //結束原因-接觸人
                if (END_RSV[0] == "1")
                {
                    var END_RS_CT = form["CK_END_RS_CT" + id_list[v]];
                    var END_RS_CTV = new List<string>() { "0", "0", "0", "0", "0", "0", "0", "0", "0" };
                    if (END_RS_CT == null)
                    {
                        json_result.status = RESPONSE_STATUS.ERROR;
                        json_result.message = "接觸人原因未填寫!";
                        return Content(JsonConvert.SerializeObject(json_result), "application/json");
                    }
                    else
                    {
                        var END_RS_CT_SP = END_RS_CT.Split(',');
                        foreach (var i in END_RS_CT_SP)
                            END_RS_CTV[Convert.ToInt32(i)] = "1";
                        insertDataList.Add(new DBItem("END_RS_CT", String.Join("", END_RS_CTV), DBItem.DBDataType.String));
                    }

                    if (END_RS_CTV[7] == "1")
                    {
                        if (!IsNoEmpty(form["TXT_END_RS_CT_OTH" + id_list[v]]))
                        {
                            json_result.status = RESPONSE_STATUS.ERROR;
                            json_result.message = "接觸人原因-其他未填寫!";
                            return Content(JsonConvert.SerializeObject(json_result), "application/json");
                        }
                        insertDataList.Add(new DBItem("END_RS_CT_OTH", form["TXT_END_RS_CT_OTH" + id_list[v]], DBItem.DBDataType.String));
                    }
                    else
                        insertDataList.Add(new DBItem("END_RS_CT_OTH", null, DBItem.DBDataType.String));

                    for (var i = 0; i < END_RS_CTV.Count; i++)
                    {
                        if (i == 0 && END_RS_CTV[i] == "1")
                        {
                            STA_REASON_C.Add("生命徵象不穩定");
                        }
                        if (i == 1 && END_RS_CTV[i] == "1")
                        {
                            STA_REASON_C.Add("嘔吐");
                        }
                        if (i == 2 && END_RS_CTV[i] == "1")
                        {
                            STA_REASON_C.Add("發燒");
                        }
                        if (i == 3 && END_RS_CTV[i] == "1")
                        {
                            STA_REASON_C.Add("傷口疼痛");
                        }
                        if (i == 4 && END_RS_CTV[i] == "1")
                        {
                            STA_REASON_C.Add("有精神疾患");
                        }
                        if (i == 5 && END_RS_CTV[i] == "1")
                        {
                            STA_REASON_C.Add("拒絕");
                        }
                        if (i == 6 && END_RS_CTV[i] == "1")
                        {
                            STA_REASON_C.Add("疲憊");
                        }
                        if (i == 7 && END_RS_CTV[i] == "1")
                        {
                            var d = "其他";
                            if (form["TXT_END_RS_CT_OTH" + id_list[v]] != "")
                            {
                                d += $"-{form["TXT_END_RS_CT_OTH" + id_list[v]]}";
                            }
                            STA_REASON_C.Add(d);
                        }
                        if (i == 8 && END_RS_CTV[i] == "1")
                        {
                            STA_REASON_C.Add("返病房");
                        }
                    }
                }
                else
                    insertDataList.Add(new DBItem("END_RS_CT", null, DBItem.DBDataType.String));
                //結束原因-新生兒
                if (END_RSV[1] == "1")
                {
                    var END_RS_NB = form["CK_END_RS_NB" + id_list[v]];
                    var END_RS_NBV = new List<string>() { "0", "0", "0", "0", "0" };
                    if (END_RS_NB == null)
                    {
                        json_result.status = RESPONSE_STATUS.ERROR;
                        json_result.message = "新生兒原因未填寫!";
                        return Content(JsonConvert.SerializeObject(json_result), "application/json");
                    }
                    else
                    {
                        var END_RS_NB_SP = END_RS_NB.Split(',');
                        foreach (var i in END_RS_NB_SP)
                            END_RS_NBV[Convert.ToInt32(i)] = "1";
                        insertDataList.Add(new DBItem("END_RS_NB", String.Join("", END_RS_NBV), DBItem.DBDataType.String));

                        if (END_RS_NBV[3] == "1")
                        {
                            if (!IsNoEmpty(form["TXT_END_RS_NB_OTH" + id_list[v]]))
                            {
                                json_result.status = RESPONSE_STATUS.ERROR;
                                json_result.message = "新生兒原因-其他未填寫!";
                                return Content(JsonConvert.SerializeObject(json_result), "application/json");
                            }
                            insertDataList.Add(new DBItem("END_RS_NB_OTH", form["TXT_END_RS_NB_OTH" + id_list[v]], DBItem.DBDataType.String));
                        }
                        else
                            insertDataList.Add(new DBItem("END_RS_NB_OTH", null, DBItem.DBDataType.String));
                    }

                    for (var i = 0; i < END_RS_NBV.Count; i++)
                    {
                        if (i == 0 && END_RS_NBV[i] == "1")
                        {
                            STA_REASON_NB.Add("生命徵象不穩定");
                        }
                        if (i == 1 && END_RS_NBV[i] == "1")
                        {
                            STA_REASON_NB.Add("早產");
                        }
                        if (i == 2 && END_RS_NBV[i] == "1")
                        {
                            STA_REASON_NB.Add("低血糖");
                        }
                        if (i == 3 && END_RS_NBV[i] == "1")
                        {
                            var d = "其他";
                            if (form["TXT_END_RS_NB_OTH" + id_list[v]] != "")
                            {
                                d += $"-{form["TXT_END_RS_NB_OTH" + id_list[v]]}";
                            }
                            STA_REASON_NB.Add(d);
                        }
                        if (i == 4 && END_RS_NBV[i] == "1")
                        {
                            STA_REASON_NB.Add("返嬰兒室");
                        }
                    }
                }
                else
                {
                    insertDataList.Add(new DBItem("END_RS_NB_OTH", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("END_RS_NB", null, DBItem.DBDataType.String));
                }

                string where = " IID = '" + id_list[v] + "' ";
                insertDataList = setNullToEmpty(insertDataList);
                erow += obs_m.DBExecUpdate("OBS_SKTSK", insertDataList, where);

                base.Upd_CareRecord(form["TXT_START_TIME_DAY" + id_list[v]] + " " + form["TXT_START_TIME_TIME"], id_list[v] + "START", "皮膚接觸-新增", $"{Obj}於{LOCATION_NAME}執行肌膚接觸。", "", "", "", "", "OBS_SKTSK");
                if (ptinfo.Age < 1)
                {
                    Upd_CareRecord_ForOtherTns(momfeeno, form["TXT_START_TIME_DAY"] + " " + form["TXT_START_TIME_TIME"], id_list[v] + "START", "皮膚接觸-新增", $"{Obj}於{LOCATION_NAME}執行肌膚接觸。", "", "", "", "", "OBS_SKTSK", ref link);
                }
                else
                {
                    Upd_CareRecord_ForOtherTns(NBFeeno, form["TXT_START_TIME_DAY"] + " " + form["TXT_START_TIME_TIME"], id_list[v] + "START", "皮膚接觸-新增", $"{Obj}於{LOCATION_NAME}執行肌膚接觸。", "", "", "", "", "OBS_SKTSK", ref link);
                }

                if (IsNoEmpty(form["TXT_END_TIME_DAY"]) && IsNoEmpty(form["TXT_END_TIME_TIME"]))
                {
                    var TotalTime = "";
                    var s_time = Convert.ToDateTime(form["TXT_START_TIME_DAY"] + " " + form["TXT_START_TIME_TIME"]);
                    var e_time = Convert.ToDateTime(form["TXT_END_TIME_DAY"] + " " + form["TXT_END_TIME_TIME"]);

                    var timediff = e_time - s_time;
                    TotalTime = $"{(timediff.Days == 0 ? "" : $"{timediff.Days}天")}{(timediff.Hours == 0 ? "" : $"{timediff.Hours}小時")}{(timediff.Minutes == 0 ? "" : $"{timediff.Minutes}分鐘")}";

                    var careSql = $"SELECT * FROM CARERECORD_DATA where DELETED IS NULL AND CARERECORD_ID = '{id_list[v] + "END"}'";
                    DataTable care = obs_m.DBExecSQL(careSql);
                    if (care != null && care.Rows.Count > 0)
                    {
                        base.Upd_CareRecord(form["TXT_END_TIME_DAY"] + " " + form["TXT_END_TIME_TIME"], id_list[v] + "END", "皮膚接觸-結束", $"{Obj}結束肌膚接觸共{TotalTime}，因{(STA_REASON_C.Count() > 0 ? $"{Obj}{String.Join(", ", STA_REASON_C) + "。"}" : $"")} {(STA_REASON_NB.Count() > 0 ? $"新生兒{String.Join(", ", STA_REASON_NB) + "。"}" : $"")}", "", "", "", "", "OBS_SKTSK");
                        if (ptinfo.Age < 1)
                        {
                            Upd_CareRecord_ForOtherTns(momfeeno, form["TXT_END_TIME_DAY"] + " " + form["TXT_END_TIME_TIME"], id_list[v] + "END", "皮膚接觸-結束", $"{Obj}結束肌膚接觸共{TotalTime}，因{(STA_REASON_C.Count() > 0 ? $"{Obj}{String.Join(", ", STA_REASON_C) + "。"}" : $"")} {(STA_REASON_NB.Count() > 0 ? $"新生兒{String.Join(", ", STA_REASON_NB) + "。"}" : $"")}", "", "", "", "", "OBS_SKTSK", ref link);
                        }
                        else
                        {
                            Upd_CareRecord_ForOtherTns(NBFeeno, form["TXT_END_TIME_DAY"] + " " + form["TXT_END_TIME_TIME"], id_list[v] + "END", "皮膚接觸-結束", $"{Obj}結束肌膚接觸共{TotalTime}，因{(STA_REASON_C.Count() > 0 ? $"{Obj}{String.Join(", ", STA_REASON_C) + "。"}" : $"")} {(STA_REASON_NB.Count() > 0 ? $"新生兒{String.Join(", ", STA_REASON_NB) + "。"}" : $"")}", "", "", "", "", "OBS_SKTSK", ref link);
                        }
                    }
                    else
                    {
                        base.Insert_CareRecord(form["TXT_END_TIME_DAY"] + " " + form["TXT_END_TIME_TIME"], id_list[v] + "END", "皮膚接觸-結束", $"{Obj}結束肌膚接觸共{TotalTime}，因{(STA_REASON_C.Count() > 0 ? $"{Obj}{String.Join(", ", STA_REASON_C) + "。"}" : $"")} {(STA_REASON_NB.Count() > 0 ? $"新生兒{String.Join(", ", STA_REASON_NB) + "。"}" : $"")}", "", "", "", "", "OBS_SKTSK");
                        if (ptinfo.Age < 1)
                        {
                            Insert_CareRecord_ForOtherTns(momfeeno, form["TXT_END_TIME_DAY"] + " " + form["TXT_END_TIME_TIME"], id_list[v] + "END", "皮膚接觸-結束", $"{Obj}結束肌膚接觸共{TotalTime}，因{(STA_REASON_C.Count() > 0 ? $"{Obj}{String.Join(", ", STA_REASON_C) + "。"}" : $"")} {(STA_REASON_NB.Count() > 0 ? $"新生兒{String.Join(", ", STA_REASON_NB) + "。"}" : $"")}", "", "", "", "", "OBS_SKTSK", ref link);
                        }
                        else
                        {
                            Insert_CareRecord_ForOtherTns(NBFeeno, form["TXT_END_TIME_DAY"] + " " + form["TXT_END_TIME_TIME"], id_list[v] + "END", "皮膚接觸-結束", $"{Obj}結束肌膚接觸共{TotalTime}，因{(STA_REASON_C.Count() > 0 ? $"{Obj}{String.Join(", ", STA_REASON_C) + "。"}" : $"")} {(STA_REASON_NB.Count() > 0 ? $"新生兒{String.Join(", ", STA_REASON_NB) + "。"}" : $"")}", "", "", "", "", "OBS_SKTSK", ref link);
                        }
                    }
                }
            }
            if (erow > 0)
            {
                json_result.status = RESPONSE_STATUS.SUCCESS;
                json_result.message = "修改成功";
            }
            else
            {
                json_result.status = RESPONSE_STATUS.ERROR;
                json_result.message = "修改失敗";
            }
            return Content(JsonConvert.SerializeObject(json_result), "application/json");
        }
        #endregion

        #region 皮膚接觸刪除
        /// <summary>
        /// 皮膚接觸刪除
        /// </summary>
        /// <param name="form"></param>
        /// <returns></returns>
        [HttpPost]
        public string Del_SkinTouch()
        {
            JavaScriptSerializer serializer = new JavaScriptSerializer();

            string[] id_list = Request["S_IID"].Split(',');
            string where = " IID IN ('" + String.Join("','", id_list) + "')";

            var sql = $"SELECT * FROM OBS_SKTSK WHERE " + where;
            DataTable dt = obs_m.DBExecSQL(sql);
            if (dt != null && dt.Rows.Count > 0)
            {
                foreach (DataRow r in dt.Rows)
                {
                    if (r["END_TIME"].ToString() != "" && r["UPDNO"].ToString() != userinfo.EmployeesNo)
                    {
                        return serializer.Serialize("資料已結案，僅結案者可刪除!");
                    }
                    else if (r["END_TIME"].ToString() == "" && r["UPDNO"].ToString() != "")
                    {
                        if (r["UPDNO"].ToString() != userinfo.EmployeesNo)
                        {
                            return serializer.Serialize("無權限刪除!");
                        }
                    }
                    else if (r["END_TIME"].ToString() == "" && r["UPDNO"].ToString() == "")
                    {
                        if (r["CREATNO"].ToString() != userinfo.EmployeesNo)
                        {
                            return serializer.Serialize("無權限刪除!");
                        }
                    }
                }
            }

            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("DELETED", userinfo.EmployeesNo, DBItem.DBDataType.String));
            insertDataList = setNullToEmpty(insertDataList);
            int erow = obs_m.DBExecUpdate("OBS_SKTSK", insertDataList, where);

            for (var i = 0; i < id_list.Length; i++)
            {
                Del_CareRecord(id_list[i] + "START", "OBS_SKTSK");
                Del_CareRecord(id_list[i] + "END", "OBS_SKTSK");
            }

            if (erow > 0)
                return serializer.Serialize("刪除成功");
            else
                return serializer.Serialize("刪除失敗");
        }
        #endregion

        #region 母嬰同室新增/編輯畫面
        /// <summary>
        /// 母嬰同室新增/編輯畫面
        /// </summary>
        /// <param name="id"></param>
        /// <returns></returns>
        public ActionResult Insert_RoomIn(string IID, string Type = "")
        {
            if (IID != null)
            {
                DataTable dt = obs_m.sel_roomin("", IID);
                if (dt != null && dt.Rows.Count > 0)
                {
                    dt.Columns.Add("UPDNO_NAME");
                    dt.Columns.Add("PAT_FEENO_NAME");
                    dt.Columns.Add("NB_CHARTNO_NAME");
                    dt.Columns.Add("NB_CHARTNO_E_NAME");
                    foreach (DataRow r in dt.Rows)
                    {
                        if (r["END_TIME"].ToString() != "" && r["UPDNO"].ToString() != userinfo.EmployeesNo)
                        {
                            Response.Write("<script>alert('資料已結案，僅結案者可修改!');window.close();</script>");
                            return new EmptyResult();
                        }

                        //結案時預設結束時間
                        if (Type.IndexOf("Close") >= 0)
                        {
                            r["END_TIME"] = DateTime.Now;
                        }

                        if (r["UPDNO"].ToString() != "")
                        {
                            byte[] listByteCode1 = webService.UserName(r["UPDNO"].ToString());
                            if (listByteCode1 == null)
                                r["UPDNO_NAME"] = "";
                            else
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode1);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                r["UPDNO_NAME"] = user_name.EmployeesName;
                            }
                        }

                        byte[] listByteCode = webService.GetPatFeeNo(r["PAT_FEENO"].ToString());
                        if (listByteCode == null) { }
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(listByteCode);
                            BabyLab[] patinfo = JsonConvert.DeserializeObject<BabyLab[]>(listJsonArray);
                            var feeNo = "";
                            if (patinfo != null && patinfo.Count() > 0)
                                feeNo = patinfo[0].FEE_NO;

                            byte[] ByteCode = webService.GetPatientInfo(feeNo);
                            if (ByteCode != null)
                                r["PAT_FEENO_NAME"] = JsonConvert.DeserializeObject<PatientInfo>(CompressTool.DecompressString(ByteCode)).PatientName;
                        }

                        DataTable baby_dt = obs_m.sel_nbcha("", r["NB_CHARTNO"].ToString());
                        if (baby_dt != null && baby_dt.Rows.Count > 0)
                        {
                            byte[] listByteCode_b = webService.GetPatientInfo(baby_dt.Rows[0]["BABY_FEE_NO"].ToString());
                            if (listByteCode_b == null) { }
                            string listJsonArray_b = CompressTool.DecompressString(listByteCode_b);
                            PatientInfo patientInfo = JsonConvert.DeserializeObject<PatientInfo>(listJsonArray_b);
                            r["NB_CHARTNO_NAME"] = patientInfo.PatientName;
                        }

                        if (r["NB_CHARTNO_E"].ToString() != "")
                        {
                            DataTable baby_e_dt = obs_m.sel_nbcha("", r["NB_CHARTNO_E"].ToString());
                            if (baby_e_dt != null && baby_e_dt.Rows.Count > 0)
                            {
                                byte[] listByteCode_b = webService.GetPatientInfo(baby_e_dt.Rows[0]["BABY_FEE_NO"].ToString());
                                if (listByteCode_b == null) { }
                                string listJsonArray_b = CompressTool.DecompressString(listByteCode_b);
                                PatientInfo patientInfo = JsonConvert.DeserializeObject<PatientInfo>(listJsonArray_b);
                                r["NB_CHARTNO_E_NAME"] = patientInfo.PatientName;
                            }
                        }
                    }
                }
                ViewBag.dt = dt;
            }
            else
            {
                DataTable dt = null;
                if (ptinfo.Age < 1)
                {
                    dt = obs_m.sel_roomin("", "", "", new List<string>() { ptinfo.ChartNo.PadLeft(10, '0') }, "", true);
                }
                else
                {
                    DataTable dtnb = obs_m.sel_nb(ptinfo.FeeNo);
                    if (dtnb != null && dtnb.Rows.Count > 0)
                    {
                        if (dtnb.Rows.Count == 1)
                        {
                            dt = obs_m.sel_roomin("", "", ptinfo.ChartNo.PadLeft(10, '0'), null, "", true);
                        }
                        else
                        {
                            Response.Write($"<script>alert('此產婦有{dtnb.Rows.Count}個小孩，輸入小孩病歷號檢查是否有未結束之資料');</script>");
                        }
                    }
                }
                if (dt != null && dt.Rows.Count > 0)
                {
                    Response.Write("<script>alert('尚有資料未結束!');window.close();</script>");
                    return new EmptyResult();
                }
            }
            ViewBag.Type = Type;
            return View();
        }
        #endregion

        #region NB_Data Models
        public class NB_Data
        {
            public string SEQ { set; get; }
            public string NB_NAME { set; get; }
            public string MOM_NAME { set; get; }
            public string NB_CHARTNO { set; get; }
            public string NB_FEENO { set; get; }
            public string BIRTH_DAY { set; get; }
            public string BIRTH_TIME { set; get; }
            public string BIRTH_TYPE { set; get; }
            public string GENDER { set; get; }
            public string WEIGHT_BIRTH { set; get; }
            public string WEIGHT_NOW { set; get; }
            public string AGE_N { set; get; }
        }
        #endregion

        #region 媽媽取得所有小孩病歷號 (by FeeNo)
        public string Get_NB_By_FeeNo(string feeNo)
        {
            var nbList = new List<NB_Data>();
            if (feeNo != null && feeNo != "")
            {
                DataTable dt = obs_m.sel_nbcha("", "", feeNo);
                if (dt != null && dt.Rows.Count > 0)
                {
                    foreach (DataRow r in dt.Rows)
                    {
                        DataTable dtnb = obs_m.sel_nb(feeNo, r["BABY_CHART_NO"].ToString());
                        var nbName = "";

                        if (dtnb != null && dtnb.Rows.Count > 0)
                        {
                            nbName = dtnb.Rows[0]["NB_NAME"].ToString();
                        }

                        var o = new NB_Data()
                        {
                            SEQ = r["BABY_SEQ"].ToString(),
                            NB_FEENO = r["BABY_FEE_NO"].ToString(),
                            NB_NAME = nbName,
                            NB_CHARTNO = r["BABY_CHART_NO"].ToString(),
                        };
                        nbList.Add(o);
                    }
                }
            }
            JavaScriptSerializer serializer = new JavaScriptSerializer();
            string ret = serializer.Serialize(nbList);
            return ret;
        }
        #endregion

        #region 媽媽取得所有小孩病歷號 (by ChartNo)
        public string Get_NB(string chartNo)
        {
            var nbList = new List<NB_Data>();
            var momName = "";
            if (chartNo != null && chartNo != "")
            {
                byte[] listByteCode = webService.GetPatFeeNo(chartNo);
                if (listByteCode == null) { }
                else
                {
                    string listJsonArray = CompressTool.DecompressString(listByteCode);
                    BabyLab[] patinfo = JsonConvert.DeserializeObject<BabyLab[]>(listJsonArray);
                    var feeNo = "";
                    if (patinfo != null && patinfo.Count() > 0)
                        feeNo = patinfo[0].FEE_NO;


                    byte[] ByteCode = webService.GetPatientInfo(feeNo);
                    if (ByteCode != null)
                        momName = JsonConvert.DeserializeObject<PatientInfo>(CompressTool.DecompressString(ByteCode)).PatientName;

                    if (feeNo != null && feeNo != "")
                    {
                        DataTable dt = obs_m.sel_nbcha("", "", feeNo);
                        if (dt != null && dt.Rows.Count > 0)
                        {
                            foreach (DataRow r in dt.Rows)
                            {
                                DataTable dtnb = obs_m.sel_nb(feeNo, r["BABY_CHART_NO"].ToString());
                                var nbName = "";

                                if (dtnb != null && dtnb.Rows.Count > 0)
                                {
                                    nbName = dtnb.Rows[0]["NB_NAME"].ToString();
                                }

                                var o = new NB_Data()
                                {
                                    SEQ = r["BABY_SEQ"].ToString(),
                                    NB_FEENO = r["BABY_FEE_NO"].ToString(),
                                    NB_NAME = nbName,
                                    NB_CHARTNO = r["BABY_CHART_NO"].ToString(),
                                    MOM_NAME = momName
                                };
                                nbList.Add(o);
                            }
                        }
                    }
                }
            }
            JavaScriptSerializer serializer = new JavaScriptSerializer();
            string ret = serializer.Serialize(nbList);
            return ret;
        }
        #endregion

        #region 媽媽取得單一小孩資料
        public string Get_NB_Data(string Seq)
        {
            var nbList = new List<NB_Data>();
            if (Seq != null && Seq != "")
            {
                DataTable dt = obs_m.sel_nb(ptinfo?.FeeNo, "", "", ptinfo?.FeeNo + Seq);
                if (dt != null && dt.Rows.Count > 0)
                {
                    string weight = null;
                    foreach (DataRow r in dt.Rows)
                    {
                        DataTable dt_babylink = obs_m.sel_nbcha("", r["NB_CHARTNO"].ToString(), ptinfo?.FeeNo);
                        if (dt_babylink != null && dt_babylink.Rows.Count > 0)
                        {
                            #region 病人生命徵象
                            var sql = "SELECT CREATE_DATE, VS_ITEM, VS_PART, VS_RECORD, VS_MEMO,VS_REASON  "
                                    + " FROM ( "
                                    + "     SELECT CREATE_DATE, VS_ITEM, VS_PART, VS_RECORD, VS_MEMO,VS_REASON, "
                                    + "     ROW_NUMBER() OVER(PARTITION BY t.VS_ITEM ORDER BY t.CREATE_DATE desc) NUM "
                                    + "     FROM DATA_VITALSIGN t "
                                    + "     WHERE FEE_NO = '" + dt_babylink.Rows[0]["BABY_FEE_NO"] + "' "
                                    + "     AND VS_ITEM = 'bw' "
                                    + "     AND CREATE_DATE >= to_date('" + DateTime.Now.AddDays(-1).ToString("yyyy/MM/dd HH:mm:ss") + "','yyyy/MM/dd hh24:mi:ss') "
                                    + "     ORDER BY CREATE_DATE DESC ) MAIN "
                                    + "";
                            var Temp = new List<Dictionary<string, string>>();

                            DataTable Dt2 = link.DBExecSQL(sql);
                            if (Dt2.Rows.Count > 0)
                            {
                                for (int i = 0; i < Dt2.Rows.Count; i++)
                                {
                                    var temp = new Dictionary<string, string>();
                                    temp["CREATE_DATE"] = Dt2.Rows[i]["CREATE_DATE"].ToString();
                                    temp["VS_ITEM"] = Dt2.Rows[i]["VS_ITEM"].ToString();
                                    temp["VS_PART"] = Dt2.Rows[i]["VS_PART"].ToString();
                                    temp["VS_REASON"] = Dt2.Rows[i]["VS_REASON"].ToString();
                                    temp["VS_RECORD"] = Dt2.Rows[i]["VS_RECORD"].ToString();
                                    temp["VS_MEMO"] = Dt2.Rows[i]["VS_MEMO"].ToString();
                                    Temp.Add(temp);
                                }
                            }

                            if (Temp.Count > 0)
                            {
                                int rownum = 3;
                                List<Dictionary<string, string>> VitalSignList = new List<Dictionary<string, string>>();

                                VitalSignList = Temp.FindAll(x => x["VS_ITEM"] == "bw" && !string.IsNullOrEmpty(x["VS_RECORD"]));
                                if (VitalSignList.Count > 0)
                                {
                                    for (int i = 0; i < ((VitalSignList.Count < rownum) ? VitalSignList.Count : rownum); i++)
                                    {
                                        weight = VitalSignList[i]["VS_RECORD"].ToString().Split('|')[0];
                                    }
                                }
                            }
                            #endregion
                        }
                        var o = new NB_Data()
                        {
                            BIRTH_DAY = Convert.ToDateTime(r["BIRTH_DAY"]).ToString("yyyy/MM/dd"),
                            BIRTH_TIME = Convert.ToDateTime(r["BIRTH_DAY"]).ToString("HH:mm"),
                            BIRTH_TYPE = r["BIRTH_TYPE"].ToString(),
                            GENDER = r["GENDER"].ToString(),
                            AGE_N = (DateTime.Now - Convert.ToDateTime(r["BIRTH_DAY"])).Days.ToString(),
                            WEIGHT_BIRTH = $"Bw: {r["WEIGHT"].ToString()} gm BL: {r["HEIGHT"].ToString()} cm",
                            WEIGHT_NOW = weight
                        };
                        nbList.Add(o);
                    }
                }
            }
            JavaScriptSerializer serializer = new JavaScriptSerializer();
            string ret = serializer.Serialize(nbList);
            return ret;
        }
        #endregion

        #region 媽媽病歷號抓姓名
        /// <summary>
        /// 呼叫WebService取得員工姓名
        /// </summary>
        /// <param name="userno"></param>
        /// <returns></returns>
        public string GetMomNameByChartNo(string chartno, string babyChartno)
        {
            if (chartno != null && chartno != "")
            {
                byte[] listByteCode = webService.GetPatFeeNo(chartno);
                if (listByteCode == null) { return ""; }
                else
                {
                    string listJsonArray = CompressTool.DecompressString(listByteCode);
                    BabyLab[] patinfo = JsonConvert.DeserializeObject<BabyLab[]>(listJsonArray);
                    var feeNo = "";
                    if (patinfo != null && patinfo.Count() > 0)
                    {
                        feeNo = patinfo[0].FEE_NO;
                    }

                    if (!IsNoEmpty(babyChartno))
                    {
                        return "新生兒病歷號";
                    }

                    byte[] ByteCode = webService.GetPatientInfo(feeNo);
                    if (ByteCode != null)
                    {
                        var momName = JsonConvert.DeserializeObject<PatientInfo>(CompressTool.DecompressString(ByteCode)).PatientName;
                        DataTable babylink = obs_m.sel_nbcha("", babyChartno, feeNo);
                        if (babylink == null || babylink.Rows.Count == 0)
                        {
                            return $"對應錯誤/{momName}";
                        }

                        return momName;
                    }
                    else
                        return "";
                }
            }
            else
                return "";
        }
        #endregion

        #region 小孩病歷號抓姓名
        /// <summary>
        /// 呼叫WebService取得員工姓名
        /// </summary>
        /// <param name="userno"></param>
        /// <returns></returns>
        public string GetPatientNameByChartNo(string chartno)
        {
            DataTable dt_sk = obs_m.sel_sktsk("", "", "", new List<string>() { ptinfo.ChartNo.PadLeft(10, '0') }, "", true);
            if (dt_sk != null && dt_sk.Rows.Count > 0)
            {
                return "資料未結束";
            }

            DataTable dt = obs_m.sel_nbcha("", chartno);
            if (dt == null || dt.Rows.Count == 0)
                return "";
            else
            {
                byte[] listByteCode = webService.GetPatientInfo(dt.Rows[0]["BABY_FEE_NO"].ToString());
                if (listByteCode == null)
                    return "";
                string listJsonArray = CompressTool.DecompressString(listByteCode);
                PatientInfo patientInfo = JsonConvert.DeserializeObject<PatientInfo>(listJsonArray);

                var sql = $"SELECT * FROM NIS_SPECIAL_EVENT_DATA WHERE TYPE_ID = '6' AND FEENO = '{patientInfo.FeeNo}'";
                DataTable outdt = obs_m.DBExecSQL(sql);
                if (outdt != null && outdt.Rows.Count > 0)
                {
                    return "已出院";
                }
                else
                {
                    return patientInfo.PatientName;
                }
            }
        }
        #endregion

        #region 母嬰同室新增
        /// <summary>
        /// 母嬰同室新增
        /// </summary>
        /// <param name="form"></param>
        /// <returns></returns>
        [HttpPost]
        public ActionResult Insert_Roomin(FormCollection form)
        {
            RESPONSE_MSG json_result = new RESPONSE_MSG();

            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo.FeeNo;
            string id = base.creatid("OBS_ROOMIN", userno, feeno, "0");
            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("IID", id, DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("CREATNO", userno, DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("RECORDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間

            var EXCLUDE = "";
            insertDataList.Add(new DBItem("EXCLUDE", form["RB_EXCLUDE"], DBItem.DBDataType.String));
            if (form["RB_EXCLUDE"] == "1")
            {
                if (!IsNoEmpty(form["RB_EXC_R"]))
                {
                    json_result.status = RESPONSE_STATUS.ERROR;
                    json_result.message = "排除親子同室原因未填寫!";
                    return Content(JsonConvert.SerializeObject(json_result), "application/json");
                }
                insertDataList.Add(new DBItem("EXC_R", form["RB_EXC_R"], DBItem.DBDataType.String));
                if (form["RB_EXC_R"] == "4")
                {
                    if (!IsNoEmpty(form["TXT_EXC_MOM_R"]))
                    {
                        json_result.status = RESPONSE_STATUS.ERROR;
                        json_result.message = "排除親子同室原因-母親因素未填寫!";
                        return Content(JsonConvert.SerializeObject(json_result), "application/json");
                    }
                    insertDataList.Add(new DBItem("EXC_MOM_R", form["TXT_EXC_MOM_R"], DBItem.DBDataType.String));
                }

                if (form["RB_EXCLUDE"] == "0")
                {
                    EXCLUDE = "新生兒入PICU";
                }
                if (form["RB_EXCLUDE"] == "1")
                {
                    EXCLUDE = "新生兒入NBC";
                }
                if (form["RB_EXCLUDE"] == "2")
                {
                    EXCLUDE = "新生兒轉院";
                }
                if (form["RB_EXCLUDE"] == "3")
                {
                    EXCLUDE = "新生兒死亡";
                }
                if (form["RB_EXCLUDE"] == "4")
                {
                    EXCLUDE = "母親因素";
                    if (IsNoEmpty(form["TXT_EXC_MOM_R"]))
                    {
                        EXCLUDE += $"-{form["TXT_EXC_MOM_R"]}";
                    }
                }
            }

            var NB_CHARTNO = form["TXT_NB_CHARTNO"].ToString().Trim();
            var NBFeeno = "";
            if (!IsNoEmpty(NB_CHARTNO))
            {
                json_result.status = RESPONSE_STATUS.ERROR;
                json_result.message = "新生兒病歷號未填寫!";
                return Content(JsonConvert.SerializeObject(json_result), "application/json");
            }

            DataTable dt_babylink = obs_m.sel_nbcha("", NB_CHARTNO);
            if (dt_babylink == null || dt_babylink.Rows.Count == 0) { }
            else
            {
                NBFeeno = dt_babylink.Rows[0]["BABY_FEE_NO"].ToString();

                byte[] listByteCodeb = webService.GetPatientInfo(dt_babylink.Rows[0]["BABY_FEE_NO"].ToString());
                if (listByteCodeb == null)
                {
                    json_result.status = RESPONSE_STATUS.ERROR;
                    json_result.message = "查無此新生兒病歷號!(開始)";
                    return Content(JsonConvert.SerializeObject(json_result), "application/json");
                }
            }
            insertDataList.Add(new DBItem("NB_CHARTNO", NB_CHARTNO, DBItem.DBDataType.String));

            DataTable dt = obs_m.sel_nbcha("", NB_CHARTNO);
            var PAT_FEENO = form["TXT_PAT_FEENO"];
            var momfeeno = "";
            if (!IsNoEmpty(PAT_FEENO))
            {
                json_result.status = RESPONSE_STATUS.ERROR;
                json_result.message = "母親病歷號未填寫!";
                return Content(JsonConvert.SerializeObject(json_result), "application/json");
            }
            if (dt != null || dt.Rows.Count > 0)
            {
                momfeeno = dt.Rows[0]["MOM_FEE_NO"].ToString();
                PatientInfo momInfo = Get_Patient_Info(momfeeno);

                insertDataList.Add(new DBItem("SEQ_OF_NB", dt.Rows[0]["BABY_SEQ"].ToString(), DBItem.DBDataType.String));
                if (PAT_FEENO == momInfo.ChartNo.PadLeft(10, '0'))
                {
                    insertDataList.Add(new DBItem("PAT_FEENO", PAT_FEENO, DBItem.DBDataType.String));
                }
                else
                {
                    json_result.status = RESPONSE_STATUS.ERROR;
                    json_result.message = "新生兒與母親對應有誤!";
                    return Content(JsonConvert.SerializeObject(json_result), "application/json");
                }
            }

            if (IsNoEmpty(form["TXT_START_TIME_DAY"]) && IsNoEmpty(form["TXT_START_TIME_TIME"]))
                insertDataList.Add(new DBItem("START_TIME", form["TXT_START_TIME_DAY"] + " " + form["TXT_START_TIME_TIME"], DBItem.DBDataType.DataTime));
            else
            {
                json_result.status = RESPONSE_STATUS.ERROR;
                json_result.message = "開始時間未填寫!";
                return Content(JsonConvert.SerializeObject(json_result), "application/json");
            }


            if (IsNoEmpty(form["TXT_END_TIME_DAY"]) && IsNoEmpty(form["TXT_END_TIME_TIME"]))
            {
                insertDataList.Add(new DBItem("UPDNO", userno, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("UPDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime));

                insertDataList.Add(new DBItem("END_TIME", form["TXT_END_TIME_DAY"] + " " + form["TXT_END_TIME_TIME"], DBItem.DBDataType.DataTime));
            }

            if (IsNoEmpty(form["TXT_NB_CHARTNO_E"]))
            {
                if (form["TXT_NB_CHARTNO_E"].ToString().Trim() != NB_CHARTNO)
                {
                    json_result.status = RESPONSE_STATUS.ERROR;
                    json_result.message = "新生兒病歷號開始與結束不相同!";
                    return Content(JsonConvert.SerializeObject(json_result), "application/json");
                }
                insertDataList.Add(new DBItem("NB_CHARTNO_E", form["TXT_NB_CHARTNO_E"], DBItem.DBDataType.String));
            }
            else
            {
                if (IsNoEmpty(form["TXT_END_TIME_DAY"]) && IsNoEmpty(form["TXT_END_TIME_TIME"]))
                {
                    json_result.status = RESPONSE_STATUS.ERROR;
                    json_result.message = "新生兒病歷號結束未填寫!";
                    return Content(JsonConvert.SerializeObject(json_result), "application/json");
                }
            }

            if (IsNoEmpty(form["TXT_START_TIME_DAY"]) && IsNoEmpty(form["TXT_START_TIME_TIME"]) &&
                IsNoEmpty(form["TXT_END_TIME_DAY"]) && IsNoEmpty(form["TXT_END_TIME_TIME"]))
            {
                var s_time = Convert.ToDateTime(form["TXT_START_TIME_DAY"] + " " + form["TXT_START_TIME_TIME"]);
                var e_time = Convert.ToDateTime(form["TXT_END_TIME_DAY"] + " " + form["TXT_END_TIME_TIME"]);

                var timediff = e_time - s_time;
                if (timediff.TotalSeconds < 0)
                {
                    json_result.status = RESPONSE_STATUS.ERROR;
                    json_result.message = "開始時間不得大於結束時間";
                    return Content(JsonConvert.SerializeObject(json_result), "application/json");
                }

                var duplicateSql = $@"SELECT * FROM OBS_ROOMIN WHERE 0 = 0 AND (PAT_FEENO = '{PAT_FEENO}' or NB_CHARTNO = '{NB_CHARTNO}' or NB_CHARTNO_E = '{NB_CHARTNO}') 
 AND SEQ_OF_NB = '{dt.Rows[0]["BABY_SEQ"].ToString()}' 
                    AND DELETED IS NULL 
AND (
START_TIME BETWEEN TO_DATE('{s_time.ToString("yyyy/MM/dd HH:mm")}', 'YYYY/MM/DD HH24:MI') AND TO_DATE('{e_time.ToString("yyyy/MM/dd HH:mm")}', 'YYYY/MM/DD HH24:MI')
OR 
END_TIME BETWEEN TO_DATE('{s_time.ToString("yyyy/MM/dd HH:mm")}', 'YYYY/MM/DD HH24:MI') AND TO_DATE('{e_time.ToString("yyyy/MM/dd HH:mm")}', 'YYYY/MM/DD HH24:MI')
OR
TO_DATE('{s_time.ToString("yyyy/MM/dd HH:mm")}', 'YYYY/MM/DD HH24:MI') BETWEEN START_TIME AND END_TIME
OR
TO_DATE('{e_time.ToString("yyyy/MM/dd HH:mm")}', 'YYYY/MM/DD HH24:MI') BETWEEN START_TIME AND END_TIME
) ORDER BY START_TIME DESC";

                DataTable duplicate = obs_m.DBExecSQL(duplicateSql);
                if (duplicate != null && duplicate.Rows.Count > 0)
                {
                    json_result.status = RESPONSE_STATUS.ERROR;
                    json_result.message = "時間重疊，請確認資料!";
                    return Content(JsonConvert.SerializeObject(json_result), "application/json");
                }
            }
            else
            {
                if (IsNoEmpty(form["TXT_START_TIME_DAY"]) && IsNoEmpty(form["TXT_START_TIME_TIME"]))
                {
                    var s_time = Convert.ToDateTime(form["TXT_START_TIME_DAY"] + " " + form["TXT_START_TIME_TIME"]);
                    var duplicateSql = $@"SELECT * FROM OBS_ROOMIN WHERE 0 = 0 AND (PAT_FEENO = '{PAT_FEENO}' or NB_CHARTNO = '{NB_CHARTNO}' or NB_CHARTNO_E = '{NB_CHARTNO}') 
                    AND SEQ_OF_NB = '{dt.Rows[0]["BABY_SEQ"].ToString()}' 
                    AND DELETED IS NULL AND TO_DATE('{s_time.ToString("yyyy/MM/dd HH:mm")}', 'YYYY/MM/DD HH24:MI') <= END_TIME
                    ORDER BY START_TIME DESC";

                    DataTable duplicate = obs_m.DBExecSQL(duplicateSql);
                    if (duplicate != null && duplicate.Rows.Count > 0)
                    {
                        json_result.status = RESPONSE_STATUS.ERROR;
                        json_result.message = "必須大於最新一筆結束時間，請確認資料!";
                        return Content(JsonConvert.SerializeObject(json_result), "application/json");
                    }
                }
            }

            var END_STA = form["RB_END_STA"];
            if (!IsNoEmpty(END_STA))
            {
                if (IsNoEmpty(form["TXT_END_TIME_DAY"]) && IsNoEmpty(form["TXT_END_TIME_TIME"]))
                {
                    json_result.status = RESPONSE_STATUS.ERROR;
                    json_result.message = "結束原因未填寫!";
                    return Content(JsonConvert.SerializeObject(json_result), "application/json");
                }
            }
            insertDataList.Add(new DBItem("END_STA", END_STA, DBItem.DBDataType.String));
            var STA = "";
            var STA_REASON = new List<string>();

            if (END_STA == "0")
            {
                STA = "親子同室24HR";
                var END_RS_24 = form["CK_END_RS_24"];
                var END_RS_24V = new List<string>() { "0", "0", "0", "0" };
                if (END_RS_24 == null)
                {
                    json_result.status = RESPONSE_STATUS.ERROR;
                    json_result.message = "親子同室24HR原因未填寫!";
                    return Content(JsonConvert.SerializeObject(json_result), "application/json");
                }
                else
                {
                    var END_RS_24_SP = END_RS_24.Split(',');
                    foreach (var i in END_RS_24_SP)
                        END_RS_24V[Convert.ToInt32(i)] = "1";
                    insertDataList.Add(new DBItem("END_RS_24", String.Join("", END_RS_24V), DBItem.DBDataType.String));
                }

                for (var i = 0; i < END_RS_24V.Count; i++)
                {
                    if (i == 0 && END_RS_24V[i] == "1")
                    {
                        STA_REASON.Add("正常返室");
                    }
                    if (i == 1 && END_RS_24V[i] == "1")
                    {
                        STA_REASON.Add("媽媽出院");
                    }
                    if (i == 2 && END_RS_24V[i] == "1")
                    {
                        STA_REASON.Add("新生兒洗澡");
                    }
                    if (i == 3 && END_RS_24V[i] == "1")
                    {
                        STA_REASON.Add("新生兒檢查");
                    }
                }
            }
            else
                insertDataList.Add(new DBItem("END_RS_24", null, DBItem.DBDataType.String));

            if (END_STA == "1" || END_STA == "2")
            {
                STA = END_STA == "1" ? "親子同室12HR" : "未親子同室";

                var END_RS_C = form["CK_END_RS_C"];
                var END_RS_CV = new List<string>() { "0", "0", "0" };
                if (END_RS_C == null)
                {
                    json_result.status = RESPONSE_STATUS.ERROR;
                    json_result.message = END_STA == "1" ? "親子同室12HR原因未填寫!" : "未親子同室原因未填寫!";
                    return Content(JsonConvert.SerializeObject(json_result), "application/json");
                }
                else
                {
                    var END_RS_C_SP = END_RS_C.Split(',');
                    foreach (var i in END_RS_C_SP)
                        END_RS_CV[Convert.ToInt32(i)] = "1";
                    insertDataList.Add(new DBItem("END_RS_C", String.Join("", END_RS_CV), DBItem.DBDataType.String));
                }

                //結束原因-產婦
                if (END_RS_CV[0] == "1")
                {
                    var END_RS_P = form["CK_END_RS_P"];
                    var END_RS_PV = new List<string>() {
                        "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",
                        "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"
                    };
                    if (END_RS_P == null)
                    {
                        json_result.status = RESPONSE_STATUS.ERROR;
                        json_result.message = "結束原因-產婦未填寫!";
                        return Content(JsonConvert.SerializeObject(json_result), "application/json");
                    }
                    else
                    {
                        var END_RS_P_SP = END_RS_P.Split(',');
                        foreach (var i in END_RS_P_SP)
                            END_RS_PV[Convert.ToInt32(i)] = "1";
                        insertDataList.Add(new DBItem("END_RS_P", String.Join("", END_RS_PV), DBItem.DBDataType.String));

                        if (END_RS_PV[22] == "1")
                            insertDataList.Add(new DBItem("END_RS_P_OTH", form["TXT_END_RS_P_OTH"], DBItem.DBDataType.String));
                        else
                            insertDataList.Add(new DBItem("END_RS_P_OTH", null, DBItem.DBDataType.String));
                    }

                    for (var i = 0; i < END_RS_PV.Count; i++)
                    {
                        if (i == 0 && END_RS_PV[i] == "1")
                        {
                            STA_REASON.Add("媽媽想休息");
                        }
                        if (i == 1 && END_RS_PV[i] == "1")
                        {
                            STA_REASON.Add("媽媽沒有乳汁分泌");
                        }
                        if (i == 2 && END_RS_PV[i] == "1")
                        {
                            STA_REASON.Add("媽媽身體不適");
                        }
                        if (i == 3 && END_RS_PV[i] == "1")
                        {
                            STA_REASON.Add("擔心睡著後新生兒被抱走");
                        }

                        if (i == 4 && END_RS_PV[i] == "1")
                        {
                            STA_REASON.Add("怕嬰兒太吵");
                        }
                        if (i == 5 && END_RS_PV[i] == "1")
                        {
                            STA_REASON.Add("媽媽出院");
                        }
                        if (i == 6 && END_RS_PV[i] == "1")
                        {
                            STA_REASON.Add("媽媽自退奶");
                        }
                        if (i == 7 && END_RS_PV[i] == "1")
                        {
                            STA_REASON.Add("媽媽產後發燒");
                        }
                        if (i == 8 && END_RS_PV[i] == "1")
                        {
                            STA_REASON.Add("媽媽待產發燒");
                        }
                        if (i == 9 && END_RS_PV[i] == "1")
                        {
                            STA_REASON.Add("媽媽服用不宜餵母乳之藥物");
                        }
                        if (i == 10 && END_RS_PV[i] == "1")
                        {
                            STA_REASON.Add("擔心新生兒被感染");
                        }
                        if (i == 11 && END_RS_PV[i] == "1")
                        {
                            STA_REASON.Add("媽媽GBS(+)，抗生素未打滿4小時/未打抗生素");
                        }
                        if (i == 12 && END_RS_PV[i] == "1")
                        {
                            STA_REASON.Add("媽媽/同住家人(小孩)感冒");
                        }
                        if (i == 13 && END_RS_PV[i] == "1")
                        {
                            STA_REASON.Add("媽媽住9樓");
                        }
                        if (i == 14 && END_RS_PV[i] == "1")
                        {
                            STA_REASON.Add("媽媽破水大於24小時");
                        }
                        if (i == 15 && END_RS_PV[i] == "1")
                        {
                            STA_REASON.Add("媽媽PPH");
                        }
                        if (i == 16 && END_RS_PV[i] == "1")
                        {
                            STA_REASON.Add("媽媽PIH");
                        }
                        if (i == 17 && END_RS_PV[i] == "1")
                        {
                            STA_REASON.Add("多胞胎無法同時兼顧");
                        }
                        if (i == 18 && END_RS_PV[i] == "1")
                        {
                            STA_REASON.Add("有其他小孩要顧");
                        }
                        if (i == 19 && END_RS_PV[i] == "1")
                        {
                            STA_REASON.Add("請假(外出)");
                        }
                        if (i == 20 && END_RS_PV[i] == "1")
                        {
                            STA_REASON.Add("訪客多");
                        }
                        if (i == 21 && END_RS_PV[i] == "1")
                        {
                            STA_REASON.Add("拒絕");
                        }
                        if (i == 22 && END_RS_PV[i] == "1")
                        {
                            var d = "其他";
                            if (form["TXT_END_RS_P_OTH"] != "")
                            {
                                d += "-" + form["TXT_END_RS_P_OTH"].ToString();
                            }
                            STA_REASON.Add(d);
                        }
                    }
                }
                else
                    insertDataList.Add(new DBItem("END_RS_P", null, DBItem.DBDataType.String));
                //結束原因-新生兒
                if (END_RS_CV[1] == "1")
                {
                    var END_RS_NB = form["CK_END_RS_NB"];
                    var END_RS_NBV = new List<string>() { "0", "0", "0", "0", "0", "0", "0", "0" };
                    if (END_RS_NB == null)
                    {
                        json_result.status = RESPONSE_STATUS.ERROR;
                        json_result.message = "結束原因-新生兒未填寫!";
                        return Content(JsonConvert.SerializeObject(json_result), "application/json");
                    }
                    else
                    {
                        var END_RS_NB_SP = END_RS_NB.Split(',');
                        foreach (var i in END_RS_NB_SP)
                            END_RS_NBV[Convert.ToInt32(i)] = "1";
                        insertDataList.Add(new DBItem("END_RS_NB", String.Join("", END_RS_NBV), DBItem.DBDataType.String));

                        if (END_RS_NBV[4] == "1")
                            insertDataList.Add(new DBItem("END_RS_NB_S", form["TXT_END_RS_NB_S"], DBItem.DBDataType.String));
                        else
                            insertDataList.Add(new DBItem("END_RS_NB_S", null, DBItem.DBDataType.String));

                        if (END_RS_NBV[6] == "1")
                            insertDataList.Add(new DBItem("END_RS_NB_PICU", form["TXT_END_RS_NB_PICU"], DBItem.DBDataType.String));
                        else
                            insertDataList.Add(new DBItem("END_RS_NB_PICU", null, DBItem.DBDataType.String));

                        if (END_RS_NBV[7] == "1")
                            insertDataList.Add(new DBItem("END_RS_NB_NBC", form["TXT_END_RS_NB_NBC"], DBItem.DBDataType.String));
                        else
                            insertDataList.Add(new DBItem("END_RS_NB_NBC", null, DBItem.DBDataType.String));
                    }

                    for (var i = 0; i < END_RS_NBV.Count; i++)
                    {
                        if (i == 0 && END_RS_NBV[i] == "1")
                        {
                            STA_REASON.Add("新生兒體溫不穩");
                        }
                        if (i == 1 && END_RS_NBV[i] == "1")
                        {
                            STA_REASON.Add("新生兒洗澡");
                        }
                        if (i == 2 && END_RS_NBV[i] == "1")
                        {
                            STA_REASON.Add("新生兒檢查");
                        }
                        if (i == 3 && END_RS_NBV[i] == "1")
                        {
                            STA_REASON.Add("新生兒一直哭泣");
                        }

                        if (i == 4 && END_RS_NBV[i] == "1")
                        {
                            var d = "新生兒自身問題";
                            if (form["TXT_END_RS_NB_S"] != "")
                            {
                                d += "-" + form["TXT_END_RS_NB_S"].ToString();
                            }
                            STA_REASON.Add(d);
                        }
                        if (i == 5 && END_RS_NBV[i] == "1")
                        {
                            STA_REASON.Add("新生兒預計出院");
                        }
                        if (i == 6 && END_RS_NBV[i] == "1")
                        {
                            var d = "入PICU";
                            if (form["TXT_END_RS_NB_PICU"] != "")
                            {
                                d += "-" + form["TXT_END_RS_NB_PICU"].ToString();
                            }
                            STA_REASON.Add(d);
                        }
                        if (i == 7 && END_RS_NBV[i] == "1")
                        {
                            var d = "入NBC";
                            if (form["TXT_END_RS_NB_NBC"] != "")
                            {
                                d += "-" + form["TXT_END_RS_NB_NBC"].ToString();
                            }
                            STA_REASON.Add(d);
                        }
                    }
                }
                else
                {
                    insertDataList.Add(new DBItem("END_RS_NB_S", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("END_RS_NB", null, DBItem.DBDataType.String));
                }
                //結束原因-其他
                if (END_RS_CV[2] == "1")
                {
                    var END_RS_OTH = form["CK_END_RS_OTH"];
                    var END_RS_OTHV = new List<string>() { "0", "0", "0", "0", "0" };
                    if (END_RS_OTH == null)
                    {
                        json_result.status = RESPONSE_STATUS.ERROR;
                        json_result.message = "結束原因-其他未填寫!";
                        return Content(JsonConvert.SerializeObject(json_result), "application/json");
                    }
                    else
                    {
                        var END_RS_OTH_SP = END_RS_OTH.Split(',');
                        foreach (var i in END_RS_OTH_SP)
                            END_RS_OTHV[Convert.ToInt32(i)] = "1";
                        insertDataList.Add(new DBItem("END_RS_OTH", String.Join("", END_RS_OTHV), DBItem.DBDataType.String));

                        if (END_RS_OTHV[4] == "1")
                        {
                            if (!IsNoEmpty(form["TXT_OTH_RS"]))
                            {
                                json_result.status = RESPONSE_STATUS.ERROR;
                                json_result.message = "結束原因-其他-其他未填寫!";
                                return Content(JsonConvert.SerializeObject(json_result), "application/json");
                            }
                            insertDataList.Add(new DBItem("OTH_RS", form["TXT_OTH_RS"], DBItem.DBDataType.String));
                        }
                        else
                            insertDataList.Add(new DBItem("OTH_RS", null, DBItem.DBDataType.String));
                    }

                    for (var i = 0; i < END_RS_OTHV.Count; i++)
                    {
                        if (i == 0 && END_RS_OTHV[i] == "1")
                        {
                            STA_REASON.Add("病房太冷");
                        }
                        if (i == 1 && END_RS_OTHV[i] == "1")
                        {
                            STA_REASON.Add("病房環境太吵");
                        }
                        if (i == 2 && END_RS_OTHV[i] == "1")
                        {
                            STA_REASON.Add("病房打蠟");
                        }
                        if (i == 3 && END_RS_OTHV[i] == "1")
                        {
                            STA_REASON.Add("其他家人干預");
                        }

                        if (i == 4 && END_RS_OTHV[i] == "1")
                        {
                            var d = "其他";
                            if (form["TXT_OTH_RS"] != "")
                            {
                                d += "-" + form["TXT_OTH_RS"].ToString();
                            }
                            STA_REASON.Add(d);
                        }
                    }
                }
                else
                {
                    insertDataList.Add(new DBItem("END_RS_OTH", null, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("OTH_RS", null, DBItem.DBDataType.String));
                }
            }
            else
            {
                insertDataList.Add(new DBItem("END_RS_P", null, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("END_RS_NB", null, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("END_RS_NB_S", null, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("END_RS_OTH", null, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("OTH_RS", null, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("END_RS_C", null, DBItem.DBDataType.String));
            }
            insertDataList = setNullToEmpty(insertDataList);
            int erow = obs_m.DBExecInsert("OBS_ROOMIN", insertDataList);

            if (form["TXT_START_TIME_DAY"].ToString() == form["TXT_END_TIME_DAY"].ToString() && form["TXT_START_TIME_TIME"].ToString() == form["TXT_END_TIME_TIME"].ToString())
            {
                if (IsNoEmpty(form["TXT_END_TIME_DAY"]) && IsNoEmpty(form["TXT_END_TIME_TIME"]))
                {
                    base.Insert_CareRecord(form["TXT_END_TIME_DAY"] + " " + form["TXT_END_TIME_TIME"], id + "END", "親子同室-結束", $"{STA}{(EXCLUDE == "" ? "" : $"，因{EXCLUDE}")}{(STA_REASON.Count() == 0 ? "" : $"，原因{String.Join(",", STA_REASON)}")}。", "", "", "", "", "OBS_ROOMIN");
                }
            }
            else
            {
                base.Insert_CareRecord(form["TXT_START_TIME_DAY"] + " " + form["TXT_START_TIME_TIME"], id + "START", "親子同室-新增", "開始親子同室。", "", "", "", "", "OBS_ROOMIN");
                if (IsNoEmpty(form["TXT_END_TIME_DAY"]) && IsNoEmpty(form["TXT_END_TIME_TIME"]))
                {
                    base.Insert_CareRecord(form["TXT_END_TIME_DAY"] + " " + form["TXT_END_TIME_TIME"], id + "END", "親子同室-結束", $"{STA}{(EXCLUDE == "" ? "" : $"，因{EXCLUDE}")}{(STA_REASON.Count() == 0 ? "" : $"，原因{String.Join(",", STA_REASON)}")}。", "", "", "", "", "OBS_ROOMIN");
                }
            }

            if (ptinfo.Age < 1)
            {
                if (form["TXT_START_TIME_DAY"].ToString() == form["TXT_END_TIME_DAY"].ToString() && form["TXT_START_TIME_TIME"].ToString() == form["TXT_END_TIME_TIME"].ToString())
                {
                    if (IsNoEmpty(form["TXT_END_TIME_DAY"]) && IsNoEmpty(form["TXT_END_TIME_TIME"]))
                    {
                        Insert_CareRecord_ForOtherTns(momfeeno, form["TXT_END_TIME_DAY"] + " " + form["TXT_END_TIME_TIME"], id + "END", "親子同室-結束", $"{STA}{(EXCLUDE == "" ? "" : $"，因{EXCLUDE}")}{(STA_REASON.Count() == 0 ? "" : $"，原因{String.Join(",", STA_REASON)}")}。", "", "", "", "", "OBS_ROOMIN", ref link);
                    }
                }
                else
                {
                    Insert_CareRecord_ForOtherTns(momfeeno, form["TXT_START_TIME_DAY"] + " " + form["TXT_START_TIME_TIME"], id + "START", "親子同室-新增", "開始親子同室。", "", "", "", "", "OBS_ROOMIN", ref link);
                    if (IsNoEmpty(form["TXT_END_TIME_DAY"]) && IsNoEmpty(form["TXT_END_TIME_TIME"]))
                    {
                        Insert_CareRecord_ForOtherTns(momfeeno, form["TXT_END_TIME_DAY"] + " " + form["TXT_END_TIME_TIME"], id + "END", "親子同室-結束", $"{STA}{(EXCLUDE == "" ? "" : $"，因{EXCLUDE}")}{(STA_REASON.Count() == 0 ? "" : $"，原因{String.Join(",", STA_REASON)}")}。", "", "", "", "", "OBS_ROOMIN", ref link);
                    }
                }
            }
            else
            {
                if (form["TXT_START_TIME_DAY"].ToString() == form["TXT_END_TIME_DAY"].ToString() && form["TXT_START_TIME_TIME"].ToString() == form["TXT_END_TIME_TIME"].ToString())
                {
                    if (IsNoEmpty(form["TXT_END_TIME_DAY"]) && IsNoEmpty(form["TXT_END_TIME_TIME"]))
                    {
                        Insert_CareRecord_ForOtherTns(NBFeeno, form["TXT_END_TIME_DAY"] + " " + form["TXT_END_TIME_TIME"], id + "END", "親子同室-結束", $"{STA}{(EXCLUDE == "" ? "" : $"，因{EXCLUDE}")}{(STA_REASON.Count() == 0 ? "" : $"，原因{String.Join(",", STA_REASON)}")}。", "", "", "", "", "OBS_ROOMIN", ref link);
                    }
                }
                else
                {
                    Insert_CareRecord_ForOtherTns(NBFeeno, form["TXT_START_TIME_DAY"] + " " + form["TXT_START_TIME_TIME"], id + "START", "親子同室-新增", "開始親子同室。", "", "", "", "", "OBS_ROOMIN", ref link);
                }
            }

            if (erow > 0)
            {
                json_result.status = RESPONSE_STATUS.SUCCESS;
                json_result.message = "新增成功";
            }
            else
            {
                json_result.status = RESPONSE_STATUS.ERROR;
                json_result.message = "新增失敗";
            }
            return Content(JsonConvert.SerializeObject(json_result), "application/json");
        }
        #endregion

        #region 母嬰同室編輯
        /// <summary>
        /// 母嬰同室編輯
        /// </summary>
        /// <param name="form"></param>
        /// <returns></returns>
        [HttpPost]
        public ActionResult Upd_Roomin(FormCollection form)
        {
            RESPONSE_MSG json_result = new RESPONSE_MSG();

            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo.FeeNo;
            string[] id_list = form["IID"].Split(',');
            List<DBItem> insertDataList = new List<DBItem>();
            int erow = 0;
            for (int v = 0; v < id_list.Length; v++)
            {
                insertDataList.Add(new DBItem("UPDNO", userno, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("UPDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime));
                insertDataList.Add(new DBItem("RECORDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間

                var EXCLUDE = "";
                insertDataList.Add(new DBItem("EXCLUDE", form["RB_EXCLUDE" + id_list[v]], DBItem.DBDataType.String));
                if (form["RB_EXCLUDE" + id_list[v]] == "1")
                {
                    if (!IsNoEmpty(form["RB_EXC_R" + id_list[v]]))
                    {
                        json_result.status = RESPONSE_STATUS.ERROR;
                        json_result.message = "排除親子同室原因未填寫!";
                        return Content(JsonConvert.SerializeObject(json_result), "application/json");
                    }

                    insertDataList.Add(new DBItem("EXC_R", form["RB_EXC_R" + id_list[v]], DBItem.DBDataType.String));
                    if (form["RB_EXC_R" + id_list[v]] == "4")
                    {
                        if (!IsNoEmpty(form["TXT_EXC_MOM_R" + id_list[v]]))
                        {
                            json_result.status = RESPONSE_STATUS.ERROR;
                            json_result.message = "排除親子同室原因-母親因素未填寫!";
                            return Content(JsonConvert.SerializeObject(json_result), "application/json");
                        }
                        insertDataList.Add(new DBItem("EXC_MOM_R", form["TXT_EXC_MOM_R" + id_list[v]], DBItem.DBDataType.String));
                    }

                    if (form["RB_EXCLUDE" + id_list[v]] == "0")
                    {
                        EXCLUDE = "新生兒入PICU";
                    }
                    if (form["RB_EXCLUDE" + id_list[v]] == "1")
                    {
                        EXCLUDE = "新生兒入NBC";
                    }
                    if (form["RB_EXCLUDE" + id_list[v]] == "2")
                    {
                        EXCLUDE = "新生兒轉院";
                    }
                    if (form["RB_EXCLUDE" + id_list[v]] == "3")
                    {
                        EXCLUDE = "新生兒死亡";
                    }
                    if (form["RB_EXCLUDE" + id_list[v]] == "4")
                    {
                        EXCLUDE = "母親因素";
                        if (IsNoEmpty(form["TXT_EXC_MOM_R" + id_list[v]]))
                        {
                            EXCLUDE += $"-{form["TXT_EXC_MOM_R" + id_list[v]]}";
                        }
                    }
                }

                if (IsNoEmpty(form["TXT_START_TIME_DAY" + id_list[v]]) && IsNoEmpty(form["TXT_START_TIME_TIME" + id_list[v]]))
                    insertDataList.Add(new DBItem("START_TIME", form["TXT_START_TIME_DAY" + id_list[v]] + " " + form["TXT_START_TIME_TIME" + id_list[v]], DBItem.DBDataType.DataTime));

                var PAT_FEENO = form["TXT_PAT_FEENO" + id_list[v]];
                var NB_CHARTNO = form["TXT_NB_CHARTNO" + id_list[v]];
                var SEQ_OF_NB = form["SEQ_OF_NB"];

                var NBFeeno = "";
                var momfeeno = "";

                DataTable dt_babylink = obs_m.sel_nbcha("", NB_CHARTNO);
                if (dt_babylink == null || dt_babylink.Rows.Count == 0) { }
                else
                {
                    NBFeeno = dt_babylink.Rows[0]["BABY_FEE_NO"].ToString();
                    momfeeno = dt_babylink.Rows[0]["MOM_FEE_NO"].ToString();
                }

                if (form["TXT_END_TIME_DAY" + id_list[v]] != "" && form["TXT_END_TIME_DAY" + id_list[v]] != null && form["TXT_END_TIME_TIME" + id_list[v]] != "" && form["TXT_END_TIME_TIME" + id_list[v]] != null)
                    insertDataList.Add(new DBItem("END_TIME", form["TXT_END_TIME_DAY" + id_list[v]] + " " + form["TXT_END_TIME_TIME" + id_list[v]], DBItem.DBDataType.DataTime));

                var NB_CHARTNO_E = form["TXT_NB_CHARTNO_E" + id_list[v]];
                if (IsNoEmpty(NB_CHARTNO_E))
                {
                    if (NB_CHARTNO_E.ToString().Trim() != NB_CHARTNO)
                    {
                        json_result.status = RESPONSE_STATUS.ERROR;
                        json_result.message = "新生兒病歷號開始與結束不相同!";
                        return Content(JsonConvert.SerializeObject(json_result), "application/json");
                    }
                    insertDataList.Add(new DBItem("NB_CHARTNO_E", NB_CHARTNO_E, DBItem.DBDataType.String));
                }
                else
                {
                    if (IsNoEmpty(form["TXT_END_TIME_DAY" + id_list[v]]) && IsNoEmpty(form["TXT_END_TIME_TIME" + id_list[v]]))
                    {
                        json_result.status = RESPONSE_STATUS.ERROR;
                        json_result.message = "新生兒病歷號結束未填寫!";
                        return Content(JsonConvert.SerializeObject(json_result), "application/json");
                    }
                }

                if (IsNoEmpty(form["TXT_START_TIME_DAY" + id_list[v]]) && IsNoEmpty(form["TXT_START_TIME_TIME" + id_list[v]]) &&
                IsNoEmpty(form["TXT_END_TIME_DAY" + id_list[v]]) && IsNoEmpty(form["TXT_END_TIME_TIME" + id_list[v]]))
                {
                    var s_time = Convert.ToDateTime(form["TXT_START_TIME_DAY" + id_list[v]] + " " + form["TXT_START_TIME_TIME" + id_list[v]]);
                    var e_time = Convert.ToDateTime(form["TXT_END_TIME_DAY" + id_list[v]] + " " + form["TXT_END_TIME_TIME" + id_list[v]]);

                    var timediff = e_time - s_time;
                    if (timediff.TotalSeconds < 0)
                    {
                        json_result.status = RESPONSE_STATUS.ERROR;
                        json_result.message = "開始時間不得大於結束時間";
                        return Content(JsonConvert.SerializeObject(json_result), "application/json");
                    }

                    var duplicateSql = $@"SELECT * FROM OBS_ROOMIN WHERE 0 = 0 AND (PAT_FEENO = '{PAT_FEENO}' or NB_CHARTNO = '{NB_CHARTNO}' or NB_CHARTNO_E = '{NB_CHARTNO}') 
 AND SEQ_OF_NB = '{SEQ_OF_NB}' 
                    AND DELETED IS NULL AND IID != '{id_list[v]}' 
AND (
START_TIME BETWEEN TO_DATE('{s_time.ToString("yyyy/MM/dd HH:mm")}', 'YYYY/MM/DD HH24:MI') AND TO_DATE('{e_time.ToString("yyyy/MM/dd HH:mm")}', 'YYYY/MM/DD HH24:MI')
OR 
END_TIME BETWEEN TO_DATE('{s_time.ToString("yyyy/MM/dd HH:mm")}', 'YYYY/MM/DD HH24:MI') AND TO_DATE('{e_time.ToString("yyyy/MM/dd HH:mm")}', 'YYYY/MM/DD HH24:MI')
OR
TO_DATE('{s_time.ToString("yyyy/MM/dd HH:mm")}', 'YYYY/MM/DD HH24:MI') BETWEEN START_TIME AND END_TIME
OR
TO_DATE('{e_time.ToString("yyyy/MM/dd HH:mm")}', 'YYYY/MM/DD HH24:MI') BETWEEN START_TIME AND END_TIME
) ORDER BY START_TIME DESC";

                    DataTable duplicate = obs_m.DBExecSQL(duplicateSql);
                    if (duplicate != null && duplicate.Rows.Count > 0)
                    {
                        json_result.status = RESPONSE_STATUS.ERROR;
                        json_result.message = "時間重疊，請確認資料!";
                        return Content(JsonConvert.SerializeObject(json_result), "application/json");
                    }
                }
                else
                {
                    if (IsNoEmpty(form["TXT_START_TIME_DAY" + id_list[v]]) && IsNoEmpty(form["TXT_START_TIME_TIME" + id_list[v]]))
                    {
                        var s_time = Convert.ToDateTime(form["TXT_START_TIME_DAY" + id_list[v]] + " " + form["TXT_START_TIME_TIME" + id_list[v]]);
                        var duplicateSql = $@"SELECT * FROM OBS_ROOMIN WHERE 0 = 0 AND (PAT_FEENO = '{PAT_FEENO}' or NB_CHARTNO = '{NB_CHARTNO}' or NB_CHARTNO_E = '{NB_CHARTNO}') 
                    AND SEQ_OF_NB = '{SEQ_OF_NB}' AND IID != '{id_list[v]}' 
                    AND DELETED IS NULL AND TO_DATE('{s_time.ToString("yyyy/MM/dd HH:mm")}', 'YYYY/MM/DD HH24:MI') <= END_TIME
                    ORDER BY START_TIME DESC";

                        DataTable duplicate = obs_m.DBExecSQL(duplicateSql);
                        if (duplicate != null && duplicate.Rows.Count > 0)
                        {
                            json_result.status = RESPONSE_STATUS.ERROR;
                            json_result.message = "必須大於最新一筆結束時間，請確認資料!";
                            return Content(JsonConvert.SerializeObject(json_result), "application/json");
                        }
                    }
                }

                if (form["TypeMode"] == "BarcodeClose")
                {
                    DataTable cnt = obs_m.sel_roomin("", "", PAT_FEENO, new List<string>() { NB_CHARTNO });
                    if (cnt != null && cnt.Rows.Count == 1)
                    {
                        insertDataList.Add(new DBItem("END_STA", "0", DBItem.DBDataType.String));
                        insertDataList.Add(new DBItem("END_RS_24", "1000", DBItem.DBDataType.String));

                        if (IsNoEmpty(form["TXT_END_TIME_DAY" + id_list[v]]) && IsNoEmpty(form["TXT_END_TIME_TIME" + id_list[v]]))
                        {
                            var careSql = $"SELECT * FROM CARERECORD_DATA where DELETED IS NULL AND CARERECORD_ID = '{id_list[v] + "END"}'";
                            DataTable care = obs_m.DBExecSQL(careSql);
                            if (care != null && care.Rows.Count > 0)
                            {
                                base.Upd_CareRecord(form["TXT_END_TIME_DAY" + id_list[v]] + " " + form["TXT_END_TIME_TIME" + id_list[v]], id_list[v] + "END", "親子同室-結束", "親子同室24HR-正常返室。", "", "", "", "", "OBS_ROOMIN");
                                if (ptinfo.Age < 1)
                                {
                                    Upd_CareRecord_ForOtherTns(momfeeno, form["TXT_END_TIME_DAY" + id_list[v]] + " " + form["TXT_END_TIME_TIME" + id_list[v]], id_list[v] + "END", "親子同室-結束", "親子同室24HR-正常返室。", "", "", "", "", "OBS_ROOMIN", ref link);
                                }
                                else
                                {
                                    Upd_CareRecord_ForOtherTns(NBFeeno, form["TXT_END_TIME_DAY" + id_list[v]] + " " + form["TXT_END_TIME_TIME" + id_list[v]], id_list[v] + "END", "親子同室-結束", "親子同室24HR-正常返室。", "", "", "", "", "OBS_ROOMIN", ref link);
                                }
                            }
                            else
                            {
                                base.Insert_CareRecord(form["TXT_END_TIME_DAY" + id_list[v]] + " " + form["TXT_END_TIME_TIME" + id_list[v]], id_list[v] + "END", "親子同室-結束", "親子同室24HR-正常返室。", "", "", "", "", "OBS_ROOMIN");
                                if (ptinfo.Age < 1)
                                {
                                    Insert_CareRecord_ForOtherTns(momfeeno, form["TXT_END_TIME_DAY" + id_list[v]] + " " + form["TXT_END_TIME_TIME" + id_list[v]], id_list[v] + "END", "親子同室-結束", "親子同室24HR-正常返室。", "", "", "", "", "OBS_ROOMIN", ref link);
                                }
                                else
                                {
                                    Insert_CareRecord_ForOtherTns(NBFeeno, form["TXT_END_TIME_DAY" + id_list[v]] + " " + form["TXT_END_TIME_TIME" + id_list[v]], id_list[v] + "END", "親子同室-結束", "親子同室24HR-正常返室。", "", "", "", "", "OBS_ROOMIN", ref link);
                                }
                            }
                        }
                    }
                    else
                    {
                        var s_time = Convert.ToDateTime(form["TXT_START_TIME_DAY" + id_list[v]] + " " + form["TXT_START_TIME_TIME" + id_list[v]]);
                        var e_time = Convert.ToDateTime(form["TXT_END_TIME_DAY" + id_list[v]] + " " + form["TXT_END_TIME_TIME" + id_list[v]]);
                        var timediff = e_time - s_time;
                        if (timediff.TotalHours > 23)
                        {
                            insertDataList.Add(new DBItem("END_STA", "0", DBItem.DBDataType.String));
                            insertDataList.Add(new DBItem("END_RS_24", "1000", DBItem.DBDataType.String));
                        }
                        else
                        {
                            var STA = "";
                            if (timediff.TotalHours >= 12 && timediff.TotalHours <= 23)
                            {
                                STA = "親子同室12HR";
                                insertDataList.Add(new DBItem("END_STA", "1", DBItem.DBDataType.String));
                            }
                            else
                            {
                                STA = "未親子同室";
                                insertDataList.Add(new DBItem("END_STA", "2", DBItem.DBDataType.String));
                            }
                            insertDataList.Add(new DBItem("END_RS_C", "100", DBItem.DBDataType.String));
                            insertDataList.Add(new DBItem("END_RS_P", "10000000000", DBItem.DBDataType.String));

                            if (IsNoEmpty(form["TXT_END_TIME_DAY" + id_list[v]]) && IsNoEmpty(form["TXT_END_TIME_TIME" + id_list[v]]))
                            {
                                var careSql = $"SELECT * FROM CARERECORD_DATA where DELETED IS NULL AND CARERECORD_ID = '{id_list[v] + "END"}'";
                                DataTable care = obs_m.DBExecSQL(careSql);
                                if (care != null && care.Rows.Count > 0)
                                {
                                    base.Upd_CareRecord(form["TXT_END_TIME_DAY" + id_list[v]] + " " + form["TXT_END_TIME_TIME" + id_list[v]], id_list[v] + "END", "親子同室-結束", $"{STA}{(EXCLUDE == "" ? "" : $"，因{EXCLUDE}")}，原因媽媽想休息。", "", "", "", "", "OBS_ROOMIN");
                                    if (ptinfo.Age < 1)
                                    {
                                        Upd_CareRecord_ForOtherTns(momfeeno, form["TXT_END_TIME_DAY" + id_list[v]] + " " + form["TXT_END_TIME_TIME" + id_list[v]], id_list[v] + "END", "親子同室-結束", $"{STA}{(EXCLUDE == "" ? "" : $"，因{EXCLUDE}")}，原因媽媽想休息。", "", "", "", "", "OBS_ROOMIN", ref link);
                                    }
                                    else
                                    {
                                        Upd_CareRecord_ForOtherTns(NBFeeno, form["TXT_END_TIME_DAY" + id_list[v]] + " " + form["TXT_END_TIME_TIME" + id_list[v]], id_list[v] + "END", "親子同室-結束", $"{STA}{(EXCLUDE == "" ? "" : $"，因{EXCLUDE}")}，原因媽媽想休息。", "", "", "", "", "OBS_ROOMIN", ref link);
                                    }
                                }
                                else
                                {
                                    base.Insert_CareRecord(form["TXT_END_TIME_DAY" + id_list[v]] + " " + form["TXT_END_TIME_TIME" + id_list[v]], id_list[v] + "END", "親子同室-結束", $"{STA}{(EXCLUDE == "" ? "" : $"，因{EXCLUDE}")}，原因媽媽想休息。", "", "", "", "", "OBS_ROOMIN");

                                    if (ptinfo.Age < 1)
                                    {
                                        Insert_CareRecord_ForOtherTns(momfeeno, form["TXT_END_TIME_DAY" + id_list[v]] + " " + form["TXT_END_TIME_TIME" + id_list[v]], id_list[v] + "END", "親子同室-結束", $"{STA}{(EXCLUDE == "" ? "" : $"，因{EXCLUDE}")}，原因媽媽想休息。", "", "", "", "", "OBS_ROOMIN", ref link);
                                    }
                                    else
                                    {
                                        Insert_CareRecord_ForOtherTns(NBFeeno, form["TXT_END_TIME_DAY" + id_list[v]] + " " + form["TXT_END_TIME_TIME" + id_list[v]], id_list[v] + "END", "親子同室-結束", $"{STA}{(EXCLUDE == "" ? "" : $"，因{EXCLUDE}")}，原因媽媽想休息。", "", "", "", "", "OBS_ROOMIN", ref link);
                                    }
                                }
                            }
                        }
                    }
                }
                else
                {
                    var STA = "";
                    var STA_REASON = new List<string>();

                    //DataTable cnt = obs_m.sel_roomin("", "", PAT_FEENO, new List<string>() { NB_CHARTNO });
                    //if (cnt != null && cnt.Rows.Count == 1)
                    //{
                    //    insertDataList.Add(new DBItem("END_STA", "0", DBItem.DBDataType.String));
                    //    insertDataList.Add(new DBItem("END_RS_24", "1000", DBItem.DBDataType.String));
                    //}
                    //else
                    //{
                    var END_STA = form["RB_END_STA" + id_list[v]];
                    if (!IsNoEmpty(END_STA))
                    {
                        if (IsNoEmpty(form["TXT_END_TIME_DAY" + id_list[v]]) && IsNoEmpty(form["TXT_END_TIME_TIME" + id_list[v]]))
                        {
                            json_result.status = RESPONSE_STATUS.ERROR;
                            json_result.message = "結束原因未填寫!";
                            return Content(JsonConvert.SerializeObject(json_result), "application/json");
                        }
                    }
                    insertDataList.Add(new DBItem("END_STA", END_STA, DBItem.DBDataType.String));
                    if (END_STA == "0")
                    {
                        STA = "親子同室24HR";

                        var END_RS_24 = form["CK_END_RS_24" + id_list[v]];
                        var END_RS_24V = new List<string>() { "0", "0", "0", "0" };
                        if (END_RS_24 == null)
                        {
                            json_result.status = RESPONSE_STATUS.ERROR;
                            json_result.message = "親子同室24HR原因未填寫!";
                            return Content(JsonConvert.SerializeObject(json_result), "application/json");
                        }
                        else
                        {
                            var END_RS_24_SP = END_RS_24.Split(',');
                            foreach (var i in END_RS_24_SP)
                                END_RS_24V[Convert.ToInt32(i)] = "1";
                            insertDataList.Add(new DBItem("END_RS_24", String.Join("", END_RS_24V), DBItem.DBDataType.String));
                        }

                        for (var i = 0; i < END_RS_24V.Count; i++)
                        {
                            if (i == 0 && END_RS_24V[i] == "1")
                            {
                                STA_REASON.Add("正常返室");
                            }
                            if (i == 1 && END_RS_24V[i] == "1")
                            {
                                STA_REASON.Add("媽媽出院");
                            }
                            if (i == 2 && END_RS_24V[i] == "1")
                            {
                                STA_REASON.Add("新生兒洗澡");
                            }
                            if (i == 3 && END_RS_24V[i] == "1")
                            {
                                STA_REASON.Add("新生兒檢查");
                            }
                        }
                    }
                    else
                        insertDataList.Add(new DBItem("END_RS_24", null, DBItem.DBDataType.String));
                    if (END_STA == "1" || END_STA == "2")
                    {
                        STA = END_STA == "1" ? "親子同室12HR" : "未親子同室";

                        var END_RS_C = form["CK_END_RS_C" + id_list[v]];
                        var END_RS_CV = new List<string>() { "0", "0", "0" };
                        if (END_RS_C == null)
                        {
                            json_result.status = RESPONSE_STATUS.ERROR;
                            json_result.message = END_STA == "1" ? "親子同室12HR原因未填寫!" : "未親子同室原因未填寫!";
                            return Content(JsonConvert.SerializeObject(json_result), "application/json");
                        }
                        else
                        {
                            var END_RS_C_SP = END_RS_C.Split(',');
                            foreach (var i in END_RS_C_SP)
                                END_RS_CV[Convert.ToInt32(i)] = "1";
                            insertDataList.Add(new DBItem("END_RS_C", String.Join("", END_RS_CV), DBItem.DBDataType.String));
                        }

                        //結束原因-產婦
                        if (END_RS_CV[0] == "1")
                        {
                            var END_RS_P = form["CK_END_RS_P" + id_list[v]];
                            var END_RS_PV = new List<string>() {
                                "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",
                                "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0"
                            };
                            if (END_RS_P == null)
                            {
                                json_result.status = RESPONSE_STATUS.ERROR;
                                json_result.message = "結束原因-產婦未填寫!";
                                return Content(JsonConvert.SerializeObject(json_result), "application/json");
                            }
                            else
                            {
                                var END_RS_P_SP = END_RS_P.Split(',');
                                foreach (var i in END_RS_P_SP)
                                    END_RS_PV[Convert.ToInt32(i)] = "1";
                                insertDataList.Add(new DBItem("END_RS_P", String.Join("", END_RS_PV), DBItem.DBDataType.String));

                                if (END_RS_PV[22] == "1")
                                    insertDataList.Add(new DBItem("END_RS_P_OTH", form["TXT_END_RS_P_OTH" + id_list[v]], DBItem.DBDataType.String));
                                else
                                    insertDataList.Add(new DBItem("END_RS_P_OTH", null, DBItem.DBDataType.String));
                            }

                            for (var i = 0; i < END_RS_PV.Count; i++)
                            {
                                if (i == 0 && END_RS_PV[i] == "1")
                                {
                                    STA_REASON.Add("媽媽想休息");
                                }
                                if (i == 1 && END_RS_PV[i] == "1")
                                {
                                    STA_REASON.Add("媽媽沒有乳汁分泌");
                                }
                                if (i == 2 && END_RS_PV[i] == "1")
                                {
                                    STA_REASON.Add("媽媽身體不適");
                                }
                                if (i == 3 && END_RS_PV[i] == "1")
                                {
                                    STA_REASON.Add("擔心睡著後新生兒被抱走");
                                }

                                if (i == 4 && END_RS_PV[i] == "1")
                                {
                                    STA_REASON.Add("怕嬰兒太吵");
                                }
                                if (i == 5 && END_RS_PV[i] == "1")
                                {
                                    STA_REASON.Add("媽媽出院");
                                }
                                if (i == 6 && END_RS_PV[i] == "1")
                                {
                                    STA_REASON.Add("媽媽自退奶");
                                }
                                if (i == 7 && END_RS_PV[i] == "1")
                                {
                                    STA_REASON.Add("媽媽產後發燒");
                                }
                                if (i == 8 && END_RS_PV[i] == "1")
                                {
                                    STA_REASON.Add("媽媽待產發燒");
                                }
                                if (i == 9 && END_RS_PV[i] == "1")
                                {
                                    STA_REASON.Add("媽媽服用不宜餵母乳之藥物");
                                }
                                if (i == 10 && END_RS_PV[i] == "1")
                                {
                                    STA_REASON.Add("擔心新生兒被感染");
                                }
                                if (i == 11 && END_RS_PV[i] == "1")
                                {
                                    STA_REASON.Add("媽媽GBS(+)，抗生素未打滿4小時/未打抗生素");
                                }
                                if (i == 12 && END_RS_PV[i] == "1")
                                {
                                    STA_REASON.Add("媽媽/同住家人(小孩)感冒");
                                }
                                if (i == 13 && END_RS_PV[i] == "1")
                                {
                                    STA_REASON.Add("媽媽住9樓");
                                }
                                if (i == 14 && END_RS_PV[i] == "1")
                                {
                                    STA_REASON.Add("媽媽破水大於24小時");
                                }
                                if (i == 15 && END_RS_PV[i] == "1")
                                {
                                    STA_REASON.Add("媽媽PPH");
                                }
                                if (i == 16 && END_RS_PV[i] == "1")
                                {
                                    STA_REASON.Add("媽媽PIH");
                                }
                                if (i == 17 && END_RS_PV[i] == "1")
                                {
                                    STA_REASON.Add("多胞胎無法同時兼顧");
                                }
                                if (i == 18 && END_RS_PV[i] == "1")
                                {
                                    STA_REASON.Add("有其他小孩要顧");
                                }
                                if (i == 19 && END_RS_PV[i] == "1")
                                {
                                    STA_REASON.Add("請假(外出)");
                                }
                                if (i == 20 && END_RS_PV[i] == "1")
                                {
                                    STA_REASON.Add("訪客多");
                                }
                                if (i == 21 && END_RS_PV[i] == "1")
                                {
                                    STA_REASON.Add("拒絕");
                                }
                                if (i == 22 && END_RS_PV[i] == "1")
                                {
                                    var d = "其他";
                                    if (form["TXT_END_RS_P_OTH"] != "")
                                    {
                                        d += "-" + form["TXT_END_RS_P_OTH" + id_list[v]].ToString();
                                    }
                                    STA_REASON.Add(d);
                                }
                            }
                        }
                        else
                            insertDataList.Add(new DBItem("END_RS_P", null, DBItem.DBDataType.String));
                        //結束原因-新生兒
                        if (END_RS_CV[1] == "1")
                        {
                            var END_RS_NB = form["CK_END_RS_NB" + id_list[v]];
                            var END_RS_NBV = new List<string>() { "0", "0", "0", "0", "0", "0", "0", "0" };
                            if (END_RS_NB == null)
                            {
                                json_result.status = RESPONSE_STATUS.ERROR;
                                json_result.message = "結束原因-新生兒未填寫!";
                                return Content(JsonConvert.SerializeObject(json_result), "application/json");
                            }
                            else
                            {
                                var END_RS_NB_SP = END_RS_NB.Split(',');
                                foreach (var i in END_RS_NB_SP)
                                    END_RS_NBV[Convert.ToInt32(i)] = "1";
                                insertDataList.Add(new DBItem("END_RS_NB", String.Join("", END_RS_NBV), DBItem.DBDataType.String));

                                if (END_RS_NBV[4] == "1")
                                    insertDataList.Add(new DBItem("END_RS_NB_S", form["TXT_END_RS_NB_S" + id_list[v]], DBItem.DBDataType.String));
                                else
                                    insertDataList.Add(new DBItem("END_RS_NB_S", null, DBItem.DBDataType.String));

                                if (END_RS_NBV[6] == "1")
                                    insertDataList.Add(new DBItem("END_RS_NB_PICU", form["TXT_END_RS_NB_PICU" + id_list[v]], DBItem.DBDataType.String));
                                else
                                    insertDataList.Add(new DBItem("END_RS_NB_PICU", null, DBItem.DBDataType.String));

                                if (END_RS_NBV[7] == "1")
                                    insertDataList.Add(new DBItem("END_RS_NB_NBC", form["TXT_END_RS_NB_NBC" + id_list[v]], DBItem.DBDataType.String));
                                else
                                    insertDataList.Add(new DBItem("END_RS_NB_NBC", null, DBItem.DBDataType.String));
                            }

                            for (var i = 0; i < END_RS_NBV.Count; i++)
                            {
                                if (i == 0 && END_RS_NBV[i] == "1")
                                {
                                    STA_REASON.Add("新生兒體溫不穩");
                                }
                                if (i == 1 && END_RS_NBV[i] == "1")
                                {
                                    STA_REASON.Add("新生兒洗澡");
                                }
                                if (i == 2 && END_RS_NBV[i] == "1")
                                {
                                    STA_REASON.Add("新生兒檢查");
                                }
                                if (i == 3 && END_RS_NBV[i] == "1")
                                {
                                    STA_REASON.Add("新生兒一直哭泣");
                                }

                                if (i == 4 && END_RS_NBV[i] == "1")
                                {
                                    var d = "新生兒自身問題";
                                    if (form["TXT_END_RS_NB_S" + id_list[v]] != "")
                                    {
                                        d += "-" + form["TXT_END_RS_NB_S" + id_list[v]].ToString();
                                    }
                                    STA_REASON.Add(d);
                                }
                                if (i == 5 && END_RS_NBV[i] == "1")
                                {
                                    STA_REASON.Add("新生兒預計出院");
                                }
                                if (i == 6 && END_RS_NBV[i] == "1")
                                {
                                    var d = "入PICU";
                                    if (form["TXT_END_RS_NB_PICU" + id_list[v]] != "")
                                    {
                                        d += "-" + form["TXT_END_RS_NB_PICU" + id_list[v]].ToString();
                                    }
                                    STA_REASON.Add(d);
                                }
                                if (i == 7 && END_RS_NBV[i] == "1")
                                {
                                    var d = "入NBC";
                                    if (form["TXT_END_RS_NB_NBC" + id_list[v]] != "")
                                    {
                                        d += "-" + form["TXT_END_RS_NB_NBC" + id_list[v]].ToString();
                                    }
                                    STA_REASON.Add(d);
                                }
                            }
                        }
                        else
                        {
                            insertDataList.Add(new DBItem("END_RS_NB_S", null, DBItem.DBDataType.String));
                            insertDataList.Add(new DBItem("END_RS_NB", null, DBItem.DBDataType.String));
                        }
                        //結束原因-其他
                        if (END_RS_CV[2] == "1")
                        {
                            var END_RS_OTH = form["CK_END_RS_OTH" + id_list[v]];
                            var END_RS_OTHV = new List<string>() { "0", "0", "0", "0", "0" };
                            if (END_RS_OTH == null)
                            {
                                json_result.status = RESPONSE_STATUS.ERROR;
                                json_result.message = "結束原因-其他未填寫!";
                                return Content(JsonConvert.SerializeObject(json_result), "application/json");
                            }
                            else
                            {
                                var END_RS_OTH_SP = END_RS_OTH.Split(',');
                                foreach (var i in END_RS_OTH_SP)
                                    END_RS_OTHV[Convert.ToInt32(i)] = "1";
                                insertDataList.Add(new DBItem("END_RS_OTH", String.Join("", END_RS_OTHV), DBItem.DBDataType.String));

                                if (END_RS_OTHV[4] == "1")
                                {
                                    if (!IsNoEmpty(form["TXT_OTH_RS" + id_list[v]]))
                                    {
                                        json_result.status = RESPONSE_STATUS.ERROR;
                                        json_result.message = "結束原因-其他-其他未填寫!";
                                        return Content(JsonConvert.SerializeObject(json_result), "application/json");
                                    }
                                    insertDataList.Add(new DBItem("OTH_RS", form["TXT_OTH_RS" + id_list[v]], DBItem.DBDataType.String));
                                }
                                else
                                    insertDataList.Add(new DBItem("OTH_RS", null, DBItem.DBDataType.String));


                                for (var i = 0; i < END_RS_OTHV.Count; i++)
                                {
                                    if (i == 0 && END_RS_OTHV[i] == "1")
                                    {
                                        STA_REASON.Add("病房太冷");
                                    }
                                    if (i == 1 && END_RS_OTHV[i] == "1")
                                    {
                                        STA_REASON.Add("病房環境太吵");
                                    }
                                    if (i == 2 && END_RS_OTHV[i] == "1")
                                    {
                                        STA_REASON.Add("病房打蠟");
                                    }
                                    if (i == 3 && END_RS_OTHV[i] == "1")
                                    {
                                        STA_REASON.Add("其他家人干預");
                                    }

                                    if (i == 4 && END_RS_OTHV[i] == "1")
                                    {
                                        var d = "其他";
                                        if (form["TXT_OTH_RS" + id_list[v]] != "")
                                        {
                                            d += "-" + form["TXT_OTH_RS" + id_list[v]].ToString();
                                        }
                                        STA_REASON.Add(d);
                                    }
                                }
                            }
                        }
                        else
                        {
                            insertDataList.Add(new DBItem("END_RS_OTH", null, DBItem.DBDataType.String));
                            insertDataList.Add(new DBItem("OTH_RS", null, DBItem.DBDataType.String));
                        }
                    }
                    else
                    {
                        insertDataList.Add(new DBItem("END_RS_P", null, DBItem.DBDataType.String));
                        insertDataList.Add(new DBItem("END_RS_NB", null, DBItem.DBDataType.String));
                        insertDataList.Add(new DBItem("END_RS_NB_S", null, DBItem.DBDataType.String));
                        insertDataList.Add(new DBItem("END_RS_OTH", null, DBItem.DBDataType.String));
                        insertDataList.Add(new DBItem("OTH_RS", null, DBItem.DBDataType.String));
                        insertDataList.Add(new DBItem("END_RS_C", null, DBItem.DBDataType.String));
                    }
                    // }

                    if (IsNoEmpty(form["TXT_END_TIME_DAY" + id_list[v]]) && IsNoEmpty(form["TXT_END_TIME_TIME" + id_list[v]]))
                    {
                        var careSql = $"SELECT * FROM CARERECORD_DATA where DELETED IS NULL AND CARERECORD_ID = '{id_list[v] + "END"}'";
                        DataTable care = obs_m.DBExecSQL(careSql);
                        if (care != null && care.Rows.Count > 0)
                        {
                            base.Upd_CareRecord(form["TXT_END_TIME_DAY" + id_list[v]] + " " + form["TXT_END_TIME_TIME" + id_list[v]], id_list[v] + "END", "親子同室-結束", $"{STA}{(EXCLUDE == "" ? "" : $"，因{EXCLUDE}")}{(STA_REASON.Count() == 0 ? "" : $"，原因{String.Join(",", STA_REASON)}")}。", "", "", "", "", "OBS_ROOMIN");
                            if (ptinfo.Age < 1)
                            {
                                Upd_CareRecord_ForOtherTns(momfeeno, form["TXT_END_TIME_DAY" + id_list[v]] + " " + form["TXT_END_TIME_TIME" + id_list[v]], id_list[v] + "END", "親子同室-結束", $"{STA}{(EXCLUDE == "" ? "" : $"，因{EXCLUDE}")}{(STA_REASON.Count() == 0 ? "" : $"，原因{String.Join(",", STA_REASON)}")}。", "", "", "", "", "OBS_ROOMIN", ref link);
                            }
                            else
                            {
                                Upd_CareRecord_ForOtherTns(NBFeeno, form["TXT_END_TIME_DAY" + id_list[v]] + " " + form["TXT_END_TIME_TIME" + id_list[v]], id_list[v] + "END", "親子同室-結束", $"{STA}{(EXCLUDE == "" ? "" : $"，因{EXCLUDE}")}{(STA_REASON.Count() == 0 ? "" : $"，原因{String.Join(",", STA_REASON)}")}。", "", "", "", "", "OBS_ROOMIN", ref link);
                            }
                        }
                        else
                        {
                            base.Insert_CareRecord(form["TXT_END_TIME_DAY" + id_list[v]] + " " + form["TXT_END_TIME_TIME" + id_list[v]], id_list[v] + "END", "親子同室-結束", $"{STA}{(EXCLUDE == "" ? "" : $"，因{EXCLUDE}")}{(STA_REASON.Count() == 0 ? "" : $"，原因{String.Join(",", STA_REASON)}")}。", "", "", "", "", "OBS_ROOMIN");
                            if (ptinfo.Age < 1)
                            {
                                Insert_CareRecord_ForOtherTns(momfeeno, form["TXT_END_TIME_DAY" + id_list[v]] + " " + form["TXT_END_TIME_TIME" + id_list[v]], id_list[v] + "END", "親子同室-結束", $"{STA}{(EXCLUDE == "" ? "" : $"，因{EXCLUDE}")}{(STA_REASON.Count() == 0 ? "" : $"，原因{String.Join(",", STA_REASON)}")}。", "", "", "", "", "OBS_ROOMIN", ref link);
                            }
                            else
                            {
                                Insert_CareRecord_ForOtherTns(NBFeeno, form["TXT_END_TIME_DAY" + id_list[v]] + " " + form["TXT_END_TIME_TIME" + id_list[v]], id_list[v] + "END", "親子同室-結束", $"{STA}{(EXCLUDE == "" ? "" : $"，因{EXCLUDE}")}{(STA_REASON.Count() == 0 ? "" : $"，原因{String.Join(",", STA_REASON)}")}。", "", "", "", "", "OBS_ROOMIN", ref link);
                            }
                        }
                    }
                }

                if (form["TXT_START_TIME_DAY" + id_list[v]].ToString() == form["TXT_END_TIME_DAY" + id_list[v]].ToString() && form["TXT_START_TIME_TIME" + id_list[v]].ToString() == form["TXT_END_TIME_TIME" + id_list[v]].ToString()) { }
                else
                {
                    base.Upd_CareRecord(form["TXT_START_TIME_DAY" + id_list[v]] + " " + form["TXT_START_TIME_TIME" + id_list[v]], id_list[v] + "START", "親子同室-開始", $"開始親子同室。", "", "", "", "", "OBS_ROOMIN");
                }
                if (ptinfo.Age < 1)
                {
                    if (form["TXT_START_TIME_DAY" + id_list[v]].ToString() == form["TXT_END_TIME_DAY" + id_list[v]].ToString() && form["TXT_START_TIME_TIME" + id_list[v]].ToString() == form["TXT_END_TIME_TIME" + id_list[v]].ToString()) { }
                    else
                    {
                        Upd_CareRecord_ForOtherTns(momfeeno, form["TXT_START_TIME_DAY" + id_list[v]] + " " + form["TXT_START_TIME_TIME" + id_list[v]], id_list[v] + "START", "親子同室-開始", $"開始親子同室。", "", "", "", "", "OBS_ROOMIN", ref link);
                    }
                }
                else
                {
                    if (form["TXT_START_TIME_DAY" + id_list[v]].ToString() == form["TXT_END_TIME_DAY" + id_list[v]].ToString() && form["TXT_START_TIME_TIME" + id_list[v]].ToString() == form["TXT_END_TIME_TIME" + id_list[v]].ToString()) { }
                    else
                    {
                        Upd_CareRecord_ForOtherTns(NBFeeno, form["TXT_START_TIME_DAY" + id_list[v]] + " " + form["TXT_START_TIME_TIME" + id_list[v]], id_list[v] + "START", "親子同室-開始", $"開始親子同室。", "", "", "", "", "OBS_ROOMIN", ref link);
                    }
                }

                string where = " IID = '" + id_list[v] + "' ";
                insertDataList = setNullToEmpty(insertDataList);
                erow += obs_m.DBExecUpdate("OBS_ROOMIN", insertDataList, where);
            }
            if (erow > 0)
            {
                json_result.status = RESPONSE_STATUS.SUCCESS;
                json_result.message = "修改成功";
            }
            else
            {
                json_result.status = RESPONSE_STATUS.ERROR;
                json_result.message = "修改失敗";
            }
            return Content(JsonConvert.SerializeObject(json_result), "application/json");
        }
        #endregion

        #region 母嬰同室刪除
        /// <summary>
        /// 母嬰同室刪除
        /// </summary>
        /// <param name="form"></param>
        /// <returns></returns>
        [HttpPost]
        public string Del_Roomin()
        {
            JavaScriptSerializer serializer = new JavaScriptSerializer();

            string[] id_list = Request["IID"].Split(',');
            string where = " IID IN ('" + String.Join("','", id_list) + "')";

            var sql = $"SELECT * FROM OBS_ROOMIN WHERE " + where;
            DataTable dt = obs_m.DBExecSQL(sql);
            if (dt != null && dt.Rows.Count > 0)
            {
                foreach (DataRow r in dt.Rows)
                {
                    if (r["END_TIME"].ToString() != "" && r["UPDNO"].ToString() != userinfo.EmployeesNo)
                    {
                        return serializer.Serialize("資料已結案，僅結案者可刪除!");
                    }
                    else if (r["END_TIME"].ToString() == "" && r["UPDNO"].ToString() != "")
                    {
                        if (r["UPDNO"].ToString() != userinfo.EmployeesNo)
                        {
                            return serializer.Serialize("無權限刪除!");
                        }
                    }
                    else if (r["END_TIME"].ToString() == "" && r["UPDNO"].ToString() == "")
                    {
                        if (r["CREATNO"].ToString() != userinfo.EmployeesNo)
                        {
                            return serializer.Serialize("無權限刪除!");
                        }
                    }
                }
            }

            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("DELETED", userinfo.EmployeesNo, DBItem.DBDataType.String));
            insertDataList = setNullToEmpty(insertDataList);
            int erow = obs_m.DBExecUpdate("OBS_ROOMIN", insertDataList, where);
            for (var i = 0; i < id_list.Length; i++)
            {
                Del_CareRecord(id_list[i] + "START", "OBS_ROOMIN");
                Del_CareRecord(id_list[i] + "END", "OBS_ROOMIN");
            }

            if (erow > 0)
                return serializer.Serialize("刪除成功");
            else
                return serializer.Serialize("刪除失敗");
        }
        #endregion

        #region 哺餵母乳轉介新增/編輯畫面
        /// <summary>
        /// 哺餵母乳轉介新增/編輯畫面
        /// </summary>
        /// <returns></returns>
        public ActionResult Insert_Feeding_Breast_Referral(string IID)
        {
            DataTable dthis = obs_m.sel_bthhis(ptinfo?.FeeNo);
            ViewBag.dthis = dthis;

            DataTable dtsta = obs_m.sel_bthsta(ptinfo?.FeeNo);
            ViewBag.dtsta = dtsta;

            DataTable dtnb = obs_m.sel_nb(ptinfo?.FeeNo);
            if (dtnb != null && dtnb.Rows.Count > 0)
            {
                dtnb.Columns.Add("AGE_N");
                dtnb.Columns.Add("WEIGHT_BIRTH");
                dtnb.Columns.Add("WEIGHT_NOW");
                dtnb.Columns.Add("GENDER_PF");

                foreach (DataRow r in dtnb.Rows)
                {
                    string weight = null;
                    DataTable dt_babylink = obs_m.sel_nbcha("", r["NB_CHARTNO"].ToString(), ptinfo?.FeeNo);
                    if (dt_babylink != null && dt_babylink.Rows.Count > 0)
                    {
                        #region 病人生命徵象
                        var sql = "SELECT CREATE_DATE, VS_ITEM, VS_PART, VS_RECORD, VS_MEMO,VS_REASON  "
                   + " FROM ( "
                   + "     SELECT CREATE_DATE, VS_ITEM, VS_PART, VS_RECORD, VS_MEMO,VS_REASON, "
                   + "     ROW_NUMBER() OVER(PARTITION BY t.VS_ITEM ORDER BY t.CREATE_DATE desc) NUM "
                   + "     FROM DATA_VITALSIGN t "
                   + "     WHERE FEE_NO = '" + dt_babylink.Rows[0]["BABY_FEE_NO"] + "' "
                   + "     ORDER BY CREATE_DATE DESC ) MAIN "
                   + " WHERE MAIN.NUM = 1 ";

                        var Temp = new List<Dictionary<string, string>>();

                        DataTable Dt2 = link.DBExecSQL(sql);
                        if (Dt2.Rows.Count > 0)
                        {
                            for (int i = 0; i < Dt2.Rows.Count; i++)
                            {
                                var temp = new Dictionary<string, string>();
                                temp["CREATE_DATE"] = Dt2.Rows[i]["CREATE_DATE"].ToString();
                                temp["VS_ITEM"] = Dt2.Rows[i]["VS_ITEM"].ToString();
                                temp["VS_PART"] = Dt2.Rows[i]["VS_PART"].ToString();
                                temp["VS_REASON"] = Dt2.Rows[i]["VS_REASON"].ToString();
                                temp["VS_RECORD"] = Dt2.Rows[i]["VS_RECORD"].ToString();
                                temp["VS_MEMO"] = Dt2.Rows[i]["VS_MEMO"].ToString();
                                Temp.Add(temp);
                            }
                        }

                        if (Temp.Count > 0)
                        {
                            int rownum = 3;
                            List<Dictionary<string, string>> VitalSignList = new List<Dictionary<string, string>>();

                            VitalSignList = Temp.FindAll(x => x["VS_ITEM"] == "bw" && !string.IsNullOrEmpty(x["VS_RECORD"]));
                            if (VitalSignList.Count > 0)
                            {
                                for (int i = 0; i < ((VitalSignList.Count < rownum) ? VitalSignList.Count : rownum); i++)
                                {
                                    weight = VitalSignList[i]["VS_RECORD"].ToString().Split('|')[0];
                                }
                            }
                        }
                        #endregion

                        var ptinfo = Get_Patient_Info(dt_babylink.Rows[0]["BABY_FEE_NO"].ToString());
                        r["GENDER_PF"] = ptinfo.PatientGender;
                    }

                    r["AGE_N"] = (DateTime.Now - Convert.ToDateTime(r["BIRTH_DAY"])).Days.ToString();
                    r["WEIGHT_BIRTH"] = $"Bw: {r["WEIGHT"].ToString()} gm BL: {r["HEIGHT"].ToString()} cm";
                    r["WEIGHT_NOW"] = weight;
                }
            }
            ViewBag.dtnb = dtnb;

            DataTable dtepds = obs_m.sel_epds(ptinfo?.FeeNo, "", "");
            if (dtepds != null && dtepds.Rows.Count > 0)
                ViewBag.epds = dtepds.Rows[0]["SCORE"];
            else
                ViewBag.epds = null;

            byte[] listByteCode = webService.GetPatInfo(ptinfo?.PatientID);
            if (listByteCode == null)
                ViewBag.Addr = new BaByPatInfo_IID();
            else
            {
                string listJsonArray = CompressTool.DecompressString(listByteCode);
                BaByPatInfo_IID[] patinfo = JsonConvert.DeserializeObject<BaByPatInfo_IID[]>(listJsonArray);
                ViewBag.Addr = patinfo[0].PATAddress;
            }

            if (IID != null)
            {
                DataTable dt = obs_m.sel_bredtran(ptinfo?.FeeNo, "", IID);
                dt.Columns.Add("APPLYNO_NAME");
                dt.Columns.Add("REPLYNO_NAME");
                if (dt != null && dt.Rows.Count > 0)
                {
                    foreach (DataRow r in dt.Rows)
                    {
                        if (r["APPLYNO"].ToString() != "")
                        {
                            byte[] listByteCode1 = webService.UserName(r["APPLYNO"].ToString());
                            if (listByteCode1 == null)
                                r["APPLYNO_NAME"] = "";
                            else
                            {
                                string listJsonArray1 = CompressTool.DecompressString(listByteCode1);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray1);
                                r["APPLYNO_NAME"] = user_name.EmployeesName;
                            }
                        }

                        if (r["REPLYNO"].ToString() != "")
                        {
                            byte[] listByteCode1 = webService.UserName(r["REPLYNO"].ToString());
                            if (listByteCode1 == null)
                                r["REPLYNO_NAME"] = "";
                            else
                            {
                                string listJsonArray1 = CompressTool.DecompressString(listByteCode1);
                                UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray1);
                                r["REPLYNO_NAME"] = user_name.EmployeesName;
                            }
                        }
                    }
                }
                ViewBag.dt = dt;

                DataTable dtbtnb = obs_m.sel_btnb(ptinfo?.FeeNo, "", IID);
                ViewBag.dtbtnb = dtbtnb;
            }
            return View();
        }
        #endregion

        #region 哺餵母乳轉介新增
        /// <summary>
        /// 哺餵母乳轉介新增
        /// </summary>
        /// <param name="form"></param>
        /// <returns></returns>
        [HttpPost]
        public ActionResult Insert_Feeding_Breast_Referral(FormCollection form)
        {
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo.FeeNo;
            string id = base.creatid("OBS_BREDTRAN", userno, feeno, "0");
            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("IID", id, DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("CREATNO", userno, DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("RECORDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間

            if (form["TXT_REF_DATE_DAY"] != "" && form["TXT_REF_DATE_DAY"] != null && form["TXT_REF_DATE_TIME"] != "" && form["TXT_REF_DATE_TIME"] != null)
            {
                insertDataList.Add(new DBItem("REF_DATE", form["TXT_REF_DATE_DAY"] + " " + form["TXT_REF_DATE_TIME"], DBItem.DBDataType.DataTime));
            }

            insertDataList.Add(new DBItem("APPLYNO", form["TXT_APPLYNO"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("REPLYNO", form["TXT_REPLYNO"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("NAME", form["TXT_NAME"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("AGE", form["TXT_AGE"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("EDU", form["TXT_EDU"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("TEL", form["TXT_TEL"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("BP", form["TXT_BP"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("MAR", form["RB_MAR"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("GEST_M", form["TXT_GEST_M"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("P", form["TXT_P"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("ADDR", form["TXT_ADDR"], DBItem.DBDataType.String));

            var PAT_STA = form["CK_PAT_STA"];
            var PAT_STAV = new List<string>() { "0", "0", "0", "0", "0", "0", "0", "0" };
            if (PAT_STA == null)
                insertDataList.Add(new DBItem("PAT_STA", String.Join("", PAT_STAV), DBItem.DBDataType.String));
            else
            {
                var PAT_STA_SP = PAT_STA.Split(',');
                foreach (var i in PAT_STA_SP)
                    PAT_STAV[Convert.ToInt32(i)] = "1";
                insertDataList.Add(new DBItem("PAT_STA", String.Join("", PAT_STAV), DBItem.DBDataType.String));
            }

            if (PAT_STAV[5] == "1")
                insertDataList.Add(new DBItem("PAT_STA_BL", form["TXT_PAT_STA_BL"], DBItem.DBDataType.String));
            else
                insertDataList.Add(new DBItem("PAT_STA_BL", null, DBItem.DBDataType.String));

            if (PAT_STAV[7] == "1")
                insertDataList.Add(new DBItem("PAT_STA_OTH", form["TXT_PAT_STA_OTH"], DBItem.DBDataType.String));
            else
                insertDataList.Add(new DBItem("PAT_STA_OTH", null, DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("CW", form["RB_CW"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("BREED", form["RB_BREED"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("BREED_H", form["RB_BREED_H"], DBItem.DBDataType.String));

            var TRACE = form["CK_TRACE"];
            var TRACEV = new List<string>() { "0", "0", "0", "0", "0" };
            if (TRACE == null)
                insertDataList.Add(new DBItem("TRACE", String.Join("", TRACEV), DBItem.DBDataType.String));
            else
            {
                var TRACE_SP = TRACE.Split(',');
                foreach (var i in TRACE_SP)
                    TRACEV[Convert.ToInt32(i)] = "1";
                insertDataList.Add(new DBItem("TRACE", String.Join("", TRACEV), DBItem.DBDataType.String));
            }

            if (TRACEV[4] == "1")
                insertDataList.Add(new DBItem("TRACE_OTH", form["TXT_TRACE_OTH"], DBItem.DBDataType.String));
            else
                insertDataList.Add(new DBItem("TRACE_OTH", null, DBItem.DBDataType.String));

            var REF = form["CK_REF"];
            var REFV = new List<string>() { "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", };
            if (REF == null)
                insertDataList.Add(new DBItem("REF", String.Join("", REFV), DBItem.DBDataType.String));
            else
            {
                var REF_SP = REF.Split(',');
                foreach (var i in REF_SP)
                    REFV[Convert.ToInt32(i)] = "1";
                insertDataList.Add(new DBItem("REF", String.Join("", REFV), DBItem.DBDataType.String));
            }

            if (REFV[11] == "1")
                insertDataList.Add(new DBItem("REF_OTH", form["TXT_REF_OTH"], DBItem.DBDataType.String));
            else
                insertDataList.Add(new DBItem("REF_OTH", null, DBItem.DBDataType.String));

            if (form["TXT_REPLY_DATE_DAY"] != null && form["TXT_REPLY_DATE_DAY"] != "")
            {
                insertDataList.Add(new DBItem("REPLY_DATE", form["TXT_REPLY_DATE_DAY"], DBItem.DBDataType.DataTime));
            }

            insertDataList.Add(new DBItem("REF_ORG", form["TXT_REF_ORG"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("REF_FAX", form["TXT_REF_FAX"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("REF_NAME", form["TXT_REF_NAME"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("REF_TEL", form["TXT_REF_TEL"], DBItem.DBDataType.String));

            var REF_WAY = form["CK_REF_WAY"];
            var REF_WAYV = new List<string>() { "0", "0", "0", "0", "0" };
            if (REF_WAY == null)
                insertDataList.Add(new DBItem("REF_WAY", String.Join("", REF_WAYV), DBItem.DBDataType.String));
            else
            {
                var REF_WAY_SP = REF_WAY.Split(',');
                foreach (var i in REF_WAY_SP)
                    REF_WAYV[Convert.ToInt32(i)] = "1";
                insertDataList.Add(new DBItem("REF_WAY", String.Join("", REF_WAYV), DBItem.DBDataType.String));
            }

            if (REF_WAYV[4] == "1")
                insertDataList.Add(new DBItem("REF_WAY_OTH", form["TXT_REF_WAY_OTH"], DBItem.DBDataType.String));
            else
                insertDataList.Add(new DBItem("REF_WAY_OTH", null, DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("REF_RST", form["TXT_REF_RST"], DBItem.DBDataType.String));

            insertDataList = setNullToEmpty(insertDataList);
            int erow = obs_m.DBExecInsert("OBS_BREDTRAN", insertDataList);

            #region 小孩
            var count = Convert.ToInt32(form["NB_COUNT"]);
            var seq = form["TXT_SQ_OF_NB"].Split(',');
            for (var c = 0; c < count; c++)
            {
                List<DBItem> insertNBDataList = new List<DBItem>();
                insertNBDataList.Add(new DBItem("IID", id, DBItem.DBDataType.String));
                insertNBDataList.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String));
                insertNBDataList.Add(new DBItem("CREATNO", userno, DBItem.DBDataType.String));
                insertNBDataList.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime));
                insertNBDataList.Add(new DBItem("RECORDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間
                insertNBDataList.Add(new DBItem("SQ_OF_NB", seq[c], DBItem.DBDataType.String));

                if (form["TXT_BIRTH_DAY" + seq[c]] != "" && form["TXT_BIRTH_DAY" + seq[c]] != null && form["TXT_BIRTH_TIME" + seq[c]] != "" && form["TXT_BIRTH_TIME" + seq[c]] != null)
                {
                    insertNBDataList.Add(new DBItem("BIRTH", form["TXT_BIRTH_DAY" + seq[c]] + " " + form["TXT_BIRTH_TIME" + seq[c]], DBItem.DBDataType.DataTime));
                }

                insertNBDataList.Add(new DBItem("BIRTH_TYPE", form["TXT_BIRTH_TYPE" + seq[c]], DBItem.DBDataType.String));
                insertNBDataList.Add(new DBItem("GENDER", form["TXT_GENDER" + seq[c]], DBItem.DBDataType.String));
                insertNBDataList.Add(new DBItem("AGE_N", form["TXT_AGE_N" + seq[c]], DBItem.DBDataType.String));
                insertNBDataList.Add(new DBItem("WEIGHT_BIRTH", form["TXT_WEIGHT_BIRTH" + seq[c]], DBItem.DBDataType.String));
                insertNBDataList.Add(new DBItem("WEIGHT_N", form["TXT_WEIGHT_N" + seq[c]], DBItem.DBDataType.String));

                var NB_STA = form["CK_NB_STA" + seq[c]];
                var NB_STAV = new List<string>() { "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0" };
                if (NB_STA == null)
                    insertNBDataList.Add(new DBItem("NB_STA", String.Join("", NB_STAV), DBItem.DBDataType.String));
                else
                {
                    var NB_STA_SP = NB_STA.Split(',');
                    foreach (var i in NB_STA_SP)
                        NB_STAV[Convert.ToInt32(i)] = "1";
                    insertNBDataList.Add(new DBItem("NB_STA", String.Join("", NB_STAV), DBItem.DBDataType.String));
                }

                if (NB_STAV[12] == "1")
                    insertNBDataList.Add(new DBItem("NB_STA_OTH", form["TXT_NB_STA_OTH" + seq[c]], DBItem.DBDataType.String));
                else
                    insertNBDataList.Add(new DBItem("NB_STA_OTH", null, DBItem.DBDataType.String));

                insertNBDataList = setNullToEmpty(insertNBDataList);
                erow += obs_m.DBExecInsert("OBS_BTNB", insertNBDataList);
            }
            #endregion

            if (erow > 0 && erow == count + 1)
                Response.Write("<script>alert('新增成功');window.opener.location.href='Roomin_List?mode=2';window.close();</script>");
            else
                Response.Write("<script>alert('新增失敗');window.opener.location.href='Roomin_List?mode=2';window.close();</script>");

            return new EmptyResult();
        }
        #endregion

        #region 哺餵母乳轉介編輯
        /// <summary>
        /// 哺餵母乳轉介編輯
        /// </summary>
        /// <param name="form"></param>
        /// <returns></returns>
        [HttpPost]
        public ActionResult Upd_Feeding_Breast_Referral(FormCollection form)
        {
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo.FeeNo;
            string[] id_list = form["IID"].Split(',');
            List<DBItem> insertDataList = new List<DBItem>();
            int erow = 0;
            for (int v = 0; v < id_list.Length; v++)
            {
                insertDataList.Add(new DBItem("UPDNO", userno, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("UPDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime));
                insertDataList.Add(new DBItem("RECORDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間
                if (form["TXT_REF_DATE_DAY" + id_list[v]] != "" && form["TXT_REF_DATE_DAY" + id_list[v]] != null && form["TXT_REF_DATE_TIME" + id_list[v]] != "" && form["TXT_REF_DATE_TIME" + id_list[v]] != null)
                {
                    insertDataList.Add(new DBItem("REF_DATE", form["TXT_REF_DATE_DAY" + id_list[v]] + " " + form["TXT_REF_DATE_TIME" + id_list[v]], DBItem.DBDataType.DataTime));
                }

                insertDataList.Add(new DBItem("APPLYNO", form["TXT_APPLYNO" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("REPLYNO", form["TXT_REPLYNO" + id_list[v]], DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("NAME", form["TXT_NAME" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("AGE", form["TXT_AGE" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("EDU", form["TXT_EDU" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("TEL", form["TXT_TEL" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("BP", form["TXT_BP" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("MAR", form["RB_MAR" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("GEST_M", form["TXT_GEST_M" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("P", form["TXT_P" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("ADDR", form["TXT_ADDR" + id_list[v]], DBItem.DBDataType.String));

                var PAT_STA = form["CK_PAT_STA" + id_list[v]];
                var PAT_STAV = new List<string>() { "0", "0", "0", "0", "0", "0", "0", "0" };
                if (PAT_STA == null)
                    insertDataList.Add(new DBItem("PAT_STA", String.Join("", PAT_STAV), DBItem.DBDataType.String));
                else
                {
                    var PAT_STA_SP = PAT_STA.Split(',');
                    foreach (var i in PAT_STA_SP)
                        PAT_STAV[Convert.ToInt32(i)] = "1";
                    insertDataList.Add(new DBItem("PAT_STA", String.Join("", PAT_STAV), DBItem.DBDataType.String));
                }

                if (PAT_STAV[5] == "1")
                    insertDataList.Add(new DBItem("PAT_STA_BL", form["TXT_PAT_STA_BL" + id_list[v]], DBItem.DBDataType.String));
                else
                    insertDataList.Add(new DBItem("PAT_STA_BL", null, DBItem.DBDataType.String));

                if (PAT_STAV[7] == "1")
                    insertDataList.Add(new DBItem("PAT_STA_OTH", form["TXT_PAT_STA_OTH" + id_list[v]], DBItem.DBDataType.String));
                else
                    insertDataList.Add(new DBItem("PAT_STA_OTH", null, DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("CW", form["RB_CW" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("BREED", form["RB_BREED" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("BREED_H", form["RB_BREED_H" + id_list[v]], DBItem.DBDataType.String));

                var TRACE = form["CK_TRACE" + id_list[v]];
                var TRACEV = new List<string>() { "0", "0", "0", "0", "0" };
                if (TRACE == null)
                    insertDataList.Add(new DBItem("TRACE", String.Join("", TRACEV), DBItem.DBDataType.String));
                else
                {
                    var TRACE_SP = TRACE.Split(',');
                    foreach (var i in TRACE_SP)
                        TRACEV[Convert.ToInt32(i)] = "1";
                    insertDataList.Add(new DBItem("TRACE", String.Join("", TRACEV), DBItem.DBDataType.String));
                }

                if (TRACEV[4] == "1")
                    insertDataList.Add(new DBItem("TRACE_OTH", form["TXT_TRACE_OTH" + id_list[v]], DBItem.DBDataType.String));
                else
                    insertDataList.Add(new DBItem("TRACE_OTH", null, DBItem.DBDataType.String));

                var REF = form["CK_REF" + id_list[v]];
                var REFV = new List<string>() { "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", };
                if (REF == null)
                    insertDataList.Add(new DBItem("REF", String.Join("", REFV), DBItem.DBDataType.String));
                else
                {
                    var REF_SP = REF.Split(',');
                    foreach (var i in REF_SP)
                        REFV[Convert.ToInt32(i)] = "1";
                    insertDataList.Add(new DBItem("REF", String.Join("", REFV), DBItem.DBDataType.String));
                }

                if (REFV[11] == "1")
                    insertDataList.Add(new DBItem("REF_OTH", form["TXT_REF_OTH" + id_list[v]], DBItem.DBDataType.String));
                else
                    insertDataList.Add(new DBItem("REF_OTH", null, DBItem.DBDataType.String));

                if (form["TXT_REPLY_DATE_DAY" + id_list[v]] != null && form["TXT_REPLY_DATE_DAY" + id_list[v]] != "")
                {
                    insertDataList.Add(new DBItem("REPLY_DATE", form["TXT_REPLY_DATE_DAY" + id_list[v]], DBItem.DBDataType.DataTime));
                }

                insertDataList.Add(new DBItem("REF_ORG", form["TXT_REF_ORG" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("REF_FAX", form["TXT_REF_FAX" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("REF_NAME", form["TXT_REF_NAME" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("REF_TEL", form["TXT_REF_TEL" + id_list[v]], DBItem.DBDataType.String));

                var REF_WAY = form["CK_REF_WAY" + id_list[v]];
                var REF_WAYV = new List<string>() { "0", "0", "0", "0", "0" };
                if (REF_WAY == null)
                    insertDataList.Add(new DBItem("REF_WAY", String.Join("", REF_WAYV), DBItem.DBDataType.String));
                else
                {
                    var REF_WAY_SP = REF_WAY.Split(',');
                    foreach (var i in REF_WAY_SP)
                        REF_WAYV[Convert.ToInt32(i)] = "1";
                    insertDataList.Add(new DBItem("REF_WAY", String.Join("", REF_WAYV), DBItem.DBDataType.String));
                }

                if (REF_WAYV[4] == "1")
                    insertDataList.Add(new DBItem("REF_WAY_OTH", form["TXT_REF_WAY_OTH" + id_list[v]], DBItem.DBDataType.String));
                else
                    insertDataList.Add(new DBItem("REF_WAY_OTH", null, DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("REF_RST", form["TXT_REF_RST" + id_list[v]], DBItem.DBDataType.String));

                string where = " IID = '" + id_list[v] + "' ";
                insertDataList = setNullToEmpty(insertDataList);
                erow += obs_m.DBExecUpdate("OBS_BREDTRAN", insertDataList, where);

                #region 小孩
                var count = Convert.ToInt32(form["NB_COUNT"]);
                var seq = form["TXT_SQ_OF_NB" + id_list[v]].Split(',');
                for (var c = 0; c < count; c++)
                {
                    List<DBItem> insertNBDataList = new List<DBItem>();
                    if (form["TXT_BIRTH_DAY" + id_list[v] + seq[c]] != "" && form["TXT_BIRTH_DAY" + id_list[v] + seq[c]] != null && form["TXT_BIRTH_TIME" + id_list[v] + seq[c]] != "" && form["TXT_BIRTH_TIME" + id_list[v] + seq[c]] != null)
                    {
                        insertNBDataList.Add(new DBItem("BIRTH", form["TXT_BIRTH_DAY" + id_list[v] + seq[c]] + " " + form["TXT_BIRTH_TIME" + id_list[v] + seq[c]], DBItem.DBDataType.DataTime));
                    }

                    insertNBDataList.Add(new DBItem("BIRTH_TYPE", form["TXT_BIRTH_TYPE" + id_list[v] + seq[c]], DBItem.DBDataType.String));
                    insertNBDataList.Add(new DBItem("GENDER", form["TXT_GENDER" + id_list[v] + seq[c]], DBItem.DBDataType.String));
                    insertNBDataList.Add(new DBItem("AGE_N", form["TXT_AGE_N" + id_list[v] + seq[c]], DBItem.DBDataType.String));
                    insertNBDataList.Add(new DBItem("WEIGHT_BIRTH", form["TXT_WEIGHT_BIRTH" + id_list[v] + seq[c]], DBItem.DBDataType.String));
                    insertNBDataList.Add(new DBItem("WEIGHT_N", form["TXT_WEIGHT_N" + id_list[v] + seq[c]], DBItem.DBDataType.String));

                    var NB_STA = form["CK_NB_STA" + id_list[v] + seq[c]];
                    var NB_STAV = new List<string>() { "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0" };
                    if (NB_STA == null)
                        insertNBDataList.Add(new DBItem("NB_STA", String.Join("", NB_STAV), DBItem.DBDataType.String));
                    else
                    {
                        var NB_STA_SP = NB_STA.Split(',');
                        foreach (var i in NB_STA_SP)
                            NB_STAV[Convert.ToInt32(i)] = "1";
                        insertNBDataList.Add(new DBItem("NB_STA", String.Join("", NB_STAV), DBItem.DBDataType.String));
                    }

                    if (NB_STAV[12] == "1")
                        insertNBDataList.Add(new DBItem("NB_STA_OTH", form["TXT_NB_STA_OTH" + id_list[v] + seq[c]], DBItem.DBDataType.String));
                    else
                        insertNBDataList.Add(new DBItem("NB_STA_OTH", null, DBItem.DBDataType.String));

                    string NBwhere = " IID = '" + id_list[v] + "' AND SQ_OF_NB = '" + seq[c] + "' ";
                    insertNBDataList = setNullToEmpty(insertNBDataList);
                    obs_m.DBExecUpdate("OBS_BTNB", insertNBDataList, NBwhere);
                }
                #endregion

            }
            if (erow == id_list.Length)
                Response.Write("<script>alert('修改成功');window.opener.location.href='Roomin_List?mode=2';window.close();</script>");
            else
                Response.Write("<script>alert('修改失敗');window.opener.location.href='Roomin_List?mode=2';window.close();</script>");

            return new EmptyResult();
        }
        #endregion

        #region 哺餵母乳轉介刪除
        [HttpPost]
        public string Del_Feeding_Breast_Referral()
        {
            link.DBOpen();
            string[] id = Request["B_IID"].ToString().Split(',');

            bool UnAuthorized = false;
            for (var i = 0; i < id.Length; i++)
            {
                DataTable dt = obs_m.sel_bredtran("", userinfo.EmployeesNo, id[i]);
                if (dt == null || dt.Rows.Count == 0)
                {
                    UnAuthorized = true;
                    break;
                }
            }
            if (!UnAuthorized)
            {
                List<DBItem> insertDataList = new List<DBItem>();
                insertDataList.Add(new DBItem("DELETED", userinfo.EmployeesNo, DBItem.DBDataType.String));
                string where = " IID IN ('" + String.Join("','", id) + "')";
                insertDataList = setNullToEmpty(insertDataList);
                int erow = link.DBExecUpdate("OBS_BREDTRAN", insertDataList, where);
                if (erow > 0)
                {
                    for (int i = 0; i < id.Length; i++)
                        link.DBExecUpdate("OBS_BTNB", insertDataList, where);
                    return "1";
                    //Response.Write("<script>alert('刪除成功');window.location.href='Index?active=Instantly_Be_Birth_List';</script>");
                }
                else
                    return "-1";
            }
            else
            {
                return "-501";
            }
            //Response.Write("<script>alert('刪除失敗');window.location.href='Index?active=Instantly_Be_Birth_List';</script>");
        }
        #endregion

        #region 母乳轉介列印單
        public ActionResult Feeding_Breast_Referral_Print(string IID)
        {
            if (IID != null)
            {
                DataTable dt = obs_m.sel_bredtran("", "", IID);
                if (dt != null && dt.Rows.Count > 0)
                    ViewBag.dt = dt.Rows[0];
                else
                    ViewBag.dt = null;

                DataTable dtbtnb = obs_m.sel_btnb("", "", IID);
                ViewBag.dtbtnb = dtbtnb;
            }

            ViewBag.ptinfo = ptinfo;
            return View();
        }
        #endregion

        #region 哺餵照護紀錄畫面
        public ActionResult Breast_Fedding_List(string feeno, string chartno, string Type, bool IsHisView = false)
        {
            ViewBag.IsHisView = IsHisView;

            if (IsHisView)
            {
                his.ControllerContext = ControllerContext;
                his.getSession(feeno);
                ViewBag.feeno = feeno;
                ViewBag.ChartNo = chartno;
            }
            else
            {
                ViewBag.feeno = ptinfo.FeeNo;
                ViewBag.ChartNo = ptinfo.ChartNo;
            }
            if (Session["PatInfo"] != null)
            {
                var ptinfo = Session["PatInfo"] as PatientInfo;
                if (feeno == "" || feeno == null)
                    feeno = ptinfo.FeeNo;

                string type = "";
                if (IsNoEmpty(Type))
                    type = Type.Split('?')[0];

                //自己身分取自己
                if (!IsNoEmpty(Type) || (type == "NB" && ptinfo.Age < 1) || (type == "Mon" && ptinfo.Age >= 1))
                {
                    DataTable dt = obs_m.sel_Breast_Fedding(ptinfo?.FeeNo, "", "");
                    dt.Columns.Add("CREATNO_NAME");

                    if (dt != null && dt.Rows.Count > 0)
                    {
                        foreach (DataRow r in dt.Rows)
                        {
                            if (r["CREATNO"].ToString() != "")
                            {
                                byte[] listByteCode1 = webService.UserName(r["CREATNO"].ToString());
                                if (listByteCode1 == null)
                                    r["CREATNO_NAME"] = "";
                                else
                                {
                                    string listJsonArray = CompressTool.DecompressString(listByteCode1);
                                    UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                    r["CREATNO_NAME"] = user_name.EmployeesName;
                                }
                            }
                        }
                    }
                    ViewBag.dt = set_dt(dt);
                }
                //媽媽取小孩
                else if (type == "NB" && ptinfo.Age >= 1)
                {
                    DataTable dt_babylink = obs_m.sel_nbcha("", "", ptinfo?.FeeNo);
                    if (dt_babylink != null && dt_babylink.Rows.Count > 0)
                    {
                        DataTable dt = new DataTable();

                        foreach (DataRow r in dt_babylink.Rows)
                        {
                            var baby_feeno = r["BABY_FEE_NO"].ToString();

                            DataTable bf = obs_m.sel_Breast_Fedding(baby_feeno, "", "");
                            if (bf != null && bf.Rows.Count > 0)
                            {
                                foreach (DataRow bf_r in bf.Rows)
                                {
                                    bf_r["NB_SEQ_FEENO"] = $"{r["BABY_SEQ"].ToString()},新生兒{r["BABY_SEQ"].ToString()},{r["BABY_FEE_NO"].ToString()}";
                                }
                            }
                            dt.Merge(bf);
                        }

                        DataTable dt_bfCopy = dt.Copy();
                        DataView dv_bf = dt.DefaultView;
                        dv_bf.Sort = "RECORDTIME DESC";
                        dt_bfCopy = dv_bf.ToTable();
                        dt_bfCopy.Columns.Add("CREATNO_NAME");
                        if (dt_bfCopy != null && dt_bfCopy.Rows.Count > 0)
                        {
                            foreach (DataRow r in dt_bfCopy.Rows)
                            {
                                if (r["CREATNO"].ToString() != "")
                                {
                                    byte[] listByteCode1 = webService.UserName(r["CREATNO"].ToString());
                                    if (listByteCode1 == null)
                                        r["CREATNO_NAME"] = "";
                                    else
                                    {
                                        string listJsonArray = CompressTool.DecompressString(listByteCode1);
                                        UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                        r["CREATNO_NAME"] = user_name.EmployeesName;
                                    }
                                }
                            }
                        }
                        ViewBag.dt = set_dt(dt_bfCopy);
                    }
                }
                //小孩取媽媽
                else if (type == "Mon" && ptinfo.Age < 1)
                {
                    DataTable dt_babylink = obs_m.sel_nbcha(ptinfo?.FeeNo, "", "");
                    if (dt_babylink != null && dt_babylink.Rows.Count > 0)
                    {
                        var mom_feeno = dt_babylink.Rows[0]["MOM_FEE_NO"].ToString();

                        DataTable dt = obs_m.sel_Breast_Fedding(mom_feeno, "", "", ptinfo?.FeeNo);
                        dt.Columns.Add("CREATNO_NAME");
                        if (dt != null && dt.Rows.Count > 0)
                        {
                            foreach (DataRow r in dt.Rows)
                            {
                                if (r["CREATNO"].ToString() != "")
                                {
                                    byte[] listByteCode1 = webService.UserName(r["CREATNO"].ToString());
                                    if (listByteCode1 == null)
                                        r["CREATNO_NAME"] = "";
                                    else
                                    {
                                        string listJsonArray = CompressTool.DecompressString(listByteCode1);
                                        UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                        r["CREATNO_NAME"] = user_name.EmployeesName;
                                    }
                                }
                            }
                        }
                        ViewBag.dt = set_dt(dt);
                    }
                }
                else if (type == "ALL")
                {
                    if (ptinfo.Age < 1)
                    {
                        DataTable dt_babylink = obs_m.sel_nbcha(ptinfo?.FeeNo, "", "");
                        if (dt_babylink != null && dt_babylink.Rows.Count > 0)
                        {
                            var mom_feeno = dt_babylink.Rows[0]["MOM_FEE_NO"].ToString();
                            var baby_seq = dt_babylink.Rows[0]["BABY_SEQ"].ToString();

                            DataTable dt_bf = obs_m.sel_Breast_Fedding(mom_feeno, "", "", "", baby_seq);
                            DataTable dt_bf_b = obs_m.sel_Breast_Fedding(ptinfo?.FeeNo, "", "");

                            dt_bf.Merge(dt_bf_b);

                            DataTable dtCopy = dt_bf.Copy();
                            DataView dv = dt_bf.DefaultView;
                            dv.Sort = "RECORDTIME DESC";
                            dtCopy = dv.ToTable();
                            dtCopy.Columns.Add("CREATNO_NAME");
                            if (dtCopy != null && dtCopy.Rows.Count > 0)
                            {
                                foreach (DataRow r in dtCopy.Rows)
                                {
                                    if (r["CREATNO"].ToString() != "")
                                    {
                                        byte[] listByteCode1 = webService.UserName(r["CREATNO"].ToString());
                                        if (listByteCode1 == null)
                                            r["CREATNO_NAME"] = "";
                                        else
                                        {
                                            string listJsonArray = CompressTool.DecompressString(listByteCode1);
                                            UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                            r["CREATNO_NAME"] = user_name.EmployeesName;
                                        }
                                    }
                                }
                            }
                            ViewBag.dt = set_dt(dtCopy);
                        }
                    }
                    else
                    {
                        DataTable dt_babylink = obs_m.sel_nbcha("", "", ptinfo?.FeeNo);
                        if (dt_babylink != null && dt_babylink.Rows.Count > 0)
                        {
                            DataTable dt_bf = obs_m.sel_Breast_Fedding(ptinfo?.FeeNo, "", "");

                            foreach (DataRow r in dt_babylink.Rows)
                            {
                                var baby_feeno = r["BABY_FEE_NO"].ToString();

                                DataTable bf = obs_m.sel_Breast_Fedding(baby_feeno, "", "");
                                if (bf != null && bf.Rows.Count > 0)
                                {
                                    foreach (DataRow bf_r in bf.Rows)
                                    {
                                        bf_r["NB_SEQ_FEENO"] = $"{r["BABY_SEQ"].ToString()},新生兒{r["BABY_SEQ"].ToString()},{r["BABY_FEE_NO"].ToString()}";
                                    }
                                }
                                dt_bf.Merge(bf);
                            }

                            DataTable dt_bfCopy = dt_bf.Copy();
                            DataView dv_bf = dt_bf.DefaultView;
                            dv_bf.Sort = "RECORDTIME DESC";
                            dt_bfCopy = dv_bf.ToTable();
                            dt_bfCopy.Columns.Add("CREATNO_NAME");
                            if (dt_bfCopy != null && dt_bfCopy.Rows.Count > 0)
                            {
                                foreach (DataRow r in dt_bfCopy.Rows)
                                {
                                    if (r["CREATNO"].ToString() != "")
                                    {
                                        byte[] listByteCode1 = webService.UserName(r["CREATNO"].ToString());
                                        if (listByteCode1 == null)
                                            r["CREATNO_NAME"] = "";
                                        else
                                        {
                                            string listJsonArray = CompressTool.DecompressString(listByteCode1);
                                            UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                                            r["CREATNO_NAME"] = user_name.EmployeesName;
                                        }
                                    }
                                }
                            }
                            ViewBag.dt = set_dt(dt_bfCopy);
                        }
                    }
                }

                ViewData["color_drainage"] = this.cd.getSelectItem("io", "outputcolor_Drainage", "");
                ViewData["outputnature_Drainage"] = this.cd.getSelectItem("io", "outputnature_Drainage", "");

                if (ptinfo.Age < 1)
                    ViewBag.IsNB = true;
                else
                    ViewBag.IsNB = false;

                ViewBag.Type = type;
                if (!IsNoEmpty(type))
                {
                    if (ptinfo?.Age < 1)
                        ViewBag.Type = "NB";
                    else
                        ViewBag.Type = "Mon";
                }

                return View();
            }
            Response.Write("<script>alert('請重新選擇病患');</script>");
            return new EmptyResult();
        }
        #endregion

        #region 哺餵照護紀錄新增畫面
        public ActionResult Insert_Breast_Fedding(string id)
        {
            ViewBag.Age = ptinfo?.Age;
            ViewBag.FeeNo = ptinfo?.FeeNo;
            ViewBag.ptinfo = ptinfo;

            if (id != null)
            {
                DataTable dt = obs_m.sel_Breast_Fedding("", "", id);
                if (dt != null && dt.Rows.Count > 0)
                {
                    foreach (DataRow r in dt.Rows)
                    {
                        if (r["CREATNO"].ToString().Trim() != userinfo.EmployeesNo)
                        {
                            Response.Write("<script>alert('無權限修改!');window.close();</script>");
                            return new EmptyResult();
                        }

                        if (r["FEENO"].ToString().Trim() != ptinfo.FeeNo)
                        {
                            Response.Write("<script>alert('請點選當初新增的病人做修改(媽媽或新生兒)!');window.close();</script>");
                            return new EmptyResult();
                        }
                    }
                }
                ViewBag.dt = dt;
            }

            ViewData["color_drainage"] = this.cd.getSelectItem("io", "outputcolor_Drainage", "");
            ViewData["outputnature_Drainage"] = this.cd.getSelectItem("io", "outputnature_Drainage", "");
            return View();
        }
        #endregion

        #region 哺餵照護紀錄新增
        [HttpPost]
        public ActionResult Insert_Breast_Fedding(FormCollection form)
        {
            link.DBOpen();

            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo.FeeNo;
            string id = base.creatid("OBS_PATNB", userno, feeno, "0");
            string milkID = form["TXT_MILK_ID"];
            var baby_feeno = IsNoEmpty(form["RB_NB_FEENO"]) == true ? form["RB_NB_FEENO"].Split(',')[2] : "";
            var baby_seq = IsNoEmpty(form["RB_NB_FEENO"]) == true ? form["RB_NB_FEENO"].Split(',')[0] : "";

            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("IID", id, DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("CREATNO", userno, DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime));
            if (form["RECORDTIME_DAY"] != "" && form["RECORDTIME_DAY"] != null && form["RECORDTIME_TIME"] != "" && form["RECORDTIME_TIME"] != null)
                insertDataList.Add(new DBItem("RECORDTIME", form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], DBItem.DBDataType.DataTime)); //紀錄時間

            var NIPPLE = form["CK_NIPPLE"];
            var NIPPLEV = new List<string>() { "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0" };
            if (NIPPLE == null)
                insertDataList.Add(new DBItem("NIPPLE", String.Join("", NIPPLEV), DBItem.DBDataType.String));
            else
            {
                var NIPPLE_SP = NIPPLE.Split(',');
                foreach (var i in NIPPLE_SP)
                    NIPPLEV[Convert.ToInt32(i)] = "1";
                insertDataList.Add(new DBItem("NIPPLE", String.Join("", NIPPLEV), DBItem.DBDataType.String));
            }

            var BREAST = form["CK_BREAST"];
            var BREASTV = new List<string>() { "0", "0", "0", "0", "0", "0", "0", "0", "0", "0" };
            if (BREAST == null)
                insertDataList.Add(new DBItem("BREAST", String.Join("", BREASTV), DBItem.DBDataType.String));
            else
            {
                var BREAST_SP = BREAST.Split(',');
                foreach (var i in BREAST_SP)
                    BREASTV[Convert.ToInt32(i)] = "1";
                insertDataList.Add(new DBItem("BREAST", String.Join("", BREASTV), DBItem.DBDataType.String));
            }

            var LACT_L = form["RB_LACT_L"];
            insertDataList.Add(new DBItem("LACT_L", LACT_L, DBItem.DBDataType.String));
            if (LACT_L == "2")
                insertDataList.Add(new DBItem("LACT_LAMT", form["TXT_LACT_LAMT"], DBItem.DBDataType.String));
            else
                insertDataList.Add(new DBItem("LACT_LAMT", null, DBItem.DBDataType.String));

            var LACT_R = form["RB_LACT_R"];
            insertDataList.Add(new DBItem("LACT_R", LACT_R, DBItem.DBDataType.String));
            if (LACT_R == "2")
                insertDataList.Add(new DBItem("LACT_RAMT", form["TXT_LACT_RAMT"], DBItem.DBDataType.String));
            else
                insertDataList.Add(new DBItem("LACT_RAMT", null, DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("NB_SEQ_FEENO", form["RB_NB_FEENO"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("AWAKE", form["RB_AWAKE"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("BRE_TYP", form["RB_BRE_TYP"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("SKIN", form["RB_SKIN"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("MUSCLE", form["RB_MUSCLE"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("ACTI", form["RB_ACTI"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("BRE_BP1", form["RB_BRE_BP1"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("BRE_BP2", form["RB_BRE_BP2"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("BRE_BP3", form["RB_BRE_BP3"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("BRE_BP4", form["RB_BRE_BP4"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("BRE_BP5", form["RB_BRE_BP5"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("BRE_RES1", form["RB_BRE_RES1"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("BRE_RES2", form["RB_BRE_RES2"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("BRE_RES3", form["RB_BRE_RES3"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("BRE_RES4", form["RB_BRE_RES4"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("BRE_EB1", form["RB_BRE_EB1"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("BRE_EB2", form["RB_BRE_EB2"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("BRE_ANA1", form["RB_BRE_ANA1"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("BRE_ANA2", form["RB_BRE_ANA2"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("BRE_ANA3", form["RB_BRE_ANA3"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("BRE_SUC1", form["RB_BRE_SUC1"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("BRE_SUC2", form["RB_BRE_SUC2"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("BRE_SUC3", form["RB_BRE_SUC3"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("BRE_SUC4", form["RB_BRE_SUC4"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("BRE_SUC5", form["RB_BRE_SUC5"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("BRE_TSS1", form["RB_BRE_TSS1"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("BRE_TSS2", form["TXT_BRE_TSS2"], DBItem.DBDataType.String));

            #region 含乳時間IO
            //20200331 modified ，輸入為空值，會放 value 0 到 IO
            //if (form["TXT_BRE_TSS2"] != "" && IsNoEmpty(baby_feeno))
            //{
            //    Insert_IO_DATA_ForOther(baby_feeno, form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "_11", "11", "", form["TXT_BRE_TSS2"], "4", id + "_BRE_TSS2", "OBS_PATNB");
            //}
            //else if (ptinfo.Age < 1 && form["TXT_BRE_TSS2"] != "")
            //{
            //    Insert_IO_DATA(form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "_11", "11", "", form["TXT_BRE_TSS2"], "4", id + "_BRE_TSS2", "OBS_PATNB");
            //}
            var ValueTXT_BRE_TSS2 = (form["TXT_BRE_TSS2"] == "") ? "0" : form["TXT_BRE_TSS2"];
            if (IsNoEmpty(baby_feeno))
            {
                Insert_IO_DATA_ForOther(baby_feeno, form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "_11", "11", "", ValueTXT_BRE_TSS2, "4", id + "_BRE_TSS2", "OBS_PATNB");
            }
            else if (ptinfo.Age < 1)
            {
                Insert_IO_DATA(form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "_11", "11", "", ValueTXT_BRE_TSS2, "4", id + "_BRE_TSS2", "OBS_PATNB");
            }
            //end 20200331 modified
            #endregion

            insertDataList.Add(new DBItem("WATER", form["TXT_WATER"], DBItem.DBDataType.String));

            #region 水IO
            //20200331 modified ，輸入為空值，會放 value 0 到 IO
            //if (form["TXT_WATER"] != "" && IsNoEmpty(baby_feeno))
            //{
            //    var ioSql = "SELECT * FROM IO_ITEM WHERE TYPEID = '2' AND NAME = '水'";
            //    var io_dt = obs_m.DBExecSQL(ioSql);
            //    if (io_dt != null && io_dt.Rows.Count > 0)
            //    {
            //        var itemid = io_dt.Rows[0]["ITEMID"].ToString();
            //        Insert_IO_DATA_ForOther(baby_feeno, form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "_2", "2", itemid, form["TXT_WATER"], "1", id + "_WATER", "OBS_PATNB");
            //    }
            //}
            //else if (ptinfo.Age < 1 && form["TXT_WATER"] != "")
            //{
            //    var ioSql = "SELECT * FROM IO_ITEM WHERE TYPEID = '2' AND NAME = '水'";
            //    var io_dt = obs_m.DBExecSQL(ioSql);
            //    if (io_dt != null && io_dt.Rows.Count > 0)
            //    {
            //        var itemid = io_dt.Rows[0]["ITEMID"].ToString();
            //        Insert_IO_DATA(form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "_2", "2", itemid, form["TXT_WATER"], "1", id + "_WATER", "OBS_PATNB");
            //    }
            //}
            var ValueTXT_WATER = (form["TXT_WATER"] == "") ? "0" : form["TXT_WATER"];
            if (IsNoEmpty(baby_feeno))
            {
                var ioSql = "SELECT * FROM IO_ITEM WHERE TYPEID = '2' AND NAME = '水'";
                var io_dt = obs_m.DBExecSQL(ioSql);
                if (io_dt != null && io_dt.Rows.Count > 0)
                {
                    var itemid = io_dt.Rows[0]["ITEMID"].ToString();
                    Insert_IO_DATA_ForOther(baby_feeno, form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "_2", "2", itemid, ValueTXT_WATER, "1", id + "_WATER", "OBS_PATNB");
                }
            }
            else if (ptinfo.Age < 1)
            {
                var ioSql = "SELECT * FROM IO_ITEM WHERE TYPEID = '2' AND NAME = '水'";
                var io_dt = obs_m.DBExecSQL(ioSql);
                if (io_dt != null && io_dt.Rows.Count > 0)
                {
                    var itemid = io_dt.Rows[0]["ITEMID"].ToString();
                    Insert_IO_DATA(form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "_2", "2", itemid, ValueTXT_WATER, "1", id + "_WATER", "OBS_PATNB");
                }
            }
            //end 20200331 modified
            #endregion

            insertDataList.Add(new DBItem("BRE_MLK", form["TXT_BRE_MLK"], DBItem.DBDataType.String));

            #region 母乳IO
            //20200331 modified ，輸入為空值，會放 value 0 到 IO
            //if (form["TXT_BRE_MLK"] != "" && IsNoEmpty(baby_feeno))
            //{
            //    var ioSql = "SELECT * FROM IO_ITEM WHERE TYPEID = '2' AND NAME = '母奶'";
            //    var io_dt = obs_m.DBExecSQL(ioSql);
            //    if (io_dt != null && io_dt.Rows.Count > 0)
            //    {
            //        var itemid = io_dt.Rows[0]["ITEMID"].ToString();
            //        Insert_IO_DATA_ForOther(baby_feeno, form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "_2", "2", itemid, form["TXT_BRE_MLK"], "1", id + "_BRE_MLK", "OBS_PATNB");
            //    }
            //}
            //else if (ptinfo.Age < 1 && form["TXT_BRE_MLK"] != "")
            //{
            //    var ioSql = "SELECT * FROM IO_ITEM WHERE TYPEID = '2' AND NAME = '母奶'";
            //    var io_dt = obs_m.DBExecSQL(ioSql);
            //    if (io_dt != null && io_dt.Rows.Count > 0)
            //    {
            //        var itemid = io_dt.Rows[0]["ITEMID"].ToString();
            //        Insert_IO_DATA(form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "_2", "2", itemid, form["TXT_BRE_MLK"], "1", id + "_BRE_MLK", "OBS_PATNB");
            //    }
            //}
            var ValueTXT_BRE_MLK = (form["TXT_BRE_MLK"] == "") ? "0" : form["TXT_BRE_MLK"];
            if (IsNoEmpty(baby_feeno))
            {
                var ioSql = "SELECT * FROM IO_ITEM WHERE TYPEID = '2' AND NAME = '母奶'";
                var io_dt = obs_m.DBExecSQL(ioSql);
                if (io_dt != null && io_dt.Rows.Count > 0)
                {
                    var itemid = io_dt.Rows[0]["ITEMID"].ToString();
                    Insert_IO_DATA_ForOther(baby_feeno, form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "_2", "2", itemid, ValueTXT_BRE_MLK, "1", id + "_BRE_MLK", "OBS_PATNB");
                }
            }
            else if (ptinfo.Age < 1)
            {
                var ioSql = "SELECT * FROM IO_ITEM WHERE TYPEID = '2' AND NAME = '母奶'";
                var io_dt = obs_m.DBExecSQL(ioSql);
                if (io_dt != null && io_dt.Rows.Count > 0)
                {
                    var itemid = io_dt.Rows[0]["ITEMID"].ToString();
                    Insert_IO_DATA(form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "_2", "2", itemid, ValueTXT_BRE_MLK, "1", id + "_BRE_MLK", "OBS_PATNB");
                }
            }
            //end 20200331 modified
            #endregion

            insertDataList.Add(new DBItem("MILK_BD", form["TXT_MILK_BD"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("MILK", form["TXT_MILK"], DBItem.DBDataType.String));
            #region 配方奶IO
            //20200331 modified ，輸入為空值，會放 value 0 到 IO
            //if (form["TXT_MILK"] != "" && IsNoEmpty(baby_feeno))
            //{
            //    var ioSql = "SELECT * FROM IO_ITEM WHERE TYPEID = '2' AND NAME = '配方奶'";
            //    var io_dt = obs_m.DBExecSQL(ioSql);
            //    if (io_dt != null && io_dt.Rows.Count > 0)
            //    {
            //        var itemid = io_dt.Rows[0]["ITEMID"].ToString();
            //        Insert_IO_DATA_ForOther(baby_feeno, form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "_2", "2", itemid, form["TXT_MILK"], "1", id + "_MILK", "OBS_PATNB", "", form["TXT_MILK_BD"]);
            //    }
            //}
            //else if (ptinfo.Age < 1 && form["TXT_MILK"] != "")
            //{
            //    var ioSql = "SELECT * FROM IO_ITEM WHERE TYPEID = '2' AND NAME = '配方奶'";
            //    var io_dt = obs_m.DBExecSQL(ioSql);
            //    if (io_dt != null && io_dt.Rows.Count > 0)
            //    {
            //        var itemid = io_dt.Rows[0]["ITEMID"].ToString();
            //        Insert_IO_DATA(form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "_2", "2", itemid, form["TXT_MILK"], "1", id + "_MILK", "OBS_PATNB", form["TXT_MILK_BD"]);
            //    }
            //}
            var ValueTXT_MILK = (form["TXT_MILK"] == "") ? "0" : form["TXT_MILK"];
            if (IsNoEmpty(baby_feeno))
            {
                var ioSql = "SELECT * FROM IO_ITEM WHERE TYPEID = '2' AND NAME = '配方奶'";
                var io_dt = obs_m.DBExecSQL(ioSql);
                if (io_dt != null && io_dt.Rows.Count > 0)
                {
                    var itemid = io_dt.Rows[0]["ITEMID"].ToString();
                    Insert_IO_DATA_ForOther(baby_feeno, form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "_2", "2", itemid, ValueTXT_MILK, "1", id + "_MILK", "OBS_PATNB", "", form["TXT_MILK_BD"]);
                }
            }
            else if (ptinfo.Age < 1)
            {
                var ioSql = "SELECT * FROM IO_ITEM WHERE TYPEID = '2' AND NAME = '配方奶'";
                var io_dt = obs_m.DBExecSQL(ioSql);
                if (io_dt != null && io_dt.Rows.Count > 0)
                {
                    var itemid = io_dt.Rows[0]["ITEMID"].ToString();
                    Insert_IO_DATA(form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "_2", "2", itemid, ValueTXT_MILK, "1", id + "_MILK", "OBS_PATNB", form["TXT_MILK_BD"]);
                }
            }
            //end 20200331 modified
            #endregion
            insertDataList.Add(new DBItem("D5W", form["TXT_D5W"], DBItem.DBDataType.String));

            #region D5W
            //20200331 modified ，輸入為空值，會放 value 0 到 IO
            //if (form["TXT_D5W"] != "" && IsNoEmpty(baby_feeno))
            //{
            //    var ioSql = "SELECT * FROM IO_ITEM WHERE TYPEID = '2' AND NAME = 'D5W'";
            //    var io_dt = obs_m.DBExecSQL(ioSql);
            //    if (io_dt != null && io_dt.Rows.Count > 0)
            //    {
            //        var itemid = io_dt.Rows[0]["ITEMID"].ToString();
            //        Insert_IO_DATA_ForOther(baby_feeno, form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "_2", "2", itemid, form["TXT_D5W"], "1", id + "_D5W", "OBS_PATNB");
            //    }
            //}
            //else if (ptinfo.Age < 1 && form["TXT_D5W"] != "")
            //{
            //    var ioSql = "SELECT * FROM IO_ITEM WHERE TYPEID = '2' AND NAME = 'D5W'";
            //    var io_dt = obs_m.DBExecSQL(ioSql);
            //    if (io_dt != null && io_dt.Rows.Count > 0)
            //    {
            //        var itemid = io_dt.Rows[0]["ITEMID"].ToString();
            //        Insert_IO_DATA(form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "_2", "2", itemid, form["TXT_D5W"], "1", id + "_D5W", "OBS_PATNB");
            //    }
            //}
            var ValueTXT_D5W = (form["TXT_D5W"] == "") ? "0" : form["TXT_D5W"];
            if (IsNoEmpty(baby_feeno))
            {
                var ioSql = "SELECT * FROM IO_ITEM WHERE TYPEID = '2' AND NAME = 'D5W'";
                var io_dt = obs_m.DBExecSQL(ioSql);
                if (io_dt != null && io_dt.Rows.Count > 0)
                {
                    var itemid = io_dt.Rows[0]["ITEMID"].ToString();
                    Insert_IO_DATA_ForOther(baby_feeno, form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "_2", "2", itemid, ValueTXT_D5W, "1", id + "_D5W", "OBS_PATNB");
                }
            }
            else if (ptinfo.Age < 1)
            {
                var ioSql = "SELECT * FROM IO_ITEM WHERE TYPEID = '2' AND NAME = 'D5W'";
                var io_dt = obs_m.DBExecSQL(ioSql);
                if (io_dt != null && io_dt.Rows.Count > 0)
                {
                    var itemid = io_dt.Rows[0]["ITEMID"].ToString();
                    Insert_IO_DATA(form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "_2", "2", itemid, ValueTXT_D5W, "1", id + "_D5W", "OBS_PATNB");
                }
            }
            //end 20200331 modified
            #endregion

            insertDataList.Add(new DBItem("DEF_FRQ", form["TXT_DEF_FRQ"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("DEF_COL", form["RB_DEF_COL"], DBItem.DBDataType.String));

            if (form["RB_DEF_COL"] != null && form["RB_DEF_COL"] == "99")
                insertDataList.Add(new DBItem("DEF_COL_OTH", form["TXT_DEF_COL_OTH"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("DEF_CHA", form["RB_DEF_CHA"], DBItem.DBDataType.String));
            if (form["RB_DEF_CHA"] != null && form["RB_DEF_CHA"] == "99")
                insertDataList.Add(new DBItem("DEF_CHA_OTH", form["TXT_DEF_CHA_OTH"], DBItem.DBDataType.String));

            #region 排便IO
            //20200331 modified ，輸入為空值，會放 value 0 到 IO
            //if (form["TXT_DEF_FRQ"] != "" && IsNoEmpty(baby_feeno))
            //{
            //    Insert_IO_DATA_ForOther(baby_feeno, form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "_12", "12", "", form["TXT_DEF_FRQ"], "5", id + "_DEF_FRQ", "OBS_PATNB");
            //    Insert_IO_Additional_forOther(baby_feeno, id + "_12", !string.IsNullOrWhiteSpace(form["RB_DEF_COL"]) ? form["RB_DEF_COL"]?.Trim() : "-1", form["TXT_DEF_COL_OTH"]?.Trim(), !string.IsNullOrWhiteSpace(form["RB_DEF_CHA"]) ? form["RB_DEF_CHA"]?.Trim() : "-1", form["TXT_DEF_CHA_OTH"]?.Trim(), "", "");
            //}
            //else if (ptinfo.Age < 1 && form["TXT_DEF_FRQ"] != "")
            //{
            //    Insert_IO_DATA(form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "_12", "12", "", form["TXT_DEF_FRQ"], "5", id + "_DEF_FRQ", "OBS_PATNB");
            //    Insert_IO_Additional(id + "_12", !string.IsNullOrWhiteSpace(form["RB_DEF_COL"]) ? form["RB_DEF_COL"]?.Trim() : "-1", form["TXT_DEF_COL_OTH"]?.Trim(), !string.IsNullOrWhiteSpace(form["RB_DEF_CHA"]) ? form["RB_DEF_CHA"]?.Trim() : "-1", form["TXT_DEF_CHA_OTH"]?.Trim(), "", "");
            //}
            var ValueTXT_DEF_FRQ = (form["TXT_DEF_FRQ"] == "") ? "0" : form["TXT_DEF_FRQ"];
            if (IsNoEmpty(baby_feeno))
            {
                Insert_IO_DATA_ForOther(baby_feeno, form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "_12", "12", "", ValueTXT_DEF_FRQ, "5", id + "_DEF_FRQ", "OBS_PATNB");
                Insert_IO_Additional_forOther(baby_feeno, id + "_12", !string.IsNullOrWhiteSpace(form["RB_DEF_COL"]) ? form["RB_DEF_COL"]?.Trim() : "-1", form["TXT_DEF_COL_OTH"]?.Trim(), !string.IsNullOrWhiteSpace(form["RB_DEF_CHA"]) ? form["RB_DEF_CHA"]?.Trim() : "-1", form["TXT_DEF_CHA_OTH"]?.Trim(), "", "");
            }
            else if (ptinfo.Age < 1)
            {
                Insert_IO_DATA(form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "_12", "12", "", ValueTXT_DEF_FRQ, "5", id + "_DEF_FRQ", "OBS_PATNB");
                Insert_IO_Additional(id + "_12", !string.IsNullOrWhiteSpace(form["RB_DEF_COL"]) ? form["RB_DEF_COL"]?.Trim() : "-1", form["TXT_DEF_COL_OTH"]?.Trim(), !string.IsNullOrWhiteSpace(form["RB_DEF_CHA"]) ? form["RB_DEF_CHA"]?.Trim() : "-1", form["TXT_DEF_CHA_OTH"]?.Trim(), "", "");
            }
            //end 20200331 modified
            #endregion

            insertDataList.Add(new DBItem("URI_FRQ", form["TXT_URI_FRQ"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("URI_COL", form["RB_URI_COL"], DBItem.DBDataType.String));
            if (form["RB_URI_COL"] != null && form["RB_URI_COL"] == "99")
                insertDataList.Add(new DBItem("URI_COL_OTH", form["TXT_URI_COL_OTH"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("URI_CHA", form["RB_URI_CHA"], DBItem.DBDataType.String));
            if (form["RB_URI_CHA"] != null && form["RB_URI_CHA"] == "99")
                insertDataList.Add(new DBItem("URI_CHA_OTH", form["TXT_URI_CHA_OTH"], DBItem.DBDataType.String));

            #region 排尿IO
            //20200331 modified ，輸入為空值，會放 value 0 到 IO
            //if (form["TXT_URI_FRQ"] != "" && IsNoEmpty(baby_feeno))
            //{
            //    Insert_IO_DATA_ForOther(baby_feeno, form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "_13", "13", "", form["TXT_URI_FRQ"], "5", id + "_URI_FRQ", "OBS_PATNB");
            //    Insert_IO_Additional_forOther(baby_feeno, id + "_13", !string.IsNullOrWhiteSpace(form["RB_URI_COL"]) ? form["RB_URI_COL"]?.Trim() : "-1", form["TXT_URI_COL_OTH"]?.Trim(), !string.IsNullOrWhiteSpace(form["RB_URI_CHA"]) ? form["RB_URI_CHA"]?.Trim() : "-1", form["TXT_URI_CHA_OTH"]?.Trim(), "", "");
            //}
            //else if (ptinfo.Age < 1 && form["TXT_URI_FRQ"] != "")
            //{
            //    Insert_IO_DATA(form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "_13", "13", "", form["TXT_URI_FRQ"], "5", id + "_URI_FRQ", "OBS_PATNB");
            //    Insert_IO_Additional(id + "_13", !string.IsNullOrWhiteSpace(form["RB_URI_COL"]) ? form["RB_URI_COL"]?.Trim() : "-1", form["TXT_URI_COL_OTH"]?.Trim(), !string.IsNullOrWhiteSpace(form["RB_URI_CHA"]) ? form["RB_URI_CHA"]?.Trim() : "-1", form["TXT_URI_CHA_OTH"]?.Trim(), "", "");
            //}
            var ValueTXT_URI_FRQ = (form["TXT_URI_FRQ"] == "") ? "0" : form["TXT_URI_FRQ"];
            if (IsNoEmpty(baby_feeno))
            {
                Insert_IO_DATA_ForOther(baby_feeno, form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "_13", "13", "", ValueTXT_URI_FRQ, "5", id + "_URI_FRQ", "OBS_PATNB");
                Insert_IO_Additional_forOther(baby_feeno, id + "_13", !string.IsNullOrWhiteSpace(form["RB_URI_COL"]) ? form["RB_URI_COL"]?.Trim() : "-1", form["TXT_URI_COL_OTH"]?.Trim(), !string.IsNullOrWhiteSpace(form["RB_URI_CHA"]) ? form["RB_URI_CHA"]?.Trim() : "-1", form["TXT_URI_CHA_OTH"]?.Trim(), "", "");
            }
            else if (ptinfo.Age < 1)
            {
                Insert_IO_DATA(form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "_13", "13", "", ValueTXT_URI_FRQ, "5", id + "_URI_FRQ", "OBS_PATNB");
                Insert_IO_Additional(id + "_13", !string.IsNullOrWhiteSpace(form["RB_URI_COL"]) ? form["RB_URI_COL"]?.Trim() : "-1", form["TXT_URI_COL_OTH"]?.Trim(), !string.IsNullOrWhiteSpace(form["RB_URI_CHA"]) ? form["RB_URI_CHA"]?.Trim() : "-1", form["TXT_URI_CHA_OTH"]?.Trim(), "", "");
            }
            //end 20200331 modified
            #endregion

            insertDataList.Add(new DBItem("TREAT", form["TXT_TREAT"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("CARE_RECORD", form["CK_CARE_RECORD"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("NB_CARE_RECORD", form["CK_NB_CARE_RECORD"], DBItem.DBDataType.String));

            insertDataList = setNullToEmpty(insertDataList);
            int erow = link.DBExecInsertTns("OBS_PATNB", insertDataList);

            List<SelectListItem> ColorList = this.cd.getSelectItem("io", "outputcolor_Drainage", "");
            List<SelectListItem> TypeList = this.cd.getSelectItem("io", "outputnature_Drainage", "");

            #region 轉護理記錄
            if (form["CK_CARE_RECORD"] == "1" || form["CK_NB_CARE_RECORD"] == "1")
            {
                var content = new List<string>();
                var semicolon = new List<string>();
                var field = "";
                var commaFlag = false;

                field = "#from#評估產婦";
                #region 乳房
                if (IsNoEmpty(form["CK_BREAST"]))
                {
                    field += "乳房";
                    var BREASTs = (form["CK_BREAST"] ?? "").Split(',');
                    var L_BREAST = new List<string>();
                    var R_BREAST = new List<string>();

                    foreach (var i in BREASTs)
                    {
                        if (Convert.ToInt32(i) < 5)
                            L_BREAST.Add(i);
                        else
                            R_BREAST.Add((Convert.ToInt32(i) - 5).ToString());
                    }

                    //左右相同
                    if (String.Join(",", L_BREAST) == String.Join(",", R_BREAST))
                    {
                        commaFlag = false;
                        foreach (var i in L_BREAST)
                        {
                            if (commaFlag)
                                field += "、";

                            switch (i)
                            {
                                case "0":
                                    field += "鬆軟";
                                    break;
                                case "1":
                                    field += "充盈";
                                    break;
                                case "2":
                                    field += "緊繃";
                                    break;
                                case "3":
                                    field += "腫脹";
                                    break;
                                case "4":
                                    field += "硬";
                                    break;
                                default:
                                    field += "";
                                    break;
                            }

                            commaFlag = true;
                        }
                    }
                    else
                    {
                        //左邊
                        commaFlag = false;
                        if (L_BREAST != null && L_BREAST.Count() > 0)
                        {
                            field += "左";
                            foreach (var i in L_BREAST)
                            {
                                if (commaFlag)
                                    field += "、";

                                switch (i)
                                {
                                    case "0":
                                        field += "鬆軟";
                                        break;
                                    case "1":
                                        field += "充盈";
                                        break;
                                    case "2":
                                        field += "緊繃";
                                        break;
                                    case "3":
                                        field += "腫脹";
                                        break;
                                    case "4":
                                        field += "硬";
                                        break;
                                    default:
                                        field += "";
                                        break;
                                }
                                commaFlag = true;
                            }
                        }
                        //右邊
                        commaFlag = false;
                        if (R_BREAST != null && R_BREAST.Count() > 0)
                        {
                            field += "、右";
                            foreach (var i in R_BREAST)
                            {
                                if (commaFlag)
                                    field += "、";

                                switch (i)
                                {
                                    case "0":
                                        field += "鬆軟";
                                        break;
                                    case "1":
                                        field += "充盈";
                                        break;
                                    case "2":
                                        field += "緊繃";
                                        break;
                                    case "3":
                                        field += "腫脹";
                                        break;
                                    case "4":
                                        field += "硬";
                                        break;
                                    default:
                                        field += "";
                                        break;
                                }
                                commaFlag = true;
                            }
                        }
                    }
                }
                if (IsNoEmpty(field))
                    content.Add(field);
                #endregion

                field = "";
                #region 乳頭
                if (IsNoEmpty(form["CK_NIPPLE"]))
                {
                    field = "乳頭";
                    var NIPPLEs = (form["CK_NIPPLE"] ?? "").Split(',');
                    var L_NIPPLE = new List<string>();
                    var R_NIPPLE = new List<string>();

                    foreach (var i in NIPPLEs)
                    {
                        if (Convert.ToInt32(i) < 8)
                            L_NIPPLE.Add(i);
                        else
                            R_NIPPLE.Add((Convert.ToInt32(i) - 8).ToString());
                    }

                    //左右相同
                    if (String.Join(",", L_NIPPLE) == String.Join(",", R_NIPPLE))
                    {
                        commaFlag = false;
                        foreach (var i in L_NIPPLE)
                        {
                            if (commaFlag)
                                field += "、";

                            switch (i)
                            {
                                case "0":
                                    field += "正常";
                                    break;
                                case "1":
                                    field += "凹";
                                    break;
                                case "2":
                                    field += "平";
                                    break;
                                case "3":
                                    field += "短";
                                    break;
                                case "4":
                                    field += "大";
                                    break;
                                case "5":
                                    field += "小";
                                    break;
                                case "6":
                                    field += "破皮";
                                    break;
                                case "7":
                                    field += "結痂";
                                    break;
                                default:
                                    field += "";
                                    break;
                            }

                            commaFlag = true;
                        }
                    }
                    else
                    {
                        //左邊
                        commaFlag = false;
                        if (L_NIPPLE != null && L_NIPPLE.Count() > 0)
                        {
                            field += "左";
                            foreach (var i in L_NIPPLE)
                            {
                                if (commaFlag)
                                    field += "、";

                                switch (i)
                                {
                                    case "0":
                                        field += "正常";
                                        break;
                                    case "1":
                                        field += "凹";
                                        break;
                                    case "2":
                                        field += "平";
                                        break;
                                    case "3":
                                        field += "短";
                                        break;
                                    case "4":
                                        field += "大";
                                        break;
                                    case "5":
                                        field += "小";
                                        break;
                                    case "6":
                                        field += "破皮";
                                        break;
                                    case "7":
                                        field += "結痂";
                                        break;
                                    default:
                                        field += "";
                                        break;
                                }
                                commaFlag = true;
                            }
                        }
                        //右邊
                        commaFlag = false;
                        if (R_NIPPLE != null && R_NIPPLE.Count() > 0)
                        {
                            field += "、右";
                            foreach (var i in R_NIPPLE)
                            {
                                if (commaFlag)
                                    field += "、";

                                switch (i)
                                {
                                    case "0":
                                        field += "正常";
                                        break;
                                    case "1":
                                        field += "凹";
                                        break;
                                    case "2":
                                        field += "平";
                                        break;
                                    case "3":
                                        field += "短";
                                        break;
                                    case "4":
                                        field += "大";
                                        break;
                                    case "5":
                                        field += "小";
                                        break;
                                    case "6":
                                        field += "破皮";
                                        break;
                                    case "7":
                                        field += "結痂";
                                        break;
                                    default:
                                        field += "";
                                        break;
                                }
                                commaFlag = true;
                            }
                        }
                    }
                }
                if (IsNoEmpty(field))
                    content.Add(field);
                #endregion

                #region 泌乳
                field = "";
                //左右相同
                if (form["RB_LACT_L"] == form["RB_LACT_R"] && IsNoEmpty(form["RB_LACT_L"]) && IsNoEmpty(form["RB_LACT_L"]))
                {
                    field = "乳汁";
                    switch ((form["RB_LACT_L"] ?? "").ToString())
                    {
                        case "0":
                            field += "無分泌";
                            break;
                        case "1":
                            field += "微泌乳";
                            break;
                        case "2":
                            field += "已分泌";
                            break;
                        default:
                            field += "";
                            break;
                    }
                }
                else
                {
                    //左
                    if (IsNoEmpty(form["RB_LACT_L"]))
                    {
                        field += "左";
                        switch ((form["RB_LACT_L"] ?? "").ToString())
                        {
                            case "0":
                                field += "無分泌";
                                break;
                            case "1":
                                field += "微泌乳";
                                break;
                            case "2":
                                field += "已分泌";
                                break;
                            default:
                                field += "";
                                break;
                        }
                    }

                    //右
                    if (IsNoEmpty(form["RB_LACT_R"]))
                    {
                        field += $"{(IsNoEmpty(form["RB_LACT_L"]) ? "、" : "")}右";
                        switch ((form["RB_LACT_R"] ?? "").ToString())
                        {
                            case "0":
                                field += "無分泌";
                                break;
                            case "1":
                                field += "微泌乳";
                                break;
                            case "2":
                                field += "已分泌";
                                break;
                            default:
                                field += "";
                                break;
                        }
                    }
                }
                if (IsNoEmpty(field))
                    content.Add(field);
                #endregion

                if (content.Count() > 0)
                    semicolon.Add(String.Join("，", content));
                content = new List<string>();
                field = "";

                #region 嬰兒[嬰兒生理評估 清醒]
                if (IsNoEmpty(form["RB_AWAKE"]) || IsNoEmpty(form["RB_BRE_TYP"]) || IsNoEmpty(form["RB_SKIN"]) || IsNoEmpty(form["RB_MUSCLE"]) || IsNoEmpty(form["RB_ACTI"]))
                    field = "嬰兒";
                switch ((form["RB_AWAKE"] ?? "").ToString())
                {
                    case "0":
                        field += "警醒";
                        break;
                    case "1":
                        field += "睡覺";
                        break;
                    case "2":
                        field += "哭鬧";
                        break;
                    default:
                        field += "";
                        break;
                }
                if (IsNoEmpty(field))
                    content.Add(field);
                #endregion

                #region 呼吸[嬰兒生理評估 呼吸型態]
                field = "";
                switch ((form["RB_BRE_TYP"] ?? "").ToString())
                {
                    case "0":
                        field += "呼吸順暢";
                        break;
                    case "1":
                        field += "呼吸胸骨凹陷";
                        break;
                    case "2":
                        field += "呼吸困難";
                        break;
                    default:
                        field += "";
                        break;
                }
                if (IsNoEmpty(field))
                    content.Add(field);
                #endregion

                #region 膚色[嬰兒生理評估 膚色]
                field = "";
                switch ((form["RB_SKIN"] ?? "").ToString())
                {
                    case "0":
                        field += "膚色粉紅";
                        break;
                    case "1":
                        field += "膚色蒼白";
                        break;
                    case "2":
                        field += "膚色發紺";
                        break;
                    default:
                        field += "";
                        break;
                }
                if (IsNoEmpty(field))
                    content.Add(field);
                #endregion

                #region 肌肉張力[嬰兒生理評估 肌肉張力]
                field = "";
                switch ((form["RB_MUSCLE"] ?? "").ToString())
                {
                    case "0":
                        field += "肌肉張力佳";
                        break;
                    case "1":
                        field += "肌肉張力中";
                        break;
                    case "2":
                        field += "肌肉張力弱";
                        break;
                    default:
                        field += "";
                        break;
                }
                if (IsNoEmpty(field))
                    content.Add(field);
                #endregion

                #region 活動力[嬰兒生理評估 活動力]
                field = "";
                switch ((form["RB_ACTI"] ?? "").ToString())
                {
                    case "0":
                        field += "活動力強";
                        break;
                    case "1":
                        field += "活動力中";
                        break;
                    case "2":
                        field += "活動力弱";
                        break;
                    default:
                        field += "";
                        break;
                }
                if (IsNoEmpty(field))
                    content.Add(field);
                #endregion
                if (content.Count() > 0)
                    semicolon.Add(String.Join("，", content));
                content = new List<string>();
                field = "";

                #region 觀察嬰兒[嬰兒會尋找乳房(是 / 飢餓時會尋找乳房、否 / 不呈現)]
                field = "";
                commaFlag = false;
                switch ((form["RB_BRE_RES2"] ?? "").ToString())
                {
                    case "0":
                        field += "";
                        break;
                    case "1":
                        commaFlag = true;
                        field += "觀察嬰兒飢餓時會尋找乳房";
                        break;
                    default:
                        field += "";
                        break;
                }
                #endregion

                #region [嬰兒接觸乳房時平靜而清醒(是 / 情緒平穩、否 / 哭泣)]
                if (commaFlag)
                    field += "、";

                if (IsNoEmpty(form["RB_BRE_RES3"]))
                {
                    field += "觀察嬰兒";

                    switch ((form["RB_BRE_RES3"] ?? "").ToString())
                    {
                        case "0":
                            field += "哭泣";
                            break;
                        case "1":
                            field += "情緒平穩";
                            break;
                        default:
                            field += "";
                            break;
                    }

                    content.Add(field);
                    #endregion
                    if (content.Count() > 0)
                        semicolon.Add(String.Join("，", content));
                }

                content = new List<string>();
                field = "";
                commaFlag = false;

                if (IsNoEmpty(form["TXT_BRE_MLK"]))
                {
                    #region 哺餵母乳時，產婦身體姿勢[母親放鬆而舒服(是 / 放鬆、否 / 緊繃)]
                    field = "";
                    switch ((form["RB_BRE_BP1"] ?? "").ToString())
                    {
                        case "0":
                            field += "緊繃";
                            break;
                        case "1":
                            field += "放鬆";
                            break;
                        default:
                            field += "";
                            break;
                    }
                    if (IsNoEmpty(field))
                        content.Add(field);
                    #endregion

                    #region [嬰兒身體緊貼母親，臉朝向乳房(是 / 嬰兒身體緊貼母親，臉朝向乳房、否 / 不 呈現)]
                    field = "";
                    switch ((form["RB_BRE_BP2"] ?? "").ToString())
                    {
                        case "0":
                            field += "";
                            break;
                        case "1":
                            field += "嬰兒身體緊貼母親，臉朝向乳房";
                            break;
                        default:
                            field += "";
                            break;
                    }
                    if (IsNoEmpty(field))
                        content.Add(field);
                    #endregion

                    #region [嬰兒頭部及身體呈一直線(是 / 頭部及身體一直線、否 / 嬰兒頭部及身體扭轉)]
                    field = "";
                    switch ((form["RB_BRE_BP3"] ?? "").ToString())
                    {
                        case "0":
                            field += "嬰兒頭部及身體扭轉";
                            break;
                        case "1":
                            field += "頭部及身體一直線";
                            break;
                        default:
                            field += "";
                            break;
                    }
                    if (IsNoEmpty(field))
                        content.Add(field);
                    #endregion

                    #region [嬰兒下巴貼著乳房(是 / 下巴貼著乳房、否 / 下巴未貼著乳房)]
                    field = "";
                    switch ((form["RB_BRE_BP4"] ?? "").ToString())
                    {
                        case "0":
                            field += "下巴未貼著乳房";
                            break;
                        case "1":
                            field += "下巴貼著乳房";
                            break;
                        default:
                            field += "";
                            break;
                    }
                    if (IsNoEmpty(field))
                        content.Add(field);
                    #endregion

                    #region [嬰兒臀部受支撐(是 / 臀部有支撐、否 / 不呈現)]
                    field = "";
                    switch ((form["RB_BRE_BP5"] ?? "").ToString())
                    {
                        case "0":
                            field += "";
                            break;
                        case "1":
                            field += "臀部有支撐";
                            break;
                        default:
                            field += "";
                            break;
                    }
                    if (IsNoEmpty(field))
                        content.Add(field);
                    #endregion
                }

                #region [嬰兒嘴巴張大(是 / 吸吮時嘴巴有張大、否 / 嘴巴僅含著乳頭)] 
                field = "";
                switch ((form["RB_BRE_SUC1"] ?? "").ToString())
                {
                    case "0":
                        field += "嘴巴僅含著乳頭";
                        break;
                    case "1":
                        field += "吸吮時嘴巴有張大";
                        break;
                    default:
                        field += "";
                        break;
                }
                if (IsNoEmpty(field))
                    content.Add(field);
                #endregion

                #region [下唇外翻(是 / 下唇外翻、否 / 下唇未外翻)]
                field = "";
                switch ((form["RB_BRE_SUC2"] ?? "").ToString())
                {
                    case "0":
                        field += "下唇未外翻";
                        break;
                    case "1":
                        field += "下唇外翻";
                        break;
                    default:
                        field += "";
                        break;
                }
                if (IsNoEmpty(field))
                    content.Add(field);
                #endregion

                #region [嬰兒嘴巴上方乳暈較多(是 / 嘴巴上方乳暈較多、否 / 未含上乳暈)]
                field = "";
                switch ((form["RB_BRE_SUC3"] ?? "").ToString())
                {
                    case "0":
                        field += "未含上乳暈";
                        break;
                    case "1":
                        field += "嘴巴上方乳暈較多";
                        break;
                    default:
                        field += "";
                        break;
                }
                if (IsNoEmpty(field))
                    content.Add(field);
                #endregion

                #region [慢慢的深吸奶，一陣子後間隔有休息(是 / 慢而深吸奶，一陣子後間隔有休息、否 / 吸吮急促)]
                field = "";
                switch ((form["RB_BRE_SUC4"] ?? "").ToString())
                {
                    case "0":
                        field += "吸吮急促";
                        break;
                    case "1":
                        field += "慢而深吸奶，一陣子後間隔有休息";
                        break;
                    default:
                        field += "";
                        break;
                }
                if (IsNoEmpty(field))
                    content.Add(field);
                #endregion

                #region [可看到或聽到吞嚥(是 / 可看到或聽到吞嚥、否 / 不呈現)]
                field = "";
                switch ((form["RB_BRE_SUC5"] ?? "").ToString())
                {
                    case "0":
                        field += "";
                        break;
                    case "1":
                        field += "可看到或聽到吞嚥";
                        break;
                    default:
                        field += "";
                        break;
                }
                if (IsNoEmpty(field))
                    content.Add(field);
                #endregion

                #region [嬰兒自己鬆開乳房(是 / 喝飽後嬰兒自己鬆開乳房、否 / 不呈現)]
                field = "";
                switch ((form["RB_BRE_TSS1"] ?? "").ToString())
                {
                    case "0":
                        field += "";
                        break;
                    case "1":
                        field += "喝飽後嬰兒自己鬆開乳房";
                        break;
                    default:
                        field += "";
                        break;
                }
                if (IsNoEmpty(field))
                    content.Add(field);
                #endregion

                if (content.Count() > 0)
                    semicolon.Add("哺餵母乳時，產婦身體姿勢" + String.Join("，", content));

                content = new List<string>();
                field = "";
                commaFlag = false;

                #region 吸吮[嬰兒吸吮母乳時間] 分鐘。嬰兒自解{ [排便 次數] 次[排便 顏色][排便 軟便]
                field = "#嬰兒吸吮母乳時間#";
                #endregion

                #region [排尿 次數] 次[排尿 顏色] 尿液
                if (IsNoEmpty(form["TXT_URI_FRQ"]))
                {
                    field += $"{(IsNoEmpty(form["TXT_URI_FRQ"]) == true ? form["TXT_URI_FRQ"] : "0")}次";

                    var URIColor = ColorList.Where(x => x.Value == form["RB_URI_COL"].ToString()).Select(x => x.Text).FirstOrDefault();
                    var URIType = TypeList.Where(x => x.Value == form["RB_URI_CHA"].ToString()).Select(x => x.Text).FirstOrDefault();

                    if (URIColor.Trim() != "請選擇(色)")
                    {
                        if (URIColor.Trim() == "其他")
                            field += form["TXT_URI_COL_OTH"];
                        else
                            field += URIColor;
                    }
                    if (URIColor.Trim() != "請選擇(性質)")
                    {
                        if (URIType.Trim() == "其他")
                            field += form["TXT_URI_CHA_OTH"];
                        else
                            field += URIType;
                    }

                    field += "尿液。";
                }

                if (IsNoEmpty(form["TXT_TREAT"]))
                    field += $"{form["TXT_TREAT"]}";

                if (IsNoEmpty(field))
                    content.Add(field);
                #endregion

                if (content.Count() > 0)
                    semicolon.Add(String.Join("，", content));

                var result = String.Join("；", semicolon);
                field = "";

                //小孩帶護理紀錄
                if (form["CK_NB_CARE_RECORD"] == "1")
                {
                    bool iscommaFlag = false;
                    field = "";
                    if (IsNoEmpty(form["TXT_BRE_MLK"]))
                    {
                        field = $"{(IsNoEmpty(form["TXT_BRE_TSS2"]) == true ? $"吸吮{form["TXT_BRE_TSS2"]}分鐘，" : "")}";
                    }
                    if (IsNoEmpty(form["TXT_WATER"]))
                    {
                        field += $"餵食開水量{(IsNoEmpty(form["TXT_WATER"]) == true ? form["TXT_WATER"] : "0")}mL";
                        iscommaFlag = true;
                    }
                    if (IsNoEmpty(form["TXT_BRE_MLK"]))
                    {
                        if (iscommaFlag)
                            field += "、";
                        field += $"母乳量{(IsNoEmpty(form["TXT_BRE_MLK"]) == true ? form["TXT_BRE_MLK"] : "0")}mL";
                        iscommaFlag = true;
                    }
                    if (IsNoEmpty(form["TXT_MILK"]))
                    {
                        if (iscommaFlag)
                            field += "、";
                        field += $"配方奶量{(IsNoEmpty(form["TXT_MILK"]) == true ? form["TXT_MILK"] : "0")}mL";
                        iscommaFlag = true;
                    }
                    if (IsNoEmpty(form["TXT_D5W"]))
                    {
                        if (iscommaFlag)
                            field += "、";
                        field += $"D5W量{(IsNoEmpty(form["TXT_D5W"]) == true ? form["TXT_D5W"] : "0")}mL。";
                        iscommaFlag = true;
                    }

                    if (IsNoEmpty(form["TXT_DEF_FRQ"]))
                    {
                        field += $"嬰兒自解{(IsNoEmpty(form["TXT_DEF_FRQ"]) == true ? form["TXT_DEF_FRQ"] : "0")}次";

                        var DEFColor = ColorList.Where(x => x.Value == form["RB_DEF_COL"].ToString()).Select(x => x.Text).FirstOrDefault();
                        var DEFType = TypeList.Where(x => x.Value == form["RB_DEF_CHA"].ToString()).Select(x => x.Text).FirstOrDefault();

                        if (DEFColor.Trim() != "請選擇(色)")
                        {
                            if (DEFColor.Trim() == "其他")
                                field += form["TXT_DEF_COL_OTH"];
                            else
                                field += DEFColor;
                        }
                        if (DEFColor.Trim() != "請選擇(性質)")
                        {
                            if (DEFType.Trim() == "其他")
                                field += form["TXT_DEF_CHA_OTH"];
                            else
                                field += DEFType;
                        }
                    }

                    result = String.Join("；", semicolon).Replace("#嬰兒吸吮母乳時間#", field) + "。";
                    result = result.Replace("。。", "。");

                    //小孩給小孩
                    if (ptinfo?.Age < 1)
                    {
                        result = result.Replace("#from#", "");
                        if (result.IndexOf("評估產婦；") >= 0)
                            result = result.Replace("評估產婦；", "");
                        if (result.Trim() == "。")
                            result = "";
                        if (result != "")
                        {
                            erow += base.Insert_CareRecordTns(form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "NB", "母嬰護理及飲食排泄紀錄", result, "", "", "", "", "OBS_PATNB", ref link);
                        }
                    }
                    //媽媽給小孩
                    else
                    {
                        if (IsNoEmpty(baby_feeno))
                        {
                            //新增小孩的
                            result = result.Replace("#from#", "");
                            if (result.IndexOf("評估產婦；") >= 0)
                                result = result.Replace("評估產婦；", "");
                            if (result.Trim() == "。")
                                result = "";

                            if (result != "")
                            {
                                erow += Insert_CareRecord_ForOtherTns(baby_feeno, form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "NB", "母嬰護理及飲食排泄紀錄", result, "", "", "", "", "OBS_PATNB", ref link);
                            }
                        }
                    }
                }
                //媽媽帶護理紀錄
                if (form["CK_CARE_RECORD"] == "1")
                {
                    field = "";
                    if (IsNoEmpty(form["TXT_BRE_TSS2"]))
                    {
                        field = $"{(IsNoEmpty(form["TXT_BRE_TSS2"]) == true ? $"吸吮{form["TXT_BRE_TSS2"]}分鐘。" : "")}";
                    }

                    if (IsNoEmpty(form["TXT_DEF_FRQ"]))
                    {
                        field += $"嬰兒自解{(IsNoEmpty(form["TXT_DEF_FRQ"]) == true ? form["TXT_DEF_FRQ"] : "0")}次";

                        var DEFColor = ColorList.Where(x => x.Value == form["RB_DEF_COL"].ToString()).Select(x => x.Text).FirstOrDefault();
                        var DEFType = TypeList.Where(x => x.Value == form["RB_DEF_CHA"].ToString()).Select(x => x.Text).FirstOrDefault();

                        if (DEFColor.Trim() != "請選擇(色)")
                        {
                            if (DEFColor.Trim() == "其他")
                                field += form["TXT_DEF_COL_OTH"];
                            else
                                field += DEFColor;
                        }
                        if (DEFColor.Trim() != "請選擇(性質)")
                        {
                            if (DEFType.Trim() == "其他")
                                field += form["TXT_DEF_CHA_OTH"];
                            else
                                field += DEFType;
                        }
                    }

                    result = String.Join("；", semicolon).Replace("#嬰兒吸吮母乳時間#", field) + "。";
                    result = result.Replace("。。", "。");
                    //小孩給媽媽的護理紀錄
                    if (ptinfo?.Age < 1)
                    {
                        DataTable dt = obs_m.sel_nbcha(ptinfo?.FeeNo);
                        if (dt != null && dt.Rows.Count > 0)
                        {
                            byte[] listByteCode = webService.GetPatientInfo(dt.Rows[0]["MOM_FEE_NO"].ToString());
                            if (listByteCode != null)
                            {
                                string listJsonArray = CompressTool.DecompressString(listByteCode);
                                PatientInfo mom = JsonConvert.DeserializeObject<PatientInfo>(listJsonArray);
                                DataTable mom_nb_dt = obs_m.sel_nb(mom.FeeNo, ptinfo?.ChartNo);
                                if (mom_nb_dt != null && mom_nb_dt.Rows.Count > 0)
                                    result = result.Replace("#from#", $"{mom.PatientName}{dt.Rows[0]["BABY_SEQ"].ToString()}{mom_nb_dt.Rows[0]["GENDER"]}");
                                result = result.Replace("#from#", "");
                                //新增媽媽的
                                if (result.IndexOf("評估產婦；") >= 0)
                                    result = result.Replace("評估產婦；", "");
                                if (result.Trim() == "。")
                                    result = "";
                                if (result != "")
                                {
                                    erow += Insert_CareRecord_ForOtherTns(mom.FeeNo, form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "PAT", "母嬰護理及飲食排泄紀錄", result, "", "", "", "", "OBS_PATNB", ref link);
                                }
                            }
                        }
                    }
                    //媽媽給媽媽
                    else
                    {
                        result = result.Replace("#from#", "");
                        if (result.IndexOf("評估產婦；") >= 0)
                            result = result.Replace("評估產婦；", "");
                        if (result.Trim() == "。")
                            result = "";
                        if (result != "")
                        {
                            erow += base.Insert_CareRecordTns(form["RECORDTIME_DAY"] + " " + form["RECORDTIME_TIME"], id + "PAT", $"母嬰護理及飲食排泄紀錄-新生兒{baby_seq}", result, "", "", "", "", "OBS_PATNB", ref link);
                        }
                    }
                }
            }
            #endregion

            //配方奶計價
            if (milkID != "" && milkID != null)
            {
                int DefaultCapacity = 0;
                int capacity = 0;
                int UsageCapacity = 0;
                string startTime = DateTime.Now.ToString("yyyy/MM/dd 00:00:00");
                string endTime = DateTime.Now.ToString("yyyy/MM/dd 23:59:59");


                string sql = "SELECT * FROM NIS_MILK_LOG WHERE MILK_ID = '" + milkID + "' AND FEENO = '" + feeno + "' AND STATUS = 'Y' AND RECORD_TIME BETWEEN TO_DATE('"+ startTime + "','yyyy/MM/dd HH24:mi:ss') AND TO_DATE('"+ endTime + "','yyyy/MM/dd HH24:mi:ss')";
                DataTable dt = new DataTable();
                link.DBExecSQL(sql, ref dt);

                if (form["TXT_MILK"].ToString() != "")
                {
                    UsageCapacity = int.Parse(form["TXT_MILK"].ToString());
                }
                //取得已使用的配方奶紀錄
                if (dt.Rows.Count> 0)
                {
                    capacity = int.Parse(dt.Rows[0]["MILK_CAPACITY"].ToString());
                }
                //取得配方奶對應計價碼
                string ho_id = "";
                string unit = "";
                sql = "SELECT * FROM OBS_NBFORMULA WHERE IID = '" + milkID + "' AND DELETED IS NULL";
                DataTable dtMilk = new DataTable();
                link.DBExecSQL(sql, ref dtMilk);
                if (dtMilk.Rows.Count > 0)
                {
                    ho_id = dtMilk.Rows[0]["HO_ID"].ToString();
                    unit = dtMilk.Rows[0]["UNIT"].ToString();
                    if(unit == "瓶")
                    {
                        DefaultCapacity = int.Parse(dtMilk.Rows[0]["CAPACITY"].ToString());
                    }
                }
                if(unit == "瓶")
                {
                    //如果相減小於0 或是沒有紀錄 計一瓶
                    if (capacity - UsageCapacity < 0 || dt.Rows.Count <= 0)
                    {
                        List<Bill_RECORD> billDataList = new List<Bill_RECORD>();
                        Bill_RECORD billData = new Bill_RECORD();
                        billData.HO_ID = ho_id;
                        billData.COUNT = "1";
                        billDataList.Add(billData);

                        SaveBillingRecord(billDataList);
                    }
                }
                else if (unit == "天")
                {
                    //如果相減小於0 或是沒有紀錄 計一瓶
                    if (dt.Rows.Count <= 0)
                    {
                        List<Bill_RECORD> billDataList = new List<Bill_RECORD>();
                        Bill_RECORD billData = new Bill_RECORD();
                        billData.HO_ID = ho_id;
                        billData.COUNT = "1";
                        billDataList.Add(billData);

                        SaveBillingRecord(billDataList);
                    }
                }

                //配方奶寫log
                int RemainingCapacity = capacity - UsageCapacity;
                int newCapacity = 0;
                string serial = creatid("MILK_LOG", userno, feeno, "0");


                if (RemainingCapacity < 0)
                {
                    newCapacity = DefaultCapacity + RemainingCapacity;
                }
                else
                {
                    newCapacity = RemainingCapacity;
                }

                insertDataList.Clear();
                insertDataList.Add(new DBItem("STATUS", "D", DBItem.DBDataType.String));
                erow = link.DBExecUpdate("NIS_MILK_LOG", insertDataList,"MILK_ID = '"+milkID+"' AND FEENO = '"+feeno+"'");



                insertDataList.Clear();
                insertDataList.Add(new DBItem("SERIAL", serial, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("CHARTNO", ptinfo.ChartNo, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("FEENO", ptinfo.FeeNo, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("CREATE_NO", userno, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("RECORD_TIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime));
                insertDataList.Add(new DBItem("MILK_ID", milkID, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("MILK_NAME", form["TXT_MILK_BD"].ToString(), DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("MILK_CAPACITY", newCapacity.ToString(), DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("STATUS", "Y", DBItem.DBDataType.String));

                erow = link.DBExecInsert("NIS_MILK_LOG", insertDataList);
            }


            if (erow >= 1)
            {
                link.DBCommit();
                Response.Write("<script>alert('新增成功');window.opener.location.href='Index?active=Breast_Fedding_List&show=Y';window.close();</script>");
            }
            else
            {
                link.DBRollBack();
                Response.Write("<script>alert('新增失敗');window.opener.location.href='Index?active=Breast_Fedding_List&show=Y';window.close();</script>");
            }

            return new EmptyResult();
        }
        #endregion

        #region 哺餵照護紀錄編輯
        [HttpPost]
        public ActionResult Upd_Breast_Fedding(FormCollection form)
        {
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo.FeeNo;
            string[] id_list = form["IID"].Split(',');
            int erow = 0;
            for (int v = 0; v < id_list.Length; v++)
            {
                List<DBItem> insertDataList = new List<DBItem>();
                var baby_feeno = IsNoEmpty(form["RB_NB_FEENO" + id_list[v]]) == true ? form["RB_NB_FEENO" + id_list[v]].Split(',')[2] : "";
                var baby_seq = IsNoEmpty(form["RB_NB_FEENO" + id_list[v]]) == true ? form["RB_NB_FEENO" + id_list[v]].Split(',')[0] : "";

                insertDataList.Add(new DBItem("UPDNO", userno, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("UPDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime));
                if (form["RECORDTIME_DAY" + id_list[v]] != "" && form["RECORDTIME_DAY" + id_list[v]] != null && form["RECORDTIME_TIME" + id_list[v]] != "" && form["RECORDTIME_TIME" + id_list[v]] != null)
                    insertDataList.Add(new DBItem("RECORDTIME", form["RECORDTIME_DAY" + id_list[v]] + " " + form["RECORDTIME_TIME" + id_list[v]], DBItem.DBDataType.DataTime)); //紀錄時間

                var NIPPLE = form["CK_NIPPLE" + id_list[v]];
                var NIPPLEV = new List<string>() { "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0" };
                if (NIPPLE == null)
                    insertDataList.Add(new DBItem("NIPPLE", String.Join("", NIPPLEV), DBItem.DBDataType.String));
                else
                {
                    var NIPPLE_SP = NIPPLE.Split(',');
                    foreach (var i in NIPPLE_SP)
                        NIPPLEV[Convert.ToInt32(i)] = "1";
                    insertDataList.Add(new DBItem("NIPPLE", String.Join("", NIPPLEV), DBItem.DBDataType.String));
                }

                var BREAST = form["CK_BREAST" + id_list[v]];
                var BREASTV = new List<string>() { "0", "0", "0", "0", "0", "0", "0", "0", "0", "0" };
                if (BREAST == null)
                    insertDataList.Add(new DBItem("BREAST", String.Join("", BREASTV), DBItem.DBDataType.String));
                else
                {
                    var BREAST_SP = BREAST.Split(',');
                    foreach (var i in BREAST_SP)
                        BREASTV[Convert.ToInt32(i)] = "1";
                    insertDataList.Add(new DBItem("BREAST", String.Join("", BREASTV), DBItem.DBDataType.String));
                }

                var LACT_L = form["RB_LACT_L" + id_list[v]];
                insertDataList.Add(new DBItem("LACT_L", LACT_L, DBItem.DBDataType.String));
                if (LACT_L == "2")
                    insertDataList.Add(new DBItem("LACT_LAMT", form["TXT_LACT_LAMT" + id_list[v]], DBItem.DBDataType.String));
                else
                    insertDataList.Add(new DBItem("LACT_LAMT", null, DBItem.DBDataType.String));

                var LACT_R = form["RB_LACT_R" + id_list[v]];
                insertDataList.Add(new DBItem("LACT_R", LACT_R, DBItem.DBDataType.String));
                if (LACT_R == "2")
                    insertDataList.Add(new DBItem("LACT_RAMT", form["TXT_LACT_RAMT" + id_list[v]], DBItem.DBDataType.String));
                else
                    insertDataList.Add(new DBItem("LACT_RAMT", null, DBItem.DBDataType.String));

                //insertDataList.Add(new DBItem("NB_SEQ_FEENO", form["RB_NB_FEENO"], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("AWAKE", form["RB_AWAKE" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("BRE_TYP", form["RB_BRE_TYP" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("SKIN", form["RB_SKIN" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("MUSCLE", form["RB_MUSCLE" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("ACTI", form["RB_ACTI" + id_list[v]], DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("BRE_BP1", form["RB_BRE_BP1" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("BRE_BP2", form["RB_BRE_BP2" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("BRE_BP3", form["RB_BRE_BP3" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("BRE_BP4", form["RB_BRE_BP4" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("BRE_BP5", form["RB_BRE_BP5" + id_list[v]], DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("BRE_RES1", form["RB_BRE_RES1" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("BRE_RES2", form["RB_BRE_RES2" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("BRE_RES3", form["RB_BRE_RES3" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("BRE_RES4", form["RB_BRE_RES4" + id_list[v]], DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("BRE_EB1", form["RB_BRE_EB1" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("BRE_EB2", form["RB_BRE_EB2" + id_list[v]], DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("BRE_ANA1", form["RB_BRE_ANA1" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("BRE_ANA2", form["RB_BRE_ANA2" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("BRE_ANA3", form["RB_BRE_ANA3" + id_list[v]], DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("BRE_SUC1", form["RB_BRE_SUC1" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("BRE_SUC2", form["RB_BRE_SUC2" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("BRE_SUC3", form["RB_BRE_SUC3" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("BRE_SUC4", form["RB_BRE_SUC4" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("BRE_SUC5", form["RB_BRE_SUC5" + id_list[v]], DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("BRE_TSS1", form["RB_BRE_TSS1" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("BRE_TSS2", form["TXT_BRE_TSS2" + id_list[v]], DBItem.DBDataType.String));
                #region 含乳時間IO
                if (form["TXT_BRE_TSS2" + id_list[v]] != "" && IsNoEmpty(baby_feeno))
                {
                    Update_IO_DATA_ForOther(baby_feeno, form["RECORDTIME_DAY" + id_list[v]] + " " + form["RECORDTIME_TIME" + id_list[v]], id_list[v] + "_11", "11", "", form["TXT_BRE_TSS2" + id_list[v]], "4", id_list[v] + "_BRE_TSS2", "OBS_PATNB");
                }
                else if (ptinfo.Age < 1 && form["TXT_BRE_TSS2" + id_list[v]] != "")
                {
                    Update_IO_DATA(form["RECORDTIME_DAY" + id_list[v]] + " " + form["RECORDTIME_TIME" + id_list[v]], id_list[v] + "_11", "11", "", form["TXT_BRE_TSS2" + id_list[v]], "4", id_list[v] + "_BRE_TSS2", "OBS_PATNB");
                }
                #endregion

                insertDataList.Add(new DBItem("WATER", form["TXT_WATER" + id_list[v]], DBItem.DBDataType.String));
                #region 水IO
                if (form["TXT_WATER" + id_list[v]] != "" && IsNoEmpty(baby_feeno))
                {
                    var ioSql = "SELECT * FROM IO_ITEM WHERE TYPEID = '2' AND NAME = '水'";
                    var io_dt = obs_m.DBExecSQL(ioSql);
                    if (io_dt != null && io_dt.Rows.Count > 0)
                    {
                        var itemid = io_dt.Rows[0]["ITEMID"].ToString();
                        Update_IO_DATA_ForOther(baby_feeno, form["RECORDTIME_DAY" + id_list[v]] + " " + form["RECORDTIME_TIME" + id_list[v]], id_list[v] + "_2", "2", itemid, form["TXT_WATER" + id_list[v]], "1", id_list[v] + "_WATER", "OBS_PATNB");
                    }
                }
                else if (ptinfo.Age < 1 && form["TXT_WATER" + id_list[v]] != "")
                {
                    var ioSql = "SELECT * FROM IO_ITEM WHERE TYPEID = '2' AND NAME = '水'";
                    var io_dt = obs_m.DBExecSQL(ioSql);
                    if (io_dt != null && io_dt.Rows.Count > 0)
                    {
                        var itemid = io_dt.Rows[0]["ITEMID"].ToString();
                        Update_IO_DATA(form["RECORDTIME_DAY" + id_list[v]] + " " + form["RECORDTIME_TIME" + id_list[v]], id_list[v] + "_2", "2", itemid, form["TXT_WATER" + id_list[v]], "1", id_list[v] + "_WATER", "OBS_PATNB");
                    }
                }
                #endregion
                insertDataList.Add(new DBItem("BRE_MLK", form["TXT_BRE_MLK" + id_list[v]], DBItem.DBDataType.String));
                #region 母乳IO
                if (form["TXT_BRE_MLK" + id_list[v]] != "" && IsNoEmpty(baby_feeno))
                {
                    var ioSql = "SELECT * FROM IO_ITEM WHERE TYPEID = '2' AND NAME = '母奶'";
                    var io_dt = obs_m.DBExecSQL(ioSql);
                    if (io_dt != null && io_dt.Rows.Count > 0)
                    {
                        var itemid = io_dt.Rows[0]["ITEMID"].ToString();
                        Update_IO_DATA_ForOther(baby_feeno, form["RECORDTIME_DAY" + id_list[v]] + " " + form["RECORDTIME_TIME" + id_list[v]], id_list[v] + "_2", "2", itemid, form["TXT_BRE_MLK" + id_list[v]], "1", id_list[v] + "_BRE_MLK", "OBS_PATNB");
                    }
                }
                else if (ptinfo.Age < 1 && form["TXT_BRE_MLK" + id_list[v]] != "")
                {
                    var ioSql = "SELECT * FROM IO_ITEM WHERE TYPEID = '2' AND NAME = '母奶'";
                    var io_dt = obs_m.DBExecSQL(ioSql);
                    if (io_dt != null && io_dt.Rows.Count > 0)
                    {
                        var itemid = io_dt.Rows[0]["ITEMID"].ToString();
                        Update_IO_DATA(form["RECORDTIME_DAY" + id_list[v]] + " " + form["RECORDTIME_TIME" + id_list[v]], id_list[v] + "_2", "2", itemid, form["TXT_BRE_MLK" + id_list[v]], "1", id_list[v] + "_BRE_MLK", "OBS_PATNB");
                    }
                }
                #endregion
                insertDataList.Add(new DBItem("MILK_BD", form["TXT_MILK_BD" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("MILK", form["TXT_MILK" + id_list[v]], DBItem.DBDataType.String));
                #region 配方奶IO
                if (form["TXT_MILK" + id_list[v]] != "" && IsNoEmpty(baby_feeno))
                {
                    var ioSql = "SELECT * FROM IO_ITEM WHERE TYPEID = '2' AND NAME = '配方奶'";
                    var io_dt = obs_m.DBExecSQL(ioSql);
                    if (io_dt != null && io_dt.Rows.Count > 0)
                    {
                        var itemid = io_dt.Rows[0]["ITEMID"].ToString();
                        Update_IO_DATA_ForOther(baby_feeno, form["RECORDTIME_DAY" + id_list[v]] + " " + form["RECORDTIME_TIME" + id_list[v]], id_list[v] + "_2", "2", itemid, form["TXT_MILK" + id_list[v]], "1", id_list[v] + "_MILK", "OBS_PATNB", "", form["TXT_MILK_BD" + id_list[v]]);
                    }
                }
                else if (ptinfo.Age < 1 && form["TXT_MILK" + id_list[v]] != "")
                {
                    var ioSql = "SELECT * FROM IO_ITEM WHERE TYPEID = '2' AND NAME = '配方奶'";
                    var io_dt = obs_m.DBExecSQL(ioSql);
                    if (io_dt != null && io_dt.Rows.Count > 0)
                    {
                        var itemid = io_dt.Rows[0]["ITEMID"].ToString();
                        Update_IO_DATA(form["RECORDTIME_DAY" + id_list[v]] + " " + form["RECORDTIME_TIME" + id_list[v]], id_list[v] + "_2", "2", itemid, form["TXT_MILK" + id_list[v]], "1", id_list[v] + "_MILK", "OBS_PATNB", form["TXT_MILK_BD" + id_list[v]]);
                    }
                }
                #endregion
                insertDataList.Add(new DBItem("D5W", form["TXT_D5W" + id_list[v]], DBItem.DBDataType.String));
                #region D5W
                if (form["TXT_D5W" + id_list[v]] != "" && IsNoEmpty(baby_feeno))
                {
                    var ioSql = "SELECT * FROM IO_ITEM WHERE TYPEID = '2' AND NAME = 'D5W'";
                    var io_dt = obs_m.DBExecSQL(ioSql);
                    if (io_dt != null && io_dt.Rows.Count > 0)
                    {
                        var itemid = io_dt.Rows[0]["ITEMID"].ToString();
                        Update_IO_DATA_ForOther(baby_feeno, form["RECORDTIME_DAY" + id_list[v]] + " " + form["RECORDTIME_TIME" + id_list[v]], id_list[v] + "_2", "2", itemid, form["TXT_D5W" + id_list[v]], "1", id_list[v] + "_D5W", "OBS_PATNB");
                    }
                }
                else if (ptinfo.Age < 1 && form["TXT_D5W" + id_list[v]] != "")
                {
                    var ioSql = "SELECT * FROM IO_ITEM WHERE TYPEID = '2' AND NAME = 'D5W'";
                    var io_dt = obs_m.DBExecSQL(ioSql);
                    if (io_dt != null && io_dt.Rows.Count > 0)
                    {
                        var itemid = io_dt.Rows[0]["ITEMID"].ToString();
                        Update_IO_DATA(form["RECORDTIME_DAY" + id_list[v]] + " " + form["RECORDTIME_TIME" + id_list[v]], id_list[v] + "_2", "2", itemid, form["TXT_D5W" + id_list[v]], "1", id_list[v] + "_D5W", "OBS_PATNB");
                    }
                }
                #endregion
                insertDataList.Add(new DBItem("DEF_FRQ", form["TXT_DEF_FRQ" + id_list[v]], DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("DEF_COL", form["RB_DEF_COL" + id_list[v]], DBItem.DBDataType.String));
                if (form["RB_DEF_COL" + id_list[v]] != null && form["RB_DEF_COL" + id_list[v]] == "99")
                    insertDataList.Add(new DBItem("DEF_COL_OTH", form["TXT_DEF_COL_OTH" + id_list[v]], DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("DEF_CHA", form["RB_DEF_CHA" + id_list[v]], DBItem.DBDataType.String));
                if (form["RB_DEF_CHA" + id_list[v]] != null && form["RB_DEF_CHA" + id_list[v]] == "99")
                    insertDataList.Add(new DBItem("DEF_CHA_OTH", form["TXT_DEF_CHA_OTH" + id_list[v]], DBItem.DBDataType.String));

                insertDataList.Add(new DBItem("URI_FRQ", form["TXT_URI_FRQ" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("URI_COL", form["RB_URI_COL" + id_list[v]], DBItem.DBDataType.String));
                if (form["RB_URI_COL" + id_list[v]] != null && form["RB_URI_COL" + id_list[v]] == "99")
                    insertDataList.Add(new DBItem("URI_COL_OTH", form["TXT_URI_COL_OTH" + id_list[v]], DBItem.DBDataType.String));
                #region 排便IO
                if (form["TXT_DEF_FRQ" + id_list[v]] != "" && IsNoEmpty(baby_feeno))
                {
                    Update_IO_DATA_ForOther(baby_feeno, form["RECORDTIME_DAY" + id_list[v]] + " " + form["RECORDTIME_TIME" + id_list[v]], id_list[v] + "_12", "12", "", form["TXT_DEF_FRQ" + id_list[v]], "5", id_list[v] + "_DEF_FRQ", "OBS_PATNB");
                    Update_IO_Additional_forOther(baby_feeno, id_list[v] + "_12", !string.IsNullOrWhiteSpace(form["RB_DEF_COL" + id_list[v]]) ? form["RB_DEF_COL" + id_list[v]].Trim() : "-1", form["TXT_DEF_COL_OTH" + id_list[v]], !string.IsNullOrWhiteSpace(form["RB_DEF_CHA" + id_list[v]]) ? form["RB_DEF_CHA" + id_list[v]].Trim() : "-1", form["TXT_DEF_CHA_OTH" + id_list[v]], "", "");
                }
                else if (ptinfo.Age < 1 && form["TXT_DEF_FRQ" + id_list[v]] != "")
                {
                    Update_IO_DATA(form["RECORDTIME_DAY" + id_list[v]] + " " + form["RECORDTIME_TIME" + id_list[v]], id_list[v] + "_12", "12", "", form["TXT_DEF_FRQ" + id_list[v]], "5", id_list[v] + "_DEF_FRQ", "OBS_PATNB");
                    Update_IO_Additional(id_list[v] + "_12", !string.IsNullOrWhiteSpace(form["RB_DEF_COL" + id_list[v]]) ? form["RB_DEF_COL" + id_list[v]].Trim() : "-1", form["TXT_DEF_COL_OTH" + id_list[v]], !string.IsNullOrWhiteSpace(form["RB_DEF_CHA" + id_list[v]]) ? form["RB_DEF_CHA" + id_list[v]].Trim() : "-1", form["TXT_DEF_CHA_OTH" + id_list[v]], "", "");
                }
                #endregion
                insertDataList.Add(new DBItem("URI_CHA", form["RB_URI_CHA" + id_list[v]], DBItem.DBDataType.String));
                if (form["RB_URI_CHA" + id_list[v]] != null && form["RB_URI_CHA" + id_list[v]] == "99")
                    insertDataList.Add(new DBItem("URI_CHA_OTH", form["TXT_URI_CHA_OTH" + id_list[v]], DBItem.DBDataType.String));
                #region 排尿IO
                if (form["TXT_URI_FRQ" + id_list[v]] != "" && IsNoEmpty(baby_feeno))
                {
                    Update_IO_DATA_ForOther(baby_feeno, form["RECORDTIME_DAY" + id_list[v]] + " " + form["RECORDTIME_TIME" + id_list[v]], id_list[v] + "_13", "13", "", form["TXT_URI_FRQ" + id_list[v]], "5", id_list[v] + "_URI_FRQ", "OBS_PATNB");
                    Update_IO_Additional_forOther(baby_feeno, id_list[v] + "_13", !string.IsNullOrWhiteSpace(form["RB_URI_COL" + id_list[v]]) ? form["RB_URI_COL" + id_list[v]].Trim() : "-1", form["TXT_URI_COL_OTH" + id_list[v]], !string.IsNullOrWhiteSpace(form["RB_URI_CHA" + id_list[v]]) ? form["RB_URI_CHA" + id_list[v]].Trim() : "-1", form["TXT_URI_CHA_OTH" + id_list[v]], "", "");
                }
                else if (ptinfo.Age < 1 && form["TXT_URI_FRQ" + id_list[v]] != "")
                {
                    Update_IO_DATA(form["RECORDTIME_DAY" + id_list[v]] + " " + form["RECORDTIME_TIME" + id_list[v]], id_list[v] + "_13", "13", "", form["TXT_URI_FRQ" + id_list[v]], "5", id_list[v] + "_URI_FRQ", "OBS_PATNB");
                    Update_IO_Additional(id_list[v] + "_13", !string.IsNullOrWhiteSpace(form["RB_URI_COL" + id_list[v]]) ? form["RB_URI_COL" + id_list[v]].Trim() : "-1", form["TXT_URI_COL_OTH" + id_list[v]], !string.IsNullOrWhiteSpace(form["RB_URI_CHA" + id_list[v]]) ? form["RB_URI_CHA" + id_list[v]].Trim() : "-1", form["TXT_URI_CHA_OTH" + id_list[v]], "", "");
                }
                #endregion
                insertDataList.Add(new DBItem("TREAT", form["TXT_TREAT" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("CARE_RECORD", form["CK_CARE_RECORD" + id_list[v]], DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("NB_CARE_RECORD", form["CK_NB_CARE_RECORD" + id_list[v]], DBItem.DBDataType.String));

                //舊資料
                var MNcareRecordCheck = false; // 媽媽帶小孩
                var MMcareRecordCheck = false; // 媽媽帶媽媽
                var NMcareRecordCheck = false; // 小孩帶媽媽
                var NNcareRecordCheck = false; // 小孩帶小孩

                var careSql = "";
                DataTable dt_CareRecord = null;

                careSql = $@"SELECT * FROM CARERECORD_DATA 
WHERE CARERECORD_ID = '{id_list[v]}NB' 
AND SELF = 'OBS_PATNB'";

                dt_CareRecord = obs_m.DBExecSQL(careSql);
                if (dt_CareRecord != null && dt_CareRecord.Rows.Count > 0)
                {
                    if (ptinfo.Age < 1)
                    {
                        NNcareRecordCheck = true;
                    }
                    else
                    {
                        MNcareRecordCheck = true;
                    }
                }

                careSql = $@"SELECT * FROM CARERECORD_DATA 
WHERE CARERECORD_ID = '{id_list[v]}PAT' 
AND SELF = 'OBS_PATNB'";

                dt_CareRecord = obs_m.DBExecSQL(careSql);
                if (dt_CareRecord != null && dt_CareRecord.Rows.Count > 0)
                {
                    if (ptinfo.Age < 1)
                    {
                        NMcareRecordCheck = true;
                    }
                    else
                    {
                        MMcareRecordCheck = true;
                    }
                }

                string where = " IID = '" + id_list[v] + "' ";
                insertDataList = setNullToEmpty(insertDataList);
                erow += obs_m.DBExecUpdate("OBS_PATNB", insertDataList, where);

                List<SelectListItem> ColorList = this.cd.getSelectItem("io", "outputcolor_Drainage", "");
                List<SelectListItem> TypeList = this.cd.getSelectItem("io", "outputnature_Drainage", "");

                #region 轉護理記錄
                if (form["CK_CARE_RECORD" + id_list[v]] == "1" || form["CK_NB_CARE_RECORD" + id_list[v]] == "1")
                {
                    var content = new List<string>();
                    var semicolon = new List<string>();
                    var field = "";
                    var commaFlag = false;

                    field = "#from#評估產婦";
                    #region 乳房
                    if (IsNoEmpty(form["CK_BREAST" + id_list[v]]))
                    {
                        field += "乳房";
                        var BREASTs = (form["CK_BREAST" + id_list[v]] ?? "").Split(',');
                        var L_BREAST = new List<string>();
                        var R_BREAST = new List<string>();

                        foreach (var i in BREASTs)
                        {
                            if (Convert.ToInt32(i) < 5)
                                L_BREAST.Add(i);
                            else
                                R_BREAST.Add((Convert.ToInt32(i) - 5).ToString());
                        }

                        //左右相同
                        if (String.Join(",", L_BREAST) == String.Join(",", R_BREAST))
                        {
                            commaFlag = false;
                            foreach (var i in L_BREAST)
                            {
                                if (commaFlag)
                                    field += "、";

                                switch (i)
                                {
                                    case "0":
                                        field += "鬆軟";
                                        break;
                                    case "1":
                                        field += "充盈";
                                        break;
                                    case "2":
                                        field += "緊繃";
                                        break;
                                    case "3":
                                        field += "腫脹";
                                        break;
                                    case "4":
                                        field += "硬";
                                        break;
                                    default:
                                        field += "";
                                        break;
                                }

                                commaFlag = true;
                            }
                        }
                        else
                        {
                            //左邊
                            commaFlag = false;
                            if (L_BREAST != null && L_BREAST.Count() > 0)
                            {
                                field += "左";
                                foreach (var i in L_BREAST)
                                {
                                    if (commaFlag)
                                        field += "、";

                                    switch (i)
                                    {
                                        case "0":
                                            field += "鬆軟";
                                            break;
                                        case "1":
                                            field += "充盈";
                                            break;
                                        case "2":
                                            field += "緊繃";
                                            break;
                                        case "3":
                                            field += "腫脹";
                                            break;
                                        case "4":
                                            field += "硬";
                                            break;
                                        default:
                                            field += "";
                                            break;
                                    }
                                    commaFlag = true;
                                }
                            }
                            //右邊
                            commaFlag = false;
                            if (R_BREAST != null && R_BREAST.Count() > 0)
                            {
                                field += "、右";
                                foreach (var i in R_BREAST)
                                {
                                    if (commaFlag)
                                        field += "、";

                                    switch (i)
                                    {
                                        case "0":
                                            field += "鬆軟";
                                            break;
                                        case "1":
                                            field += "充盈";
                                            break;
                                        case "2":
                                            field += "緊繃";
                                            break;
                                        case "3":
                                            field += "腫脹";
                                            break;
                                        case "4":
                                            field += "硬";
                                            break;
                                        default:
                                            field += "";
                                            break;
                                    }
                                    commaFlag = true;
                                }
                            }
                        }
                    }
                    if (IsNoEmpty(field))
                        content.Add(field);
                    #endregion

                    field = "";
                    #region 乳頭
                    if (IsNoEmpty(form["CK_NIPPLE" + id_list[v]]))
                    {
                        field = "乳頭";
                        var NIPPLEs = (form["CK_NIPPLE" + id_list[v]] ?? "").Split(',');
                        var L_NIPPLE = new List<string>();
                        var R_NIPPLE = new List<string>();

                        foreach (var i in NIPPLEs)
                        {
                            if (Convert.ToInt32(i) < 8)
                                L_NIPPLE.Add(i);
                            else
                                R_NIPPLE.Add((Convert.ToInt32(i) - 8).ToString());
                        }

                        //左右相同
                        if (String.Join(",", L_NIPPLE) == String.Join(",", R_NIPPLE))
                        {
                            commaFlag = false;
                            foreach (var i in L_NIPPLE)
                            {
                                if (commaFlag)
                                    field += "、";

                                switch (i)
                                {
                                    case "0":
                                        field += "正常";
                                        break;
                                    case "1":
                                        field += "凹";
                                        break;
                                    case "2":
                                        field += "平";
                                        break;
                                    case "3":
                                        field += "短";
                                        break;
                                    case "4":
                                        field += "大";
                                        break;
                                    case "5":
                                        field += "小";
                                        break;
                                    case "6":
                                        field += "破皮";
                                        break;
                                    case "7":
                                        field += "結痂";
                                        break;
                                    default:
                                        field += "";
                                        break;
                                }

                                commaFlag = true;
                            }
                        }
                        else
                        {
                            //左邊
                            commaFlag = false;
                            if (L_NIPPLE != null && L_NIPPLE.Count() > 0)
                            {
                                field += "左";
                                foreach (var i in L_NIPPLE)
                                {
                                    if (commaFlag)
                                        field += "、";

                                    switch (i)
                                    {
                                        case "0":
                                            field += "正常";
                                            break;
                                        case "1":
                                            field += "凹";
                                            break;
                                        case "2":
                                            field += "平";
                                            break;
                                        case "3":
                                            field += "短";
                                            break;
                                        case "4":
                                            field += "大";
                                            break;
                                        case "5":
                                            field += "小";
                                            break;
                                        case "6":
                                            field += "破皮";
                                            break;
                                        case "7":
                                            field += "結痂";
                                            break;
                                        default:
                                            field += "";
                                            break;
                                    }
                                    commaFlag = true;
                                }
                            }
                            //右邊
                            commaFlag = false;
                            if (R_NIPPLE != null && R_NIPPLE.Count() > 0)
                            {
                                field += "、右";
                                foreach (var i in R_NIPPLE)
                                {
                                    if (commaFlag)
                                        field += "、";

                                    switch (i)
                                    {
                                        case "0":
                                            field += "正常";
                                            break;
                                        case "1":
                                            field += "凹";
                                            break;
                                        case "2":
                                            field += "平";
                                            break;
                                        case "3":
                                            field += "短";
                                            break;
                                        case "4":
                                            field += "大";
                                            break;
                                        case "5":
                                            field += "小";
                                            break;
                                        case "6":
                                            field += "破皮";
                                            break;
                                        case "7":
                                            field += "結痂";
                                            break;
                                        default:
                                            field += "";
                                            break;
                                    }
                                    commaFlag = true;
                                }
                            }
                        }
                    }
                    if (IsNoEmpty(field))
                        content.Add(field);
                    #endregion

                    #region 泌乳
                    field = "";
                    //左右相同
                    if (form["RB_LACT_L" + id_list[v]] == form["RB_LACT_R" + id_list[v]] && IsNoEmpty(form["RB_LACT_L" + id_list[v]]) && IsNoEmpty(form["RB_LACT_L" + id_list[v]]))
                    {
                        field = "乳汁";
                        switch ((form["RB_LACT_L" + id_list[v]] ?? "").ToString())
                        {
                            case "0":
                                field += "無分泌";
                                break;
                            case "1":
                                field += "微泌乳";
                                break;
                            case "2":
                                field += "已分泌";
                                break;
                            default:
                                field += "";
                                break;
                        }
                    }
                    else
                    {
                        //左
                        if (IsNoEmpty(form["RB_LACT_L" + id_list[v]]))
                        {
                            field += "左";
                            switch ((form["RB_LACT_L" + id_list[v]] ?? "").ToString())
                            {
                                case "0":
                                    field += "無分泌";
                                    break;
                                case "1":
                                    field += "微泌乳";
                                    break;
                                case "2":
                                    field += "已分泌";
                                    break;
                                default:
                                    field += "";
                                    break;
                            }
                        }

                        //右
                        if (IsNoEmpty(form["RB_LACT_R" + id_list[v]]))
                        {
                            field += $"{(IsNoEmpty(form["RB_LACT_L" + id_list[v]]) ? "、" : "")}右";
                            switch ((form["RB_LACT_R" + id_list[v]] ?? "").ToString())
                            {
                                case "0":
                                    field += "無分泌";
                                    break;
                                case "1":
                                    field += "微泌乳";
                                    break;
                                case "2":
                                    field += "已分泌";
                                    break;
                                default:
                                    field += "";
                                    break;
                            }
                        }
                    }
                    if (IsNoEmpty(field))
                        content.Add(field);
                    #endregion

                    if (content.Count() > 0)
                        semicolon.Add(String.Join("，", content));
                    content = new List<string>();
                    field = "";

                    #region 嬰兒[嬰兒生理評估 清醒]
                    if (IsNoEmpty(form["RB_AWAKE" + id_list[v]]) || IsNoEmpty(form["RB_BRE_TYP" + id_list[v]]) || IsNoEmpty(form["RB_SKIN" + id_list[v]]) || IsNoEmpty(form["RB_MUSCLE" + id_list[v]]) || IsNoEmpty(form["RB_ACTI" + id_list[v]]))
                        field = "嬰兒";
                    switch ((form["RB_AWAKE" + id_list[v]] ?? "").ToString())
                    {
                        case "0":
                            field += "警醒";
                            break;
                        case "1":
                            field += "睡覺";
                            break;
                        case "2":
                            field += "哭鬧";
                            break;
                        default:
                            field += "";
                            break;
                    }
                    if (IsNoEmpty(field))
                        content.Add(field);
                    #endregion

                    #region 呼吸[嬰兒生理評估 呼吸型態]
                    field = "";
                    switch ((form["RB_BRE_TYP" + id_list[v]] ?? "").ToString())
                    {
                        case "0":
                            field += "呼吸順暢";
                            break;
                        case "1":
                            field += "呼吸胸骨凹陷";
                            break;
                        case "2":
                            field += "呼吸困難";
                            break;
                        default:
                            field += "";
                            break;
                    }
                    if (IsNoEmpty(field))
                        content.Add(field);
                    #endregion

                    #region 膚色[嬰兒生理評估 膚色]
                    field = "";
                    switch ((form["RB_SKIN" + id_list[v]] ?? "").ToString())
                    {
                        case "0":
                            field += "膚色粉紅";
                            break;
                        case "1":
                            field += "膚色蒼白";
                            break;
                        case "2":
                            field += "膚色發紺";
                            break;
                        default:
                            field += "";
                            break;
                    }
                    if (IsNoEmpty(field))
                        content.Add(field);
                    #endregion

                    #region 肌肉張力[嬰兒生理評估 肌肉張力]
                    field = "";
                    switch ((form["RB_MUSCLE" + id_list[v]] ?? "").ToString())
                    {
                        case "0":
                            field += "肌肉張力佳";
                            break;
                        case "1":
                            field += "肌肉張力中";
                            break;
                        case "2":
                            field += "肌肉張力弱";
                            break;
                        default:
                            field += "";
                            break;
                    }
                    if (IsNoEmpty(field))
                        content.Add(field);
                    #endregion

                    #region 活動力[嬰兒生理評估 活動力]
                    field = "";
                    switch ((form["RB_ACTI" + id_list[v]] ?? "").ToString())
                    {
                        case "0":
                            field += "活動力強";
                            break;
                        case "1":
                            field += "活動力中";
                            break;
                        case "2":
                            field += "活動力弱";
                            break;
                        default:
                            field += "";
                            break;
                    }
                    if (IsNoEmpty(field))
                        content.Add(field);
                    #endregion

                    if (content.Count() > 0)
                        semicolon.Add(String.Join("，", content));
                    content = new List<string>();
                    field = "";

                    #region 觀察嬰兒[嬰兒會尋找乳房(是 / 飢餓時會尋找乳房、否 / 不呈現)]
                    field = "";
                    commaFlag = false;
                    switch ((form["RB_BRE_RES2" + id_list[v]] ?? "").ToString())
                    {
                        case "0":
                            field += "";
                            break;
                        case "1":
                            commaFlag = true;
                            field += "觀察嬰兒飢餓時會尋找乳房";
                            break;
                        default:
                            field += "";
                            break;
                    }
                    #endregion

                    #region [嬰兒接觸乳房時平靜而清醒(是 / 情緒平穩、否 / 哭泣)]
                    if (commaFlag)
                        field += "、";
                    if (IsNoEmpty(form["RB_BRE_RES3"]))
                    {
                        field += "觀察嬰兒";

                        switch ((form["RB_BRE_RES3" + id_list[v]] ?? "").ToString())
                        {
                            case "0":
                                field += "哭泣";
                                break;
                            case "1":
                                field += "情緒平穩";
                                break;
                            default:
                                field += "";
                                break;
                        }

                        content.Add(field);
                        #endregion
                        if (content.Count() > 0)
                            semicolon.Add(String.Join("，", content));
                    }
                    content = new List<string>();
                    field = "";
                    commaFlag = false;

                    if (IsNoEmpty(form["TXT_BRE_MLK" + id_list[v]]))
                    {
                        #region 哺餵母乳時，產婦身體姿勢[母親放鬆而舒服(是 / 放鬆、否 / 緊繃)]
                        field = "";
                        switch ((form["RB_BRE_BP1" + id_list[v]] ?? "").ToString())
                        {
                            case "0":
                                field += "緊繃";
                                break;
                            case "1":
                                field += "放鬆";
                                break;
                            default:
                                field += "";
                                break;
                        }
                        if (IsNoEmpty(field))
                            content.Add(field);
                        #endregion

                        #region [嬰兒身體緊貼母親，臉朝向乳房(是 / 嬰兒身體緊貼母親，臉朝向乳房、否 / 不 呈現)]
                        field = "";
                        switch ((form["RB_BRE_BP2" + id_list[v]] ?? "").ToString())
                        {
                            case "0":
                                field += "";
                                break;
                            case "1":
                                field += "嬰兒身體緊貼母親，臉朝向乳房";
                                break;
                            default:
                                field += "";
                                break;
                        }
                        if (IsNoEmpty(field))
                            content.Add(field);
                        #endregion

                        #region [嬰兒頭部及身體呈一直線(是 / 頭部及身體一直線、否 / 嬰兒頭部及身體扭轉)]
                        field = "";
                        switch ((form["RB_BRE_BP3" + id_list[v]] ?? "").ToString())
                        {
                            case "0":
                                field += "嬰兒頭部及身體扭轉";
                                break;
                            case "1":
                                field += "頭部及身體一直線";
                                break;
                            default:
                                field += "";
                                break;
                        }
                        if (IsNoEmpty(field))
                            content.Add(field);
                        #endregion

                        #region [嬰兒下巴貼著乳房(是 / 下巴貼著乳房、否 / 下巴未貼著乳房)]
                        field = "";
                        switch ((form["RB_BRE_BP4" + id_list[v]] ?? "").ToString())
                        {
                            case "0":
                                field += "下巴未貼著乳房";
                                break;
                            case "1":
                                field += "下巴貼著乳房";
                                break;
                            default:
                                field += "";
                                break;
                        }
                        if (IsNoEmpty(field))
                            content.Add(field);
                        #endregion

                        #region [嬰兒臀部受支撐(是 / 臀部有支撐、否 / 不呈現)]
                        field = "";
                        switch ((form["RB_BRE_BP5" + id_list[v]] ?? "").ToString())
                        {
                            case "0":
                                field += "";
                                break;
                            case "1":
                                field += "臀部有支撐";
                                break;
                            default:
                                field += "";
                                break;
                        }
                        if (IsNoEmpty(field))
                            content.Add(field);
                        #endregion
                    }

                    #region [嬰兒嘴巴張大(是 / 吸吮時嘴巴有張大、否 / 嘴巴僅含著乳頭)] 
                    field = "";
                    switch ((form["RB_BRE_SUC1" + id_list[v]] ?? "").ToString())
                    {
                        case "0":
                            field += "嘴巴僅含著乳頭";
                            break;
                        case "1":
                            field += "吸吮時嘴巴有張大";
                            break;
                        default:
                            field += "";
                            break;
                    }
                    if (IsNoEmpty(field))
                        content.Add(field);
                    #endregion

                    #region [下唇外翻(是 / 下唇外翻、否 / 下唇未外翻)]
                    field = "";
                    switch ((form["RB_BRE_SUC2" + id_list[v]] ?? "").ToString())
                    {
                        case "0":
                            field += "下唇未外翻";
                            break;
                        case "1":
                            field += "下唇外翻";
                            break;
                        default:
                            field += "";
                            break;
                    }
                    if (IsNoEmpty(field))
                        content.Add(field);
                    #endregion

                    #region [嬰兒嘴巴上方乳暈較多(是 / 嘴巴上方乳暈較多、否 / 未含上乳暈)]
                    field = "";
                    switch ((form["RB_BRE_SUC3" + id_list[v]] ?? "").ToString())
                    {
                        case "0":
                            field += "未含上乳暈";
                            break;
                        case "1":
                            field += "嘴巴上方乳暈較多";
                            break;
                        default:
                            field += "";
                            break;
                    }
                    if (IsNoEmpty(field))
                        content.Add(field);
                    #endregion

                    #region [慢慢的深吸奶，一陣子後間隔有休息(是 / 慢而深吸奶，一陣子後間隔有休息、否 / 吸吮急促)]
                    field = "";
                    switch ((form["RB_BRE_SUC4" + id_list[v]] ?? "").ToString())
                    {
                        case "0":
                            field += "吸吮急促";
                            break;
                        case "1":
                            field += "慢而深吸奶，一陣子後間隔有休息";
                            break;
                        default:
                            field += "";
                            break;
                    }
                    if (IsNoEmpty(field))
                        content.Add(field);
                    #endregion

                    #region [可看到或聽到吞嚥(是 / 可看到或聽到吞嚥、否 / 不呈現)]
                    field = "";
                    switch ((form["RB_BRE_SUC5" + id_list[v]] ?? "").ToString())
                    {
                        case "0":
                            field += "";
                            break;
                        case "1":
                            field += "可看到或聽到吞嚥";
                            break;
                        default:
                            field += "";
                            break;
                    }
                    if (IsNoEmpty(field))
                        content.Add(field);
                    #endregion

                    #region [嬰兒自己鬆開乳房(是 / 喝飽後嬰兒自己鬆開乳房、否 / 不呈現)]
                    field = "";
                    switch ((form["RB_BRE_TSS1" + id_list[v]] ?? "").ToString())
                    {
                        case "0":
                            field += "";
                            break;
                        case "1":
                            field += "喝飽後嬰兒自己鬆開乳房";
                            break;
                        default:
                            field += "";
                            break;
                    }
                    if (IsNoEmpty(field))
                        content.Add(field);
                    #endregion

                    if (content.Count() > 0)
                        semicolon.Add("哺餵母乳時，產婦身體姿勢" + String.Join("，", content));

                    content = new List<string>();
                    field = "";
                    commaFlag = false;

                    #region 吸吮[嬰兒吸吮母乳時間] 分鐘。嬰兒自解{ [排便 次數] 次[排便 顏色][排便 軟便]
                    field = "#嬰兒吸吮母乳時間#";
                    #endregion

                    #region [排尿 次數] 次[排尿 顏色] 尿液
                    if (IsNoEmpty(form["TXT_URI_FRQ" + id_list[v]]))
                    {
                        field += $"{(IsNoEmpty(form["TXT_URI_FRQ" + id_list[v]]) == true ? form["TXT_URI_FRQ" + id_list[v]] : "0")}次";

                        var URIColor = ColorList.Where(x => x.Value == form["RB_URI_COL" + id_list[v]].ToString()).Select(x => x.Text).FirstOrDefault();
                        var URIType = TypeList.Where(x => x.Value == form["RB_URI_CHA" + id_list[v]].ToString()).Select(x => x.Text).FirstOrDefault();

                        if (URIColor.Trim() != "請選擇(色)")
                        {
                            if (URIColor.Trim() == "其他")
                                field += form["TXT_URI_COL_OTH" + id_list[v]];
                            else
                                field += URIColor;
                        }
                        if (URIColor.Trim() != "請選擇(性質)")
                        {
                            if (URIType.Trim() == "其他")
                                field += form["TXT_URI_CHA_OTH" + id_list[v]];
                            else
                                field += URIType;
                        }

                        field += "尿液。";
                    }

                    if (IsNoEmpty(form["TXT_TREAT" + id_list[v]]))
                        field += $"{form["TXT_TREAT" + id_list[v]]}";

                    if (IsNoEmpty(field))
                        content.Add(field);
                    #endregion

                    if (content.Count() > 0)
                        semicolon.Add(String.Join("，", content));

                    var result = String.Join("；", semicolon) + "。";
                    field = "";

                    //小孩帶護理紀錄
                    if (form["CK_NB_CARE_RECORD" + id_list[v]] == "1")
                    {
                        bool iscommaFlag = false;
                        field = "";
                        if (IsNoEmpty(form["TXT_BRE_TSS2" + id_list[v]]))
                        {
                            field = $"{(IsNoEmpty(form["TXT_BRE_TSS2" + id_list[v]]) == true ? $"吸吮{form["TXT_BRE_TSS2" + id_list[v]]}分鐘，" : "")}";
                        }
                        if (IsNoEmpty(form["TXT_WATER" + id_list[v]]))
                        {
                            field += $"餵食開水量{(IsNoEmpty(form["TXT_WATER" + id_list[v]]) == true ? form["TXT_WATER" + id_list[v]] : "0")}mL";
                            iscommaFlag = true;
                        }
                        if (IsNoEmpty(form["TXT_BRE_MLK" + id_list[v]]))
                        {
                            if (iscommaFlag)
                                field += "、";
                            field += $"母乳量{(IsNoEmpty(form["TXT_BRE_MLK" + id_list[v]]) == true ? form["TXT_BRE_MLK" + id_list[v]] : "0")}mL";
                            iscommaFlag = true;
                        }
                        if (IsNoEmpty(form["TXT_MILK" + id_list[v]]))
                        {
                            if (iscommaFlag)
                                field += "、";
                            field += $"配方奶量{(IsNoEmpty(form["TXT_MILK" + id_list[v]]) == true ? form["TXT_MILK" + id_list[v]] : "0")}mL";
                            iscommaFlag = true;
                        }
                        if (IsNoEmpty(form["TXT_D5W" + id_list[v]]))
                        {
                            if (iscommaFlag)
                                field += "、";
                            field += $"D5W量{(IsNoEmpty(form["TXT_D5W" + id_list[v]]) == true ? form["TXT_D5W" + id_list[v]] : "0")}mL。";
                            iscommaFlag = true;
                        }

                        if (IsNoEmpty(form["TXT_DEF_FRQ" + id_list[v]]))
                        {
                            field += $"嬰兒自解{(IsNoEmpty(form["TXT_DEF_FRQ" + id_list[v]]) == true ? form["TXT_DEF_FRQ" + id_list[v]] : "0")}次";

                            var DEFColor = ColorList.Where(x => x.Value == form["RB_DEF_COL" + id_list[v]].ToString()).Select(x => x.Text).FirstOrDefault();
                            var DEFType = TypeList.Where(x => x.Value == form["RB_DEF_CHA" + id_list[v]].ToString()).Select(x => x.Text).FirstOrDefault();

                            if (DEFColor.Trim() != "請選擇(色)")
                            {
                                if (DEFColor.Trim() == "其他")
                                    field += form["TXT_DEF_COL_OTH" + id_list[v]];
                                else
                                    field += DEFColor;
                            }
                            if (DEFColor.Trim() != "請選擇(性質)")
                            {
                                if (DEFType.Trim() == "其他")
                                    field += form["TXT_DEF_CHA_OTH" + id_list[v]];
                                else
                                    field += DEFType;
                            }
                        }

                        result = String.Join("；", semicolon).Replace("#嬰兒吸吮母乳時間#", field) + "。";
                        result = result.Replace("。。", "。");
                        //小孩給小孩
                        if (ptinfo?.Age < 1)
                        {
                            result = result.Replace("#from#", "");
                            if (result.IndexOf("評估產婦；") >= 0)
                                result = result.Replace("評估產婦；", "");
                            if (result.Trim() == "。")
                                result = "";
                            if (NNcareRecordCheck)
                            {
                                if (result != "")
                                {
                                    erow += base.Upd_CareRecord(form["RECORDTIME_DAY" + id_list[v]] + " " + form["RECORDTIME_TIME" + id_list[v]], id_list[v] + "NB", "母嬰護理及飲食排泄紀錄", result, "", "", "", "", "OBS_PATNB");
                                }
                                else
                                {
                                    //base.Del_CareRecordTns(id_list[v] + "NB", "OBS_PATNB", ref link);
                                    base.Del_CareRecord(id_list[v] + "NB", "OBS_PATNB");
                                }
                            }
                            else if (!NNcareRecordCheck && result != "")
                                erow += base.Insert_CareRecord(form["RECORDTIME_DAY" + id_list[v]] + " " + form["RECORDTIME_TIME" + id_list[v]], id_list[v] + "NB", "母嬰護理及飲食排泄紀錄", result, "", "", "", "", "OBS_PATNB");
                        }
                        //媽媽給小孩
                        else
                        {
                            if (IsNoEmpty(baby_feeno))
                            {
                                result = result.Replace("#from#", "");
                                if (result.IndexOf("評估產婦；") >= 0)
                                    result = result.Replace("評估產婦；", "");
                                if (result.Trim() == "。")
                                    result = "";
                                //小孩的
                                if (MNcareRecordCheck)
                                {
                                    if (result != "")
                                    {
                                        erow += Upd_CareRecord_ForOtherTns(baby_feeno, form["RECORDTIME_DAY" + id_list[v]] + " " + form["RECORDTIME_TIME" + id_list[v]], id_list[v] + "NB", "母嬰護理及飲食排泄紀錄", result, "", "", "", "", "OBS_PATNB", ref link);
                                    }
                                    else
                                    {
                                        //base.Del_CareRecordTns(id_list[v] + "NB", "OBS_PATNB", ref link);
                                        base.Del_CareRecord(id_list[v] + "NB", "OBS_PATNB");
                                    }
                                }
                                else if (!MNcareRecordCheck && result != "")
                                    erow += Insert_CareRecord_ForOtherTns(baby_feeno, form["RECORDTIME_DAY" + id_list[v]] + " " + form["RECORDTIME_TIME" + id_list[v]], id_list[v] + "NB", "母嬰護理及飲食排泄紀錄", result, "", "", "", "", "OBS_PATNB", ref link);
                            }
                        }
                    }
                    else
                    {
                        //base.Del_CareRecordTns(id_list[v] + "NB", "OBS_PATNB", ref link);
                        base.Del_CareRecord(id_list[v] + "NB", "OBS_PATNB");
                    }
                    //媽媽帶護理紀錄
                    if (form["CK_CARE_RECORD" + id_list[v]] == "1")
                    {
                        field = "";
                        if (IsNoEmpty(form["TXT_BRE_TSS2" + id_list[v]]))
                        {
                            field = $"{(IsNoEmpty(form["TXT_BRE_TSS2" + id_list[v]]) == true ? $"吸吮{form["TXT_BRE_TSS2" + id_list[v]]}分鐘。" : "")}";
                        }
                        if (IsNoEmpty(form["TXT_DEF_FRQ" + id_list[v]]))
                        {
                            field += $"嬰兒自解{(IsNoEmpty(form["TXT_DEF_FRQ" + id_list[v]]) == true ? form["TXT_DEF_FRQ" + id_list[v]] : "0")}次";

                            var DEFColor = ColorList.Where(x => x.Value == form["RB_DEF_COL" + id_list[v]].ToString()).Select(x => x.Text).FirstOrDefault();
                            var DEFType = TypeList.Where(x => x.Value == form["RB_DEF_CHA" + id_list[v]].ToString()).Select(x => x.Text).FirstOrDefault();

                            if (DEFColor.Trim() != "請選擇(色)")
                            {
                                if (DEFColor.Trim() == "其他")
                                    field += form["TXT_DEF_COL_OTH" + id_list[v]];
                                else
                                    field += DEFColor;
                            }
                            if (DEFColor.Trim() != "請選擇(性質)")
                            {
                                if (DEFType.Trim() == "其他")
                                    field += form["TXT_DEF_CHA_OTH" + id_list[v]];
                                else
                                    field += DEFType;
                            }
                        }

                        result = String.Join("；", semicolon).Replace("#嬰兒吸吮母乳時間#", field) + "。";
                        result = result.Replace("。。", "。");

                        //小孩給媽媽的護理紀錄
                        if (ptinfo?.Age < 1)
                        {
                            DataTable dt = obs_m.sel_nbcha(ptinfo?.FeeNo);
                            if (dt != null && dt.Rows.Count > 0)
                            {
                                byte[] listByteCode = webService.GetPatientInfo(dt.Rows[0]["MOM_FEE_NO"].ToString());
                                if (listByteCode != null)
                                {
                                    string listJsonArray = CompressTool.DecompressString(listByteCode);
                                    PatientInfo mom = JsonConvert.DeserializeObject<PatientInfo>(listJsonArray);
                                    DataTable mom_nb_dt = obs_m.sel_nb(mom.FeeNo, ptinfo?.ChartNo);
                                    if (mom_nb_dt != null && mom_nb_dt.Rows.Count > 0)
                                        result = result.Replace("#from#", $"{mom.PatientName}{dt.Rows[0]["BABY_SEQ"].ToString()}{mom_nb_dt.Rows[0]["GENDER"]}");
                                    result = result.Replace("#from#", "");
                                    if (result.IndexOf("評估產婦；") >= 0)
                                        result = result.Replace("評估產婦；", "");
                                    if (result.Trim() == "。")
                                        result = "";
                                    //媽媽的
                                    if (NMcareRecordCheck)
                                    {
                                        if (result != "")
                                        {
                                            erow += Upd_CareRecord_ForOtherTns(mom.FeeNo, form["RECORDTIME_DAY" + id_list[v]] + " " + form["RECORDTIME_TIME" + id_list[v]], id_list[v] + "PAT", "母嬰護理及飲食排泄紀錄", result, "", "", "", "", "OBS_PATNB", ref link);
                                        }
                                        else
                                        {
                                            //base.Del_CareRecordTns(id_list[v] + "PAT", "OBS_PATNB", ref link);
                                            base.Del_CareRecord(id_list[v] + "PAT", "OBS_PATNB");
                                        }
                                    }
                                    else if (!NMcareRecordCheck && result != "")
                                        erow += Insert_CareRecord_ForOtherTns(mom.FeeNo, form["RECORDTIME_DAY" + id_list[v]] + " " + form["RECORDTIME_TIME" + id_list[v]], id_list[v] + "PAT", "母嬰護理及飲食排泄紀錄", result, "", "", "", "", "OBS_PATNB", ref link);
                                }
                            }
                        }
                        //媽媽給媽媽
                        else
                        {
                            result = result.Replace("#from#", "");
                            if (result.IndexOf("評估產婦；") >= 0)
                                result = result.Replace("評估產婦；", "");
                            if (result.Trim() == "。")
                                result = "";

                            if (MMcareRecordCheck)
                            {
                                if (result != "")
                                {
                                    erow += base.Upd_CareRecord(form["RECORDTIME_DAY" + id_list[v]] + " " + form["RECORDTIME_TIME" + id_list[v]], id_list[v] + "PAT", $"母嬰護理及飲食排泄紀錄-新生兒{baby_seq}", result, "", "", "", "", "OBS_PATNB");
                                }
                                else
                                {
                                    //base.Del_CareRecordTns(id_list[v] + "PAT", "OBS_PATNB", ref link);
                                    base.Del_CareRecord(id_list[v] + "PAT", "OBS_PATNB");
                                }
                            }
                            else if (!MMcareRecordCheck && result != "")
                                //erow += base.Insert_CareRecordTns(form["RECORDTIME_DAY" + id_list[v]] + " " + form["RECORDTIME_TIME" + id_list[v]], id_list[v] + "PAT", $"母嬰護理及飲食排泄紀錄-新生兒{baby_seq}", result, "", "", "", "", "OBS_PATNB", ref link);
                                erow += base.Insert_CareRecord(form["RECORDTIME_DAY" + id_list[v]] + " " + form["RECORDTIME_TIME" + id_list[v]], id_list[v] + "PAT", $"母嬰護理及飲食排泄紀錄-新生兒{baby_seq}", result, "", "", "", "", "OBS_PATNB");
                        }
                    }
                    else
                    {
                        //base.Del_CareRecordTns(id_list[v] + "PAT", "OBS_PATNB", ref link);
                        base.Del_CareRecord(id_list[v] + "PAT", "OBS_PATNB");
                    }
                }
                else
                {
                    if (form["CK_NB_CARE_RECORD" + id_list[v]] == "" || form["CK_NB_CARE_RECORD" + id_list[v]] == null) //小孩不帶護理紀錄
                    {
                        //base.Del_CareRecordTns(id_list[v] + "NB", "OBS_PATNB", ref link);
                        base.Del_CareRecord(id_list[v] + "NB", "OBS_PATNB");
                    }
                    if (form["CK_CARE_RECORD" + id_list[v]] == "" || form["CK_CARE_RECORD" + id_list[v]] == null) //產婦不帶護理紀錄
                    {
                        base.Del_CareRecord(id_list[v] + "PAT", "OBS_PATNB");
                    }
                }
                #endregion
            }
            if (erow >= id_list.Length)
                Response.Write("<script>alert('修改成功');window.opener.location.href='Index?active=Breast_Fedding_List&show=Y';window.close();</script>");
            else
                Response.Write("<script>alert('修改失敗');window.opener.location.href='Index?active=Breast_Fedding_List&show=Y';window.close();</script>");

            return new EmptyResult();
        }
        #endregion

        #region 哺餵照護紀錄刪除
        public ActionResult Del_Breast_Fedding(string id)
        {
            DataTable dt = obs_m.sel_Breast_Fedding("", userinfo.EmployeesNo, id);
            if (dt == null || dt.Rows.Count == 0)
            {
                Response.Write("<script>alert('無權限修改!');window.close();</script>");
            }
            else
            {
                List<DBItem> insertDataList = new List<DBItem>();
                insertDataList.Add(new DBItem("DELETED", userinfo.EmployeesNo, DBItem.DBDataType.String));
                string where = " IID = '" + id + "' ";
                insertDataList = setNullToEmpty(insertDataList);

                base.Delete_IO_DATA(id + "_BRE_TSS2", "OBS_PATNB");
                base.Delete_IO_DATA(id + "_WATER", "OBS_PATNB");
                base.Delete_IO_DATA(id + "_BRE_MILK", "OBS_PATNB");
                base.Delete_IO_DATA(id + "_MILK", "OBS_PATNB");
                base.Delete_IO_DATA(id + "_D5W", "OBS_PATNB");
                base.Delete_IO_DATA(id + "_DEF_FRQ", "OBS_PATNB");
                base.Delete_IO_DATA(id + "_URI_FRQ", "OBS_PATNB");
                //base.Del_CareRecordTns(id + "NB", "OBS_PATNB", ref link);
                base.Del_CareRecord(id + "NB", "OBS_PATNB");
                //base.Del_CareRecordTns(id + "PAT", "OBS_PATNB", ref link);
                base.Del_CareRecord(id + "PAT", "OBS_PATNB");

                int erow = obs_m.DBExecUpdate("OBS_PATNB", insertDataList, where);
                if (erow > 0)
                    Response.Write("<script>alert('刪除成功');window.location.href='Index?active=Breast_Fedding_List&show=Y';</script>");
                else
                    Response.Write("<script>alert('刪除失敗');window.location.href='Index?active=Breast_Fedding_List&show=Y';</script>");
            }
            return new EmptyResult();
        }
        #endregion

        #region 配方奶開窗選擇
        /// <summary>
        /// 配方奶開窗選擇
        /// </summary>
        /// <param name="page"></param>
        /// <param name="value"></param>
        /// <returns></returns>
        public ActionResult Select_NB_Formula_List(string value)
        {
            DataTable dt = obs_m.sel_nb_formula_choose();
            ViewBag.dt = set_dt(dt);
            ViewBag.value = value;
            return View();
        }
        #endregion


        #region 配方奶維護畫面
        /// <summary>
        /// 配方奶維護 List
        /// </summary>
        /// <returns></returns>
        public ActionResult NB_Formula_List()
        {
            DataTable dt = obs_m.sel_nb_formula();
            ViewBag.dt = set_dt(dt);
            return View();
        }
        #endregion

        #region 新增/編輯 配方奶
        /// <summary>
        /// 新增/編輯 配方奶
        /// </summary>
        /// <param name="IID"></param>
        /// <returns></returns>
        public ActionResult Insert_NB_Formula(string IID = "")
        {
            if (IID != "" && IID != null)
            {
                DataTable dt = obs_m.sel_nb_formula(IID);
                ViewBag.dt = set_dt(dt);
            }
            return View();
        }
        #endregion

        #region 配方奶新增
        /// <summary>
        /// 配方奶新增
        /// </summary>
        /// <param name="form"></param>
        /// <returns></returns>
        [HttpPost]
        public ActionResult Insert_NB_Formula(FormCollection form)
        {
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo?.FeeNo;
            string id = base.creatid("OBS_NBFORMULA", userno, feeno, "0");
            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("IID", id, DBItem.DBDataType.String)); //序號
            insertDataList.Add(new DBItem("CREATNO", userno, DBItem.DBDataType.String)); //建立者員編
            insertDataList.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
            insertDataList.Add(new DBItem("RECORDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間
            insertDataList.Add(new DBItem("DELETED", null, DBItem.DBDataType.String)); //刪除註記

            insertDataList.Add(new DBItem("BRAND", form["BRAND"], DBItem.DBDataType.String));
            if (form["START_D"] != "")
                insertDataList.Add(new DBItem("START_D", form["START_D"], DBItem.DBDataType.DataTime));

            insertDataList = setNullToEmpty(insertDataList);
            int erow = obs_m.DBExecInsert("OBS_NBFORMULA", insertDataList);
            if (erow > 0)
                Response.Write("<script>alert('新增成功');window.opener.location.href='NB_Formula_List';window.close();</script>");
            else
                Response.Write("<script>alert('新增失敗');window.opener.location.href='NB_Formula_List';window.close();</script>");

            return new EmptyResult();
        }
        #endregion

        #region 配方奶編輯
        /// <summary>
        /// 配方奶編輯
        /// </summary>
        /// <param name="form"></param>
        /// <returns></returns>
        [HttpPost]
        public ActionResult Upd_NB_Formula(FormCollection form)
        {
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo?.FeeNo;
            string id = form["IID"];

            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("UPDNO", userno, DBItem.DBDataType.String)); //建立者員編
            insertDataList.Add(new DBItem("UPDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
            insertDataList.Add(new DBItem("RECORDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間
            insertDataList.Add(new DBItem("DELETED", null, DBItem.DBDataType.String)); //刪除註記

            insertDataList.Add(new DBItem("BRAND", form["BRAND"], DBItem.DBDataType.String));
            if (form["START_D"] != "")
                insertDataList.Add(new DBItem("START_D", form["START_D"], DBItem.DBDataType.DataTime));
            if (form["END_D"] != "")
                insertDataList.Add(new DBItem("END_D", form["END_D"], DBItem.DBDataType.DataTime));

            string where = " IID = '" + id + "' ";
            insertDataList = setNullToEmpty(insertDataList);
            int erow = obs_m.DBExecUpdate("OBS_NBFORMULA", insertDataList, where);

            if (erow > 0)
                Response.Write("<script>alert('修改成功');window.opener.location.href='NB_Formula_List';window.close();</script>");
            else
                Response.Write("<script>alert('修改失敗');window.opener.location.href='NB_Formula_List';window.close();</script>");

            return new EmptyResult();
        }
        #endregion

        #region 配方奶停用
        /// <summary>
        /// 配方奶停用
        /// </summary>
        /// <param name="id"></param>
        /// <returns></returns>
        public ActionResult Del_NB_Formula(string id)
        {
            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("END_D", DateTime.Now.ToString("yyyy/mm/dd"), DBItem.DBDataType.String));
            string where = " IID = '" + id + "' ";
            insertDataList = setNullToEmpty(insertDataList);
            int erow = obs_m.DBExecUpdate("OBS_NBFORMULA", insertDataList, where);
            if (erow > 0)
                Response.Write("<script>alert('刪除成功');window.location.href='NB_Formula_List';</script>");
            else
                Response.Write("<script>alert('刪除失敗');window.location.href='NB_Formula_List';</script>");
            return new EmptyResult();
        }
        #endregion

        public int Save_NB_Formula(List<milk_INFO> data, List<string> delete)
        {
            List<DBItem> insertDataList = new List<DBItem>();
            int erow = 0;
            string userNO = userinfo.EmployeesNo;
            for(int i = 0; i < data.Count; i++ )
            {
                string iid = data[i].ID;

                if(iid != "" && iid != null)
                {
                    string capatity = (data[i].CAPATITY == null) ? "" : data[i].CAPATITY;
                    insertDataList.Clear();
                    insertDataList.Add(new DBItem("UPDNO", userNO, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("UPDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime));
                    insertDataList.Add(new DBItem("BRAND", data[i].NAME, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("HO_ID", data[i].HO_ID, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("UNIT", data[i].UNIT, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("SEQ", data[i].SEQ, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("HO_NAME", data[i].HO_NAME, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("CAPACITY", capatity, DBItem.DBDataType.String));
                    erow = link.DBExecUpdate("OBS_NBFORMULA", insertDataList, "IID = '" + iid + "'");
                }
                else
                {
                    string capatity = (data[i].CAPATITY == null) ? "" : data[i].CAPATITY;
                    iid = creatid("OBS_NBFORMULA", userNO, "", "0");
                    insertDataList.Clear();
                    insertDataList.Add(new DBItem("IID", iid, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("CREATNO", userNO, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime));
                    insertDataList.Add(new DBItem("BRAND", data[i].NAME, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("HO_ID", data[i].HO_ID, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("UNIT", data[i].UNIT, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("SEQ", data[i].SEQ, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("HO_NAME", data[i].HO_NAME, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("CAPACITY", capatity, DBItem.DBDataType.String));
                    erow =link.DBExecInsert("OBS_NBFORMULA", insertDataList);
                }
            }
            //刪除
            if(delete!= null)
            {
                if (delete.Count > 0)
                {
                    foreach (var item in delete)
                    {
                        string iid = item;

                        insertDataList.Clear();
                        insertDataList.Add(new DBItem("DELETED", userNO, DBItem.DBDataType.String));
                        erow = link.DBExecUpdate("OBS_NBFORMULA", insertDataList, "IID = '" + iid + "'");

                    }
                }
            }



            if(erow > 0 )
            {
                return 1;
            }
            return 0;
        }




        #region 產科核對清單
        /// <summary>
        /// 產科核對清單
        /// </summary>
        /// <param name="page"></param>
        /// <returns></returns>
        public ActionResult Obstetrics_List(string feeno, bool? kardex)
        {
            DataTable dt = new DataTable();
            if (IsNoEmpty(feeno))
                dt = obs_m.sel_obschk(feeno);
            else
                dt = obs_m.sel_obschk(ptinfo?.FeeNo);

            ViewBag.dt = dt;
            ViewBag.kardex = kardex;
            return View();
        }
        #endregion

        #region 產科核對清單新增
        public ActionResult Insert_OBSCHK(FormCollection form)
        {
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo?.FeeNo;
            bool kardex = Convert.ToBoolean(form["kardex"].ToString() == "" ? "False" : form["kardex"].ToString());
            string id = base.creatid("OBS_OBSCHK", userno, feeno, "0");
            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("IID", id, DBItem.DBDataType.String)); //序號
            insertDataList.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String)); //建立者員編
            insertDataList.Add(new DBItem("CREATNO", userno, DBItem.DBDataType.String)); //建立者員編
            insertDataList.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
            insertDataList.Add(new DBItem("RECORDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間
            insertDataList.Add(new DBItem("DELETED", null, DBItem.DBDataType.String)); //刪除註記
            insertDataList.Add(new DBItem("M_ID", form["CK_M_ID"], DBItem.DBDataType.String));
            if (form["TXT_M_ID_D_DAY"] != "" && form["TXT_M_ID_D_DAY"] != null && form["TXT_M_ID_D_TIME"] != "" && form["TXT_M_ID_D_TIME"] != null)
                insertDataList.Add(new DBItem("M_ID_D", form["TXT_M_ID_D_DAY"] + " " + form["TXT_M_ID_D_TIME"], DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("F_ID", form["CK_F_ID"], DBItem.DBDataType.String));
            if (form["TXT_F_ID_D_DAY"] != "" && form["TXT_F_ID_D_DAY"] != null && form["TXT_F_ID_D_TIME"] != "" && form["TXT_F_ID_D_TIME"] != null)
                insertDataList.Add(new DBItem("F_ID_D", form["TXT_F_ID_D_DAY"] + " " + form["TXT_F_ID_D_TIME"], DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("M_HIC", form["CK_M_HIC"], DBItem.DBDataType.String));
            if (form["TXT_M_HIC_D_DAY"] != "" && form["TXT_M_HIC_D_DAY"] != null && form["TXT_M_HIC_D_TIME"] != "" && form["TXT_M_HIC_D_TIME"] != null)
                insertDataList.Add(new DBItem("M_HIC_D", form["TXT_M_HIC_D_DAY"] + " " + form["TXT_M_HIC_D_TIME"], DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("F_HIC", form["CK_F_HIC"], DBItem.DBDataType.String));
            if (form["TXT_F_HIC_D_DAY"] != "" && form["TXT_F_HIC_D_DAY"] != null && form["TXT_F_HIC_D_TIME"] != "" && form["TXT_F_HIC_D_TIME"] != null)
                insertDataList.Add(new DBItem("F_HIC_D", form["TXT_F_HIC_D_DAY"] + " " + form["TXT_F_HIC_D_TIME"], DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("LIH", form["RB_LIH"], DBItem.DBDataType.String));
            if (form["TXT_LIH_D_DAY"] != "" && form["TXT_LIH_D_DAY"] != null && form["TXT_LIH_D_TIME"] != "" && form["TXT_LIH_D_TIME"] != null)
                insertDataList.Add(new DBItem("LIH_D", form["TXT_LIH_D_DAY"] + " " + form["TXT_LIH_D_TIME"], DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("BC", form["CK_BC"], DBItem.DBDataType.String));
            if (form["TXT_BC_D_DAY"] != "" && form["TXT_BC_D_DAY"] != null && form["TXT_BC_D_TIME"] != "" && form["TXT_BC_D_TIME"] != null)
                insertDataList.Add(new DBItem("BC_D", form["TXT_BC_D_DAY"] + " " + form["TXT_BC_D_TIME"], DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("DC", form["RB_DC"], DBItem.DBDataType.String));
            if (form["TXT_DC_D_DAY"] != "" && form["TXT_DC_D_DAY"] != null && form["TXT_DC_D_TIME"] != "" && form["TXT_DC_D_TIME"] != null)
                insertDataList.Add(new DBItem("DC_D", form["TXT_DC_D_DAY"] + " " + form["TXT_DC_D_TIME"], DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("MINOR", form["RB_MINOR"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("SW", form["RB_SW"], DBItem.DBDataType.String));

            insertDataList = setNullToEmpty(insertDataList);
            int erow = link.DBExecInsert("OBS_OBSCHK", insertDataList);

            if (erow > 0)
            {
                link.DBCommit();
                if (kardex)
                    Response.Write("<script>alert('新增成功');window.close();</script>");
                else
                    Response.Write("<script>alert('新增成功');window.location.href='Index?active=Obstetrics_List';</script>");
            }
            else
            {
                link.DBRollBack();
                if (kardex)
                    Response.Write("<script>alert('新增失敗');window.close();</script>");
                else
                    Response.Write("<script>alert('新增失敗');window.location.href='Index?active=Obstetrics_List';</script>");
            }

            return new EmptyResult();
        }
        #endregion

        #region 產科核對清單編輯
        public ActionResult Upd_OBSCHK(FormCollection form)
        {
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo?.FeeNo;
            string id = form["IID"];
            bool kardex = Convert.ToBoolean(form["kardex"].ToString() == "" ? "False" : form["kardex"].ToString());
            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("UPDNO", userno, DBItem.DBDataType.String)); //建立者員編
            insertDataList.Add(new DBItem("UPDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
            insertDataList.Add(new DBItem("RECORDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間
            insertDataList.Add(new DBItem("DELETED", null, DBItem.DBDataType.String)); //刪除註記

            insertDataList.Add(new DBItem("M_ID", form["CK_M_ID"], DBItem.DBDataType.String));
            if (form["TXT_M_ID_D_DAY"] != "" && form["TXT_M_ID_D_DAY"] != null && form["TXT_M_ID_D_TIME"] != "" && form["TXT_M_ID_D_TIME"] != null)
                insertDataList.Add(new DBItem("M_ID_D", form["TXT_M_ID_D_DAY"] + " " + form["TXT_M_ID_D_TIME"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("M_ID_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("F_ID", form["CK_F_ID"], DBItem.DBDataType.String));
            if (form["TXT_F_ID_D_DAY"] != "" && form["TXT_F_ID_D_DAY"] != null && form["TXT_F_ID_D_TIME"] != "" && form["TXT_F_ID_D_TIME"] != null)
                insertDataList.Add(new DBItem("F_ID_D", form["TXT_F_ID_D_DAY"] + " " + form["TXT_F_ID_D_TIME"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("F_ID_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("M_HIC", form["CK_M_HIC"], DBItem.DBDataType.String));
            if (form["TXT_M_HIC_D_DAY"] != "" && form["TXT_M_HIC_D_DAY"] != null && form["TXT_M_HIC_D_TIME"] != "" && form["TXT_M_HIC_D_TIME"] != null)
                insertDataList.Add(new DBItem("M_HIC_D", form["TXT_M_HIC_D_DAY"] + " " + form["TXT_M_HIC_D_TIME"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("M_HIC_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("F_HIC", form["CK_F_HIC"], DBItem.DBDataType.String));
            if (form["TXT_F_HIC_D_DAY"] != "" && form["TXT_F_HIC_D_DAY"] != null && form["TXT_F_HIC_D_TIME"] != "" && form["TXT_F_HIC_D_TIME"] != null)
                insertDataList.Add(new DBItem("F_HIC_D", form["TXT_F_HIC_D_DAY"] + " " + form["TXT_F_HIC_D_TIME"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("F_HIC_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("LIH", form["RB_LIH"], DBItem.DBDataType.String));
            if (form["TXT_LIH_D_DAY"] != "" && form["TXT_LIH_D_DAY"] != null && form["TXT_LIH_D_TIME"] != "" && form["TXT_LIH_D_TIME"] != null)
                insertDataList.Add(new DBItem("LIH_D", form["TXT_LIH_D_DAY"] + " " + form["TXT_LIH_D_TIME"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("LIH_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("BC", form["CK_BC"], DBItem.DBDataType.String));
            if (form["TXT_BC_D_DAY"] != "" && form["TXT_BC_D_DAY"] != null && form["TXT_BC_D_TIME"] != "" && form["TXT_BC_D_TIME"] != null)
                insertDataList.Add(new DBItem("BC_D", form["TXT_BC_D_DAY"] + " " + form["TXT_BC_D_TIME"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("BC_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("DC", form["RB_DC"], DBItem.DBDataType.String));
            if (form["TXT_DC_D_DAY"] != "" && form["TXT_DC_D_DAY"] != null && form["TXT_DC_D_TIME"] != "" && form["TXT_DC_D_TIME"] != null)
                insertDataList.Add(new DBItem("DC_D", form["TXT_DC_D_DAY"] + " " + form["TXT_DC_D_TIME"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("DC_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("MINOR", form["RB_MINOR"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("SW", form["RB_SW"], DBItem.DBDataType.String));

            insertDataList = setNullToEmpty(insertDataList);
            string where = " IID = '" + id + "' ";
            insertDataList = setNullToEmpty(insertDataList);
            int erow = obs_m.DBExecUpdate("OBS_OBSCHK", insertDataList, where);

            if (erow > 0)
            {
                link.DBCommit();
                if (kardex)
                    Response.Write("<script>alert('修改成功');window.close();</script>");
                else
                    Response.Write("<script>alert('修改成功');window.location.href='Index?active=Obstetrics_List';</script>");
            }
            else
            {
                link.DBRollBack();
                if (kardex)
                    Response.Write("<script>alert('修改失敗');window.close();</script>");
                else
                    Response.Write("<script>alert('修改失敗');window.location.href='Index?active=Obstetrics_List';</script>");
            }

            return new EmptyResult();
        }
        #endregion

        #region GetBaByLab 
        public string GetBabyLab(DateTime? date)
        {
            if (date != null)
            {
                byte[] BabyLablistByteCode = webService.GetBabyLab(ptinfo?.FeeNo, date.Value.ToString("yyyy/MM/dd"), date.Value.ToString("yyyy/MM/dd"));
                if (BabyLablistByteCode == null)
                    return "";
                else
                {
                    string listJsonArray = CompressTool.DecompressString(BabyLablistByteCode);
                    BabyLab[] BabyLab = JsonConvert.DeserializeObject<BabyLab[]>(listJsonArray);
                    return JsonConvert.SerializeObject(BabyLab.Where(x => x.LabCode.Trim() == "6399121").FirstOrDefault()?.LabValue);
                }
            }
            else
            {
                return JsonConvert.SerializeObject("");
            }
        }
        #endregion

        #region 兒科核對清單
        /// <summary>
        /// 兒科核對清單
        /// </summary>
        /// <returns></returns>
        public ActionResult Pediatrics_Check_List(string feeno, bool? kardex)
        {
            DataTable dt = new DataTable();
            if (IsNoEmpty(feeno))
                dt = obs_m.sel_pedchk(feeno);
            else
                dt = obs_m.sel_pedchk(ptinfo?.FeeNo);

            ViewBag.dt = dt;
            ViewBag.kardex = kardex;

            #region 媽媽產檢資料
            DataTable mom = obs_m.sel_nbcha(ptinfo?.FeeNo);
            if (mom != null && mom.Rows.Count > 0)
            {
                foreach (DataRow r in mom.Rows)
                {
                    //GetBabyLab
                    byte[] BabyLablistByteCode = webService.GetBabyLab(r["MOM_FEE_NO"].ToString(), DateTime.Now.AddMonths(-8).ToString("yyyy/MM/dd"), DateTime.Now.ToString("yyyy/MM/dd"));
                    if (BabyLablistByteCode == null)
                        ViewBag.BabyLab = new BabyLab();
                    else
                    {
                        string listJsonArray = CompressTool.DecompressString(BabyLablistByteCode);
                        BabyLab[] BabyLab = JsonConvert.DeserializeObject<BabyLab[]>(listJsonArray);

                        //BabyLab[0].LabCode = "6314032";
                        //BabyLab[0].LabValue = "GRAYZONE(8.9)";

                        //BabyLab[1].LabCode = "6312001";
                        //BabyLab[1].LabValue = "Non-reactive";

                        //BabyLab[2].LabCode = "6314035";
                        //BabyLab[2].LabValue = "Negative(0.445)";

                        //BabyLab[3].LabCode = "6312001";
                        //BabyLab[3].LabValue = "Reactive";


                        //'6314032' - HBsAg
                        var HBsAg = BabyLab.Where(x => x.LabCode.Trim() == "6314032").FirstOrDefault();
                        if (HBsAg?.LabValue.IndexOf('(') >= 0)
                        {
                            ViewBag.HBsAg = HBsAg.LabValue.Split('(')[1].Replace(")", "");
                        }
                        else
                        {
                            ViewBag.HBsAg = "";
                        }
                        //'6314035' - HBeAg
                        var HBeAg = BabyLab.Where(x => x.LabCode.Trim() == "6314035").FirstOrDefault();
                        if (HBeAg?.LabValue.IndexOf('(') >= 0)
                        {
                            ViewBag.HBeAg = HBeAg.LabValue.Split('(')[1].Replace(")", "");
                        }
                        else
                        {
                            ViewBag.HBeAg = "";
                        }
                    }
                }

            }
            #endregion

            #region 生命徵象
            var sql = "SELECT CREATE_DATE, VS_ITEM, VS_PART, VS_RECORD, VS_MEMO,VS_REASON  "
                      + " FROM ( "
                      + "     SELECT CREATE_DATE, VS_ITEM, VS_PART, VS_RECORD, VS_MEMO,VS_REASON, "
                      + "     ROW_NUMBER() OVER(PARTITION BY t.VS_ITEM ORDER BY t.CREATE_DATE desc) NUM "
                      + "     FROM DATA_VITALSIGN t "
                      + "     WHERE FEE_NO = '" + (IsNoEmpty(feeno) ? feeno : ptinfo?.FeeNo) + "' "
                      + "     AND VS_ITEM = 'bw'"
                      + "     AND CREATE_DATE < to_date('" + DateTime.Now.ToString("yyyy/MM/dd") + " 00:00" + "','yyyy/MM/dd hh24:mi:ss') "
                      + "     ORDER BY CREATE_DATE DESC ) MAIN "
                      + " WHERE MAIN.NUM = 1 ";
            var Temp = new List<Dictionary<string, string>>();

            DataTable Dt2 = link.DBExecSQL(sql);
            if (Dt2.Rows.Count > 0)
            {
                for (int i = 0; i < Dt2.Rows.Count; i++)
                {
                    var temp = new Dictionary<string, string>();
                    temp["CREATE_DATE"] = Dt2.Rows[i]["CREATE_DATE"].ToString();
                    temp["VS_ITEM"] = Dt2.Rows[i]["VS_ITEM"].ToString();
                    temp["VS_PART"] = Dt2.Rows[i]["VS_PART"].ToString();
                    temp["VS_REASON"] = Dt2.Rows[i]["VS_REASON"].ToString();
                    temp["VS_RECORD"] = Dt2.Rows[i]["VS_RECORD"].ToString();
                    temp["VS_MEMO"] = Dt2.Rows[i]["VS_MEMO"].ToString();
                    Temp.Add(temp);
                }

                if (Temp.Count > 0)
                {
                    List<Dictionary<string, string>> VitalSignList = new List<Dictionary<string, string>>();

                    VitalSignList = Temp.FindAll(x => x["VS_ITEM"] == "bw" && !string.IsNullOrEmpty(x["VS_RECORD"]));
                    if (VitalSignList.Count > 0)
                    {
                        for (int i = 0; i < 1; i++)
                        {
                            ViewBag.LastWeight = VitalSignList[i]["VS_RECORD"].Replace("|", "");
                            ViewBag.WeightTime = VitalSignList[i]["CREATE_DATE"];
                        }
                    }
                }
            }
            #endregion

            return View();
        }
        #endregion

        #region 兒科核對清單新增
        public ActionResult Insert_PEDCHK(FormCollection form)
        {
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo?.FeeNo;
            bool kardex = Convert.ToBoolean(form["kardex"].ToString() == "" ? "False" : form["kardex"].ToString());
            string id = base.creatid("OBS_PEDCHK", userno, feeno, "0");
            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("IID", id, DBItem.DBDataType.String)); //序號
            insertDataList.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String)); //建立者員編
            insertDataList.Add(new DBItem("CREATNO", userno, DBItem.DBDataType.String)); //建立者員編
            insertDataList.Add(new DBItem("CREATTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
            insertDataList.Add(new DBItem("RECORDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間
            insertDataList.Add(new DBItem("DELETED", null, DBItem.DBDataType.String)); //刪除註記

            insertDataList.Add(new DBItem("WEIGHT_TD", form["TXT_WEIGHT_TD"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("WEIGHT_TM", form["TXT_WEIGHT_TM"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("MILK_B", form["TXT_MILK_B"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("MILK_F", form["RB_MILK_F"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("MILK_AMT", form["TXT_MILK_AMT"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("GIRTH", form["RB_GIRTH"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("GIRTH_H", form["TXT_GIRTH_H"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("GIRTH_B", form["TXT_GIRTH_B"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("GIRTH_L", form["TXT_GIRTH_L"], DBItem.DBDataType.String));

            if (form["TXT_GIRTH_D"] != "" && form["TXT_GIRTH_D"] != null)
                insertDataList.Add(new DBItem("GIRTH_D", form["TXT_GIRTH_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("GIRTH_D", null, DBItem.DBDataType.DataTime));

            if (form["TXT_GIRTH_LD"] != "" && form["TXT_GIRTH_LD"] != null)
                insertDataList.Add(new DBItem("GIRTH_LD", form["TXT_GIRTH_LD"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("GIRTH_LD", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("SOB", form["RB_SOB"], DBItem.DBDataType.String));
            if (form["TXT_SOB_D"] != "" && form["TXT_SOB_D"] != null)
                insertDataList.Add(new DBItem("SOB_D", form["TXT_SOB_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("SOB_D", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("SOB_R", form["TXT_SOB_R"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("UR", form["RB_UR"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("UR_PH", form["TXT_UR_PH"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("UR_SG", form["TXT_UR_SG"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("UR_PT", form["TXT_UR_PT"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("BATH", form["RB_BATH"], DBItem.DBDataType.String));
            if (form["TXT_BATH_D1"] != "" && form["TXT_BATH_D1"] != null)
                insertDataList.Add(new DBItem("BATH_D1", form["TXT_BATH_D1"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("BATH_D1", null, DBItem.DBDataType.DataTime));
            if (form["TXT_BATH_D2"] != "" && form["TXT_BATH_D2"] != null)
                insertDataList.Add(new DBItem("BATH_D2", form["TXT_BATH_D2"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("BATH_D2", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("CBEX", form["RB_CBEX"], DBItem.DBDataType.String));
            if (form["TXT_CBEX_D"] != "" && form["TXT_CBEX_D"] != null)
                insertDataList.Add(new DBItem("CBEX_D", form["TXT_CBEX_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("CBEX_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("HBIG", form["RB_HBIG"], DBItem.DBDataType.String));
            if (form["TXT_HBIG_D"] != "" && form["TXT_HBIG_D"] != null)
                insertDataList.Add(new DBItem("HBIG_D", form["TXT_HBIG_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("HBIG_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("HBSAG", form["TXT_HBSAG"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("HBEAG", form["TXT_HBEAG"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("HBV", form["RB_HBV"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("HBV_N", form["TXT_HBV_N"], DBItem.DBDataType.String));

            var HBV_NR = form["CK_HBV_NR"];
            var HBV_NRV = new List<string>() { "0", "0" };
            if (HBV_NR == null)
                insertDataList.Add(new DBItem("HBV_NR", String.Join("", HBV_NRV), DBItem.DBDataType.String));
            else
            {
                var HBV_NR_SP = HBV_NR.Split(',');
                foreach (var i in HBV_NR_SP)
                    HBV_NRV[Convert.ToInt32(i)] = "1";
                insertDataList.Add(new DBItem("HBV_NR", String.Join("", HBV_NRV), DBItem.DBDataType.String));
            }

            if (form["TXT_HBV_D"] != "" && form["TXT_HBV_D"] != null)
                insertDataList.Add(new DBItem("HBV_D", form["TXT_HBV_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("HBV_D", null, DBItem.DBDataType.DataTime));

            var NBS = form["CK_NBS"];
            var NBSV = new List<string>() { "0", "0", "0", "0" };
            if (NBS == null)
                insertDataList.Add(new DBItem("NBS", String.Join("", NBSV), DBItem.DBDataType.String));
            else
            {
                var NBS_SP = NBS.Split(',');
                foreach (var i in NBS_SP)
                    NBSV[Convert.ToInt32(i)] = "1";
                insertDataList.Add(new DBItem("NBS", String.Join("", NBSV), DBItem.DBDataType.String));
            }

            if (form["TXT_NBS_D"] != "" && form["TXT_NBS_D"] != null)
                insertDataList.Add(new DBItem("NBS_D", form["TXT_NBS_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("NBS_D", null, DBItem.DBDataType.DataTime));

            if (form["TXT_NBS_RC_D1"] != "" && form["TXT_NBS_RC_D1"] != null)
                insertDataList.Add(new DBItem("NBS_RC_D1", form["TXT_NBS_RC_D1"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("NBS_RC_D1", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("NBS_MEMO1", form["TXT_NBS_MEMO1"], DBItem.DBDataType.String));

            if (form["TXT_NBS_RC_D2"] != "" && form["TXT_NBS_RC_D2"] != null)
                insertDataList.Add(new DBItem("NBS_RC_D2", form["TXT_NBS_RC_D2"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("NBS_RC_D2", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("NBS_MEMO2", form["TXT_NBS_MEMO2"], DBItem.DBDataType.String));

            if (form["TXT_NBS_RC_D3"] != "" && form["TXT_NBS_RC_D3"] != null)
                insertDataList.Add(new DBItem("NBS_RC_D3", form["TXT_NBS_RC_D3"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("NBS_RC_D3", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("NBS_MEMO3", form["TXT_NBS_MEMO3"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("AOC", form["RB_AOC"], DBItem.DBDataType.String));
            if (form["TXT_AOC_D"] != "" && form["TXT_AOC_D"] != null)
                insertDataList.Add(new DBItem("AOC_D", form["TXT_AOC_D"], DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("PD", form["RB_PD"], DBItem.DBDataType.String));
            if (form["TXT_PD_D"] != "" && form["TXT_PD_D"] != null)
                insertDataList.Add(new DBItem("PD_D", form["TXT_PD_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("PD_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("SCID", form["RB_SCID"], DBItem.DBDataType.String));
            if (form["TXT_SCID_D"] != "" && form["TXT_SCID_D"] != null)
                insertDataList.Add(new DBItem("SCID_D", form["TXT_SCID_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("SCID_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("FIVEIN1", form["RB_FIVEIN1"], DBItem.DBDataType.String));
            if (form["TXT_FIVEIN1_D"] != "" && form["TXT_FIVEIN1_D"] != null)
                insertDataList.Add(new DBItem("FIVEIN1_D", form["TXT_FIVEIN1_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("FIVEIN1_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("ALD", form["RB_ALD"], DBItem.DBDataType.String));
            if (form["TXT_ALD_D"] != "" && form["TXT_ALD_D"] != null)
                insertDataList.Add(new DBItem("ALD_D", form["TXT_ALD_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("ALD_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("SHL", form["RB_SHL"], DBItem.DBDataType.String));
            if (form["TXT_SHL_D"] != "" && form["TXT_SHL_D"] != null)
                insertDataList.Add(new DBItem("SHL_D", form["TXT_SHL_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("SHL_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("CCHS", form["RB_CCHS"], DBItem.DBDataType.String));
            if (form["TXT_CCHS_D"] != "" && form["TXT_CCHS_D"] != null)
                insertDataList.Add(new DBItem("CCHS_D", form["TXT_CCHS_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("CCHS_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("CMV", form["RB_CMV"], DBItem.DBDataType.String));
            if (form["TXT_CMV_D"] != "" && form["TXT_CMV_D"] != null)
                insertDataList.Add(new DBItem("CMV_D", form["TXT_CMV_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("CMV_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("OTH", form["TXT_OTH"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("LGE", form["RB_LGE"], DBItem.DBDataType.String));
            if (form["TXT_LGE_D1"] != "" && form["TXT_LGE_D1"] != null)
                insertDataList.Add(new DBItem("LGE_D1", form["TXT_LGE_D1"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("LGE_D1", null, DBItem.DBDataType.DataTime));
            if (form["TXT_LGE_D2"] != "" && form["TXT_LGE_D2"] != null)
                insertDataList.Add(new DBItem("LGE_D2", form["TXT_LGE_D2"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("LGE_D2", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("BUS", form["RB_BUS"], DBItem.DBDataType.String));
            var BUS_M = form["CK_BUS_M"];
            var BUS_MV = new List<string>() { "0", "0", "0" };
            if (BUS_M == null)
                insertDataList.Add(new DBItem("BUS_M", String.Join("", BUS_MV), DBItem.DBDataType.String));
            else
            {
                var BUS_M_SP = BUS_M.Split(',');
                foreach (var i in BUS_M_SP)
                    BUS_MV[Convert.ToInt32(i)] = "1";
                insertDataList.Add(new DBItem("BUS_M", String.Join("", BUS_MV), DBItem.DBDataType.String));
            }

            if (form["TXT_BUS_D1"] != "" && form["TXT_BUS_D1"] != null)
                insertDataList.Add(new DBItem("BUS_D1", form["TXT_BUS_D1"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("BUS_D1", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("BUS_1R", form["TXT_BUS_1R"], DBItem.DBDataType.String));

            if (form["TXT_BUS_D2"] != "" && form["TXT_BUS_D2"] != null)
                insertDataList.Add(new DBItem("BUS_D2", form["TXT_BUS_D2"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("BUS_D2", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("BUS_2R", form["TXT_BUS_2R"], DBItem.DBDataType.String));

            if (form["TXT_BUS_D3"] != "" && form["TXT_BUS_D3"] != null)
                insertDataList.Add(new DBItem("BUS_D3", form["TXT_BUS_D3"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("BUS_D3", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("BUS_3R", form["TXT_BUS_3R"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("BUS_OTH", form["TXT_BUS_OTH"], DBItem.DBDataType.String));


            insertDataList.Add(new DBItem("ECG", form["RB_ECG"], DBItem.DBDataType.String));
            var ECG_M = form["CK_ECG_M"];
            var ECG_MV = new List<string>() { "0", "0", "0" };
            if (ECG_M == null)
                insertDataList.Add(new DBItem("ECG_M", String.Join("", ECG_MV), DBItem.DBDataType.String));
            else
            {
                var ECG_M_SP = ECG_M.Split(',');
                foreach (var i in ECG_M_SP)
                    ECG_MV[Convert.ToInt32(i)] = "1";
                insertDataList.Add(new DBItem("ECG_M", String.Join("", ECG_MV), DBItem.DBDataType.String));
            }

            if (form["TXT_ECG_D1"] != "" && form["TXT_ECG_D1"] != null)
                insertDataList.Add(new DBItem("ECG_D1", form["TXT_ECG_D1"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("ECG_D1", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("ECG_1R", form["TXT_ECG_1R"], DBItem.DBDataType.String));

            if (form["TXT_ECG_D2"] != "" && form["TXT_ECG_D2"] != null)
                insertDataList.Add(new DBItem("ECG_D2", form["TXT_ECG_D2"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("ECG_D2", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("ECG_2R", form["TXT_ECG_2R"], DBItem.DBDataType.String));

            if (form["TXT_ECG_D3"] != "" && form["TXT_ECG_D3"] != null)
                insertDataList.Add(new DBItem("ECG_D3", form["TXT_ECG_D3"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("ECG_D3", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("ECG_3R", form["TXT_ECG_3R"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("ECG_OTH", form["TXT_ECG_OTH"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("AUS", form["RB_AUS"], DBItem.DBDataType.String));
            var AUS_M = form["CK_AUS_M"];
            var AUS_MV = new List<string>() { "0", "0", "0" };
            if (AUS_M == null)
                insertDataList.Add(new DBItem("AUS_M", String.Join("", AUS_MV), DBItem.DBDataType.String));
            else
            {
                var AUS_M_SP = AUS_M.Split(',');
                foreach (var i in AUS_M_SP)
                    AUS_MV[Convert.ToInt32(i)] = "1";
                insertDataList.Add(new DBItem("AUS_M", String.Join("", AUS_MV), DBItem.DBDataType.String));
            }

            if (form["TXT_AUS_D1"] != "" && form["TXT_AUS_D1"] != null)
                insertDataList.Add(new DBItem("AUS_D1", form["TXT_AUS_D1"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("AUS_D1", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("AUS_1R", form["TXT_AUS_1R"], DBItem.DBDataType.String));

            if (form["TXT_AUS_D2"] != "" && form["TXT_AUS_D2"] != null)
                insertDataList.Add(new DBItem("AUS_D2", form["TXT_AUS_D2"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("AUS_D2", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("AUS_2R", form["TXT_AUS_2R"], DBItem.DBDataType.String));

            if (form["TXT_AUS_D3"] != "" && form["TXT_AUS_D3"] != null)
                insertDataList.Add(new DBItem("AUS_D3", form["TXT_AUS_D3"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("AUS_D3", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("AUS_3R", form["TXT_AUS_3R"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("HUS", form["RB_HUS"], DBItem.DBDataType.String));
            if (form["TXT_HUS_D"] != "" && form["TXT_HUS_D"] != null)
                insertDataList.Add(new DBItem("HUS_D", form["TXT_HUS_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("HUS_D", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("HUS_M", form["TXT_HUS_M"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("HUS_R", form["TXT_HUS_R"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("AABR", form["RB_AABR"], DBItem.DBDataType.String));
            if (form["TXT_AABR_D"] != "" && form["TXT_AABR_D"] != null)
                insertDataList.Add(new DBItem("AABR_D", form["TXT_AABR_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("AABR_D", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("AABR_M", form["TXT_AABR_M"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("AABR_SC", form["RB_AABR_SC"], DBItem.DBDataType.String));
            if (form["TXT_AABR_SC_D"] != "" && form["TXT_AABR_SC_D"] != null)
                insertDataList.Add(new DBItem("AABR_SC_D", form["TXT_AABR_SC_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("AABR_SC_D", null, DBItem.DBDataType.DataTime));

            var CD = form["CK_CD"];
            var CDV = new List<string>() { "0", "0" };
            if (CD == null)
                insertDataList.Add(new DBItem("CD", String.Join("", CDV), DBItem.DBDataType.String));
            else
            {
                var CD_SP = CD.Split(',');
                foreach (var i in CD_SP)
                    CDV[Convert.ToInt32(i)] = "1";
                insertDataList.Add(new DBItem("CD", String.Join("", CDV), DBItem.DBDataType.String));
            }

            if (form["TXT_CD_D_DAY"] != "" && form["TXT_CD_D_DAY"] != null && form["TXT_CD_D_TIME"] != "" && form["TXT_CD_D_TIME"] != null)
                insertDataList.Add(new DBItem("CD_D", form["TXT_CD_D_DAY"] + " " + form["TXT_CD_D_TIME"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("CD_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("CD_M", form["TXT_CD_M"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("BATH_RS", form["RB_BATH_RS"], DBItem.DBDataType.String));
            if (form["TXT_BATH_RS_D_DAY"] != "" && form["TXT_BATH_RS_D_DAY"] != null && form["TXT_BATH_RS_D_TIME"] != "" && form["TXT_BATH_RS_D_TIME"] != null)
                insertDataList.Add(new DBItem("BATH_RS_D", form["TXT_BATH_RS_D_DAY"] + " " + form["TXT_BATH_RS_D_TIME"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("BATH_RS_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("P_ID", form["RB_P_ID"], DBItem.DBDataType.String));
            if (form["TXT_P_ID_D"] != "" && form["TXT_P_ID_D"] != null)
                insertDataList.Add(new DBItem("P_ID_D", form["TXT_P_ID_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("P_ID_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("M_HIC", form["RB_M_HIC"], DBItem.DBDataType.String));
            if (form["TXT_M_HIC_D"] != "" && form["TXT_M_HIC_D"] != null)
                insertDataList.Add(new DBItem("M_HIC_D", form["TXT_M_HIC_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("M_HIC_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("F_HIC", form["RB_F_HIC"], DBItem.DBDataType.String));
            if (form["TXT_F_HIC_D"] != "" && form["TXT_F_HIC_D"] != null)
                insertDataList.Add(new DBItem("F_HIC_D", form["TXT_F_HIC_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("F_HIC_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("LIH", form["RB_LIH"], DBItem.DBDataType.String));
            if (form["TXT_LIH_D"] != "" && form["TXT_LIH_D"] != null)
                insertDataList.Add(new DBItem("LIH_D", form["TXT_LIH_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("LIH_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("HC", form["RB_HC"], DBItem.DBDataType.String));
            if (form["TXT_HC_D"] != "" && form["TXT_HC_D"] != null)
                insertDataList.Add(new DBItem("HC_D", form["TXT_HC_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("HC_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("TP", form["RB_TP"], DBItem.DBDataType.String));
            if (form["TXT_TP_D"] != "" && form["TXT_TP_D"] != null)
                insertDataList.Add(new DBItem("TP_D", form["TXT_TP_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("TP_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("UC", form["RB_UC"], DBItem.DBDataType.String));
            if (form["TXT_UC_D"] != "" && form["TXT_UC_D"] != null)
                insertDataList.Add(new DBItem("UC_D", form["TXT_UC_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("UC_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("CHM", form["CK_CHM"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("PBS", form["RB_PBS"], DBItem.DBDataType.String));

            var NIP = form["CK_NIP"];
            var NIPV = new List<string>() { "0", "0" };
            if (NIP == null)
                insertDataList.Add(new DBItem("NIP", String.Join("", NIPV), DBItem.DBDataType.String));
            else
            {
                var NIP_SP = NIP.Split(',');
                foreach (var i in NIP_SP)
                    NIPV[Convert.ToInt32(i)] = "1";
                insertDataList.Add(new DBItem("NIP", String.Join("", NIPV), DBItem.DBDataType.String));
            }

            insertDataList.Add(new DBItem("NIP_S", form["TXT_NIP_S"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("NIP_H", form["TXT_NIP_H"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("SR", form["TXT_SR"], DBItem.DBDataType.String));

            insertDataList = setNullToEmpty(insertDataList);
            int erow = link.DBExecInsert("OBS_PEDCHK", insertDataList);

            if (erow > 0)
            {
                link.DBCommit();
                if (kardex)
                    Response.Write("<script>alert('新增成功');window.close();</script>");
                else
                    Response.Write("<script>alert('新增成功');window.location.href='Index?active=Pediatrics_Check_List';</script>");
            }
            else
            {
                link.DBRollBack();
                if (kardex)
                    Response.Write("<script>alert('新增失敗');window.close();</script>");
                else
                    Response.Write("<script>alert('新增失敗');window.location.href='Index?active=Pediatrics_Check_List';</script>");
            }

            return new EmptyResult();
        }
        #endregion

        #region 兒科核對清單編輯
        public ActionResult Upd_PEDCHK(FormCollection form)
        {
            string userno = userinfo.EmployeesNo;
            string feeno = ptinfo?.FeeNo;
            string id = form["IID"];
            bool kardex = Convert.ToBoolean(form["kardex"].ToString() == "" ? "False" : form["kardex"].ToString());
            List<DBItem> insertDataList = new List<DBItem>();
            insertDataList.Add(new DBItem("UPDNO", userno, DBItem.DBDataType.String)); //建立者員編
            insertDataList.Add(new DBItem("UPDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //建立時間
            insertDataList.Add(new DBItem("RECORDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime)); //紀錄時間
            insertDataList.Add(new DBItem("DELETED", null, DBItem.DBDataType.String)); //刪除註記

            insertDataList.Add(new DBItem("WEIGHT_TD", form["TXT_WEIGHT_TD"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("WEIGHT_TM", form["TXT_WEIGHT_TM"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("MILK_B", form["TXT_MILK_B"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("MILK_F", form["RB_MILK_F"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("MILK_AMT", form["TXT_MILK_AMT"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("GIRTH", form["RB_GIRTH"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("GIRTH_H", form["TXT_GIRTH_H"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("GIRTH_B", form["TXT_GIRTH_B"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("GIRTH_L", form["TXT_GIRTH_L"], DBItem.DBDataType.String));

            if (form["TXT_GIRTH_D"] != "" && form["TXT_GIRTH_D"] != null)
                insertDataList.Add(new DBItem("GIRTH_D", form["TXT_GIRTH_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("GIRTH_D", null, DBItem.DBDataType.DataTime));

            if (form["TXT_GIRTH_LD"] != "" && form["TXT_GIRTH_LD"] != null)
                insertDataList.Add(new DBItem("GIRTH_LD", form["TXT_GIRTH_LD"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("GIRTH_LD", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("SOB", form["RB_SOB"], DBItem.DBDataType.String));
            if (form["TXT_SOB_D"] != "" && form["TXT_SOB_D"] != null)
                insertDataList.Add(new DBItem("SOB_D", form["TXT_SOB_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("SOB_D", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("SOB_R", form["TXT_SOB_R"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("UR", form["RB_UR"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("UR_PH", form["TXT_UR_PH"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("UR_SG", form["TXT_UR_SG"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("UR_PT", form["TXT_UR_PT"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("BATH", form["RB_BATH"], DBItem.DBDataType.String));
            if (form["TXT_BATH_D1"] != "" && form["TXT_BATH_D1"] != null)
                insertDataList.Add(new DBItem("BATH_D1", form["TXT_BATH_D1"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("BATH_D1", null, DBItem.DBDataType.DataTime));
            if (form["TXT_BATH_D2"] != "" && form["TXT_BATH_D2"] != null)
                insertDataList.Add(new DBItem("BATH_D2", form["TXT_BATH_D2"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("BATH_D2", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("CBEX", form["RB_CBEX"], DBItem.DBDataType.String));
            if (form["TXT_CBEX_D"] != "" && form["TXT_CBEX_D"] != null)
                insertDataList.Add(new DBItem("CBEX_D", form["TXT_CBEX_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("CBEX_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("HBIG", form["RB_HBIG"], DBItem.DBDataType.String));
            if (form["TXT_HBIG_D"] != "" && form["TXT_HBIG_D"] != null)
                insertDataList.Add(new DBItem("HBIG_D", form["TXT_HBIG_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("HBIG_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("HBSAG", form["TXT_HBSAG"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("HBEAG", form["TXT_HBEAG"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("HBV", form["RB_HBV"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("HBV_N", form["TXT_HBV_N"], DBItem.DBDataType.String));

            var HBV_NR = form["CK_HBV_NR"];
            var HBV_NRV = new List<string>() { "0", "0" };
            if (HBV_NR == null)
                insertDataList.Add(new DBItem("HBV_NR", String.Join("", HBV_NRV), DBItem.DBDataType.String));
            else
            {
                var HBV_NR_SP = HBV_NR.Split(',');
                foreach (var i in HBV_NR_SP)
                    HBV_NRV[Convert.ToInt32(i)] = "1";
                insertDataList.Add(new DBItem("HBV_NR", String.Join("", HBV_NRV), DBItem.DBDataType.String));
            }

            if (form["TXT_HBV_D"] != "" && form["TXT_HBV_D"] != null)
                insertDataList.Add(new DBItem("HBV_D", form["TXT_HBV_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("HBV_D", null, DBItem.DBDataType.DataTime));

            var NBS = form["CK_NBS"];
            var NBSV = new List<string>() { "0", "0", "0", "0" };
            if (NBS == null)
                insertDataList.Add(new DBItem("NBS", String.Join("", NBSV), DBItem.DBDataType.String));
            else
            {
                var NBS_SP = NBS.Split(',');
                foreach (var i in NBS_SP)
                    NBSV[Convert.ToInt32(i)] = "1";
                insertDataList.Add(new DBItem("NBS", String.Join("", NBSV), DBItem.DBDataType.String));
            }

            if (form["TXT_NBS_D"] != "" && form["TXT_NBS_D"] != null)
                insertDataList.Add(new DBItem("NBS_D", form["TXT_NBS_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("NBS_D", null, DBItem.DBDataType.DataTime));

            if (form["TXT_NBS_RC_D1"] != "" && form["TXT_NBS_RC_D1"] != null)
                insertDataList.Add(new DBItem("NBS_RC_D1", form["TXT_NBS_RC_D1"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("NBS_RC_D1", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("NBS_MEMO1", form["TXT_NBS_MEMO1"], DBItem.DBDataType.String));

            if (form["TXT_NBS_RC_D2"] != "" && form["TXT_NBS_RC_D2"] != null)
                insertDataList.Add(new DBItem("NBS_RC_D2", form["TXT_NBS_RC_D2"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("NBS_RC_D2", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("NBS_MEMO2", form["TXT_NBS_MEMO2"], DBItem.DBDataType.String));

            if (form["TXT_NBS_RC_D3"] != "" && form["TXT_NBS_RC_D3"] != null)
                insertDataList.Add(new DBItem("NBS_RC_D3", form["TXT_NBS_RC_D3"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("NBS_RC_D3", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("NBS_MEMO3", form["TXT_NBS_MEMO3"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("AOC", form["RB_AOC"], DBItem.DBDataType.String));
            if (form["TXT_AOC_D"] != "" && form["TXT_AOC_D"] != null)
                insertDataList.Add(new DBItem("AOC_D", form["TXT_AOC_D"], DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("PD", form["RB_PD"], DBItem.DBDataType.String));
            if (form["TXT_PD_D"] != "" && form["TXT_PD_D"] != null)
                insertDataList.Add(new DBItem("PD_D", form["TXT_PD_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("PD_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("SCID", form["RB_SCID"], DBItem.DBDataType.String));
            if (form["TXT_SCID_D"] != "" && form["TXT_SCID_D"] != null)
                insertDataList.Add(new DBItem("SCID_D", form["TXT_SCID_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("SCID_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("FIVEIN1", form["RB_FIVEIN1"], DBItem.DBDataType.String));
            if (form["TXT_FIVEIN1_D"] != "" && form["TXT_FIVEIN1_D"] != null)
                insertDataList.Add(new DBItem("FIVEIN1_D", form["TXT_FIVEIN1_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("FIVEIN1_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("ALD", form["RB_ALD"], DBItem.DBDataType.String));
            if (form["TXT_ALD_D"] != "" && form["TXT_ALD_D"] != null)
                insertDataList.Add(new DBItem("ALD_D", form["TXT_ALD_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("ALD_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("SHL", form["RB_SHL"], DBItem.DBDataType.String));
            if (form["TXT_SHL_D"] != "" && form["TXT_SHL_D"] != null)
                insertDataList.Add(new DBItem("SHL_D", form["TXT_SHL_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("SHL_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("CCHS", form["RB_CCHS"], DBItem.DBDataType.String));
            if (form["TXT_CCHS_D"] != "" && form["TXT_CCHS_D"] != null)
                insertDataList.Add(new DBItem("CCHS_D", form["TXT_CCHS_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("CCHS_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("CMV", form["RB_CMV"], DBItem.DBDataType.String));
            if (form["TXT_CMV_D"] != "" && form["TXT_CMV_D"] != null)
                insertDataList.Add(new DBItem("CMV_D", form["TXT_CMV_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("CMV_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("OTH", form["TXT_OTH"], DBItem.DBDataType.String));


            insertDataList.Add(new DBItem("LGE", form["RB_LGE"], DBItem.DBDataType.String));
            if (form["TXT_LGE_D1"] != "" && form["TXT_LGE_D1"] != null)
                insertDataList.Add(new DBItem("LGE_D1", form["TXT_LGE_D1"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("LGE_D1", null, DBItem.DBDataType.DataTime));
            if (form["TXT_LGE_D2"] != "" && form["TXT_LGE_D2"] != null)
                insertDataList.Add(new DBItem("LGE_D2", form["TXT_LGE_D2"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("LGE_D2", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("BUS", form["RB_BUS"], DBItem.DBDataType.String));
            var BUS_M = form["CK_BUS_M"];
            var BUS_MV = new List<string>() { "0", "0", "0" };
            if (BUS_M == null)
                insertDataList.Add(new DBItem("BUS_M", String.Join("", BUS_MV), DBItem.DBDataType.String));
            else
            {
                var BUS_M_SP = BUS_M.Split(',');
                foreach (var i in BUS_M_SP)
                    BUS_MV[Convert.ToInt32(i)] = "1";
                insertDataList.Add(new DBItem("BUS_M", String.Join("", BUS_MV), DBItem.DBDataType.String));
            }

            if (form["TXT_BUS_D1"] != "" && form["TXT_BUS_D1"] != null)
                insertDataList.Add(new DBItem("BUS_D1", form["TXT_BUS_D1"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("BUS_D1", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("BUS_1R", form["TXT_BUS_1R"], DBItem.DBDataType.String));

            if (form["TXT_BUS_D2"] != "" && form["TXT_BUS_D2"] != null)
                insertDataList.Add(new DBItem("BUS_D2", form["TXT_BUS_D2"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("BUS_D2", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("BUS_2R", form["TXT_BUS_2R"], DBItem.DBDataType.String));

            if (form["TXT_BUS_D3"] != "" && form["TXT_BUS_D3"] != null)
                insertDataList.Add(new DBItem("BUS_D3", form["TXT_BUS_D3"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("BUS_D3", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("BUS_3R", form["TXT_BUS_3R"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("BUS_OTH", form["TXT_BUS_OTH"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("ECG", form["RB_ECG"], DBItem.DBDataType.String));
            var ECG_M = form["CK_ECG_M"];
            var ECG_MV = new List<string>() { "0", "0", "0" };
            if (ECG_M == null)
                insertDataList.Add(new DBItem("ECG_M", String.Join("", ECG_MV), DBItem.DBDataType.String));
            else
            {
                var ECG_M_SP = ECG_M.Split(',');
                foreach (var i in ECG_M_SP)
                    ECG_MV[Convert.ToInt32(i)] = "1";
                insertDataList.Add(new DBItem("ECG_M", String.Join("", ECG_MV), DBItem.DBDataType.String));
            }

            if (form["TXT_ECG_D1"] != "" && form["TXT_ECG_D1"] != null)
                insertDataList.Add(new DBItem("ECG_D1", form["TXT_ECG_D1"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("ECG_D1", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("ECG_1R", form["TXT_ECG_1R"], DBItem.DBDataType.String));

            if (form["TXT_ECG_D2"] != "" && form["TXT_ECG_D2"] != null)
                insertDataList.Add(new DBItem("ECG_D2", form["TXT_ECG_D2"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("ECG_D2", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("ECG_2R", form["TXT_ECG_2R"], DBItem.DBDataType.String));

            if (form["TXT_ECG_D3"] != "" && form["TXT_ECG_D3"] != null)
                insertDataList.Add(new DBItem("ECG_D3", form["TXT_ECG_D3"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("ECG_D3", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("ECG_3R", form["TXT_ECG_3R"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("ECG_OTH", form["TXT_ECG_OTH"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("AUS", form["RB_AUS"], DBItem.DBDataType.String));
            var AUS_M = form["CK_AUS_M"];
            var AUS_MV = new List<string>() { "0", "0", "0" };
            if (AUS_M == null)
                insertDataList.Add(new DBItem("AUS_M", String.Join("", AUS_MV), DBItem.DBDataType.String));
            else
            {
                var AUS_M_SP = AUS_M.Split(',');
                foreach (var i in AUS_M_SP)
                    AUS_MV[Convert.ToInt32(i)] = "1";
                insertDataList.Add(new DBItem("AUS_M", String.Join("", AUS_MV), DBItem.DBDataType.String));
            }

            if (form["TXT_AUS_D1"] != "" && form["TXT_AUS_D1"] != null)
                insertDataList.Add(new DBItem("AUS_D1", form["TXT_AUS_D1"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("AUS_D1", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("AUS_1R", form["TXT_AUS_1R"], DBItem.DBDataType.String));

            if (form["TXT_AUS_D2"] != "" && form["TXT_AUS_D2"] != null)
                insertDataList.Add(new DBItem("AUS_D2", form["TXT_AUS_D2"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("AUS_D2", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("AUS_2R", form["TXT_AUS_2R"], DBItem.DBDataType.String));

            if (form["TXT_AUS_D3"] != "" && form["TXT_AUS_D3"] != null)
                insertDataList.Add(new DBItem("AUS_D3", form["TXT_AUS_D3"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("AUS_D3", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("AUS_3R", form["TXT_AUS_3R"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("HUS", form["RB_HUS"], DBItem.DBDataType.String));
            if (form["TXT_HUS_D"] != "" && form["TXT_HUS_D"] != null)
                insertDataList.Add(new DBItem("HUS_D", form["TXT_HUS_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("HUS_D", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("HUS_M", form["TXT_HUS_M"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("HUS_R", form["TXT_HUS_R"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("AABR", form["RB_AABR"], DBItem.DBDataType.String));
            if (form["TXT_AABR_D"] != "" && form["TXT_AABR_D"] != null)
                insertDataList.Add(new DBItem("AABR_D", form["TXT_AABR_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("AABR_D", null, DBItem.DBDataType.DataTime));
            insertDataList.Add(new DBItem("AABR_M", form["TXT_AABR_M"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("AABR_SC", form["RB_AABR_SC"], DBItem.DBDataType.String));
            if (form["TXT_AABR_SC_D"] != "" && form["TXT_AABR_SC_D"] != null)
                insertDataList.Add(new DBItem("AABR_SC_D", form["TXT_AABR_SC_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("AABR_SC_D", null, DBItem.DBDataType.DataTime));

            var CD = form["CK_CD"];
            var CDV = new List<string>() { "0", "0" };
            if (CD == null)
                insertDataList.Add(new DBItem("CD", String.Join("", CDV), DBItem.DBDataType.String));
            else
            {
                var CD_SP = CD.Split(',');
                foreach (var i in CD_SP)
                    CDV[Convert.ToInt32(i)] = "1";
                insertDataList.Add(new DBItem("CD", String.Join("", CDV), DBItem.DBDataType.String));
            }

            if (form["TXT_CD_D_DAY"] != "" && form["TXT_CD_D_DAY"] != null && form["TXT_CD_D_TIME"] != "" && form["TXT_CD_D_TIME"] != null)
                insertDataList.Add(new DBItem("CD_D", form["TXT_CD_D_DAY"] + " " + form["TXT_CD_D_TIME"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("CD_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("CD_M", form["TXT_CD_M"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("BATH_RS", form["RB_BATH_RS"], DBItem.DBDataType.String));
            if (form["TXT_BATH_RS_D_DAY"] != "" && form["TXT_BATH_RS_D_DAY"] != null && form["TXT_BATH_RS_D_TIME"] != "" && form["TXT_BATH_RS_D_TIME"] != null)
                insertDataList.Add(new DBItem("BATH_RS_D", form["TXT_BATH_RS_D_DAY"] + " " + form["TXT_BATH_RS_D_TIME"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("BATH_RS_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("P_ID", form["RB_P_ID"], DBItem.DBDataType.String));
            if (form["TXT_P_ID_D"] != "" && form["TXT_P_ID_D"] != null)
                insertDataList.Add(new DBItem("P_ID_D", form["TXT_P_ID_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("P_ID_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("M_HIC", form["RB_M_HIC"], DBItem.DBDataType.String));
            if (form["TXT_M_HIC_D"] != "" && form["TXT_M_HIC_D"] != null)
                insertDataList.Add(new DBItem("M_HIC_D", form["TXT_M_HIC_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("M_HIC_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("F_HIC", form["RB_F_HIC"], DBItem.DBDataType.String));
            if (form["TXT_F_HIC_D"] != "" && form["TXT_F_HIC_D"] != null)
                insertDataList.Add(new DBItem("F_HIC_D", form["TXT_F_HIC_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("F_HIC_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("LIH", form["RB_LIH"], DBItem.DBDataType.String));
            if (form["TXT_LIH_D"] != "" && form["TXT_LIH_D"] != null)
                insertDataList.Add(new DBItem("LIH_D", form["TXT_LIH_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("LIH_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("HC", form["RB_HC"], DBItem.DBDataType.String));
            if (form["TXT_HC_D"] != "" && form["TXT_HC_D"] != null)
                insertDataList.Add(new DBItem("HC_D", form["TXT_HC_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("HC_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("TP", form["RB_TP"], DBItem.DBDataType.String));
            if (form["TXT_TP_D"] != "" && form["TXT_TP_D"] != null)
                insertDataList.Add(new DBItem("TP_D", form["TXT_TP_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("TP_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("UC", form["RB_UC"], DBItem.DBDataType.String));
            if (form["TXT_UC_D"] != "" && form["TXT_UC_D"] != null)
                insertDataList.Add(new DBItem("UC_D", form["TXT_UC_D"], DBItem.DBDataType.DataTime));
            else
                insertDataList.Add(new DBItem("UC_D", null, DBItem.DBDataType.DataTime));

            insertDataList.Add(new DBItem("CHM", form["CK_CHM"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("PBS", form["RB_PBS"], DBItem.DBDataType.String));

            var NIP = form["CK_NIP"];
            var NIPV = new List<string>() { "0", "0" };
            if (NIP == null)
                insertDataList.Add(new DBItem("NIP", String.Join("", NIPV), DBItem.DBDataType.String));
            else
            {
                var NIP_SP = NIP.Split(',');
                foreach (var i in NIP_SP)
                    NIPV[Convert.ToInt32(i)] = "1";
                insertDataList.Add(new DBItem("NIP", String.Join("", NIPV), DBItem.DBDataType.String));
            }

            insertDataList.Add(new DBItem("NIP_S", form["TXT_NIP_S"], DBItem.DBDataType.String));
            insertDataList.Add(new DBItem("NIP_H", form["TXT_NIP_H"], DBItem.DBDataType.String));

            insertDataList.Add(new DBItem("SR", form["TXT_SR"], DBItem.DBDataType.String));

            insertDataList = setNullToEmpty(insertDataList);
            string where = " IID = '" + id + "' ";
            insertDataList = setNullToEmpty(insertDataList);
            int erow = obs_m.DBExecUpdate("OBS_PEDCHK", insertDataList, where);

            if (erow > 0)
            {
                link.DBCommit();
                if (kardex)
                    Response.Write("<script>alert('修改成功');window.close();</script>");
                else
                    Response.Write("<script>alert('修改成功');window.location.href='Index?active=Pediatrics_Check_List';</script>");
            }
            else
            {
                link.DBRollBack();
                if (kardex)
                    Response.Write("<script>alert('修改失敗');window.close();</script>");
                else
                    Response.Write("<script>alert('修改失敗');window.location.href='Index?active=Pediatrics_Check_List';</script>");
            }

            return new EmptyResult();
        }
        #endregion

        #region 資料Null轉為空
        private List<DBItem> setNullToEmpty(List<DBItem> data)
        {
            foreach (DBItem d in data)
                if (d.Value == null)
                    d.Value = "";

            return data;
        }
        #endregion

        #region set_dt
        private DataTable set_dt(DataTable dt)
        {
            if (dt.Rows.Count > 0)
            {
                dt.Columns.Add("username");

                string userno = "";
                UserInfo user_name = new UserInfo();
                foreach (DataRow r in dt.Rows)
                {
                    if (r["UPDNO"].ToString() != "")
                    {
                        if (userno != r["UPDNO"].ToString())
                        {
                            userno = r["UPDNO"].ToString();
                            byte[] listByteCode = webService.UserName(userno);
                            string listJsonArray = CompressTool.DecompressString(listByteCode);
                            user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                        }
                        r["username"] = user_name.EmployeesName;
                    }
                }
            }
            return dt;
        }
        #endregion

        #region 新增他人護理紀錄
        public int Insert_CareRecord_ForOtherTns(string feeno, string time, string id, string title, string C, string S, string O, string I, string E, string self, ref DBConnector link)
        {
            int erow = 0; string EMRid = "";
            try
            {
                if (feeno != null && feeno != "")
                {
                    PatientInfo patinfo = new PatientInfo();
                    byte[] listByteCode = webService.GetPatientInfo(feeno);
                    if (listByteCode != null)
                    {
                        string listJsonArray = CompressTool.DecompressString(listByteCode);
                        patinfo = JsonConvert.DeserializeObject<PatientInfo>(listJsonArray);
                    }


                    CareRecord care_record_m = new CareRecord();
                    string sign_userno = care_record_m.sel_guide_userno(this.userinfo.EmployeesNo, Convert.ToDateTime(time), Convert.ToDateTime(time).Hour);
                    DateTime NowTime = DateTime.Now;
                    LogTool lt = new LogTool();
                    List<DBItem> insertDataList = new List<DBItem>();
                    insertDataList.Add(new DBItem("CARERECORD_ID", id, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("CREATNO", this.userinfo.EmployeesNo, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("GUIDE_NO", sign_userno, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("CREATNAME", userinfo.EmployeesName, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("CREATTIME", NowTime.ToString("yyyy/MM/dd HH:mm"), DBItem.DBDataType.DataTime));
                    insertDataList.Add(new DBItem("RECORDTIME", time, DBItem.DBDataType.DataTime));
                    insertDataList.Add(new DBItem("FEENO", patinfo.FeeNo, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("TITLE", trans_date(title), DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("C_OTHER", trans_date(C), DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("S_OTHER", trans_date(S), DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("O_OTHER", trans_date(O), DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("I_OTHER", trans_date(I), DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("E_OTHER", trans_date(E), DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("SELF", self, DBItem.DBDataType.String));
                    insertDataList.Add(new DBItem("SIGN", "N", DBItem.DBDataType.String));
                    erow = link.DBExecInsertTns("CARERECORD_DATA", insertDataList);
                    #region --EMR--
                    try
                    {

                        byte[] tempByte = webService.GetAllergyList(patinfo.FeeNo);
                        string allergyDesc = string.Empty, msg = string.Empty;
                        string RecordTime = NowTime.ToString("yyyy/MM/dd HH:mm:ss");
                        string Temp_NowTime_Str = Convert.ToDateTime(RecordTime).ToString("yyyyMMddHHmmss");//時間採統一變數
                        if (tempByte != null)
                        {
                            List<NIS.Data.PatientInfo> patList = JsonConvert.DeserializeObject<List<NIS.Data.PatientInfo>>(CompressTool.DecompressString(tempByte));
                            allergyDesc = patList[0].AllergyDesc;
                        }

                        if (trans_date(C) != "")
                            msg += trans_date(C) + "\n";
                        if (trans_date(S) != "")
                            msg += "S:" + trans_date(S) + "\n";
                        if (trans_date(O) != "")
                            msg += "O:" + trans_date(O) + "\n";
                        if (trans_date(I) != "")
                            msg += "I:" + trans_date(I) + "\n";
                        if (trans_date(E) != "")
                            msg += "E:" + trans_date(E) + "\n";

                        string xml = care_record_m.care_Record_Get_xml(patinfo.PatientName, patinfo.ChartNo,
                        patinfo.PatientGender, (patinfo.Age).ToString(), patinfo.BedNo, patinfo.InDate.ToString("yyyyMMdd"),
                        patinfo.InDate.ToString("HHmm"), allergyDesc, Convert.ToDateTime(time).ToString("yyyyMMdd"),
                        Convert.ToDateTime(time).ToString("HHmm"), userinfo.EmployeesName, trans_date(title), msg);
                        //SaveEMRLogData(id + self, GetMd5Hash(id + self), "EMR", RecordTime, "A000040" + GetMd5Hash(id + self) + Temp_NowTime_Str, xml);

                        //取得應簽章人員
                        tempByte = webService.UserName(userinfo.Guider);
                        if (tempByte != null)
                        {
                            string listJsonArray = CompressTool.DecompressString(tempByte);
                            UserInfo user_info = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                            string EmrXmlString = this.get_xml(
                                NowTime.ToString("yyyyMMddHHmmss.fffffff"), Temp_NowTime_Str + GetMd5Hash(id + self), "A000040", Convert.ToDateTime(time).ToString("yyyyMMdd"),
                                GetMd5Hash(id + self), Convert.ToDateTime(time).ToString("yyyyMMdd"), "", "",
                                user_info.EmployeesNo, user_info.EmployeesName, user_info.UserID, patinfo.ChartNo, patinfo.PatientName,
                                patinfo.PatientID, patinfo.PayInfo,
                                "C:\\EMR\\", "A000040" + GetMd5Hash(id + self) + Temp_NowTime_Str + ".xml", listJsonArray, "Insert_CareRecordTns"
                                );
                            //SaveEMRLogData(id + self, GetMd5Hash(id + self), "Temp", RecordTime, Temp_NowTime_Str + "-" + GetMd5Hash(id + self), EmrXmlString);
                            EMRid = id + self;
                        }
                        else
                        {
                            lt.saveLogMsg(userinfo.EmployeesNo + "_" + userinfo.Guider + "_" + id + self + "_" + GetMd5Hash(id + self), "EMRLogTns");
                        }

                        erow = EMR_Sign(time, id, msg, title, self, feeno);

                    }
                    catch (Exception ex)
                    {
                        lt.saveLogMsg("EMRid= \t" + EMRid + "\t" + ex.Message.ToString(), "EMRLog");

                    }
                    #endregion
                }
            }
            catch (Exception ex)
            {
                //寫入 write_logMsg(controllerName, loginID, actionName, errorMsg)     
                string tmp_controller = ControllerContext.RouteData.Values["controller"].ToString();
                string tmp_action = ControllerContext.RouteData.Values["action"].ToString();
                write_logMsg(tmp_controller, userinfo.EmployeesNo, tmp_action, ex.ToString(), "EMRLogTns", EMRid, ex);
            }

            return erow;
        }
        #endregion

        #region 編輯他人護理紀錄
        public int Upd_CareRecord_ForOtherTns(string feeno, string time, string id, string title, string C, string S, string O, string I, string E, string self, ref DBConnector link)
        {
            int erow = 0;
            if (feeno != null && feeno != "")
            {
                PatientInfo patinfo = new PatientInfo();
                byte[] listByteCode = webService.GetPatientInfo(feeno);
                if (listByteCode != null)
                {
                    string listJsonArray = CompressTool.DecompressString(listByteCode);
                    patinfo = JsonConvert.DeserializeObject<PatientInfo>(listJsonArray);
                }

                CareRecord care_record_m = new CareRecord();
                string sign_userno = care_record_m.sel_guide_userno(this.userinfo.EmployeesNo, Convert.ToDateTime(time), Convert.ToDateTime(time).Hour);
                DateTime NowTime = DateTime.Now;

                List<DBItem> insertDataList = new List<DBItem>();
                insertDataList.Add(new DBItem("UPDNO", this.userinfo.EmployeesNo, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("GUIDE_NO", sign_userno, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("UPDTIME", NowTime.ToString("yyyy/MM/dd HH:mm"), DBItem.DBDataType.DataTime));
                insertDataList.Add(new DBItem("RECORDTIME", time, DBItem.DBDataType.DataTime));
                insertDataList.Add(new DBItem("TITLE", trans_date(title), DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("C_OTHER", trans_date(C), DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("S_OTHER", trans_date(S), DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("O_OTHER", trans_date(O), DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("I_OTHER", trans_date(I), DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("E_OTHER", trans_date(E), DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("SIGN", "N", DBItem.DBDataType.String));

                erow = link.DBExecUpdateTns("CARERECORD_DATA", insertDataList, "CARERECORD_ID = '" + id + "' AND SELF = '" + self + "' ");
                #region --EMR--
                try
                {
                    if (erow > 0 && id != "")
                    {
                        insertDataList.Clear();
                        insertDataList.Add(new DBItem("STATUS", "M", DBItem.DBDataType.String));
                        string EMRwhere = " RECORD_KEY  = '" + id + "' AND SELF = '" + self + "'";
                        erow = care_record_m.DBExecUpdate("NIS_EMR_PACKAGE_DTL", insertDataList, EMRwhere);

                    }
                    byte[] tempByte = webService.GetAllergyList(patinfo.FeeNo);
                    string allergyDesc = string.Empty, msg = string.Empty;
                    string RecordTime = NowTime.ToString("yyyy/MM/dd HH:mm:ss");
                    string Temp_NowTime_Str = Convert.ToDateTime(RecordTime).ToString("yyyyMMddHHmmss");//時間採統一變數
                    if (tempByte != null)
                    {
                        List<NIS.Data.PatientInfo> patList = JsonConvert.DeserializeObject<List<NIS.Data.PatientInfo>>(CompressTool.DecompressString(tempByte));
                        allergyDesc = patList[0].AllergyDesc;
                    }

                    if (trans_date(C) != "")
                        msg += trans_date(C) + "\n";
                    if (trans_date(S) != "")
                        msg += "S:" + trans_date(S) + "\n";
                    if (trans_date(O) != "")
                        msg += "O:" + trans_date(O) + "\n";
                    if (trans_date(I) != "")
                        msg += "I:" + trans_date(I) + "\n";
                    if (trans_date(E) != "")
                        msg += "E:" + trans_date(E) + "\n";

                    string xml = care_record_m.care_Record_Get_xml(patinfo.PatientName, patinfo.ChartNo,
                       patinfo.PatientGender, (patinfo.Age).ToString(), patinfo.BedNo, patinfo.InDate.ToString("yyyyMMdd"),
                       patinfo.InDate.ToString("HHmm"), allergyDesc, Convert.ToDateTime(time).ToString("yyyyMMdd"),
                       Convert.ToDateTime(time).ToString("HHmm"), userinfo.EmployeesName, trans_date(title), msg);
                    //SaveEMRLogData(id + self, GetMd5Hash(id + self), "EMR", RecordTime, "A000040" + GetMd5Hash(id + self) + Temp_NowTime_Str, xml);

                    //取得應簽章人員
                    tempByte = webService.UserName(userinfo.Guider);
                    if (tempByte != null)
                    {
                        string listJsonArray = CompressTool.DecompressString(tempByte);
                        UserInfo user_info = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                        string EmrXmlString = this.get_xml(
                            NowTime.ToString("yyyyMMddHHmmss.fffffff"), Temp_NowTime_Str + GetMd5Hash(id + self), "A000040", Convert.ToDateTime(time).ToString("yyyyMMdd"),
                             GetMd5Hash(id + self), Convert.ToDateTime(time).ToString("yyyyMMdd"), "", "",
                             user_info.EmployeesNo, user_info.EmployeesName, user_info.UserID, patinfo.ChartNo, patinfo.PatientName,
                            patinfo.PatientID, patinfo.PayInfo,
                            "C:\\EMR\\", "A000040" + GetMd5Hash(id + self) + Temp_NowTime_Str + ".xml", listJsonArray, "Upd_CareRecordTns"
                            );
                        //SaveEMRLogData(id + self, GetMd5Hash(id + self), "Temp", RecordTime, Temp_NowTime_Str + "-" + GetMd5Hash(id + self), EmrXmlString);
                    }
                    erow = EMR_Sign(time, id, msg, title, self, feeno);

                }
                catch { }
                #endregion
            }

            return erow;
        }
        #endregion

        #region I/O
        /// <summary>
        /// 帶入IO
        /// </summary>
        /// <param name="time">紀錄時間</param>
        /// <param name="id">ID</param>
        /// <param name="typeid">種類序號</param>
        /// <param name="itemid">項目序號</param>
        /// <param name="amount">數量</param>
        /// <param name="amount_unit">單位(1:mL  2:g 3:mg)</param>
        public int Insert_IO_DATA_ForOther(string feeno, string time, string id, string typeid, string itemid, string amount, string amount_unit, string source_id, string source_tablename, string reason = "", string explanation_item = "")
        {
            int erow = 0;
            if (feeno != null)
            {
                //DBConnector dbconnector = new DBConnector();
                string userno = userinfo.EmployeesNo;
                string DATA_SOURCE = "NIS";
                if (id.Substring(0, 3) == "OBS")
                    DATA_SOURCE = "OBS";
                else
                    DATA_SOURCE = "NIS";

                List<DBItem> insertDataList = new List<DBItem>();
                insertDataList.Add(new DBItem("IO_ROW", "IO_DATA_SEQUENCE.NEXTVAL", DBItem.DBDataType.Number));
                insertDataList.Add(new DBItem("IO_ID", id, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("FEENO", feeno, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("CREANO", userno, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("CREANAME", userinfo.EmployeesName, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("CREATTIME", time, DBItem.DBDataType.DataTime));
                insertDataList.Add(new DBItem("TYPEID", typeid, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("ITEMID", itemid, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("AMOUNT", amount, DBItem.DBDataType.Number));
                insertDataList.Add(new DBItem("AMOUNT_UNIT", amount_unit, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("EXPLANATION_ITEM", explanation_item, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("UPDNO", userno, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("UPDNAME", userinfo.EmployeesName, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("UPDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime));
                insertDataList.Add(new DBItem("SOURCE_ID", source_id, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("SOURCE", source_tablename, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("DATA_SOURCE", DATA_SOURCE, DBItem.DBDataType.String));

                if (reason != "")
                    insertDataList.Add(new DBItem("REASON", reason, DBItem.DBDataType.String));

                erow = link.DBExecInsert("IO_DATA", insertDataList);
            }
            return erow;
        }

        #region 連動修改I/O
        /// <summary>
        /// 修改 IO
        /// </summary>
        /// <param name="time">紀錄時間</param>
        /// <param name="id">ID</param>
        /// <param name="typeid">種類序號</param>
        /// <param name="itemid">項目序號</param>
        /// <param name="amount">數量</param>
        /// <param name="amount_unit">單位(1:mL  2:g 3:mg)</param>
        public int Update_IO_DATA_ForOther(string feeno, string time, string id, string typeid, string itemid, string amount, string amount_unit, string source_id, string source_tablename, string reason = "", string explanation_item = "")
        {
            int erow = 0;
            if (feeno != null)
            {
                //DBConnector dbconnector = new DBConnector();
                string userno = userinfo.EmployeesNo;
                List<DBItem> insertDataList = new List<DBItem>();
                //insertDataList.Add(new DBItem("CREANO", userno, DBItem.DBDataType.String));
                //insertDataList.Add(new DBItem("CREANAME", userinfo.EmployeesName, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("CREATTIME", time, DBItem.DBDataType.DataTime));
                insertDataList.Add(new DBItem("TYPEID", typeid, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("ITEMID", itemid, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("AMOUNT", amount, DBItem.DBDataType.Number));
                insertDataList.Add(new DBItem("AMOUNT_UNIT", amount_unit, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("EXPLANATION_ITEM", explanation_item, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("UPDNO", userno, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("UPDNAME", userinfo.EmployeesName, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("UPDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime));
                //insertDataList.Add(new DBItem("SOURCE_ID", source_id, DBItem.DBDataType.String));
                //insertDataList.Add(new DBItem("SOURCE", source_tablename, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("REASON", reason, DBItem.DBDataType.String));

                string where = "FEENO = '" + feeno + "' AND SOURCE_ID = '" + source_id + "' AND SOURCE = '" + source_tablename + "' ";
                erow = link.DBExecUpdate("IO_DATA", insertDataList, where);
            }
            return erow;
        }
        #endregion

        /// <summary>
        /// 刪除IO
        /// </summary>
        /// <param name="time">紀錄時間</param>
        /// <param name="typeid">種類序號</param>
        /// <param name="itemid">項目序號</param>
        /// <param name="amount">數量</param>
        /// <param name="amount_unit">單位(1:mL  2:g 3:mg)</param>
        public int Delete_IO_DATA_ForOther(string feeno, string source_id, string source_tablename)
        {
            int erow = 0;
            if (feeno != null)
            {
                //DBConnector dbconnector = new DBConnector();
                string userno = userinfo.EmployeesNo;

                List<DBItem> insertDataList = new List<DBItem>();
                insertDataList.Add(new DBItem("DELETED", userno, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("UPDNO", userno, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("UPDNAME", userinfo.EmployeesName, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("UPDTIME", DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"), DBItem.DBDataType.DataTime));

                string where = "FEENO = '" + ptinfo.FeeNo + "' AND SOURCE_ID = '" + source_id + "' AND SOURCE = '" + source_tablename + "' ";
                erow = link.DBExecUpdate("IO_DATA", insertDataList, where);
            }
            return erow;
        }


        #region --IO，顏色、氣味、形狀--
        /// <summary>
        /// 新增IO，副加形容(顏色、氣味、形狀)
        /// </summary>
        /// <param name="id">IO的ID</param>
        /// <param name="color_drainage">顏色</param>
        /// <param name="color_other">顏色的其他</param>
        /// <param name="nature_drainage">性狀</param>
        /// <param name="nature_other">性狀的其他</param>
        /// <param name="taste_drainage">氣味</param>
        /// <param name="taste_other">氣味的其他</param>
        /// <returns></returns>
        public int Insert_IO_Additional_forOther(string feeno, string id, string color_drainage, string color_other, string nature_drainage, string nature_other, string taste_drainage, string taste_other)
        {
            int erow = 0;
            if (feeno != null && id != "")
            {
                //DBConnector dbconnector = new DBConnector();
                List<DBItem> insertDataList = new List<DBItem>();
                insertDataList.Clear();
                insertDataList.Add(new DBItem("FEATUREID", id, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("COLORID", color_drainage, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("COLOROTHER", (color_other == null) ? "" : color_other.Trim(), DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("NATUREID", nature_drainage, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("NATUREOTHER", (nature_other == null) ? "" : nature_other.Trim(), DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("TASTEID", taste_drainage, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("TASTEOTHER", (taste_other == null) ? "" : taste_other.Trim(), DBItem.DBDataType.String));
                erow = link.DBExecInsert("TUBE_FEATURE", insertDataList);
                insertDataList.Clear();
            }
            return erow;
        }



        /// <summary>
        /// 更新IO，副加形容(顏色、氣味、形狀)
        /// </summary>
        /// <param name="id"></param>
        /// <param name="color_drainage"></param>
        /// <param name="color_other"></param>
        /// <param name="nature_drainage"></param>
        /// <param name="nature_other"></param>
        /// <param name="taste_drainage"></param>
        /// <param name="taste_other"></param>
        /// <returns></returns>
        public int Update_IO_Additional_forOther(string feeno, string id, string color_drainage, string color_other, string nature_drainage, string nature_other, string taste_drainage, string taste_other)
        {
            int erow = 0;
            if (feeno != null && id != "")
            {
                //DBConnector dbconnector = new DBConnector();
                List<DBItem> insertDataList = new List<DBItem>();
                insertDataList.Clear();
                //insertDataList.Add(new DBItem("FEATUREID", id, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("COLORID", color_drainage, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("COLOROTHER", (color_other == null) ? "" : color_other.Trim(), DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("NATUREID", nature_drainage, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("NATUREOTHER", (nature_other == null) ? "" : nature_other.Trim(), DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("TASTEID", taste_drainage, DBItem.DBDataType.String));
                insertDataList.Add(new DBItem("TASTEOTHER", (taste_other == null) ? "" : taste_other.Trim(), DBItem.DBDataType.String));
                erow = link.DBExecUpdate("TUBE_FEATURE", insertDataList, "FEATUREID='" + id + "'");
                insertDataList.Clear();
            }
            return erow;
        }
        #endregion


        #endregion

        #region 首頁總資料
        public class GAssessment
        {
            /// <summary>
            /// 高危險妊娠
            /// </summary>
            public string GPREG { set; get; }
            /// <summary>
            /// 入院原因
            /// </summary>
            public string GReason { set; get; }
            /// <summary>
            /// 妊娠週數
            /// </summary>
            public string GWeek { set; get; }
            /// <summary>
            /// 預產期
            /// </summary>
            public string GExpectedDate { set; get; }
            /// <summary>
            /// 孕次(G)
            /// </summary>
            public string GG { set; get; }
            /// <summary>
            /// 產次(P)
            /// </summary>
            public string GP { set; get; }
            /// <summary>
            /// 總活產數
            /// </summary>
            public string LBTotalN { set; get; }
            /// <summary>
            /// 生產方式
            /// </summary>
            public string BirthType { set; get; }
            /// <summary>
            /// 嬰兒出生時間
            /// </summary>
            public string GBirthTime { set; get; }
            /// <summary>
            /// 新生兒動向
            /// </summary>
            public string CHILD_SENT { set; get; }

            /// <summary>
            /// 胎膜破裂時間
            /// </summary>
            public string GRFMTime { set; get; }
            /// <summary>
            /// 總破水時間
            /// </summary>
            public string GRuptureTime { set; get; }
            /// <summary>
            /// 規則陣痛時間
            /// </summary>
            public string GThroeTime { set; get; }
            /// <summary>
            /// 子宮頸全開時間
            /// </summary>
            public string GCervicalTime { set; get; }
            /// <summary>
            /// 胎盤娩出時間
            /// </summary>
            public string GPlacentaTime { set; get; }
            /// <summary>
            /// 第一產程
            /// </summary>
            public string GOneBth { set; get; }
            /// <summary>
            /// 第二產程
            /// </summary>
            public string GTwoBth { set; get; }
            /// <summary>
            /// 第三產程
            /// </summary>
            public string GThreeBth { set; get; }
            /// <summary>
            /// 總產程
            /// </summary>
            public string GTotalBth { set; get; }
        }
        #endregion

        #region 值不為空回傳True，否則為False
        public bool IsNoEmpty(string str)
        {
            if (str != null && str != "")
                return true;
            else
                return false;
        }
        #endregion

        #region 早產兒體重表繪圖設定
        [DataContract]
        public class DataPoint
        {
            public DataPoint(double x, double y, string markerType = "none", string indexLabel = "", int indexLabelFontSize = 10)
            {
                this.X = x;
                this.Y = y;
                this.MarkerType = markerType;
                this.IndexLabel = indexLabel;
                this.indexLabelFontSize = indexLabelFontSize;
            }

            //Explicitly setting the name to be used while serializing to JSON.
            [DataMember(Name = "x")]
            public Nullable<double> X = null;

            //Explicitly setting the name to be used while serializing to JSON.
            [DataMember(Name = "y")]
            public Nullable<double> Y = null;

            [DataMember(Name = "markerType")]
            public string MarkerType = "none";

            [DataMember(Name = "indexLabel")]
            public string IndexLabel = "";

            [DataMember(Name = "indexLabelFontSize")]
            public int indexLabelFontSize = 12;
        }
        #endregion


        #region 產嬰報表
        public ActionResult OBSReport()
        {
            return View();
        }
        #endregion

        #region 產檢明細表(開始時間)
        [HttpGet]
        public void Production_Export(string PP_CHARTNO, string PP_ID, string CHECKST_DAY, string CHECKST_TIME, string CHECKET_DAY, string CHECKET_TIME)
        {
            DateTime? CHECKST = null;
            DateTime? CHECKET = null;
            if (IsNoEmpty(CHECKST_DAY) && IsNoEmpty(CHECKST_TIME))
                CHECKST = Convert.ToDateTime(CHECKST_DAY + " " + CHECKST_TIME);
            if (IsNoEmpty(CHECKET_DAY) && IsNoEmpty(CHECKET_TIME))
                CHECKET = Convert.ToDateTime(CHECKET_DAY + " " + CHECKET_TIME);

            DataTable dt = obs_m.sel_exechk("", PP_CHARTNO, PP_ID, CHECKST, CHECKET);
            Dictionary<string, List<ProductionExport>> dict = new Dictionary<string, List<ProductionExport>>();
            foreach (DataRow r in dt.Rows)
            {
                var temp = new ProductionExport();
                temp.ChartNo = r["PP_CHARTNO"].ToString();
                temp.Name = r["PP_NAME"].ToString();
                temp.StartTime = Convert.ToDateTime(r["CHECKST"].ToString()).ToString("yyyy/MM/dd HH:mm");
                temp.EndTime = Convert.ToDateTime(r["CHECKET"].ToString()).ToString("yyyy/MM/dd HH:mm");
                switch (r["PP_FROM"].ToString() ?? "")
                {
                    case "1":
                        temp.From = "急診";
                        break;
                    case "2":
                        temp.From = "自行來診";
                        break;
                    case "3":
                        temp.From = "會診";
                        break;
                    case "4":
                        temp.From = "住院";
                        break;
                    case "5":
                        temp.From = "門診";
                        break;
                    default:
                        temp.From = null;
                        break;
                }
                switch (r["PP_TO"].ToString() ?? "")
                {
                    case "1":
                        temp.To = "門診";
                        break;
                    case "2":
                        temp.To = "住院";
                        break;
                    case "3":
                        temp.To = "自行返家";
                        break;
                    case "4":
                        temp.To = "院內活動";
                        break;
                    case "5":
                        temp.To = "留觀";
                        break;
                    case "6":
                        temp.To = "POR(恢復室)";
                        break;
                    case "7":
                        temp.To = "返急診";
                        break;
                    case "8":
                        temp.To = "MBD出院";
                        break;
                    case "9":
                        temp.To = r["PP_TO_OTH"].ToString();
                        break;
                    default:
                        temp.To = null;
                        break;
                }

                if (r["PP_CHECKITEM"].ToString() == "1")
                {
                    temp.Item = "胎心音";
                }
                else if (r["PP_CHECKITEM"].ToString() == "2")
                {
                    temp.Item = "RU486";
                }
                else if (r["PP_CHECKITEM"].ToString() == "3")
                {
                    temp.Item = "羊水檢查";
                }
                else if (r["PP_CHECKITEM"].ToString() == "4")
                {
                    temp.Item = "超音波檢查";
                }
                else if (r["PP_CHECKITEM"].ToString() == "5")
                {
                    temp.Item = "其他";
                }

                if (r["PP_CHECKITEM"].ToString() != "1")
                {
                    temp.Result = r["CHECK_REP1"].ToString();
                    temp.Result2 = r["CHECK_REP2"].ToString();
                }
                else
                {
                    var result = "";
                    if (r["REP1_FH_FH1"].ToString() != "" && r["REP1_FH_FH2"].ToString() != "")
                    {
                        result += "胎心音:" + r["REP1_FH_FH1"] + "~" + r["REP1_FH_FH2"] + "。";
                    }
                    if (r["REP1_FH_FHT"].ToString() != "")
                    {
                        switch (r["REP1_FH_FHT"].ToString())
                        {
                            case "0":
                                result += "早期減速。";
                                break;
                            case "1":
                                result += "晚期減速。";
                                break;
                            case "2":
                                result += "變異性減速。";
                                break;
                            default:
                                result += "";
                                break;
                        }
                    }
                    if ((r["REP1_FH_UCDU1"].ToString() != "" && r["REP1_FH_UCDU2"].ToString() != "") || (r["REP1_FH_UCINT1"].ToString() != "" && r["REP1_FH_UCINT2"].ToString() != ""))
                    {
                        result += "宮縮:";
                        if (r["REP1_FH_UCDU1"].ToString() != "" && r["REP1_FH_UCDU2"].ToString() != "")
                        {
                            result += "持續時間：" + r["REP1_FH_UCDU1"] + "~" + r["REP1_FH_UCDU2"] + "秒。";
                        }
                        if (r["REP1_FH_UCINT1"].ToString() != "" && r["REP1_FH_UCINT2"].ToString() != "")
                        {
                            result += "間隔時間：" + r["REP1_FH_UCINT1"] + "~" + r["REP1_FH_UCINT2"] + "分。";
                        }
                    }
                    if (r["REP1_FH_UCSTR"].ToString() != "")
                    {
                        switch (r["REP1_FH_UCSTR"].ToString())
                        {
                            case "0":
                                result += "強度：無。";
                                break;
                            case "1":
                                result += "強度：弱。";
                                break;
                            case "2":
                                result += "強度：中。";
                                break;
                            case "3":
                                result += "強度：強。";
                                break;
                            default:
                                result += "";
                                break;
                        }
                    }
                    if (r["REP1_FH_UCE"].ToString() != "" && r["REP1_FH_UCT"].ToString() != "" && r["REP1_FH_UCH"].ToString() != "" || r["REP1_FH_ROM"].ToString() != "")
                    {
                        result += "子宮頸:";

                        if (r["REP1_FH_UCE"].ToString() != "")
                        {
                            result += "擴張程度(O.S):" + r["REP1_FH_UCE"] + "cm。";
                        }
                        if (r["REP1_FH_UCT"].ToString() != "")
                        {
                            result += "變薄程度:" + r["REP1_FH_UCT"] + "0%。";
                        }
                        if (r["REP1_FH_UCH"].ToString() != "")
                        {
                            result += "胎頭高度（ST）:" + r["REP1_FH_UCH"] + "。";
                        }
                        if (r["REP1_FH_ROM"].ToString() != "")
                        {
                            result += "破水:" + (r["REP1_FH_ROM"].ToString() == "1" ? "是。" : "否。");
                        }
                    }
                    temp.Result = result;

                    var result2 = "";
                    if (r["REP2_FH_FH1"].ToString() != "" && r["REP2_FH_FH2"].ToString() != "")
                    {
                        result2 += "胎心音:" + r["REP2_FH_FH1"] + "~" + r["REP2_FH_FH2"] + "。";
                    }
                    if (r["REP2_FH_FHT"].ToString() != "")
                    {
                        switch (r["REP2_FH_FHT"].ToString())
                        {
                            case "0":
                                result2 += "早期減速。";
                                break;
                            case "1":
                                result2 += "晚期減速。";
                                break;
                            case "2":
                                result2 += "變異性減速。";
                                break;
                            default:
                                result2 += "";
                                break;
                        }
                    }
                    if ((r["REP2_FH_UCDU1"].ToString() != "" && r["REP2_FH_UCDU2"].ToString() != "") || (r["REP2_FH_UCINT1"].ToString() != "" && r["REP2_FH_UCINT2"].ToString() != ""))
                    {
                        result2 += "宮縮:";
                        if (r["REP2_FH_UCDU1"].ToString() != "" && r["REP2_FH_UCDU2"].ToString() != "")
                        {
                            result2 += "持續時間：" + r["REP2_FH_UCDU1"] + "~" + r["REP2_FH_UCDU2"] + "秒。";
                        }
                        if (r["REP2_FH_UCINT1"].ToString() != "" && r["REP2_FH_UCINT2"].ToString() != "")
                        {
                            result2 += "間隔時間：" + r["REP2_FH_UCINT1"] + "~" + r["REP2_FH_UCINT2"] + "分。";
                        }
                    }
                    if (r["REP2_FH_UCSTR"].ToString() != "")
                    {
                        switch (r["REP2_FH_UCSTR"].ToString())
                        {
                            case "0":
                                result2 += "強度：無。";
                                break;
                            case "1":
                                result2 += "強度：弱。";
                                break;
                            case "2":
                                result2 += "強度：中。";
                                break;
                            case "3":
                                result2 += "強度：強。";
                                break;
                            default:
                                result2 += "";
                                break;
                        }
                    }
                    if (r["REP2_FH_UCE"].ToString() != "" && r["REP2_FH_UCT"].ToString() != "" && r["REP2_FH_UCH"].ToString() != "" || r["REP2_FH_ROM"].ToString() != "")
                    {
                        result2 += "子宮頸:";

                        if (r["REP2_FH_UCE"].ToString() != "")
                        {
                            result2 += "擴張程度(O.S):" + r["REP2_FH_UCE"] + "cm。";
                        }
                        if (r["REP2_FH_UCT"].ToString() != "")
                        {
                            result2 += "變薄程度:" + r["REP2_FH_UCT"] + "0%。";
                        }
                        if (r["REP2_FH_UCH"].ToString() != "")
                        {
                            result2 += "胎頭高度（ST）:" + r["REP2_FH_UCH"] + "。";
                        }
                        if (r["REP2_FH_ROM"].ToString() != "")
                        {
                            result2 += "破水:" + (r["REP2_FH_ROM"].ToString() == "1" ? "是。" : "否。");
                        }
                    }
                    temp.Result2 = result2;
                }

                if (r["UPDNO"].ToString() != "")
                {
                    byte[] listByteCode1 = webService.UserName(r["UPDNO"].ToString());
                    if (listByteCode1 == null) { }
                    else
                    {
                        string listJsonArray = CompressTool.DecompressString(listByteCode1);
                        UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                        temp.Creater = user_name.EmployeesName;
                    }
                }
                else
                {
                    byte[] listByteCode1 = webService.UserName(r["CREATNO"].ToString());
                    if (listByteCode1 == null) { }
                    else
                    {
                        string listJsonArray = CompressTool.DecompressString(listByteCode1);
                        UserInfo user_name = JsonConvert.DeserializeObject<UserInfo>(listJsonArray);
                        temp.Creater = user_name.EmployeesName;
                    }
                }

                if (dict.ContainsKey(r["RECORDDAY"].ToString()))
                {
                    dict[r["RECORDDAY"].ToString()].Add(temp);
                }
                else
                {
                    dict.Add(r["RECORDDAY"].ToString(), new List<ProductionExport>() { temp });
                }
            }

            XLWorkbook workbook = new XLWorkbook();
            var sheet = workbook.Worksheets.Add("產檢項目");
            int colIdx = 1;

            //20200331 第一列保留給標題
            //int rowIdx = 1;
            int rowIdx = 2;
            sheet.Cell(1, 1).Value = string.Format("產檢明細表({0}-{1})", CHECKST.Value.ToString("yyyy/MM/dd"), CHECKET.Value.ToString("yyyy/MM/dd"));
            sheet.Cell(1, 1).Style.Alignment.Horizontal = XLAlignmentHorizontalValues.Center;
            var colLen = typeof(ProductionExport).GetProperties().Length;
            sheet.Range(1, 1, 1, colLen).Row(1).Merge();
            // end 20200331 第一列保留給標題

            sheet.Cell(rowIdx, 1).Value = "範圍區間";
            sheet.Cell(rowIdx, 2).Value = $"{CHECKST.Value.ToString("yyyy/MM/dd HH:mm")}~{CHECKET.Value.ToString("yyyy/MM/dd HH:mm")}";
            sheet.Range(rowIdx, 2, rowIdx, 4).Merge();
            rowIdx++;

            foreach (var d in dict)
            {
                sheet.Cell(rowIdx++, 1).Value = string.Concat("'", Convert.ToDateTime(d.Key).ToString("yyyy/MM/dd"));
                colIdx = 1;
                foreach (var item in typeof(ProductionExport).GetProperties())
                {
                    #region - 可以使用 DescriptionAttribute 設定，找不到 DescriptionAttribute 時改用屬性名稱 -
                    DescriptionAttribute description = item.GetCustomAttribute(typeof(DescriptionAttribute)) as DescriptionAttribute;
                    if (description != null)
                    {
                        sheet.Cell(rowIdx, colIdx++).Value = description.Description;
                        continue;
                    }
                    sheet.Cell(rowIdx, colIdx++).Value = item.Name;
                    #endregion
                }
                //資料起始列位置
                rowIdx += 1;
                foreach (var item in d.Value)
                {
                    //每筆資料欄位起始位置
                    int conlumnIndex = 1;
                    foreach (var jtem in item.GetType().GetProperties())
                    {
                        //將資料內容加上 "'" 避免受到 excel 預設格式影響，並依 row 及 column 填入
                        sheet.Cell(rowIdx, conlumnIndex).Value = string.Concat("'", Convert.ToString(jtem.GetValue(item, null)));
                        conlumnIndex++;
                    }
                    rowIdx++;
                }
                sheet.Cell(rowIdx++, 1).Value = $"共{d.Value.Count()}筆";
            }

            sheet.Cell(rowIdx++, 9).Value = $"總筆數：{dt.Rows.Count}筆";

            //sheet.Columns().AdjustToContents();  // Adjust column width
            //sheet.Rows().AdjustToContents();     // Adjust row heights

            //存檔至指定位置
            System.Web.HttpContext.Current.Response.Clear();
            System.Web.HttpContext.Current.Response.Buffer = true;
            System.Web.HttpContext.Current.Response.Charset = "";
            System.Web.HttpContext.Current.Response.ContentType = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";
            System.Web.HttpContext.Current.Response.AddHeader("content-disposition", $@"attachment;filename=產檢項目_{DateTime.Now.ToString("yyyyMMdd")}.xlsx");
            using (MemoryStream MyMemoryStream = new MemoryStream())
            {
                workbook.SaveAs(MyMemoryStream);
                MyMemoryStream.WriteTo(System.Web.HttpContext.Current.Response.OutputStream);
            }
            System.Web.HttpContext.Current.Response.Flush();
            System.Web.HttpContext.Current.Response.End();
        }
        #endregion

        #region 母親明細表(生產日期)(排序 1.生產日期 2.母親病歷號)
        [HttpGet]
        public void MomDetail_Export(string START_DAY, string START_TIME, string END_DAY, string END_TIME)
        {
            DateTime? START = null;
            DateTime? END = null;
            if (IsNoEmpty(START_DAY) && IsNoEmpty(START_TIME))
                START = Convert.ToDateTime(START_DAY + " " + START_TIME);
            if (IsNoEmpty(END_DAY) && IsNoEmpty(END_TIME))
                END = Convert.ToDateTime(END_DAY + " " + END_TIME);

            string sql = @"SELECT  S.*, H.EDC, H.VBAC, H.PREG, H.PREG_ITM, H.PREG_OTH, H.ROOM_IN, H.FEED, H.PAT_ZONE
FROM OBS_BTHSTA S
LEFT JOIN OBS_BTHHIS H
ON S.FEENO = H.FEENO
WHERE 0 = 0";
            if (START != null && END != null)
                sql += $" AND S.BIRTH BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";
            sql += " AND S.DELETED IS NULL ORDER BY S.BIRTH, S.FEENO";
            DataTable dt = obs_m.DBExecSQL(sql);

            List<MomDetailExport> data = new List<MomDetailExport>();
            if (dt != null && dt.Rows.Count > 0)
            {
                foreach (DataRow r in dt.Rows)
                {
                    var temp = new MomDetailExport();
                    var MomInfo = Get_Patient_Info(r["FEENO"].ToString());
                    temp.MomChartNo = MomInfo.ChartNo;
                    temp.MomName = MomInfo.PatientName;

                    #region 產傷兒數/類固醇施打
                    byte[] listByteCode = webService.GetBirthTrauma(MomInfo.FeeNo);
                    if (listByteCode == null) { }
                    else
                    {
                        string listJsonArray = CompressTool.DecompressString(listByteCode);
                        BirthTrauma[] birthTrauma = JsonConvert.DeserializeObject<BirthTrauma[]>(listJsonArray);
                        if (birthTrauma.Count() > 0)
                        {
                            temp.NBHurtNumber = birthTrauma[0].NUMBER_OF_BT;
                            temp.Steroid = birthTrauma[0].Steroid == true ? "是" : "否";
                        }
                    }
                    #endregion

                    #region 高危妊娠
                    byte[] BaByPatInfolistByteCode = webService.GetBaByPatInfo(r["FEENO"].ToString());
                    if (BaByPatInfolistByteCode == null)
                        temp.GPREG = "";
                    else
                    {
                        string listJsonArray = CompressTool.DecompressString(BaByPatInfolistByteCode);
                        BaByPatInfo_FeeNo[] baByPatInfo = JsonConvert.DeserializeObject<BaByPatInfo_FeeNo[]>(listJsonArray);
                        temp.GPREG = baByPatInfo[0].PATPregnancy;
                    }
                    #endregion

                    //temp.EDC = Convert.ToDateTime(r["EDC"].ToString()).ToString("yyyy/MM/dd");
                    temp.EDC = Convert_DateTime(r["EDC"].ToString());
                    temp.GEST = r["GEST_M"].ToString() + "+" + r["GEST_D"].ToString();
                    temp.P = r["PARITY_N"].ToString();
                    if (r["BIRTH"].ToString() != "")
                        //temp.Birth = Convert.ToDateTime(r["BIRTH"].ToString()).ToString("yyyy/MM/dd");
                        temp.Birth = Convert_DateTime(r["BIRTH"].ToString());
                    else if (r["BIRTH_NA"].ToString() == "1")
                        temp.Birth = "不詳";

                    //add by chih,20200511
                    if (temp.Birth == "不詳")
                        temp.BirthTime = "不詳";
                    else
                        //temp.BirthTime = Convert.ToDateTime(r["BIRTH"].ToString()).ToString("HH:mm"); //20200515 修改為只顯示到分
                        temp.BirthTime = Convert_DateTime(r["BIRTH"].ToString()); //20200515 修改為只顯示到分
                    //end add by chih,20200511

                    if (r["BIRTH_TYPE"].ToString() == "0")
                    {
                        temp.BirthType = "NSD";
                        temp.Vacuum = r["VACUUM_NSD"].ToString() == "0" ? "是" : "否";
                    }
                    else if (r["BIRTH_TYPE"].ToString() == "1")
                    {
                        temp.BirthType = "C/S";
                        temp.Vacuum = r["VACUUM_CS"].ToString() == "0" ? "是" : "否";
                        temp.VacuumNote = r["CS_NOTE"].ToString() == "0" ? "初次剖腹產" : "前胎剖腹產";
                    }
                    temp.VBAC = r["VBAC"].ToString() == "0" ? "有" : (r["VBAC"].ToString() == "1" ? "無" : "未曾剖腹產或初產婦");

                    if (r["PREG"].ToString() == "0")
                    {
                        temp.PREG = "無";
                    }
                    else if (r["PREG"].ToString() == "1")
                    {
                        #region 妊娠併發症項目
                        var PREG_ITM = r["PREG_ITM"].ToString();
                        var PREG_ITMV = new List<string>();
                        for (var i = 0; i < PREG_ITM.ToString().Length; i++)
                        {
                            if (PREG_ITM[i] == '1')
                            {
                                switch (i.ToString())
                                {
                                    case "0":
                                        PREG_ITMV.Add("子癲前症");
                                        break;
                                    case "1":
                                        PREG_ITMV.Add("胎盤早期剝離");
                                        break;
                                    case "2":
                                        PREG_ITMV.Add("前置胎盤");
                                        break;
                                    case "3":
                                        PREG_ITMV.Add("絨毛膜羊膜囊炎");
                                        break;
                                    case "4":
                                        PREG_ITMV.Add("重度子癲前症");
                                        break;
                                    case "5":
                                        PREG_ITMV.Add("中度子癲前症");
                                        break;
                                    case "6":
                                        PREG_ITMV.Add("妊娠高血壓");
                                        break;
                                    case "7":
                                        PREG_ITMV.Add("嚴重妊娠高血壓");
                                        break;
                                    case "8":
                                        PREG_ITMV.Add("心臟病");
                                        break;
                                    case "9":
                                        PREG_ITMV.Add("腎臟疾病");
                                        break;
                                    case "10":
                                        PREG_ITMV.Add("免疫性疾病(SLE)");
                                        break;
                                    case "11":
                                        if (r["PREG_OTH"].ToString() != "")
                                            PREG_ITMV.Add(r["PREG_OTH"].ToString());
                                        break;
                                    default:
                                        break;
                                }
                            }
                        }
                        temp.PREG = String.Join(",", PREG_ITMV);
                        #endregion
                    }

                    DataTable nbCount = obs_m.sel_nb(r["FEENO"].ToString());
                    if (nbCount != null && nbCount.Rows.Count > 0)
                        temp.NBNumber = nbCount.Rows.Count.ToString();
                    else
                        temp.NBNumber = "0";

                    temp.CORDBLOOD = r["CORDBLOOD"].ToString() == "0" ? "否" : "是";
                    temp.EPIDURAL = r["EPIDURAL"].ToString() == "0" ? "否" : "是";
                    temp.PATERNITY = r["PATERNITY"].ToString() == "0" ? "沒有" : "有";
                    temp.CORDCLAMP = r["CORDCLAMP"].ToString() == "0" ? "沒有" : "有";

                    switch (r["PERINEUM"].ToString() ?? "")
                    {
                        case "0":
                            temp.PERINEUM = "完整";
                            break;
                        case "1":
                            temp.PERINEUM = "自裂";
                            break;
                        case "2":
                            temp.PERINEUM = "正中切開";
                            break;
                        case "3":
                            temp.PERINEUM = "不詳";
                            break;
                        default:
                            break;
                    }
                    switch (r["PERI_LAC"].ToString() ?? "")
                    {
                        case "0":
                            temp.PERI_LAC = "無";
                            break;
                        case "1":
                            temp.PERI_LAC = "1度";
                            break;
                        case "2":
                            temp.PERI_LAC = "2度";
                            break;
                        case "3":
                            temp.PERI_LAC = "3度";
                            break;
                        case "4":
                            temp.PERI_LAC = "4度";
                            break;
                        default:
                            break;
                    }

                    temp.ABD_WND = r["ABD_WND"].ToString() == "0" ? "無" : "有";

                    switch (r["FEED"].ToString() ?? "")
                    {
                        case "0":
                            temp.FEED = "純母乳";
                            break;
                        case "1":
                            temp.FEED = "混合乳";
                            break;
                        case "2":
                            temp.FEED = "配方奶";
                            break;
                        case "3":
                            temp.FEED = "尚未決定";
                            break;
                        default:
                            break;
                    }
                    switch (r["ROOM_IN"].ToString() ?? "")
                    {
                        case "0":
                            temp.ROOM_IN = "24小時";
                            break;
                        case "1":
                            temp.ROOM_IN = "部份時段";
                            break;
                        case "2":
                            temp.ROOM_IN = "分離照顧";
                            break;
                        case "3":
                            temp.ROOM_IN = "尚未決定";
                            break;
                        default:
                            break;
                    }

                    #region 門診SDM
                    byte[] SDMlistByteCode = webService.GetSDM(MomInfo.ChartNo);
                    if (SDMlistByteCode == null)
                    {
                        temp.SDMFEED = "";
                        temp.SDMROOM_IN = "";
                    }
                    else
                    {
                        string listJsonArray = CompressTool.DecompressString(SDMlistByteCode);
                        SDMInfo[] SDMInfo = JsonConvert.DeserializeObject<SDMInfo[]>(listJsonArray);
                        var SDM = SDMInfo[0];

                        if (SDM.SDM1 == "1")
                            temp.SDMROOM_IN = "24小時";
                        else if (SDM.SDM1 == "2")
                            temp.SDMROOM_IN = "部分時段";
                        else if (SDM.SDM1 == "3")
                            temp.SDMROOM_IN = "分離照顧";
                        else if (SDM.SDM1 == "4")
                            temp.SDMROOM_IN = "尚未決定";

                        if (SDM.SDM2 == "1")
                            temp.SDMFEED = "純母乳";
                        else if (SDM.SDM2 == "2")
                            temp.SDMFEED = "混合乳";
                        else if (SDM.SDM2 == "3")
                            temp.SDMFEED = "配方奶";
                        else if (SDM.SDM1 == "4")
                            temp.SDMFEED = "尚未決定";
                    }
                    #endregion

                    DataTable roomin = obs_m.sel_roomin("", "", MomInfo.ChartNo.PadLeft(10, '0'));
                    var EXCLUDE = false; var NoRoomIn = false; var HR12 = false; var HR24 = false;
                    var EXCLUDEReason = "";
                    if (roomin != null && roomin.Rows.Count > 0)
                    {
                        foreach (DataRow row in roomin.Rows)
                        {
                            if (row["EXCLUDE"].ToString() == "1")
                            {
                                EXCLUDE = true;
                                switch (row["EXC_R"].ToString() ?? "")
                                {
                                    case "0":
                                        EXCLUDEReason = "NB入PICU";
                                        break;
                                    case "1":
                                        EXCLUDEReason = "NB入NBC";
                                        break;
                                    case "2":
                                        EXCLUDEReason = "NB轉院";
                                        break;
                                    case "3":
                                        EXCLUDEReason = "NB死亡";
                                        break;
                                    case "4":
                                        EXCLUDEReason = "母親因素";
                                        break;
                                    default:
                                        break;
                                }
                            }
                            if (row["END_STA"].ToString() == "0")
                                HR24 = true;
                            if (row["END_STA"].ToString() == "1")
                                HR12 = true;
                            if (row["END_STA"].ToString() == "2")
                                NoRoomIn = true;
                        }
                    }

                    if (EXCLUDE)
                        temp.ROOM_IN_STAT = $"X-{EXCLUDEReason}";
                    else if (NoRoomIn)
                        temp.ROOM_IN_STAT = "N";
                    else if (HR12)
                        temp.ROOM_IN_STAT = "12";
                    else if (HR24)
                        temp.ROOM_IN_STAT = "24";

                    DataTable dtArea = obs_m.sel_v_area("", r["PAT_ZONE"].ToString());
                    if (dtArea != null && dtArea.Rows.Count > 0)
                        temp.Zone = dtArea.Rows[0]["AREA_NAME"].ToString();

                    temp.AdmissionDate = MomInfo.InDate.ToString("yyyy/MM/dd");
                    temp.AdmissionTime = MomInfo.InDate.ToString("HH:mm");

                    if (r["PAIN_ST"].ToString() != "")
                    {
                        temp.PAIN_STDate = Convert.ToDateTime(r["PAIN_ST"].ToString()).ToString("yyyy/MM/dd");
                        temp.PAIN_STTime = Convert.ToDateTime(r["PAIN_ST"].ToString()).ToString("HH:mm");
                    }
                    else
                    {
                        if (r["PAIN_ST_NA"].ToString() == "0")
                        {
                            temp.PAIN_STDate = "不詳";
                            temp.PAIN_STTime = "不詳";
                        }
                    }

                    if (r["CERFO_TIME"].ToString() != "")
                    {
                        temp.CERFO_Date = Convert.ToDateTime(r["CERFO_TIME"].ToString()).ToString("yyyy/MM/dd");
                        temp.CERFO_TIME = Convert.ToDateTime(r["CERFO_TIME"].ToString()).ToString("HH:mm");
                    }
                    else
                    {
                        if (r["CERFO_TIME_NA"].ToString() == "0")
                        {
                            temp.CERFO_Date = "不詳";
                            temp.CERFO_TIME = "不詳";
                        }
                    }

                    if (r["BIRTH"].ToString() != "" && r["RFM_TIME"].ToString() != "")
                    {
                        var GRuptureTime = Convert.ToDateTime(r["BIRTH"]).Subtract(Convert.ToDateTime(r["RFM_TIME"]));
                        temp.GRuptureTime = GRuptureTime.Days.ToString() + "天" + GRuptureTime.Hours.ToString() + "小時" + GRuptureTime.Minutes.ToString() + "分鐘" + GRuptureTime.Seconds.ToString() + "秒";
                    }

                    if (r["DOP_TIME"].ToString() != "" && r["PAIN_ST"].ToString() != "")
                    {
                        var GTotalBth = Convert.ToDateTime(r["DOP_TIME"]).Subtract(Convert.ToDateTime(r["PAIN_ST"]));
                        temp.TotalTime = GTotalBth.Days.ToString() + "天" + GTotalBth.Hours.ToString() + "小時" + GTotalBth.Minutes.ToString() + "分鐘" + GTotalBth.Seconds.ToString() + "秒";
                    }

                    if (r["TOP"].ToString() == "1")
                    {
                        var top_reason = new List<string>();
                        var reason = r["TOP_RS"].ToString();
                        for (var i = 0; i < reason.Length; i++)
                        {
                            if (reason[i] == '1')
                            {
                                if (i == 0)
                                {
                                    top_reason.Add("染色體異常");
                                }
                                else if (i == 1)
                                {
                                    top_reason.Add("胎兒無心跳");
                                }
                                else if (i == 2)
                                {
                                    top_reason.Add("器官異常");
                                }
                                else if (i == 3)
                                {
                                    top_reason.Add("感染");
                                }
                                else if (i == 4)
                                {
                                    top_reason.Add("個人因素");
                                }
                                else if (i == 5)
                                {
                                    if (r["TOP_RS_O"].ToString() != "")
                                    {
                                        top_reason.Add(r["TOP_RS_O"].ToString());
                                    }
                                }
                            }
                        }
                        temp.TOP_Reason = String.Join(",", top_reason);
                    }
                    data.Add(temp);
                }
            }

            data.OrderBy(x => x.Birth).ThenBy(x => x.MomChartNo);
            //20200331 modified
            //ObstetricsHelper.Export(data, "母親明細表");
            ObstetricsHelper.Export(data, "母親明細表", string.Format("母親明細表({0}-{1})", START.Value.ToString("yyyy/MM/dd"), END.Value.ToString("yyyy/MM/dd")));
        }
        #endregion

        //處理日期轉換
        public string Convert_DateTime(string data)
        {
            try
            {
                return Convert.ToDateTime(data).ToString("yyyy/MM/dd");
            }
            catch
            {
                return "";
            }
        }

        #region 母乳SDM明細表(生產日期)(排序 1.母親病歷號)
        [HttpGet]
        public void SDM_Export(string START_DAY, string START_TIME, string END_DAY, string END_TIME)
        {
            DateTime? START = null;
            DateTime? END = null;
            if (IsNoEmpty(START_DAY) && IsNoEmpty(START_TIME))
                START = Convert.ToDateTime(START_DAY + " " + START_TIME);
            if (IsNoEmpty(END_DAY) && IsNoEmpty(END_TIME))
                END = Convert.ToDateTime(END_DAY + " " + END_TIME);

            DataTable dt = obs_m.sel_bthsta("", START, END);

            List<SDMExport> data = new List<SDMExport>();
            if (dt != null && dt.Rows.Count > 0)
            {
                foreach (DataRow r in dt.Rows)
                {
                    var temp = new SDMExport();
                    var momInfo = Get_Patient_Info(r["FEENO"].ToString());

                    temp = new SDMExport();
                    temp.MomChartNo = momInfo.ChartNo;
                    temp.MomName = momInfo.PatientName;
                    temp.P = r["PARITY_N"].ToString();

                    #region 生產史
                    DataTable dt_his = obs_m.sel_bthhis(momInfo.FeeNo);
                    if (dt_his != null && dt_his.Rows.Count > 0)
                    {
                        var r_his = dt_his.Rows[0];
                        if (r_his["ROOM_IN"].ToString() == "0")
                            temp.ROOMIN = "24小時";
                        else if (r_his["ROOM_IN"].ToString() == "1")
                            temp.ROOMIN = "部分時段";
                        else if (r_his["ROOM_IN"].ToString() == "2")
                            temp.ROOMIN = "分離照顧";
                        else if (r_his["ROOM_IN"].ToString() == "3")
                            temp.ROOMIN = "尚未決定";

                        if (r_his["FEED"].ToString() == "0")
                            temp.FEED = "純母乳";
                        else if (r_his["FEED"].ToString() == "1")
                            temp.FEED = "混合乳";
                        else if (r_his["FEED"].ToString() == "2")
                            temp.FEED = "配方奶";
                        else if (r_his["FEED"].ToString() == "3")
                            temp.FEED = "尚未決定";
                    }
                    #endregion

                    #region 門診SDM資料
                    //GetSDM
                    byte[] SDMlistByteCode = webService.GetSDM(momInfo.ChartNo);
                    if (SDMlistByteCode == null)
                    {
                        temp.ROOMIN_SDM = "";
                        temp.FEED_SDM = "";
                    }
                    else
                    {
                        string listJsonArray = CompressTool.DecompressString(SDMlistByteCode);
                        SDMInfo[] SDMInfo = JsonConvert.DeserializeObject<SDMInfo[]>(listJsonArray);
                        var SDM = SDMInfo[0];

                        if (SDM.SDM1 == "1")
                            temp.ROOMIN_SDM = "24小時";
                        else if (SDM.SDM1 == "2")
                            temp.ROOMIN_SDM = "部分時段";
                        else if (SDM.SDM1 == "3")
                            temp.ROOMIN_SDM = "分離照顧";
                        else if (SDM.SDM1 == "4")
                            temp.ROOMIN_SDM = "尚未決定";

                        if (SDM.SDM2 == "1")
                            temp.FEED_SDM = "純母乳";
                        else if (SDM.SDM2 == "2")
                            temp.FEED_SDM = "混合乳";
                        else if (SDM.SDM2 == "3")
                            temp.FEED_SDM = "配方奶";
                        else if (SDM.SDM1 == "4")
                            temp.FEED_SDM = "尚未決定";
                    }
                    #endregion
                    data.Add(temp);
                }
            }

            //20200331 modified
            //ObstetricsHelper.Export(data, "母乳SDM明細表");
            ObstetricsHelper.Export(data, "母乳SDM明細表", string.Format("母乳SDM明細表({0}-{1})", START.Value.ToString("yyyy/MM/dd"), END.Value.ToString("yyyy/MM/dd")));
        }
        #endregion

        #region 母乳轉介明細表(轉介日期)(排序 1.母親病歷號)
        [HttpGet]
        public void Feeding_Breast_Referral_Export(string START_DAY, string START_TIME, string END_DAY, string END_TIME)
        {
            DateTime? START = null;
            DateTime? END = null;
            if (IsNoEmpty(START_DAY) && IsNoEmpty(START_TIME))
                START = Convert.ToDateTime(START_DAY + " " + START_TIME);
            if (IsNoEmpty(END_DAY) && IsNoEmpty(END_TIME))
                END = Convert.ToDateTime(END_DAY + " " + END_TIME);

            DataTable dt = obs_m.sel_bredtran("", "", "", START, END);
            List<FeedingBreastReferralExport> data = new List<FeedingBreastReferralExport>();
            if (dt != null && dt.Rows.Count > 0)
            {
                foreach (DataRow r in dt.Rows)
                {
                    DataTable nbdt = obs_m.sel_btnb("", "", r["IID"].ToString());
                    if (nbdt != null && nbdt.Rows.Count > 0)
                    {
                        foreach (DataRow nb in nbdt.Rows)
                        {
                            var temp = new FeedingBreastReferralExport();
                            temp.MomName = r["NAME"].ToString();
                            var momInfo = Get_Patient_Info(r["FEENO"].ToString());
                            temp.MomChartNo = momInfo.ChartNo;
                            temp.TransferDate = Convert.ToDateTime(r["REF_DATE"].ToString()).ToString("yyyy/MM/dd");

                            DataTable bthsta = obs_m.sel_bthsta(r["FEENO"].ToString());
                            if (bthsta != null && bthsta.Rows.Count > 0)
                            {
                                temp.BirthDate = Convert.ToDateTime(bthsta.Rows[0]["BIRTH"].ToString()).ToString("yyyy/MM/dd");
                            }

                            DataTable dt_nb = obs_m.sel_nb(r["FEENO"].ToString());
                            if (dt_nb != null && dt_nb.Rows.Count > 0)
                            {
                                temp.BornCnt = dt_nb.Rows.Count;
                            }

                            temp.P = r["P"].ToString();
                            #region 轉介原因
                            var REF = r["REF"].ToString();
                            var REFV = new List<string>();
                            for (var i = 0; i < REF.ToString().Length; i++)
                            {
                                if (REF[i] == '1')
                                {
                                    switch (i.ToString())
                                    {
                                        case "0":
                                            REFV.Add("乳頭酸痛");
                                            break;
                                        case "1":
                                            REFV.Add("乳頭龜裂");
                                            break;
                                        case "2":
                                            REFV.Add("乳頭破皮");
                                            break;
                                        case "3":
                                            REFV.Add("乳腺炎");
                                            break;
                                        case "4":
                                            REFV.Add("產婦缺乏哺餵母乳動機");
                                            break;
                                        case "5":
                                            REFV.Add("（產婦哺乳技巧不熟練，須加強協助）");
                                            break;
                                        case "6":
                                            REFV.Add("寶寶吸奶姿勢不良");
                                            break;
                                        case "7":
                                            REFV.Add("寶寶吸吮力較弱");
                                            break;
                                        case "8":
                                            REFV.Add("奶水分泌不足");
                                            break;
                                        case "9":
                                            REFV.Add("先生不支持");
                                            break;
                                        case "10":
                                            REFV.Add("家人不支持");
                                            break;
                                        case "11":
                                            REFV.Add(r["REF_OTH"].ToString());
                                            break;
                                        default:
                                            break;
                                    }
                                }
                            }
                            #endregion
                            temp.Reason = String.Join(",", REFV);

                            if (r["REPLY_DATE"].ToString() != "")
                            {
                                temp.ReplyDate = Convert.ToDateTime(r["REPLY_DATE"].ToString()).ToString("yyyy/MM/dd");
                            }

                            #region 處理方式
                            var REF_WAY = r["REF_WAY"].ToString();
                            var REF_WAYV = new List<string>();
                            for (var i = 0; i < REF_WAY.ToString().Length; i++)
                            {
                                if (REF_WAY[i] == '1')
                                {
                                    switch (i.ToString())
                                    {
                                        case "0":
                                            REFV.Add("電話訪視");
                                            break;
                                        case "1":
                                            REFV.Add("家訪");
                                            break;
                                        case "2":
                                            REFV.Add("提供宣導資料");
                                            break;
                                        case "3":
                                            REFV.Add("邀請參加支持團體");
                                            break;
                                        case "4":
                                            REFV.Add(r["REF_WAY_OTH"].ToString());
                                            break;
                                        default:
                                            break;
                                    }
                                }
                            }
                            #endregion
                            temp.ProcessMethod = String.Join(",", REF_WAYV);
                            temp.ReplyResult = r["REF_RST"].ToString();

                            DataTable seqdt = obs_m.sel_nbcha("", "", nb["FEENO"].ToString(), nb["SQ_OF_NB"].ToString());
                            if (seqdt != null && seqdt.Rows.Count > 0)
                            {
                                foreach (DataRow seq in seqdt.Rows)
                                {
                                    var babyInfo = Get_Patient_Info(seq["BABY_FEE_NO"].ToString());
                                    temp.BabyName = babyInfo.PatientName;
                                    temp.BabyChartNo = seq["BABY_CHART_NO"].ToString();
                                }
                            }
                            temp.BirthType = nb["BIRTH_TYPE"].ToString();
                            data.Add(temp);
                        }
                    }
                }
            }

            //20200331 modified
            //ObstetricsHelper.Export(data, "母乳轉介明細表");
            ObstetricsHelper.Export(data, "母乳轉介明細表", string.Format("母乳轉介明細表({0}-{1})", START.Value.ToString("yyyy/MM/dd"), END.Value.ToString("yyyy/MM/dd")));
        }
        #endregion

        #region 親子同室總表(生產日期)(排序 1.母親病歷號)
        [HttpGet]
        public void Roomin_Export(string START_DAY, string START_TIME, string END_DAY, string END_TIME)
        {
            DateTime? START = null;
            DateTime? END = null;
            if (IsNoEmpty(START_DAY) && IsNoEmpty(START_TIME))
                START = Convert.ToDateTime(START_DAY + " " + START_TIME);
            if (IsNoEmpty(END_DAY) && IsNoEmpty(END_TIME))
                END = Convert.ToDateTime(END_DAY + " " + END_TIME);

            //modified by chih,20200619
            //string sql = @"SELECT * FROM OBS_BTHSTA WHERE 0 = 0";
            //if (START != null && END != null)
            //    sql += $" AND BIRTH BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";
            //sql += " AND DELETED IS NULL AND LENGTH(FEENO) = 10 ORDER BY BIRTH";
            string sql = @"SELECT * FROM OBS_BTHSTA B LEFT JOIN OBS_NB R ON R.FEENO = B.FEENO    WHERE 0 = 0  AND  R.NB_STAT = '1'  ";
            if (START != null && END != null)
                sql += $" AND B.BIRTH BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";
            sql += " AND B.DELETED IS NULL AND LENGTH(B.FEENO) = 10 ORDER BY B.BIRTH";
            //end modified by chih,20200619

            DataTable dt = obs_m.DBExecSQL(sql);

            List<RoomInExport> data = new List<RoomInExport>();
            if (dt != null && dt.Rows.Count > 0)
            {
                foreach (DataRow r in dt.Rows)
                {
                    var temp = new RoomInExport();
                    var momInfo = Get_Patient_Info(r["FEENO"].ToString());
                    temp.MomChartNo = momInfo.ChartNo;
                    temp.MomName = momInfo.PatientName;

                    temp.Gest = r["GEST_M"].ToString() + "+" + r["GEST_D"].ToString();

                    if (r["BIRTH_TYPE"].ToString() == "0")
                    {
                        temp.BirthType = "NSD";
                    }
                    else
                    {
                        temp.BirthType = "C/S";
                    }

                    if (r["BIRTH"].ToString() != "")
                    {
                        temp.Birthday = Convert.ToDateTime(r["BIRTH"].ToString()).ToString("yyyy/MM/dd HH:mm");
                    }

                    DataTable dt_roomin = obs_m.sel_roomin("", "", momInfo.ChartNo.PadLeft(10, '0'));

                    if (dt_roomin != null && dt_roomin.Rows.Count > 0)
                    {
                        var EXCLUDE = false; var NoRoomIn = false; var HR12 = false; var HR24 = false;
                        var EXCLUDEReason = new List<string>(); ; var EndReason = new List<string>();

                        foreach (DataRow row in dt_roomin.Rows)
                        {
                            if (row["EXCLUDE"].ToString() == "1")
                            {
                                EXCLUDE = true;
                                switch (row["EXC_R"].ToString() ?? "")
                                {
                                    case "0":
                                        EXCLUDEReason.Add("NB入PICU");
                                        break;
                                    case "1":
                                        EXCLUDEReason.Add("NB入NBC");
                                        break;
                                    case "2":
                                        EXCLUDEReason.Add("NB轉院");
                                        break;
                                    case "3":
                                        EXCLUDEReason.Add("NB死亡");
                                        break;
                                    case "4":
                                        EXCLUDEReason.Add("母親因素");
                                        break;
                                    default:
                                        break;
                                }
                            }
                            if (row["END_STA"].ToString() == "0")
                            {
                                HR24 = true;
                                #region 結束原因-24HR
                                var END_RS_24 = row["END_RS_24"].ToString();
                                var END_RS_24V = new List<string>();
                                for (var i = 0; i < END_RS_24.ToString().Length; i++)
                                {
                                    if (END_RS_24[i] == '1')
                                    {
                                        switch (i.ToString())
                                        {
                                            case "0":
                                                END_RS_24V.Add("正常返室");
                                                break;
                                            case "1":
                                                END_RS_24V.Add("媽媽出院");
                                                break;
                                            case "2":
                                                END_RS_24V.Add("新生兒洗澡");
                                                break;
                                            case "3":
                                                END_RS_24V.Add("新生兒檢查");
                                                break;
                                            default:
                                                break;
                                        }
                                    }
                                }
                                #endregion
                                EndReason.Add(string.Join("/", END_RS_24V));
                            }
                            if (row["END_STA"].ToString() == "1")
                                HR12 = true;
                            if (row["END_STA"].ToString() == "2")
                                NoRoomIn = true;

                            if (row["END_STA"].ToString() == "1" || row["END_STA"].ToString() == "2")
                            {
                                #region 原因類別
                                var END_RS_C = row["END_RS_C"].ToString();
                                var END_RS_CV = new List<string>();
                                for (var i = 0; i < END_RS_C.ToString().Length; i++)
                                {
                                    if (END_RS_C[i] == '1')
                                    {
                                        switch (i.ToString())
                                        {
                                            case "0":
                                                END_RS_CV.Add("產婦原因");
                                                break;
                                            case "1":
                                                END_RS_CV.Add("新生兒原因");
                                                break;
                                            case "2":
                                                END_RS_CV.Add("其他原因");
                                                break;
                                            default:
                                                break;
                                        }
                                    }
                                }
                                #endregion
                                temp.EndResult = String.Join(",", END_RS_CV);

                                var END_RS_PV = new List<string>();
                                var END_RS_NBV = new List<string>();
                                var END_RS_OTHV = new List<string>();
                                if (END_RS_CV.IndexOf("產婦原因") >= 0)
                                {
                                    #region 結束原因-產婦
                                    var END_RS_P = row["END_RS_P"].ToString();
                                    for (var i = 0; i < END_RS_P.ToString().Length; i++)
                                    {
                                        if (END_RS_P[i] == '1')
                                        {
                                            switch (i.ToString())
                                            {
                                                case "0":
                                                    END_RS_PV.Add("媽媽想休息");
                                                    break;
                                                case "1":
                                                    END_RS_PV.Add("媽媽沒有乳汁分泌");
                                                    break;
                                                case "2":
                                                    END_RS_PV.Add("媽媽身體不適");
                                                    break;
                                                case "3":
                                                    END_RS_PV.Add("擔心睡著後新生兒被抱走");
                                                    break;
                                                case "4":
                                                    END_RS_PV.Add("怕新生兒太吵");
                                                    break;
                                                case "5":
                                                    END_RS_PV.Add("媽媽出院");
                                                    break;
                                                case "6":
                                                    END_RS_PV.Add("媽媽自退奶");
                                                    break;
                                                case "7":
                                                    END_RS_PV.Add("媽媽產後發燒");
                                                    break;
                                                case "8":
                                                    END_RS_PV.Add("媽媽待產發燒");
                                                    break;
                                                case "9":
                                                    END_RS_PV.Add("媽媽服用不宜餵母乳之藥物");
                                                    break;
                                                case "10":
                                                    END_RS_PV.Add("擔心新生兒被感染");
                                                    break;
                                                case "11":
                                                    END_RS_PV.Add("媽媽GBS(+)，抗生素未打滿4小時/未打抗生素");
                                                    break;
                                                case "12":
                                                    END_RS_PV.Add("媽媽/同住家人(小孩)感冒");
                                                    break;
                                                case "13":
                                                    END_RS_PV.Add("媽媽住9樓");
                                                    break;
                                                case "14":
                                                    END_RS_PV.Add("媽媽破水大於24小時");
                                                    break;
                                                case "15":
                                                    END_RS_PV.Add("媽媽PPH");
                                                    break;
                                                case "16":
                                                    END_RS_PV.Add("媽媽PIH");
                                                    break;
                                                case "17":
                                                    END_RS_PV.Add("多胞胎無法同時兼顧");
                                                    break;
                                                case "18":
                                                    END_RS_PV.Add("有其他小孩要顧");
                                                    break;
                                                case "19":
                                                    END_RS_PV.Add("請假(外出)");
                                                    break;
                                                case "20":
                                                    END_RS_PV.Add("訪客多");
                                                    break;
                                                case "21":
                                                    END_RS_PV.Add("拒絕");
                                                    break;
                                                case "22":
                                                    if (row["END_RS_P_OTH"].ToString() != "")
                                                        END_RS_PV.Add(row["END_RS_P_OTH"].ToString());
                                                    else
                                                        END_RS_PV.Add("其他");
                                                    break;
                                                default:
                                                    break;
                                            }
                                        }
                                    }
                                    #endregion
                                }
                                if (END_RS_CV.IndexOf("新生兒原因") >= 0)
                                {
                                    #region 結束原因-新生兒
                                    var END_RS_NB = row["END_RS_NB"].ToString();
                                    for (var i = 0; i < END_RS_NB.ToString().Length; i++)
                                    {
                                        if (END_RS_NB[i] == '1')
                                        {
                                            switch (i.ToString())
                                            {
                                                case "0":
                                                    END_RS_NBV.Add("新生兒體溫不穩");
                                                    break;
                                                case "1":
                                                    END_RS_NBV.Add("新生兒洗澡");
                                                    break;
                                                case "2":
                                                    END_RS_NBV.Add("新生兒檢查");
                                                    break;
                                                case "3":
                                                    END_RS_NBV.Add("新生兒一直哭泣");
                                                    break;
                                                case "4":
                                                    if (row["END_RS_NB_S"].ToString() != "")
                                                        END_RS_NBV.Add(row["END_RS_NB_S"].ToString());
                                                    else
                                                        END_RS_NBV.Add("新生兒自身問題");
                                                    break;
                                                case "5":
                                                    END_RS_NBV.Add("新生兒預計出院");
                                                    break;
                                                case "6":
                                                    END_RS_NBV.Add("入PICU");
                                                    break;
                                                case "7":
                                                    END_RS_NBV.Add("入NBC");
                                                    break;
                                                default:
                                                    break;
                                            }
                                        }
                                    }
                                    #endregion
                                }
                                if (END_RS_CV.IndexOf("其他原因") >= 0)
                                {
                                    #region 結束原因-其他
                                    var END_RS_OTH = row["END_RS_OTH"].ToString();

                                    for (var i = 0; i < END_RS_OTH.ToString().Length; i++)
                                    {
                                        if (END_RS_OTH[i] == '1')
                                        {
                                            switch (i.ToString())
                                            {
                                                case "0":
                                                    END_RS_OTHV.Add("病房太冷");
                                                    break;
                                                case "1":
                                                    END_RS_OTHV.Add("病房環境太吵");
                                                    break;
                                                case "2":
                                                    END_RS_OTHV.Add("病房打蠟");
                                                    break;
                                                case "3":
                                                    END_RS_OTHV.Add("其他家人干預");
                                                    break;
                                                case "4":
                                                    END_RS_OTHV.Add(row["OTH_RS"].ToString());
                                                    break;
                                                default:
                                                    break;
                                            }
                                        }
                                    }
                                    #endregion
                                }

                                END_RS_PV = END_RS_PV.Concat(END_RS_NBV).Concat(END_RS_OTHV).ToList();
                                EndReason.Add(String.Join("/", END_RS_PV));
                            }

                            if (EXCLUDE)
                            {
                                temp.RoomIn = "排除";
                                temp.ExtraResult = string.Join("，", EXCLUDEReason);
                            }
                            else if (NoRoomIn)
                                temp.RoomIn = "N";
                            else if (HR12)
                                temp.RoomIn = "12";
                            else if (HR24)
                                temp.RoomIn = "24";

                            temp.EndResult = string.Join("，", EndReason);
                        }
                    }
                    data.Add(temp);
                }
            }

            data.OrderBy(x => x.MomChartNo);

            //20200331 modified
            //ObstetricsHelper.Export(data, "親子同室總表");
            ObstetricsHelper.Export(data, "親子同室總表", string.Format("親子同室總表({0}-{1})", START.Value.ToString("yyyy/MM/dd"), END.Value.ToString("yyyy/MM/dd")));
        }
        #endregion

        #region 親子同室明細表(生產日期)(排序 1.母親病歷號 2.小孩子病歷號 3.開始時間)
        [HttpGet]
        public void RoominDetail_Export(string START_DAY, string START_TIME, string END_DAY, string END_TIME)
        {
            DateTime? START = null;
            DateTime? END = null;
            if (IsNoEmpty(START_DAY) && IsNoEmpty(START_TIME))
                START = Convert.ToDateTime(START_DAY + " " + START_TIME);
            if (IsNoEmpty(END_DAY) && IsNoEmpty(END_TIME))
                END = Convert.ToDateTime(END_DAY + " " + END_TIME);

            //modified by chih,20200619
            //            string sql = @"SELECT B.BIRTH, B.BIRTH_TYPE, NB.NB_CHARTNO, NB.BIRTH_DAY, R.*
            //FROM OBS_NB NB
            //LEFT JOIN OBS_ROOMIN R 
            //ON NB.NB_CHARTNO = R.NB_CHARTNO AND NB.NB_CHARTNO = R.NB_CHARTNO_E
            //LEFT JOIN OBS_BTHSTA B
            //ON NB.FEENO = B.FEENO
            //WHERE 0 = 0 ";
            string sql = @"SELECT B.BIRTH, B.BIRTH_TYPE, NB.NB_CHARTNO, NB.BIRTH_DAY, R.*
FROM OBS_NB NB
LEFT JOIN OBS_ROOMIN R 
ON NB.NB_CHARTNO = R.NB_CHARTNO AND NB.NB_CHARTNO = R.NB_CHARTNO_E
LEFT JOIN OBS_BTHSTA B
ON NB.FEENO = B.FEENO
WHERE 0 = 0 AND NB.NB_STAT = '1'   ";
            //end modified by chih,20200619

            if (START != null && END != null)
                sql += $" AND B.BIRTH BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";
            sql += " AND R.DELETED IS NULL AND NB.DELETED IS NULL AND B.DELETED IS NULL ORDER BY R.PAT_FEENO, R.NB_CHARTNO, R.START_TIME";
            DataTable dt = obs_m.DBExecSQL(sql);

            List<RoomInDetailExport> data = new List<RoomInDetailExport>();
            if (dt != null && dt.Rows.Count > 0)
            {
                foreach (DataRow r in dt.Rows)
                {
                    var temp = new RoomInDetailExport();

                    if (r["BIRTH_TYPE"].ToString() == "0")
                    {
                        temp.BirthType = "NSD";
                    }
                    else
                    {
                        temp.BirthType = "C/S";
                    }

                    if (r["BIRTH"].ToString() != "")
                    {
                        temp.Birthday = Convert.ToDateTime(r["BIRTH"].ToString()).ToString("yyyy/MM/dd HH:mm");
                    }

                    if (r["EXCLUDE"].ToString() == "1")
                    {
                        temp.RoomIn = "排除";
                        switch (r["EXC_R"].ToString() ?? "")
                        {
                            case "0":
                                temp.ExtraResult = "NB入PICU";
                                break;
                            case "1":
                                temp.ExtraResult = "NB入NBC";
                                break;
                            case "2":
                                temp.ExtraResult = "NB轉院";
                                break;
                            case "3":
                                temp.ExtraResult = "NB死亡";
                                break;
                            case "4":
                                temp.ExtraResult = "母親因素";
                                if (r["EXC_MOM_R"].ToString() != "")
                                    temp.ExtraResult = "母親因素-" + r["EXC_MOM_R"].ToString();
                                break;
                            default:
                                break;
                        }
                    }
                    else
                    {
                        if (r["END_STA"].ToString() == "0")
                            temp.RoomIn = "24";
                        else if (r["END_STA"].ToString() == "1")
                            temp.RoomIn = "12";
                        else if (r["END_STA"].ToString() == "2")
                            temp.RoomIn = "N";
                        else
                            temp.RoomIn = "";
                    }

                    if (r["START_TIME"].ToString() != "")
                    {
                        temp.StartTime = Convert.ToDateTime(r["START_TIME"]).ToString("yyyy/MM/dd HH:mm");
                    }
                    else
                    {
                        temp.StartTime = "";
                    }

                    if (r["END_TIME"].ToString() != "")
                    {
                        temp.EndTime = Convert.ToDateTime(r["END_TIME"]).ToString("yyyy/MM/dd HH:mm");
                    }
                    else
                    {
                        temp.EndTime = "";
                    }

                    if (r["START_TIME"].ToString() != "" && r["END_TIME"].ToString() != "")
                    {
                        var Time = Convert.ToDateTime(r["END_TIME"]).Subtract(Convert.ToDateTime(r["START_TIME"]));
                        temp.RoomInTime = $"{(Time.Days == 0 ? "" : $"{Time.Days}天")}{(Time.Hours == 0 ? "" : $"{Time.Hours}小時")}{(Time.Minutes == 0 ? "" : $"{Time.Minutes}分鐘")}";
                    }

                    temp.BabyChartNo = r["NB_CHARTNO"].ToString();
                    DataTable dt_nbcha = obs_m.sel_nbcha("", r["NB_CHARTNO"].ToString());
                    if (dt_nbcha != null || dt_nbcha.Rows.Count > 0)
                    {
                        var momfeeno = dt_nbcha.Rows[0]["MOM_FEE_NO"].ToString();
                        PatientInfo momInfo = Get_Patient_Info(momfeeno);
                        temp.MomName = momInfo.PatientName;
                        temp.MomChartNo = momInfo.ChartNo;

                        var BabyInfo = Get_Patient_Info(dt_nbcha.Rows[0]["BABY_FEE_NO"].ToString());
                        temp.BabyName = BabyInfo.PatientName;

                        DataTable stadt = obs_m.sel_bthsta(momfeeno);
                        if (stadt != null && stadt.Rows.Count > 0)
                            temp.P = stadt.Rows[0]["PARITY_N"].ToString();
                    }

                    if (r["END_TIME"].ToString() != "")
                        temp.BabyChartNo = r["NB_CHARTNO_E"].ToString();

                    if (r["SEQ_OF_NB"].ToString() != "")
                        temp.Seq = (Convert.ToInt32(Convert.ToChar(r["SEQ_OF_NB"].ToString())) - 64).ToString();

                    if (r["END_STA"].ToString() == "1" || r["END_STA"].ToString() == "2")
                    {
                        #region 原因類別
                        var END_RS_C = r["END_RS_C"].ToString();
                        var END_RS_CV = new List<string>();
                        for (var i = 0; i < END_RS_C.ToString().Length; i++)
                        {
                            if (END_RS_C[i] == '1')
                            {
                                switch (i.ToString())
                                {
                                    case "0":
                                        END_RS_CV.Add("產婦原因");
                                        break;
                                    case "1":
                                        END_RS_CV.Add("新生兒原因");
                                        break;
                                    case "2":
                                        END_RS_CV.Add("其他原因");
                                        break;
                                    default:
                                        break;
                                }
                            }
                        }
                        #endregion
                        temp.ReasonType = String.Join(",", END_RS_CV);

                        var END_RS_PV = new List<string>();
                        var END_RS_NBV = new List<string>();
                        var END_RS_OTHV = new List<string>();
                        if (END_RS_CV.IndexOf("產婦原因") >= 0)
                        {
                            #region 結束原因-產婦
                            var END_RS_P = r["END_RS_P"].ToString();
                            for (var i = 0; i < END_RS_P.ToString().Length; i++)
                            {
                                if (END_RS_P[i] == '1')
                                {
                                    switch (i.ToString())
                                    {
                                        case "0":
                                            END_RS_PV.Add("媽媽想休息");
                                            break;
                                        case "1":
                                            END_RS_PV.Add("媽媽沒有乳汁分泌");
                                            break;
                                        case "2":
                                            END_RS_PV.Add("媽媽身體不適");
                                            break;
                                        case "3":
                                            END_RS_PV.Add("擔心睡著後新生兒被抱走");
                                            break;
                                        case "4":
                                            END_RS_PV.Add("怕新生兒太吵");
                                            break;
                                        case "5":
                                            END_RS_PV.Add("媽媽出院");
                                            break;
                                        case "6":
                                            END_RS_PV.Add("媽媽自退奶");
                                            break;
                                        case "7":
                                            END_RS_PV.Add("媽媽產後發燒");
                                            break;
                                        case "8":
                                            END_RS_PV.Add("媽媽待產發燒");
                                            break;
                                        case "9":
                                            END_RS_PV.Add("媽媽服用不宜餵母乳之藥物");
                                            break;
                                        case "10":
                                            END_RS_PV.Add("擔心新生兒被感染");
                                            break;
                                        case "11":
                                            END_RS_PV.Add("媽媽GBS(+)，抗生素未打滿4小時/未打抗生素");
                                            break;
                                        case "12":
                                            END_RS_PV.Add("媽媽/同住家人(小孩)感冒");
                                            break;
                                        case "13":
                                            END_RS_PV.Add("媽媽住9樓");
                                            break;
                                        case "14":
                                            END_RS_PV.Add("媽媽破水大於24小時");
                                            break;
                                        case "15":
                                            END_RS_PV.Add("媽媽PPH");
                                            break;
                                        case "16":
                                            END_RS_PV.Add("媽媽PIH");
                                            break;
                                        case "17":
                                            END_RS_PV.Add("多胞胎無法同時兼顧");
                                            break;
                                        case "18":
                                            END_RS_PV.Add("有其他小孩要顧");
                                            break;
                                        case "19":
                                            END_RS_PV.Add("請假(外出)");
                                            break;
                                        case "20":
                                            END_RS_PV.Add("訪客多");
                                            break;
                                        case "21":
                                            END_RS_PV.Add("拒絕");
                                            break;
                                        case "22":
                                            if (r["END_RS_P_OTH"].ToString() != "")
                                                END_RS_PV.Add(r["END_RS_P_OTH"].ToString());
                                            else
                                                END_RS_PV.Add("其他");
                                            break;
                                        default:
                                            break;
                                    }
                                }
                            }
                            #endregion
                        }
                        if (END_RS_CV.IndexOf("新生兒原因") >= 0)
                        {
                            #region 結束原因-新生兒
                            var END_RS_NB = r["END_RS_NB"].ToString();
                            for (var i = 0; i < END_RS_NB.ToString().Length; i++)
                            {
                                if (END_RS_NB[i] == '1')
                                {
                                    switch (i.ToString())
                                    {
                                        case "0":
                                            END_RS_NBV.Add("新生兒體溫不穩");
                                            break;
                                        case "1":
                                            END_RS_NBV.Add("新生兒洗澡");
                                            break;
                                        case "2":
                                            END_RS_NBV.Add("新生兒檢查");
                                            break;
                                        case "3":
                                            END_RS_NBV.Add("新生兒一直哭泣");
                                            break;
                                        case "4":
                                            if (r["END_RS_NB_S"].ToString() != "")
                                                END_RS_NBV.Add("新生兒自身問題-" + r["END_RS_NB_S"].ToString());
                                            else
                                                END_RS_NBV.Add("新生兒自身問題");
                                            break;
                                        case "5":
                                            END_RS_NBV.Add("新生兒預計出院");
                                            break;
                                        case "6":
                                            if (r["END_RS_NB_PICU"].ToString() != "")
                                                END_RS_NBV.Add("入PICU-" + r["END_RS_NB_PICU"].ToString());
                                            else
                                                END_RS_NBV.Add("入PICU");
                                            break;
                                        case "7":
                                            if (r["END_RS_NB_NBC"].ToString() != "")
                                                END_RS_NBV.Add("入NBC-" + r["END_RS_NB_NBC"].ToString());
                                            else
                                                END_RS_NBV.Add("入NBC");
                                            break;
                                        default:
                                            break;
                                    }
                                }
                            }
                            #endregion
                        }
                        if (END_RS_CV.IndexOf("其他原因") >= 0)
                        {
                            #region 結束原因-其他
                            var END_RS_OTH = r["END_RS_OTH"].ToString();

                            for (var i = 0; i < END_RS_OTH.ToString().Length; i++)
                            {
                                if (END_RS_OTH[i] == '1')
                                {
                                    switch (i.ToString())
                                    {
                                        case "0":
                                            END_RS_OTHV.Add("病房太冷");
                                            break;
                                        case "1":
                                            END_RS_OTHV.Add("病房環境太吵");
                                            break;
                                        case "2":
                                            END_RS_OTHV.Add("病房打蠟");
                                            break;
                                        case "3":
                                            END_RS_OTHV.Add("其他家人干預");
                                            break;
                                        case "4":
                                            END_RS_OTHV.Add(r["OTH_RS"].ToString());
                                            break;
                                        default:
                                            break;
                                    }
                                }
                            }
                            #endregion
                        }

                        END_RS_PV = END_RS_PV.Concat(END_RS_NBV).Concat(END_RS_OTHV).ToList();
                        temp.EndResult = String.Join(",", END_RS_PV);
                    }
                    else
                    {

                    }
                    data.Add(temp);
                }
            }

            //20200331 modified
            //ObstetricsHelper.Export(data, "親子同室明細表");
            ObstetricsHelper.Export(data, "親子同室明細表", string.Format("親子同室明細表({0}-{1})", START.Value.ToString("yyyy/MM/dd"), END.Value.ToString("yyyy/MM/dd")));
        }
        #endregion

        #region 肌膚接觸明細表(出生紀錄單)(生產日期)(排序 1.出生日期時間)
        [HttpGet]
        public void SkinTouch_Export(string START_DAY, string START_TIME, string END_DAY, string END_TIME)
        {
            DateTime? START = null;
            DateTime? END = null;
            if (IsNoEmpty(START_DAY) && IsNoEmpty(START_TIME))
                START = Convert.ToDateTime(START_DAY + " " + START_TIME);
            if (IsNoEmpty(END_DAY) && IsNoEmpty(END_TIME))
                END = Convert.ToDateTime(END_DAY + " " + END_TIME);

            // 20200331 modified 無接觸的原因，改抓出生紀錄
            //            string sql = @"SELECT B.BIRTH, NB.FEENO AS MOM_FEENO, NB.NB_CHARTNO, NB.BIRTH_TYPE, NB.NB_STAT, NB.CHILD_SENT, NB.CHILD_SENT_MEMO, NB.BIRTH_DAY, R.*
            //FROM OBS_NB NB
            //LEFT JOIN  OBS_SKTSK R
            //ON NB.IID = R.IID
            //LEFT JOIN OBS_BTHSTA B
            //ON NB.FEENO = B.FEENO
            //WHERE 0 = 0 ";
            string sql = @"SELECT B.BIRTH, NB.FEENO AS MOM_FEENO, NB.NB_CHARTNO, NB.BIRTH_TYPE, NB.NB_STAT, NB.CHILD_SENT, NB.CHILD_SENT_MEMO, NB.BIRTH_DAY, NB.SKIN_CONTACT ,NB.SKIN_CONTACT_RS, NB.CONTACT_N_MOM, NB.CONTACT_N_MOM_ID, NB.CONTACT_N_MOM_OTH, NB.CONTACT_N_NB, NB.CONTACT_N_NB_OTH , R.*
FROM OBS_NB NB
LEFT JOIN  OBS_SKTSK R
ON NB.IID = R.IID AND R.DELETED IS NULL
LEFT JOIN OBS_BTHSTA B
ON NB.FEENO = B.FEENO
WHERE 0 = 0 ";
            //end 20200331 modified
            if (START != null && END != null)
                sql += $" AND B.BIRTH BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";
            sql += " AND NB.DELETED IS NULL AND B.DELETED IS NULL AND LENGTH(B.FEENO) = 10 ORDER BY NB.BIRTH_DAY";
            DataTable dt = obs_m.DBExecSQL(sql);

            List<SkinTouchExport> data = new List<SkinTouchExport>();
            if (dt != null && dt.Rows.Count > 0)
            {
                foreach (DataRow r in dt.Rows)
                {
                    var temp = new SkinTouchExport();

                    if (r["START_TIME"].ToString() != "")
                        temp.StartTime = Convert.ToDateTime(r["START_TIME"]).ToString("yyyy/MM/dd HH:mm");
                    if (r["END_TIME"].ToString() != "")
                    {
                        temp.EndTime = Convert.ToDateTime(r["END_TIME"]).ToString("yyyy/MM/dd HH:mm");
                    }

                    if (r["BIRTH_TYPE"].ToString() == "0")
                    {
                        temp.BirthType = "NSD";
                    }
                    else
                    {
                        temp.BirthType = "C/S";
                    }

                    if (r["START_TIME"].ToString() != "" && r["END_TIME"].ToString() != "")
                    {
                        var Time = Convert.ToDateTime(r["END_TIME"]).Subtract(Convert.ToDateTime(r["START_TIME"]));
                        temp.TouchTime = $"{(Time.Days == 0 ? "" : $"{Time.Days}天")}{(Time.Hours == 0 ? "" : $"{Time.Hours}小時")}{(Time.Minutes == 0 ? "" : $"{Time.Minutes}分鐘")}";

                        if (Time.Hours > 0)
                        {
                            temp.Match = "Y";
                        }
                        else
                        {
                            if (temp.BirthType == "NSD")
                            {
                                temp.Match = Time.TotalMinutes >= 20 ? "Y" : "N";
                            }
                            else if (temp.BirthType == "C/S")
                            {
                                temp.Match = Time.TotalMinutes >= 10 ? "Y" : "N";
                            }
                        }
                    }

                    temp.BabyChartNo = r["NB_CHARTNO"].ToString();
                    temp.Birth = Convert.ToDateTime(r["BIRTH_DAY"].ToString()).ToString("yyyy/MM/dd");

                    if (r["NB_STAT"].ToString() == "0")
                    {
                        temp.BabyStatus = "死產";
                    }
                    else
                    {
                        temp.BabyStatus = "活產";
                    }

                    if (r["CHILD_SENT"].ToString() == "0")
                    {
                        temp.BabySent = "嬰兒室";
                    }
                    else if (r["CHILD_SENT"].ToString() == "1")
                    {
                        temp.BabySent = "PICU";
                        if (r["CHILD_SENT_MEMO"].ToString() != "")
                        {
                            temp.BabySent += "-" + r["CHILD_SENT_MEMO"].ToString();
                        }
                    }
                    else if (r["CHILD_SENT"].ToString() == "2")
                    {
                        temp.BabySent = "NBC";
                        if (r["CHILD_SENT_MEMO"].ToString() != "")
                        {
                            temp.BabySent += "-" + r["CHILD_SENT_MEMO"].ToString();
                        }
                    }
                    else if (r["CHILD_SENT"].ToString() == "3")
                    {
                        temp.BabySent = "太平間";
                    }
                    else if (r["CHILD_SENT"].ToString() == "4")
                    {
                        temp.BabySent = "家屬帶回";
                    }

                    var MomInfo = Get_Patient_Info(r["MOM_FEENO"].ToString());
                    temp.MomName = MomInfo.PatientName;
                    temp.MomChartNo = MomInfo.ChartNo;

                    if (r["NB_CHARTNO"].ToString() != "")
                    {
                        DataTable dt_nbcha = obs_m.sel_nbcha("", r["NB_CHARTNO"].ToString());
                        if (dt_nbcha != null || dt_nbcha.Rows.Count > 0)
                        {
                            var BabyInfo = Get_Patient_Info(dt_nbcha.Rows[0]["BABY_FEE_NO"].ToString());
                            temp.BabyName = BabyInfo.PatientName;
                        }
                    }

                    if (r["SEQ_OF_NB"].ToString() != "")
                        temp.Seq = (Convert.ToInt32(Convert.ToChar(r["SEQ_OF_NB"].ToString())) - 64).ToString();

                    #region 原因類別
                    var END_RS = r["END_RS"].ToString();
                    var END_RSV = new List<string>();
                    for (var i = 0; i < END_RS.ToString().Length; i++)
                    {
                        if (END_RS[i] == '1')
                        {
                            switch (i.ToString())
                            {
                                case "0":
                                    END_RSV.Add("接觸人原因");
                                    break;
                                case "1":
                                    END_RSV.Add("新生兒原因");
                                    break;
                                default:
                                    break;
                            }
                        }
                    }
                    //20200331  modified 無接觸的原因，改抓出生紀錄
                    var reasonFromNB = false;
                    if (END_RSV.Count == 0 && r["SKIN_CONTACT"].ToString() == "0")
                    {
                        reasonFromNB = true;
                        var SKIN_CONTACT_RS = r["SKIN_CONTACT_RS"].ToString();
                        for (var i = 0; i < SKIN_CONTACT_RS.ToString().Length; i++)
                        {
                            if (SKIN_CONTACT_RS[i] == '1')
                            {
                                switch (i.ToString())
                                {
                                    case "0":
                                        END_RSV.Add("接觸人原因");
                                        break;
                                    case "1":
                                        END_RSV.Add("新生兒原因");
                                        break;
                                    default:
                                        break;
                                }
                            }
                        }
                    }
                    //end 20200331 modified
                    #endregion
                    temp.ReasonType = String.Join(",", END_RSV);

                    var END_RS_CTV = new List<string>();
                    var END_RS_NBV = new List<string>();
                    if (END_RSV.IndexOf("接觸人原因") >= 0)
                    {
                        #region 結束原因-接觸人
                        var END_RS_CT = r["END_RS_CT"].ToString();
                        for (var i = 0; i < END_RS_CT.ToString().Length; i++)
                        {
                            if (END_RS_CT[i] == '1')
                            {
                                switch (i.ToString())
                                {
                                    case "0":
                                        END_RS_CTV.Add("生命徵象不穩定");
                                        break;
                                    case "1":
                                        END_RS_CTV.Add("嘔吐");
                                        break;
                                    case "2":
                                        END_RS_CTV.Add("發燒");
                                        break;
                                    case "3":
                                        END_RS_CTV.Add("傷口疼痛");
                                        break;
                                    case "4":
                                        END_RS_CTV.Add("有精神疾患");
                                        break;
                                    case "5":
                                        END_RS_CTV.Add("拒絕");
                                        break;
                                    case "6":
                                        END_RS_CTV.Add("疲憊");
                                        break;
                                    case "7":
                                        END_RS_CTV.Add(r["END_RS_CT_OTH"].ToString());
                                        break;
                                    case "8":
                                        END_RS_CTV.Add("返病房");
                                        break;
                                    default:
                                        break;
                                }
                            }
                        }
                        //20200331  modified 無接觸的原因，改抓出生紀錄
                        if (reasonFromNB)
                        {
                            END_RS_CTV = new List<string>();
                            var CONTACT_N_MOM = r["CONTACT_N_MOM"].ToString();
                            for (var i = 0; i < CONTACT_N_MOM.ToString().Length; i++)
                            {
                                if (CONTACT_N_MOM[i] == '1')
                                {
                                    switch (i.ToString())
                                    {
                                        case "0":
                                            END_RS_CTV.Add("生命徵象不穩定");
                                            break;
                                        case "1":
                                            END_RS_CTV.Add("嘔吐");
                                            break;
                                        case "2":
                                            END_RS_CTV.Add("發燒");
                                            break;
                                        case "3":
                                            END_RS_CTV.Add("傷口疼痛");
                                            break;
                                        case "4":
                                            END_RS_CTV.Add("有精神疾患");
                                            break;
                                        case "5":
                                            END_RS_CTV.Add("拒絕");
                                            break;
                                        case "6":
                                            END_RS_CTV.Add("疲憊");
                                            break;
                                        case "7":
                                            //傳染性疾病
                                            var CONTACT_N_MOM_ID = r["CONTACT_N_MOM_ID"].ToString();
                                            for (var j = 0; j < CONTACT_N_MOM_ID.ToString().Length; j++)
                                            {
                                                if (CONTACT_N_MOM_ID[j] == '1')
                                                {
                                                    switch (j.ToString())
                                                    {
                                                        case "0":
                                                            END_RS_CTV.Add("水痘");
                                                            break;
                                                        case "1":
                                                            END_RS_CTV.Add("梅毒");
                                                            break;
                                                        case "2":
                                                            END_RS_CTV.Add("HIV");
                                                            break;
                                                        default:
                                                            break;
                                                    }
                                                }
                                            }
                                            break;
                                        case "8":
                                            END_RS_CTV.Add("藥毒癮");
                                            break;
                                        case "9":
                                            //其他
                                            END_RS_CTV.Add(r["CONTACT_N_MOM_OTH"].ToString());
                                            break;
                                        case "10":
                                            END_RS_CTV.Add("返病房");
                                            break;
                                        default:
                                            break;
                                    }
                                }
                            }
                        }
                        //end 20200331 modified
                        #endregion
                    }
                    if (END_RSV.IndexOf("新生兒原因") >= 0)
                    {
                        #region 結束原因-新生兒
                        var END_RS_NB = r["END_RS_NB"].ToString();
                        for (var i = 0; i < END_RS_NB.ToString().Length; i++)
                        {
                            if (END_RS_NB[i] == '1')
                            {
                                switch (i.ToString())
                                {
                                    case "0":
                                        END_RS_NBV.Add("生命徵象不穩定");
                                        break;
                                    case "1":
                                        END_RS_NBV.Add("早產");
                                        break;
                                    case "2":
                                        END_RS_NBV.Add("低血糖");
                                        break;
                                    case "3":
                                        END_RS_NBV.Add(r["END_RS_NB_OTH"].ToString());
                                        break;
                                    case "4":
                                        END_RS_NBV.Add("返嬰兒室");
                                        break;
                                    default:
                                        break;
                                }
                            }
                        }
                        //20200331  modified 無接觸的原因，改抓出生紀錄
                        if (reasonFromNB)
                        {
                            END_RS_NBV = new List<string>();
                            var CONTACT_N_NB = r["CONTACT_N_NB"].ToString();
                            for (var i = 0; i < CONTACT_N_NB.ToString().Length; i++)
                            {
                                if (CONTACT_N_NB[i] == '1')
                                {
                                    switch (i.ToString())
                                    {
                                        case "0":
                                            END_RS_NBV.Add("生命徵象不穩定");
                                            break;
                                        case "1":
                                            END_RS_NBV.Add("早產");
                                            break;
                                        case "2":
                                            END_RS_NBV.Add("低血糖");
                                            break;
                                        case "3":
                                            END_RS_NBV.Add(r["CONTACT_N_NB_OTH"].ToString());
                                            break;
                                        case "4":
                                            END_RS_NBV.Add("返嬰兒室");
                                            break;
                                        default:
                                            break;
                                    }
                                }
                            }
                        }
                        //end 20200331 modified
                        #endregion
                    }


                    END_RS_CTV = END_RS_CTV.Concat(END_RS_NBV).ToList();
                    //20200410 modified 若是無接觸，原因要寫在排除
                    //temp.EndResult = String.Join(",", END_RS_CTV);
                    if (reasonFromNB)
                    {
                        temp.ExtraResult = String.Join(",", END_RS_CTV);
                    }
                    else
                    {
                        temp.EndResult = String.Join(",", END_RS_CTV);
                    }
                    //end 
                    data.Add(temp);
                }
            }

            //20200331 modified
            //ObstetricsHelper.Export(data, "肌膚接觸明細表(出生紀錄單)");
            ObstetricsHelper.Export(data, "肌膚接觸明細表(出生紀錄)", string.Format("肌膚接觸明細表(出生紀錄)({0}-{1})", START.Value.ToString("yyyy/MM/dd"), END.Value.ToString("yyyy/MM/dd")));
        }
        #endregion

        #region 肌膚接觸明細表2(生產日期)(排序 1.小孩子病歷號 2.開始時間)
        [HttpGet]
        public void SkinTouchDetail_Export(string START_DAY, string START_TIME, string END_DAY, string END_TIME)
        {
            DateTime? START = null;
            DateTime? END = null;
            if (IsNoEmpty(START_DAY) && IsNoEmpty(START_TIME))
                START = Convert.ToDateTime(START_DAY + " " + START_TIME);
            if (IsNoEmpty(END_DAY) && IsNoEmpty(END_TIME))
                END = Convert.ToDateTime(END_DAY + " " + END_TIME);

            string sql = @"SELECT B.BIRTH, NB.BIRTH_TYPE, NB.NB_STAT, NB.CHILD_SENT, NB.CHILD_SENT_MEMO, NB.BIRTH_DAY, R.*
FROM OBS_SKTSK R
LEFT JOIN OBS_NB NB
ON R.NB_CHARTNO = NB.NB_CHARTNO
LEFT JOIN OBS_BTHSTA B
ON NB.FEENO = B.FEENO
WHERE NB.NB_CHARTNO IS NOT NULL";
            if (START != null && END != null)
                sql += $" AND B.BIRTH BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";
            sql += " AND R.DELETED IS NULL AND NB.DELETED IS NULL AND B.DELETED IS NULL ORDER BY NB.NB_CHARTNO, R.START_TIME";
            DataTable dt = obs_m.DBExecSQL(sql);

            List<SkinTouchDetailExport> data = new List<SkinTouchDetailExport>();
            if (dt != null && dt.Rows.Count > 0)
            {
                foreach (DataRow r in dt.Rows)
                {
                    var temp = new SkinTouchDetailExport();

                    if (r["START_TIME"].ToString() != "")
                        temp.StartTime = Convert.ToDateTime(r["START_TIME"]).ToString("yyyy/MM/dd HH:mm");
                    if (r["END_TIME"].ToString() != "")
                    {
                        temp.EndTime = Convert.ToDateTime(r["END_TIME"]).ToString("yyyy/MM/dd HH:mm");
                    }

                    if (r["START_TIME"].ToString() != "" && r["END_TIME"].ToString() != "")
                    {
                        var Time = Convert.ToDateTime(r["END_TIME"]).Subtract(Convert.ToDateTime(r["START_TIME"]));
                        temp.TouchTime = $"{(Time.Days == 0 ? "" : $"{Time.Days}天")}{(Time.Hours == 0 ? "" : $"{Time.Hours}小時")}{(Time.Minutes == 0 ? "" : $"{Time.Minutes}分鐘")}";
                    }

                    DataTable babylink = obs_m.sel_nbcha("", r["NB_CHARTNO"].ToString());
                    if (babylink != null && babylink.Rows.Count > 0)
                    {
                        var MomInfo = Get_Patient_Info(babylink.Rows[0]["MOM_FEE_NO"].ToString());
                        temp.MomName = MomInfo.PatientName;
                        temp.MomChartNo = MomInfo.ChartNo;

                        var BabyInfo = Get_Patient_Info(babylink.Rows[0]["BABY_FEE_NO"].ToString());
                        temp.BabyName = BabyInfo.PatientName;
                        temp.BabyChartNo = BabyInfo.ChartNo;

                        if (babylink.Rows[0]["BABY_SEQ"].ToString() != "")
                            temp.Seq = (Convert.ToInt32(Convert.ToChar(babylink.Rows[0]["BABY_SEQ"].ToString())) - 64).ToString();

                        DataTable dtBthsta = obs_m.sel_bthsta(MomInfo.FeeNo);
                        if (dtBthsta != null && dtBthsta.Rows.Count > 0)
                        {
                            var staRow = dtBthsta.Rows[0];
                            temp.P = staRow["PARITY_N"].ToString();
                        }
                    }

                    #region 地點
                    switch (r["LOCATION"].ToString() ?? "")
                    {
                        case "0":
                            temp.Location = "產房";
                            break;
                        case "1":
                            temp.Location = "開刀房";
                            break;
                        case "2":
                            temp.Location = "恢復室";
                            break;
                        case "3":
                            temp.Location = "嬰兒室";
                            break;
                        case "4":
                            temp.Location = "產後病房";
                            break;
                        case "5":
                            temp.Location = "兒科中重度病房";
                            break;
                        case "6":
                            temp.Location = "兒科加護病房";
                            break;
                        case "7":
                            if (r["LOCA_OTH"].ToString() != "")
                                temp.Location = r["LOCA_OTH"].ToString();
                            break;
                        default:
                            break;
                    }
                    #endregion

                    switch (r["WHO"].ToString() ?? "")
                    {
                        case "0":
                            temp.Person = "母親";
                            break;
                        case "1":
                            temp.Person = "父親";
                            break;
                        default:
                            break;
                    }

                    temp.Source = "肌膚接觸";

                    #region 原因類別
                    var END_RS = r["END_RS"].ToString();
                    var END_RSV = new List<string>();
                    for (var i = 0; i < END_RS.ToString().Length; i++)
                    {
                        if (END_RS[i] == '1')
                        {
                            switch (i.ToString())
                            {
                                case "0":
                                    END_RSV.Add("產婦原因");
                                    break;
                                case "1":
                                    END_RSV.Add("新生兒原因");
                                    break;
                                default:
                                    break;
                            }
                        }
                    }
                    #endregion
                    temp.ReasonType = String.Join(",", END_RSV);

                    var END_RS_CTV = new List<string>();
                    var END_RS_NBV = new List<string>();
                    if (END_RSV.IndexOf("產婦原因") >= 0)
                    {
                        #region 結束原因-產婦
                        var END_RS_CT = r["END_RS_CT"].ToString();
                        for (var i = 0; i < END_RS_CT.ToString().Length; i++)
                        {
                            if (END_RS_CT[i] == '1')
                            {
                                switch (i.ToString())
                                {
                                    case "0":
                                        END_RS_CTV.Add("生命徵象不穩定");
                                        break;
                                    case "1":
                                        END_RS_CTV.Add("嘔吐");
                                        break;
                                    case "2":
                                        END_RS_CTV.Add("發燒");
                                        break;
                                    case "3":
                                        END_RS_CTV.Add("傷口疼痛");
                                        break;
                                    case "4":
                                        END_RS_CTV.Add("有精神疾患");
                                        break;
                                    case "5":
                                        END_RS_CTV.Add("拒絕");
                                        break;
                                    case "6":
                                        END_RS_CTV.Add("疲憊");
                                        break;
                                    case "7":
                                        END_RS_CTV.Add(r["END_RS_CT_OTH"].ToString());
                                        break;
                                    case "8":
                                        END_RS_CTV.Add("返病房");
                                        break;
                                    default:
                                        break;
                                }
                            }
                        }
                        #endregion
                    }
                    if (END_RSV.IndexOf("新生兒原因") >= 0)
                    {
                        #region 結束原因-新生兒
                        var END_RS_NB = r["END_RS_NB"].ToString();
                        for (var i = 0; i < END_RS_NB.ToString().Length; i++)
                        {
                            if (END_RS_NB[i] == '1')
                            {
                                switch (i.ToString())
                                {
                                    case "0":
                                        END_RS_NBV.Add("生命徵象不穩定");
                                        break;
                                    case "1":
                                        END_RS_NBV.Add("早產");
                                        break;
                                    case "2":
                                        END_RS_NBV.Add("低血糖");
                                        break;
                                    case "3":
                                        END_RS_NBV.Add(r["END_RS_NB_OTH"].ToString());
                                        break;
                                    case "4":
                                        END_RS_NBV.Add("返嬰兒室");
                                        break;
                                    default:
                                        break;
                                }
                            }
                        }
                        #endregion
                    }
                    END_RS_CTV = END_RS_CTV.Concat(END_RS_NBV).ToList();
                    temp.EndResult = String.Join(",", END_RS_CTV);
                    data.Add(temp);
                }
            }

            //20200331 modified
            //ObstetricsHelper.Export(data, "肌膚接觸明細表2");
            ObstetricsHelper.Export(data, "肌膚接觸明細表(母嬰親善)", string.Format("肌膚接觸明細表(母嬰親善)({0}-{1})", START.Value.ToString("yyyy/MM/dd"), END.Value.ToString("yyyy/MM/dd")));
        }
        #endregion

        #region 新生兒名單(出生日期)
        [HttpGet]
        public void NB_Export(string START_DAY, string START_TIME, string END_DAY, string END_TIME)
        {
            DateTime? START = null;
            DateTime? END = null;
            if (IsNoEmpty(START_DAY) && IsNoEmpty(START_TIME))
                START = Convert.ToDateTime(START_DAY + " " + START_TIME);
            if (IsNoEmpty(END_DAY) && IsNoEmpty(END_TIME))
                END = Convert.ToDateTime(END_DAY + " " + END_TIME);

            string sql = @"SELECT R.* ,H.GEST_M, H.GEST_D
FROM OBS_NB R
LEFT JOIN OBS_BTHSTA H
ON R.FEENO = H.FEENO
WHERE 1=1 ";
            if (START != null && END != null)
                sql += $" AND R.BIRTH_DAY BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";
            sql += " AND R.DELETED IS NULL AND LENGTH(H.FEENO) = 10";
            DataTable dt = obs_m.DBExecSQL(sql);

            List<NBExport> data = new List<NBExport>();
            if (dt != null && dt.Rows.Count > 0)
            {
                foreach (DataRow r in dt.Rows)
                {
                    var temp = new NBExport();

                    var momInfo = Get_Patient_Info(r["FEENO"].ToString());
                    temp.MomChartNo = momInfo.ChartNo;
                    temp.MomName = momInfo.PatientName;

                    if (r["BIRTH_DAY"].ToString() != "")
                        temp.Birth = Convert.ToDateTime(r["BIRTH_DAY"].ToString()).ToString("yyyy/MM/dd");

                    switch (r["BIRTH_TYPE"].ToString() ?? "")
                    {
                        case "0":
                            temp.BirthType = "NSD";
                            break;
                        case "1":
                            temp.BirthType = "C/S";
                            break;
                        default:
                            break;
                    }

                    temp.GEST = r["GEST_M"].ToString() + "+" + r["GEST_D"].ToString();
                    temp.Height = r["HEIGHT"].ToString();
                    temp.Weight = r["WEIGHT"].ToString();

                    #region 胎位
                    switch (r["FETAL"].ToString() ?? "")
                    {
                        case "0":
                            temp.FETAL = "LOA";
                            break;
                        case "1":
                            temp.FETAL = "ROA";
                            break;
                        case "2":
                            temp.FETAL = "OA";
                            break;
                        case "3":
                            temp.FETAL = "LOP";
                            break;
                        case "4":
                            temp.FETAL = "ROP";
                            break;
                        case "5":
                            temp.FETAL = "OP";
                            break;
                        case "6":
                            temp.FETAL = "LOT";
                            break;
                        case "7":
                            temp.FETAL = "ROT";
                            break;
                        case "8":
                            temp.FETAL = "Transverse";
                            break;
                        case "9":
                            temp.FETAL = "Breech";
                            break;
                        case "10":
                            temp.FETAL = "Vertex";
                            break;
                        case "11":
                            if (r["FETAL_OTH"].ToString() != "")
                                temp.FETAL = r["FETAL_OTH"].ToString();
                            break;
                        default:
                            break;
                    }
                    #endregion
                    temp.Gender = r["GENDER"].ToString();

                    switch (r["NB_STAT"].ToString() ?? "")
                    {
                        case "0":
                            temp.NB_STAT = "死胎";
                            break;
                        case "1":
                            temp.NB_STAT = "活胎";
                            break;
                        default:
                            break;
                    }
                    switch (r["CHILD_SENT"].ToString() ?? "")
                    {
                        case "0":
                            temp.CHILD_SENT = "嬰兒室";
                            break;
                        case "1":
                            if (r["CHILD_SENT_MEMO"].ToString() != "")
                                temp.CHILD_SENT = "PICU-" + r["CHILD_SENT_MEMO"].ToString();
                            else
                                temp.CHILD_SENT = "PICU";
                            break;
                        case "2":
                            if (r["CHILD_SENT_MEMO"].ToString() != "")
                                temp.CHILD_SENT = "NBC-" + r["CHILD_SENT_MEMO"].ToString();
                            else
                                temp.CHILD_SENT = "NBC";
                            break;
                        case "3":
                            temp.CHILD_SENT = "太平間";
                            break;
                        case "4":
                            temp.CHILD_SENT = "家屬帶回";
                            break;
                        default:
                            break;
                    }

                    temp.RB_AS_1_NUM = r["RB_AS_1_NUM"].ToString();
                    temp.RB_AS_5_NUM = r["RB_AS_5_NUM"].ToString();
                    temp.RB_AS_10_NUM = r["RB_AS_10_NUM"].ToString();

                    switch (r["MECONIUM_COLOR"].ToString() ?? "")
                    {

                        case "0":
                            temp.MECONIUM_COLOR = "無";
                            break;
                        case "1":
                            temp.MECONIUM_COLOR = "+";
                            break;
                        case "2":
                            temp.MECONIUM_COLOR = "++";
                            break;
                        case "3":
                            temp.MECONIUM_COLOR = "+++";
                            break;
                        case "4":
                            temp.MECONIUM_COLOR = "++++";
                            break;
                        default:
                            break;
                    }

                    DataTable emr = obs_m.sel_nb_emr(r["FEENO"].ToString(), r["IID"].ToString());
                    if (emr != null && emr.Rows.Count > 0)
                        temp.EMR = "有";
                    else
                        temp.EMR = "無";

                    if (r["SKIN_CONTACT"].ToString() == "0")
                        temp.SkinTouch = "無";
                    else
                        temp.SkinTouch = "有";

                    DataTable roomin = obs_m.sel_roomin("", "", "", new List<string>() { r["NB_CHARTNO"].ToString() });
                    if (roomin != null && roomin.Rows.Count > 0)
                    {
                        var EXCLUDE = false; var NoRoomIn = false; var HR12 = false; var HR24 = false;
                        var EXCLUDEReason = new List<string>(); ; var EndReason = new List<string>();

                        foreach (DataRow row in roomin.Rows)
                        {
                            if (row["EXCLUDE"].ToString() == "1")
                            {
                                EXCLUDE = true;
                                switch (row["EXC_R"].ToString() ?? "")
                                {
                                    case "0":
                                        EXCLUDEReason.Add("NB入PICU");
                                        break;
                                    case "1":
                                        EXCLUDEReason.Add("NB入NBC");
                                        break;
                                    case "2":
                                        EXCLUDEReason.Add("NB轉院");
                                        break;
                                    case "3":
                                        EXCLUDEReason.Add("NB死亡");
                                        break;
                                    case "4":
                                        EXCLUDEReason.Add("母親因素");
                                        break;
                                    default:
                                        break;
                                }
                            }
                            if (row["END_STA"].ToString() == "0")
                            {
                                HR24 = true;
                                #region 結束原因-24HR
                                var END_RS_24 = row["END_RS_24"].ToString();
                                var END_RS_24V = new List<string>();
                                for (var i = 0; i < END_RS_24.ToString().Length; i++)
                                {
                                    if (END_RS_24[i] == '1')
                                    {
                                        switch (i.ToString())
                                        {
                                            case "0":
                                                END_RS_24V.Add("正常返室");
                                                break;
                                            case "1":
                                                END_RS_24V.Add("媽媽出院");
                                                break;
                                            case "2":
                                                END_RS_24V.Add("新生兒洗澡");
                                                break;
                                            case "3":
                                                END_RS_24V.Add("新生兒檢查");
                                                break;
                                            default:
                                                break;
                                        }
                                    }
                                }
                                #endregion
                                EndReason.Add(string.Join("/", END_RS_24V));
                            }
                            if (row["END_STA"].ToString() == "1")
                                HR12 = true;
                            if (row["END_STA"].ToString() == "2")
                                NoRoomIn = true;

                            if (row["END_STA"].ToString() == "1" || row["END_STA"].ToString() == "2")
                            {
                                #region 原因類別
                                var END_RS_C = row["END_RS_C"].ToString();
                                var END_RS_CV = new List<string>();
                                for (var i = 0; i < END_RS_C.ToString().Length; i++)
                                {
                                    if (END_RS_C[i] == '1')
                                    {
                                        switch (i.ToString())
                                        {
                                            case "0":
                                                END_RS_CV.Add("產婦原因");
                                                break;
                                            case "1":
                                                END_RS_CV.Add("新生兒原因");
                                                break;
                                            case "2":
                                                END_RS_CV.Add("其他原因");
                                                break;
                                            default:
                                                break;
                                        }
                                    }
                                }
                                #endregion

                                var END_RS_PV = new List<string>();
                                var END_RS_NBV = new List<string>();
                                var END_RS_OTHV = new List<string>();
                                if (END_RS_CV.IndexOf("產婦原因") >= 0)
                                {
                                    #region 結束原因-產婦
                                    var END_RS_P = row["END_RS_P"].ToString();
                                    for (var i = 0; i < END_RS_P.ToString().Length; i++)
                                    {
                                        if (END_RS_P[i] == '1')
                                        {
                                            switch (i.ToString())
                                            {
                                                case "0":
                                                    END_RS_PV.Add("媽媽想休息");
                                                    break;
                                                case "1":
                                                    END_RS_PV.Add("媽媽沒有乳汁分泌");
                                                    break;
                                                case "2":
                                                    END_RS_PV.Add("媽媽身體不適");
                                                    break;
                                                case "3":
                                                    END_RS_PV.Add("擔心睡著後新生兒被抱走");
                                                    break;
                                                case "4":
                                                    END_RS_PV.Add("怕新生兒太吵");
                                                    break;
                                                case "5":
                                                    END_RS_PV.Add("媽媽出院");
                                                    break;
                                                case "6":
                                                    END_RS_PV.Add("媽媽自退奶");
                                                    break;
                                                case "7":
                                                    END_RS_PV.Add("媽媽產後發燒");
                                                    break;
                                                case "8":
                                                    END_RS_PV.Add("媽媽待產發燒");
                                                    break;
                                                case "9":
                                                    END_RS_PV.Add("媽媽服用不宜餵母乳之藥物");
                                                    break;
                                                case "10":
                                                    END_RS_PV.Add("擔心新生兒被感染");
                                                    break;
                                                default:
                                                    break;
                                            }
                                        }
                                    }
                                    #endregion
                                }
                                if (END_RS_CV.IndexOf("新生兒原因") >= 0)
                                {
                                    #region 結束原因-新生兒
                                    var END_RS_NB = row["END_RS_NB"].ToString();
                                    for (var i = 0; i < END_RS_NB.ToString().Length; i++)
                                    {
                                        if (END_RS_NB[i] == '1')
                                        {
                                            switch (i.ToString())
                                            {
                                                case "0":
                                                    END_RS_NBV.Add("新生兒體溫不穩");
                                                    break;
                                                case "1":
                                                    END_RS_NBV.Add("新生兒洗澡");
                                                    break;
                                                case "2":
                                                    END_RS_NBV.Add("新生兒檢查");
                                                    break;
                                                case "3":
                                                    END_RS_NBV.Add("新生兒一直哭泣");
                                                    break;
                                                case "4":
                                                    if (row["END_RS_NB_S"].ToString() != "")
                                                        END_RS_NBV.Add("新生兒自身問題-" + row["END_RS_NB_S"].ToString());
                                                    else
                                                        END_RS_NBV.Add("新生兒自身問題");
                                                    break;
                                                case "5":
                                                    END_RS_NBV.Add("新生兒預計出院");
                                                    break;
                                                case "6":
                                                    if (row["END_RS_NB_PICU"].ToString() != "")
                                                        END_RS_NBV.Add("入PICU-" + row["END_RS_NB_PICU"].ToString());
                                                    else
                                                        END_RS_NBV.Add("入PICU");
                                                    break;
                                                case "7":
                                                    if (row["END_RS_NB_NBC"].ToString() != "")
                                                        END_RS_NBV.Add("入NBC-" + row["END_RS_NB_NBC"].ToString());
                                                    else
                                                        END_RS_NBV.Add("入NBC");
                                                    break;
                                                default:
                                                    break;
                                            }
                                        }
                                    }
                                    #endregion
                                }
                                if (END_RS_CV.IndexOf("其他原因") >= 0)
                                {
                                    #region 結束原因-其他
                                    var END_RS_OTH = row["END_RS_OTH"].ToString();

                                    for (var i = 0; i < END_RS_OTH.ToString().Length; i++)
                                    {
                                        if (END_RS_OTH[i] == '1')
                                        {
                                            switch (i.ToString())
                                            {
                                                case "0":
                                                    END_RS_OTHV.Add("病房太冷");
                                                    break;
                                                case "1":
                                                    END_RS_OTHV.Add("病房環境太吵");
                                                    break;
                                                case "2":
                                                    END_RS_OTHV.Add("病房打蠟");
                                                    break;
                                                case "3":
                                                    END_RS_OTHV.Add("其他家人干預");
                                                    break;
                                                case "4":
                                                    END_RS_OTHV.Add(row["OTH_RS"].ToString());
                                                    break;
                                                default:
                                                    break;
                                            }
                                        }
                                    }
                                    #endregion
                                }

                                END_RS_PV.Concat(END_RS_NBV).Concat(END_RS_OTHV);
                                EndReason.Add(String.Join("/", END_RS_PV));
                            }

                            if (EXCLUDE)
                                temp.RoominStat = $"X-{string.Join("，", EXCLUDEReason)}";
                            else if (NoRoomIn)
                                temp.RoominStat = $"N-{string.Join("，", EndReason)}";
                            else if (HR12)
                                temp.RoominStat = "12";
                            else if (HR24)
                                temp.RoominStat = "24";
                        }
                    }

                    DataTable babylink = obs_m.sel_nbcha("", r["NB_CHARTNO"].ToString().PadLeft(10, '0'));
                    if (babylink != null && babylink.Rows.Count > 0)
                    {
                        var babyFeeno = babylink.Rows[0]["BABY_FEE_NO"].ToString();
                        var babyFeeno2 = babylink.Rows[0]["BABY_FEE_NO2"].ToString();

                        var babyInfo = Get_Patient_Info(babylink.Rows[0]["BABY_FEE_NO"].ToString());
                        temp.BabyChartNo = babyInfo.ChartNo;
                        temp.BabyName = babyInfo.PatientName;

                        string c_sql = "SELECT * FROM ( ";
                        c_sql += " SELECT A.*, C_OTHER,TITLE FROM NIS_SPECIAL_EVENT_DATA A, CARERECORD_DATA B ";
                        c_sql += "WHERE A.FEENO = B.FEENO AND A.EVENT_ID = B.CARERECORD_ID AND A.TYPE_ID = '6' ";
                        c_sql += "AND A.FEENO in ('" + babyInfo.FeeNo + "') ";
                        c_sql += " ) EVT ORDER BY EVT.CREATTIME  ";

                        DataTable Dt_C = link.DBExecSQL(c_sql);
                        if (Dt_C != null && Dt_C.Rows.Count > 0)
                        {
                            foreach (DataRow rc in Dt_C.Rows)
                            {
                                temp.Method = rc["CONTENT"].ToString();
                            }
                        }

                        var BRE_TSS1 = false; var BRE_MLK = false; var MILK = false;
                        //var WATER = false;  var D5W = false;
                        var BRE_TSS1Sql = $@"SELECT * FROM IO_DATA WHERE FEENO IN ('{babyFeeno}' {(babyFeeno2 == "" ? "" : $", '{babyFeeno2}'")})
                                        AND TYPEID = '11' AND AMOUNT > 0";
                        DataTable dt_BRE_TSS1 = obs_m.DBExecSQL(BRE_TSS1Sql);
                        if (dt_BRE_TSS1 != null && dt_BRE_TSS1.Rows.Count > 0)
                        {
                            BRE_TSS1 = true;
                        }

                        var itemid = "";
                        var itemidSql = "";
                        DataTable dt_ITEMID = null;

                        //itemidSql = $"SELECT ITEMID FROM IO_ITEM WHERE TYPEID = '2' AND NAME = '水'";
                        //dt_ITEMID = obs_m.DBExecSQL(itemidSql);
                        //if (dt_ITEMID != null && dt_ITEMID.Rows.Count > 0)
                        //{
                        //    itemid = dt_ITEMID.Rows[0]["ITEMID"].ToString();
                        //}
                        //var WATERSql = $@"SELECT * FROM IO_DATA WHERE FEENO IN ('{babyFeeno}' {(babyFeeno2 == "" ? "" : $", '{ babyFeeno2 }'")})
                        //                AND TYPEID = '2' AND ITEMID = '{ itemid }'";
                        //DataTable dt_WATER = obs_m.DBExecSQL(WATERSql);
                        //if (dt_WATER != null && dt_WATER.Rows.Count > 0)
                        //{
                        //    WATER = true;
                        //}

                        itemidSql = $"SELECT ITEMID FROM IO_ITEM WHERE TYPEID = '2' AND NAME = '母奶'";
                        dt_ITEMID = obs_m.DBExecSQL(itemidSql);
                        if (dt_ITEMID != null && dt_ITEMID.Rows.Count > 0)
                        {
                            itemid = dt_ITEMID.Rows[0]["ITEMID"].ToString();
                        }
                        var BRE_MLKSql = $@"SELECT * FROM IO_DATA WHERE FEENO IN ('{babyFeeno}' {(babyFeeno2 == "" ? "" : $", '{babyFeeno2}'")})
                                        AND TYPEID = '2' AND ITEMID = '{itemid}' AND AMOUNT > 0";
                        DataTable dt_BRE_MLK = obs_m.DBExecSQL(BRE_MLKSql);
                        if (dt_BRE_MLK != null && dt_BRE_MLK.Rows.Count > 0)
                        {
                            BRE_MLK = true;
                        }

                        itemidSql = $"SELECT ITEMID FROM IO_ITEM WHERE TYPEID = '2' AND NAME = '配方奶'";
                        dt_ITEMID = obs_m.DBExecSQL(itemidSql);
                        if (dt_ITEMID != null && dt_ITEMID.Rows.Count > 0)
                        {
                            itemid = dt_ITEMID.Rows[0]["ITEMID"].ToString();
                        }
                        var MILKSql = $@"SELECT * FROM IO_DATA WHERE FEENO IN ('{babyFeeno}' {(babyFeeno2 == "" ? "" : $", '{babyFeeno2}'")})
                                        AND TYPEID = '2' AND ITEMID = '{itemid}' AND AMOUNT > 0";
                        DataTable dt_MILK = obs_m.DBExecSQL(MILKSql);
                        if (dt_MILK != null && dt_MILK.Rows.Count > 0)
                        {
                            MILK = true;
                        }

                        //itemidSql = $"SELECT ITEMID FROM IO_ITEM WHERE TYPEID = '2' AND NAME = 'D5W'";
                        //dt_ITEMID = obs_m.DBExecSQL(itemidSql);
                        //if (dt_ITEMID != null && dt_ITEMID.Rows.Count > 0)
                        //{
                        //    itemid = dt_ITEMID.Rows[0]["ITEMID"].ToString();
                        //}
                        //var D5WSql = $@"SELECT * FROM IO_DATA WHERE FEENO IN ('{babyFeeno}' {(babyFeeno2 == "" ? "" : $", '{ babyFeeno2 }'")})
                        //                AND TYPEID = '2' AND ITEMID = '{ itemid }'";
                        //DataTable dt_D5W = obs_m.DBExecSQL(D5WSql);
                        //if (dt_D5W != null && dt_D5W.Rows.Count > 0)
                        //{
                        //    D5W = true;
                        //}

                        if ((BRE_TSS1 && !BRE_MLK && !MILK) || (!BRE_TSS1 && BRE_MLK && !MILK) || (BRE_TSS1 && BRE_MLK && !MILK))
                            temp.Feed = "純母乳";
                        else if (!BRE_TSS1 && !BRE_MLK && MILK)
                            temp.Feed = "配方奶";
                        else if (!BRE_MLK && !MILK)
                            temp.Feed = "";
                        else
                            temp.Feed = "混合乳";
                    }
                    data.Add(temp);
                }
            }

            //20200331 modified
            //ObstetricsHelper.Export(data, "新生兒名單");
            ObstetricsHelper.Export(data, "新生兒名單", string.Format("新生兒名單({0}-{1})", START.Value.ToString("yyyy/MM/dd"), END.Value.ToString("yyyy/MM/dd")));
        }
        #endregion

        #region 早產兒名單(出生日期)
        [HttpGet]
        public void ChildWeight_Export(string START_DAY, string START_TIME, string END_DAY, string END_TIME)
        {
            DateTime? START = null;
            DateTime? END = null;
            if (IsNoEmpty(START_DAY) && IsNoEmpty(START_TIME))
                START = Convert.ToDateTime(START_DAY + " " + START_TIME);
            if (IsNoEmpty(END_DAY) && IsNoEmpty(END_TIME))
                END = Convert.ToDateTime(END_DAY + " " + END_TIME);

            string sql = @"SELECT * FROM 
(SELECT rank() over(partition by R.FEENO order by R.CREATTIME desc) SEQ, R.* 
FROM OBS_NBENTR R
) T WHERE T.SEQ = 1 AND T.GEST_M < 37
";
            if (START != null && END != null)
                sql += $" AND T.BIRTH BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";
            sql += " AND T.DELETED IS NULL";
            DataTable dt = obs_m.DBExecSQL(sql);

            List<ChildWeightExport> data = new List<ChildWeightExport>();
            if (dt != null && dt.Rows.Count > 0)
            {
                foreach (DataRow r in dt.Rows)
                {
                    var temp = new ChildWeightExport();

                    var babyInfo = Get_Patient_Info(r["FEENO"].ToString());
                    temp.BabyChartNo = babyInfo.ChartNo;
                    temp.BabyName = babyInfo.PatientName;
                    switch (r["FROM_WHERE"].ToString() ?? "")
                    {
                        case "0":
                            temp.Source = "本院生產";
                            break;
                        case "1":
                            temp.Source = "院外生產";
                            break;
                        case "2":
                            temp.Source = "外院轉入";
                            break;
                        default:
                            break;
                    }

                    if (r["BIRTH"].ToString() != "")
                        temp.Birth = Convert.ToDateTime(r["BIRTH"].ToString()).ToString("yyyy/MM/dd");

                    switch (r["BIRTH_TYPE"].ToString() ?? "")
                    {
                        case "0":
                            temp.BirthType = "NSD";
                            break;
                        case "1":
                            temp.BirthType = "C/S";
                            break;
                        default:
                            break;
                    }

                    temp.GEST = r["GEST_M"].ToString() + "+" + r["GEST_D"].ToString();
                    temp.Height = r["HEIGHT"].ToString();
                    temp.Weight = r["WEIGHT"].ToString();
                    temp.Gender = r["GENDER"].ToString() == "0" ? "男" : "女";
                    temp.Phone = r["PAT_TEL"].ToString();

                    DataTable babylink = obs_m.sel_nbcha(r["FEENO"].ToString());
                    if (babylink != null && babylink.Rows.Count > 0)
                    {
                        foreach (DataRow nb in babylink.Rows)
                        {
                            var momFeeNo = nb["MOM_FEE_NO"].ToString();
                            var momInfo = Get_Patient_Info(momFeeNo);
                            temp.MomChartNo = momInfo.ChartNo;
                            temp.MomName = momInfo.PatientName;
                        }
                    }

                    string c_sql = "SELECT * FROM ( ";
                    c_sql += " SELECT A.*, C_OTHER,TITLE FROM NIS_SPECIAL_EVENT_DATA A, CARERECORD_DATA B ";
                    c_sql += "WHERE A.FEENO = B.FEENO AND A.EVENT_ID = B.CARERECORD_ID AND A.TYPE_ID = '6' ";
                    c_sql += "AND A.FEENO in ('" + r["FEENO"].ToString() + "') ";
                    //2019 新增歷中資料判斷
                    c_sql += " UNION ";
                    c_sql += " SELECT A.*, C_OTHER,TITLE FROM NIS_SPECIAL_EVENT_DATA A, CARERECORD_DATA B ";
                    c_sql += " WHERE A.FEENO = B.FEENO AND A.EVENT_ID = B.CARERECORD_ID AND A.TYPE_ID = '6' ";
                    c_sql += "AND A.FEENO in ('" + r["FEENO"].ToString() + "') ";
                    c_sql += " ) EVT ORDER BY EVT.CREATTIME  ";

                    DataTable Dt_C = link.DBExecSQL(c_sql);
                    if (Dt_C != null && Dt_C.Rows.Count > 0)
                    {
                        foreach (DataRow rc in Dt_C.Rows)
                        {
                            temp.Method = rc["CONTENT"].ToString();
                            temp.OutTime = babyInfo.OutDate.ToString("yyyy/MM/dd");
                        }
                    }

                    var v_sql = "SELECT CREATE_DATE, VS_ITEM, VS_PART, VS_RECORD, VS_MEMO,VS_REASON  "
                     + " FROM ( "
                     + "     SELECT CREATE_DATE, VS_ITEM, VS_PART, VS_RECORD, VS_MEMO,VS_REASON, "
                     + "     ROW_NUMBER() OVER(PARTITION BY t.VS_ITEM ORDER BY t.CREATE_DATE desc) NUM "
                     + "     FROM DATA_VITALSIGN t "
                     + "     WHERE FEE_NO = '" + r["FEENO"].ToString() + "' "
                     + "     AND VS_ITEM = 'bw' "
                    // + "     AND CREATE_DATE >= to_date('" + DateTime.Now.AddDays(-1).ToString("yyyy/MM/dd HH:mm:ss") + "','yyyy/MM/dd hh24:mi:ss') "
                     + "     ORDER BY CREATE_DATE DESC ) MAIN "
                     + " WHERE MAIN.NUM = 1 ";
                    DataTable Dt2 = link.DBExecSQL(v_sql);
                    if (Dt2 != null && Dt2.Rows.Count > 0)
                    {
                        foreach (DataRow r2 in Dt2.Rows)
                        {
                            temp.OutWeight = (r2["VS_RECORD"].ToString() ?? "").Replace("|", "");
                        }
                    }
                    data.Add(temp);
                }
            }

            //20200331 modified
            //ObstetricsHelper.Export(data, "早產兒名單");
            ObstetricsHelper.Export(data, "早產兒名單", string.Format("早產兒名單({0}-{1})", START.Value.ToString("yyyy/MM/dd"), END.Value.ToString("yyyy/MM/dd")));
        }
        #endregion

        #region 母乳統計表(出生日期)(排序 1.母親病歷號 2.小孩子病歷號)
        [HttpGet]
        public void FEED_Export(string START_DAY, string START_TIME, string END_DAY, string END_TIME)
        {
            DateTime? START = null;
            DateTime? END = null;
            if (IsNoEmpty(START_DAY) && IsNoEmpty(START_TIME))
                START = Convert.ToDateTime(START_DAY + " " + START_TIME);
            if (IsNoEmpty(END_DAY) && IsNoEmpty(END_TIME))
                END = Convert.ToDateTime(END_DAY + " " + END_TIME);

            //20200612 modified by chih
            //            string sql = @"SELECT R.* ,H.GEST_M, H.GEST_D
            //FROM OBS_NB R
            //LEFT JOIN OBS_BTHSTA H
            //ON R.FEENO = H.FEENO
            //WHERE 1 = 1
            //";

            // modified by chih,20200701
            //            string sql = @"SELECT R.* ,H.GEST_M, H.GEST_D , BD.BABY_FEE_NO, BD.BABY_CHART_NO , EVT.TITLE , DV.VS_PART , H.PLACE
            //FROM (OBS_NB R 
            //LEFT JOIN OBS_BTHSTA H
            //ON R.FEENO = H.FEENO ), OBS_BABYLINK_DATA BD
            //LEFT JOIN
            //(  
            //SELECT A.* ,TITLE FROM NIS_SPECIAL_EVENT_DATA A, CARERECORD_DATA B 
            //WHERE A.FEENO = B.FEENO AND A.EVENT_ID = B.CARERECORD_ID  AND A.TYPE_ID = '6' 
            //AND (B.TITLE LIKE '%死亡%' OR  B.TITLE LIKE '%轉院%') 
            //) EVT
            //ON BD.BABY_FEE_NO = EVT.FEENO
            //LEFT JOIN 
            //(  
            //SELECT RANK() OVER (PARTITION BY A.FEE_NO ORDER BY A.CREATE_DATE) SEQ, A.* FROM DATA_VITALSIGN A
            //WHERE A.VS_PART LIKE '%NPO%'
            //) DV
            //ON BD.BABY_FEE_NO = DV.FEE_NO
            //WHERE R.FEENO = BD.MOM_FEE_NO AND SUBSTR(R.NB_TEMPNO,-1,1) = BD.BABY_SEQ 
            //AND 1 = 1 
            //AND (DV.SEQ IS NULL OR DV.SEQ = 1)   
            //AND  R.NB_STAT = '1'  
            //";
            string sql = $@"SELECT R.* ,H.GEST_M, H.GEST_D , BD.BABY_FEE_NO, BD.BABY_CHART_NO , EVT.TITLE , DV.VS_PART , H.PLACE
FROM (OBS_NB R 
LEFT JOIN OBS_BTHSTA H
ON R.FEENO = H.FEENO ), OBS_BABYLINK_DATA BD
LEFT JOIN
(  
SELECT A.* ,TITLE FROM NIS_SPECIAL_EVENT_DATA A, CARERECORD_DATA B 
WHERE A.FEENO = B.FEENO AND A.EVENT_ID = B.CARERECORD_ID  AND A.TYPE_ID = '6' 
AND (B.TITLE LIKE '%死亡%' OR  B.TITLE LIKE '%轉院%') 
) EVT
ON BD.BABY_FEE_NO = EVT.FEENO
LEFT JOIN 
(  
SELECT RANK() OVER (PARTITION BY A.FEE_NO ORDER BY A.CREATE_DATE) SEQ, A.* FROM DATA_VITALSIGN A
WHERE A.VS_PART LIKE '%NPO%' AND A.CREATE_DATE BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS')
) DV
ON BD.BABY_FEE_NO = DV.FEE_NO
WHERE R.FEENO = BD.MOM_FEE_NO AND SUBSTR(R.NB_TEMPNO,-1,1) = BD.BABY_SEQ 
AND 1 = 1 
AND (DV.SEQ IS NULL OR DV.SEQ = 1)   
AND  R.NB_STAT = '1'  
";
            //end  modified by chih,20200701
            //end 20200612 modified by chih

            if (START != null && END != null)
                sql += $" AND R.BIRTH_DAY BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";
            sql += " AND R.DELETED IS NULL AND H.DELETED IS NULL ORDER BY R.BIRTH_DAY"; // H.FEENO, R.NB_CHARTNO
            DataTable dt = obs_m.DBExecSQL(sql);

            //add by chih,20200817
            for (int i = 0; i < dt.Rows.Count; i++)
            {
                if (dt.Rows[i]["VS_PART"].ToString().Contains("NPO"))
                {
                    if (IsNPO(dt.Rows[i]["BABY_FEE_NO"].ToString(), START, END) == false)
                    {
                        dt.Columns["VS_PART"].ReadOnly = false; //20200918
                        dt.Rows[i]["VS_PART"] = null;
                    }
                }
            }
            //end add by chih,20200817

            List<FEEDExport> data = new List<FEEDExport>();
            if (dt != null && dt.Rows.Count > 0)
            {
                foreach (DataRow r in dt.Rows)
                {
                    var temp = new FEEDExport();

                    var momInfo = Get_Patient_Info(r["FEENO"].ToString());
                    temp.MomChartNo = momInfo.ChartNo;
                    temp.MomName = momInfo.PatientName;

                    DataTable babylink = obs_m.sel_nbcha("", r["NB_CHARTNO"].ToString());
                    if (babylink != null && babylink.Rows.Count > 0)
                    {
                        var babyFeeno = babylink.Rows[0]["BABY_FEE_NO"].ToString();
                        var babyFeeno2 = babylink.Rows[0]["BABY_FEE_NO2"].ToString();

                        //add by chih,20200623
                        //var babyInfo = Get_Patient_Info(babyFeeno);
                        PatientInfo babyInfo = null;
                        if (babyFeeno2.Trim() != "")
                        {
                            babyInfo = Get_Patient_Info(babyFeeno2);
                        }
                        else
                        {
                            babyInfo = Get_Patient_Info(babyFeeno);
                        }
                        //end add by chih,20200623

                        temp.BabyChartNo = babyInfo.ChartNo;
                        temp.BabyName = babyInfo.PatientName;
                        temp.Birth = babyInfo.Birthday.ToString("yyyy/MM/dd");

                        //add by chih,20200511
                        if (babyInfo.CostCenterNo.Trim() == "B")
                        {
                            temp.BrPicu = "BR";
                        }
                        else if (babyInfo.CostCenterNo.Trim() == "P")
                        {
                            temp.BrPicu = "PICU";
                        }
                        else if (babyInfo.CostCenterNo.Trim() == "P1")
                        {
                            temp.BrPicu = "P1"; // add by chih,20200518
                        }
                        //end add by chih,20200511
                        temp.Seq = babylink.Rows[0]["BABY_SEQ"].ToString();

                        var BRE_TSS1 = false; var MILK = false; var BRE_MLK = false;

                        var BRE_TSS1Sql = $@"SELECT * FROM IO_DATA WHERE FEENO IN ('{babyFeeno}' {(babyFeeno2 == "" ? "" : $", '{babyFeeno2}'")})
                                        AND TYPEID = '11' AND AMOUNT > 0 AND DELETED IS NULL";
                        DataTable dt_BRE_TSS1 = obs_m.DBExecSQL(BRE_TSS1Sql);
                        if (dt_BRE_TSS1 != null && dt_BRE_TSS1.Rows.Count > 0)
                        {
                            BRE_TSS1 = true;
                        }

                        var itemid = "";
                        var itemidSql = "";
                        DataTable dt_ITEMID = null;

                        itemidSql = $"SELECT ITEMID FROM IO_ITEM WHERE TYPEID = '2' AND NAME = '母奶'";
                        dt_ITEMID = obs_m.DBExecSQL(itemidSql);
                        if (dt_ITEMID != null && dt_ITEMID.Rows.Count > 0)
                        {
                            itemid = dt_ITEMID.Rows[0]["ITEMID"].ToString();
                        }
                        var BRE_MLKSql = $@"SELECT * FROM IO_DATA WHERE FEENO IN ('{babyFeeno}' {(babyFeeno2 == "" ? "" : $", '{babyFeeno2}'")})
                                        AND TYPEID = '2' AND ITEMID = '{itemid}' AND AMOUNT > 0 AND DELETED IS NULL";
                        DataTable dt_BRE_MLK = obs_m.DBExecSQL(BRE_MLKSql);
                        if (dt_BRE_MLK != null && dt_BRE_MLK.Rows.Count > 0)
                        {
                            BRE_MLK = true;
                        }

                        itemidSql = $"SELECT ITEMID FROM IO_ITEM WHERE TYPEID = '2' AND NAME = '配方奶'";
                        dt_ITEMID = obs_m.DBExecSQL(itemidSql);
                        if (dt_ITEMID != null && dt_ITEMID.Rows.Count > 0)
                        {
                            itemid = dt_ITEMID.Rows[0]["ITEMID"].ToString();
                        }
                        var MILKSql = $@"SELECT * FROM IO_DATA WHERE FEENO IN ('{babyFeeno}' {(babyFeeno2 == "" ? "" : $", '{babyFeeno2}'")})
                                        AND TYPEID = '2' AND ITEMID = '{itemid}' AND AMOUNT > 0 AND DELETED IS NULL";
                        DataTable dt_MILK = obs_m.DBExecSQL(MILKSql);
                        if (dt_MILK != null && dt_MILK.Rows.Count > 0)
                        {
                            MILK = true;
                        }

                        if ((BRE_TSS1 && !BRE_MLK && !MILK) || (!BRE_TSS1 && BRE_MLK && !MILK) || (BRE_TSS1 && BRE_MLK && !MILK))
                            temp.Feed = "純母乳";
                        else if (!BRE_TSS1 && !BRE_MLK && MILK)
                            temp.Feed = "配方奶";
                        else if (!BRE_MLK && !MILK)
                            temp.Feed = "";
                        else
                            temp.Feed = "混合乳";
                    }

                    //20200612 add by chih
                    temp.Reason = "";
                    List<string> reasonList = new List<string>();
                    if ((r["TITLE"] ?? "").ToString().Contains("轉院"))
                    {
                        reasonList.Add("轉院");
                    }
                    else if ((r["TITLE"] ?? "").ToString().Contains("死亡"))
                    {
                        reasonList.Add("死亡");
                    }
                    if ((r["PLACE"] ?? "").ToString() == "1")
                    {
                        reasonList.Add("非本院出生");
                    }
                    if ((r["VS_PART"] ?? "").ToString().Contains("NPO"))
                    {
                        reasonList.Add("禁食");
                    }
                    temp.Reason = string.Join(",", reasonList);
                    //end 20200612 add by chih

                    data.Add(temp);
                }
            }

            //20200331 modified
            //ObstetricsHelper.Export(data, "母乳統計表");
            ObstetricsHelper.Export(data, "母乳統計表(細表)", string.Format("母乳統計表(細表)({0}-{1})", START.Value.ToString("yyyy/MM/dd"), END.Value.ToString("yyyy/MM/dd")));
        }
        #endregion


        #region 判斷禁食，一天一天的看  20200817
        private bool IsNPO(string feeno, DateTime? start, DateTime? end)
        {
            bool retValue = true;
            int countLoop = 0;

            string sql = $"SELECT * FROM DATA_VITALSIGN WHERE VS_ITEM = 'eat'  AND  FEE_NO = '{feeno}' AND CREATE_DATE BETWEEN TO_DATE('{start.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{end.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";
            DataTable dt = obs_m.DBExecSQL(sql);

            DateTime indexDate = start.Value;

            while (string.Compare(indexDate.ToString("yyyy-MM-dd"), end.Value.ToString("yyyy-MM-dd")) <= 0)
            {
                countLoop += 1;
                int countNPO = 0;
                int countNoneNPO = 0;
                for (int i = 0; i < dt.Rows.Count; i++)
                {
                    if (string.Compare(indexDate.ToString("yyyy-MM-dd"), ((DateTime)dt.Rows[i]["CREATE_DATE"]).ToString("yyyy-MM-dd")) == 0)
                    {
                        if (dt.Rows[i]["VS_PART"].ToString().Contains("NPO"))
                        {
                            countNPO += 1;
                        }
                        else
                        {
                            countNoneNPO += 1;
                        }
                    }
                }
                if (countNoneNPO > 0)
                {
                    retValue = false;
                    break;
                }
                if (countNPO == 0)
                {
                    retValue = false;
                    break;
                }
                indexDate = indexDate.AddDays(1);
            }
            if (countLoop == 0)
            {
                retValue = false;
            }

            return retValue;
        }
        #endregion


        #region 產嬰總表
        [HttpGet]
        public void List_Export(string START_DAY, string START_TIME, string END_DAY, string END_TIME)
        {
            DateTime? START = null;
            DateTime? END = null;
            if (IsNoEmpty(START_DAY) && IsNoEmpty(START_TIME))
                START = Convert.ToDateTime(START_DAY + " " + START_TIME);
            if (IsNoEmpty(END_DAY) && IsNoEmpty(END_TIME))
                END = Convert.ToDateTime(END_DAY + " " + END_TIME);

            List<ListExport> data = new List<ListExport>();
            var temp = new ListExport();

            #region 實際活產總數
            string sql = @"SELECT B.BIRTH,NB.FEENO, NB.IID, NB.NB_STAT, NB.CHILD_SENT FROM OBS_NB NB, OBS_BTHSTA B
WHERE NB.FEENO = B.FEENO AND NB.DELETED IS NULL AND NB.NB_STAT = '1'";
            if (START != null && END != null)
                sql += $" AND B.BIRTH BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";
            DataTable 實際活產總數_dt = obs_m.DBExecSQL(sql);

            var 實際活產總數 = 實際活產總數_dt == null ? 0 : 實際活產總數_dt.Rows.Count;
            temp = new ListExport();
            temp.Seq = "1";
            temp.Type = "肌膚";
            temp.Formula = "實際活產總數";
            temp.Denominator = 1;
            temp.Molecule = 實際活產總數;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);
            #endregion

            #region 活產扣除數(轉院、死亡、入PICU、入NBC)
            sql = @"SELECT B.BIRTH,NB.FEENO MOM_FEE_NO, BD.BABY_FEE_NO, BD.BABY_CHART_NO, NB.NB_CHARTNO, EVT.FEENO, NB.IID, NB.NB_STAT,  NB.CHILD_SENT, EVT.C_OTHER, EVT.TITLE 
FROM OBS_NB NB, OBS_BTHSTA B, OBS_BABYLINK_DATA BD
LEFT JOIN
(  
SELECT A.*, C_OTHER,TITLE FROM NIS_SPECIAL_EVENT_DATA A, CARERECORD_DATA B 
WHERE A.FEENO = B.FEENO AND A.EVENT_ID = B.CARERECORD_ID AND A.TYPE_ID = '6' 
AND (B.TITLE LIKE '%死亡%' OR  B.TITLE LIKE '%轉院%') 
) EVT
ON  BD.BABY_FEE_NO = EVT.FEENO
WHERE NB.FEENO = BD.MOM_FEE_NO AND SUBSTR(NB.NB_TEMPNO,-1,1) = BD.BABY_SEQ AND NB.FEENO = B.FEENO AND NB.DELETED IS NULL AND NB.NB_STAT = '1' 
AND (EVT.TITLE LIKE '%死亡%' OR  EVT.TITLE LIKE '%轉院%' OR NB.CHILD_SENT = '1'  OR NB.CHILD_SENT = '2')";
            if (START != null && END != null)
                sql += $" AND B.BIRTH BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";
            DataTable 活產扣除數_dt = obs_m.DBExecSQL(sql);

            var 活產扣除數 = 活產扣除數_dt == null ? 0 : 活產扣除數_dt.Rows.Count;
            temp = new ListExport();
            temp.Seq = "2";
            temp.Type = "肌膚";
            temp.Formula = "活產扣除數";
            temp.Denominator = 1;
            temp.Molecule = 活產扣除數;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);

            var 扣除人數原因_轉院 = 活產扣除數_dt.AsEnumerable().Count(p => (p.Field<string>("TITLE") ?? "").Contains("轉院"));
            temp = new ListExport();
            temp.Seq = "3";
            temp.Type = "肌膚";
            temp.Formula = "扣除人數原因-轉院";
            temp.Denominator = 活產扣除數;
            temp.Molecule = 扣除人數原因_轉院;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            var 扣除人數原因_入P床 = 活產扣除數_dt.AsEnumerable().Count(p => (p.Field<string>("CHILD_SENT") ?? "") == "1");
            temp = new ListExport();
            temp.Seq = "4";
            temp.Type = "肌膚";
            temp.Formula = "扣除人數原因-入P床";
            temp.Denominator = 活產扣除數;
            temp.Molecule = 扣除人數原因_入P床;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            var 扣除人數原因_NBC床 = 活產扣除數_dt.AsEnumerable().Count(p => (p.Field<string>("CHILD_SENT") ?? "") == "2");
            temp = new ListExport();
            temp.Seq = "5";
            temp.Type = "肌膚";
            temp.Formula = "扣除人數原因-NBC床";
            temp.Denominator = 活產扣除數;
            temp.Molecule = 扣除人數原因_NBC床;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            var 扣除人數原因_死亡 = 活產扣除數_dt.AsEnumerable().Count(p => (p.Field<string>("TITLE") ?? "").Contains("死亡"));
            temp = new ListExport();
            temp.Seq = "6";
            temp.Type = "肌膚";
            temp.Formula = "扣除人數原因-死亡";
            temp.Denominator = 活產扣除數;
            temp.Molecule = 扣除人數原因_死亡;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);
            #endregion

            #region 總正常新生兒
            var 總正常新生兒 = 實際活產總數 - 活產扣除數;
            temp = new ListExport();
            temp.Seq = "7";
            temp.Type = "肌膚";
            temp.Formula = "總正常新生兒";
            temp.Denominator = 1;
            temp.Molecule = 總正常新生兒;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);
            #endregion

            #region 總正常陰道產新生兒數、總正常剖腹產新生兒數
            sql = @"SELECT B.BIRTH, BD.BABY_FEE_NO,BD.BABY_CHART_NO, NB.BIRTH_TYPE, NB.NB_CHARTNO, EVT.FEENO, NB.IID, NB.NB_STAT, NB.FEENO MOM_FEE_NO, NB.CHILD_SENT, EVT.C_OTHER, EVT.TITLE 
FROM OBS_NB NB, OBS_BTHSTA B, OBS_BABYLINK_DATA BD
LEFT JOIN
(  
SELECT A.*, C_OTHER,TITLE FROM NIS_SPECIAL_EVENT_DATA A, CARERECORD_DATA B 
WHERE A.FEENO = B.FEENO AND A.EVENT_ID = B.CARERECORD_ID AND A.TYPE_ID = '6' 
AND (B.TITLE LIKE '%死亡%' OR  B.TITLE LIKE '%轉院%')
) EVT
ON  BD.BABY_FEE_NO = EVT.FEENO
WHERE NB.FEENO = BD.MOM_FEE_NO AND SUBSTR(NB.NB_TEMPNO,-1,1) = BD.BABY_SEQ AND NB.FEENO = B.FEENO AND NB.DELETED IS NULL AND NB.NB_STAT = '1' 
AND (EVT.TITLE IS NULL OR (EVT.TITLE NOT LIKE '%死亡%' AND  EVT.TITLE NOT LIKE '%轉院%')) 
AND (NB.CHILD_SENT IS NULL OR (NB.CHILD_SENT != '1'  AND NB.CHILD_SENT != '2'))";
            if (START != null && END != null)
                sql += $" AND B.BIRTH BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";
            DataTable 總正常新生兒_dt = obs_m.DBExecSQL(sql);

            var 總正常陰道產新生兒數 = 總正常新生兒_dt.AsEnumerable().Count(p => (p.Field<string>("BIRTH_TYPE") ?? "") == "0");
            temp = new ListExport();
            temp.Seq = "8";
            temp.Type = "肌膚";
            temp.Formula = "總正常陰道產新生兒數";
            temp.Denominator = 1;
            temp.Molecule = 總正常陰道產新生兒數;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);

            var 總正常剖腹產新生兒數 = 總正常新生兒_dt.AsEnumerable().Count(p => (p.Field<string>("BIRTH_TYPE") ?? "") == "1");
            temp = new ListExport();
            temp.Seq = "9";
            temp.Type = "肌膚";
            temp.Formula = "總正常剖腹產新生兒數";
            temp.Denominator = 1;
            temp.Molecule = 總正常剖腹產新生兒數;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);

            #endregion

            #region 總肌膚接觸率(陰道產新生兒皮膚接觸率、剖腹產新生兒皮膚接觸率)
            sql = @"SELECT B.BIRTH, BD.BABY_FEE_NO,BD.BABY_CHART_NO, NB.BIRTH_TYPE, NB.NB_CHARTNO, EVT.FEENO, NB.IID, NB.NB_STAT, NB.FEENO MOM_FEE_NO, NB.CHILD_SENT, EVT.C_OTHER, EVT.TITLE 
FROM OBS_NB NB, OBS_BTHSTA B, OBS_BABYLINK_DATA BD
LEFT JOIN
(  
SELECT A.*, C_OTHER,TITLE FROM NIS_SPECIAL_EVENT_DATA A, CARERECORD_DATA B 
WHERE A.FEENO = B.FEENO AND A.EVENT_ID = B.CARERECORD_ID AND A.TYPE_ID = '6' 
AND (B.TITLE LIKE '%死亡%' OR  B.TITLE LIKE '%轉院%')
) EVT
ON  BD.BABY_FEE_NO = EVT.FEENO
WHERE NB.FEENO = BD.MOM_FEE_NO AND SUBSTR(NB.NB_TEMPNO,-1,1) = BD.BABY_SEQ AND NB.FEENO = B.FEENO AND NB.DELETED IS NULL AND NB.NB_STAT = '1' 
AND (EVT.TITLE IS NULL OR (EVT.TITLE NOT LIKE '%死亡%' AND  EVT.TITLE NOT LIKE '%轉院%')) 
AND (NB.CHILD_SENT IS NULL OR (NB.CHILD_SENT != '1'  AND NB.CHILD_SENT != '2'))
AND (NB.SKIN_CONTACT = '1' AND (NB.BIRTH_TYPE = '0' AND ROUND(TO_NUMBER(NB.CONTACT_END_DAY - NB.CONTACT_START_DAY) * 24 * 60) >= 20) OR (NB.BIRTH_TYPE = '1' AND ROUND(TO_NUMBER(NB.CONTACT_END_DAY - NB.CONTACT_START_DAY) * 24 * 60) >= 10))
";
            // 20200320 SQL modified   >20   >10  改為  >=20   >= 10


            if (START != null && END != null)
                sql += $" AND B.BIRTH BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";

            DataTable 總肌膚接觸率_dt = obs_m.DBExecSQL(sql);
            var 總肌膚接觸率 = 總肌膚接觸率_dt == null ? 0 : 總肌膚接觸率_dt.Rows.Count;
            temp = new ListExport();
            temp.Seq = "10";
            temp.Type = "肌膚";
            temp.Formula = "總肌膚接觸率";
            temp.Denominator = 總正常新生兒;
            temp.Molecule = 總肌膚接觸率;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            var 陰道產新生兒皮膚接觸率 = 總肌膚接觸率_dt.AsEnumerable().Count(p => (p.Field<string>("BIRTH_TYPE") ?? "") == "0");
            temp = new ListExport();
            temp.Seq = "11";
            temp.Type = "肌膚";
            temp.Formula = "陰道產新生兒皮膚接觸率";
            temp.Denominator = 總正常陰道產新生兒數;
            temp.Molecule = 陰道產新生兒皮膚接觸率;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            var 剖腹產新生兒皮膚接觸率 = 總肌膚接觸率_dt.AsEnumerable().Count(p => (p.Field<string>("BIRTH_TYPE") ?? "") == "1");
            temp = new ListExport();
            temp.Seq = "12";
            temp.Type = "肌膚";
            temp.Formula = "剖腹產新生兒皮膚接觸率";
            temp.Denominator = 總正常剖腹產新生兒數;
            temp.Molecule = 剖腹產新生兒皮膚接觸率;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);
            #endregion

            #region 當月實際活產數
            sql = @"SELECT B.BIRTH, B.PLACE, NB.NB_CHARTNO FROM OBS_BTHSTA B, OBS_NB NB 
WHERE B.FEENO = NB.FEENO AND B.DELETED IS NULL AND NB.DELETED IS NULL AND NB.NB_STAT = '1'";
            if (START != null && END != null)
                sql += $" AND NB.BIRTH_DAY BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";

            DataTable 當月實際活產數_dt = obs_m.DBExecSQL(sql);
            var 當月實際活產數 = 當月實際活產數_dt == null ? 0 : 當月實際活產數_dt.Rows.Count;

            temp = new ListExport();
            temp.Seq = "13";
            temp.Type = "哺育狀況";
            temp.Formula = "當月實際活產數";
            temp.Denominator = 1;
            temp.Molecule = 當月實際活產數;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);
            #endregion

            #region 活產扣除人數(轉院、死亡、非本院出生、禁食)
            // modified by chih,20200701
            //            sql = @"SELECT NB.BIRTH_DAY, NB.FEENO MOM_FEE_NO, B.PLACE, BD.BABY_FEE_NO, BD.BABY_CHART_NO, NB.NB_CHARTNO, DV.VS_PART, EVT.FEENO, NB.IID, NB.NB_STAT,  NB.CHILD_SENT, EVT.C_OTHER, EVT.TITLE 
            //FROM OBS_NB NB, OBS_BTHSTA B, OBS_BABYLINK_DATA BD
            //LEFT JOIN
            //(  
            //SELECT A.*, C_OTHER,TITLE FROM NIS_SPECIAL_EVENT_DATA A, CARERECORD_DATA B 
            //WHERE A.FEENO = B.FEENO AND A.EVENT_ID = B.CARERECORD_ID AND A.TYPE_ID = '6' 
            //AND (B.TITLE LIKE '%死亡%' OR  B.TITLE LIKE '%轉院%') 
            //) EVT
            //ON BD.BABY_FEE_NO = EVT.FEENO
            //LEFT JOIN 
            //(  
            //SELECT RANK() OVER (PARTITION BY A.FEE_NO ORDER BY A.CREATE_DATE) SEQ, A.* FROM DATA_VITALSIGN A
            //WHERE A.VS_PART LIKE '%NPO%'
            //) DV
            //ON BD.BABY_FEE_NO = DV.FEE_NO
            //WHERE NB.FEENO = BD.MOM_FEE_NO AND SUBSTR(NB.NB_TEMPNO,-1,1) = BD.BABY_SEQ AND NB.FEENO = B.FEENO AND NB.DELETED IS NULL AND NB.NB_STAT = '1' 
            //AND (EVT.TITLE LIKE '%死亡%' OR  EVT.TITLE LIKE '%轉院%' OR B.PLACE = '1' OR DV.VS_PART LIKE '%NPO%')
            //AND DV.SEQ = 1";
            sql = $@"SELECT NB.BIRTH_DAY, NB.FEENO MOM_FEE_NO, B.PLACE, BD.BABY_FEE_NO, BD.BABY_CHART_NO, NB.NB_CHARTNO, DV.VS_PART, EVT.FEENO, NB.IID, NB.NB_STAT,  NB.CHILD_SENT, EVT.C_OTHER, EVT.TITLE 
FROM OBS_NB NB, OBS_BTHSTA B, OBS_BABYLINK_DATA BD
LEFT JOIN
(  
SELECT A.*, C_OTHER,TITLE FROM NIS_SPECIAL_EVENT_DATA A, CARERECORD_DATA B 
WHERE A.FEENO = B.FEENO AND A.EVENT_ID = B.CARERECORD_ID AND A.TYPE_ID = '6' 
AND (B.TITLE LIKE '%死亡%' OR  B.TITLE LIKE '%轉院%') 
) EVT
ON BD.BABY_FEE_NO = EVT.FEENO
LEFT JOIN 
(  
SELECT RANK() OVER (PARTITION BY A.FEE_NO ORDER BY A.CREATE_DATE) SEQ, A.* FROM DATA_VITALSIGN A
WHERE A.VS_PART LIKE '%NPO%'  AND A.CREATE_DATE BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS')
) DV
ON BD.BABY_FEE_NO = DV.FEE_NO
WHERE NB.FEENO = BD.MOM_FEE_NO AND SUBSTR(NB.NB_TEMPNO,-1,1) = BD.BABY_SEQ AND NB.FEENO = B.FEENO AND NB.DELETED IS NULL AND NB.NB_STAT = '1' 
AND (EVT.TITLE LIKE '%死亡%' OR  EVT.TITLE LIKE '%轉院%' OR B.PLACE = '1' OR DV.VS_PART LIKE '%NPO%')
AND DV.SEQ = 1";

            //end modified by chih,20200701
            if (START != null && END != null)
                sql += $" AND NB.BIRTH_DAY BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";
            DataTable 活產扣除人數_dt = obs_m.DBExecSQL(sql);

            //add by chih,20200817
            for (int i = 0; i < 活產扣除人數_dt.Rows.Count; i++)
            {
                if (活產扣除人數_dt.Rows[i]["VS_PART"].ToString().Contains("NPO"))
                {
                    if (IsNPO(活產扣除人數_dt.Rows[i]["BABY_FEE_NO"].ToString(), START, END) == false)
                    {
                        活產扣除人數_dt.Columns["VS_PART"].ReadOnly = false; //20200918
                        活產扣除人數_dt.Rows[i]["VS_PART"] = null;
                    }
                }
            }
            //end add by chih,20200817

            var 活產扣除人數 = 活產扣除人數_dt == null ? 0 : 活產扣除人數_dt.Rows.Count;
            temp = new ListExport();
            temp.Seq = "14";
            temp.Type = "哺育狀況";
            temp.Formula = "活產扣除人數";
            temp.Denominator = 1;
            temp.Molecule = 活產扣除人數;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);

            var 活產扣除人數原因_轉院 = 活產扣除人數_dt.AsEnumerable().Count(p => (p.Field<string>("TITLE") ?? "").Contains("轉院"));
            temp = new ListExport();
            temp.Seq = "15";
            temp.Type = "哺育狀況";
            temp.Formula = "扣除人數原因-轉院";
            temp.Denominator = 活產扣除人數;
            temp.Molecule = 活產扣除人數原因_轉院;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            var 活產扣除人數原因_死亡 = 活產扣除人數_dt.AsEnumerable().Count(p => (p.Field<string>("TITLE") ?? "").Contains("死亡"));
            temp = new ListExport();
            temp.Seq = "16";
            temp.Type = "哺育狀況";
            temp.Formula = "扣除人數原因-死亡";
            temp.Denominator = 活產扣除人數;
            temp.Molecule = 活產扣除人數原因_死亡;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            var 活產扣除人數原因_非本院出生 = 活產扣除人數_dt.AsEnumerable().Count(p => (p.Field<string>("PLACE") ?? "") == "1");
            temp = new ListExport();
            temp.Seq = "17";
            temp.Type = "哺育狀況";
            temp.Formula = "扣除人數原因-非本院出生";
            temp.Denominator = 活產扣除人數;
            temp.Molecule = 活產扣除人數原因_非本院出生;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            var 活產扣除人數原因_禁食 = 活產扣除人數_dt.AsEnumerable().Count(p => (p.Field<string>("VS_PART") ?? "").Contains("NPO"));
            temp = new ListExport();
            temp.Seq = "18";
            temp.Type = "哺育狀況";
            temp.Formula = "扣除人數原因-禁食";
            temp.Denominator = 活產扣除人數;
            temp.Molecule = 活產扣除人數原因_禁食;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);
            #endregion

            #region 當月活產數
            var 當月活產數 = 當月實際活產數 - 活產扣除人數;
            temp = new ListExport();
            temp.Seq = "19";
            temp.Type = "哺育狀況";
            temp.Formula = "當月活產數-BR+PICU";
            temp.Denominator = 1;
            temp.Molecule = 當月活產數;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);
            #endregion

            #region 總哺餵率-BR+PICU、純母乳-BR+PICU、混合乳(母乳+配方奶)-BR+PICU、配方奶-BR+PICU
            // modified by chih,20200701
            //            sql = @"SELECT NB.BIRTH_DAY, NB.FEENO MOM_FEE_NO, B.PLACE, BD.BABY_FEE_NO, BD.BABY_CHART_NO, NB.NB_CHARTNO, DV.VS_PART, EVT.FEENO, NB.IID, NB.NB_STAT,  NB.CHILD_SENT, EVT.C_OTHER, EVT.TITLE 
            //FROM OBS_NB NB, OBS_BTHSTA B, OBS_BABYLINK_DATA BD
            //LEFT JOIN
            //(  
            //SELECT A.*, C_OTHER,TITLE FROM NIS_SPECIAL_EVENT_DATA A, CARERECORD_DATA B 
            //WHERE A.FEENO = B.FEENO AND A.EVENT_ID = B.CARERECORD_ID AND A.TYPE_ID = '6' 
            //AND (B.TITLE LIKE '%死亡%' OR  B.TITLE LIKE '%轉院%') 
            //) EVT
            //ON BD.BABY_FEE_NO = EVT.FEENO
            //LEFT JOIN 
            //(  
            //SELECT RANK() OVER (PARTITION BY A.FEE_NO ORDER BY A.CREATE_DATE) SEQ, A.* FROM DATA_VITALSIGN A
            //WHERE A.VS_PART LIKE '%NPO%'
            //) DV
            //ON BD.BABY_FEE_NO = DV.FEE_NO
            //WHERE NB.FEENO = BD.MOM_FEE_NO AND SUBSTR(NB.NB_TEMPNO,-1,1) = BD.BABY_SEQ AND NB.FEENO = B.FEENO AND NB.DELETED IS NULL AND NB.NB_STAT = '1' 
            //AND (EVT.TITLE IS NULL OR (EVT.TITLE NOT LIKE '%死亡%' AND  EVT.TITLE NOT LIKE '%轉院%')) 
            //AND (DV.VS_PART IS NULL OR DV.VS_PART NOT LIKE '%NPO%')
            //AND (DV.SEQ IS NULL OR DV.SEQ = 1)";
            sql = $@"SELECT NB.BIRTH_DAY, NB.FEENO MOM_FEE_NO, B.PLACE, BD.BABY_FEE_NO, BD.BABY_CHART_NO, NB.NB_CHARTNO, DV.VS_PART, EVT.FEENO, NB.IID, NB.NB_STAT,  NB.CHILD_SENT, EVT.C_OTHER, EVT.TITLE 
FROM OBS_NB NB, OBS_BTHSTA B, OBS_BABYLINK_DATA BD
LEFT JOIN
(  
SELECT A.*, C_OTHER,TITLE FROM NIS_SPECIAL_EVENT_DATA A, CARERECORD_DATA B 
WHERE A.FEENO = B.FEENO AND A.EVENT_ID = B.CARERECORD_ID AND A.TYPE_ID = '6' 
AND (B.TITLE LIKE '%死亡%' OR  B.TITLE LIKE '%轉院%') 
) EVT
ON BD.BABY_FEE_NO = EVT.FEENO
LEFT JOIN 
(  
SELECT RANK() OVER (PARTITION BY A.FEE_NO ORDER BY A.CREATE_DATE) SEQ, A.* FROM DATA_VITALSIGN A
WHERE A.VS_PART LIKE '%NPO%' AND A.CREATE_DATE BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS')
) DV
ON BD.BABY_FEE_NO = DV.FEE_NO
WHERE NB.FEENO = BD.MOM_FEE_NO AND SUBSTR(NB.NB_TEMPNO,-1,1) = BD.BABY_SEQ AND NB.FEENO = B.FEENO AND NB.DELETED IS NULL AND NB.NB_STAT = '1' 
AND (EVT.TITLE IS NULL OR (EVT.TITLE NOT LIKE '%死亡%' AND  EVT.TITLE NOT LIKE '%轉院%')) 
AND (DV.VS_PART IS NULL OR DV.VS_PART NOT LIKE '%NPO%')
AND (DV.SEQ IS NULL OR DV.SEQ = 1)";
            // end modified by chih,20200701

            if (START != null && END != null)
                sql += $" AND NB.BIRTH_DAY BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";
            DataTable 當月活產數_dt = obs_m.DBExecSQL(sql);

            //add by chih,20200817
            for (int i = 0; i < 當月活產數_dt.Rows.Count; i++)
            {
                if (當月活產數_dt.Rows[i]["VS_PART"].ToString().Contains("NPO"))
                {
                    if (IsNPO(當月活產數_dt.Rows[i]["BABY_FEE_NO"].ToString(), START, END) == false)
                    {
                        當月活產數_dt.Columns["VS_PART"].ReadOnly = false; //20200918
                        當月活產數_dt.Rows[i]["VS_PART"] = null;
                    }
                }
            }
            //end add by chih,20200817 

            var 純母乳_BR_PICU = 0;
            var 混合乳_BR_PICU = 0;
            var 配方奶_BR_PICU = 0;

            var 純母乳_PICU = 0;
            var 混合乳_PICU = 0;
            var 配方奶_PICU = 0;

            var 純母乳_BR = 0;
            var 混合乳_BR = 0;
            var 配方奶_BR = 0;

            當月活產數_dt.AsEnumerable().ForEach(p =>
            {
                var feeno = p.Field<string>("BABY_FEE_NO") ?? "";
                if (feeno != "")
                {
                    var ptinfo = Get_Patient_Info(feeno);

                    DataTable babylink = obs_m.sel_nbcha(feeno);
                    if (babylink != null && babylink.Rows.Count > 0)
                    {
                        var babyFeeno = babylink.Rows[0]["BABY_FEE_NO"].ToString();
                        var babyFeeno2 = babylink.Rows[0]["BABY_FEE_NO2"].ToString();

                        //add by chih,20200624
                        if (babyFeeno2.Trim() != "")
                        {
                            ptinfo = Get_Patient_Info(babyFeeno2);
                        }
                        //end add by chih,20200624

                        var BRE_TSS1 = false; var MILK = false; var BRE_MLK = false;

                        var BRE_TSS1Sql = $@"SELECT * FROM IO_DATA WHERE FEENO IN ('{babyFeeno}' {(babyFeeno2 == "" ? "" : $", '{babyFeeno2}'")})
                                        AND TYPEID = '11' AND AMOUNT > 0";
                        DataTable dt_BRE_TSS1 = obs_m.DBExecSQL(BRE_TSS1Sql);
                        if (dt_BRE_TSS1 != null && dt_BRE_TSS1.Rows.Count > 0)
                        {
                            BRE_TSS1 = true;
                        }

                        var itemid = "";
                        var itemidSql = "";
                        DataTable dt_ITEMID = null;

                        itemidSql = $"SELECT ITEMID FROM IO_ITEM WHERE TYPEID = '2' AND NAME = '母奶'";
                        dt_ITEMID = obs_m.DBExecSQL(itemidSql);
                        if (dt_ITEMID != null && dt_ITEMID.Rows.Count > 0)
                        {
                            itemid = dt_ITEMID.Rows[0]["ITEMID"].ToString();
                        }
                        var BRE_MLKSql = $@"SELECT * FROM IO_DATA WHERE FEENO IN ('{babyFeeno}' {(babyFeeno2 == "" ? "" : $", '{babyFeeno2}'")})
                                        AND TYPEID = '2' AND ITEMID = '{itemid}' AND AMOUNT > 0";
                        DataTable dt_BRE_MLK = obs_m.DBExecSQL(BRE_MLKSql);
                        if (dt_BRE_MLK != null && dt_BRE_MLK.Rows.Count > 0)
                        {
                            BRE_MLK = true;
                        }

                        itemidSql = $"SELECT ITEMID FROM IO_ITEM WHERE TYPEID = '2' AND NAME = '配方奶'";
                        dt_ITEMID = obs_m.DBExecSQL(itemidSql);
                        if (dt_ITEMID != null && dt_ITEMID.Rows.Count > 0)
                        {
                            itemid = dt_ITEMID.Rows[0]["ITEMID"].ToString();
                        }
                        var MILKSql = $@"SELECT * FROM IO_DATA WHERE FEENO IN ('{babyFeeno}' {(babyFeeno2 == "" ? "" : $", '{babyFeeno2}'")})
                                        AND TYPEID = '2' AND ITEMID = '{itemid}' AND AMOUNT > 0";
                        DataTable dt_MILK = obs_m.DBExecSQL(MILKSql);
                        if (dt_MILK != null && dt_MILK.Rows.Count > 0)
                        {
                            MILK = true;
                        }

                        if ((BRE_TSS1 && !BRE_MLK && !MILK) || (!BRE_TSS1 && BRE_MLK && !MILK) || (BRE_TSS1 && BRE_MLK && !MILK))
                        {
                            純母乳_BR_PICU += 1;
                            if (ptinfo.CostCenterNo.Trim() == "B")
                            {
                                純母乳_BR += 1;
                            }
                            else if (ptinfo.CostCenterNo.Trim() == "P" || ptinfo.CostCenterNo.Trim() == "P1")  //20200518
                            {
                                純母乳_PICU += 1;
                            }
                        }
                        else if (!BRE_TSS1 && !BRE_MLK && MILK)
                        {
                            配方奶_BR_PICU += 1;
                            if (ptinfo.CostCenterNo.Trim() == "B")
                            {
                                配方奶_BR += 1;
                            }
                            else if (ptinfo.CostCenterNo.Trim() == "P" || ptinfo.CostCenterNo.Trim() == "P1")   //20200518
                            {
                                配方奶_PICU += 1;
                            }
                        }
                        else if (!BRE_MLK && !MILK) { }
                        else
                        {
                            混合乳_BR_PICU += 1;
                            if (ptinfo.CostCenterNo.Trim() == "B")
                            {
                                混合乳_BR += 1;
                            }
                            else if (ptinfo.CostCenterNo.Trim() == "P" || ptinfo.CostCenterNo.Trim() == "P1")   //20200518
                            {
                                混合乳_PICU += 1;
                            }
                        }
                    }
                }
            });

            var 總哺餵率_BR_PICU = 純母乳_BR_PICU + 混合乳_BR_PICU;
            var 總哺餵率_BR = 純母乳_BR + 混合乳_BR;
            var 總哺餵率_PICU = 純母乳_PICU + 混合乳_PICU;

            temp = new ListExport();
            temp.Seq = "20";
            temp.Type = "哺育狀況";
            temp.Formula = "總哺餵率-BR+PICU";
            temp.Denominator = 當月活產數;
            temp.Molecule = 總哺餵率_BR_PICU;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            temp = new ListExport();
            temp.Seq = "21";
            temp.Type = "哺育狀況";
            temp.Formula = "純母乳-BR+PICU";
            temp.Denominator = 當月活產數;
            temp.Molecule = 純母乳_BR_PICU;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            temp = new ListExport();
            temp.Seq = "22";
            temp.Type = "哺育狀況";
            temp.Formula = "混合乳(母乳+配方奶)-BR+PICU";
            temp.Denominator = 當月活產數;
            temp.Molecule = 混合乳_BR_PICU;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            temp = new ListExport();
            temp.Seq = "23";
            temp.Type = "哺育狀況";
            temp.Formula = "配方奶-BR+PICU";
            temp.Denominator = 當月活產數;
            temp.Molecule = 配方奶_BR_PICU;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);
            #endregion

            #region 當月活產數-BR
            var 當月活產數_BR = 0;
            var 當月活產數_PICU = 0;

            當月活產數_dt.AsEnumerable().ForEach(p =>
            {
                var feeno = p.Field<string>("BABY_FEE_NO") ?? "";
                if (feeno != "")
                {
                    var ptinfo = Get_Patient_Info(feeno);
                    //add by chih,20200624
                    DataTable babylink = obs_m.sel_nbcha(feeno);
                    if (babylink != null && babylink.Rows.Count > 0)
                    {
                        var babyFeeno = babylink.Rows[0]["BABY_FEE_NO"].ToString();
                        var babyFeeno2 = babylink.Rows[0]["BABY_FEE_NO2"].ToString();
                        if (babyFeeno2.Trim() != "")
                        {
                            ptinfo = Get_Patient_Info(babyFeeno2);
                        }
                    }
                    //end add by chih,20200624

                    if (ptinfo.CostCenterNo.Trim() == "B")
                    {
                        當月活產數_BR += 1;
                    }
                    else if (ptinfo.CostCenterNo.Trim() == "P" || ptinfo.CostCenterNo.Trim() == "P1")  //20200518
                    {
                        當月活產數_PICU += 1;
                    }
                }
            });

            temp = new ListExport();
            temp.Seq = "24";
            temp.Type = "哺育狀況";
            temp.Formula = "當月活產數-BR";
            temp.Denominator = 1;
            temp.Molecule = 當月活產數_BR;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);

            #endregion

            #region 總哺餵率-BR、純母乳-BR、混合乳(母乳+配方奶)-BR、配方奶-BR
            temp = new ListExport();
            temp.Seq = "25";
            temp.Type = "哺育狀況";
            temp.Formula = "總哺餵率-BR";
            temp.Denominator = 當月活產數_BR;
            temp.Molecule = 總哺餵率_BR;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            temp = new ListExport();
            temp.Seq = "26";
            temp.Type = "哺育狀況";
            temp.Formula = "純母乳-BR";
            temp.Denominator = 當月活產數_BR;
            temp.Molecule = 純母乳_BR;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            temp = new ListExport();
            temp.Seq = "27";
            temp.Type = "哺育狀況";
            temp.Formula = "混合乳(母乳+配方奶)-BR";
            temp.Denominator = 當月活產數_BR;
            temp.Molecule = 混合乳_BR;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            temp = new ListExport();
            temp.Seq = "28";
            temp.Type = "哺育狀況";
            temp.Formula = "配方奶-BR";
            temp.Denominator = 當月活產數_BR;
            temp.Molecule = 配方奶_BR;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);
            #endregion

            #region 當月活產數-PICU
            temp = new ListExport();
            temp.Seq = "29";
            temp.Type = "哺育狀況";
            temp.Formula = "當月活產數-PICU";
            temp.Denominator = 1;
            temp.Molecule = 當月活產數_PICU;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);
            #endregion

            #region 總哺餵率-PICU、純母乳-PICU、混合乳(母乳+配方奶)-PICU、配方奶-PICU
            temp = new ListExport();
            temp.Seq = "30";
            temp.Type = "哺育狀況";
            temp.Formula = "總哺餵率-PICU";
            temp.Denominator = 當月活產數_PICU;
            temp.Molecule = 總哺餵率_PICU;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            temp = new ListExport();
            temp.Seq = "31";
            temp.Type = "哺育狀況";
            temp.Formula = "純母乳-PICU";
            temp.Denominator = 當月活產數_PICU;
            temp.Molecule = 純母乳_PICU;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            temp = new ListExport();
            temp.Seq = "32";
            temp.Type = "哺育狀況";
            temp.Formula = "混合乳(母乳+配方奶)-PICU";
            temp.Denominator = 當月活產數_PICU;
            temp.Molecule = 混合乳_PICU;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            temp = new ListExport();
            temp.Seq = "33";
            temp.Type = "哺育狀況";
            temp.Formula = "配方奶-PICU";
            temp.Denominator = 當月活產數_PICU;
            temp.Molecule = 配方奶_PICU;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);
            #endregion

            #region 當月實際產婦人數
            sql = @"SELECT B.FEENO, B.BIRTH_TYPE, NB.NB_STAT, NB.NB_CHARTNO, B.BIRTH 
FROM OBS_BTHSTA B, OBS_NB NB
WHERE B.FEENO = NB.FEENO AND B.DELETED IS NULL AND LENGTH(B.FEENO) = 10
AND NB.NB_STAT = '1'";
            if (START != null && END != null)
                sql += $" AND B.BIRTH BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";
            DataTable 當月實際產婦人數_dt = obs_m.DBExecSQL(sql);

            var 當月實際產婦人數 = 當月實際產婦人數_dt.AsEnumerable().GroupBy(p => p.Field<string>("FEENO")).Count();
            temp = new ListExport();
            temp.Seq = "34";
            temp.Type = "親子同室";
            temp.Formula = "當月實際產婦人數";
            temp.Denominator = 1;
            temp.Molecule = 當月實際產婦人數;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);
            #endregion

            #region 扣除人數(NB入PICU、NB入NBC、轉院、死亡、母親因素)、總正常陰道產產婦人數、總正常剖腹產產婦人數
            var 親子同室扣除人數 = 0;
            var 親子同室扣除人數原因_NB入PICU = 0;
            var 親子同室扣除人數原因_NB入NBC = 0;
            var 親子同室扣除人數原因_轉院 = 0;
            var 親子同室扣除人數原因_死亡 = 0;
            var 親子同室扣除人數原因_母親因素 = 0;

            var 總正常陰道產產婦人數 = 0;
            var 總正常剖腹產產婦人數 = 0;
            var 陰道產產婦採行24小時親子同室 = 0;
            var 剖腹產產婦採行24小時親子同室 = 0;
            var 陰道產產婦採行12小時親子同室 = 0;
            var 剖腹產產婦採行12小時親子同室 = 0;
            var 陰道產產婦未執行親子同室 = 0;
            var 剖腹產產婦未執行親子同室 = 0;
            var 正常產婦採行24小時親子同室 = 0;
            var 正常產婦採行12小時親子同室 = 0;

            當月實際產婦人數_dt.AsEnumerable().GroupBy(p => p.Field<string>("FEENO")).ForEach(p =>
            {
                var feeno = p.Key;
                if (feeno != "")
                {
                    var ptinfo = Get_Patient_Info(feeno);

                    var NB = p.Select(x => (x.Field<string>("NB_CHARTNO") ?? "").Trim()).ToList();

                    //20200416 modified    obs_roomin 資料表的PAT_FEENO記錄的是chart_no
                    //                    sql = $@"SELECT * FROM OBS_ROOMIN
                    //WHERE DELETED IS NULL AND EXCLUDE = '1' AND EXC_R IS NOT NULL
                    //AND PAT_FEENO = '{ptinfo.ChartNo}' AND NB_CHARTNO IN (' {String.Join("','", NB)} ')";
                    sql = $@"SELECT * FROM OBS_ROOMIN
WHERE DELETED IS NULL AND EXCLUDE = '1' AND EXC_R IS NOT NULL
AND PAT_FEENO = '{ptinfo.ChartNo}' AND NB_CHARTNO IN ('{String.Join("','", NB)}')";
                    //end 20200416 modified 

                    DataTable 親子同室排除_產婦_dt = obs_m.DBExecSQL(sql);

                    var 親子同室排除數_產婦 = 親子同室排除_產婦_dt.AsEnumerable().GroupBy(x => new
                    {
                        PAT_FEENO = (x.Field<string>("PAT_FEENO") ?? ""),
                        NB_CHARTNO = (x.Field<string>("NB_CHARTNO") ?? "")
                    }).Count();

                    if (親子同室排除數_產婦 == NB.Count())
                    {
                        親子同室扣除人數 += 1;
                        if (親子同室排除_產婦_dt.AsEnumerable().Count(x => x.Field<string>("EXC_R") == "0") > 0)
                        {
                            親子同室扣除人數原因_NB入PICU += 1;
                        }
                        if (親子同室排除_產婦_dt.AsEnumerable().Count(x => x.Field<string>("EXC_R") == "1") > 0)
                        {
                            親子同室扣除人數原因_NB入NBC += 1;
                        }
                        if (親子同室排除_產婦_dt.AsEnumerable().Count(x => x.Field<string>("EXC_R") == "2") > 0)
                        {
                            親子同室扣除人數原因_轉院 += 1;
                        }
                        if (親子同室排除_產婦_dt.AsEnumerable().Count(x => x.Field<string>("EXC_R") == "3") > 0)
                        {
                            親子同室扣除人數原因_死亡 += 1;
                        }
                        if (親子同室排除_產婦_dt.AsEnumerable().Count(x => x.Field<string>("EXC_R") == "4") > 0)
                        {
                            親子同室扣除人數原因_母親因素 += 1;
                        }
                    }
                    else
                    {
                        //20200416 modified 
                        //                        sql = $@"SELECT PAT_FEENO, NB_CHARTNO, END_STA FROM OBS_ROOMIN
                        //WHERE DELETED IS NULL AND EXCLUDE = '0'
                        //AND PAT_FEENO = '{ptinfo.ChartNo}' AND NB_CHARTNO IN (' {String.Join("','", NB)} ')";
                        sql = $@"SELECT PAT_FEENO, NB_CHARTNO, END_STA FROM OBS_ROOMIN
WHERE DELETED IS NULL AND EXCLUDE = '0'
AND PAT_FEENO = '{ptinfo.ChartNo}' AND NB_CHARTNO IN ('{String.Join("','", NB)}')";
                        //end 20200416 modified 

                        DataTable 親子同室_產婦_dt = obs_m.DBExecSQL(sql);
                        var 親子同室_產婦_IENUM = 親子同室_產婦_dt.AsEnumerable();

                        if (親子同室_產婦_IENUM.Count(x => (x.Field<string>("END_STA") ?? "") == "2") > 0)
                        {
                        }
                        else if (親子同室_產婦_IENUM.Count(x => (x.Field<string>("END_STA") ?? "") == "1") > 0)
                        {
                            正常產婦採行12小時親子同室 += 1;
                        }
                        else if (親子同室_產婦_IENUM.Count(x => (x.Field<string>("END_STA") ?? "") == "0") > 0)
                        {
                            正常產婦採行24小時親子同室 += 1;
                        }

                        if (p.First().Field<string>("BIRTH_TYPE") == "0")
                        {
                            總正常陰道產產婦人數 += 1;

                            if (親子同室_產婦_IENUM.Count(x => (x.Field<string>("END_STA") ?? "") == "2") > 0)
                            {
                                陰道產產婦未執行親子同室 += 1;
                            }
                            else if (親子同室_產婦_IENUM.Count(x => (x.Field<string>("END_STA") ?? "") == "1") > 0)
                            {
                                陰道產產婦採行12小時親子同室 += 1;
                            }
                            else if (親子同室_產婦_IENUM.Count(x => (x.Field<string>("END_STA") ?? "") == "0") > 0)
                            {
                                陰道產產婦採行24小時親子同室 += 1;
                            }
                        }
                        else
                        {
                            總正常剖腹產產婦人數 += 1;
                            if (親子同室_產婦_IENUM.Count(x => (x.Field<string>("END_STA") ?? "") == "2") > 0)
                            {
                                剖腹產產婦未執行親子同室 += 1;
                            }
                            else if (親子同室_產婦_IENUM.Count(x => (x.Field<string>("END_STA") ?? "") == "1") > 0)
                            {
                                剖腹產產婦採行12小時親子同室 += 1;
                            }
                            else if (親子同室_產婦_IENUM.Count(x => (x.Field<string>("END_STA") ?? "") == "0") > 0)
                            {
                                剖腹產產婦採行24小時親子同室 += 1;
                            }
                        }
                    }
                }
            });

            temp = new ListExport();
            temp.Seq = "35";
            temp.Type = "親子同室";
            temp.Formula = "扣除人數";
            temp.Denominator = 1;
            temp.Molecule = 親子同室扣除人數;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);

            temp = new ListExport();
            temp.Seq = "36";
            temp.Type = "親子同室";
            temp.Formula = "扣除人數原因-NB入PICU";
            temp.Denominator = 親子同室扣除人數;
            temp.Molecule = 親子同室扣除人數原因_NB入PICU;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            temp = new ListExport();
            temp.Seq = "37";
            temp.Type = "親子同室";
            temp.Formula = "扣除人數原因-NB入NBC";
            temp.Denominator = 親子同室扣除人數;
            //20200417 modified
            //temp.Molecule = 親子同室扣除人數原因_NB入PICU;
            temp.Molecule = 親子同室扣除人數原因_NB入NBC;
            //end 20200417 modified
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            temp = new ListExport();
            temp.Seq = "38";
            temp.Type = "親子同室";
            temp.Formula = "扣除人數原因-轉院";
            temp.Denominator = 親子同室扣除人數;
            temp.Molecule = 親子同室扣除人數原因_轉院;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            temp = new ListExport();
            temp.Seq = "39";
            temp.Type = "親子同室";
            temp.Formula = "扣除人數原因-死亡";
            temp.Denominator = 親子同室扣除人數;
            temp.Molecule = 親子同室扣除人數原因_死亡;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            temp = new ListExport();
            temp.Seq = "40";
            temp.Type = "親子同室";
            temp.Formula = "扣除人數原因-母親因素";
            temp.Denominator = 親子同室扣除人數;
            temp.Molecule = 親子同室扣除人數原因_母親因素;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            //modified by chih,20200608
            //var 總正常產婦人數 = 親子同室扣除人數;
            var 總正常產婦人數 = 當月實際產婦人數 - 親子同室扣除人數;
            //end modified by chih,20200608
            temp = new ListExport();
            temp.Seq = "41";
            temp.Type = "親子同室";
            temp.Formula = "總正常產婦人數";
            temp.Denominator = 1;
            temp.Molecule = 總正常產婦人數;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);

            temp = new ListExport();
            temp.Seq = "42";
            temp.Type = "親子同室";
            temp.Formula = "總正常陰道產產婦人數";
            temp.Denominator = 總正常產婦人數;
            temp.Molecule = 總正常陰道產產婦人數;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            temp = new ListExport();
            temp.Seq = "43";
            temp.Type = "親子同室";
            temp.Formula = "總正常剖腹產產婦人數";
            temp.Denominator = 總正常產婦人數;
            temp.Molecule = 總正常剖腹產產婦人數;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            temp = new ListExport();
            temp.Seq = "44";
            temp.Type = "親子同室";
            temp.Formula = "陰道產產婦採行24小時親子同室";
            temp.Denominator = 總正常陰道產產婦人數;
            temp.Molecule = 陰道產產婦採行24小時親子同室;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            temp = new ListExport();
            temp.Seq = "45";
            temp.Type = "親子同室";
            temp.Formula = "剖腹產產婦採行24小時親子同室";
            temp.Denominator = 總正常剖腹產產婦人數;
            temp.Molecule = 剖腹產產婦採行24小時親子同室;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            temp = new ListExport();
            temp.Seq = "46";
            temp.Type = "親子同室";
            temp.Formula = "陰道產產婦採行12小時親子同室";
            temp.Denominator = 總正常陰道產產婦人數;
            temp.Molecule = 陰道產產婦採行12小時親子同室;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            temp = new ListExport();
            temp.Seq = "47";
            temp.Type = "親子同室";
            temp.Formula = "剖腹產產婦採行12小時親子同室";
            temp.Denominator = 總正常剖腹產產婦人數;
            temp.Molecule = 剖腹產產婦採行12小時親子同室;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            temp = new ListExport();
            temp.Seq = "48";
            temp.Type = "親子同室";
            temp.Formula = "陰道產產婦未執行親子同室";
            temp.Denominator = 總正常陰道產產婦人數;
            temp.Molecule = 陰道產產婦未執行親子同室;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            temp = new ListExport();
            temp.Seq = "49";
            temp.Type = "親子同室";
            temp.Formula = "剖腹產產婦未執行親子同室";
            temp.Denominator = 總正常剖腹產產婦人數;
            temp.Molecule = 剖腹產產婦未執行親子同室;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            temp = new ListExport();
            temp.Seq = "50";
            temp.Type = "親子同室";
            temp.Formula = "正常產婦採行24小時親子同室";
            temp.Denominator = 總正常產婦人數;
            temp.Molecule = 正常產婦採行24小時親子同室;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            temp = new ListExport();
            temp.Seq = "51";
            temp.Type = "親子同室";
            temp.Formula = "正常產婦採行12小時親子同室";
            temp.Denominator = 總正常產婦人數;
            temp.Molecule = 正常產婦採行12小時親子同室;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);
            #endregion

            #region 母乳轉介人數
            sql = @"SELECT S.* FROM (
SELECT RANK() OVER (PARTITION BY BT.FEENO ORDER BY BT.CREATTIME DESC) SEQ, B.FEENO, B.BIRTH
FROM OBS_BTHSTA B, OBS_BREDTRAN BT
WHERE B.FEENO = BT.FEENO AND B.DELETED IS NULL AND BT.DELETED IS NULL
) S
WHERE S.SEQ = 1";
            if (START != null && END != null)
                sql += $" AND S.BIRTH BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";

            DataTable 母乳轉介人數_dt = obs_m.DBExecSQL(sql);
            var 母乳轉介人數 = 母乳轉介人數_dt == null ? 0 : 母乳轉介人數_dt.Rows.Count;
            temp = new ListExport();
            temp.Seq = "52";
            temp.Type = "媽媽";
            temp.Formula = "母乳轉介人數";
            temp.Denominator = 1;
            temp.Molecule = 母乳轉介人數;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);
            #endregion

            #region 生產數、剖腹產率、自然產率
            sql = @"SELECT B.FEENO, B.BIRTH, B.PERINEUM, B.PERI_LAC, B.PATERNITY, B.CORDCLAMP, B.EPIDURAL, NB.BIRTH_TYPE, NB.NB_CHARTNO, B.TOP, B.GEST_M, NB.RB_AS_1_NUM FROM OBS_BTHSTA B
LEFT JOIN OBS_NB NB
ON B.FEENO = NB.FEENO
WHERE B.DELETED IS NULL AND B.TOP != '1' AND B.GEST_M >= 20 
AND LENGTH(B.FEENO) = 10 AND NB.NB_STAT = '1'
AND NB.RB_AS_1_NUM != 0 ";
            if (START != null && END != null)
                sql += $" AND B.BIRTH BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";

            DataTable 生產數_dt = obs_m.DBExecSQL(sql);
            var 生產數 = 生產數_dt.AsEnumerable().GroupBy(p => p.Field<string>("FEENO")).Count();

            temp = new ListExport();
            temp.Seq = "53";
            temp.Type = "媽媽";
            temp.Formula = "生產數";
            temp.Denominator = 1;
            temp.Molecule = 生產數;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);

            var 剖腹產率 = 生產數_dt.AsEnumerable().Where(p => (p.Field<string>("BIRTH_TYPE") ?? "") == "1").GroupBy(p => p.Field<string>("FEENO")).Count();
            temp = new ListExport();
            temp.Seq = "54";
            temp.Type = "媽媽";
            temp.Formula = "剖腹產率";
            temp.Denominator = 生產數;
            temp.Molecule = 剖腹產率;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            var 自然產率 = 生產數_dt.AsEnumerable().Where(p => (p.Field<string>("BIRTH_TYPE") ?? "") == "0").GroupBy(p => p.Field<string>("FEENO")).Count();
            temp = new ListExport();
            temp.Seq = "55";
            temp.Type = "媽媽";
            temp.Formula = "自然產率";
            temp.Denominator = 生產數;
            temp.Molecule = 自然產率;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);
            #endregion

            #region 早產產前類固醇施打
            sql = @"SELECT B.FEENO FROM OBS_BTHSTA B
WHERE B.DELETED IS NULL AND B.GEST_M >=24 AND B.GEST_M <= 33 ";
            if (START != null && END != null)
                sql += $" AND B.BIRTH BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";
            DataTable 早產產婦_dt = obs_m.DBExecSQL(sql);
            var 早產產婦_分母 = 早產產婦_dt == null ? 0 : 早產產婦_dt.Rows.Count;
            var 類固醇施打 = 0;

            早產產婦_dt.AsEnumerable().ForEach(p =>
                {
                    var feeno = p.Field<string>("FEENO") ?? "";
                    if (feeno != "")
                    {
                        byte[] 早產產婦_listByteCode = webService.GetBirthTrauma(feeno);
                        if (早產產婦_listByteCode == null) { }
                        else
                        {
                            string listJsonArray = CompressTool.DecompressString(早產產婦_listByteCode);
                            BirthTrauma[] birthTrauma = JsonConvert.DeserializeObject<BirthTrauma[]>(listJsonArray);
                            if (birthTrauma.Count() > 0 && birthTrauma[0].Steroid == true)
                            {
                                類固醇施打 += 1;
                            }
                        }
                    }
                });
            temp = new ListExport();
            temp.Seq = "56";
            temp.Type = "媽媽";
            temp.Formula = "早產產前類固醇施打";
            temp.Denominator = 早產產婦_分母;
            temp.Molecule = 類固醇施打;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);
            #endregion

            #region 總剖腹產率、初次剖腹產率
            sql = @"SELECT HIS.VBAC, B.FEENO, B.BIRTH, B.PERINEUM, B.PERI_LAC, B.PATERNITY, B.CORDCLAMP, B.EPIDURAL, NB.BIRTH_TYPE, NB.NB_CHARTNO, B.TOP, B.GEST_M, NB.RB_AS_1_NUM 
FROM OBS_BTHHIS HIS, OBS_BTHSTA B
LEFT JOIN OBS_NB NB
ON B.FEENO = NB.FEENO
WHERE B.FEENO = HIS.FEENO AND B.DELETED IS NULL AND B.TOP != '1' AND B.GEST_M >= 20 
AND LENGTH(B.FEENO) = 10 AND NB.NB_STAT = '1'
AND NB.RB_AS_1_NUM != 0 ";
            if (START != null && END != null)
                sql += $" AND B.BIRTH BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";

            DataTable 生產數_dt_排除週數 = obs_m.DBExecSQL(sql);
            var 生產數_排除週數 = 生產數_dt_排除週數.AsEnumerable().GroupBy(p => p.Field<string>("FEENO")).Count();
            var 總剖腹產率 = 生產數_dt_排除週數.AsEnumerable().Where(p => (p.Field<string>("BIRTH_TYPE") ?? "") == "1").GroupBy(p => p.Field<string>("FEENO")).Count();
            temp = new ListExport();
            temp.Seq = "57";
            temp.Type = "媽媽";
            temp.Formula = "總剖腹產率";
            temp.Denominator = 生產數_排除週數;
            temp.Molecule = 總剖腹產率;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);


            var 生產數_前胎未剖腹 = 生產數_dt_排除週數.AsEnumerable().Where(p => (p.Field<string>("VBAC") ?? "") != "0").GroupBy(p => p.Field<string>("FEENO")).Count();
            var 初次剖腹產率 = 生產數_dt_排除週數.AsEnumerable().Where(p => (p.Field<string>("BIRTH_TYPE") ?? "") == "1").GroupBy(p => p.Field<string>("FEENO")).Count();
            temp = new ListExport();
            temp.Seq = "58";
            temp.Type = "媽媽";
            temp.Formula = "初次剖腹產率";
            temp.Denominator = 生產數_前胎未剖腹;
            temp.Molecule = 初次剖腹產率;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);
            #endregion

            #region 再次剖腹產率、剖腹產後自然產比率、剖腹產後嘗試自然產成功率
            //modified by chih,20200619
            //            sql = @"SELECT HIS.VBAC, B.BIRTH_TYPE, B.CS_NOTE FROM OBS_BTHHIS HIS, OBS_BTHSTA B
            //WHERE HIS.FEENO = B.FEENO AND B.DELETED IS NULL AND HIS.VBAC != '2'";
            sql = @"SELECT HIS.VBAC, B.BIRTH_TYPE, B.CS_NOTE FROM OBS_BTHHIS HIS, (OBS_BTHSTA B LEFT JOIN OBS_NB R ON R.FEENO = B.FEENO)  
WHERE HIS.FEENO = B.FEENO AND B.DELETED IS NULL AND HIS.VBAC != '2'  AND  R.NB_STAT = '1'  ";

            //end modified by chih,20200619
            if (START != null && END != null)
                sql += $" AND B.BIRTH BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";

            DataTable 生產方式_dt = obs_m.DBExecSQL(sql);

            var 生產方式比率_分母 = 生產方式_dt.AsEnumerable().Count(p =>
            ((p.Field<string>("BIRTH_TYPE") ?? "") == "1" && (p.Field<string>("CS_NOTE") ?? "") == "1") ||
            ((p.Field<string>("BIRTH_TYPE") ?? "") == "0" && (p.Field<string>("VBAC") ?? "") == "0"));

            var 再次剖腹產率 = 生產方式_dt.AsEnumerable().Count(p => ((p.Field<string>("BIRTH_TYPE") ?? "") == "1" && (p.Field<string>("CS_NOTE") ?? "") == "1"));
            temp = new ListExport();
            temp.Seq = "59";
            temp.Type = "媽媽";
            temp.Formula = "再次剖腹產率";
            temp.Denominator = 生產方式比率_分母;
            temp.Molecule = 再次剖腹產率;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            var 剖腹產後自然產比率 = 生產方式_dt.AsEnumerable().Count(p => (p.Field<string>("VBAC") ?? "") == "0");
            temp = new ListExport();
            temp.Seq = "60";
            temp.Type = "媽媽";
            temp.Formula = "剖腹產後自然產比率";
            temp.Denominator = 生產方式比率_分母;
            temp.Molecule = 剖腹產後自然產比率;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            var VBAC有_分母 = 生產方式_dt.AsEnumerable().Count(p => (p.Field<string>("VBAC") ?? "") == "0");
            var 剖腹產後嘗試自然產成功率 = 生產方式_dt.AsEnumerable().Count(p => ((p.Field<string>("BIRTH_TYPE") ?? "") == "0" && (p.Field<string>("VBAC") ?? "") == "0"));
            temp = new ListExport();
            temp.Seq = "61";
            temp.Type = "媽媽";
            temp.Formula = "剖腹產後嘗試自然產成功率";
            temp.Denominator = VBAC有_分母;
            temp.Molecule = 剖腹產後嘗試自然產成功率;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);
            #endregion

            #region 產程中會陰切開比率、產程中會陰四度裂傷發生率
            var 產程中會陰切開比率 = 生產數_dt.AsEnumerable().Where(p => (p.Field<string>("BIRTH_TYPE") ?? "") == "0" &&
            ((p.Field<string>("PERINEUM") ?? "") == "2" || (p.Field<string>("PERINEUM") ?? "") == "3"))
            .GroupBy(p => p.Field<string>("FEENO")).Count();

            temp = new ListExport();
            temp.Seq = "62";
            temp.Type = "媽媽";
            temp.Formula = "產程中會陰切開比率";
            temp.Denominator = 自然產率;
            temp.Molecule = 產程中會陰切開比率;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            var 產程中會陰四度裂傷發生率 = 生產數_dt.AsEnumerable().Where(p => (p.Field<string>("BIRTH_TYPE") ?? "") == "0" &&
            (p.Field<string>("PERI_LAC") ?? "") == "4")
            .GroupBy(p => p.Field<string>("FEENO")).Count();
            temp = new ListExport();
            temp.Seq = "63";
            temp.Type = "媽媽";
            temp.Formula = "產程中會陰四度裂傷發生率";
            temp.Denominator = 自然產率;
            temp.Molecule = 產程中會陰四度裂傷發生率;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);
            #endregion

            #region 陪產、斷臍、無痛分娩
            var 總陪產 = 生產數_dt.AsEnumerable().Where(p => (p.Field<string>("PATERNITY") ?? "") == "1").GroupBy(p => p.Field<string>("FEENO")).Count();
            temp = new ListExport();
            temp.Seq = "64";
            temp.Type = "媽媽";
            temp.Formula = "總陪產";
            temp.Denominator = 生產數;
            temp.Molecule = 總陪產;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            var 自然產陪產 = 生產數_dt.AsEnumerable().Where(p => (p.Field<string>("BIRTH_TYPE") ?? "") == "0" && (p.Field<string>("PATERNITY") ?? "") == "1").GroupBy(p => p.Field<string>("FEENO")).Count();
            temp = new ListExport();
            temp.Seq = "65";
            temp.Type = "媽媽";
            temp.Formula = "自然產陪產";
            temp.Denominator = 自然產率;
            temp.Molecule = 自然產陪產;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            var 斷臍 = 生產數_dt.AsEnumerable().Where(p => (p.Field<string>("CORDCLAMP") ?? "") == "1").GroupBy(p => p.Field<string>("FEENO")).Count();
            temp = new ListExport();
            temp.Seq = "66";
            temp.Type = "媽媽";
            temp.Formula = "斷臍";
            temp.Denominator = 生產數;
            temp.Molecule = 斷臍;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            var 無痛分娩 = 生產數_dt.AsEnumerable().Where(p => (p.Field<string>("EPIDURAL") ?? "") == "1").GroupBy(p => p.Field<string>("FEENO")).Count();
            temp = new ListExport();
            temp.Seq = "67";
            temp.Type = "媽媽";
            temp.Formula = "無痛分娩";
            temp.Denominator = 生產數;
            temp.Molecule = 無痛分娩;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            var 自然產無痛分娩 = 生產數_dt.AsEnumerable().Where(p => (p.Field<string>("BIRTH_TYPE") ?? "") == "0" && (p.Field<string>("EPIDURAL") ?? "") == "1").GroupBy(p => p.Field<string>("FEENO")).Count();
            temp = new ListExport();
            temp.Seq = "68";
            temp.Type = "媽媽";
            temp.Formula = "自然產無痛分娩";
            temp.Denominator = 自然產率;
            temp.Molecule = 自然產無痛分娩;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);
            #endregion

            #region 留臍帶血
            sql = @"SELECT B.CORDBLOOD FROM OBS_BTHSTA B WHERE B.DELETED IS NULL AND B.CORDBLOOD = '1'";
            if (START != null && END != null)
                sql += $" AND B.BIRTH BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";
            DataTable 留臍帶血_dt = obs_m.DBExecSQL(sql);
            var 留臍帶血 = 留臍帶血_dt == null ? 0 : 留臍帶血_dt.Rows.Count;
            temp = new ListExport();
            temp.Seq = "69";
            temp.Type = "媽媽";
            temp.Formula = "留臍帶血";
            temp.Denominator = 1;
            temp.Molecule = 留臍帶血;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);
            #endregion

            #region GBS(乙型鏈球菌)陽性
            sql = @"SELECT HIS.GBS FROM OBS_BTHHIS HIS, OBS_BTHSTA B 
WHERE HIS.FEENO = B.FEENO AND HIS.DELETED IS NULL AND HIS.GBS = '0'";
            if (START != null && END != null)
                sql += $" AND B.BIRTH BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";
            DataTable GBS_乙型鏈球菌_陽性_dt = obs_m.DBExecSQL(sql);
            var GBS_乙型鏈球菌_陽性 = GBS_乙型鏈球菌_陽性_dt == null ? 0 : GBS_乙型鏈球菌_陽性_dt.Rows.Count;
            temp = new ListExport();
            temp.Seq = "70";
            temp.Type = "媽媽";
            temp.Formula = "GBS(乙型鏈球菌)陽性";
            temp.Denominator = 1;
            temp.Molecule = GBS_乙型鏈球菌_陽性;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);
            #endregion

            #region 高危妊娠
            sql = @"SELECT HIS.FEENO FROM OBS_BTHHIS HIS, OBS_BTHSTA B 
WHERE HIS.FEENO = B.FEENO AND HIS.DELETED IS NULL ";
            if (START != null && END != null)
                sql += $" AND B.BIRTH BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";
            DataTable 高危妊娠_dt = obs_m.DBExecSQL(sql);
            var 高危妊娠 = 0;

            高危妊娠_dt.AsEnumerable().ForEach(p =>
            {
                var feeno = p.Field<string>("FEENO") ?? "";
                if (feeno != "")
                {
                    byte[] 高危妊娠_listByteCode = webService.GetBaByPatInfo(feeno);
                    if (高危妊娠_listByteCode == null) { }
                    else
                    {
                        string listJsonArray = CompressTool.DecompressString(高危妊娠_listByteCode);
                        BaByPatInfo_FeeNo[] baByPatInfo = JsonConvert.DeserializeObject<BaByPatInfo_FeeNo[]>(listJsonArray);
                        if (baByPatInfo.FirstOrDefault()?.PATPregnancy == "Y")
                        {
                            高危妊娠 += 1;
                        }
                    }
                }
            });

            temp = new ListExport();
            temp.Seq = "71";
            temp.Type = "媽媽";
            temp.Formula = "高危妊娠";
            temp.Denominator = 1;
            temp.Molecule = 高危妊娠;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);
            #endregion

            #region 自然產新生兒數、剖腹產新生兒數
            sql = @"SELECT NB.FEENO, NB.BIRTH_TYPE FROM OBS_NB NB WHERE DELETED IS NULL";
            if (START != null && END != null)
                sql += $" AND NB.BIRTH_DAY BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";
            DataTable 新生兒數_dt = obs_m.DBExecSQL(sql);

            var 自然產新生兒數 = 新生兒數_dt.AsEnumerable().Count(p => (p.Field<string>("BIRTH_TYPE") ?? "") == "0");
            temp = new ListExport();
            temp.Seq = "72";
            temp.Type = "小孩";
            temp.Formula = "自然產新生兒數";
            temp.Denominator = 1;
            temp.Molecule = 自然產新生兒數;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);

            var 剖腹產新生兒數 = 新生兒數_dt.AsEnumerable().Count(p => (p.Field<string>("BIRTH_TYPE") ?? "") == "1");
            temp = new ListExport();
            temp.Seq = "73";
            temp.Type = "小孩";
            temp.Formula = "剖腹產新生兒數";
            temp.Denominator = 1;
            temp.Molecule = 剖腹產新生兒數;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);
            #endregion

            #region 新生兒產傷發生率、低新生兒生命指數發生率
            sql = @"SELECT BD.BABY_FEE_NO, NB.BIRTH_DAY, NB.NB_CHARTNO, NB.FEENO MOM_FEE_NO, NB.RB_AS_5_NUM, EVT.C_OTHER, EVT.TITLE 
FROM OBS_NB NB, OBS_BABYLINK_DATA BD
LEFT JOIN
(  
SELECT A.*, C_OTHER,TITLE FROM NIS_SPECIAL_EVENT_DATA A, CARERECORD_DATA B 
WHERE A.FEENO = B.FEENO AND A.EVENT_ID = B.CARERECORD_ID AND A.TYPE_ID = '6' 
AND B.TITLE LIKE '%MBD%'
) EVT
ON  BD.BABY_FEE_NO = EVT.FEENO
WHERE NB.FEENO = BD.MOM_FEE_NO AND SUBSTR(NB.NB_TEMPNO,-1,1) = BD.BABY_SEQ AND NB.DELETED IS NULL AND NB.NB_STAT = '1' ";
            if (START != null && END != null)
                sql += $" AND NB.BIRTH_DAY BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";
            DataTable 活產新生兒總人數​_dt = obs_m.DBExecSQL(sql);

            temp = new ListExport();
            temp.Seq = "74";
            temp.Type = "小孩";
            temp.Formula = "新生兒產傷發生率";

            byte[] 產傷兒數_listByteCode = webService.GetTraumaRate(Convert.ToDateTime(START_DAY).ToString("yyyyMMdd"), Convert.ToDateTime(END_DAY).ToString("yyyyMMdd"));
            if (產傷兒數_listByteCode == null) { }
            else
            {
                string listJsonArray = CompressTool.DecompressString(產傷兒數_listByteCode);
                TraumaRate[] traumaRate = JsonConvert.DeserializeObject<TraumaRate[]>(listJsonArray);
                if (traumaRate.Count() > 0)
                {
                    if (traumaRate[0] != null)
                    {
                        temp.Denominator = traumaRate[0].NO_OF_LH;
                        temp.Molecule = traumaRate[0].NO_OF_TRAUMA;
                    }
                    else
                    {
                        temp.Denominator = 1;
                        temp.Molecule = 0;
                    }
                }
            }

            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);

            var 活產新生兒總人數​_分母 = 活產新生兒總人數​_dt == null ? 0 : 活產新生兒總人數​_dt.Rows.Count;
            var 低新生兒生命指數發生率 = 活產新生兒總人數​_dt.AsEnumerable().Count(p => Convert.ToInt32(p.Field<string>("RB_AS_5_NUM")) <= 6);

            temp = new ListExport();
            temp.Seq = "75";
            temp.Type = "小孩";
            temp.Formula = "低新生兒生命指數發生率";
            temp.Denominator = 活產新生兒總人數​_分母;
            temp.Molecule = 低新生兒生命指數發生率;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);
            #endregion

            #region 新生兒入評
            sql = @"SELECT NB_ENTR.FEENO, NB_ENTR.BIRTH, NB_ENTR.WEIGHT, EVT.TITLE FROM (
SELECT ENTR.* , RANK() OVER (PARTITION BY FEENO ORDER BY CREATTIME DESC) SEQ
FROM OBS_NBENTR ENTR 
WHERE ENTR.DELETED IS NULL
) NB_ENTR
LEFT JOIN
(  
SELECT A.*, C_OTHER,TITLE FROM NIS_SPECIAL_EVENT_DATA A, CARERECORD_DATA B 
WHERE A.FEENO = B.FEENO AND A.EVENT_ID = B.CARERECORD_ID AND A.TYPE_ID = '6' 
AND (B.TITLE LIKE '%死亡%' OR  B.TITLE LIKE '%轉院%')
) EVT
ON NB_ENTR.FEENO = EVT.FEENO
WHERE NB_ENTR.SEQ = 1";
            if (START != null && END != null)
                sql += $" AND NB_ENTR.BIRTH BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";
            DataTable 新生兒入評_dt = obs_m.DBExecSQL(sql);

            //20200311  報表中，入評有同chartNO不同feeno的新生兒會算到，影響76-93項
            List<int> removeList = new List<int>();
            新生兒入評_dt.Columns.Add("CHARTNO");
            foreach (DataRow item in 新生兒入評_dt.Rows)
            {
                var t_feeno = item["FEENO"].ToString();
                PatientInfo t_user = Get_Patient_Info(t_feeno);
                if (t_user != null)
                    item["CHARTNO"] = t_user.ChartNo;
            }
            for (int i = 0; i < 新生兒入評_dt.Rows.Count; i++)
            {
                for (int j = 0; j < 新生兒入評_dt.Rows.Count; j++)
                {
                    if (i == j)
                    {
                        continue;
                    }
                    if (新生兒入評_dt.Rows[i]["CHARTNO"].ToString() == 新生兒入評_dt.Rows[j]["CHARTNO"].ToString())
                    {
                        if (string.Compare(新生兒入評_dt.Rows[i]["FEENO"].ToString(), 新生兒入評_dt.Rows[j]["FEENO"].ToString()) > 0)
                        {
                            // i 比 j 大， i不是最小的 ，把 i記下來，準備刪除
                            if (!removeList.Contains(i))
                            {
                                removeList.Add(i);
                            }
                        }
                    }
                }
            }
            for (int i = 新生兒入評_dt.Rows.Count - 1; i >= 0; i--)
            {
                if (removeList.Contains(i))
                {
                    新生兒入評_dt.Rows.RemoveAt(i);
                }
            }
            // end 20200311

            var 直接入院新生兒出生體重500公克的入院人次 = 新生兒入評_dt.AsEnumerable().Count(p => p.Field<decimal>("WEIGHT") < 500);
            temp = new ListExport();
            temp.Seq = "76";
            temp.Type = "小孩";
            temp.Formula = "直接入院新生兒出生體重＜500公克的入院人次";
            temp.Denominator = 1;
            temp.Molecule = 直接入院新生兒出生體重500公克的入院人次;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);

            var 直接入院新生兒出生體重500公克死亡人數 = 新生兒入評_dt.AsEnumerable().Count(p => (p.Field<string>("TITLE") ?? "").Contains("死亡") && p.Field<decimal>("WEIGHT") < 500);
            temp = new ListExport();
            temp.Seq = "77";
            temp.Type = "小孩";
            temp.Formula = "直接入院新生兒(出生體重＜500公克)死亡人數";
            temp.Denominator = 1;
            temp.Molecule = 直接入院新生兒出生體重500公克死亡人數;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);

            var 直接入院新生兒出生體重500公克出生體重749公克入院人次 = 新生兒入評_dt.AsEnumerable().Count(p => p.Field<decimal>("WEIGHT") >= 500 && p.Field<decimal>("WEIGHT") <= 749);
            temp = new ListExport();
            temp.Seq = "78";
            temp.Type = "小孩";
            temp.Formula = "直接入院新生兒(500公克≦出生體重≦749公克)入院人次";
            temp.Denominator = 1;
            temp.Molecule = 直接入院新生兒出生體重500公克出生體重749公克入院人次;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);

            var 直接入院新生兒500公克出生體重749公克死亡人數 = 新生兒入評_dt.AsEnumerable().Count(p => (p.Field<string>("TITLE") ?? "").Contains("死亡") && p.Field<decimal>("WEIGHT") >= 500 && p.Field<decimal>("WEIGHT") <= 749);
            temp = new ListExport();
            temp.Seq = "79";
            temp.Type = "小孩";
            temp.Formula = "直接入院新生兒(500公克≦出生體重≦749公克)死亡人數";
            temp.Denominator = 1;
            temp.Molecule = 直接入院新生兒500公克出生體重749公克死亡人數;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);

            var 直接入院新生兒750公克出生體重999公克入院人次 = 新生兒入評_dt.AsEnumerable().Count(p => p.Field<decimal>("WEIGHT") >= 750 && p.Field<decimal>("WEIGHT") <= 999);
            temp = new ListExport();
            temp.Seq = "80";
            temp.Type = "小孩";
            temp.Formula = "直接入院新生兒(750公克≦出生體重≦999公克)入院人次";
            temp.Denominator = 1;
            temp.Molecule = 直接入院新生兒750公克出生體重999公克入院人次;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);

            var 直接入院新生兒750公克出生體重999公克死亡人數 = 新生兒入評_dt.AsEnumerable().Count(p => (p.Field<string>("TITLE") ?? "").Contains("死亡") && p.Field<decimal>("WEIGHT") >= 750 && p.Field<decimal>("WEIGHT") <= 999);
            temp = new ListExport();
            temp.Seq = "81";
            temp.Type = "小孩";
            temp.Formula = "直接入院新生兒(750公克≦出生體重≦999公克)死亡人數";
            temp.Denominator = 1;
            temp.Molecule = 直接入院新生兒750公克出生體重999公克死亡人數;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);

            var 直接入院新生兒1000公克出生體重1249公克入院人次 = 新生兒入評_dt.AsEnumerable().Count(p => p.Field<decimal>("WEIGHT") >= 1000 && p.Field<decimal>("WEIGHT") <= 1249);
            temp = new ListExport();
            temp.Seq = "82";
            temp.Type = "小孩";
            temp.Formula = "直接入院新生兒(1000公克≦出生體重≦1249公克)入院人次";
            temp.Denominator = 1;
            temp.Molecule = 直接入院新生兒1000公克出生體重1249公克入院人次;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);

            var 直接入院新生兒1000公克出生體重1249公克死亡人數 = 新生兒入評_dt.AsEnumerable().Count(p => (p.Field<string>("TITLE") ?? "").Contains("死亡") && p.Field<decimal>("WEIGHT") >= 1000 && p.Field<decimal>("WEIGHT") <= 1249);
            temp = new ListExport();
            temp.Seq = "83";
            temp.Type = "小孩";
            temp.Formula = "直接入院新生兒(1000公克≦出生體重≦1249公克)死亡人數";
            temp.Denominator = 1;
            temp.Molecule = 直接入院新生兒1000公克出生體重1249公克死亡人數;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);

            var 直接入院新生兒1250公克出生體重1499公克入院人次 = 新生兒入評_dt.AsEnumerable().Count(p => p.Field<decimal>("WEIGHT") >= 1250 && p.Field<decimal>("WEIGHT") <= 1499);
            temp = new ListExport();
            temp.Seq = "84";
            temp.Type = "小孩";
            temp.Formula = "直接入院新生兒(1250公克≦出生體重≦1499公克)入院人次";
            temp.Denominator = 1;
            temp.Molecule = 直接入院新生兒1250公克出生體重1499公克入院人次;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);

            var 直接入院新生兒1250公克出生體重1499公克死亡人數 = 新生兒入評_dt.AsEnumerable().Count(p => (p.Field<string>("TITLE") ?? "").Contains("死亡") && p.Field<decimal>("WEIGHT") >= 1250 && p.Field<decimal>("WEIGHT") <= 1499);
            temp = new ListExport();
            temp.Seq = "85";
            temp.Type = "小孩";
            temp.Formula = "直接入院新生兒(1250公克≦出生體重≦1499公克)死亡人數";
            temp.Denominator = 1;
            temp.Molecule = 直接入院新生兒1250公克出生體重1499公克死亡人數;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);

            var 直接入院新生兒1500公克出生體重1749公克入院人次 = 新生兒入評_dt.AsEnumerable().Count(p => p.Field<decimal>("WEIGHT") >= 1500 && p.Field<decimal>("WEIGHT") <= 1749);
            temp = new ListExport();
            temp.Seq = "86";
            temp.Type = "小孩";
            temp.Formula = "直接入院新生兒(1500公克≦出生體重≦1749公克)入院人次";
            temp.Denominator = 1;
            temp.Molecule = 直接入院新生兒1500公克出生體重1749公克入院人次;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);

            var 直接入院新生兒1500公克出生體重1749公克死亡人數 = 新生兒入評_dt.AsEnumerable().Count(p => (p.Field<string>("TITLE") ?? "").Contains("死亡") && p.Field<decimal>("WEIGHT") >= 1500 && p.Field<decimal>("WEIGHT") <= 1749);
            temp = new ListExport();
            temp.Seq = "87";
            temp.Type = "小孩";
            temp.Formula = "直接入院新生兒(1500公克≦出生體重≦1749公克)死亡人數";
            temp.Denominator = 1;
            temp.Molecule = 直接入院新生兒1500公克出生體重1749公克死亡人數;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);

            var 直接入院新生兒1750公克出生體重1999公克入院人次 = 新生兒入評_dt.AsEnumerable().Count(p => p.Field<decimal>("WEIGHT") >= 1750 && p.Field<decimal>("WEIGHT") <= 1999);
            temp = new ListExport();
            temp.Seq = "88";
            temp.Type = "小孩";
            temp.Formula = "直接入院新生兒(1750公克≦出生體重≦1999公克)入院人次";
            temp.Denominator = 1;
            temp.Molecule = 直接入院新生兒1750公克出生體重1999公克入院人次;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);

            var 直接入院新生兒1750公克出生體重1999公克死亡人數 = 新生兒入評_dt.AsEnumerable().Count(p => (p.Field<string>("TITLE") ?? "").Contains("死亡") && p.Field<decimal>("WEIGHT") >= 1750 && p.Field<decimal>("WEIGHT") <= 1999);
            temp = new ListExport();
            temp.Seq = "89";
            temp.Type = "小孩";
            temp.Formula = "直接入院新生兒(1750公克≦出生體重≦1999公克)死亡人數";
            temp.Denominator = 1;
            temp.Molecule = 直接入院新生兒1750公克出生體重1999公克死亡人數;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);

            var 直接入院新生兒2000公克出生體重2499公克入院人次 = 新生兒入評_dt.AsEnumerable().Count(p => p.Field<decimal>("WEIGHT") >= 2000 && p.Field<decimal>("WEIGHT") <= 2499);
            temp = new ListExport();
            temp.Seq = "90";
            temp.Type = "小孩";
            temp.Formula = "直接入院新生兒(2000公克≦出生體重≦2499公克)入院人次";
            temp.Denominator = 1;
            temp.Molecule = 直接入院新生兒2000公克出生體重2499公克入院人次;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);

            var 直接入院新生兒2000公克出生體重2499公克死亡人數 = 新生兒入評_dt.AsEnumerable().Count(p => (p.Field<string>("TITLE") ?? "").Contains("死亡") && p.Field<decimal>("WEIGHT") >= 2000 && p.Field<decimal>("WEIGHT") <= 2499);
            temp = new ListExport();
            temp.Seq = "91";
            temp.Type = "小孩";
            temp.Formula = "直接入院新生兒(2000公克≦出生體重≦2499公克)死亡人數";
            temp.Denominator = 1;
            temp.Molecule = 直接入院新生兒2000公克出生體重2499公克死亡人數;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);

            var 直接入院新生兒出生體重2500公克入院人次 = 新生兒入評_dt.AsEnumerable().Count(p => p.Field<decimal>("WEIGHT") >= 2500);
            temp = new ListExport();
            temp.Seq = "92";
            temp.Type = "小孩";
            temp.Formula = "直接入院新生兒(出生體重≧2500公克)入院人次";
            temp.Denominator = 1;
            temp.Molecule = 直接入院新生兒出生體重2500公克入院人次;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);

            var 直接入院新生兒出生體重2500公克死亡人數 = 新生兒入評_dt.AsEnumerable().Count(p => (p.Field<string>("TITLE") ?? "").Contains("死亡") && p.Field<decimal>("WEIGHT") >= 2500);
            temp = new ListExport();
            temp.Seq = "93";
            temp.Type = "小孩";
            temp.Formula = "直接入院新生兒(出生體重≧2500公克)死亡人數";
            temp.Denominator = 1;
            temp.Molecule = 直接入院新生兒出生體重2500公克死亡人數;
            temp.Result = temp.Denominator == 0 ? "0" : (temp.Molecule / temp.Denominator).ToString();
            data.Add(temp);
            #endregion

            #region 他院轉入(新生兒死亡率)
            sql = @"SELECT * FROM (
SELECT RANK() OVER (PARTITION BY A.FEENO ORDER BY RECORDTIME DESC) SEQ, EVT.C_OTHER, EVT.TITLE, A.* from (
SELECT FEENO, '新生兒' AS Type, BIRTH,  FROM_WHERE, RECORDTIME FROM OBS_NBENTR NB
WHERE DELETED IS NULL AND FROM_WHERE = '2'
UNION select FEENO, '嬰幼兒' AS Type, BIRTH, FROM_WHERE, RECORDTIME FROM OBS_BABYENTR BABY
WHERE  DELETED IS NULL AND FROM_WHERE = '3') A
LEFT JOIN
(  
SELECT A.*, C_OTHER,TITLE FROM NIS_SPECIAL_EVENT_DATA A, CARERECORD_DATA B 
WHERE A.FEENO = B.FEENO AND A.EVENT_ID = B.CARERECORD_ID AND A.TYPE_ID = '6' 
AND (B.TITLE = '死亡')
) EVT
ON A.FEENO = EVT.FEENO) R WHERE SEQ = 1";
            if (START != null && END != null)
                sql += $" AND R.BIRTH BETWEEN TO_DATE('{START.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') AND TO_DATE('{END.Value.ToString("yyyy-MM-dd HH:mm:ss")}', 'YYYY-MM-DD HH24:MI:SS') ";
            DataTable 入評_他院轉入_dt = obs_m.DBExecSQL(sql);

            var 入評_他院轉入_分母 = 入評_他院轉入_dt == null ? 0 : 入評_他院轉入_dt.Rows.Count;
            var 入評_他院轉入_死亡 = 入評_他院轉入_dt.AsEnumerable().Count(p => (p.Field<string>("TITLE") ?? "").Contains("死亡"));

            temp = new ListExport();
            temp.Seq = "94";
            temp.Type = "小孩";
            temp.Formula = "他院轉入(新生兒死亡率)";
            temp.Denominator = 入評_他院轉入_分母;
            temp.Molecule = 入評_他院轉入_死亡;
            temp.Result = temp.Denominator == 0 ? "0.00%" : String.Format("{0:0.00%}", temp.Molecule / (float)temp.Denominator);
            data.Add(temp);
            #endregion


            //20200331 modified
            //ObstetricsHelper.Export(data, "產嬰總表");
            ObstetricsHelper.Export(data, "產嬰總表", string.Format("產嬰總表({0}-{1})", START.Value.ToString("yyyy/MM/dd"), END.Value.ToString("yyyy/MM/dd")));
        }
        #endregion


    }
}
