@using NIS.Data;
@using NIS.Models;
@using System.Data;
@{
    List<UdOrder> LongList = (List<UdOrder>)ViewBag.LongList;
    List<UdOrder> PRNList = (List<UdOrder>)ViewBag.PRNList;
    List<UdOrder> StatList = (List<UdOrder>)ViewBag.StatList;
    List<UdOrder> IVList = (List<UdOrder>)ViewBag.IVList;

    DataTable LongDt = (DataTable)ViewBag.LongDt;
    DataTable PRNDt = (DataTable)ViewBag.PRNDt;
    DataTable StatDt = (DataTable)ViewBag.StatDt;
    DataTable IVDt = (DataTable)ViewBag.IVDt;
    CommonMedication cm = new CommonMedication();

    int LongUnExec = 0, PRNUnExec = 0, StatUnExec = 0, IVUnExec = 0;
    double TotalDose = 0, UseDose = 0;

    DateTime MustTime = DateTime.Now.AddHours(-1);
    DateTime EarlyTime = DateTime.Now.AddHours(+1);

    string pStartDate = ViewBag.pStartDate;
    string InsulinLastPosition = ViewBag.InsulinLastPosition;
    //日期選擇器，鎖定時間
    NIS.Data.PatientInfo pf = (NIS.Data.PatientInfo)Session["PatInfo"];
    NIS.Data.Complement_List complement_List = (NIS.Data.Complement_List)Session["Complement_List"];

    bool IsDischarged = false;
    if (Convert.ToDateTime(pf.OutDate).ToString("yyyy").ToString() != "0001" && pf.OutDate < DateTime.Now)
    {
        IsDischarged = true;
    }
}
<link rel="Stylesheet" type="text/css" href="~/Content/StyleSheet/ExecMed.css" />
<style type="text/css">
    /*頁籤的css，暫放*/
    .ui-tabs .ui-tabs-nav li a {
        font-size: 16px;
        padding: 3px 5px 3px 5px;
    }

    .ui-tabs {
        font-size: 16px;
    }

    .hide {
        display: none;
    }

    /*-----數字按鈕的css*/
    .WhiteBox, .RedBox, .WhiteEarlyBox, .White24Box {
        border: solid 2px #000;
        cursor: pointer;
    }

    .NumberBoxCSS, .NumberBoxCSS_SEL, .WhiteBox, .BlueBox, .RedBox, .WhiteEarlyBox, .White24Box, .OverDCDateBox {
        width: 20px;
        height: 16px;
        margin: 5px 5px 5px 5px;
        -moz-box-shadow: 4px 4px 3px 1px rgba(20%,20%,40%,0.5),1px 1px 1px 1px rgba(20%,20%,40%,0.1);
        -webkit-box-shadow: 4px 4px 3px 1px rgba(20%,20%,40%,0.5),1px 1px 1px 1px rgba(20%,20%,40%,0.1);
        box-shadow: 4px 4px 3px 1px rgba(20%,20%,40%,0.5),1px 1px 1px 1px rgba(20%,20%,40%,0.1);
        word-break: break-all;
        font-weight: bold;
        text-align: center;
        display: inline-block;
    }

    /*無框白*/
    .NumberBoxCSS {
        background-color: #fff;
    }

    /*無框綠*/
    .NumberBoxCSS_SEL {
        background-color: #6AA84F;
    }

    /*有框白, 提早, PRN & IV, 正常也要跳註記*/
    .WhiteBox, .WhiteEarlyBox, .White24Box, .WhiteJumpBox {
        background-color: #fff;
    }

    /*無框藍*/
    .BlueBox {
        background-color: #2B78E4;
    }

    /*有框紅*/
    .RedBox {
        background-color: #CC0000;
    }

    /*無框灰*/
    .OverDCDateBox {
        /*20160906 mod by yungchen 減一小時若開始時間為13:10 則13的格子還是要可以點 並改為白底*/
        /*background-color: #808080;*/
        background-color: #fff;
    }
    /*-----*/

    #sys_Block {
        position: fixed;
        top: 0px;
        right: 0px;
        bottom: 0px;
        left: 0px;
        z-index: 1000;
        background-color: #666;
        /* other browsers */
        opacity: 0.65;
        /* this works in IE6, IE7, and IE8 */
        filter: alpha(opacity=65);
        /* this works in IE8 only */
        display: none;
    }

    #sys_Loading {
        position: fixed;
        text-align: center;
        left: 50%;
        top: 50%;
        height: 50px;
        width: 200px;
        margin-top: -25px;
        margin-left: -100px;
        _position: absolute;
        color: #040FD9;
        font-weight: bold;
        z-index: 1001;
        display: none;
    }
</style>
<script type="text/javascript">
    var num
    var ckname
    var Med_ExecList
    var Med_DcList

    $(document).ready(function () {
        close_pup_window();

        $(window).resize(function () {
            if ($(this).outerHeight() <= 50) {
                $(".dataArea").outerHeight(400);
            }
            else {
                $(".dataArea").outerHeight($(this).outerHeight() - 100);
            }
        }).trigger("resize");

        $("input[name=med_type]").click(function () {
            $(".MedListSTAT, .MedListREG, .MedListPRN, .MedListIV").hide();
            $($(this).val()).show();
        });

        $("#udodrgcode").keypress(function (e) {
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) { //Enter keycode
                if (Trim($("#udodrgcode").val().toString()) == "") {
                    alert("藥包條碼錯誤！");
                    return false;
                }
                else
                    MedicinalInfo_barcode($(this).val());
            }
        });

        //病歷號 ENTER
        $("#PatientNo").keypress(function (e) {
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) { //Enter keycode
                if (Trim($("#PatientNo").val().toString()) == "") {
                    alert("查無此病歷號，請重新確認。");
                    return false;
                }
                else {
                    if (Trim($("#PatientNo").val().toString()) != null) {
                        $.ajax({
                            type: 'POST',
                            url: "../Main/WebS_InHistory",
                            data: "str_Barcode=" + Trim($("#PatientNo").val().toString()),
                            success: function (data) {
                                if (data == "Error")
                                    alert("查無此病歷號，請重新確認。");
                                else if (data != "NotInIpd") {
                                    $.ajax({
                                        url: "../Main/SetPatient", timeout: 5000, type: "post",
                                        data: "fee_no=" + data,
                                        success: function () {
                                            window.parent.parent.GetPtInfoArea();
                                            window.parent.parent.readMqList();
                                            window.parent.parent.hasPat = "Y";
                                        },
                                        complete: function () {
                                            window.parent.parent.ReloadModule('M01');
                                        }
                                    });
                                }
                            },
                            error: function (data) {
                                alert("查無此病歷號，請重新確認。");
                            }
                        });
                    }
                }
            }
        });

        $("#txtpwd").keypress(function (e) {
            var code = (e.keyCode ? e.keyCode : e.which);
            if (code == 13) { //Enter keycode
                DouCheck('ok');
            }
        });
        @if (Request["message"] != null)
        {
            @Html.Raw("showHint(\"" + Request["message"].ToString() + "\");")
        }

        $("#udodrgcode").focus();
    });

    function rinput(type) {
        $("#type_early,#type_delay,#type_overtime,#type_notyet").css("display", "none");
        $(".TableNote,#type_other").css("display", "inline");
        $("#" + type).fadeIn(500);
    }

    function hidePopup(id) {
        $("#" + id).fadeOut(200);
    }

    function showPopup(id, flag, type, num) {
        $("#block").show();
        if (id == "dv_type") {
            if ($("#bad_" + num).attr("code") == "Y") {
                $("#badtype[value=Y]").click();
            }
            else if ($("#bad_" + num).attr("code") == "N") {
                $("#badtype[value=N]").click();
            }
            $("#badreaction").val($("#bad_" + num).val());
            $("#textname").val(flag);
            $("#other1").val($("#reason_" + num).val());
            $("#injection_execution1,#injection_execution2,#injection_execution3,#injection_execution4").attr("checked", false);
            $("#injection_execution1,#injection_execution2,#injection_execution3,#injection_execution4").css("display", "inline");
            $(".TableNote,#type_other").css("display", "none");
            if (type == "S") {
                $("#injection_execution1").click();
                $("#injection_execution2,#injection_execution3,#injection_execution4").css("display", "none");
                $(".TableNote,#type_other").css("display", "inline");
            }
            if (type == "P") {
                $("#injection_execution1,#injection_execution2,#injection_execution3,#injection_execution4").css("display", "none");
                $(".TableNote,#type_other").css("display", "none");
            }
            if (type == "P1") {
                $("#injection_execution2").click();
                $("#injection_execution1,#injection_execution3,#injection_execution4").css("display", "none");
                $(".TableNote,#type_other").css("display", "inline");
            }
            if ($("#ck_" + num).attr("position") != "") {
                $("#p_position").css("display", "inline");
                $("#Position_List option[value=" + $("#position_" + num).val() + "]").attr('selected', true);
                //20140423 總劑量隱藏
                $("#showtotaldose").css("display", "inline");
            }
            else {
                $("#p_position").css("display", "none");
                $("#showtotaldose").css("display", "none");
            }

            if ($("#reasontype_" + num).val() != "") {
                $("#injection_execution" + $("#reasontype_" + num).val()).click();

            }
            if (flag == "B")
                $("#p_position").css("display", "none");
        }
        if (id == "div_login") {
            $("#checker").attr("name", num);
            $("#txtid").val("");
            $("#txtpwd").val("");
        }
        $("#" + id).center().fadeIn(200);
    }

    function get_DOSE(amount, unit, idname) {
        $("#amount").val($("#moddose_" + idname).val());
        $("#unit").val(unit);
        $("#Sliding_unit").val(unit);
        $("#name").val(idname); //i流水號
        // 20140423 新增總劑量單位
        $("#totaldoseunit").text(unit);
        plustotalunit();
    }

    function plustotalunit() {
        var totalamount = parseInt($("#Sliding_dose").val()) + parseInt($("#amount").val());
        $("#totaldose").text(totalamount);
    }

    function get_DOSE_all(text) {
        $("#textname").val("all");
    }

    function reason(result, i) {
        id = $("#name").val();
        name = $("#name").val();

        var textname = $("#textname");
        if (typeof (textname) !== "undefined")
            textname = $(textname).val();

        var other = $("#other1");
        if (typeof (other) !== "undefined")
            other = $(other).val();

        var badreaction = $("#badreaction");
        if (typeof (badreaction) !== "undefined")
            badreaction = $(badreaction).val();

        var rd = $('input:radio[name=injection_execution]:checked').val();
        if (typeof (rd) == "undefined")
            rd = "";

        $("#reasontype_" + id).val(rd);
        $("#moddose_" + id).val($("#amount").val());                        //修改劑量
        $("#checker_" + id).val($("#checker").val());                       //覆核人員
        $("#bad_" + id).attr("value", $("#badreaction").val());             //不良反應
        $("#bad_" + id).attr("code", $("input:radio[name=baditems]:checked").val());
        $("#ss_drugname_" + id).val($("#Sliding_List option:selected").text());
        $("#ss_dose_" + id).val($("#Sliding_dose").val());
        $("#position_" + id).val($("#Position_List").val());

        if ($("#Sliding_dose").val() == "" && $("#Sliding_List option:selected").text() != "請選擇") {
            alert("Sliding Scale 劑量未填寫！");
            return false;
        }

        if ($("#bad_" + id).attr("code") == "Y" && $("#bad_" + id).val() == "") {
            alert("不良反應填'有'，需說明。");
            return;
        }

        if (result == 'textbox' && i == "Z" && rd != "" && $("#other1").val() == "") {
            if ($("#udcir_" + id).val() != "STAT") {
                alert("執行原因未點選(填寫)");
                return;
            }
        }

        text = "";
        //單次備註 A amount
        if (textname == 'A') {
            if ($("#bad_" + id).attr("code") == "Y")
                nogood = "" + $("#bad_" + id).val();
            else
                nogood = "";
            if (result == 'textbox') {
                if (nogood != "") { $("#txt_" + id).text($("#other1").val() + " 不良反應:" + nogood) }
                else { $("#txt_" + id).text($("#other1").val()) }
                if ($("#udcir_" + id).val() == "STAT" && $("#other1").val() == "")
                { $("#reasontype_" + id).val(""); }
                $("#reason_" + id).val($("#other1").val()); //原因內容
            }
            else {
                if (nogood != "") { $("#txt_" + id).text(result + " 不良反應:" + nogood) }
                else { $("#txt_" + id).text(result) }
                $("#reason_" + id).val(result); //原因內容
            }
            var ck_part = document.getElementById("ck_" + id);
            if (ck_part.checked == false)
                ck_part.checked = true;

            if ((i == "B" || rd == '3') && $("#reasontype_" + id).attr("check") == "") {
                $("#ck_" + id).css("display", "none");
                $("#ordstatus_" + id).val("2"); //是否勾選 0:true,1:false,2:註記
            }
            else {
                $("#ck_" + id).css("display", "inline");
                $("#ordstatus_" + id).val("0"); //是否勾選
            }
        }
        else {
            //批次備註 B
            nogood = $("input:radio[name=baditems]:checked").val();
            if (nogood != "Y" && nogood != "N")
                nogood = "";
            var iii = "";
            var index = 0;
            var $checker = $("#checker").val(); //覆核人員
            var $badreaction = $("#badreaction").val(); // 藥物不良反應
            var $nogood = $("#other1").val()//藥物不良反應 //原因內容
            $("div[name='MedListREG']").find("input[type=checkbox]").each(function (g) {
                if ($(this).attr("position") == "") {
                    index = $(this).attr("index");
                    $(this).attr("checked", true);
                    $("#reasontype_" + index).val(rd);

                    if (i == "B" || rd == "3")
                        $("#ordstatus_" + index).val("2"); //是否勾選 0:true,1:false,2:註記
                    else {
                        $("#ck_" + id).attr("checked", true);
                        $("#ordstatus_" + index).val("0"); //是否勾選
                    }

                    $("#checker_" + index).val($checker); //覆核人員
                    $("#bad_" + index).val($badreaction);
                    $("#bad_" + index).attr("code", $("input:radio[name=baditems]:checked").val());

                    if (result == 'textbox') {
                        if (nogood == "Y")
                            $("#txt_" + index).text($nogood + " 不良反應:" + nogood);
                        else
                            $("#txt_" + index).text($nogood);
                        $("#reason_" + index).val($nogood); //原因內容
                    }
                    else {
                        if (nogood == "Y")
                            $("#txt_" + index).text(result + " 不良反應:" + nogood);
                        else
                            $("#txt_" + index).text(result);
                        $("#reason_" + index).val(result); //原因內容
                    }
                }
            });
            $("#textname").val("");
            $("#name").val("");
        }
        $("input[name=baditems]").attr("checked", false);
        $("#block").hide();
        $('#dv_type').fadeOut(500);
        $("#udodrgcode").focus();
    }

    function DouCheck(flag) {
        if (flag == "ok") {
            $.ajax({
                type: 'POST',
                url: "DoubleLogin",
                async: false ,
                data: { id: $('#txtid').val(), pw: $('#txtpwd').val() },
                success: function (data) {
                    if (data == 'error') {
                        alert("帳號或密碼錯誤1！");
                    }
                    else if (data == "iderr") {
                        alert("登入者不得與覆核者同一人！");
                    }
                    else {
                        // $("#l_checker").text("覆核者：" + data);
                        $("#checker_id").val($('#txtid').val());
                        $("#checker").val(data);
                        //$("#checker_" + $("#checker").attr("name")).val(data);
                        //$("#checkerid_" + $("#checker").attr("name")).val($('#txtid').val());
                        // alert("覆核者：" + data);
                        $("#checktype").val('C')//覆核通過
                        UpdateRemark();
                        //$("#block").hide();
                        ////$('#div_login').fadeOut(0);
                        //// $('#checker_show').show();
                        ////$('#Remarks').fadeIn(0);
                    }
                },
                error: function (data) {
                    alert("帳號或密碼錯誤！");
                    //$("#block").hide();
                    //$('#div_login').fadeOut(300);
                }
            });
        }
        else {

            $("#ck_" + $("#checker").attr("name")).attr("checked", false);
            $('#ordstatus_' + $("#checker").attr("name")).val("1");
            $("#block").hide();
            $('#div_login').fadeOut(0);
            $('#Remarks').fadeIn(0);
        }
    }

    function fatherHello(ckname, id) {
        if (ckname != "") {
            $("#checker").val(ckname);
            alert("覆核者為:" + ckname);
        }
        else {
            $("#ck_" + id).click();
            alert("帳號或密碼錯誤");
        }
    }

    function doit(id) {
        $("#execflag").val(id)
        return true;
        //quiry = 查詢
        //quiryAll = 查詢所有待執行醫囑
        //ckin = 覆核 按紐
        //OK = 完成
        //over = 結束
    }

    function cc() {
        $("#block").hide();
        $("#bad_" + $("#name").val()).attr("code", "N");
        $("#txt_" + $("#name").val()).text("");
        $("#reasontype_" + $("#name").val()).val("");
        $("#textname").val("");
        $("#name").val("");
        $("#medmessage").text("");
        $("#udodrgcode").focus();
    }

    function MedicinalInfo(strMedCode, strInfo) {
        //SHOW 藥品圖片
        var str_tr, str_th, str_th1;
        $.ajax({
            type: 'POST',
            url: "WebS_MedicinalInfo",
            data: "Str_MedCode=" + Trim(strMedCode),
            success: function (data) {
                if (data == "Error") {
                    alert("錯誤！無法找到線上處方集資料。");
                    return;
                }
                var obj = $.parseJSON(data);
                if (strInfo == "img" && obj.length > 0)
                    new_window.push(window.open(obj[0].DrugHref));
                else {
                    $("#l_src").attr("src", obj[0].DrugPicPath);
                    $("#l_drugname").text("藥品名稱：" + obj[0].DrugName);
                    if (Med_DcList == null) {
                        $("#l_dose").text(" 劑量：" + $("#moddose_" + strInfo).val() + " " + $("#moddose_" + strInfo).attr("unit"));
                        $("#l_cir").text("頻次：" + $("#udcir_" + strInfo).val());
                    }
                    $("#l_effect").text("作用：" + obj[0].DrugEffects);
                    $("#l_sideeffect").text("副作用：" + obj[0].DrugSideEffects);

                    var img = new Image();
                    img.src = obj[0].DrugPicPath;
                    var tmpheight = Math.ceil(300 / img.width * img.height);
                    var tmpwidth = Math.ceil(300 / img.height * img.width);
                    if (img.height > img.width)
                        $("#l_src").css({ 'height': "300px", 'width': tmpwidth });
                    else
                        $("#l_src").css({ 'height': tmpheight, 'width': "300px" });

                    showPopup('div_Med', 'A', '', '');
                    $("#div_Med").focus();
                    $("input[name='div_med_ok']").show();
                    $("input[name='div_med_cancel']").val('取消');
                }
            },
            error: function (data) {
                alert("錯誤！無法找到線上處方集資料。");
            }
        });
    }

    function MedicinalInfo_barcode(strBarcode) {
        //依藥品條碼找對應藥品
        var strMedCode = "";
        var id = "";
        Med_DcList = null;
        if (strBarcode.length == 18) {
            $.ajax({
                type: 'POST',
                url: "Med_Bacrcode",
                data: "str_Barcode=" + Trim(strBarcode),
                success: function (data) {
                    Med_ExecList = $.parseJSON(data);
                    if (Med_ExecList.length > 0) {
                        for (var i = 0; i <= Med_ExecList.length - 1; i++)
                            strMedCode += Med_ExecList[i].med_code + "','";
                        MedicinalInfo_Click("");
                    }
                    else
                        alert("非正確餐包藥包條碼！請重新確認。");
                },
                error: function (data) {
                    alert("Web Service 執行失敗，請洽資訊室。");
                }
            });
        }
        else {
            //種包條碼
            var pass_flag = false;
            $(".dataArea").find("input:checkbox[name=" + strBarcode + "]").each(function (i) {
                id = $(this).attr("index");
                strMedCode = $("#medcode_" + id).val();
                pass_flag = true;
                return false;
            });

            if (!pass_flag) {
                //找是否有DC重開
                $.ajax({
                    type: 'POST',
                    url: "WebS_MedOrderRenew",
                    data: "str_Barcode=" + Trim(strBarcode),
                    success: function (data) {
                        if (data != "Error") {
                            Med_DcList = $.parseJSON(data);
                            $(".dataArea").find("input:checkbox[name=" + Med_DcList[0].UDSEQ + "]").each(function (i) {
                                id = $(this).attr("index");
                                strMedCode = $("#medcode_" + id).val();
                                pass_flag = true;
                                $("#medmessage").text("原藥物已DC，新的醫囑藥物如下：");
                                $("#medmessage").css("display", "inline");
                                $("#udodrgcode").val(Med_DcList[0].UDSEQ);
                                var str1 = "";
                                if (Med_DcList[0].UD_DOSE != Med_DcList[0].UD_DOSE_O || Med_DcList[0].UD_UNIT != Med_DcList[0].UD_UNIT_O) {
                                    str1 = " -> " + Med_DcList[0].UD_DOSE + " " + Med_DcList[0].UD_UNIT;
                                    $("#l_dose").css("background", "yellow");
                                }
                                $("#l_dose").text(" 劑量：" + Med_DcList[0].UD_DOSE_O + " " + Med_DcList[0].UD_UNIT_O + str1);
                                str1 = "";
                                if (Med_DcList[0].UD_CIR != Med_DcList[0].UD_CIR_O) {
                                    str1 = " -> " + Med_DcList[0].UD_CIR;
                                    $("#l_cir").css("background", "yellow");
                                }
                                $("#l_cir").text("頻次：" + Med_DcList[0].UD_CIR_O + str1);
                                return false;
                            })

                            if (pass_flag == false)
                                alert("非正確種包藥包條碼！請重新確認。");
                            else
                                MedicinalInfo(strMedCode, id);
                        }
                        else
                            alert("非正確種包藥包條碼！請重新確認。");
                    },
                    error: function (data) {
                        alert("Web Service 執行失敗，請洽資訊室。");
                    }
                });
            }
            else
                MedicinalInfo(strMedCode, id);
        }
    }

    function MedicinalInfo_Click(strBarcode) {
        //勾選給藥時間點
        strBarcode = Trim($("#udodrgcode").val().toString());
        var strMedCode = "", strMedCode1 = "", strMedTime = "", strUdSeq = "";
        var colnum = 0;
        if (strBarcode.length == 18) {
            //找餐包符合時間點藥品(不勾選)
            for (var i = 0; i <= Med_ExecList.length - 1; i++) {
                strMedCode = Med_ExecList[i].med_code;
                if (Med_ExecList[i].ud_seq_new == "")
                    strUdSeq = Med_ExecList[i].ud_seq_new;
                else
                    strUdSeq = Med_ExecList[i].ud_seq;
                strMedCode1 += strMedCode + "','";
                strMedTime = Med_ExecList[i].med_time.substr(8, 2) + ":" + Med_ExecList[i].med_time.substr(10, 2);
                $("div[name='MedListREG']").find("input[type=checkbox]").each(function (i) {
                    if ($(this).attr("name") == strUdSeq && $(this).val() == strMedTime) {
                        colnum++;
                    }
                });
            }

            if (colnum < Med_ExecList.length)
                pup_window("Med_Info?id=" + strBarcode + "&flag=false");
            else
                pup_window("Med_Info?id=" + strBarcode + "&flag=true");
        }
        else {
            var checkflag = false;
            //找餐包符合時間點藥品(勾選)
            $(".dataArea").find("input:checkbox[name=" + strBarcode + "]").each(function (i) {
                $("input:checkbox[name=" + strBarcode + "]").last().attr("checked", false);
                $("input:checkbox[name=" + strBarcode + "]").last().click();
                checkflag = true;
                $("#udodrgcode").val("");
                return false;
            });
            if (!checkflag) {
                alert("非正確藥包[種包]條碼，請確認！")
                $("#udordercode").focus();
            }
            $("#block").hide();
        }
        $("#medmessage").text("");
        $("#udodrgcode").focus();
    }

    function pup_window(url) {
        new_window.push(window.open(url, "top_dialog", "menubar=no,status=no,scrollbars=yes,top=0,resizable=yes,left=200,toolbar=no,width=900,height=600"));
    }

    function checkbox(i, type) {
        if (document.getElementById('ck_' + i).checked) {
            $("#ordstatus_" + i).val("0");
            $("#amount").val($("#moddose_" + i).val());
            $("#unit").val($("#moddose_" + i).attr("unit"));
            if ($("#ck_" + i).attr("doucheck") == "Y") {
                if ($("#checker").val() == "") {
                    showPopup('div_login', '', type, i);
                    $("#ck_" + i).attr("checked", false);
                    $("#txtid").focus();
                    return false;
                }
                else {
                    $("#checker_" + i).val($("#checker").val());
                    $("#checkerid_" + i).val($('#txtid').val());
                }
            }

            if ($("#udodrgcode").val().length != 18) {
                if (($("#ck_" + i).attr("checkt") == "spanB" || $("#ck_" + i).attr("checkt") == "spanB2") && Trim($("#reasontype_" + i).val()) == "") {
                    $("#ck_" + i).attr("checked", false);
                    $("#name").val(i);
                    showPopup('dv_type', 'A', type, i);
                }
            }

            if ($("#ck_" + i).attr("doucheck") == "S") {
                if ($("#bad_" + i).attr("code") == "") {
                    alert("此藥物 " + $("#medcode_" + i).attr("meddesc") + " 需填不良反應註記。")
                    $("#name").val(i);
                    showPopup('dv_type', 'A', type, i);
                }
            }

            if (type == "P") {
                var ls_cir = $("#udcir_" + i).val().replace(" ", "");
                if ((ls_cir == "Q2HPRN" || ls_cir == "Q12HPRN" || ls_cir == "Q4HPRN" || ls_cir == "Q6HPRN" || ls_cir == "Q8HPRN") && $("#udcir_" + i).attr("LASTEXEC") != "") {
                    var cal_min = parseInt(ls_cir.replace("Q", "").replace("HPRN", "")) * 60;
                    var diff_min = Math.floor((new Date() - new Date($("#udcir_" + i).attr("LASTEXEC"))) / (60 * 1000));
                    if (cal_min > diff_min) {
                        if (confirm("尚未到下次給藥時間，是否要提前給藥？")) {
                            $("#name").val(i)
                            showPopup('dv_type', 'A', 'P1', i);
                        }
                    }
                }
            }
        }
        else
            $('#ordstatus_' + i).val("1");
    }

    function check_point(text) {
        //完成時，檢核勾選項目是否在時間點內給藥
        var passa = false;
        var checkin = true;
        $(".MedListREG").find("input[type=checkbox]:checked").each(function (i) {
            var id = $(this).attr("index");
            var check = $(this).attr("doucheck");
            if (($(this).attr("checkt") == "spanB" || $(this).attr("checkt") == "spanB2" || $("#ordstatus_" + id).val() == "2") && $("#reasontype_" + id).val() == "") {
                alert($("#medcode_" + id).attr("meddesc") + " 未在給藥時間，請填選註記。");
                checkin = false;
            }
            else if (check == "S" && $("#bad_" + id).attr("code") == "Y" && $("bad_" + id).val() == "") {
                alert($("#medcode_" + id).attr("meddesc") + " 為特殊藥品，需填不良反應。");
                checkin = false;
            }
            else if (check == "Y" && Trim($("#checker_" + id).val()) == "") {
                alert($("#medcode_" + id).attr("meddesc") + " 為高危藥品，需雙人覆核。");
                checkin = false;
            }
            else
                passa = true;
        });

        $(".MedListSTAT,.MedListPRN,.MedListIV").find("input[type=checkbox]:checked:visible").each(function (i) {
            var id = $(this).attr("index");
            var check = $(this).attr("doucheck");
            if (check == "S" && $("#bad_" + id).attr("code") == "Y" && $("#bad_" + id).val() == "") {
                alert($("#medcode_" + id).attr("meddesc") + " 為特殊藥品，需填不良反應。");
                checkin = false;
            }
            else if (check == "Y" && $("#checker_").val() == "") {
                alert($("#medcode_" + id).attr("meddesc") + " 為高危藥品，需雙人覆核。");
                checkin = false;
            }
            else {
                $("#drug_date_" + id).val($("#prn_date" + id).val() + ' ' + $("#prn_time" + id).val());
                passa = true;
            }
        });

        if (passa) {
            $("#execflag").val("submit");
            $("#l_save").text("Saving...");
            tosubmit('A');
        }
        else {
            if (checkin)
                alert("尚未勾選給藥時間點！");
            $("#block,#saving").hide();
        }
    }

    function CancelBarcode(str1) {
        var count = 0;
        var checklist = str1.split(",");
        var strMedTime = checklist[1].toString();
        var strMedDate = checklist[0].toString();
        for (var x = 2; x <= checklist.length - 1; x++) {
            $("div[name='MedListREG']").find("input[type=checkbox]").each(function (i) {
                if ($(this).attr("name") == checklist[x].toString() && $(this).attr("date1") == strMedDate && $(this).val() == strMedTime) {
                    $("#execflag").val("checkReason");
                    $(this).attr("checked", false);
                    count++;
                }
            });
        }
        if (count != checklist.length - 2) {
            alert("此藥包[餐包]條碼藥品數量 與 藥品給藥時間點不符，請確認！");
            return false;
        }
        for (var x = 2; x <= checklist.length - 1; x++) {
            $("div[name='MedListREG']").find("input[type=checkbox]").each(function (i) {
                if ($(this).attr("name") == checklist[x].toString() && $(this).attr("date1") == strMedDate && $(this).val() == strMedTime)
                    $(this).click();
            });
        }
        $("#udodrgcode").val("");
    }

    function badreaction(flag) {
        if (flag == "Y")
            $("#badreaction").css("display", "inline");
        else
            $("#badreaction").css("display", "none");
    }

    function IV_Label_Print(id, feeno) {
        $.ajax({
            type: 'POST',
            url: "IV_Label_Print",
            data: {
                ud_seq: $('#ck_' + id).attr('name'), fee_no: feeno, med_code: $('#medcode_' + id).attr('meddesc'), use_dose: $('#moddose_' + id).val(),
                use_unit: $('#moddose_' + id).attr('unit'), cost_code: $('#ck_' + id).attr('costcode'), flow_speed: $('#ck_' + id).attr('flow_speed')
            },
            success: function (data) {
                if (data == 'error')
                    showHint("點滴標籤產生失敗");
                else
                    showHint("點滴標籤產生中，稍後即將列印。");
            },
            error: function (data) {
                showHint("點滴標籤產生失敗，請洽資訊室");
            }
        });
    }

    function slidingselect() {
        $('#Sliding_dose').val($('#Sliding_List').val());
    }

    function tosubmit(flag) {
        if (flag == 'A') {
            $('#form_med').attr("action", "Med_NurseExecuteCheckList");
            $('#form_med').attr("target", "finalcheck");
            $('#form_med').attr("onsubmit", "new_window.push(window.open('','finalcheck','width=900,height=600'));");
            $("form").submit();
        }
        else {
            $('#form_med').attr("action", "Med_NurseExecute");
            $('#form_med').attr("target", "_self");
            $('#form_med').attr("onsubmit", "");
            $("form").submit();
        }
    }

    function position_check(val) {
        var postionall = '@(ViewBag.position_check)';
        if (postionall.indexOf(val) == '-1') {
            alert(val + '部位禁拒打');
            $("#Position_List").children().each(function () {
                if ($(this).val() == '0')
                    $(this).attr("selected", "true");
            });
        }
    }
</script>
<script type="text/javascript">
    $(document).ready(function () {
        //頁籤
        //自動調整頁面高度   //分頁選項高度
        $(window).resize(function () {
            var height = $(this).outerHeight();
            if (height <= 300)
                height = 450;
            $("#unfilled").outerHeight(height - 115);
            $(".tabArea").outerHeight(height - 115);
            $(".tab").outerHeight($(".tabArea").outerHeight() - 100);
        }).trigger("resize");

        $(".tabArea").tabs({ active: 0 });
        $('.WhiteBox, .RedBox, .WhiteEarlyBox, .White24Box').click(function () {
            if ($(this).text() == 'V') {
                $(this).text($(this).attr('tm'));
                $(this).removeClass('FocusStatus');
            } else {
                var Row = $(this).attr('row');
                var UD = $(this).attr('ud');
                var TimeCtrl = $('#Pn' + UD + '_' + Row + ' .FocusStatus');
                var Img = $('#Img' + UD + '_' + Row).attr('src');
                if (TimeCtrl != null) {
                    $(TimeCtrl).removeClass('FocusStatus');
                    $(TimeCtrl).text($(TimeCtrl).attr('tm'));
                }
                if (Img != null && Img != "")
                    $('#ImgCurrentMed').attr('src', Img);
                //藥品資訊
                var MedInfoNameTmp = $("#HidMedInfo" + UD + "_1_" + Row).val().split('|');
                $('#TxtMedInfoName_1').text(MedInfoNameTmp[0]);
                $('#TxtMedInfoName_2').text(MedInfoNameTmp[1]);
                $('#TxtMedInfoName_3').text(MedInfoNameTmp[2]);
                var MedInfoDoseTmp = $("#HidMedInfo" + UD + "_2_" + Row).val().split('|');
                $('#TxtMedInfoDose_1').text(MedInfoDoseTmp[0]);
                $('#TxtMedInfoDose_2').text(MedInfoDoseTmp[1]);
                $('#TxtMedInfoDose_3').text(MedInfoDoseTmp[2]);
                var timeInMs = moment(new Date()).format("YYYY-MM-DD HH:mm:ss");

                setDateTimeForStartDate("TxtRemarkDate", "TxtRemarkTime", MedInfoNameTmp[3], timeInMs);
                $(this).text('V');
                $(this).addClass('FocusStatus');
                $('#PnImg').show();
                $('#PnUd1').show();

                //除了 長期給藥-正常給藥時間 不需跳註記，其餘正常給藥時間階需註記；所有胰島素皆需註記
                if ($(this).attr('class').indexOf('RedBox') >= 0 || $(this).attr('class').indexOf('WhiteEarlyBox') >= 0 ||
                    $(this).attr('class').indexOf('White24Box') >= 0 || !($(this).attr('class').indexOf('WhiteBox') >= 0 &&
                    $(this).attr('udtype') == "R" && $(this).attr('drtype') != 'Y') || ($(this).attr('drtype') != null &&
                    $(this).attr('drtype') != '' && $(this).attr('drtype') == 'Y') || ($(this).attr('cktype') != null &&
                    $(this).attr('cktype') != '' && $(this).attr('cktype') == 'Y')) {
                    showPopup('dv_type1');

                    if ($(this).attr('class').indexOf('RedBox') >= 0) $('#HfCurrentCss').val('RedBox');
                    else if ($(this).attr('class').indexOf('WhiteEarlyBox') >= 0) $('#HfCurrentCss').val('WhiteEarlyBox');
                    else if ($(this).attr('class').indexOf('White24Box') >= 0) $('#HfCurrentCss').val('White24Box');
                    else if ($(this).attr('class').indexOf('WhiteBox') >= 0) $('#HfCurrentCss').val('WhiteBox');
                    EditRemark($(this), false);
                    if (Img == null || Img == "") $('#PnImg').hide();
                }
                //勾選欲給藥資訊，記住id，若無儲存，使用者按取消後，需將此清除，並將原數字改回。
                $('#HidBorderBoxID').val($(this).attr('id'));
            }
        });
        $('a[tabs=Y]').click(function () {
            if ($(".tabArea").tabs("option", "active") == 3)
                $('#BtnBatch').hide();
            else
                $('#BtnBatch').show();
        });
    });

    function setDateTimeForStartDate(DateField, TimeField, St_MinDate, St_MaxDate) {
        //因為目前的寫法難於從 js 傳值至 setDateTime，故暫時將 setDateTime 拉出來給特殊註記
        var now = new Date();
        var maxDate = new Date();
        if (!!St_MaxDate) {
            maxDate = new Date(St_MaxDate);
        }
        var minDate = new Date(St_MinDate);
        $("#" + DateField).removeAttr('readonly');
        $("#" + DateField).attr("readonly", true);
        $("#" + DateField).css({ "width": "80px" });
        $("#" + DateField).css({ "font-size": "12px" });
        if (TimeField != "") {
            $("#" + TimeField).css({ "width": "50px" });
            $("#" + TimeField).removeAttr('readonly');
            $("#" + TimeField).attr("readonly", true);
            $("#" + TimeField).css({ "font-size": "12px" });
        }
        $("#" + DateField).datetimepicker({
            altField: "#" + TimeField,
            beforeShowDay: function (date) {
                switch (date.getDay()) {
                    case 6:
                        return [true, 'satday'];
                        break;
                    case 0:
                        return [true, 'sunday'];
                        break;
                    default:
                        return [true, ''];
                        break;
                }
            },
            inline: true,
            showAnim: "slideDown",
            controlType: myControl,
            minDateTime: minDate,
            maxDateTime: maxDate,
            addSliderAccess: true,
            sliderAccessArgs: { touchonly: false }
        });
    }

    //用藥紀錄 收合
    function DisShowFunc(ObjVal, DivName) {
        var ShowHideValue = $(ObjVal).attr("tagto");
        switch (ShowHideValue) {
            case "Hide":
                $("#" + DivName).fadeIn(300);
                $(ObjVal).attr("tagto", "Show");
                $("#" + $(ObjVal).attr("id") + " img").attr("src", "../images/nolines_minus.gif");
                break;
            case "Show":
                $("#" + DivName).fadeOut(300);
                $(ObjVal).attr("tagto", "Hide");
                $("#" + $(ObjVal).attr("id") + " img").attr("src", "../images/nolines_plus.gif");
                break;
            default:
                break;
        }
    }

    function ChangeStartDate(pType, TxtNameArr, ObjVal, type) {
        var Index = $(".tabArea").tabs("option", "active");
        var CurrentDate = new Date($('#start_date').val());
        if (CurrentDate < '@pf.InDate') {
            CurrentDate = '@pf.InDate';
            $('#start_date').val('@pf.InDate');
        }

        var NewDate = new Date(CurrentDate);  //開始日期
        var NextDateVal = new Date();  //現在日期，給「後一天」的 btn 使用；開始日期不可大於「現在日期 + 1」
        //var BeforeDateVal = new Date();  //住院日期，給「前一天」的 btn 使用；開始日期不可小於「出院日期」
        var dd = "", mm = "", yyyy = "";
        if (pType == 'prev')
            NewDate.setDate(NewDate.getDate() - 1);
        else if (pType == 'next')
            NewDate.setDate(NewDate.getDate() + 1);
        else
            NewDate.setDate(NewDate.getDate() );

        //開始日期
        dd = padLeft(NewDate.getDate().toString(), 2, "0");
        mm = padLeft((NewDate.getMonth() + 1).toString(), 2, "0");
        yyyy = NewDate.getFullYear();
        var RightNowDate = yyyy + '/' + mm + '/' + dd;
        $('#start_date').val(RightNowDate);
        QueryMedData(Index, type);

        //btn 判斷日期，現在日期 or 住院日期
        //現在日期
        NextDateVal.setDate(NextDateVal.getDate() + 1);  //現在日期 + 1
        dd = padLeft(NextDateVal.getDate().toString(), 2, "0");
        mm = padLeft((NextDateVal.getMonth() + 1).toString(), 2, "0");
        yyyy = NextDateVal.getFullYear();
        var NextDStr = yyyy + '/' + mm + '/' + dd;

        //住院日期
        var BeforeDStr = $(ObjVal).attr("indate");

        var SplitTmp = TxtNameArr.split(',');
        if (RightNowDate >= NextDStr)  //最後一天
        {
            $("#" + SplitTmp[0]).attr("disabled", true);
            $("#" + SplitTmp[1]).attr("disabled", false);
        }
        else if (RightNowDate <= BeforeDStr)  //第一天
        {
            $("#" + SplitTmp[1]).attr("disabled", true);
            $("#" + SplitTmp[0]).attr("disabled", false);
        }
        //else {
        //    $("#" + SplitTmp[1]).attr("disabled", true);
        //    $("#" + SplitTmp[0]).attr("disabled", true);
        //}
    }

    function QueryMedData(pIndex, type) {


        $.ajax({
            url: '@Url.Content("~/CommonMedication/QueryMedData")',
            type: 'POST',
            data: { pStartDate: $('#start_date').val() , type: type },
            dataType: 'html',
            async: false,
            cache: false,
            success: function (response) {
                $('#PnMedResult').html(response);
                if (pIndex != null) $(".tabArea").tabs("option", "active", pIndex);
            },
            beforeSend: function () {
                $("#sys_Block, #sys_Loading").show();
            },
            complete: function () {
                $("#sys_Block, #sys_Loading").hide();
            }
        });
    }

    function EditRemark(pCtrl, pBatch) {//打開 特殊註記
        $('#PnUdInsulin').hide();
        $('#checker_show').hide();
        $('#PnUd2').show();
        $('#PnNonDrug').show();
        var Index = $(".tabArea").tabs("option", "active");
        if (pBatch) {
            //批次(目前批次功能已取消)
            //$('#HfBatch').val('Y');
            ////$('#BtnDel').show();
            //if (Index != 1) {
            //    if (Index != 3) {
            //        ChangeRemarkField(true);
            //        ChangeRemarkClear(true);
            //    }
            //    if (Index == 0)
            //        $('#HfUDType').val('R');
            //    else if (Index == 2)
            //        $('#HfUDType').val('S');
            //} else {
            //    ChangeRemarkField(false);
            //    ChangeRemarkClear(false);
            //    $('#HfUDType').val('P');
            //}
            //$('#PnUd2').hide();
        } else {
            //非批次
            $('#HfBatch').val('N');
            $('#HfCurrentCtrl').val($(pCtrl).attr('seq'));
            $('#HidTotalDose').val($(pCtrl).attr('totaldose'));
            $('#HidUseDose').val($(pCtrl).attr('usedose'));
            var RemarkArray = $('#Hf_' + $(pCtrl).attr('seq')).val().split('|');
            var IVInsulin = $('#Hf_Insulin_' + $(pCtrl).attr('seq'));
            var CareArray = $('#Hf_Care_' + $(pCtrl).attr('seq')).val().split('|');
            var Cktype = $('#Hf_DoubleCheck_' + $(pCtrl).attr('seq')).val().split('|');
            if (RemarkArray != null && RemarkArray.length > 0) {
                //  if (RemarkArray.length > 5) {
                if (RemarkArray[3] != "P" && RemarkArray.length > 5) {
                    //S(臨時)、R(長期)、IV(資料庫裡已有資料，欲update的點滴，或無資料但已輸入)
                    //20160906 mod by yungchen 醫囑備註
                    $('#TxtOrder').text(RemarkArray[2]);
                    //
                    var IsPRN = false;
                    if (IVInsulin != null && IVInsulin[0] == "P") {
                        IsPRN = true;
                    }
                    if (IsPRN) {
                        ChangeRemarkField(false);
                        $('#TxtRemark').val(RemarkArray[0]);
                        //20160906 mod by yungchen 醫囑備註
                        $('#TxtOrder').text(RemarkArray[3]);
                        //

                        $('#HfUDType').val("P");
                        $('#PnUd2').hide();
                    } else {
                        ChangeRemarkField(true);
                        if ($(pCtrl).attr('ud') == "0")  //長期
                        {
                            $('#PnUd4').hide();
                        }
                        $('#TxtRemarkDate').val(RemarkArray[0]);
                        $('#TxtRemarkTime').val(RemarkArray[1]);
                        if (document.all("Replenish").checked == true)//補登打勾 用補登的時間
                        {
                            $('#TxtRemarkDate').val($('#TxtReplenishDate').val());
                            $('#TxtRemarkTime').val($('#TxtReplenishTime').val());
                        }
                        $('#TxtOrder').text(RemarkArray[2]);
                        //20160907 mod by yungchen 增加單次比較劑量欄位
                        $('#check_Dose').val(RemarkArray[3]);
                        $('#TxtDose').val(RemarkArray[3]);
                        $('#DdlReasonType').val(RemarkArray[4]);
                        if (RemarkArray[4] != '') {
                            $('#CbNon').prop('checked', true);
                            $('#TxtDose').hide();
                            $('#PnReason').show();
                        } else {
                            $('#CbNon').prop('checked', false);
                            $('#TxtDose').show();
                            $('#PnReason').hide();
                        }
                        $('#DdlLateReason').val(RemarkArray[5]);
                        $('#DdlEarlyReason').val(RemarkArray[5]);
                        $('#TxtRemark').val(RemarkArray[6]);
                        $('#TxtReasonTypeElse').val(RemarkArray[10]);
                        $('#TxtLateReasonElse').val(RemarkArray[11]);
                        $('#TxtEarlyReasonElse').val(RemarkArray[11]);
                        $('#CbCare').prop('checked', RemarkArray[7] == '1' ? true : false);
                        $('#HfUDType').val(RemarkArray[9]);
                        if (Index == "3")  //IV
                        {
                            $('#HidIVType').val("IV" + $(pCtrl).attr('drtype'));
                            //20170614點滴不可以有未給藥 把勾拿掉==
                            $('#DdlReasonType').val('');
                            $('#CbNon').prop('checked', false);
                            $('#TxtDose').show();
                            $('#PnReason').hide();
                            $('#PnNonDrug').hide();  //$('#PnUd2').hide();
                            //20170614點滴不可以有未給藥 把勾拿掉==

                        }
                        if (CareArray != null && CareArray.length > 0) {
                            $('#LblUnit').text(CareArray[7]);
                        }
                    }
                    if (IVInsulin != null && IVInsulin.length > 0) {
                        var IVInsulinItems = $(IVInsulin).val().split('|');
                        if (IVInsulinItems[0] == "Y") {
                            $('#PnUdInsulin').show();
                            if (IVInsulinItems[1] == "") {
                                if ('@(InsulinLastPosition)' == "")
                                    $('#DdlSection option').get(0).selected = true;
                                else
                                    $('#DdlSection').val('@(InsulinLastPosition)');
                                var selectIndex = parseInt($("#DdlSection").find(":selected").index());
                                selectIndex = selectIndex != $('#DdlSection option').length - 1 ? selectIndex : 0;
                                $('#DdlSection option').get(selectIndex + 1).selected = true;
                            }
                            else
                                $('#DdlSection').val(IVInsulinItems[1]);
                        }
                    }
                    //判斷是否是雙人覆核
                    if (Cktype[0] != "" && Cktype[0] == "Y") {
                        $("#checktype").val('Y');
                        $('#checker_show').show();
                    }
                } else {

                    //PRN、IV(強制白框、尚無填入資料)
                    ChangeRemarkField(true);  //PRN 原為只有備註，設為 false ，後恩主公要求有其它資訊，故設為 true
                    $('#TxtRemark').val(RemarkArray[0]);
                    //20160906 mod by yungchen 醫囑備註
                    $('#TxtOrder').text(CareArray[5]);
                    //
                    //20160907 mod by yungchen 增加單次比較劑量欄位
                    $('#check_Dose').val(CareArray[1]);

                    if (Index == "3")  //IV
                    {
                        //20170614點滴不可以有未給藥 把勾拿掉==
                        $('#DdlReasonType').val('');
                        $('#CbNon').prop('checked', false);
                        $('#TxtDose').show();
                        $('#PnReason').hide();
                        //20170614點滴不可以有未給藥 把勾拿掉==

                        $('#HfUDType').val("IV");
                        $('#HidIVType').val("IV" + $(pCtrl).attr('drtype'));
                        //if ($(pCtrl).attr('drtype') == 'P')
                        //    $('#TxtDose').val(CareArray[1]);
                        var tmpTxtDose = dose2int(CareArray[1]).toString();
                        if (tmpTxtDose.indexOf('/') == -1) {
                            if (parseFloat(tmpTxtDose) > 1.0) {
                                $('#TxtDose').val('1');
                            } else {
                                $('#TxtDose').val(dose2int(CareArray[1]));
                            }
                        }
                        else {
                            var dTxtDose = tmpTxtDose.split("/");
                            if (dTxtDose.length == 2) {
                                dTxtDose = dTxtDose[0] / dTxtDose[1];
                            } else {
                                $('#TxtDose').val('1');
                            }

                            $('#TxtDose').val(dTxtDose);
                        }

                        //$('#TxtDose').val('1');
                        //$('#TxtDose').val(dose2int(CareArray[1]));
                        //點滴給藥，是否能像錠劑一樣，執行註記畫面 劑量能自動帶入 mod by yungchen

                    }
                    else {
                        $('#TxtDose').val(dose2int(CareArray[1]));
                        $('#HfUDType').val("P");
                    }

                    if (IVInsulin != null && IVInsulin.length > 0) {
                        var IVInsulinItems = $(IVInsulin).val().split('|');
                        if (IVInsulinItems[0] == "Y") {
                            $('#PnUdInsulin').show();
                            if (IVInsulinItems[1] == "") {
                                if ('@(InsulinLastPosition)' == "")
                                    $('#DdlSection option').get(0).selected = true;
                                else
                                    $('#DdlSection').val('@(InsulinLastPosition)');
                                var selectIndex = parseInt($("#DdlSection").find(":selected").index());
                                selectIndex = selectIndex != $('#DdlSection option').length - 1 ? selectIndex : 0;
                                $('#DdlSection option').get(selectIndex + 1).selected = true;
                            }
                            else
                                $('#DdlSection').val(IVInsulinItems[1]);
                        }
                    }

                    if (document.all("Replenish").checked == true)//補登打勾 用補登的時間 //20161116 mod by yungchen prn&點滴 也加上補登
                    {
                        $('#TxtRemarkDate').val($('#TxtReplenishDate').val());
                        $('#TxtRemarkTime').val($('#TxtReplenishTime').val());
                    } else {
                        var ThisDate = new Date();
                        var RightNowDate = ThisDate.getFullYear() + "/" + padLeft((ThisDate.getMonth() + 1).toString(), 2, "0") + "/" + padLeft(ThisDate.getDate().toString(), 2, "0");
                        var RightNowTime = padLeft(ThisDate.getHours().toString(), 2, "0") + ":" + padLeft(ThisDate.getMinutes().toString(), 2, "0");
                        $('#TxtRemarkDate').val(RightNowDate);
                        $('#TxtRemarkTime').val(RightNowTime);
                    }

                    if (CareArray != null && CareArray.length > 0) {
                        $('#LblUnit').text(CareArray[6]);
                    }
                    $('#PnNonDrug').hide();  //$('#PnUd2').hide();
                    //判斷是否是雙人覆核
                    if (Cktype[0] != "" && Cktype[0] == "Y") {
                        $("#checktype").val('Y');
                        $('#checker_show').show();
                    }
                }
            }
        }
    }

    function ChangeRemarkField(pStatus) {
        for (var i = 0; i <= 5 ; i++) {
            if (pStatus) {
                $('#PnUd' + i).show();
            } else {
                $('#PnUd' + i).hide();
            }
        }

        //提早、延遲、正常
        if ($('#HfCurrentCss').val().indexOf('WhiteEarlyBox') > -1)
            $('#PnUd3').hide();
        else if ($('#HfCurrentCss').val().indexOf('RedBox') > -1)
            $('#PnUd5').hide();
        else if ($('#HfCurrentCss').val().indexOf('WhiteBox') > -1 || $('#HfCurrentCss').val().indexOf('White24Box') > -1) {
            $('#PnUd3').hide();
            $('#PnUd5').hide();
        }
    }

    function ChangeRemarkClear(pStatus) {
        //這裡是批次才會跑的清空程式
        if (pStatus) {
            var ThisDate = new Date();
            var RightNowDate = ThisDate.getFullYear() + "/" + padLeft((ThisDate.getMonth() + 1).toString(), 2, "0") + "/" + padLeft(ThisDate.getDate().toString(), 2, "0");
            var RightNowTime = padLeft(ThisDate.getHours().toString(), 2, "0") + ":" + padLeft(ThisDate.getMinutes().toString(), 2, "0");
            $('#TxtRemarkDate').val(RightNowDate);
            $('#TxtRemarkTime').val(RightNowTime);
            $('#TxtOrder').text('');
            $('#TxtDose').val('');
            $('#DdlReasonType').val('');
            $('#CbNon').prop('checked', false);
            $('#TxtDose').show();
            $('#PnReason').hide();
            $('#DdlLateReason').val('');
            $('#DdlEarlyReason').val('');
            $('#TxtRemark').val('');
            $('#CbCare').prop('checked', false);
            $('#TxtReasonTypeElse').val('');
            $('#TxtLateReasonElse').val('');
            $('#TxtEarlyReasonElse').val('');
        } else {
            $('#TxtRemark').val('');
        }
    }

    function UpdateRemark() {
        var e = $('#TxtRemarkDate').val() + " " + $('#TxtRemarkTime').val();
        var y = new Number($('#TxtMedInfoName_3').text().substr(0, 3)) + 1911;
        var d = y + $('#TxtMedInfoName_3').text().substr(3, 12);
        var dc_y = new Number($('#TxtMedInfoName_3').text().substr(16, 3)) + 1911;
        var dc_date = dc_y + $('#TxtMedInfoName_3').text().substr(19, 12);
        if (e < d) {
            alert('實際給藥時間小於醫囑開藥時間!，請再次確認!');
            return;
        }
        if (dc_y != '1911' && e > dc_date) {
            alert('實際給藥時間大於醫囑停止時間，請再次確認!');
        }
        if ($('#HfUDType').val() != "P") { // PRN 為P
            if ($('#HfBatch').val() != 'Y') {
                if ($('#HfCurrentCss').val() == 'RedBox') {
                    if (document.all("Replenish").checked == false) { //有勾補登就不需要填延遲原因
                        if ($('#DdlLateReason').val() == '' && !$('#CbNon').prop('checked')) {
                            alert('延遲給藥原因必須填寫!');
                            return;
                        } else if ($('#DdlLateReason').val() == '其他' && $('#TxtLateReasonElse').val().length <= 1) {
                            alert('延遲給藥原因「其它」內容不得為空值，長度須大於2碼!');
                            return;
                        }
                    }
                }
                if ($('#HfCurrentCss').val() == 'WhiteEarlyBox') {
                    if ($('#DdlEarlyReason').val() == '' && !$('#CbNon').prop('checked')) {
                        alert('提早給藥原因必須填寫!');
                        return;
                    } else if ($('#DdlEarlyReason').val() == '其他' && $('#TxtEarlyReasonElse').val().length <= 1) {
                        alert('提早給藥原因「其它」內容不得為空值，長度須大於2碼!');
                        return;
                    }
                }
                if ($('#CbNon').prop('checked')) {
                    if ($('#DdlReasonType').val() == '') {
                        alert('未給予原因必須填寫!');
                        return;
                    } else if ($('#DdlReasonType').val() == '其他' && $('#TxtReasonTypeElse').val().length <= 1) {
                        alert('提早給藥原因「其它」內容不得為空值，長度須大於2碼!');
                        return;
                    }
                } else {
                    $('#TxtReasonTypeElse').val('');
                    //var aa = $.trim($('#TxtDose').val()).split('/');
                    //if (aa.length == 2) {
                    //    if (isNaN(aa[0])) {
                    //        alert('給予劑量必須為數值!');
                    //        return;
                    //    }
                    //    if (isNaN(aa[1])) {
                    //        alert('給予劑量必須為數值!');
                    //        return;
                    //    }
                    //} else if (isNaN($.trim($('#TxtDose').val()))) {
                    //    alert('給予劑量必須為數值!');
                    //    return;
                    //}
                    if (isNaN($.trim($('#TxtDose').val()))) {
                        alert('給予劑量必須為數值!');
                        return;
                    }
                    if ($.trim($('#TxtDose').val()) == '' || (!isNaN($.trim($('#TxtDose').val())) && parseFloat($.trim($('#TxtDose').val())) == 0)) {
                        alert('給予劑量必須填寫!');
                        return;
                    }

                    //20160907 mod by yungchen ST有延遲給藥的情況下，延遲原因跟備註都要填寫，但若是未給予，就不用寫備註
                    if ($('#HfUDType').val() == "S") {
                        if ($.trim($('#TxtRemark').val()) == '') {
                            alert('備註必須填寫!');
                            return;
                        }
                    }
                    //20160907 mod by yungchen   ===================
                }
                //if ($('#PnUdInsulin').is(':visible') && $('#DdlSection').val() == '') {
                //    alert('胰島素施打部位必須填寫!');
                //    return;
                //}
            }
        } else {
            if (isNaN($.trim($('#TxtDose').val()))) {
                alert('給予劑量必須為數值!');
                return;
            }
            if ($('#TxtRemark').val() == '') {
                alert('備註必須填寫!');
                return;
            }
        }

        //點滴的 ST、PRN 要輸入備註
        if ($("#HidIVType").val() == "IVS" || $("#HidIVType").val() == "IVP") {
            if ($('#TxtRemark').val() == '') {
                alert('備註必須填寫!');
                return;
            }
        }

        ////全藥種需要判斷是否超過總量
        //if ($("#HidIVType").val() != "IVN") {
        //    if ($.trim($('#HidTotalDose').val()) != '' && $.trim($('#HidUseDose').val()) != '') {
        //        var CanUseDose = 0.00;
        //        CanUseDose = parseFloat($.trim($('#HidTotalDose').val())) - parseFloat($.trim($('#HidUseDose').val()));
        //        if (parseFloat($.trim($('#TxtDose').val())) > CanUseDose) {
        //            alert('劑量必須小於 ' + CanUseDose + " " + $('#LblUnit').html());
        //            return;
        //        }
        //    }
        //}
        //20160907全藥種需要判斷是否超過"單次劑量"
        if ($("#HidIVType").val() != "IVN") {
            if ($.trim($('#check_Dose').val()) != '') {
                var CanUseDose = 0.00;
                CanUseDose = $.trim($('#check_Dose').val());
                var Calculation = $.trim($('#check_Dose').val()).split("/");
                if (Calculation.length == 2) {
                    Calculation = Calculation[0] / Calculation[1];
                } else {
                    Calculation = Calculation[0];
                }


                if (parseFloat(TxtDose) > Calculation) {
                    alert('劑量必須小於 ' + CanUseDose + " " + $('#LblUnit').html());
                    return;
                }
            }
        }
        ////if ($("#checktype").val() == 'Y') {
        ////    $("#Remarks").fadeOut(0);
        ////    $("#div_login").fadeIn(0);
        ////    $("#txtid").val("");
        ////    $("#txtpwd").val("");
        ////    return false
        ////    //雙人覆核跳出
        ////}


        if ($('#checktype').val() == "Y") {
            DouCheck('ok');
            return;
        }


        //if (!DoubleCheck())
        //{
        //    alert('雙人覆核不通過,請再次輸入');
        //    return;
        //}

        var SetCtrl;
        var RemarkContent;
        var Ctrl;
        var CareData;
        var UDTime;
        var DrType;
        var InsulinData;
        var RemarkData;
        if ($('#HfBatch').val() == 'Y') {
            SetCtrl = $('#tabs-' + ($(".tabArea").tabs("option", "active") + 1) + ' .FocusStatus');
        } else {
            SetCtrl = $('#Hf_' + $('#HfCurrentCtrl').val());
        }

        var $HfCurrentCtrl = $('#HfCurrentCtrl').val();
        var $HfUDType = $('#HfUDType').val();
        var $TxtRemark = $('#TxtRemark').val();
        var $HfCurrentCss = $('#HfCurrentCss').val();
        var $HfBatch = $('#HfBatch').val();
        var $TxtRemarkDate = $('#TxtRemarkDate').val();
        var $TxtRemarkTime = $('#TxtRemarkTime').val();
        var $TxtOrder = $('#TxtOrder').text();
        var $TxtDose = $('#TxtDose').val();
        var $DdlReasonType = $('#DdlReasonType').val();
        var $DdlEarlyReason = $('#DdlEarlyReason').val();
        var $DdlLateReason = $('#DdlLateReason').val();
        $(SetCtrl).each(function () {
            //註記內容
            if ($HfBatch == 'Y') {
                Ctrl = $('#Hf_' + $(this).attr('seq'));
                UDTime = $('div[seq=' + $(this).attr('seq') + ']').attr('tm');
            } else {
                Ctrl = $(this);
                UDTime = $('div[seq=' + $HfCurrentCtrl + ']').attr('tm');
                DrType = $('div[seq=' + $(this).attr('seq') + ']').attr('drtype');
            }

            RemarkData = $(Ctrl).val().split('|');
            if ($HfUDType != "P") {
                if ($HfUDType == "IV" && DrType != null && DrType == "P")
                    RemarkContent = [$.trim($TxtRemark), UDTime, "1", $HfUDType, $HfCurrentCss];
                else {
                    if ($HfBatch != 'Y')
                        if ($HfCurrentCss == 'WhiteEarlyBox')
                            RemarkContent = [$TxtRemarkDate, $TxtRemarkTime, $TxtOrder, $.trim($TxtDose), $DdlReasonType, $DdlEarlyReason, $.trim($TxtRemark), $('#CbCare').prop('checked') ? "1" : "0", "1", $HfUDType, $('#TxtReasonTypeElse').val(), $('#TxtEarlyReasonElse').val(), $('#HfCurrentCss').val()];
                        else
                            RemarkContent = [$TxtRemarkDate, $TxtRemarkTime, $TxtOrder, $.trim($TxtDose), $DdlReasonType, $DdlLateReason, $.trim($TxtRemark), $('#CbCare').prop('checked') ? "1" : "0", "1", $HfUDType, $('#TxtReasonTypeElse').val(), $('#TxtLateReasonElse').val(), $('#HfCurrentCss').val()];
                    else
                        RemarkContent = [$TxtRemarkDate, $TxtRemarkTime, $TxtOrder, $.trim(RemarkData[3]), $DdlReasonType, $DdlLateReason, $.trim($TxtRemark), $('#CbCare').prop('checked') ? "1" : "0", "1", $HfUDType, $('#TxtReasonTypeElse').val(), $('#TxtLateReasonElse').val(), $('#HfCurrentCss').val()];
                }
            } else
                //  RemarkContent = [$.trim($('#TxtRemark').val()), UDTime, "1", $('#HfUDType').val(), $('#HfCurrentCss').val()];
                RemarkContent = [$.trim($TxtRemark), UDTime, "1", $HfUDType, $TxtRemarkDate, $TxtRemarkTime, $HfCurrentCss];
            //20160929 mod by yungchen 修改胰島素也要把實際給藥日期帶過去(第4,5個位置)

            $(Ctrl).val(RemarkContent.join('|'));

            //護理紀錄
            if ($HfBatch == 'Y') {
                Ctrl = $('#Hf_Care_' + $(this).attr('seq'));
            } else {
                Ctrl = $('#Hf_Care_' + $HfCurrentCtrl);
            }
            CareData = $(Ctrl).val().split('|');

            if ($HfUDType != "P") {
                if ($HfUDType == "IV" && DrType != null && DrType == "P") {
                    //RemarkContent = [$.trim($('#TxtRemark').val()), CareData[1], CareData[2], CareData[3], CareData[4], CareData[5]];

                    RemarkContent = [$.trim($TxtRemark), $.trim($TxtDose), CareData[2], CareData[3], CareData[4], CareData[5]];

                } else if ($HfUDType == "IV") {
                    if ($HfCurrentCss == 'White24Box') {
                        var MedDescTmp = CareData[6];
                        if ($(Ctrl).attr('id').indexOf('TmpIV') > -1) {
                            MedDescTmp = CareData[5];
                        }
                        RemarkContent = [$.trim($TxtRemark), $.trim($TxtDose), CareData[2], CareData[3], $DdlReasonType == "" ? "" : $('#DdlReasonType option:selected').text(), MedDescTmp, CareData[6], CareData[7]];
                    } else {
                        RemarkContent = [$.trim($TxtRemark), $.trim($TxtDose), CareData[2], CareData[3], $DdlReasonType == "" ? "" : $('#DdlReasonType option:selected').text(), CareData[5], $DdlLateReason == "" ? "" : $('#DdlLateReason option:selected').text(), CareData[7]];
                    }
                }
                else {
                    if ($HfCurrentCss == 'WhiteEarlyBox'){
                        RemarkContent = [$.trim($TxtRemark), $.trim($TxtDose), CareData[2], CareData[3], $DdlReasonType == "" ? "" : $('#DdlReasonType option:selected').text(), CareData[5], $DdlEarlyReason == "" ? "" : $('#DdlEarlyReason option:selected').text(), CareData[7]];
                    }
                    else if ($HfCurrentCss == 'White24Box') {
                        var MedDescTmp = CareData[5];
                        if ($(Ctrl).attr('id').indexOf('TmpIV') > -1) {
                            MedDescTmp = CareData[4];

                        }
                        RemarkContent = [$.trim($TxtRemark), $.trim($TxtDose), CareData[2], CareData[3], $DdlReasonType == "" ? "" : $('#DdlReasonType option:selected').text(), MedDescTmp, "", CareData[7]];
                    }
                    else {
                        RemarkContent = [$.trim($TxtRemark), $.trim($TxtDose), CareData[2], CareData[3], $DdlReasonType == "" ? "" : $('#DdlReasonType option:selected').text(), CareData[5], $DdlLateReason == "" ? "" : $('#DdlLateReason option:selected').text(), CareData[7]];
                    }

                }
            } else {
                //RemarkContent = [$.trim($('#TxtRemark').val()), CareData[1], CareData[2], CareData[3], CareData[4], CareData[5]];
                RemarkContent = [$.trim($TxtRemark), $.trim($TxtDose), CareData[2], CareData[3], CareData[4], CareData[5], CareData[6]];
            }
            //護理紀錄是否有打勾20160930 mod by yungchen
            if ($('#CbCare').is(":checked")) {
                $(Ctrl).val(RemarkContent.join('|') + "|Y");
            }
            else {
                $(Ctrl).val(RemarkContent.join('|') + "|N");
            }
            // alert($(Ctrl).val(RemarkContent.join('|') + "|N"));
            //20160930 mod by yungchen=======
            // $(Ctrl).val(RemarkContent.join('|'));

            //胰島素
            Ctrl = $('#Hf_Insulin_' + $HfCurrentCtrl);
            if (Ctrl != null && Ctrl.length > 0) {
                InsulinData = $(Ctrl).val().split('|');
                var x = document.getElementById("DdlSection")
                RemarkContent = [InsulinData[0], $('#DdlSection').val(), x.options[x.selectedIndex].text];
                $(Ctrl).val(RemarkContent.join('|'));


            }

            //雙人覆核
            Ctrl = $('#Hf_DoubleCheck_' + $HfCurrentCtrl);
            if (Ctrl != null && Ctrl.length > 0) {

                DoubleCheckData = $(Ctrl).val().split('|');
                RemarkContent = [DoubleCheckData[0], $('#txtid').val(), $('#checker').val()];

                $(Ctrl).val(RemarkContent.join('|'));
                $('#checktype').val('N');//回復原本狀態
                $('#checker_id').val('');
                $('#checker').val('');
                $('#txtid').val('');
                $('#txtpwd').val('');
                $('#checker_show').hide();//關掉顯示的覆核名字
            }
        })
        $('#dv_type1').fadeOut(500);
        $('#block').hide();
        $('#HfBatch').val('');

    }

    function CancelRemark() {
        var BorderBoxIDTmp = '#' + $('#HidBorderBoxID').val();
        $(BorderBoxIDTmp).text($(BorderBoxIDTmp).attr('tm'));  //將數字還原
        $(BorderBoxIDTmp).removeClass('FocusStatus');
        $('#dv_type1').hide();
        $('#block').hide();
        $('#HidBorderBoxID').val('');  //將暫記清除
        $('#TxtDose').val('');
        //20160907 mod by yungchen 增加單次比較劑量欄位清空
        $('#check_Dose').val('');
        //20160907 mod by yungchen 取消時要連註記都清空
        //    DelRemark();
        $('#TxtReasonTypeElse').val('');
        $('#TxtLateReasonElse').val('');
    }

    function DelRemark() {
        var SetCtrl;
        var Ctrl;
        var UDTime;
        var DrType;
        if ($('#HfBatch').val() == 'Y') {
            SetCtrl = $('#tabs-' + ($(".tabArea").tabs("option", "active") + 1) + ' .FocusStatus');
        } else {
            SetCtrl = $('#Hf_' + $('#HfCurrentCtrl').val());
        }
        var $HfBatch = $('#HfBatch').val();
        var $HfUDType = $('#HfUDType').val();
        $(SetCtrl).each(function () {
            if ($HfBatch == 'Y') {
                Ctrl = $('#Hf_' + $(this).attr('seq'));
                UDTime = $('div[seq=' + $(this).attr('seq') + ']').attr('tm');
            } else {
                Ctrl = $(this);
                UDTime = $('div[seq=' + $('#HfCurrentCtrl').val() + ']').attr('tm');
                DrType = $('div[seq=' + $('#HfCurrentCtrl').val() + ']').attr('drtype');
            }
            if ($HfUDType != "P") {
                if ($HfUDType == "IV" && DrType != null && DrType == "P") {
                    $(Ctrl).val('|' + UDTime + '|0|' + $HfUDType);
                } else {
                    var ThisDate = new Date();
                    var RightNowDate = ThisDate.getFullYear() + "/" + padLeft((ThisDate.getMonth() + 1).toString(), 2, "0") + "/" + padLeft(ThisDate.getDate().toString(), 2, "0");
                    var RightNowTime = padLeft(ThisDate.getHours().toString(), 2, "0") + ":" + padLeft(ThisDate.getMinutes().toString(), 2, "0");
                    $(Ctrl).val(RightNowDate + '|' + RightNowTime + '||||||0|0|' + $HfUDType);
                }
            } else {
                $(Ctrl).val('|' + UDTime + '|0|' + $HfUDType);
            }
        })
        $('#HfBatch').val('');
    }

    function OpenBatchRemark() {
        var TimeCtrl = $('#tabs-' + ($(".tabArea").tabs("option", "active") + 1) + ' .FocusStatus');
        if ($(TimeCtrl) != null && $(TimeCtrl).length > 0) {
            showPopup('dv_type1');
            EditRemark($(TimeCtrl), true);
            $('#PnImg').hide();
            $('#PnUd1').hide();
        } else {
            alert('請選擇預計給藥時間!');
        }
    }

    function OpenRemark(pType, pRow) {//1為PRN
        var TimeCtrl = $('#Pn' + pType + '_' + pRow + ' .FocusStatus');
        var Img = $('#Img' + pType + '_' + pRow).attr('src');
        $('#PnImg').show();
        $('#PnUd1').show();
        if (Img != null && Img != "")
            $('#ImgCurrentMed').attr('src', Img);

        //藥品資訊
        var MedInfoNameTmp = $("#HidMedInfo" + pType + "_1_" + pRow).val().split('|');
        $('#TxtMedInfoName_1').text(MedInfoNameTmp[0]);
        $('#TxtMedInfoName_2').text(MedInfoNameTmp[1]);
        $('#TxtMedInfoName_3').text(MedInfoNameTmp[2]);
        var MedInfoDoseTmp = $("#HidMedInfo" + pType + "_2_" + pRow).val().split('|');
        $('#TxtMedInfoDose_1').text(MedInfoDoseTmp[0]);
        $('#TxtMedInfoDose_2').text(MedInfoDoseTmp[1]);
        $('#TxtMedInfoDose_3').text(MedInfoDoseTmp[2]);

        setDateTimeForStartDate("TxtRemarkDate", "TxtRemarkTime", MedInfoNameTmp[3]);

        if ($(TimeCtrl) != null && $(TimeCtrl).length > 0) {
            showPopup('dv_type1');
            $('#HfCurrentCss').val($(TimeCtrl).attr('class'));
            EditRemark($(TimeCtrl), false);
            if (Img == null || Img == "") $('#PnImg').hide();
        } else {
            alert('請選擇預計給藥時間!');
        }
    }

    function SwitchReason(pCtrl) {
        if ($(pCtrl).prop('checked')) {
            $('#TxtDose').hide();
            $('#TxtDose').val('');
            $('#PnReason').show();
            $('#PnReason').css('display', 'inline-block');
            $('#LblUnit').hide();
        } else {
            $('#TxtDose').show();
            $('#PnReason').hide();
            $('#DdlReasonType').val('');
            $('#LblUnit').show();
        }
    }

    function SaveMedData(MedicationType) {
      var age = '@pf.Age';
      var rowCount = $('#checkmed tr').length - 1;
      var rowCount = $('#checkmed tr').length - 1;
      if ($('input[name=Chk35]:checked').length == $('input[name=Chk35]').length) {
          //alert('請至少給一個藥!');
          //return;
          //若藥物全部取消，則不儲存任何資料，直接重新進入頁面，將其它資料清空。
          QueryMedData();
          $('#PnChecksRights').fadeOut(500);
          $('#block').hide();
          return;
      }
      var ReadyCtrls = $('#PnMedResult .FocusStatus');
      var SeqArray = $(ReadyCtrls).map(function () {
          return $(this).attr('seq');
      }).get();
      var Exclude = $('input[name=Chk35]:checked').map(function () {
          return $(this).val();
      }).get();
      SeqArray = $(SeqArray).not(Exclude).get().join('|');
      $('#HfMedData').val(SeqArray);
      $.ajax({
          url: '@Url.Content("~/CommonMedication/MedInsert")',
          type: 'POST',
          data: $('form[name=FormMed]').serialize() + "&StartDate=" + $('#start_date').val() + "&TxtReplenishDate=" + $('#TxtReplenishDate').val() + "&TxtReplenishTime=" + $('#TxtReplenishTime').val() + "&Replenish=" + $('#Replenish').prop('checked'),
          //TxtReplenishDate 補登日期,  TxtReplenishTime 補登時間, Replenish 是否勾選補登
          async: false,
          success: function (data) {
              if (data == "Y") {
                  //var Index = $(".tabArea").tabs("option", "active");

                  var Index = $(".tabArea").tabs("option", "active") || 0;

                  alert('儲存成功!');
                  QueryMedData(Index, MedicationType);
                  $('#PnChecksRights').fadeOut(500);
                  $('#block').hide();
                  CancelRemark();
                  var wayArrary = [];
                  var medCodeArrary = [];
                  for (i = 0; i < rowCount; i++) {
                      var desc = $("#desc_" + i).text().trim();
                      var dose = $("#dose_" + i).text().trim();
                      var way = $("#way_" + i).text().trim();
                      var seq = $("#Chk_" + i).val().trim();
                      if (MedicationType == "pain") {
                          window.opener.insertMed(seq, desc, dose, way);
                      }

                      wayArrary.push(way);
                      var obj = {
                          way: way,
                          med_code: $("#medCode_" + i).text().trim(),
                          count: $("#medCount_" + i).text().trim(),
                          desc: $("#desc_" + i).text().trim(),
                          dose: $("#dose_" + i).text().trim(),
                          type: $("#medType_" + i).text().trim(),
                          execTime: $("#execTime_" + i).text().trim(),
                      }
                      medCodeArrary.push(obj)
                  }

                  var billSet = [];
                  var billEisai = [];

                  // 默許及套組設定

                var insulinList = null;
                    //取得胰島素藥物
                    $.ajax({
                        type: 'POST',
                        async: false,
                        url: '@Url.Content("~/CommonMedication/getInsulinMed")',
                        success: function (data) {
                            if (data != null) {
                                insulinList = data.split("|");
                            }
                        }
                    });

                  for (i = 0; i < medCodeArrary.length; i++) {
                      var way = medCodeArrary[i].way;
                      var code = medCodeArrary[i].med_code;
                      var type = medCodeArrary[i].type;
                      var dose = medCodeArrary[i].dose;

                      if (way == "IM") {
                          billSet.push("SET0410112051");

                          // 新增默許
                          var obj = {
                              HO_ID: "8999015",
                              COUNT: "0",
                              IDENTITY: "吸收",
                          }
                          billEisai.push(obj);
                      }
                      else if (way == "SC") {

                          // 新增默許
                          var obj = {
                              HO_ID: "8999013",
                              COUNT: "1",
                              IDENTITY: "吸收",
                          }

                          billEisai.push(obj);

                          // 胰島素類
                          if (insulinList.includes(code)) {
                              billSet.push("SET1008000007");
                          }
                          else {
                              // 非胰島素類
                              billSet.push("SET0625113019");
                          }
                      }
                      else if (way == "IVD") {
                          if (insulinList.includes(code)) {
                              billSet.push("SET0410112407");
                          }

                          // 新增默許
                          var month = 0;
                          if (age == 0) {
                              month = parseInt('@pf.Month.ToString()');
                          }
                          if (age >= 7) {
                              var obj = {
                                  HO_ID: "8439004",
                                  COUNT: "1"
                              }
                              billEisai.push(obj)
                          }
                          else if (age < 7 && age >= 2) {
                              var obj = {
                                  HO_ID: "5157122",
                                  COUNT: "1"
                              }
                              billEisai.push(obj)
                          }
                          else if (age < 2 && month >= 6) {
                              var obj = {
                                  HO_ID: "5157121",
                                  COUNT: "1"
                              }
                              billEisai.push(obj)
                          }
                          else if (age == 0 && month < 6) {
                              var obj = {
                                  HO_ID: "5157120",
                                  COUNT: "1"
                              }
                              billEisai.push(obj)
                          }

                      }
                      else if (way == "IVF") {
                          if (insulinList.includes(code)) {
                              billSet.push("SET0410112407");
                          }
                      }
                      // 途徑為 EN 且非點滴類
                      else if (way == "EN" && type != "V") {
                          // 取得該藥物是否為第一次施打
                          $.ajax({
                              type: 'POST',
                              async: false,
                              url: '@Url.Content("~/CommonMedication/isGrugFirstTime")',
                              data: "feeno=" + '@pf.FeeNo' + "&drugcode=" + code,
                              success: function (data) {
                                  if (data == 'True') {
                                      billSet.push("SET0410112311");
                                  }
                                  else {
                                      billSet.push("SET1008000008");
                                  }
                              }
                          });

                          // 新增默許
                          var obj = {
                              HO_ID: "8447006",
                              COUNT: "1",
                              IDENTITY: "吸收",
                          }
                          billEisai.push(obj);
                      }
                      // 途徑為 INHL 且非點滴類
                      else if (way == "INHL" && type != "V") {
                          // 取得該藥物是否為第一次施打
                          $.ajax({
                              type: 'POST',
                              async: false,
                              url: '@Url.Content("~/CommonMedication/isGrugFirstTime")',
                              data: "feeno=" + '@pf.FeeNo' + "&drugcode=" + code,
                              success: function (data) {
                                  if (data == 'True') {
                                      billSet.push("SET0410113106");
                                  }
                                  else {
                                      billSet.push("SET1008000009");
                                  }
                              }
                          });

                          // 新增默許
                          var obj = {
                              HO_ID: "1357021",
                              COUNT: "1",
                              IDENTITY: "吸收",
                          }
                          billEisai.push(obj);
                      }
                      // 取得路徑為 IVP
                      else if (way == "IVP") {
                          // 新增默許
                          if (age < 7) {
                              var obj = {
                                  HO_ID: "8439004",
                                  COUNT: "1"
                              }
                              billEisai.push(obj)
                          }
                          else if (age >= 7) {
                              var obj = {
                                  HO_ID: "8999012",
                                  COUNT: "1"
                              }
                              billEisai.push(obj)
                          }
                      }

                      // 判斷是否為劑型 amp 或 vial(某些情況下 dose 會沒有單位，增加 desc 判斷)
                      if (dose.includes("AMP") || dose.includes("VIAL") || desc.toUpperCase().includes("AMP") || desc.toUpperCase().includes("VIAL")) {
                          // 判斷是否為急診
                          if ('@pf.FeeNo'.length > 10) {
                              // 急診
                              billSet.push("SET1008000011");
                          } else {
                              // 住院
                              billSet.push("SET1008000010");
                          }
                      }


                  }

                  // 將重複的套組排除
                  billSet = [...new Set(billSet)];

                    @*if (wayArrary.includes("IM")) {
                        billSet.push("SET0410112051");

                        // 新增默許
                        var obj = {
                            HO_ID: "8999015",
                            COUNT: "0",
                            IDENTITY: "吸收",
                        }
                        billEisai.push(obj);
                    }
                    //胰島素藥物
                    if (wayArrary.includes("IVD") || wayArrary.includes("IVF") || wayArrary.includes("SC")) {

                        var insulinList = null;
                        //取得胰島素藥物
                           $.ajax({
                               type: 'POST',
                               async: false,
                               url: '@Url.Content("~/CommonMedication/getInsulinMed")',
                               success: function (data) {
                                   if (data != null) {
                                       insulinList = data.split("|");
                                   }
                               }
                           });
                        for (i = 0; i < medCodeArrary.length; i++) {
                            var way = medCodeArrary[i].way;
                            var code = medCodeArrary[i].med_code;
                            if (way == "SC") {
                                if (insulinList.includes(code)) {
                                    billSet.push("SET1008000007");

                                    // 新增默許
                                    var obj = {
                                        HO_ID: "8999013",
                                        COUNT: "1",
                                        IDENTITY: "吸收",
                                    }
                                    billEisai.push(obj);
                                }
                            }
                            else if (way == "IVD" || way == "IVF") {
                                if (insulinList.includes(code)) {
                                    billSet.push("SET0410112407");

                                    // 新增默許
                                    var obj = {
                                        HO_ID: "8999013",
                                        COUNT: "1",
                                        IDENTITY: "吸收",
                                    }
                                    billEisai.push(obj);
                                }
                            }

                        }
                    }
                  if (wayArrary.includes("EN")) {

                      // 新增默許
                        var obj = {
                            HO_ID:"8447006",
                            COUNT:"1"
                        }
                        billEisai.push(obj)
                    }
                  if (wayArrary.includes("INHL")) {

                      // 新增默許
                        var obj = {
                            HO_ID: "1357021",
                            COUNT: "1"
                        }
                        billEisai.push(obj)
                    }
                    if (wayArrary.includes("SC")) {
                        var obj = {
                            HO_ID: "8999013",
                            COUNT: "1"
                        }
                        billEisai.push(obj)
                    }
                    if (wayArrary.includes("IVP")) {
                        if (age < 7) {
                            var obj = {
                                HO_ID: "8439004",
                                COUNT: "1"
                            }
                            billEisai.push(obj)
                        }
                        else if (age >= 7) {
                            var obj = {
                                HO_ID: "8999012",
                                COUNT: "1"
                            }
                            billEisai.push(obj)
                        }
                    }
                    if (wayArrary.includes("IVD")) {
                        var month = 0;
                        if (age == 0) {
                            month = parseInt('@pf.Month.ToString()');
                        }
                        if (age >= 7) {
                            var obj = {
                                HO_ID: "8439004",
                                COUNT: "1"
                            }
                            billEisai.push(obj)
                        }
                        else if (age < 7 && age >= 2) {
                            var obj = {
                                HO_ID: "5157122",
                                COUNT: "1"
                            }
                            billEisai.push(obj)
                        }
                        else if (age < 2 && month >= 6) {
                            var obj = {
                                HO_ID: "5157121",
                                COUNT: "1"
                            }
                            billEisai.push(obj)
                        }
                        else if (age == 0 && month < 6) {
                            var obj = {
                                HO_ID: "5157120",
                                COUNT: "1"
                            }
                            billEisai.push(obj)
                        }

                  }*@

                    var setStr = billSet.join("|");
                    //AJAX
                        $.ajax({
                            type: 'POST',
                            cache: false,
                            dataType: 'json',
                            contentType: "application/json; charset=utf-8",
                            url: '@Url.Content("~/Base/SaveBillingRecord")',
                            data: JSON.stringify({
                                data: billEisai,
                            }),
                            success: function (data) {
                            }
                        });

                        for (i = 0; i < medCodeArrary.length; i++) {
                        var way = medCodeArrary[i].way;
                        var code = medCodeArrary[i].med_code;
                        var type = medCodeArrary[i].type;
                        var execTime = medCodeArrary[i].execTime;
                        var isChecked = $('#Chk_' + i).is(':checked');
                            if ((way == "IVF" || way == "IVD" || way == "IRRI") && type == "V" && isChecked == false) {

                            var count = parseInt(medCodeArrary[i].count);;
                            $.ajax({
                            type: 'POST',
                            cache: false,
                            dataType: 'json',
                            contentType: "application/json; charset=utf-8",
                            url: '@Url.Content("~/CommonMedication/PrintIVF")',
                            data: JSON.stringify({
                                code: code,
                                way: way,
                                desc: medCodeArrary[i].desc,
                                dose: medCodeArrary[i].dose,
                                count: count,
                                execTime: execTime
                            }),
                            success: function (data) {
                            }
                        });

                        }
                    }

                    if (setStr != "" && '@IsDischarged' == 'False' ) {
                        var popup = window.open('', '', 'menubar=no,status=no,scrollbars=yes,top=0,left=300,toolbar=no,width=1290,height=800');
                        popup.location.href = '../Billing/index?set=' + setStr;
                        //window.open('../Billing/index?set=' + setStr, '', 'menubar=no,status=no,scrollbars=yes,top=0,left=300,toolbar=no,width=1290,height=800');
                    }

                } else {
                    alert('儲存失敗!');
                }
            },
            complete: function () {
                $("#sys_Block, #sys_Loading").hide();
            },
            beforeSend: function () {
                $("#sys_Block, #sys_Loading").show();
            }
        });
    }

    function OpenChecksList(type) {
        var ReadyCtrls = $('#PnMedResult .FocusStatus');
        if (ReadyCtrls != null && $(ReadyCtrls).length > 0) {
            var IsOk = true;
            $(ReadyCtrls).each(function () {
                if ($(this).attr('class').indexOf('RedBox') >= 0) {
                    if ($('#Hf_' + $(this).attr('seq')).val().split('|').length > 5) {
                        if (document.all("Replenish").checked == false)//有勾補登就不需要填延遲原因
                            if ($('#Hf_' + $(this).attr('seq')).val().split('|')[5] == "" && $('#Hf_' + $(this).attr('seq')).val().split('|')[4] == "") {
                                alert('延遲給藥原因必須填寫!');
                                IsOk = false;
                                return false;
                            }
                    } else {
                        if ($('#Hf_' + $(this).attr('seq')).val().split('|')[0] == "") {
                            alert('PRN備註必須填寫!');
                            IsOk = false;
                            return false;
                        }
                    }
                }
                if ($('#Hf_' + $(this).attr('seq')).val().split('|').length > 5) {
                    if ($('#Hf_' + $(this).attr('seq')).val().split('|')[4] == "") {
                        if ($('#Hf_' + $(this).attr('seq')).val().split('|')[3] == "" || (!isNaN($('#Hf_' + $(this).attr('seq')).val().split('|')[3]) && parseFloat($('#Hf_' + $(this).attr('seq')).val().split('|')[3]) == 0)) {
                            alert('給予劑量必須填寫!');
                            IsOk = false;
                            return false;
                        } else if (isNaN($('#Hf_' + $(this).attr('seq')).val().split('|')[3])) {
                            alert('給予劑量必須為數值!');
                            IsOk = false;
                            return false;
                        }
                        //if ($('#Hf_' + $(this).attr('seq')).val().split('|')[4] == "" && $('#Hf_' + $(this).attr('seq')).val().split('|')[5] == "" && $('#Hf_' + $(this).attr('seq')).val().split('|')[9] != "")
                        //{
                        //    if ($('#Hf_' + $(this).attr('seq')).val().split('|')[9] == "R")
                        //    {
                        //    var temp = $('#Hf_' + $(this).attr('seq')).val().split('|');
                        //    temp[4] = temp[0];
                        //    temp[5] = temp[1];
                        //    $('#Hf_' + $(this).attr('seq')).val(temp.join('|'))

                        //    }
                        //}
                        //if ($('#Hf_Insulin_' + $(this).attr('seq')) != null && $('#Hf_Insulin_' + $(this).attr('seq')).length > 0) {
                        //    if ($('#Hf_Insulin_' + $(this).attr('seq')).val() != '' && $('#Hf_Insulin_' + $(this).attr('seq')).val().split('|')[0] == 'Y' && $('#Hf_Insulin_' + $(this).attr('seq')).val().split('|')[1] == '') {
                        //        alert('胰島素施打部位必須填寫!');
                        //        IsOk = false;
                        //        return false;
                        //    }
                        //}
                    }
                }
            })

            if (!IsOk) return;

            var SeqArray = $(ReadyCtrls).map(function () {
                return $(this).attr('seq');
            }).get().join('|');
            var Encode = encodeURIComponent($('form[name=FormMed]').serialize());
            $('#HfMedData').val(SeqArray);
            if (type == 'pain') {
                $.ajax({
                    url: '@Url.Content("~/CommonMedication/RenderChecksRightsPain")',
                    type: 'POST',
                    data: $('form[name=FormMed]').serialize(),
                    dataType: 'html',
                    async: false,
                    success: function (response) {
                        $('#PnChecksRights').html(response);
                        showPopup('PnChecksRights');
                    },
                    error: function (data) {
                        showHint("請洽資訊室");
                    }
                });
            }
            else {
                  $.ajax({
                    url: '@Url.Content("~/CommonMedication/RenderChecksRights")',
                    type: 'POST',
                    data: $('form[name=FormMed]').serialize(),
                    dataType: 'html',
                    async: false,
                    success: function (response) {
                        $('#PnChecksRights').html(response);
                        showPopup('PnChecksRights');
                    },
                    error: function (data) {
                        showHint("請洽資訊室");
                    }
                });
            }

        } else {
            alert('請選擇欲給藥時段!');
        }
    }

    function OpenFrequency() {
        $.ajax({
            url: '@Url.Content("~/CommonMedication/RenderFrequency")',
            dataType: 'html',
            success: function (response) {
                $('#PnFrequency').html(response);
                showPopup('PnFrequency');
            }
        });
    }
    function DoubleCheck() {

        if ($("#checktype").val() == 'Y') {
            $("#Remarks").fadeOut(0);
            $("#div_login").fadeIn(0);

            //$("#checker").attr("name", num);
            $("#txtid").val("");
            $("#txtpwd").val("");
            //$("#div_login").center().fadeIn(0);

            return false
        }

    }

    function dose2int(input_value) {
        var tmp_dose, result_dose;
        var result_dose = "";
        if (input_value != undefined || input_value != "") {
            if (input_value.indexOf('/') != -1) {
                tmp_dose = input_value.split('/');
                for (var i = 0; i < tmp_dose.length; i++) {
                    result_dose = parseFloat(tmp_dose[0]) / parseFloat(tmp_dose[1]).toFixed(2);
                    result_dose = result_dose.toFixed(2);
                }
            } else {
                result_dose = input_value;
            }
            return result_dose;
        } else {
            if (input_value.indexOf('/') != -1) {
                tmp_dose = input_value.split('/');
                for (var i = 0; i < tmp_dose.length; i++) {
                    result_dose = parseFloat(tmp_dose[0]) / parseFloat(tmp_dose[1]);
                    result_dose = result_dose.toFixed(2);
                }
            }
            else {
                result_dose = input_value;
            }
            return result_dose;
        }
    }


</script>
<form method="post" name="FormMed">
    <input type="hidden" id="HfCurrentCtrl" name="HfCurrentCtrl" />
    <input type="hidden" id="HfCurrentCss" name="HfCurrentCss" />
    <input type="hidden" id="HfMedData" name="HfMedData" />
    <input type="hidden" id="HfUDType" name="HfUDType" />
    <input type="hidden" id="HfBatch" name="HfBatch" />
    <input type="hidden" id="HidBorderBoxID" name="HidBorderBoxID" />
    <input type="hidden" id="HidIVType" name="HidIVType" />
    <div id="filled" class="tabArea" style="margin-bottom: 5px;">
        <ul>
            <li>
                <a href="#tabs-1" must="Y" num="0" tabs="Y" id="LongTabsTitle">長期醫囑</a>
            </li>
            <li>
                <a href="#tabs-2" must="Y" num="1" tabs="Y" id="PRNTabsTitle">PRN醫囑</a>
            </li>
            <li>
                <a href="#tabs-3" must="Y" num="2" tabs="Y" id="StatTabsTitle">臨時醫囑</a>
            </li>
            <li>
                <a href="#tabs-4" must="Y" num="3" tabs="Y" id="IVTabsTitle">點滴</a>
            </li>
            @*<li>
                    <input type="button" value="批次註記" onclick="OpenBatchRemark();" />
                    <input type="button" value="存檔" name="val" onclick="OpenChecksList();" />
                </li>*@
        </ul>
        <!-- 長期醫囑 -->
        <div id="tabs-1" class="tab">
            <table>
                @if (LongList != null && LongList.Count > 0)
                {
                    LongUnExec = 0;
                    for (int g = 0; g < LongList.Count; g++)
                    {
                        TotalDose = 0;
                        UseDose = 0;
                        <tr>
                            <td>
                                @{
                                    DataTable MedDt = cm.FiltData(LongDt, "UD_SEQ='" + LongList[g].UD_SEQ + "'");
                                    List<string[]> TimeArray = new List<string[]>();
                                    List<string> MedArray = new List<string>();
                                    string BackInsideColor = "#FFE599";
                                    Double n;
                                    TotalDose = Double.TryParse(LongList[g].UD_DOSE, out n) ? double.Parse(LongList[g].UD_DOSE) : 0.0;
                                    if (MedDt != null && MedDt.Rows.Count > 0)
                                    {
                                        foreach (DataRow MedDr in MedDt.Rows)
                                        {
                                            string TmpRemarkData = string.Format("{0}|{1}|{2}|{3}|{4}|{5}|{6}|{7}|{8}|{9}", (MedDr["EXEC_DATE"].ToString().Trim() != "" ? Convert.ToDateTime(MedDr["EXEC_DATE"].ToString().Trim()).ToString("yyyy/MM/dd") : DateTime.Now.ToString("yyyy/MM/dd")), (MedDr["EXEC_DATE"].ToString().Trim() != "" ? Convert.ToDateTime(MedDr["EXEC_DATE"].ToString().Trim()).ToString("HH:mm") : DateTime.Now.ToString("HH:mm")), LongList[g].UD_CMD, MedDr["USE_DOSE"].ToString().Trim() != "" && Convert.ToDecimal(MedDr["USE_DOSE"].ToString().Trim()) > 0 ? MedDr["USE_DOSE"].ToString().Trim() : LongList[g].UD_DOSE, MedDr["REASONTYPE"].ToString().Trim(), MedDr["REASON"].ToString().Trim(), MedDr["REMARK"].ToString().Trim(), "0", "0", "R");
                                            string CareData = string.Format("{0}|{1}|{2}|{3}|{4}|{5}|{6}|{7}", MedDr["REMARK"].ToString().Trim(), MedDr["USE_DOSE"].ToString().Trim() != "" && Convert.ToDecimal(MedDr["USE_DOSE"].ToString().Trim()) > 0 ? MedDr["USE_DOSE"].ToString().Trim() : LongList[g].UD_DOSE, LongList[g].UD_PATH, LongList[g].UD_CIR, MedDr["REASONTYPE"].ToString().Trim(), LongList[g].MED_DESC, MedDr["P_NAME"].ToString().Trim(), LongList[g].UD_UNIT);
                                            string InsulinData = string.Format("{0}|{1}", LongList[g].DRUG_TYPE, MedDr["POSITION"].ToString().Trim());

                                            <input type="hidden" name="Hf_@(MedDr["UD_SEQPK"].ToString().Trim())" id="Hf_@(MedDr["UD_SEQPK"].ToString().Trim())" value="@(TmpRemarkData)" />
                                            <input type="hidden" name="Hf_Care_@(MedDr["UD_SEQPK"].ToString().Trim())" id="Hf_Care_@(MedDr["UD_SEQPK"].ToString().Trim())" value="@(CareData)" />
                                            <input type="hidden" name="Hf_Insulin_@(MedDr["UD_SEQPK"].ToString().Trim())" id="Hf_Insulin_@(MedDr["UD_SEQPK"].ToString().Trim())" value="@(InsulinData)" />
                                            @*<input type="hidden" name="Hf_Insulin_@(MedDr["UD_SEQPK"].ToString().Trim())" id="Hf_Insulin_@(MedDr["UD_SEQPK"].ToString().Trim())" value="Y|" />*@
                                            <input type="hidden" name="Hf_DoubleCheck_@(MedDr["UD_SEQPK"].ToString().Trim())" id="Hf_DoubleCheck_@(MedDr["UD_SEQPK"].ToString().Trim())" value="@(LongList[g].DoubleCheck)" />
                                            <input type="hidden" name="Hid_MedInfo_@(MedDr["UD_SEQPK"].ToString().Trim())" id="Hid_MedInfo_@(MedDr["UD_SEQPK"].ToString().Trim())" value="@(LongList[g].MED_CODE)" />
                                            DateTime DRUG_DATE = Convert.ToDateTime(MedDr["DRUG_DATE"].ToString().Trim());
                                            string HourTmp = DRUG_DATE.Hour.ToString() != "0" ? DRUG_DATE.Hour.ToString() : "24";
                                            if (DRUG_DATE < MustTime && MedDr["EXEC_DATE"].ToString().Trim() == "")
                                            {
                                                TimeArray.Add(new string[] { HourTmp, "RedBox", MedDr["UD_SEQPK"].ToString().Trim() });
                                                BackInsideColor = "#EA9999";
                                            }
                                            else if (DRUG_DATE > EarlyTime && MedDr["EXEC_DATE"].ToString().Trim() == "")
                                            {//提早給藥
                                                TimeArray.Add(new string[] { HourTmp, "WhiteEarlyBox", MedDr["UD_SEQPK"].ToString().Trim() });
                                            }
                                            else if (MedDr["REASONTYPE"].ToString().Trim() != "")//20191107 mod by allen 將if後段判斷修改 將當日判斷拿掉 讓判斷正常運作
                                            {//20160929 修改用藥紀錄顯示 mod by yungchen 未給藥加上時間判斷只出現實際給藥是今天的藥
                                                string PositionStr = MedDr["INSULIN_POSITION"].ToString().Trim() != "" ? "，胰島素施打部位：" + MedDr["INSULIN_POSITION"].ToString().Trim() : "";
                                                TimeArray.Add(new string[] { HourTmp, "BlueBox", "" });
                                                string cker = "";
                                                if (MedDr["CHECKER"] != null && MedDr["CHECKER"].ToString().Trim() != "")
                                                { cker = "，覆核者:" + MedDr["CHECKER"].ToString().Trim(); }
                                                MedArray.Add(string.Format("時間:{0}，未給予，執行者:{1}，原因：{2} {3}{4}{5}", MedDr["DRUG_DATE"].ToString().Trim(), MedDr["EXEC_NAME"].ToString().Trim() + cker, MedDr["REASONTYPE"].ToString().Trim() != "其他" ? MedDr["REASONTYPE"].ToString().Trim() : MedDr["NON_DRUG_OTHER"].ToString().Trim(), MedDr["P_NAME"].ToString().Trim(), MedDr["REMARK"].ToString().Trim() != "" ? "，備註：" + MedDr["REMARK"].ToString().Trim() : "", PositionStr));
                                            }
                                            else if (MedDr["EXEC_DATE"].ToString().Trim() != "" && Convert.ToDateTime(MedDr["EXEC_DATE"]).AddMinutes(-59).Date == Convert.ToDateTime(pStartDate).Date)
                                            {
                                                string ExecHourTmp = Convert.ToDateTime(MedDr["EXEC_DATE"].ToString().Trim()).Hour.ToString() != "0" ? Convert.ToDateTime(MedDr["EXEC_DATE"].ToString().Trim()).Hour.ToString() : "24";
                                                string DrugReasonStr = "";
                                                if (MedDr["REASON"].ToString().Trim() != "")
                                                {//延遲
                                                    DrugReasonStr = MedDr["P_NAME"].ToString().Trim() != "其他" ? "，延遲原因：" + MedDr["P_NAME"].ToString().Trim() : "，延遲原因：" + MedDr["DRUG_OTHER"].ToString().Trim();
                                                }
                                                else if (MedDr["EARLY_REASON"].ToString().Trim() != "")
                                                {//提早
                                                    DrugReasonStr = MedDr["EARLY_REASON"].ToString().Trim() != "其他" ? "，提早原因：" + MedDr["EARLY_REASON"].ToString().Trim() : "，提早原因：" + MedDr["DRUG_OTHER"].ToString().Trim();
                                                }
                                                TimeArray.Add(new string[] { ExecHourTmp, "NumberBoxCSS_SEL", "" });

                                            }
                                            else if (MedDr["EXEC_DATE"].ToString().Trim() != "" && (Convert.ToDateTime(MedDr["EXEC_DATE"]).Date == Convert.ToDateTime(pStartDate).Date || Convert.ToDateTime(MedDr["EXEC_DATE"]).AddMinutes(-59).Date == Convert.ToDateTime(pStartDate).Date))
                                            {
                                                string PositionStr = MedDr["INSULIN_POSITION"].ToString().Trim() != "" ? "，胰島素施打部位：" + MedDr["INSULIN_POSITION"].ToString().Trim() : "";
                                                string ExecHourTmp = Convert.ToDateTime(MedDr["EXEC_DATE"].ToString().Trim()).Hour.ToString() != "0" ? Convert.ToDateTime(MedDr["EXEC_DATE"].ToString().Trim()).Hour.ToString() : "24";
                                                string DrugReasonStr = "";
                                                if (MedDr["REASON"].ToString().Trim() != "")
                                                {//延遲
                                                    DrugReasonStr = MedDr["P_NAME"].ToString().Trim() != "其他" ? "，延遲原因：" + MedDr["P_NAME"].ToString().Trim() : "，延遲原因：" + MedDr["DRUG_OTHER"].ToString().Trim();
                                                }
                                                else if (MedDr["EARLY_REASON"].ToString().Trim() != "")
                                                {//提早
                                                    DrugReasonStr = MedDr["EARLY_REASON"].ToString().Trim() != "其他" ? "，提早原因：" + MedDr["EARLY_REASON"].ToString().Trim() : "，提早原因：" + MedDr["DRUG_OTHER"].ToString().Trim();
                                                }
                                                //--   MedArray.Add(string.Format("時間:{0}，給予劑量:{1}，執行者:{2}{3}{4}{5}", MedDr["EXEC_DATE"].ToString().Trim(), MedDr["USE_DOSE"].ToString().Trim() + " " + LongList[g].UD_UNIT, MedDr["EXEC_NAME"].ToString().Trim(), MedDr["P_NAME"].ToString().Trim() != "" ? "，延遲原因：" + MedDr["P_NAME"].ToString().Trim() : "", MedDr["REMARK"].ToString().Trim() != "" ? "，備註：" + MedDr["REMARK"].ToString().Trim() : "", PositionStr));

                                                UseDose += MedDr["USE_DOSE"].ToString().Trim() != "" ? double.Parse(MedDr["USE_DOSE"].ToString().Trim()) : 0;
                                            }
                                            //else if (MedDr["EXEC_DATE"].ToString().Trim() != "")
                                            //{
                                            //    string ExecHourTmp = Convert.ToDateTime(MedDr["EXEC_DATE"].ToString().Trim()).Hour.ToString() != "0" ? Convert.ToDateTime(MedDr["EXEC_DATE"].ToString().Trim()).Hour.ToString() : "24";
                                            //    string DrugReasonStr = "";
                                            //    if (MedDr["REASON"].ToString().Trim() != "")
                                            //    {//延遲
                                            //        DrugReasonStr = MedDr["P_NAME"].ToString().Trim() != "其他" ? "，延遲原因：" + MedDr["P_NAME"].ToString().Trim() : "，延遲原因：" + MedDr["DRUG_OTHER"].ToString().Trim();
                                            //    }
                                            //    else if (MedDr["EARLY_REASON"].ToString().Trim() != "")
                                            //    {//提早
                                            //        DrugReasonStr = MedDr["EARLY_REASON"].ToString().Trim() != "其他" ? "，提早原因：" + MedDr["EARLY_REASON"].ToString().Trim() : "，提早原因：" + MedDr["DRUG_OTHER"].ToString().Trim();
                                            //    }
                                            //    TimeArray.Add(new string[] { ExecHourTmp, "NumberBoxCSS_SEL", "" });
                                            //    MedArray.Add(string.Format("時間:{0}，給予劑量:{1}，執行者:{2}{3}{4}，胰島素施打部位：{5}", MedDr["EXEC_DATE"].ToString().Trim(), MedDr["USE_DOSE"].ToString().Trim() + " " + LongList[g].UD_UNIT, MedDr["EXEC_NAME"].ToString().Trim(), DrugReasonStr, MedDr["REMARK"].ToString().Trim() != "" ? "，備註：" + MedDr["REMARK"].ToString().Trim() : "", MedDr["INSULIN_POSITION"].ToString().Trim()));

                                            //    UseDose += MedDr["USE_DOSE"].ToString().Trim() != "" ? double.Parse(MedDr["USE_DOSE"].ToString().Trim()) : 0;
                                            //}
                                            else if (MedDr["EXEC_DATE"].ToString().Trim() == "") //20161214 修改 正常時間不會出現藥
                                            {
                                                TimeArray.Add(new string[] { HourTmp, "WhiteBox", MedDr["UD_SEQPK"].ToString().Trim() });

                                            }
                                            //20160929 修改用藥紀錄顯示 mod by yungchen
                                            //用藥紀錄顯示-規則:實際給藥時間亮燈,有亮燈的才會有用藥紀錄,藍色或綠色皆有用藥紀錄
                                            if (MedDr["EXEC_DATE"].ToString().Trim() != "")
                                            {
                                                string PositionStr = MedDr["INSULIN_POSITION"].ToString().Trim() != "" ? "，胰島素施打部位：" + MedDr["INSULIN_POSITION"].ToString().Trim() : "";
                                                string ExecHourTmp = Convert.ToDateTime(MedDr["EXEC_DATE"].ToString().Trim()).Hour.ToString() != "0" ? Convert.ToDateTime(MedDr["EXEC_DATE"].ToString().Trim()).Hour.ToString() : "24";
                                                string DrugReasonStr = "";
                                                string cker = "";
                                                if (MedDr["CHECKER"] != null && MedDr["CHECKER"].ToString().Trim() != "")
                                                { cker = "，覆核者:" + MedDr["CHECKER"].ToString().Trim(); }
                                                if (MedDr["REASON"].ToString().Trim() != "")
                                                {//延遲
                                                    DrugReasonStr = MedDr["P_NAME"].ToString().Trim() != "其他" ? "，延遲原因：" + MedDr["P_NAME"].ToString().Trim() : "，延遲原因：" + MedDr["DRUG_OTHER"].ToString().Trim();
                                                }
                                                else if (MedDr["EARLY_REASON"].ToString().Trim() != "")
                                                {//提早
                                                    DrugReasonStr = MedDr["EARLY_REASON"].ToString().Trim() != "其他" ? "，提早原因：" + MedDr["EARLY_REASON"].ToString().Trim() : "，提早原因：" + MedDr["DRUG_OTHER"].ToString().Trim();
                                                }
                                                if (MedDr["USE_DOSE"] != null && MedDr["USE_DOSE"].ToString() != "")
                                                {
                                                    //  MedArray.Add(string.Format("時間:{0}，給予劑量:{1}，執行者:{2}{3}{4}{5}", MedDr["EXEC_DATE"].ToString().Trim(), MedDr["USE_DOSE"].ToString().Trim() + " " + LongList[g].UD_UNIT, MedDr["EXEC_NAME"].ToString().Trim(), MedDr["P_NAME"].ToString().Trim() != "" ? "，延遲原因：" + MedDr["P_NAME"].ToString().Trim() : "", MedDr["REMARK"].ToString().Trim() != "" ? "，備註：" + MedDr["REMARK"].ToString().Trim() : "", PositionStr));
                                                    MedArray.Add(string.Format("時間:{0}，給予劑量:{1}，執行者:{2}{3}{4}{5}", MedDr["EXEC_DATE"].ToString().Trim(), MedDr["USE_DOSE"].ToString().Trim() + " " + LongList[g].UD_UNIT, MedDr["EXEC_NAME"].ToString().Trim() + cker, DrugReasonStr, MedDr["REMARK"].ToString().Trim() != "" ? "，備註：" + MedDr["REMARK"].ToString().Trim() : "", PositionStr));
                                                }
                                            }//if end
                                             //20160929 修改用藥紀錄顯示 mod by yungchen=======================
                                             //用藥紀錄顯示-規則:實際給藥時間亮燈,有亮燈的才會有用藥紀錄,藍色或綠色皆有用藥紀錄
                                        }//foe end
                                    }
                                    //計算長期醫囑是否有未給藥，一筆只要有一顆未給即可
                                    for (int x = 0; x <= TimeArray.Count - 1; x++)
                                    {
                                        if (TimeArray[x][1].IndexOf("RedBox") > -1 || TimeArray[x][1].IndexOf("WhiteBox") > -1)
                                        {
                                            LongUnExec++;
                                            continue;
                                        }
                                    }

                                    DateTime NullDay = Convert.ToDateTime("0001/01/01 00:00");
                                    DateTime DC_DAY = Convert.ToDateTime("0001/01/01 00:00");
                                    string begin = string.Format("{0}/{1}/{2} {3}:{4}", LongList[g].BEGIN_DATE.Substring(0, 3), LongList[g].BEGIN_DATE.Substring(3, 2), LongList[g].BEGIN_DATE.Substring(5, 2), LongList[g].BEGIN_TIME.Substring(0, 2), LongList[g].BEGIN_TIME.Substring(2, 2));
                                    string end = string.Format("{0}/{1}/{2} {3}:{4}", LongList[g].END_DATE.Substring(0, 3), LongList[g].END_DATE.Substring(3, 2), LongList[g].END_DATE.Substring(5, 2), LongList[g].END_TIME.Substring(0, 2), LongList[g].END_TIME.Substring(2, 2));
                                    System.Globalization.CultureInfo ToTWDay = new System.Globalization.CultureInfo("zh-TW");  //使用 1911 轉換民國及西元，會有閏年閏月問題  by wawa
                                    ToTWDay.DateTimeFormat.Calendar = new System.Globalization.TaiwanCalendar();
                                    DateTime BEGIN_DAY = DateTime.Parse(begin, ToTWDay);
                                    DateTime END_DAY = new DateTime();
                                    if (end != "000/00/00 00:00")
                                    { END_DAY = DateTime.Parse(end, ToTWDay); DC_DAY = END_DAY; }
                                    if (LongList[g].DC_DAY != null && LongList[g].DC_DAY.ToString().Trim() != "")
                                    { DC_DAY = Convert.ToDateTime(LongList[g].DC_DAY.Trim()); }
                                    //DC_DAY = Convert.ToDateTime("2016/9/29 21:21");END_DAY = Convert.ToDateTime("2016/9/29 21:21");  //測試用********************************************************************************************
                                    // BEGIN_DAY= Convert.ToDateTime("2016/8/26 11:21");  //測試用

                                    //過 DC 時間，底要變淺灰
                                    if (end != "000/00/00 00:00" && DateTime.Now > DC_DAY)
                                    {
                                        BackInsideColor = "#CCCCCC";
                                    }
                                }
                                <table style="width: 100%; border: 1px solid #fff; background-color: @(BackInsideColor);padding: 8px;">
                                    <tr>
                                        <td colspan="2" style="text-align:left;">
                                            <input type="hidden" id="HidMedInfo0_1_@(g)" name="HidMedInfo0_1_@(g)" value="@(LongList[g].MED_DESC)|@(LongList[g].ALISE_DESC)|@(string.Format("{0}/{1}/{2} {3}:{4}", LongList[g].BEGIN_DATE.Substring(0, 3), LongList[g].BEGIN_DATE.Substring(3, 2), LongList[g].BEGIN_DATE.Substring(5, 2), LongList[g].BEGIN_TIME.Substring(0, 2), LongList[g].BEGIN_TIME.Substring(2, 2)) + (LongList[g].END_DATE != "" ? "~" + string.Format("{0}/{1}/{2} {3}:{4}", LongList[g].END_DATE.Substring(0, 3), LongList[g].END_DATE.Substring(3, 2), LongList[g].END_DATE.Substring(5, 2), LongList[g].END_TIME.Substring(0, 2), LongList[g].END_TIME.Substring(2, 2)) : ""))|@(BEGIN_DAY.ToString("yyyy/MM/dd"))" />
                                            <input type="hidden" id="HidMedInfo0_2_@(g)" name="HidMedInfo0_2_@(g)" value="@(LongList[g].UD_DOSE + " " + LongList[g].UD_UNIT)|@(LongList[g].UD_PATH)|@(LongList[g].UD_CIR)" />
                                            藥名：
                                            @if (LongList[g].IsFRIDs == true)
                                            {
                                                <span style="background-color:yellow;color:red">@(LongList[g].MED_DESC)&nbsp;</span>
                                            }
                                            else
                                            {
                                                <span>@(LongList[g].MED_DESC)&nbsp;</span>
                                            }
                                            <span style="font-style:italic;color:brown;">@(LongList[g].ALISE_DESC)</span>&nbsp;(@(string.Format("{0}/{1}/{2} {3}:{4}", LongList[g].BEGIN_DATE.Substring(0, 3), LongList[g].BEGIN_DATE.Substring(3, 2), LongList[g].BEGIN_DATE.Substring(5, 2), LongList[g].BEGIN_TIME.Substring(0, 2), LongList[g].BEGIN_TIME.Substring(2, 2)) + (LongList[g].END_DATE != "" ? "~" + string.Format("{0}/{1}/{2} {3}:{4}", LongList[g].END_DATE.Substring(0, 3), LongList[g].END_DATE.Substring(3, 2), LongList[g].END_DATE.Substring(5, 2), LongList[g].END_TIME.Substring(0, 2), LongList[g].END_TIME.Substring(2, 2)) : "")))
                                        </td>
                                    </tr>
                                    <tr>
                                        @if (LongList[g].DrugPicPath != null && LongList[g].DrugPicPath.Trim() != "")
                                        {
                                            <td style="width:120px">
                                                <img id="Img0_@(g)" src="@(LongList[g].DrugPicPath)" style="width:100px;height:100px" onclick="pup_window('med_pharmacopoeia?MedCode=@(LongList[g].MED_CODE)');" />
                                            </td>
                                        }
                                        else
                                        {
                                            <td style="width:120px">
                                                <img id="Img0_@(g)" src="\\CORA\TextData\DrugImage\NoImage.JPG" style="width:100px;height:100px" onclick="pup_window('med_pharmacopoeia?MedCode=@(LongList[g].MED_CODE)');" />
                                            </td>
                                        }
                                        <td style="width:1500px">
                                            <table style="width: 98%; border: 1px solid #fff; background-color: @(BackInsideColor); " cellspacing="0">
                                                <tr>
                                                    <td colspan="2" style="width: 15%; border: 1px solid #fff;">劑量：@(LongList[g].UD_DOSE + " " + LongList[g].UD_UNIT)</td>
                                                    @{if (LongList[g].UD_PATH.Contains("AO"))
                                                        {
                                                            <td rowspan="2" style="width: 20%;color:green; border: 1px solid #fff">備註：@(LongList[g].UD_CMD)</td>
                                                        }
                                                        else
                                                        {
                                                            <td rowspan="2" style="width: 20%; border: 1px solid #fff">
                                                                備註：@(LongList[g].UD_CMD)
                                                                @if (LongList[g].IsFRIDs == true)
                                                                {
                                                                    <span>(易跌藥品)</span>
                                                                }
                                                            </td>
                                                        }
                                                    }
                                                    <td rowspan="2" style="width: 65%; border: 1px solid #fff">
                                                        <div id="Pn0_@(g)">
                                                            @{
                                                                List<string[]> TimeCollect = new List<string[]>();
                                                            }
                                                            @for (var t = 1; t <= 24; t++)
                                                            {
                                                                @*-----2016/09/06新增顏色優先順序判斷*@
                                                                string FillColor = "";
                                                                if (TimeArray.Any(x => x[0] == t.ToString() && x[1] == "RedBox")) { FillColor = "RedBox"; }
                                                                else if (TimeArray.Any(x => x[0] == t.ToString() && x[1] == "BlueBox")) { FillColor = "BlueBox"; }
                                                                else if (TimeArray.Any(x => x[0] == t.ToString() && x[1] == "NumberBoxCSS_SEL")) { FillColor = "NumberBoxCSS_SEL"; }
                                                                if (FillColor != "")
                                                                { TimeCollect = TimeArray.Where(x => x[0] == t.ToString() && x[1] == FillColor).ToList(); }
                                                                else
                                                                { TimeCollect = TimeArray.Where(x => x[0] == t.ToString()).ToList(); }
                                                                @*-----*@
                                                                if (TimeCollect != null && TimeCollect.Count > 0)
                                                                {

                                                                    <div id="Long_@(g)_@(t)" row="@(g)" ud="0" tm="@(t)" cktype="@(LongList[g].DoubleCheck)" drtype="@(LongList[g].DRUG_TYPE)" udtype="@(LongList[g].UD_TYPE)" seq="@(TimeCollect[0][2])" totaldose="@(TotalDose)" usedose="@(UseDose)" class="@(TimeCollect[0][1])">@(t)</div>
                                                                    if (t == 12)
                                                                    {
                                                                        <br />
                                                                    }
                                                                }
                                                                else
                                                                {
                                                                    <div id="Long_@(g)_@(t)" row="@(g)" ud="0" tm="@(t)" cktype="@(LongList[g].DoubleCheck)" drtype="@(LongList[g].DRUG_TYPE)" udtype="@(LongList[g].UD_TYPE)" totaldose="@(TotalDose)" usedose="@(UseDose)" class="NumberBoxCSS">@(t)</div>
                                                                    if (t == 12)
                                                                    {
                                                                        <br />
                                                                    }
                                                                }
                                                            }
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td style="border: 1px solid #fff">@(LongList[g].UD_PATH)</td>
                                                    <td style="border: 1px solid #fff">@(LongList[g].UD_CIR)</td>
                                                </tr>
                                            </table>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td colspan="2" style="text-align:left;">
                                            <input type="button" style="float:right;" value="特殊註記" onclick="OpenRemark('0','@(g)');" />
                                            <div id="div0@(g)img" tagto="Hide" onclick="DisShowFunc(this, 'div0@(g)');">
                                                用藥紀錄
                                                <img src="../images/nolines_plus.gif" style="margin-bottom:-6px" />
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td colspan="2" style="text-align:left;">
                                            <div id="div0@(g)" style="border: 1px solid #fff; background-color: #DDDDDD; text-align: left; padding-left: 20px; display:none;">
                                                @if (MedArray != null && MedArray.Count > 0)
                                                {
                                                    for (int k = 0; k < MedArray.Count; k++)
                                                    {
                                                        <div>
                                                            <label>@(MedArray[k])</label>
                                                        </div>
                                                    }
                                                }
                                                else
                                                {
                                                    @:
                                                    <label>尚無用藥紀錄!</label>
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td>
                                尚無資料!
                            </td>
                        </tr>
                    }
            </table>
        </div>
        <!-- PRN醫囑 -->
        <div id="tabs-2" class="tab">
            <table>
                @if (PRNList != null && PRNList.Count > 0)
                {
                    PRNUnExec = 0;
                    for (int g = 0; g < PRNList.Count; g++)
                    {
                        TotalDose = 0;
                        UseDose = 0;
                        <tr>
                            <td>
                                @{
                                    DataTable MedPRNDt = cm.FiltData(PRNDt, "UD_SEQ='" + PRNList[g].UD_SEQ + "'");
                                    List<string[]> TimeArray = new List<string[]>();
                                    List<int> ExecPRNTimeArray = new List<int>();
                                    List<string> MedArray = new List<string>();
                                    string BackInsideColor = "#FFE599";
                                    Double n;
                                    TotalDose = Double.TryParse(PRNList[g].UD_DOSE, out n) ? n : 0.0;
                                    if (MedPRNDt != null && MedPRNDt.Rows.Count > 0)
                                    {
                                        foreach (DataRow MedPRNDr in MedPRNDt.Rows)
                                        {//備：基本上 PRN 不會有 提早、過時，及展藥的白框，PRN 為強制排滿 24 小時
                                         //下面這行被註解的原因：恩主公 8/23 問題清單裡 Q12 提出，給過後應該要可以再給，原文：Q12:下圖的點滴點了7點按鈕，但時記時間是14點，存檔後14點是綠色沒錯，但是7點也不能按了，應該要維持可按才對。  by wawa
                                         //ExecPRNTimeArray.Add(Convert.ToInt32(Convert.ToDateTime(MedPRNDr["DRUG_DATE"].ToString()).ToString("HH")));  //記錄 PRN 哪些時間已給藥，則在顯示時需取消框框
                                            DateTime DRUG_DATE = Convert.ToDateTime(MedPRNDr["DRUG_DATE"].ToString().Trim());
                                            string TmpRemarkData = string.Format("{0}|{1}|{2}|P", MedPRNDr["REMARK"].ToString().Trim(), DRUG_DATE.Hour.ToString(), "0");
                                            string CareData = string.Format("{0}|{1}|{2}|{3}|{4}|{5}", MedPRNDr["REMARK"].ToString().Trim(), PRNList[g].UD_DOSE, PRNList[g].UD_PATH, PRNList[g].UD_CIR, PRNList[g].MED_DESC, PRNList[g].UD_CMD);
                                            string InsulinData = string.Format("{0}|{1}", PRNList[g].DRUG_TYPE, MedPRNDr["POSITION"].ToString().Trim());
                                            <input type="hidden" name="Hf_@(MedPRNDr["UD_SEQPK"].ToString().Trim())" id="Hf_@(MedPRNDr["UD_SEQPK"].ToString().Trim())" value="@(TmpRemarkData)" />
                                            <input type="hidden" name="Hf_Care_@(MedPRNDr["UD_SEQPK"].ToString().Trim())" id="Hf_Care_@(MedPRNDr["UD_SEQPK"].ToString().Trim())" value="@(CareData)" />
                                            <input type="hidden" name="Hf_Insulin_@(MedPRNDr["UD_SEQPK"].ToString().Trim())" id="Hf_Insulin_@(MedPRNDr["UD_SEQPK"].ToString().Trim())" value="@(InsulinData)" />
                                            <input type="hidden" name="Hf_DoubleCheck_@(MedPRNDr["UD_SEQPK"].ToString().Trim())" id="Hf_DoubleCheck_@(MedPRNDr["UD_SEQPK"].ToString().Trim())" value="@(PRNList[g].DoubleCheck)" />
                                            string HourTmp = DRUG_DATE.Hour.ToString() != "0" ? DRUG_DATE.Hour.ToString() : "24";
                                            if (MedPRNDr["EXEC_DATE"].ToString().Trim() == "")  //if (DRUG_DATE < MustTime && MedPRNDr["EXEC_DATE"].ToString().Trim() == "")
                                            {
                                                TimeArray.Add(new string[] { HourTmp, "White24Box", MedPRNDr["UD_SEQPK"].ToString().Trim() });
                                                BackInsideColor = "#EA9999";
                                            }//20161007 mod by yungchen 增加24點的條件判斷
                                            else if (MedPRNDr["REASONTYPE"].ToString().Trim() != "" && (Convert.ToDateTime(MedPRNDr["EXEC_DATE"]).Date == Convert.ToDateTime(pStartDate).Date))
                                            {//20160929 修改用藥紀錄顯示 mod by yungchen 未給藥加上時間判斷只出現實際給藥是今天的藥
                                                string PositionStr = MedPRNDr["INSULIN_POSITION"].ToString().Trim() != "" ? "，胰島素施打部位：" + MedPRNDr["INSULIN_POSITION"].ToString().Trim() : "";
                                                string cker = "";
                                                if (MedPRNDr["CHECKER"] != null && MedPRNDr["CHECKER"].ToString().Trim() != "")
                                                { cker = "，覆核者:" + MedPRNDr["CHECKER"].ToString().Trim(); }
                                                TimeArray.Add(new string[] { HourTmp, "BlueBox", "" });
                                                MedArray.Add(string.Format("時間:{0}，未給予，執行者:{1}，原因：{2} {3}{4}{5}", MedPRNDr["DRUG_DATE"].ToString().Trim(), MedPRNDr["EXEC_NAME"].ToString().Trim() + cker, MedPRNDr["REASONTYPE"].ToString().Trim(), MedPRNDr["P_NAME"].ToString().Trim(), MedPRNDr["REMARK"].ToString().Trim() != "" ? "，備註：" + MedPRNDr["REMARK"].ToString().Trim() : "", PositionStr));
                                            }
                                            else if (MedPRNDr["EXEC_DATE"].ToString().Trim() != "" && Convert.ToDateTime(MedPRNDr["EXEC_DATE"]).AddMinutes(-59).Date == Convert.ToDateTime(pStartDate).Date)
                                            {
                                                string ExecHourTmp = Convert.ToDateTime(MedPRNDr["EXEC_DATE"].ToString().Trim()).Hour.ToString() != "0" ? Convert.ToDateTime(MedPRNDr["EXEC_DATE"].ToString().Trim()).Hour.ToString() : "24";
                                                TimeArray.Add(new string[] { ExecHourTmp, "NumberBoxCSS_SEL", "" });
                                            }
                                            if (MedPRNDr["EXEC_DATE"].ToString().Trim() != "" && (Convert.ToDateTime(MedPRNDr["EXEC_DATE"]).Date == Convert.ToDateTime(pStartDate).Date || Convert.ToDateTime(MedPRNDr["EXEC_DATE"]).AddMinutes(-59).Date == Convert.ToDateTime(pStartDate).Date))
                                            {//20160929 修改用藥紀錄顯示 mod by yungchen 已給藥只出現實際給藥時間為今天的藥
                                                string PositionStr = MedPRNDr["INSULIN_POSITION"].ToString().Trim() != "" ? "，胰島素施打部位：" + MedPRNDr["INSULIN_POSITION"].ToString().Trim() : "";
                                                string cker = "";
                                                if (MedPRNDr["CHECKER"] != null && MedPRNDr["CHECKER"].ToString().Trim() != "")
                                                { cker = "，覆核者:" + MedPRNDr["CHECKER"].ToString().Trim(); }
                                                string ExecHourTmp = Convert.ToDateTime(MedPRNDr["EXEC_DATE"].ToString().Trim()).Hour.ToString() != "0" ? Convert.ToDateTime(MedPRNDr["EXEC_DATE"].ToString().Trim()).Hour.ToString() : "24";
                                                MedArray.Add(string.Format("時間:{0}，給予劑量:{1}，執行者:{2}{3}{4}", MedPRNDr["EXEC_DATE"].ToString().Trim(), MedPRNDr["USE_DOSE"].ToString().Trim() + " " + PRNList[g].UD_UNIT, MedPRNDr["EXEC_NAME"].ToString().Trim() + cker, MedPRNDr["REMARK"].ToString().Trim() != "" ? "，備註：" + MedPRNDr["REMARK"].ToString().Trim() : "", PositionStr));

                                                UseDose += MedPRNDr["USE_DOSE"].ToString().Trim() != "" ? double.Parse(MedPRNDr["USE_DOSE"].ToString().Trim()) : 0;
                                            }
                                            //else if (MedPRNDr["EXEC_DATE"].ToString().Trim() != "" && Convert.ToDateTime(MedPRNDr["EXEC_DATE"]).Date == Convert.ToDateTime(pStartDate).Date)
                                            //{
                                            //    string ExecHourTmp = Convert.ToDateTime(MedPRNDr["EXEC_DATE"].ToString().Trim()).Hour.ToString() != "0" ? Convert.ToDateTime(MedPRNDr["EXEC_DATE"].ToString().Trim()).Hour.ToString() : "24";
                                            //    TimeArray.Add(new string[] { ExecHourTmp, "NumberBoxCSS_SEL", "" });
                                            //    MedArray.Add(string.Format("時間:{0}，給予劑量:{1}，執行者:{2}{3}，胰島素施打部位：{4}", MedPRNDr["EXEC_DATE"].ToString().Trim(), PRNList[g].UD_DOSE + " " + PRNList[g].UD_UNIT, MedPRNDr["EXEC_NAME"].ToString().Trim(), MedPRNDr["REMARK"].ToString().Trim() != "" ? "，備註：" + MedPRNDr["REMARK"].ToString().Trim() : "", MedPRNDr["INSULIN_POSITION"].ToString().Trim()));

                                            //    UseDose += MedPRNDr["USE_DOSE"].ToString().Trim() != "" ? double.Parse(MedPRNDr["USE_DOSE"].ToString().Trim()) : 0;
                                            //}
                                        }
                                    }

                                    int PRNTmp = 0;  //計算 PRN 醫囑是否有未給藥，一筆只要有一顆符合未給即可，未給規則為 現在時間前後一小時

                                    DateTime NullDay = Convert.ToDateTime("0001/01/01 00:00");
                                    DateTime DC_DAY = Convert.ToDateTime("0001/01/01 00:00");
                                    string begin = string.Format("{0}/{1}/{2} {3}:{4}", PRNList[g].BEGIN_DATE.Substring(0, 3), PRNList[g].BEGIN_DATE.Substring(3, 2), PRNList[g].BEGIN_DATE.Substring(5, 2), PRNList[g].BEGIN_TIME.Substring(0, 2), PRNList[g].BEGIN_TIME.Substring(2, 2));
                                    string end = string.Format("{0}/{1}/{2} {3}:{4}", PRNList[g].END_DATE.Substring(0, 3), PRNList[g].END_DATE.Substring(3, 2), PRNList[g].END_DATE.Substring(5, 2), PRNList[g].END_TIME.Substring(0, 2), PRNList[g].END_TIME.Substring(2, 2));
                                    System.Globalization.CultureInfo ToTWDay = new System.Globalization.CultureInfo("zh-TW");  //使用 1911 轉換民國及西元，會有閏年閏月問題  by wawa
                                    ToTWDay.DateTimeFormat.Calendar = new System.Globalization.TaiwanCalendar();
                                    DateTime BEGIN_DAY = DateTime.Parse(begin, ToTWDay);
                                    DateTime END_DAY = new DateTime();
                                    if (end != "000/00/00 00:00")
                                    { END_DAY = DateTime.Parse(end, ToTWDay); DC_DAY = END_DAY; }
                                    if (PRNList[g].DC_DAY != null && PRNList[g].DC_DAY.ToString().Trim() != "")
                                    { DC_DAY = Convert.ToDateTime(PRNList[g].DC_DAY.Trim()); }

                                    //過 DC 時間，底要變淺灰
                                    if (end != "000/00/00 00:00" && DateTime.Now > DC_DAY)
                                    {
                                        BackInsideColor = "#CCCCCC";
                                    }
                                    //if (Convert.ToDateTime(pStartDate).Date >= BEGIN_DAY.Date && (end == "000/00/00 00:00" || END_DAY.Date >= Convert.ToDateTime(pStartDate).Date))
                                    //{//在期限內的藥才顯示
                                    <table style="width: 100%; border: 1px solid #fff; background-color: @(BackInsideColor);padding: 8px;">
                                        <tr>
                                            <td colspan="2" style="text-align:left;">
                                                <input type="hidden" id="HidMedInfo1_1_@(g)" name="HidMedInfo1_1_@(g)" value="@(PRNList[g].MED_DESC)|@(PRNList[g].ALISE_DESC)|@(string.Format("{0}/{1}/{2} {3}:{4}", PRNList[g].BEGIN_DATE.Substring(0, 3), PRNList[g].BEGIN_DATE.Substring(3, 2), PRNList[g].BEGIN_DATE.Substring(5, 2), PRNList[g].BEGIN_TIME.Substring(0, 2), PRNList[g].BEGIN_TIME.Substring(2, 2)) + (PRNList[g].END_DATE != "" ? "~" + string.Format("{0}/{1}/{2} {3}:{4}", PRNList[g].END_DATE.Substring(0, 3), PRNList[g].END_DATE.Substring(3, 2), PRNList[g].END_DATE.Substring(5, 2), PRNList[g].END_TIME.Substring(0, 2), PRNList[g].END_TIME.Substring(2, 2)) : ""))|@(BEGIN_DAY.ToString("yyyy/MM/dd"))" />
                                                <input type="hidden" id="HidMedInfo1_2_@(g)" name="HidMedInfo1_2_@(g)" value="@(PRNList[g].UD_DOSE + " " + PRNList[g].UD_UNIT)|@(PRNList[g].UD_PATH)|@(PRNList[g].UD_CIR)" />
                                                藥名：
                                                @if (PRNList[g].IsFRIDs == true)
                                                {
                                                    <span style="background-color:yellow;color:red">@(PRNList[g].MED_DESC)&nbsp;</span>
                                                }
                                                else
                                                {
                                                    <span>@(PRNList[g].MED_DESC)&nbsp;</span>
                                                }
                                                <span style="font-style:italic;color:brown;">@(PRNList[g].ALISE_DESC)</span>&nbsp;(@(string.Format("{0}/{1}/{2} {3}:{4}", PRNList[g].BEGIN_DATE.Substring(0, 3), PRNList[g].BEGIN_DATE.Substring(3, 2), PRNList[g].BEGIN_DATE.Substring(5, 2), PRNList[g].BEGIN_TIME.Substring(0, 2), PRNList[g].BEGIN_TIME.Substring(2, 2)) + (PRNList[g].END_DATE != "" ? "~" + string.Format("{0}/{1}/{2} {3}:{4}", PRNList[g].END_DATE.Substring(0, 3), PRNList[g].END_DATE.Substring(3, 2), PRNList[g].END_DATE.Substring(5, 2), PRNList[g].END_TIME.Substring(0, 2), PRNList[g].END_TIME.Substring(2, 2)) : "")))
                                            </td>
                                        </tr>
                                        <tr>
                                            @if (PRNList[g].DrugPicPath != null && PRNList[g].DrugPicPath.Trim() != "")
                                            {
                                                <td style="width:120px">
                                                    <img id="Img1_@(g)" src="@(PRNList[g].DrugPicPath)" style="width:100px;height:100px" onclick="pup_window('med_pharmacopoeia?MedCode=@(PRNList[g].MED_CODE)');" />
                                                </td>
                                            }
                                            else
                                            {
                                                <td style="width:120px">
                                                    <img id="Img1_@(g)" src="\\CORA\TextData\DrugImage\NoImage.JPG" style="width:100px;height:100px" onclick="pup_window('med_pharmacopoeia?MedCode=@(PRNList[g].MED_CODE)');" />
                                                </td>
                                            }
                                            <td style="width:1500px">
                                                <table style="width: 98%; border: 1px solid #fff; background-color: @(BackInsideColor); " cellspacing="0">
                                                    <tr>
                                                        <td colspan="2" style="width: 15%; border: 1px solid #fff;">劑量：@(PRNList[g].UD_DOSE + " " + PRNList[g].UD_UNIT)</td>
                                                        @{if (PRNList[g].UD_PATH.Contains("AO"))
                                                            {
                                                                <td rowspan="2" style="width: 20%;color:green; border: 1px solid #fff">
                                                                    備註：@(PRNList[g].UD_CMD)
                                                                    @if (PRNList[g].IsFRIDs == true)
                                                                    {
                                                                        <span>(易跌藥品)</span>
                                                                    }
                                                                </td>
                                                            }
                                                            else
                                                            {
                                                                <td rowspan="2" style="width: 20%; border: 1px solid #fff">
                                                                    備註：@(PRNList[g].UD_CMD)
                                                                    @if (PRNList[g].IsFRIDs == true)
                                                                    {
                                                                        <span>(易跌藥品)</span>
                                                                    }
                                                                </td>
                                                            }
                                                        }
                                                        <td rowspan="2" style="width: 65%; border: 1px solid #fff">
                                                            <div id="Pn1_@(g)">
                                                                @{

                                                                    for (var t = 1; t <= 24; t++)
                                                                    {
                                                                        List<string[]> TimeCollect = TimeArray.Where(x => x[0] == t.ToString()).ToList();

                                                                        if (TimeCollect != null && TimeCollect.Count > 0)
                                                                        {//已給藥
                                                                            <div id="PRN_@(g)_@(t)" row="@(g)" ud="1" tm="@(t)" cktype="@(PRNList[g].DoubleCheck)" drtype="@(PRNList[g].DRUG_TYPE)" udtype="@(PRNList[g].UD_TYPE)" seq="@(TimeCollect[0][2])" totaldose="@(TotalDose)" usedose="@(UseDose)" class="@(TimeCollect[0][1])">@(t)</div>
                                                                            if (t == 12)
                                                                            {
                                                                                <br />
                                                                            }
                                                                        }
                                                                        else
                                                                        {//未給藥
                                                                            int tTmp = 0;
                                                                            DateTime Border_DATE = new DateTime();
                                                                            if (t == 24)
                                                                            {
                                                                                tTmp = 0;
                                                                                Border_DATE = Convert.ToDateTime(Convert.ToDateTime(pStartDate).AddDays(1).ToString("yyyy/MM/dd") + " " + tTmp.ToString().PadLeft(2, '0') + ":00");
                                                                            }
                                                                            else
                                                                            {
                                                                                tTmp = t;
                                                                                Border_DATE = Convert.ToDateTime(pStartDate + " " + tTmp.ToString().PadLeft(2, '0') + ":00");
                                                                            }
                                                                            string ClassNameTmp = "White24Box";  //PRN 白框獨立，因為 PRN 24小時強制跳註記
                                                                            for (int e = 0; e <= ExecPRNTimeArray.Count - 1; e++)
                                                                            {
                                                                                if (t == ExecPRNTimeArray[e])
                                                                                {  //符合已給藥之 DRUG_DATE，則不可再給第二次藥
                                                                                    ClassNameTmp = "NumberBoxCSS";
                                                                                    break;
                                                                                }
                                                                            }
                                                                            if ((Border_DATE > DC_DAY && DC_DAY != NullDay) || Border_DATE < BEGIN_DAY.AddHours(-1))
                                                                            {//過 DC 時間又未給藥 灰底
                                                                             //20160906 mod by yungchen 減一小時若開始時間為13:10 則13的格子還是要可以點 並改為白底
                                                                                ClassNameTmp = "OverDCDateBox";
                                                                            }
                                                                            if (Border_DATE <= DateTime.Now.AddHours(+1) && Border_DATE >= DateTime.Now.AddHours(-1))
                                                                            { //現在時間前後一小時，需顯示星星
                                                                                if (ClassNameTmp == "White24Box")
                                                                                {
                                                                                    PRNTmp = 1;
                                                                                }
                                                                            }
                                                                            <div id="PRN_@(g)_@(t)" row="@(g)" ud="1" tm="@(t)" cktype="@(PRNList[g].DoubleCheck)" drtype="@(PRNList[g].DRUG_TYPE)" udtype="@(PRNList[g].UD_TYPE)" seq="TmpPRN_@(PRNList[g].UD_SEQ)_@(t)" totaldose="@(TotalDose)" usedose="@(UseDose)" class="@(ClassNameTmp)">@(t)</div>
                                                                            if (t == 12)
                                                                            {
                                                                                <br />
                                                                            }
                                                                            <input type="hidden" name="Hf_TmpPRN_@(PRNList[g].UD_SEQ)_@(t)" id="Hf_TmpPRN_@(PRNList[g].UD_SEQ)_@(t)" value="|@(t)|0|P" />
                                                                            <input type="hidden" name="Hf_Care_TmpPRN_@(PRNList[g].UD_SEQ)_@(t)" id="Hf_Care_TmpPRN_@(PRNList[g].UD_SEQ)_@(t)" value="|@(PRNList[g].UD_DOSE)|@(PRNList[g].UD_PATH)|@(PRNList[g].UD_CIR)|@(PRNList[g].MED_DESC)|@(PRNList[g].UD_CMD)|@(PRNList[g].UD_UNIT)" />
                                                                            <input type="hidden" name="Hid_MedInfo_TmpPRN_@(PRNList[g].UD_SEQ)_@(t)" id="Hid_MedInfo_TmpPRN_@(PRNList[g].UD_SEQ)_@(t)" value="@(PRNList[g].MED_CODE)" />
                                                                            <input type="hidden" name="Hf_Insulin_TmpPRN_@(PRNList[g].UD_SEQ)_@(t)" id="Hf_Insulin_TmpPRN_@(PRNList[g].UD_SEQ)_@(t)" value="@(PRNList[g].DRUG_TYPE)|" />
                                                                            <input type="hidden" name="Hf_DoubleCheck_TmpPRN_@(PRNList[g].UD_SEQ)_@(t)" id="Hf_DoubleCheck_TmpPRN_@(PRNList[g].UD_SEQ)_@(t)" value="@(PRNList[g].DoubleCheck)" />
                                                                        }
                                                                    }
                                                                    PRNUnExec += PRNTmp;
                                                                }
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td style="border: 1px solid #fff">@(PRNList[g].UD_PATH)</td>
                                                        <td style="border: 1px solid #fff">@(PRNList[g].UD_CIR)</td>
                                                    </tr>
                                                </table>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" style="text-align:left;">
                                                <input type="button" style="float:right;" value="特殊註記" onclick="OpenRemark('1','@(g)');" />
                                                <div id="div1@(g)img" tagto="Hide" onclick="DisShowFunc(this, 'div1@(g)');">
                                                    用藥紀錄
                                                    <img src="../images/nolines_plus.gif" style="margin-bottom:-6px" />
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" style="text-align:left;">
                                                <div id="div1@(g)" style="border: 1px solid #fff; background-color: #DDDDDD; text-align: left; padding-left: 20px; display:none;">
                                                    @if (MedArray != null && MedArray.Count > 0)
                                                    {
                                                        for (int k = 0; k < MedArray.Count; k++)
                                                        {
                                                            <div>
                                                                <label>@(MedArray[k])</label>
                                                            </div>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        @:
                                                        <label>尚無用藥紀錄!</label>
                                                    }
                                                </div>
                                            </td>
                                        </tr>
                                    </table>
                                                                    //}
                                }
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td>
                            尚無資料!
                        </td>
                    </tr>
                }
            </table>
        </div>
        <!-- 臨時醫囑 -->
        <div id="tabs-3" class="tab">
            <table>
                @if (StatList != null && StatList.Count > 0)
                {
                    StatUnExec = 0;
                    for (int g = 0; g < StatList.Count; g++)
                    {
                        TotalDose = 0;
                        UseDose = 0;
                        <tr>
                            <td>
                                @{
                                    DataTable MedStatDt = cm.FiltData(StatDt, "UD_SEQ='" + StatList[g].UD_SEQ + "'");
                                    List<string[]> TimeArray = new List<string[]>();
                                    List<string> MedArray = new List<string>();
                                    string BackInsideColor = "#FFE599";
                                    Double n;
                                    TotalDose = Double.TryParse(StatList[g].UD_DOSE, out n) ? double.Parse(StatList[g].UD_DOSE) : 0.0;
                                    if (MedStatDt != null && MedStatDt.Rows.Count > 0)
                                    {
                                        foreach (DataRow MedStatDr in MedStatDt.Rows)
                                        {
                                            string TmpRemarkData = string.Format("{0}|{1}|{2}|{3}|{4}|{5}|{6}|{7}|{8}|{9}", (MedStatDr["EXEC_DATE"].ToString().Trim() != "" ? Convert.ToDateTime(MedStatDr["EXEC_DATE"].ToString().Trim()).ToString("yyyy/MM/dd") : DateTime.Now.ToString("yyyy/MM/dd")), (MedStatDr["EXEC_DATE"].ToString().Trim() != "" ? Convert.ToDateTime(MedStatDr["EXEC_DATE"].ToString().Trim()).ToString("HH:mm") : DateTime.Now.ToString("HH:mm")), StatList[g].UD_CMD, MedStatDr["USE_DOSE"].ToString().Trim() != "" && Convert.ToDecimal(MedStatDr["USE_DOSE"].ToString().Trim()) > 0 ? MedStatDr["USE_DOSE"].ToString().Trim() : StatList[g].UD_DOSE, MedStatDr["REASONTYPE"].ToString().Trim(), MedStatDr["REASON"].ToString().Trim(), MedStatDr["REMARK"].ToString().Trim(), "0", "0", "S");
                                            string CareData = string.Format("{0}|{1}|{2}|{3}|{4}|{5}|{6}|{7}", MedStatDr["REMARK"].ToString().Trim(), MedStatDr["USE_DOSE"].ToString().Trim() != "" && Convert.ToDecimal(MedStatDr["USE_DOSE"].ToString().Trim()) > 0 ? MedStatDr["USE_DOSE"].ToString().Trim() : StatList[g].UD_DOSE, StatList[g].UD_PATH, StatList[g].UD_CIR, MedStatDr["REASONTYPE"].ToString().Trim(), StatList[g].MED_DESC, MedStatDr["P_NAME"].ToString().Trim(), StatList[g].UD_UNIT);
                                            string InsulinData = string.Format("{0}|{1}", StatList[g].DRUG_TYPE, MedStatDr["POSITION"].ToString().Trim());
                                            <input type="hidden" name="Hf_@(MedStatDr["UD_SEQPK"].ToString().Trim())" id="Hf_@(MedStatDr["UD_SEQPK"].ToString().Trim())" value="@(TmpRemarkData)" />
                                            <input type="hidden" name="Hf_Care_@(MedStatDr["UD_SEQPK"].ToString().Trim())" id="Hf_Care_@(MedStatDr["UD_SEQPK"].ToString().Trim())" value="@(CareData)" />
                                            <input type="hidden" name="Hf_Insulin_@(MedStatDr["UD_SEQPK"].ToString().Trim())" id="Hf_Insulin_@(MedStatDr["UD_SEQPK"].ToString().Trim())" value="@(InsulinData)" />
                                            <input type="hidden" name="Hf_DoubleCheck_@(MedStatDr["UD_SEQPK"].ToString().Trim())" id="Hf_DoubleCheck_@(MedStatDr["UD_SEQPK"].ToString().Trim())" value="@(StatList[g].DoubleCheck)" />
                                            DateTime DRUG_DATE = Convert.ToDateTime(MedStatDr["DRUG_DATE"].ToString().Trim());
                                            string HourTmp = DRUG_DATE.Hour.ToString() != "0" ? DRUG_DATE.Hour.ToString() : "24";
                                            if (DRUG_DATE < MustTime && MedStatDr["EXEC_DATE"].ToString().Trim() == "")
                                            {
                                                TimeArray.Add(new string[] { HourTmp, "RedBox", MedStatDr["UD_SEQPK"].ToString().Trim() });
                                                BackInsideColor = "#EA9999";
                                            }
                                            else if (MedStatDr["REASONTYPE"].ToString().Trim() != "" && Convert.ToDateTime(MedStatDr["EXEC_DATE"].ToString()).Date == Convert.ToDateTime(pStartDate).Date)
                                            {//20160929 修改用藥紀錄顯示 mod by yungchen 未給藥加上時間判斷只出現實際給藥是今天的藥
                                                string PositionStr = MedStatDr["INSULIN_POSITION"].ToString().Trim() != "" ? "，胰島素施打部位：" + MedStatDr["INSULIN_POSITION"].ToString().Trim() : "";
                                                string cker = "";
                                                if (MedStatDr["CHECKER"] != null && MedStatDr["CHECKER"].ToString().Trim() != "")
                                                { cker = "，覆核者:" + MedStatDr["CHECKER"].ToString().Trim(); }
                                                TimeArray.Add(new string[] { HourTmp, "BlueBox", "" });
                                                MedArray.Add(string.Format("時間:{0}，未給予，執行者:{1}，原因：{2} {3}{4}{5}", MedStatDr["DRUG_DATE"].ToString().Trim(), MedStatDr["EXEC_NAME"].ToString().Trim() + cker, MedStatDr["REASONTYPE"].ToString().Trim(), MedStatDr["P_NAME"].ToString().Trim(), MedStatDr["REMARK"].ToString().Trim() != "" ? "，備註：" + MedStatDr["REMARK"].ToString().Trim() : "", PositionStr));
                                            }
                                            else if (MedStatDr["EXEC_DATE"].ToString().Trim() != "" && (Convert.ToDateTime(MedStatDr["EXEC_DATE"]).Date == Convert.ToDateTime(pStartDate).Date || Convert.ToDateTime(MedStatDr["EXEC_DATE"]).AddMinutes(-59).Date == Convert.ToDateTime(pStartDate).Date))
                                            {
                                                string ExecHourTmp = Convert.ToDateTime(MedStatDr["EXEC_DATE"].ToString().Trim()).Hour.ToString() != "0" ? Convert.ToDateTime(MedStatDr["EXEC_DATE"].ToString().Trim()).Hour.ToString() : "24";
                                                TimeArray.Add(new string[] { ExecHourTmp, "NumberBoxCSS_SEL", "" });
                                                //}
                                                ////20160929 修改用藥紀錄顯示 mod by yungchen 已給藥只出現實際給藥時間為今天的藥
                                                // if (MedStatDr["EXEC_DATE"].ToString().Trim() != "" && Convert.ToDateTime(MedStatDr["EXEC_DATE"]).Date == Convert.ToDateTime(pStartDate).Date)
                                                //{
                                                string PositionStr = MedStatDr["INSULIN_POSITION"].ToString().Trim() != "" ? "，胰島素施打部位：" + MedStatDr["INSULIN_POSITION"].ToString().Trim() : "";
                                                //  string ExecHourTmp = Convert.ToDateTime(MedStatDr["EXEC_DATE"].ToString().Trim()).Hour.ToString() != "0" ? Convert.ToDateTime(MedStatDr["EXEC_DATE"].ToString().Trim()).Hour.ToString() : "24";
                                                string cker = "";
                                                if (MedStatDr["CHECKER"] != null && MedStatDr["CHECKER"].ToString().Trim() != "")
                                                { cker = "，覆核者:" + MedStatDr["CHECKER"].ToString().Trim(); }
                                                if (MedStatDr["USE_DOSE"] != null && MedStatDr["USE_DOSE"].ToString() != "")
                                                {
                                                    MedArray.Add(string.Format("時間:{0}，給予劑量:{1}，執行者:{2}{3}{4}{5}", MedStatDr["EXEC_DATE"].ToString().Trim(), MedStatDr["USE_DOSE"].ToString().Trim() + " " + StatList[g].UD_UNIT, MedStatDr["EXEC_NAME"].ToString().Trim() + cker, MedStatDr["P_NAME"].ToString().Trim() != "" ? "，延遲原因：" + MedStatDr["P_NAME"].ToString().Trim() : "", MedStatDr["REMARK"].ToString().Trim() != "" ? "，備註：" + MedStatDr["REMARK"].ToString().Trim() : "", PositionStr));
                                                }
                                                UseDose += MedStatDr["USE_DOSE"].ToString().Trim() != "" ? double.Parse(MedStatDr["USE_DOSE"].ToString().Trim()) : 0;
                                            }
                                            else if (MedStatDr["EXEC_DATE"].ToString().Trim() != "")
                                            {
                                                string ExecHourTmp = Convert.ToDateTime(MedStatDr["EXEC_DATE"].ToString().Trim()).Hour.ToString() != "0" ? Convert.ToDateTime(MedStatDr["EXEC_DATE"].ToString().Trim()).Hour.ToString() : "24";
                                                TimeArray.Add(new string[] { ExecHourTmp, "NumberBoxCSS", "" });
                                                // MedArray.Add(string.Format("時間:{0}，給予劑量:{1}，執行者:{2}{3}{4}，胰島素施打部位：{5}", MedStatDr["EXEC_DATE"].ToString().Trim(), MedStatDr["USE_DOSE"].ToString().Trim() + " " + StatList[g].UD_UNIT, MedStatDr["EXEC_NAME"].ToString().Trim(), MedStatDr["P_NAME"].ToString().Trim() != "" ? "，延遲原因：" + MedStatDr["P_NAME"].ToString().Trim() : "", MedStatDr["REMARK"].ToString().Trim() != "" ? "，備註：" + MedStatDr["REMARK"].ToString().Trim() : "", MedStatDr["INSULIN_POSITION"].ToString().Trim()));

                                                UseDose += MedStatDr["USE_DOSE"].ToString().Trim() != "" ? double.Parse(MedStatDr["USE_DOSE"].ToString().Trim()) : 0;
                                            }
                                            else
                                            {
                                                TimeArray.Add(new string[] { HourTmp, "WhiteBox", MedStatDr["UD_SEQPK"].ToString().Trim() });
                                            }
                                        }
                                    }
                                    //計算長期醫囑是否有未給藥，一筆只要有一顆未給即可
                                    for (int x = 0; x <= TimeArray.Count - 1; x++)
                                    {
                                        if (TimeArray[x][1].IndexOf("RedBox") > -1 || TimeArray[x][1].IndexOf("WhiteBox") > -1)
                                        {
                                            StatUnExec++;
                                            continue;
                                        }
                                    }

                                    DateTime NullDay = Convert.ToDateTime("0001/01/01 00:00");
                                    DateTime DC_DAY = Convert.ToDateTime("0001/01/01 00:00");
                                    string begin = string.Format("{0}/{1}/{2} {3}:{4}", StatList[g].BEGIN_DATE.Substring(0, 3), StatList[g].BEGIN_DATE.Substring(3, 2), StatList[g].BEGIN_DATE.Substring(5, 2), StatList[g].BEGIN_TIME.Substring(0, 2), StatList[g].BEGIN_TIME.Substring(2, 2));
                                    string end = string.Format("{0}/{1}/{2} {3}:{4}", StatList[g].END_DATE.Substring(0, 3), StatList[g].END_DATE.Substring(3, 2), StatList[g].END_DATE.Substring(5, 2), StatList[g].END_TIME.Substring(0, 2), StatList[g].END_TIME.Substring(2, 2));
                                    System.Globalization.CultureInfo ToTWDay = new System.Globalization.CultureInfo("zh-TW");  //使用 1911 轉換民國及西元，會有閏年閏月問題  by wawa
                                    ToTWDay.DateTimeFormat.Calendar = new System.Globalization.TaiwanCalendar();
                                    DateTime BEGIN_DAY = DateTime.Parse(begin, ToTWDay);
                                    DateTime END_DAY = new DateTime();
                                    if (end != "000/00/00 00:00")
                                    { END_DAY = DateTime.Parse(end, ToTWDay); DC_DAY = END_DAY; }
                                    if (StatList[g].DC_DAY != null && StatList[g].DC_DAY.ToString().Trim() != "")
                                    { DC_DAY = Convert.ToDateTime(StatList[g].DC_DAY.Trim()); }

                                    //過 DC 時間，底要變淺灰
                                    if (end != "000/00/00 00:00" && DateTime.Now > DC_DAY)
                                    {
                                        BackInsideColor = "#CCCCCC";
                                    }

                                }
                                <table style="width: 100%; border: 1px solid #fff; background-color: @(BackInsideColor);padding: 8px;">
                                    <tr>
                                        <td colspan="2" style="text-align:left;">
                                            <input type="hidden" id="HidMedInfo2_1_@(g)" name="HidMedInfo2_1_@(g)" value="@(StatList[g].MED_DESC)|@(StatList[g].ALISE_DESC)|@(string.Format("{0}/{1}/{2} {3}:{4}", StatList[g].BEGIN_DATE.Substring(0, 3), StatList[g].BEGIN_DATE.Substring(3, 2), StatList[g].BEGIN_DATE.Substring(5, 2), StatList[g].BEGIN_TIME.Substring(0, 2), StatList[g].BEGIN_TIME.Substring(2, 2)) + (StatList[g].END_DATE != "" ? "~" + string.Format("{0}/{1}/{2} {3}:{4}", StatList[g].END_DATE.Substring(0, 3), StatList[g].END_DATE.Substring(3, 2), StatList[g].END_DATE.Substring(5, 2), StatList[g].END_TIME.Substring(0, 2), StatList[g].END_TIME.Substring(2, 2)) : ""))|@(BEGIN_DAY.ToString("yyyy/MM/dd"))" />
                                            <input type="hidden" id="HidMedInfo2_2_@(g)" name="HidMedInfo2_2_@(g)" value="@(StatList[g].UD_DOSE + " " + StatList[g].UD_UNIT)|@(StatList[g].UD_PATH)|@(StatList[g].UD_CIR)" />
                                            藥名：
                                            @if (StatList[g].IsFRIDs == true)
                                            {
                                                <span style="background-color:yellow;color:red">@(StatList[g].MED_DESC)&nbsp;</span>
                                            }
                                            else
                                            {
                                                <span>@(StatList[g].MED_DESC)&nbsp;</span>
                                            }                                            
                                            <span style="font-style:italic;color:brown;">@(StatList[g].ALISE_DESC)</span>&nbsp;(@(string.Format("{0}/{1}/{2} {3}:{4}", StatList[g].BEGIN_DATE.Substring(0, 3), StatList[g].BEGIN_DATE.Substring(3, 2), StatList[g].BEGIN_DATE.Substring(5, 2), StatList[g].BEGIN_TIME.Substring(0, 2), StatList[g].BEGIN_TIME.Substring(2, 2)) + (StatList[g].END_DATE != "" ? "~" + string.Format("{0}/{1}/{2} {3}:{4}", StatList[g].END_DATE.Substring(0, 3), StatList[g].END_DATE.Substring(3, 2), StatList[g].END_DATE.Substring(5, 2), StatList[g].END_TIME.Substring(0, 2), StatList[g].END_TIME.Substring(2, 2)) : "")))
                                        </td>
                                    </tr>
                                    <tr>
                                        @if (StatList[g].DrugPicPath != null && StatList[g].DrugPicPath.Trim() != "")
                                        {
                                            <td style="width:120px">
                                                <img id="Img2_@(g)" src="@(StatList[g].DrugPicPath)" style="width:100px;height:100px" onclick="pup_window('med_pharmacopoeia?MedCode=@(StatList[g].MED_CODE)');" />
                                            </td>
                                        }
                                        else
                                        {
                                            <td style="width:120px">
                                                <img id="Img2_@(g)" src="\\CORA\TextData\DrugImage\NoImage.JPG" style="width:100px;height:100px" onclick="pup_window('med_pharmacopoeia?MedCode=@(StatList[g].MED_CODE)');" />
                                            </td>
                                        }
                                        <td style="width:1500px">
                                            <table style="width: 98%; border: 1px solid #fff; background-color: @(BackInsideColor); " cellspacing="0">
                                                <tr>
                                                    <td colspan="2" style="width: 15%; border: 1px solid #fff;">劑量：@(StatList[g].UD_DOSE + " " + StatList[g].UD_UNIT)</td>
                                                    @{if (StatList[g].UD_PATH.Contains("AO"))
                                                        {
                                                            <td rowspan="2" style="width: 20%;color:green; border: 1px solid #fff">
                                                                備註：@(StatList[g].UD_CMD)
                                                                @if (StatList[g].IsFRIDs == true)
                                                                {
                                                                    <span>(易跌藥品)</span>
                                                                }
                                                            </td>
                                                        }
                                                        else
                                                        {
                                                            <td rowspan="2" style="width: 20%; border: 1px solid #fff">
                                                                備註：@(StatList[g].UD_CMD)
                                                                @if (StatList[g].IsFRIDs == true)
                                                                {
                                                                    <span>(易跌藥品)</span>
                                                                }
                                                            </td>
                                                        }
                                                    }
                                                    <td rowspan="2" style="width: 65%; border: 1px solid #fff">
                                                        <div id="Pn2_@(g)">
                                                            @{
                                                                List<string[]> TimeCollect = new List<string[]>();
                                                                for (var t = 1; t <= 24; t++)
                                                                {
                                                                    @*-----2016/09/06新增顏色優先順序判斷*@
                                                            string FillColor = "";
                                                            if (TimeArray.Any(x => x[0] == t.ToString() && x[1] == "RedBox")) { FillColor = "RedBox"; }
                                                            else if (TimeArray.Any(x => x[0] == t.ToString() && x[1] == "BlueBox")) { FillColor = "BlueBox"; }
                                                            else if (TimeArray.Any(x => x[0] == t.ToString() && x[1] == "NumberBoxCSS_SEL")) { FillColor = "NumberBoxCSS_SEL"; }
                                                            if (FillColor != "")
                                                            { TimeCollect = TimeArray.Where(x => x[0] == t.ToString() && x[1] == FillColor).ToList(); }
                                                            else
                                                            { TimeCollect = TimeArray.Where(x => x[0] == t.ToString()).ToList(); }
                                                            @*-----*@
                                                            if (TimeCollect != null && TimeCollect.Count > 0)
                                                            {
                                                                <div id="Stat_@(g)_@(t)" row="@(g)" ud="2" tm="@(t)" cktype="@(StatList[g].DoubleCheck)" drtype="@(StatList[g].DRUG_TYPE)" udtype="@(StatList[g].UD_TYPE)" seq="@(TimeCollect[0][2])" totaldose="@(TotalDose)" usedose="@(UseDose)" class="@(TimeCollect[0][1])">@(t)</div>
                                                                if (t == 12)
                                                                {
                                                                    <br />
                                                                }
                                                            }
                                                            else
                                                            {
                                                                <div id="Stat_@(g)_@(t)" row="@(g)" ud="2" tm="@(t)" cktype="@(StatList[g].DoubleCheck)" drtype="@(StatList[g].DRUG_TYPE)" udtype="@(StatList[g].UD_TYPE)" totaldose="@(TotalDose)" usedose="@(UseDose)" class="NumberBoxCSS">@(t)</div>
                                                                if (t == 12)
                                                                {
                                                                    <br />
                                                                    }
                                                                }
                                                            }
                                                            }
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td style="border: 1px solid #fff">@(StatList[g].UD_PATH)</td>
                                                    <td style="border: 1px solid #fff">@(StatList[g].UD_CIR)</td>
                                                </tr>
                                            </table>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td colspan="2" style="text-align:left;">
                                            <input type="button" style="float:right;" value="特殊註記" onclick="OpenRemark('2','@(g)');" />
                                            <div id="div2@(g)img" tagto="Hide" onclick="DisShowFunc(this, 'div2@(g)');">
                                                用藥紀錄
                                                <img src="../images/nolines_plus.gif" style="margin-bottom:-6px" />
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td colspan="2" style="text-align:left;">
                                            <div id="div2@(g)" style="border: 1px solid #fff; background-color: #DDDDDD; text-align: left; padding-left: 20px; display:none;">
                                                @if (MedArray != null && MedArray.Count > 0)
                                                {
                                                    for (int k = 0; k < MedArray.Count; k++)
                                                    {
                                                        <div>
                                                            <label>@(MedArray[k])</label>
                                                        </div>
                                                    }
                                                }
                                                else
                                                {
                                                    @:
                                                    <label>尚無用藥紀錄!</label>
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                </table>

                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td>
                            尚無資料!
                        </td>
                    </tr>
                }
            </table>
        </div>
        <!-- 點滴 -->
        <div id="tabs-4" class="tab">
            <table>
                @if (IVList != null && IVList.Count > 0)
                {
                    IVUnExec = 0;
                    for (int g = 0; g < IVList.Count; g++)
                    {
                        TotalDose = 0;
                        UseDose = 0;
                        <tr>
                            <td>
                                @{
                                    DataTable MedIVDt = cm.FiltData(IVDt, "UD_SEQ='" + IVList[g].UD_SEQ + "' and EXEC_DATE is not null");
                                    List<string[]> TimeArray = new List<string[]>();
                                    List<string> MedArray = new List<string>();
                                    List<int> ExecIVTimeArray = new List<int>();
                                    string BackInsideColor = "#FFE599";
                                    Double n;
                                    TotalDose = Double.TryParse(IVList[g].UD_DOSE, out n) ? double.Parse(IVList[g].UD_DOSE) : 0.0;
                                    if (MedIVDt != null && MedIVDt.Rows.Count > 0)
                                    {
                                        foreach (DataRow MedIVDr in MedIVDt.Rows)
                                        {
                                            DateTime DRUG_DATE = Convert.ToDateTime(MedIVDr["DRUG_DATE"].ToString().Trim());
                                            string HourTmp = DRUG_DATE.Hour.ToString() != "0" ? DRUG_DATE.Hour.ToString() : "24";
                                            //下面這行被註解的原因：恩主公 8/23 問題清單裡 Q12 提出，給過後應該要可以再給，原文：Q12:下圖的點滴點了7點按鈕，但時記時間是14點，存檔後14點是綠色沒錯，但是7點也不能按了，應該要維持可按才對。  by wawa
                                            //ExecIVTimeArray.Add(Convert.ToInt32(Convert.ToDateTime(MedIVDr["DRUG_DATE"].ToString()).ToString("HH")));  //記錄 IV 哪些時間已給藥，則在顯示時需取消框框
                                            if (IVList[g].DRUG_TYPE == "P")
                                            {
                                                string TmpRemarkData = string.Format("{0}|{1}|{2}|P", MedIVDr["REMARK"].ToString().Trim(), DRUG_DATE.Hour.ToString(), "0");
                                                string CareData = string.Format("{0}|{1}|{2}|{3}|{4}|{5}", MedIVDr["REMARK"].ToString().Trim(), IVList[g].UD_DOSE, IVList[g].UD_PATH, IVList[g].UD_CIR, IVList[g].MED_DESC, IVList[g].UD_CMD);
                                                string InsulinData = string.Format("{0}|{1}", IVList[g].DRUG_TYPE, MedIVDr["POSITION"].ToString().Trim());
                                                <input type="hidden" name="Hf_@(MedIVDr["UD_SEQPK"].ToString().Trim())" id="Hf_@(MedIVDr["UD_SEQPK"].ToString().Trim())" value="@(TmpRemarkData)" />
                                                <input type="hidden" name="Hf_Care_@(MedIVDr["UD_SEQPK"].ToString().Trim())" id="Hf_Care_@(MedIVDr["UD_SEQPK"].ToString().Trim())" value="@(CareData)" />
                                                <input type="hidden" name="Hf_Insulin_@(MedIVDr["UD_SEQPK"].ToString().Trim())" id="Hf_Insulin_@(MedIVDr["UD_SEQPK"].ToString().Trim())" value="@(InsulinData)" />
                                                <input type="hidden" name="Hf_DoubleCheck_@(MedIVDr["UD_SEQPK"].ToString().Trim())" id="Hf_DoubleCheck_@(MedIVDr["UD_SEQPK"].ToString().Trim())" value="@(IVList[g].DoubleCheck)" />

                                                if (MedIVDr["EXEC_DATE"].ToString().Trim() == "")  //if (DRUG_DATE < MustTime && MedIVDr["EXEC_DATE"].ToString().Trim() == "")
                                                {
                                                    TimeArray.Add(new string[] { HourTmp, "White24Box", MedIVDr["UD_SEQPK"].ToString().Trim() });
                                                    //BackInsideColor = "#EA9999";
                                                }
                                                else if (MedIVDr["REASONTYPE"].ToString().Trim() != "" && Convert.ToDateTime(DRUG_DATE).Date == Convert.ToDateTime(pStartDate).Date)
                                                {//20160929 修改用藥紀錄顯示 mod by yungchen 未給藥加上時間判斷只出現實際給藥是今天的藥
                                                    string PositionStr = MedIVDr["INSULIN_POSITION"].ToString().Trim() != "" ? "，胰島素施打部位：" + MedIVDr["INSULIN_POSITION"].ToString().Trim() : "";
                                                    string cker = "";
                                                    if (MedIVDr["CHECKER"] != null && MedIVDr["CHECKER"].ToString().Trim() != "")
                                                    { cker = "，覆核者:" + MedIVDr["CHECKER"].ToString().Trim(); }
                                                    TimeArray.Add(new string[] { HourTmp, "BlueBox", "" });
                                                    MedArray.Add(string.Format("時間:{0}，未給予，執行者:{1}，原因：{2} {3}{4}{5}", MedIVDr["DRUG_DATE"].ToString().Trim(), MedIVDr["EXEC_NAME"].ToString().Trim() + cker, MedIVDr["REASONTYPE"].ToString().Trim(), MedIVDr["P_NAME"].ToString().Trim(), MedIVDr["REMARK"].ToString().Trim() != "" ? "，備註：" + MedIVDr["REMARK"].ToString().Trim() : "", PositionStr));
                                                }
                                                else if (MedIVDr["EXEC_DATE"].ToString().Trim() != "" && (Convert.ToDateTime(MedIVDr["EXEC_DATE"]).Date == Convert.ToDateTime(pStartDate).Date || Convert.ToDateTime(MedIVDr["EXEC_DATE"]).AddMinutes(-59).Date == Convert.ToDateTime(pStartDate).Date))
                                                {
                                                    string ExecHourTmp = Convert.ToDateTime(MedIVDr["EXEC_DATE"].ToString().Trim()).Hour.ToString() != "0" ? Convert.ToDateTime(MedIVDr["EXEC_DATE"].ToString().Trim()).Hour.ToString() : "24";
                                                    TimeArray.Add(new string[] { ExecHourTmp, "NumberBoxCSS_SEL", "" });
                                                }
                                                //20160929 修改用藥紀錄顯示 mod by yungchen 已給藥加上時間判斷只出現實際給藥是今天的藥
                                                if (MedIVDr["EXEC_DATE"].ToString().Trim() != "" && (Convert.ToDateTime(MedIVDr["EXEC_DATE"]).Date == Convert.ToDateTime(pStartDate).Date || Convert.ToDateTime(MedIVDr["EXEC_DATE"]).AddMinutes(-59).Date == Convert.ToDateTime(pStartDate).Date))
                                                {
                                                    string PositionStr = MedIVDr["INSULIN_POSITION"].ToString().Trim() != "" ? "，胰島素施打部位：" + MedIVDr["INSULIN_POSITION"].ToString().Trim() : "";
                                                    string cker = "";
                                                    if (MedIVDr["CHECKER"] != null && MedIVDr["CHECKER"].ToString().Trim() != "")
                                                    { cker = "，覆核者:" + MedIVDr["CHECKER"].ToString().Trim(); }
                                                    string ExecHourTmp = Convert.ToDateTime(MedIVDr["EXEC_DATE"].ToString().Trim()).Hour.ToString() != "0" ? Convert.ToDateTime(MedIVDr["EXEC_DATE"].ToString().Trim()).Hour.ToString() : "24";
                                                    MedArray.Add(string.Format("時間:{0}，給予劑量:{1}，執行者:{2}{3}{4}{5}", MedIVDr["EXEC_DATE"].ToString().Trim(), MedIVDr["USE_DOSE"].ToString().Trim() + " " + IVList[g].UD_UNIT, MedIVDr["EXEC_NAME"].ToString().Trim() + cker, MedIVDr["P_NAME"].ToString().Trim() != "" ? "，延遲原因：" + MedIVDr["P_NAME"].ToString().Trim() : "", MedIVDr["REMARK"].ToString().Trim() != "" ? "，備註：" + MedIVDr["REMARK"].ToString().Trim() : "", PositionStr));

                                                    UseDose += MedIVDr["USE_DOSE"].ToString().Trim() != "" ? double.Parse(MedIVDr["USE_DOSE"].ToString().Trim()) : 0;
                                                }
                                            }
                                            else
                                            {
                                                //string TmpRemarkData = string.Format("{0}|{1}|{2}|{3}|{4}|{5}|{6}|{7}|{8}|{9}", (MedIVDr["EXEC_DATE"].ToString().Trim() != "" ? Convert.ToDateTime(MedIVDr["EXEC_DATE"].ToString().Trim()).ToString("yyyy/MM/dd") : DateTime.Now.ToString("yyyy/MM/dd")), (MedIVDr["EXEC_DATE"].ToString().Trim() != "" ? Convert.ToDateTime(MedIVDr["EXEC_DATE"].ToString().Trim()).ToString("HH:mm") : DateTime.Now.ToString("HH:mm")), IVList[g].UD_CMD, MedIVDr["USE_DOSE"].ToString().Trim() != "" && Convert.ToDecimal(MedIVDr["USE_DOSE"].ToString().Trim()) > 0 ? MedIVDr["USE_DOSE"].ToString().Trim() : IVList[g].UD_DOSE, MedIVDr["REASONTYPE"].ToString().Trim(), MedIVDr["REASON"].ToString().Trim(), MedIVDr["REMARK"].ToString().Trim(), "0", "0", "IV");
                                                string TmpRemarkData = string.Format("{0}|{1}|{2}|{3}|{4}|{5}|{6}|{7}|{8}|{9}", (MedIVDr["EXEC_DATE"].ToString().Trim() != "" ? Convert.ToDateTime(MedIVDr["EXEC_DATE"].ToString().Trim()).ToString("yyyy/MM/dd") : DateTime.Now.ToString("yyyy/MM/dd")), (MedIVDr["EXEC_DATE"].ToString().Trim() != "" ? Convert.ToDateTime(MedIVDr["EXEC_DATE"].ToString().Trim()).ToString("HH:mm") : DateTime.Now.ToString("HH:mm")), IVList[g].UD_CMD, "", MedIVDr["REASONTYPE"].ToString().Trim(), MedIVDr["REASON"].ToString().Trim(), MedIVDr["REMARK"].ToString().Trim(), "0", "0", "IV");
                                                string CareData = string.Format("{0}|{1}|{2}|{3}|{4}|{5}|{6}|{7}", MedIVDr["REMARK"].ToString().Trim(), MedIVDr["USE_DOSE"].ToString().Trim() != "" && Convert.ToDecimal(MedIVDr["USE_DOSE"].ToString().Trim()) > 0 ? MedIVDr["USE_DOSE"].ToString().Trim() : IVList[g].UD_DOSE, IVList[g].UD_PATH, IVList[g].UD_CIR, MedIVDr["REASONTYPE"].ToString().Trim(), IVList[g].MED_DESC, MedIVDr["P_NAME"].ToString().Trim(), IVList[g].UD_UNIT);
                                                string InsulinData = string.Format("{0}|{1}", IVList[g].DRUG_TYPE, MedIVDr["POSITION"].ToString().Trim());
                                                <input type="hidden" name="Hf_@(MedIVDr["UD_SEQPK"].ToString().Trim())" id="Hf_@(MedIVDr["UD_SEQPK"].ToString().Trim())" value="@(TmpRemarkData)" />
                                                <input type="hidden" name="Hf_Care_@(MedIVDr["UD_SEQPK"].ToString().Trim())" id="Hf_Care_@(MedIVDr["UD_SEQPK"].ToString().Trim())" value="@(CareData)" />
                                                <input type="hidden" name="Hf_Insulin_@(MedIVDr["UD_SEQPK"].ToString().Trim())" id="Hf_Insulin_@(MedIVDr["UD_SEQPK"].ToString().Trim())" value="@(InsulinData)" />
                                                <input type="hidden" name="Hf_DoubleCheck_@(MedIVDr["UD_SEQPK"].ToString().Trim())" id="Hf_DoubleCheck_@(MedIVDr["UD_SEQPK"].ToString().Trim())" value="@(IVList[g].DoubleCheck)" />

                                                if (MedIVDr["EXEC_DATE"].ToString().Trim() == "")  //if (DRUG_DATE < MustTime && MedIVDr["EXEC_DATE"].ToString().Trim() == "")
                                                {
                                                    TimeArray.Add(new string[] { HourTmp, "White24Box", MedIVDr["UD_SEQPK"].ToString().Trim() });
                                                    //BackInsideColor = "#EA9999";
                                                }
                                                else if (MedIVDr["REASONTYPE"].ToString().Trim() != "" && Convert.ToDateTime(DRUG_DATE).Date == Convert.ToDateTime(pStartDate).Date)
                                                {//20160929 修改用藥紀錄顯示 mod by yungchen 未給藥加上時間判斷只出現實際給藥是今天的藥
                                                    string PositionStr = MedIVDr["INSULIN_POSITION"].ToString().Trim() != "" ? "，胰島素施打部位：" + MedIVDr["INSULIN_POSITION"].ToString().Trim() : "";
                                                    string cker = "";
                                                    if (MedIVDr["CHECKER"] != null && MedIVDr["CHECKER"].ToString().Trim() != "")
                                                    { cker = "，覆核者:" + MedIVDr["CHECKER"].ToString().Trim(); }
                                                    TimeArray.Add(new string[] { HourTmp, "BlueBox", "" });
                                                    MedArray.Add(string.Format("時間:{0}，未給予，執行者:{1}，原因：{2} {3}{4}{5}", MedIVDr["DRUG_DATE"].ToString().Trim(), MedIVDr["EXEC_NAME"].ToString().Trim() + cker, MedIVDr["REASONTYPE"].ToString().Trim(), MedIVDr["P_NAME"].ToString().Trim(), MedIVDr["REMARK"].ToString().Trim() != "" ? "，備註：" + MedIVDr["REMARK"].ToString().Trim() : "", PositionStr));
                                                }
                                                else if (MedIVDr["EXEC_DATE"].ToString().Trim() != "" && (Convert.ToDateTime(MedIVDr["EXEC_DATE"]).Date == Convert.ToDateTime(pStartDate).Date || Convert.ToDateTime(MedIVDr["EXEC_DATE"]).AddMinutes(-59).Date == Convert.ToDateTime(pStartDate).Date))
                                                {
                                                    string ExecHourTmp = Convert.ToDateTime(MedIVDr["EXEC_DATE"].ToString().Trim()).Hour.ToString() != "0" ? Convert.ToDateTime(MedIVDr["EXEC_DATE"].ToString().Trim()).Hour.ToString() : "24";
                                                    TimeArray.Add(new string[] { ExecHourTmp, "NumberBoxCSS_SEL", "" });
                                                }
                                                if (MedIVDr["EXEC_DATE"].ToString().Trim() != "" && (Convert.ToDateTime(MedIVDr["EXEC_DATE"]).Date == Convert.ToDateTime(pStartDate).Date || Convert.ToDateTime(MedIVDr["EXEC_DATE"]).AddMinutes(-59).Date == Convert.ToDateTime(pStartDate).Date))
                                                {
                                                    string PositionStr = MedIVDr["INSULIN_POSITION"].ToString().Trim() != "" ? "，胰島素施打部位：" + MedIVDr["INSULIN_POSITION"].ToString().Trim() : "";
                                                    string cker = "";
                                                    if (MedIVDr["CHECKER"] != null && MedIVDr["CHECKER"].ToString().Trim() != "")
                                                    { cker = "，覆核者:" + MedIVDr["CHECKER"].ToString().Trim(); }
                                                    string ExecHourTmp = Convert.ToDateTime(MedIVDr["EXEC_DATE"].ToString().Trim()).Hour.ToString() != "0" ? Convert.ToDateTime(MedIVDr["EXEC_DATE"].ToString().Trim()).Hour.ToString() : "24";
                                                    MedArray.Add(string.Format("時間:{0}，給予劑量:{1}，執行者:{2}{3}{4}{5}", MedIVDr["EXEC_DATE"].ToString().Trim(), MedIVDr["USE_DOSE"].ToString().Trim() + " " + IVList[g].UD_UNIT, MedIVDr["EXEC_NAME"].ToString().Trim() + cker, MedIVDr["P_NAME"].ToString().Trim() != "" ? "，延遲原因：" + MedIVDr["P_NAME"].ToString().Trim() : "", MedIVDr["REMARK"].ToString().Trim() != "" ? "，備註：" + MedIVDr["REMARK"].ToString().Trim() : "", PositionStr));

                                                    UseDose += MedIVDr["USE_DOSE"].ToString().Trim() != "" ? double.Parse(MedIVDr["USE_DOSE"].ToString().Trim()) : 0;
                                                }
                                            }
                                        }
                                    }

                                    int IVTmp = 0;  //計算 IV 醫囑是否有未給藥，一筆只要有一顆符合未給即可，未給規則為 現在時間前後一小時

                                    DateTime NullDay = Convert.ToDateTime("0001/01/01 00:00");
                                    DateTime DC_DAY = Convert.ToDateTime("0001/01/01 00:00");
                                    string begin = string.Format("{0}/{1}/{2} {3}:{4}", IVList[g].BEGIN_DATE.Substring(0, 3), IVList[g].BEGIN_DATE.Substring(3, 2), IVList[g].BEGIN_DATE.Substring(5, 2), IVList[g].BEGIN_TIME.Substring(0, 2), IVList[g].BEGIN_TIME.Substring(2, 2));
                                    string end = string.Format("{0}/{1}/{2} {3}:{4}", IVList[g].END_DATE.Substring(0, 3), IVList[g].END_DATE.Substring(3, 2), IVList[g].END_DATE.Substring(5, 2), IVList[g].END_TIME.Substring(0, 2), IVList[g].END_TIME.Substring(2, 2));
                                    System.Globalization.CultureInfo ToTWDay = new System.Globalization.CultureInfo("zh-TW");  //使用 1911 轉換民國及西元，會有閏年閏月問題  by wawa
                                    ToTWDay.DateTimeFormat.Calendar = new System.Globalization.TaiwanCalendar();
                                    DateTime BEGIN_DAY = DateTime.Parse(begin, ToTWDay);
                                    DateTime END_DAY = new DateTime();
                                    if (end != "000/00/00 00:00")
                                    { END_DAY = DateTime.Parse(end, ToTWDay); DC_DAY = END_DAY; }
                                    if (IVList[g].DC_DAY != null && IVList[g].DC_DAY.ToString().Trim() != "")
                                    { DC_DAY = Convert.ToDateTime(IVList[g].DC_DAY.Trim()); }

                                    //過 DC 時間，底要變淺灰
                                    if (end != "000/00/00 00:00" && DateTime.Now > DC_DAY)
                                    {
                                        BackInsideColor = "#CCCCCC";
                                    }

                                    //if (Convert.ToDateTime(pStartDate).Date >= BEGIN_DAY.Date && (end == "000/00/00 00:00" || END_DAY.Date >= Convert.ToDateTime(pStartDate).Date))
                                    //{//在期限內的藥才顯示
                                    <table style="width: 100%; border: 1px solid #fff; background-color: @(BackInsideColor);padding: 8px;">
                                        <tr>
                                            <td colspan="2" style="text-align:left;">
                                                <input type="hidden" id="HidMedInfo3_1_@(g)" name="HidMedInfo3_1_@(g)" value="@(IVList[g].MED_DESC)|@(IVList[g].ALISE_DESC)|@(string.Format("{0}/{1}/{2} {3}:{4}", IVList[g].BEGIN_DATE.Substring(0, 3), IVList[g].BEGIN_DATE.Substring(3, 2), IVList[g].BEGIN_DATE.Substring(5, 2), IVList[g].BEGIN_TIME.Substring(0, 2), IVList[g].BEGIN_TIME.Substring(2, 2)) + (IVList[g].END_DATE != "" ? "~" + string.Format("{0}/{1}/{2} {3}:{4}", IVList[g].END_DATE.Substring(0, 3), IVList[g].END_DATE.Substring(3, 2), IVList[g].END_DATE.Substring(5, 2), IVList[g].END_TIME.Substring(0, 2), IVList[g].END_TIME.Substring(2, 2)) : ""))|@(BEGIN_DAY.ToString("yyyy/MM/dd"))" />
                                                <input type="hidden" id="HidMedInfo3_2_@(g)" name="HidMedInfo3_2_@(g)" value="@(IVList[g].UD_DOSE + " " + IVList[g].UD_UNIT)|@(IVList[g].UD_PATH)|@(IVList[g].UD_CIR)" />
                                                藥名：
                                                @if (IVList[g].IsFRIDs == true)
                                                {
                                                    <span style="background-color:yellow;color:red">@(IVList[g].MED_DESC)&nbsp;</span>
                                                }
                                                else
                                                {
                                                    <span>@(IVList[g].MED_DESC)&nbsp;</span>
                                                }
                                                <input type="hidden" id="HidMedInfoMedCode_@(g)" name="HidMedInfoMedCode_@(g)" value="@(IVList[g].MED_CODE)" />
                                                <span style="font-style:italic;color:brown;">@(IVList[g].ALISE_DESC)</span>&nbsp;(@(string.Format("{0}/{1}/{2} {3}:{4}", IVList[g].BEGIN_DATE.Substring(0, 3), IVList[g].BEGIN_DATE.Substring(3, 2), IVList[g].BEGIN_DATE.Substring(5, 2), IVList[g].BEGIN_TIME.Substring(0, 2), IVList[g].BEGIN_TIME.Substring(2, 2)) + (IVList[g].END_DATE != "" ? "~" + string.Format("{0}/{1}/{2} {3}:{4}", IVList[g].END_DATE.Substring(0, 3), IVList[g].END_DATE.Substring(3, 2), IVList[g].END_DATE.Substring(5, 2), IVList[g].END_TIME.Substring(0, 2), IVList[g].END_TIME.Substring(2, 2)) : "")))
                                            </td>
                                        </tr>
                                        <tr>
                                            @if (IVList[g].DrugPicPath != null && IVList[g].DrugPicPath.Trim() != "")
                                            {
                                                <td style="width:120px">
                                                    <img id="Img3_@(g)" src="@(IVList[g].DrugPicPath)" style="width:100px;height:100px" onclick="pup_window('med_pharmacopoeia?MedCode=@(IVList[g].MED_CODE)');" />
                                                </td>
                                            }
                                            else
                                            {
                                                <td style="width:120px">
                                                    <img id="Img3_@(g)" src="\\CORA\TextData\DrugImage\NoImage.JPG" style="width:100px;height:100px" onclick="pup_window('med_pharmacopoeia?MedCode=@(IVList[g].MED_CODE)');" />
                                                </td>
                                            }
                                            <td style="width:1500px">
                                                <table style="width: 98%; border: 1px solid #fff; background-color: @(BackInsideColor); " cellspacing="0">
                                                    <tr>
                                                        <td colspan="2" style="width: 15%; border: 1px solid #fff;">
                                                            劑量：@(IVList[g].UD_DOSE + " " + IVList[g].UD_UNIT)
                                                            @*<br />(@(UseDose)/@(IVList[g].UD_DOSE))*@
                                                        </td>
                                                        @{if (IVList[g].UD_PATH.Contains("AO"))
                                                            {
                                                                <td rowspan="2" style="width: 20%;color:green; border: 1px solid #fff">
                                                                    備註：@(IVList[g].UD_CMD)
                                                                    @if (IVList[g].IsFRIDs == true)
                                                                    {
                                                                        <span>(易跌藥品)</span>
                                                                    }
                                                                </td>
                                                            }
                                                            else
                                                            {
                                                                <td rowspan="2" style="width: 20%; border: 1px solid #fff">
                                                                    備註：@(IVList[g].UD_CMD)
                                                                    @if (IVList[g].IsFRIDs == true)
                                                                    {
                                                                        <span>(易跌藥品)</span>
                                                                    }
                                                                </td>
                                                            }
                                                        }

                                                        <td rowspan="2" style="width: 65%; border: 1px solid #fff">
                                                            <div id="Pn3_@(g)">
                                                                @{

                                                                    //計算是否超過當日總劑量，若超過則時間格子該全部鎖起來
                                                                    double DayUDDose = Double.TryParse(IVList[g].UD_DOSE, out n) ? n : 0;


                                                                    for (var t = 1; t <= 24; t++)
                                                                    {
                                                                        int tTmp = 0;
                                                                        DateTime Border_DATE = new DateTime();
                                                                        if (t == 24)
                                                                        {
                                                                            tTmp = 0;
                                                                            Border_DATE = Convert.ToDateTime(Convert.ToDateTime(pStartDate).AddDays(1).ToString("yyyy/MM/dd") + " " + tTmp.ToString().PadLeft(2, '0') + ":00");
                                                                        }
                                                                        else
                                                                        {
                                                                            tTmp = t;
                                                                            Border_DATE = Convert.ToDateTime(pStartDate + " " + tTmp.ToString().PadLeft(2, '0') + ":00");
                                                                        }
                                                                        string ClassNameTmp = "White24Box";  //IV 白框獨立，因為 IV 同 PRN 為 24 小時強制跳註記
                                                                        for (int e = 0; e <= ExecIVTimeArray.Count - 1; e++)
                                                                        {
                                                                            if (t == ExecIVTimeArray[e])
                                                                            {  //符合已給藥之 DRUG_DATE，則不可再給第二次藥
                                                                                ClassNameTmp = "NumberBoxCSS";
                                                                                break;
                                                                            }
                                                                        }
                                                                        if ((Border_DATE > DC_DAY && DC_DAY != NullDay) || Border_DATE < BEGIN_DAY.AddHours(-1) || BEGIN_DAY == DC_DAY)
                                                                        {//過 DC 時間又未給藥 灰底
                                                                         //20160906 mod by yungchen 減一小時若開始時間為13:10 則13的格子還是要可以點 並改為白底
                                                                            ClassNameTmp = "OverDCDateBox";
                                                                        }
                                                                        if (Border_DATE <= DateTime.Now.AddHours(+1) && Border_DATE >= DateTime.Now.AddHours(-1))
                                                                        { //現在時間前後一小時，需顯示星星
                                                                            if (ClassNameTmp == "White24Box")
                                                                            {
                                                                                IVTmp = 1;
                                                                            }
                                                                        }
                                                                        //if (UseDose >= DayUDDose || (ClassNameTmp == "White24Box" || ClassNameTmp == "NumberBoxCSS"))
                                                                        //{//計算是否超過當日總劑量，若超過則時間格子該全部鎖起來
                                                                        //    ClassNameTmp = "OverDCDateBox";
                                                                        //}

                                                                        List<string[]> TimeCollect = TimeArray.Where(x => x[0] == t.ToString()).ToList();
                                                                        if (TimeCollect != null && TimeCollect.Count > 0)
                                                                        {
                                                                            <div id="IV_@(g)_@(t)" cktype="@(IVList[g].DoubleCheck)" drtype="@(IVList[g].DRUG_TYPE)" udtype="@(IVList[g].UD_TYPE)" row="@(g)" ud="3" tm="@(t)" seq="@(TimeCollect[0][2])" totaldose="@(TotalDose)" usedose="@(UseDose)" class="@(TimeCollect[0][1])">@(t)</div>
                                                                            if (t == 12)
                                                                            {
                                                                                <br />
                                                                            }
                                                                        }
                                                                        else
                                                                        {
                                                                            <div id="IV_@(g)_@(t)" cktype="@(IVList[g].DoubleCheck)" drtype="@(IVList[g].DRUG_TYPE)" udtype="@(IVList[g].UD_TYPE)" row="@(g)" ud="3" tm="@(t)" seq="TmpIV_@(IVList[g].UD_SEQ)_@(t)" totaldose="@(TotalDose)" usedose="@(UseDose)" class="@(ClassNameTmp)">@(t)</div>
                                                                            if (t == 12)
                                                                            {
                                                                                <br />
                                                                            }
                                                                            <input type="hidden" name="Hf_TmpIV_@(IVList[g].UD_SEQ)_@(t)" id="Hf_TmpIV_@(IVList[g].UD_SEQ)_@(t)" value="|@(t)|0|@(IVList[g].DRUG_TYPE)" />
                                                                            <input type="hidden" name="Hf_Care_TmpIV_@(IVList[g].UD_SEQ)_@(t)" id="Hf_Care_TmpIV_@(IVList[g].UD_SEQ)_@(t)" value="|@(IVList[g].UD_DOSE)|@(IVList[g].UD_PATH)|@(IVList[g].UD_CIR)||@(IVList[g].MED_DESC)|@(IVList[g].UD_CMD)|@(IVList[g].UD_UNIT)" />
                                                                            <input type="hidden" name="Hf_Insulin_TmpIV_@(IVList[g].UD_SEQ)_@(t)" id="Hf_Insulin_TmpIV_@(IVList[g].UD_SEQ)_@(t)" value="@(IVList[g].DRUG_TYPE)|" />
                                                                            <input type="hidden" name="Hid_MedInfo_TmpIV_@(IVList[g].UD_SEQ)_@(t)" id="Hid_MedInfo_TmpIV_@(IVList[g].UD_SEQ)_@(t)" value="@(IVList[g].MED_CODE)" />
                                                                            <input type="hidden" name="Hf_DoubleCheck_TmpIV_@(IVList[g].UD_SEQ)_@(t)" id="Hf_DoubleCheck_TmpIV_@(IVList[g].UD_SEQ)_@(t)" value="@(IVList[g].DoubleCheck)" />
                                                                        }
                                                                    }
                                                                    IVUnExec += IVTmp;
                                                                }
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td style="border: 1px solid #fff">@(IVList[g].UD_PATH)</td>
                                                        <td style="border: 1px solid #fff">@(IVList[g].UD_CIR)</td>
                                                    </tr>
                                                </table>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" style="text-align:left;">
                                                <div style="float:right;">
                                                    <input type="button" value="特殊註記" onclick="OpenRemark('3','@(g)');" />
                                                </div>
                                                <div id="div3@(g)img" style="padding-bottom:0px;" tagto="Hide" onclick="DisShowFunc(this, 'div3@(g)');">
                                                    用藥紀錄
                                                    <img src="../images/nolines_plus.gif" style="margin-bottom:-6px" />
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" style="text-align:left;">
                                                <div id="div3@(g)" style="padding-top:0px;border: 1px solid #fff; background-color: #DDDDDD; text-align: left; padding-left: 20px; display:none;">
                                                    @if (MedArray != null && MedArray.Count > 0)
                                                    {
                                                        for (int k = 0; k < MedArray.Count; k++)
                                                        {
                                                            <div>
                                                                <label>@(MedArray[k])</label>
                                                            </div>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        @:
                                                        <label>尚無用藥紀錄!</label>
                                                    }
                                                </div>
                                            </td>
                                        </tr>
                                    </table>
                                    @*}*@
                                }
                            </td>
                        </tr>
                                                                        }
                                                                    }
                                                                    else
                                                                    {
                                                                        <tr>
                                                                            <td>
                                                                                尚無資料!
                                                                            </td>
                                                                        </tr>
                                                                    }
            </table>
        </div>
    </div>

    <!--遮罩-->
    <div id="inp" class="dialog"></div>
    <div id="cover" class="dialog"></div>
    <div id="sys_Block"></div>
    <div id="sys_Loading">
        <label for="lab" style="font-size:16px">Loading...</label><br />
        <img src="~/Images/System/loading.gif" alt="" />
    </div>

</form>

<script type="text/javascript">
    //將計算完未給藥星星，標記在各頁籤上
    if ('@LongUnExec' != 0)
        $("#LongTabsTitle").html($("#LongTabsTitle").html() + "<font color='#FF0000'> ★</font>");  //長期醫囑
    @*if ('@PRNUnExec' != 0)
        $("#PRNTabsTitle").html($("#PRNTabsTitle").html() + "<font color='#FF0000'> ★</font>");  //PRN醫囑*@
    if ('@StatUnExec' != 0)
        $("#StatTabsTitle").html($("#StatTabsTitle").html() + "<font color='#FF0000'> ★</font>");  //臨時醫囑
    @*if ('@IVUnExec' != 0)
        $("#IVTabsTitle").html($("#IVTabsTitle").html() + "<font color='#FF0000'> ★</font>");  //點滴*@
</script>