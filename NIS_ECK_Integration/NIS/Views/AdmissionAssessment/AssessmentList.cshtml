@using System.Data;
@{
    Layout = "~/Views/Layout/FormLayout.cshtml";

    DataTable dt = ViewBag.dt;
    string RootDocument = ViewBag.RootDocument;
    string LoginEmployeesName = ViewBag.LoginEmployeesName;
    string filname = "", content = "", title = "";
    string child_assess = ViewBag.child_assess;
    if (ViewBag.natype == "A")
    {
        filname = "AssessmentAdult";
        content = "入院護理評估-成人";
        title = "成人入院護理評估";
    }
    else if (ViewBag.natype == "C")
    {
        filname = "AssessmentChild";
        content = "入院護理評估-兒童";
        title = "兒童入院護理評估";
    }
    else if (ViewBag.natype == "ER")
    {
        filname = "AssessmentER";
        content = "入院護理評估-急診";
        title = "急診入院護理評估";
    }
    else if (ViewBag.natype == "Z")
    {
        filname = "AssessmentSpirit_O";
        content = "精神科-出院計劃評估";
        title = "精神科-出院計劃評估";
    }
    else if (ViewBag.natype == "G")
    {
        filname = "AssessmentObstetrics";
        content = "入院護理評估-產科";
        title = "產科入院護理評估";
    }
    else if (ViewBag.natype == "B")
    {
        filname = "AssessmentNewBorn";
        content = "入院護理評估-新生兒";
        title = "新生兒入院護理評估";
    }
}

<style type="text/css">
    .popup {
        width: 800px;
        height: 380px;
        position: absolute;
        background-color: #EFEFFF;
        padding: 10px 15px 10px 15px;
        border: 1px solid #999999;
        box-shadow: 5px 5px 5px #666;
        border-radius: 15px 15px 15px 15px;
        top: 50%;
        left: 50%;
        margin: -200px 0 0 -400px; /* [-(height/2)px 0 0 -(width/2)px] */
        display: none;
        z-index: 99;
    }

    .dataArea td {
        border-bottom: 1px solid rgba(20%,20%,40%,0.5);
        text-align: left;
    }

    .dataArea tr:hover {
        background-color: #9966FF;
    }
</style>

<script type="text/javascript">
    $(function () {
        close_pup_window();
        setGridColor();
    });

    function setGridColor() {
        //格行換色
        var tr = $('.dataArea tr');
        var color = '#ABC8E2';
        for (var i = 0; i < tr.length; i++) {
            if ($(tr[i]).css('display') != 'none') {
                $(tr[i]).css('background', color);
                if (color == '#ABC8E2')
                    color = '#E1E6FA';
                else
                    color = '#ABC8E2';
            }
        }
        $('.head').css('background', '#85A5CC');
    }

    function turn_pdf(tableid) {
        var url = '/@(filname)_PDF?tableid=' + tableid + '&feeno=@(ViewBag.feeno)&';
        $.ajax({
            type: "POST",
            url: 'Html_To_Pdf',
            data: { "url": window.location.href.replace('/AssessmentList?', url) },
            success: function (reslut) { document.write(reslut); }
        });
    }

    function pup_window(url) {
        new_window.push(window.open("../Assessment/AssessmentChild?seqno=" + url , 'top_dialog', 'menubar=no,status=no,scrollbars=yes,top=0,resizable=yes,left=200,toolbar=no,width=730,height=450'));
    }
</script>

<div class="funcArea">
    <table border="0" cellpadding="0" cellspacing="0" style="width:100%; font-size:14px;">
        <tr>
            <td>
                <p style="text-align:center">
                    <span style="color:blue;font-size:18px;">@title</span>
                </p>
            </td>
        </tr>
        <tr>
            <td style="width:100%;text-align:center;">
                @{string default_func = "window.location.href = '" + filname + "?mode=insert' ";}
                <input id="btn_insert" type="button" value="新增評估" onclick="@default_func" />
                <input type="button" value="返回入院護理評估總表" onclick="window.location.href='AssessmentIndex?page=X'" />
                @if (ViewBag.natype == "C" && child_assess != null)
                {
                    <input type="button" class="tab_control" value="兒童發展評估" onclick="pup_window('@child_assess')" />
                }
                else if (ViewBag.natype == "S")
                {
                    <input type="button" class="tab_control" value="精神科_出院計劃評估" onclick="window.location.href = 'AssessmentList?natype=Z'" />
                }
                else if (ViewBag.natype == "Z")
                {
                    <input type="button" class="tab_control" value="入院護理評估-精神科" onclick="window.location.href = 'AssessmentList?natype=S'" />
                }
            </td>
        </tr>
        <tr>
            <td style=" padding:5px 0 5px 0;">
                <div class="dataHeader">
                    <table border="0" cellpadding="4" cellspacing="1" style="width:100%;">
                        <tr>
                            <td style="width:10%;"></td>
                            <td style="width:10%;"></td>
                            <td style="width:10%;"></td>
                            <td style="width:25%;">文件說明</td>
                            <td style="width:13%;">最後修改日期</td>
                            <td style="width:8%;">版本</td>
                            <td style="width:10%;">狀態</td>
                            <td style="width:14%;">最後編輯者</td>
                        </tr>
                    </table>
                </div>
                <div class="dataArea" style="height:360px;">
                    @if (dt != null && dt.Rows.Count > 0)
                     {
                        <table border="0" cellpadding="4" cellspacing="1" style="width:100%;table-layout:fixed;">
                            @for (int i = 0; i < dt.Rows.Count; i++)
                            {
                                string upd_func = "window.location.href = '" + filname + "?tableid=" + dt.Rows[i]["TABLEID"].ToString().Trim() + "&mode=update'";
                                string del_func = "if(confirm('確認刪除?')){ window.location.href = 'DelAssessment?natype=" + ViewBag.natype + "&tableid=" + dt.Rows[i]["TABLEID"].ToString().Trim() + "'; }";
                                string back_func = "if(confirm('確認退回?')){ window.location.href = 'BackAssessment?natype=" + ViewBag.natype + "&tableid=" + dt.Rows[i]["TABLEID"].ToString().Trim() + "'; }";

                                //string print_func = "turn_pdf('" + dt.Rows[i]["TABLEID"] + "')";
                                string HeaderVal = "",FooterVal="";
                                if (ViewBag.natype == "A")
                                {//成人
                                    HeaderVal="入院護理評估表";
                                    FooterVal="(105_Q3)恩主公醫院BAIA000-034-02";
                                }
                                else if (ViewBag.natype == "C")
                                {//兒童
                                    HeaderVal="兒科入院病人護理評估單";
                                    FooterVal="(105_Q3)恩主公醫院BAIA000-011-02";
                                }
                                else if (ViewBag.natype == "ER")
                                {
                                    FooterVal = "(106_Q1)恩主公醫院BABA010-008-01";
                                }
                                string print_func = "window.open('" + RootDocument + "/Print/GetPDF?HeaderVal=" + Server.UrlEncode(HeaderVal) + "&FooterVal=" + Server.UrlEncode(FooterVal) + "&url=" + RootDocument + "/AdmissionAssessment/" + filname + "_PDF?1=1&filename="+ title + "&feeno=" + ViewBag.feeno + "&tableid=" + dt.Rows[i]["TABLEID"].ToString().Trim() + "')";
                                string pre_print = "window.open('" + RootDocument + "/AdmissionAssessment/" + filname + "_PDF?1=1&filename=test&feeno=" + ViewBag.feeno + "&tableid=" + dt.Rows[i]["TABLEID"].ToString().Trim() + "')";
                                string status = dt.Rows[i]["STATUS"].ToString().Trim();
                                if (status == "temporary")
                                {
                                    status = "暫存";
                                }
                                else if (status == "delete")
                                {
                                    status = "已刪除";
                                }
                                else
                                {
                                    status = "已完成";
                                }
                                <tr>
                                    <td style="width:10%;">
                                        <input type="button" value="列印" style="width:50px;" onclick="@print_func" />
                                        @*<input type="button" value="預覽列印" style="width:100px;" onclick="@pre_print" />*@
                                    </td>
                                    @if (status == "已刪除")
                                    {
                                        <td style="width:10%;"></td>
                                        <td style="width:10%;"></td>
                                    }
                                    else
                                    {
                                        <td style="width:10%;">
                                            @if(LoginEmployeesName.Trim() == @dt.Rows[i]["username"].ToString().Trim())
                                            { 
                                            <input type="button" value="更改" style="width:50px;" onclick="@upd_func" />
                                             }
                                        </td>
                                        <td style="width:10%;">
                                            @if (LoginEmployeesName.Trim() == @dt.Rows[i]["username"].ToString().Trim())
                                            {
                                                //20250110 ken 新增退回暫存
                                                <input type="button" value="刪除" style="width:50px;" onclick="@del_func" />
                                                if (dt.Rows[i]["STATUS"].ToString().Trim() != "temporary")
                                                {
                                                    <input type="button" value="退回暫存" style="width:80px;" onclick="@back_func" />
                                                }
                                            }
                                        </td>
                                    }
                                    <td style="width:25%;">@content</td>
                                    <td style="width:13%;">@((dt.Rows[i]["MODIFYTIME"].ToString() != "") ? Convert.ToDateTime(dt.Rows[i]["MODIFYTIME"]).ToString("yyyy/MM/dd HH:mm") : Convert.ToDateTime(dt.Rows[i]["CREATETIME"]).ToString("yyyy/MM/dd HH:mm"))</td>
                                    <td style="width:8%;">@(dt.Rows.Count - i)</td>
                                    <td style="width:10%;">@status</td>
                                    <td style="width:14%;">@dt.Rows[i]["username"].ToString().Trim()</td>
                                </tr>
                    }
                        </table>
                    for (int i = 0; i < dt.Rows.Count; i++)
                    {
                        if (dt.Rows[i]["STATUS"].ToString() != "temporary" && dt.Rows[i]["STATUS"].ToString() != "delete")
                        {
                            <script type="text/javascript">
                                $('#btn_insert').attr('onclick', 'window.location.href="@(filname)?tableid=@dt.Rows[i]["TABLEID"].ToString().Trim()&mode=insert"');
                            </script>
                            i = dt.Rows.Count;
                        }
                    }
            }
                </div>
            </td>
        </tr>
    </table>
</div>