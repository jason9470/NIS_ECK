@{
    Layout = "~/Views/Layout/FormLayout.cshtml";
    //日期選擇器，鎖定時間
    NIS.Data.PatientInfo pf = (NIS.Data.PatientInfo)Session["PatInfo"];
    NIS.Data.Complement_List complement_List = (NIS.Data.Complement_List)Session["Complement_List"];
}

<style type="text/css">
  .popup {
    width:700px;
    height:400px;
    position:absolute;
    background-color:#EFEFFF;
    padding: 10px 15px 10px 15px;
    border: 1px solid #999999;
    box-shadow: 5px 5px 5px #666;
    border-radius:15px 15px 15px 15px;
    top:50%;
    left:50%;
    margin:-200px 0 0 -350px; /* [-(height/2)px 0 0 -(width/2)px] */
    display:none;
    z-index:99;
  }
  .dataArea td {
    border-bottom: 1px solid rgba(20%,20%,40%,0.5);
    text-align: left;
  }
</style>

<script type="text/javascript">
    $(function () {
        //$('#start_date').datetimepicker({ showTimepicker: false, maxDateTime: 0 });
        //$('#end_date').datetimepicker({ showTimepicker: false, maxDateTime: 0 });
        $("#btn_tube_stats").css("background-color", "#666666");
        $("#btn_tube_stats").css("color", "#FFFFFF");
    });

    function rValue() {
        $('#dv_type').fadeOut(0);
        var ck_id = '', ck_name = '';
        var ck = document.getElementsByName('typeid');
        if (document.getElementById('all').checked) {
            $('#txt_type').val('全部');
            $('#type_id').val('all');
        }
        else {
            for (var i = 0; i < ck.length; i++) {
                if (ck[i].checked) {
                    ck_id = ck_id + "'" + ck[i].id + "',";
                    ck_name = ck_name + ck[i].value + ",";
                }
            }
            $('#type_id').val(ck_id.substring(0, ck_id.length - 1));
            $('#txt_type').val(ck_name.substring(0, ck_name.length - 1));
        }
    }

    function showPopup(id) {
        var popup = document.getElementById(id);
        popup.style.display = 'block';
    }

    function ck_all(obj) {
        var ck = document.getElementsByName('typeid');
        for (var i = 0; i < ck.length; i++) {
            if (obj.checked)
                ck[i].checked = true;
            else
                ck[i].checked = false;
        }
    }

    function search() {
        $('#part_detail').fadeOut(100);
        $('#part_amount').fadeOut(100);
        $('#part_room').fadeOut(100);
        if ($('#select_tube_type').val() == '1') {
            $.ajax({
                type: 'post',
                url: '../TubeManage/Report_Detail',
                timeout: 500,
                data: { Station: $('#selStation').val(), typeid: $('#type_id').val(), start_date: $('#start_date').val(), end_date: $('#end_date').val() },
                success: function (data) { $('#report_detail').html(data); }
            });
            $('#part_detail').fadeIn(0);
        }
        else if ($('#select_tube_type').val() == '2') {
            $.ajax({
                type: 'post',
                url: '../TubeManage/Report_Amount',
                timeout: 500,
                data: { Station: $('#selStation').val(), typeid: $('#type_id').val(), start_date: $('#start_date').val(), end_date: $('#end_date').val() },
                success: function (data) { $('#report_amount').html(data);  }
            });
            $('#part_amount').fadeIn(0);
        }
    }
    
    function selectchange() {
        if ($('#select_tube_type').val() == '1') {
            $('#selStation').find('option:contains(全選)').remove();
        }
        else {
            var list = document.getElementById('#selStation');
            var np = document.createElement("option");
            $('#selStation').append(np);
            np.innerHTML = '全選';
            $('#selStation').val('all');
        }
    }

    function provite_exl() {
        if ($('#select_tube_type').val() == '1')
            var form = createForm("../TubeManage/Report_Detail_exl", "post");
        else if ($('#select_tube_type').val() == '2')
            var form = createForm("../TubeManage/Report_Amount_exl", "post");

        appendField(form, "hidden", "Station", $('#selStation').val());
        appendField(form, "hidden", "typeid", $('#type_id').val());
        appendField(form, "hidden", "start_date", $('#start_date').val());
        appendField(form, "hidden", "end_date", $('#end_date').val());
        document.body.appendChild(form);
        form.submit();
        $(form).remove();
    }
</script>

@using System.Data;
@{
    DataTable dt_tubekind_one = ViewBag.dt_tubekind1;
    DataTable dt_tubekind_two = ViewBag.dt_tubekind2;
    DataTable dt_tubekind_three = ViewBag.dt_tubekind3;
    DataTable dt_tubekind_other = ViewBag.dt_tubekind_other;
    }
<div class="funcArea">
    <table border="0" cellpadding="0" cellspacing="0" style="width:100%;">
        <tr>
            <td style="padding-bottom:5px;text-align:center;">
                <input id="btn_tube_index" type="button" value="管路管理" onclick="window.location.href = 'Index';" />
                <input id="btn_tube_stats" type="button" value="管路統計" onclick="window.location.href = 'Stats';" />
                <input id="btn_tube_ass_list" type="button" value="管路評估" onclick="window.location.href = 'Assessment_List';" />
            </td>
        </tr>
        <tr>
            <td style="padding:5px 0 5px 0;">
                護理站：
                @Html.DropDownList("selStation", (List<SelectListItem>)ViewData["costlist"], new { })
                <select id="select_tube_type" onchange="selectchange();">
                    <option value="1">管路使用明細</option>
                    <option value="2">管路使用彙量</option>
                </select>
                種類：
                @Html.TextBox("txt_type", "全部", new { style="width:120px;",onclick = "showPopup('dv_type');"})
                <input type="hidden" id="type_id" value="all" />
            </td>
        </tr>
        <tr>
            <td style="padding:5px 0 5px 0;">
                @Html.TextBox("start_date", @DateTime.Now.AddMonths(-1).ToString("yyyy/MM/dd"), new { style = "width:80px", @readonly = "readonly" })
                @WebTool.complementList_Status(complement_List.Status, pf.InDate.ToString("MM/dd/yyyy HH:mm"), @DateTime.Now.ToString("yyyy/MM/dd"), "start_date", "", false)
                @Html.Label("lab"," ~ ")
                @Html.TextBox("end_date", @DateTime.Now.ToString("yyyy/MM/dd"), new { style = "width:80px", @readonly = "readonly" })
                @WebTool.complementList_Status(complement_List.Status, pf.InDate.ToString("MM/dd/yyyy HH:mm"), @DateTime.Now.ToString("yyyy/MM/dd"), "end_date", "", false)
                <input type="button" value="查詢" onclick="search();" />
                <input type="button" value="產生Excel" onclick="provite_exl();" />
            </td>
        </tr>
    </table>
    <div id="part_detail" style="display:none;">
        <div class="dataHeader">
            <table border="0" cellpadding="4" cellspacing="1" style="width:100%;font-size:14px;">
                <tr>
                    <td style="width:5%;">序號</td>
                    <td style="width:10%;">病歷號</td>
                    <td style="width:9%;">床號</td>
                    <td style="width:9%;">姓名</td>
                    <td style="width:9%;">主治醫師</td>
                    <td style="width:10%;">診斷</td>
                    <td style="width:8%;">住入日期</td>
                    <td style="width:12%;">管路類別</td>
                    <td style="width:9%;">插管日期<br />時間</td>
                    <td style="width:9%;">拔管日期<br />時間</td>
                    <td style="width:5%;">使用天數</td>
                </tr>
            </table>
        </div>
        <div id="report_detail" class="dataArea">
        </div>
    </div>
    <div id="part_amount">
        <div id="report_amount">
        </div>
    </div>
    <div id="part_room" style="display:none;">
        <div class="dataHeader">
            <table border="0" cellpadding="4" cellspacing="1" style="width:100%;">
                <tr>
                    <th>床號</th>
                    <th style="width:9%;">姓名</th>
                    <th style="width:9%;">性別</th>
                    <th style="width:9%;">Floey</th>
                    <th style="width:9%;">A-line</th>
                    <th style="width:9%;">Port-A</th>
                    <th style="width:9%;">PiCCO</th>
                    <th style="width:9%;">CVP</th>
                    <th style="width:9%;">Sheath</th>
                    <th style="width:9%;">PICC</th>
                </tr>
            </table>
        </div>
        <div id="report_room" class="dataArea">
        </div>
    </div>
</div>

<div id="dv_type" class="popup" style="display:none;overflow-y:auto;overflow-x:hidden;">
    <table border="1" cellpadding="1" cellspacing="0" style="width:100%;background-color: #EEEFFF;border: 1px solid #CC88FF;margin-bottom:5px;">
        <tr>
            <th colspan="5" style="background-color:#CC88FF;">不用計量、部位及位置類</th>
        </tr>
        <tr>
        @if (dt_tubekind_three != null)
        {
            int row = dt_tubekind_three.Rows.Count;
            if (row % 5 != 0)
            {
                row = row + (5 - row % 5);
            }
            for (int i = 0; i < row; i++)
            {
                if (i < dt_tubekind_three.Rows.Count)
                {
            <td width="20%" class="normal">
                <input type="checkbox" id="@dt_tubekind_three.Rows[i]["KINDID"]" name="typeid" value="@dt_tubekind_three.Rows[i]["KINDNAME"]" />
                <label for="@dt_tubekind_three.Rows[i]["KINDID"]">@dt_tubekind_three.Rows[i]["KINDNAME"]</label>
            </td>
                    if ((i + 1) % 5 == 0)
                    {
            @:</tr><tr>       
                    }
                }
                else
                {
            <td width="20%" class="normal">&nbsp;</td>
                }
            }
        }
        </tr>
        <tr>
            <th colspan="5" style="background-color:#CC88FF;">不用計量</th>
        </tr>
        <tr>
        @if (dt_tubekind_two != null)
        {
            int row = dt_tubekind_two.Rows.Count;
            if (row % 5 != 0)
            {
                row = row + (5 - row % 5);
            }
            for (int i = 0; i < row; i++)
            {
                if (i < dt_tubekind_two.Rows.Count)
                {
            <td width="20%" class="normal">
                <input type="checkbox" id="@dt_tubekind_two.Rows[i]["KINDID"]" name="typeid" value="@dt_tubekind_two.Rows[i]["KINDNAME"]" />
                <label for="@dt_tubekind_two.Rows[i]["KINDID"]">@dt_tubekind_two.Rows[i]["KINDNAME"]</label>
            </td>
                    if ((i + 1) % 5 == 0)
                    {
            @:</tr><tr>
                    }
                }
                else
                {
            <td width="20%" class="normal">&nbsp;</td>
                }
            }
        }
        </tr>
        <tr>
            <th colspan="5" style="background-color:#CC88FF;">可計量類</th>
        </tr>
        <tr>
            @if (dt_tubekind_one != null)
            {
                int row = dt_tubekind_one.Rows.Count;
                if (row % 5 != 0)
                {
                    row = row + (5 - row % 5);
                }
                for (int i = 0; i < row; i++)
                {
                    if (i < dt_tubekind_one.Rows.Count)
                    {
            <td width="20%" class="normal">
                <input type="checkbox" id="@dt_tubekind_one.Rows[i]["KINDID"]" name="typeid" value="@dt_tubekind_one.Rows[i]["KINDNAME"]" />
                <label for="@dt_tubekind_one.Rows[i]["KINDID"]">@dt_tubekind_one.Rows[i]["KINDNAME"]</label>
            </td>
                        if ((i + 1) % 5 == 0)
                        {
            @:</tr><tr>
                    }
                    }
                    else
                    {
                    <td width="20%" class="normal">&nbsp;</td>
                    }
                }
            }
        </tr>
        <tr>
            <th colspan="5" style="background-color:#CC88FF;">其他</th>
        </tr>
        <tr>
            @if (dt_tubekind_other != null)
            {
                int row = dt_tubekind_other.Rows.Count;
                if (row % 5 != 0)
                {
                    row = row + (5 - row % 5);
                }
                for (int i = 0; i < row; i++)
                {
                    if (i < dt_tubekind_other.Rows.Count)
                    {
            <td width="20%" class="normal">
                <input type="checkbox" id="@dt_tubekind_other.Rows[i]["KINDID"]" name="typeid" value="@dt_tubekind_other.Rows[i]["KINDNAME"]" />
                <label for="@dt_tubekind_other.Rows[i]["KINDID"]">@dt_tubekind_other.Rows[i]["KINDNAME"]</label>
            </td>
                        if ((i + 1) % 5 == 0)
                        {
            @:</tr><tr>
                        }
                    }
                    else
                    {
                    <td width="20%" class="normal">&nbsp;</td>
                    }
                }
            }
        </tr>
        <tr>
            <td colspan="5">
                <input id="all" type="checkbox" value="all" onclick="ck_all(this);" />
                <label for="all">全選</label>
            </td>
        </tr>
        <tr>
            <td colspan="5" style="text-align:center;">
                <div class="funcArea">
                    <input type="button" value="確認" onclick="rValue();" />
                    <input type="button" value="取消" onclick="$('#dv_type').fadeOut(0);" />
                </div>
            </td>
        </tr>
    </table>
</div>