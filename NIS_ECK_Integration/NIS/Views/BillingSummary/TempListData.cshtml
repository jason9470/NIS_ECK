@using System.Data;
@using NIS.Data
@using NIS.Controllers;
@{
    DataTable dt = ViewBag.dt;
    UserInfo ui = (UserInfo)Session["UserInfo"];
    List<Bill_Summary_Master> Summarydata = ViewBag.Summary;
    NIS.Data.Complement_List complement_List = (NIS.Data.Complement_List)Session["Complement_List"];
    List<SelectListItem> costcodelist = (List<SelectListItem>)ViewData["costlist"];
    List<SelectListItem> typeList = (List<SelectListItem>)ViewData["typeList"];

    int patientCount = 0;
    if (Summarydata != null)
    {
        patientCount = Summarydata.Count();
    }
}
<style type="text/css">
    .dataArea td {
        border-bottom: 1px solid rgba(20%,20%,40%,0.5);
        text-align: left;
    }

    #module_define {
        padding: 5px 0px 3px 0px;
        text-align: center;
        background-color: #9999FF;
        width: 100%;
        border: 1px solid #BBBBBB;
        border-right: 2px solid #999999;
        border-bottom: 2px solid #999999;
    }
</style>
<script type="text/javascript">
    $(document).ready(function () {
        setGridColor();
        $(window).resize(function () {
            var height = $(this).outerHeight();
            if (height <= 300)
                height = 450;
            $(".dataAreaX").outerHeight(height - 180);
        }).trigger("resize");
    });
    function setGridColor() {
        //格行換色
        $('.dataArea tr:odd').css('background', 'rgb(211 237 249)');
        $('.dataArea tr:even').css('background', 'rgb(231, 238, 245)');
    }
      function svae() {

      $('#save_btn').prop('disabled', true);
      var ptCount = '@patientCount'
      var save_obj = [];


      for (i = 0; i < ptCount; i++) {

          var save_obj_dtl = [];
          var trLength = $("#PT_" + i + " tr").length;

          for (j = 0; j < trLength; j++) {

              var recordTime = $('#PT_' + i).find('tr').eq(j).children("td:eq(1)").text();
              var cover = $('#PT_' + i).find('tr').eq(j).children("td:eq(2)").text();
              var set = $('#PT_' + i).find('tr').eq(j).children("td:eq(3)").text();
              var HO_ID = $('#PT_' + i).find('tr').eq(j).children("td:eq(4)").text();
              var name = $('#PT_' + i).find('tr').eq(j).children("td:eq(5)").text();
              var type = $('#PT_' + i).find('tr').eq(j).children("td:eq(6)").text();

              var identity = $('#PT_' + i).find('tr').eq(j).children("td:eq(8)").find("select").val();
              var price = $('#PT_' + i).find('tr').eq(j).children("td:eq(9)").text();
              var self = $('#PT_' + i).find('tr').eq(j).children("td:eq(10)").text();
              var costcode = $('#PT_' + i).find('tr').eq(j).children("td:eq(13)").find("select").val();
              var serial = $('#PT_' + i).find('tr').eq(j).children("td:eq(14)").text();
              var count = $("#count_" + i + j).val();
              var selfPrice = $("#priceSF_" + i + j).text();

              var obj = {
                  RECORD_DATE: recordTime,
                  HO_ID: HO_ID,
                  ITEM_NAME: name,
                  ITEM_TYPE: type,
                  COUNT: count,
                  ITEM_IDENTITY: identity,
                  ITEM_PRICE: price,
                  COSTCODE: costcode,
                  SERIAL: serial,
                  COVER: cover,
                  SET: set,
                  DOCTOR: $("#doctor_" + i + j).text(),
                  NH_CODE: $("#NH_CODE_" + i + j).text(),
                  PT_COSTCODE: $("#PT_COSTCODE_" + i + j).text(),
                  SELF_PRICE: selfPrice,

              };
              if (HO_ID != "" && HO_ID != undefined && count != "0" && count != undefined) {
                  save_obj_dtl.push(obj);
              }
          }
          var PTobj = {
              CHARTNO: $("#PT_chartno_" +i).text(),
              NAME: $("#PT_name_" + i).text(),
              BEDNO: $("#PT_bedno_" + i).text(),
              SEX: $("#PT_sex_" + i).text(),
              FEENO: $("#PT_feeno_" + i).text(),
              Bill_D: save_obj_dtl,
          };
          if (PTobj.Bill_D != null) {
              save_obj.push(PTobj);
          }
      }

         $.ajax({
          type: 'POST',
          cache: false,
          dataType: 'json',
          contentType: "application/json; charset=utf-8",
          url: '@Url.Content("~/BillingSummary/SaveBillingTemp")',
          data: JSON.stringify({
              data: save_obj,
              date: ''
          }),
           success: function (data) {
               if (data.status == 0) {
                   alert("儲存成功");
                   $('#save_btn').prop('disabled', false);

                   window.location.href = 'Index';

               }
               loop_windows("close_cover");
          }
         });

  }
</script>
<div class="card" style="overflow-y: scroll">
    @if (Summarydata != null)
    {
        for (int i = 0; i < Summarydata.Count; i++)
        {
            <div style="background-color: #d7d8db; width: 98%; margin-left: 1rem; border-radius: 10px; margin-top: 0.6rem">
                <div style="display: flex; margin-top: 0.4rem; background-color: #cde9fd; width: 100%; min-width: 505px; border-radius: 10px; font-size:larger">
                    <div style="display: flex; margin: 1rem; margin-top: 0.5rem; width: 90%; font-size: larger;">
                        <div style="font-weight:600">
                            床號 :
                            <lable id="PT_bedno_@i">  @Summarydata[i].BEDNO </lable>
                        </div>
                        <div style="margin-left:1rem">
                            病歷號 :
                            <lable id="PT_chartno_@i"> @Summarydata[i].CHARTNO </lable>
                            <lable id="PT_feeno_@i" style="display:none"> @Summarydata[i].FEENO </lable>

                        </div>
                        <div style="margin-left:1rem">
                            姓名 :
                            <lable id="PT_name_@i"> @Summarydata[i].NAME </lable>
                        </div>
                        <div style="margin-left:1rem">
                            性別 :
                            <lable id="PT_sex_@i"> @Summarydata[i].SEX </lable>
                        </div>
                        <div style="margin-left:1rem">
                            待確認數量 :
                            <lable id="PT_sex_@i">@Summarydata[i].Bill_D.Count()  </lable>
                        </div>
                    </div>
                    <div style="text-align: right; width: 10%; margin-right:0.3rem">
                        <input type="button" id="" class="fun_btn" style="width: 35px; background-color: #3c7ec3; margin-top: 0.5rem; border-radius: 20px !important; font-size: 24px !important; margin-right: 0.5rem" value="+" onclick="if ($(this).val() == '+') { $('#card_' + @i).show(); $(this).val('-')}  else{$('#card_' + @i).hide(); $(this).val('+')}  ">
                    </div>
                </div>
                <div id="card_@i.ToString()" style="display:none">
                    @*<div class="dataHeader">
                        <table border="0" cellpadding="4" cellspacing="1" style="width:100%;font-size:16px;">
                            <tr>
                                <td rowspan="14" style="width: 14%;">計價處置及衛材內容</td>
                            </tr>
                        </table>
                    </div>*@
                    <div class="dataHeader">
                        <table border="0" cellpadding="4" cellspacing="1" style="width:100%;font-size:14px;">
                            <tr>
                                <td colspan="2" style="width: 4%;"></td>
                                <td colspan="2" style="width: 9%; ">使用時間</td>
                                <td colspan="2" style="width: 3%; ">回補</td>
                                <td colspan="2" style="width: 9%; ">組套</td>
                                <td colspan="2" style="width: 10%; ">院內碼</td>
                                <td colspan="2" style="width: 14%;">名稱</td>
                                <td colspan="2" style="width: 7%;">類別</td>
                                <td colspan="2" style="width: 12%;">數量</td>
                                <td colspan="2" style="width: 6%;">身分</td>
                                <td colspan="2" style="width: 10%;">費用</td>
                                <td colspan="2" style="width: 10%;">自費同意書簽屬狀態</td>
                                <td colspan="2" style="width: 150px; min-width: 150px; max-width: 150px; ">扣庫單位</td>
                            </tr>
                        </table>
                    </div>
                    <div class="" style="font-size: 14px; text-align: center; ">
                        <table id="PT_@i.ToString()" cellpadding="4" cellspacing="1" style="width: 100%; font-size: 14px;">

                            @if (Summarydata[i].Bill_D.Count > 0)
                            {
                                for (int j = 0; j < Summarydata[i].Bill_D.Count; j++)
                                {
                                    <tr id="@i.ToString()@j.ToString()" style="background-color: #e8ebeb">
                                        <td rowspan="1" style="width: 4%;">
                                            <input type="button" class="fun_btn" id="" onclick="DelData(@i.ToString(),@j.ToString());" value="-" style="width: 30px; background-color: #ed6f6f; margin: 0.5rem !important; " />
                                        </td>
                                        <td colspan="2" style="width: 9%; ">@Summarydata[i].Bill_D[j].RECORD_DATE</td>
                                        <td colspan="2" style="width: 3%; ">
                                            @if (@Summarydata[i].Bill_D[j].COVER == "Y")
                                            {
                                                <label>Y</label>
                                            }
                                        </td>
                                        <td colspan="2" style="width: 9%; ">@Summarydata[i].Bill_D[j].SET</td>
                                        <td colspan="2" style="width: 10%; ">@Summarydata[i].Bill_D[j].HO_ID</td>
                                        <td colspan="2" style="width: 14%;">@Summarydata[i].Bill_D[j].ITEM_NAME</td>
                                        <td colspan="2" style="width: 7%;">@Summarydata[i].Bill_D[j].ITEM_TYPE</td>
                                        <td colspan="2" style="width: 12%;">
                                            <input type='button' class='fun_btn' onclick="less(@i.ToString(),@j.ToString());" value='-' style='width: 23px; background-color: #ed6f6f; margin: 0.3rem!important; ' />
                                            <input id='count_@i.ToString()@j.ToString()' name='count_@i.ToString()@j.ToString()' style='width:20px;text-align:center;border-radius :10px !important;height: 20px;' type='text' value='@Summarydata[i].Bill_D[j].COUNT'>
                                            <input type="button" class="fun_btn" onclick="plus(@i.ToString(),@j.ToString());" value="+" style="width: 23px; background-color:#5ad352; margin: 0.3rem!important;" />
                                        </td>
                                        <td colspan="2" style="width: 6%;">
                                            <select id="type_@i.ToString()@j.ToString()" style="width:40px;text-align:center;border-radius :10px !important;height: 20px;" onchange='priceCount(@i.ToString(),@j.ToString())'>
                                                @if (typeList.Count > 0)
                                                {
                                                    foreach (var item in typeList)
                                                    {
                                                        if (item.Value == @Summarydata[i].Bill_D[j].ITEM_IDENTITY)
                                                        {
                                                            <option value="@item.Value" selected>@item.Value</option>
                                                        }
                                                        else
                                                        {
                                                            <option value="@item.Value">@item.Value</option>
                                                        }
                                                    }
                                                }
                                            </select>
                                        </td>
                                        <td colspan="2" id="pricesum_@i.ToString()@j.ToString()" style="width: 10%;">@Summarydata[i].Bill_D[j].ITEM_PRICE</td>
                                        <td style="display:none" colspan="2" id="priceNH_@i.ToString()@j.ToString()">@Summarydata[i].Bill_D[j].NH_PRICE</td>
                                        <td style="display:none" colspan="2" id="priceSF_@i.ToString()@j.ToString()">@Summarydata[i].Bill_D[j].SELF_PRICE</td>
                                        <td colspan="2" style="width: 10%; "></td>
                                        <td colspan="2" style="width: 6%;">
                                            <select style="width:150px;text-align:center;border-radius :10px !important;height: 20px;">
                                                @if (costcodelist.Count > 0)
                                                {
                                                    foreach (var item in costcodelist)
                                                    {
                                                        if (item.Value == @Summarydata[i].Bill_D[j].COSTCODE)
                                                        {
                                                            <option value="@item.Value" selected>@item.Text</option>
                                                        }
                                                        else
                                                        {
                                                            <option value="@item.Value">@item.Text</option>
                                                        }
                                                    }
                                                }

                                            </select>
                                        </td>
                                        <td id='serial_@i.ToString()@j.ToString()' colspan="2" style="display:none ">@Summarydata[i].Bill_D[j].SERIAL</td>
                                        <td style="display:none" id="doctor_@i.ToString()@j.ToString()">@Summarydata[i].Bill_D[j].DOCTOR</td>
                                        <td style="display:none" id="NH_CODE_@i.ToString()@j.ToString()">@Summarydata[i].Bill_D[j].NH_CODE</td>
                                        <td style="display:none" id="PT_COSTCODE_@i.ToString()@j.ToString()">@Summarydata[i].Bill_D[j].PT_COSTCODE</td>

                                    </tr>
                                }
                            }
                            else
                            {
                                <tr><td colspan="27">無資料</td></tr>
                            }
                        </table>
                    </div>
                </div>                
                </div>
        }
    }

</div>
