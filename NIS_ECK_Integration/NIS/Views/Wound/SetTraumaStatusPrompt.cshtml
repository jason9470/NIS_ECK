@using System.Data;
@{
    Layout = "~/Views/Layout/FormLayout.cshtml";
    NIS.Data.PatientInfo pf = (NIS.Data.PatientInfo)Session["PatInfo"];
    NIS.Data.Complement_List complement_List = (NIS.Data.Complement_List)Session["Complement_List"];
    DateTime mindate = DateTime.Now;
    if (complement_List.Status) { mindate = pf.InDate; }
    else
    {
        if (DateTime.Now.Hour < 24)//20171030 改規則 AlanHuang
        {
            mindate = Convert.ToDateTime(DateTime.Now.AddDays(-1).ToString("yyyy/MM/dd 00:00"));
        }
        else if (DateTime.Now.Day == 1 && DateTime.Now.Hour < 24)
        {
            if (((DateTime.Now.Year % 4 == 0) && (DateTime.Now.Year % 100 != 0)) || (DateTime.Now.Year % 400 == 0))//判斷閏年
            {
                if (DateTime.Now.Month == 2)
                {
                    mindate = Convert.ToDateTime(DateTime.Now.AddMonths(-1).AddDays(28).ToString("yyyy/MM/dd 00:00"));
                }
            }
            if (DateTime.Now.Month == 1 || DateTime.Now.Month == 3 || DateTime.Now.Month == 5 || DateTime.Now.Month == 7 || DateTime.Now.Month == 8 || DateTime.Now.Month == 10 || DateTime.Now.Month == 12)
            {
                mindate = Convert.ToDateTime(DateTime.Now.AddMonths(-1).AddDays(30).ToString("yyyy/MM/dd 00:00"));
            }
            else
            {
                if (DateTime.Now.Month == 2) { mindate = Convert.ToDateTime(DateTime.Now.AddMonths(-1).AddDays(27).ToString("yyyy/MM/dd 00:00")); }
                else { mindate = Convert.ToDateTime(DateTime.Now.AddMonths(-1).AddDays(29).ToString("yyyy/MM/dd 00:00")); }
            }
        }
        else
        { mindate = Convert.ToDateTime(DateTime.Now.ToString("yyyy/MM/dd 00:00")); }
        if (pf != null)
        {
            if (pf.InDate > mindate)
            { mindate = pf.InDate; }
        }
    }
    DataTable dt = ViewBag.dt;
}

<style type="text/css">
    .dataArea td {
        border-bottom: 1px solid rgba(20%,20%,40%,0.5);
        text-align: left;
    }
</style>

<div class="funcArea">
    <div style="padding:5px;text-align:center;">
        <span style="font-size:18px;color:blue;">傷口記錄結案</span>
    </div>
    <div class="dataHeader">
        <table border="0" cellpadding="4" cellspacing="1" style="width:100%;">
            <tr>
                <td style="width:5%;">編號</td>
                <td style="width:10%;">發生日期</td>
                <td style="width:10%;">傷口種類</td>
                <td style="width:8%;">部位</td>
                <td style="width:11%;">發生地點</td>
                <td style="width:20%;">結案日期</td>
                <td style="width:36%;">結案原因</td>
            </tr>
        </table>
    </div>
    <div class="dataArea" style="height:440px;">
        <table id="Dt" border="0" cellpadding="4" cellspacing="1" style="width:100%;">
            @foreach (DataRow r in dt.Rows)
            {
            <tr data-id="@(r["WOUND_ID"])" data-num="@(r["NUM"])" data-position="@(r["POSITION"])" data-type="@(r["TYPE"])" data-createTime="@(r["CREATTIME"])">
                <td style="width:5%;text-align:center;">
                    <label>@(r["NUM"])</label>
                </td>
                <td style="width:10%;">
                @if (!string.IsNullOrWhiteSpace(r["CREATTIME"].ToString()))
                {
                    <label>@Convert.ToDateTime(r["CREATTIME"]).ToString("yyyy/MM/dd")</label>
                }
                else
                {
                    <label>不詳</label>
                }
                </td>
                <td style="width:10%;">@r["TYPE"]</td>
                <td style="width:8%;">@r["POSITION"]</td>
                <td style="width:11%;">@r["LOCATION"]</td>
                <td style="width:20%;">
                    <input type="text" id="wound_date_@(r["WOUND_ID"])" name="wound_date" value="@DateTime.Now.ToString("yyyy/MM/dd")" />
                    <input type="text" id="wound_time_@(r["WOUND_ID"])" name="wound_time" value="@DateTime.Now.ToString("HH:mm")" />
                    @*@WebTool.setDateTime("wound_date_" + r["WOUND_ID"], "wound_time_" + r["WOUND_ID"], "", "0", "", mindate.ToString("MM/dd/yyyy HH:mm:ss"))*@
                    @WebTool.complementList_Status(complement_List.Status, pf.InDate.ToString("MM/dd/yyyy HH:mm"), @DateTime.Now.ToString("yyyy/MM/dd"), "wound_date_" + r["WOUND_ID"], "wound_time_" + r["WOUND_ID"], true)
                </td>
                <td style="width:36%;">
                    <label><input type="radio" name="ReasSon_@(r["WOUND_ID"])" value="痊癒" onclick="SwitchSubProject(this);" />痊癒</label>
                    <label><input type="radio" name="ReasSon_@(r["WOUND_ID"])" value="截肢" onclick="SwitchSubProject(this);" />截肢</label>
                    <label><input type="radio" name="ReasSon_@(r["WOUND_ID"])" value="擴創" onclick="SwitchSubProject(this);" />擴創</label>
                    <label><input type="radio" name="ReasSon_@(r["WOUND_ID"])" value="植皮" onclick="SwitchSubProject(this);" />植皮</label>
                    <label><input type="radio" name="ReasSon_@(r["WOUND_ID"])" value="縫合" onclick="SwitchSubProject(this);" />縫合</label>
                    <label><input type="radio" name="ReasSon_@(r["WOUND_ID"])" value="其他" data-target="Y" onclick="SwitchSubProject(this);" />其他</label>
                    <span class="ReasSon_@(r["WOUND_ID"])" style="display:none;">
                        <input type="text" class="req_txt" name="txt_Reason_other_@(r["WOUND_ID"])" disabled="disabled" />
                    </span>
                </td>
            </tr>
            }
        </table>
    </div>
    <div style="padding:5px;text-align:center;">
	    <input type="button" value="傷口紀錄新增存檔" onclick="Save();" />
        <input type="button" value="放棄目前編輯資料" onclick="if (confirm('確認放棄?')) window.close();" />
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function () {
        $(window).focus(function () {
            window.opener.parent.check_session();
        });
        $('.dataArea tr:odd').css('background', '#ABC8E2');
        $('.dataArea tr:even').css('background', '#E1E6FA');
    });

    function Save(obj) {
        $(obj).prop('disabled', true);
        if (check()) {
            var DataList = [];
            var DataObj;
            var WoundID;
            $.each($('#Dt tr'), function (i, item) {
                WoundID = $(item).attr('data-id');
                DataObj = new Object();
                DataObj['WoundID'] = WoundID;
                DataObj['EndDateTime'] = $(item).find('input[type=text][name=wound_date]').val() + ' ' + $(item).find('input[type=text][name=wound_time]').val();
                if ($(item).find('input[type=text][name=txt_Reason_other_' + WoundID + ']:visible:enabled').length > 0)
                    DataObj['EndReason'] = $.trim($(item).find('input[type=text][name=txt_Reason_other_' + WoundID + ']').val());
                else
                    DataObj['EndReason'] = $(item).find('input[type=radio][name=ReasSon_' + WoundID + ']:checked').val();
                DataObj['WoundPosition'] = $(item).attr('data-position');
                DataObj['WoundType'] = $(item).attr('data-type');
                DataObj['CreateTime'] = $(item).attr('data-createTime');
                DataList.push(DataObj);
            });
            $.ajax({
                type: 'POST',
                url: '@Url.Content("~/Wound/SaveSetTraumaStatusPrompt")',
                data: { 'DataList': JSON.stringify(DataList) },
                success: function (data) {
                    if (data == "Y") {
                        alert('更新成功');
                        window.opener.location.href = '@Url.Content("~/Wound/listTrauma")';
                        window.close();
                    }
                    else {
                        alert('更新失敗');
                    }
                },
                complete: function () {
                    $(obj).prop('disabled', false);
                }
            });
        }
        else
            $(obj).prop('disabled', false);
    }

    function check() {
        var success = true;
        $.each($('#Dt tr'), function (i, item) {
            var WoundID = $(item).attr('data-id');
            var Reason = $(item).find('input[type=radio][name=ReasSon_' + WoundID + ']:checked');
            if (Reason.length > 0) {
                if ($(item).find('input[type=text][name=txt_Reason_other_' + WoundID + ']:visible:enabled').length > 0) {
                    if ($.trim($(item).find('input[type=text][name=txt_Reason_other_' + WoundID + ']').val()) == '') {
                        alert('請輸入 編號：' + $(item).attr('data-num') + '：結案原因：其他欄位');
                        success = false;
                        return false;
                    }
                }
            }
            else {
                alert('請選擇 編號：' + $(item).attr('data-num') + '：結案原因');
                success = false;
                return false;
            }
        });
        return success;
    }

    function SwitchSubProject(obj) {
        switch ($(obj).attr('type')) {
            case 'radio':
                SwitchSubProject_(obj, $(obj).attr('data-target') == "Y");
                break;
            case 'checkbox':
                SwitchSubProject_(obj, $(obj).prop('checked'));
                break;
        }
    }

    function SwitchSubProject_(obj, bool) {
        var obj_ = '.' + $(obj).attr('name');
        if (bool) {
            $(obj_).show().find('*').prop('disabled', false);
            $(obj_).find('input[type=text]:first').focus();
        }
        else {
            $(obj_).hide().find('input[type=text]').val('').prop('disabled', true);
            $(obj_).find('select').prop('selectedIndex', 0).prop('disabled', true);
            $(obj_).find('input[type=radio], input[type=checkbox]').prop('checked', false).prop('disabled', true);
        }
    }
</script>