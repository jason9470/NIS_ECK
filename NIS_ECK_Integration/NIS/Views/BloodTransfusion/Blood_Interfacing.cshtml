@using NIS.Controllers;
@using System.Data;
@using NIS.Models;
@{
    //Layout = "~/Views/Layout/FormLayout.cshtml";
    //日期選擇器，鎖定時間
    NIS.Data.PatientInfo pf = (NIS.Data.PatientInfo)Session["PatInfo"];
    NIS.Data.Complement_List complement_List = (NIS.Data.Complement_List)Session["Complement_List"];
    List<Dictionary<string, string>> BLOODID_List = ViewBag.BLOODID_List;
    var blood_id_list = new List<string>();
    if (BLOODID_List.Count > 0)
    {
        foreach (var data in BLOODID_List)
        {
            blood_id_list.Add(data["blood_id"]);
        }
    }

}

<style type="text/css">
    #module_define {
        padding: 5px 0px 3px 0px;
        text-align: left;
        background-color: #d5d5f7;
        width: 100%;
        border-radius: 5px;
        font-size: 28px;
        font-weight: 800
    }

    .dataArea {
        border: 0 !important;
        border-radius: 10px !important;
        font-family: Arial, EUDC !important;
        overflow-y: scroll !important;
    }

        .dataArea td {
            text-align: left;
            height: 20px !important;
        }

    .count_btn {
        border-radius: 60px;
        border-width: 0;
        color: white;
        background-color: #3c7ec3;
        height: 20px;
    }

    .fun_btn {
        font-size: 18px !important;
        box-shadow: none !important;
        border-radius: 10px !important;
        border: 0 !important;
        margin: 0.5rem !important;
        width: 70px !important;
        color: white !important;
    }

    .dataHeader {
        text-align: center !important;
        border-radius: 6px !important;
        font-size: 20px !important;
        margin-right: 0 !important
    }

    .funcArea legend {
        margin-left: 5px;
        font-size: 14px;
        font-family: "微軟正黑體";
        background: #E1E6FA;
        padding: 3px 7px 2px 7px;
        border-top: 0 !important;
        border-left: 0 !important;
        border-right: 0 !important;
        border-bottom: 0 !important;
        border-radius: 10px;
    }
</style>

<script type="text/javascript">
    $(document).ready(function () {
        setGridColor();
        //格行換色
        setTimeout(function () { $(".dtl_VS").gridColor(); }, 0);

        @if (Request["message"] != null)
        {
        @:showHint("@(Request["message"].ToString())");
        }
    });

    //格行換色
    function setGridColor() {
        //格行換色
        $('.dataArea tr:odd').css('background', 'rgb(211 237 249)');
        $('.dataArea tr:even').css('background', 'rgb(231, 238, 245)');
        $('.dtl_VS tr:odd').css('background', 'rgb(211 237 249)');
        $('.dtl_VS tr:even').css('background', 'rgb(231, 238, 245)');
    }

    //帶入血品
    function btn_write(d, t, time, blood_id, name, number, type, unit, exp) {
        let result = {
            Blood_ID: "",
            Blood_Time: "",
            Blood_Name: "",
            Blood_Number: "",
            Blood_Type: "",
            Blood_Unit: "",
            Blood_Exp: ""
        }

        if (blood_id != null && blood_id != "")
            result.Blood_ID = blood_id;
        if (time != null && time != "")
            result.Blood_Time = time;
        if (name != null && name != "")
            result.Blood_Name = name;
        if (number != null && number != "")
            result.Blood_Number = number;
        if (type != null && type != "")
            result.Blood_Type = type;
        if (unit != null && unit != "")
            result.Blood_Unit = unit;
        if (exp != null && exp != "")
            result.Blood_Exp = exp;

        hideImportBtn(blood_id);
        addBlood(result);
    }

    //隱藏帶入按鈕
    function hideImportBtn(bloodID) {
        if (bloodID == null || bloodID == '') {
            return;
        }
        let matchBtn = document.getElementById('importBtn_' + bloodID);
        if (matchBtn != null) {
            matchBtn.style.display = 'none';
        }
    }
</script>

<div>
    <table style="width: 100%;border-spacing:0px 0px;" cellspacing="0">
        <tr>
            <td id="VS_Import_Table" style="vertical-align: top; width: 100%;">
                <div class="dataHeader" id="dataHeader" style="width: calc(100% - 15px)">
                    <table id="table_dataHeader" border="0" cellpadding="4" cellspacing="1" style="table-layout: fixed; white-space: nowrap; font-size: 14px; width: 100%;" class="dtl_VS">
                        <tr>
                            <td style="width: 10%; background-color: #cfe1eb; text-align: center; ">帶入</td>
                            <td style="width: 10%; background-color: #cfe1eb; text-align: center; ">時間</td>
                            <td style="width: 20%; background-color: #cfe1eb; text-align: center; ">血品名稱</td>
                            <td style="width: 10%; background-color: #cfe1eb; text-align: center; ">血袋號碼</td>
                            <td style="width: 10%; background-color: #cfe1eb; text-align: center; ">血型/Rh(D)</td>
                            <td style="width: 10%; background-color: #cfe1eb; text-align: center; ">血品單位</td>
                            <td style="width: 10%; background-color: #cfe1eb; text-align: center; ">血品效期</td>
                            <td style="width: 10%; background-color: #cfe1eb; text-align: center; ">輸血帶入</td>
                            <td style="width: 10%; background-color: #cfe1eb; text-align: center; ">帶入時間</td>
                        </tr>
                    </table>
                </div>
                <!-- 表頭隨著資料內容一起動 -->
                <div class="dataArea" style="width: 100%; overflow-x: auto; overflow-y:scroll;">
                    <table id="table_dataArea" border="0" cellpadding="4" cellspacing="1" style="width: 100%" class="dataArea">
                        @{
                            if (ViewData["result"] != null)
                            {
                                List<BloodTransfusion.BloodImport> BloodDataList = (List<BloodTransfusion.BloodImport>)ViewData["result"];
                                for (int i = 0; i <= BloodDataList.Count - 1; i++)
                                {
                                    var Blood_Time = BloodDataList[i].Blood_Time;
                                    var Blood_Time_Date = "";
                                    var Blood_Time_Time = "";
                                    if (!string.IsNullOrEmpty(Blood_Time))
                                    {
                                        Blood_Time_Date = DateTime.Parse(Blood_Time).ToString("yyyy/MM/dd");
                                        Blood_Time_Time = DateTime.Parse(Blood_Time).ToString("HH:mm");
                                    }

                                    <tr>
                                        <td style="width: 10%; text-align: center; ">
                                            @*<input type="button" value="帶入" onclick="btn_write(@vsDataList[i].TEMP,@vsDataList[i].HR,@vsDataList[i].RESP,@vsDataList[i].SYSTOLIC,@vsDataList[i].DIATOLIC,@vsDataList[i].SPO2);" />*@
                                            @*<input type="button" value="帶入" onclick="btn_write(@Convert.ToDateTime(vsDataList[i].MDATE).ToString("yyyy/MM/dd"),@Convert.ToDateTime(vsDataList[i].MDATE).ToString("HH:mm"),@Convert.ToDouble(vsDataList[i].TEMP),@Convert.ToDouble(vsDataList[i].HR),@Convert.ToDouble(vsDataList[i].RESP),@vsDataList[i].SYSTOLIC,@Convert.ToDouble(vsDataList[i].DIATOLIC),@Convert.ToDouble(vsDataList[i].SPO2));" />*@
                                            @if (!blood_id_list.Contains((BloodDataList[i].Blood_ID)))
                                            {
                                                <input id="importBtn_@BloodDataList[i].Blood_ID" type="button" class="fun_btn" value="帶入" style="width: 40px !important; font-size: 14px !important; margin-left: 0 !important; background-color: #3c7ec3; border-radius: 5px !important ;cursor:pointer" onclick="btn_write('@(Convert.ToDateTime(DateTime.Now).ToString("yyyy/MM/dd"))','@(Convert.ToDateTime(DateTime.Now).ToString("HH:mm"))','@(BloodDataList[i].Blood_Time)','@(BloodDataList[i].Blood_ID)','@(BloodDataList[i].Blood_Name)','@(BloodDataList[i].Blood_Number)','@(BloodDataList[i].Blood_Type)','@(BloodDataList[i].Blood_Unit)','@(BloodDataList[i].Blood_Exp)');" />
                                            }
                                            else
                                            {
                                                <input id="importBtn_@BloodDataList[i].Blood_ID" type="button" class="fun_btn" value="帶入" style="width: 40px !important; font-size: 14px !important; margin-left: 0 !important; background-color: #3c7ec3; border-radius: 5px !important ;cursor:pointer;display:none" onclick="btn_write('@(Convert.ToDateTime(DateTime.Now).ToString("yyyy/MM/dd"))','@(Convert.ToDateTime(DateTime.Now).ToString("HH:mm"))','@(BloodDataList[i].Blood_Time)','@(BloodDataList[i].Blood_ID)','@(BloodDataList[i].Blood_Name)','@(BloodDataList[i].Blood_Number)','@(BloodDataList[i].Blood_Type)','@(BloodDataList[i].Blood_Unit)','@(BloodDataList[i].Blood_Exp)');" />
                                            }
                                        </td>
                                        <td style="width: 10%; text-align: center; ">
                                            @if (@BloodDataList[i].Blood_Time != null && @BloodDataList[i].Blood_Time.ToString().Trim() != "")
                                            {
                                                @Blood_Time_Date<br>@Blood_Time_Time
                                            }
                                        </td>
                                        <td style="width: 20%; height: 35px; ">
                                            @if (@BloodDataList[i].Blood_Name != null && @BloodDataList[i].Blood_Name.ToString().Trim() != "")
                                            {@BloodDataList[i].Blood_Name}
                                        </td>
                                        <td style="width: 10%; text-align: center; ">
                                            @if (@BloodDataList[i].Blood_Number != null && @BloodDataList[i].Blood_Number.ToString().Trim() != "")
                                            {@BloodDataList[i].Blood_Number}
                                        </td>
                                        <td style="width: 10%; text-align: center; ">
                                            @if (@BloodDataList[i].Blood_Type != null && @BloodDataList[i].Blood_Type.ToString().Trim() != "")
                                            {@BloodDataList[i].Blood_Type}
                                        </td>
                                        <td style="width: 10%; text-align: center; ">
                                            @if (@BloodDataList[i].Blood_Unit != null && @BloodDataList[i].Blood_Unit.ToString().Trim() != "")
                                            {@BloodDataList[i].Blood_Unit}
                                        </td>
                                        <td style="width: 10%; text-align: center; ">
                                            @if (@BloodDataList[i].Blood_Exp != null && @BloodDataList[i].Blood_Exp.ToString().Trim() != "")
                                            {@BloodDataList[i].Blood_Exp}
                                        </td>
                                        <td style="width: 10%; text-align: center; ">
                                            @if (blood_id_list.Contains((BloodDataList[i].Blood_ID)))
                                            {
                                                <label>是</label>
                                            }
                                        </td>
                                        <td style="width: 10%; text-align: center">
                                            @if (blood_id_list.Contains((BloodDataList[i].Blood_ID)))
                                            {
                                                if (BLOODID_List.Count > 0)
                                                {
                                                    var record_Date = "";
                                                    var record_Time = "";
                                                    foreach (var data in BLOODID_List)
                                                    {
                                                        if (data["blood_id"] == BloodDataList[i].Blood_ID)
                                                        {
                                                            record_Date = DateTime.Parse(data["record_time"]).ToString("yyyy/MM/dd");
                                                            record_Time = DateTime.Parse(data["record_time"]).ToString("HH:mm");
                                                        }
                                                    }
                                                    @record_Date <br>
                                                    @record_Time
                                                }
                                            }
                                        </td>
                                    </tr>
                                }
                            }
                        }
                    </table>
                </div>
            </td>
        </tr>
    </table>
</div>