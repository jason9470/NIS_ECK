@using System.Data;
@using NIS.Data;
@{
    Layout = "~/Views/Layout/FormLayout.cshtml";
    //日期選擇器，鎖定時間
    NIS.Data.PatientInfo pf = (NIS.Data.PatientInfo)Session["PatInfo"];
    NIS.Data.Complement_List complement_List = (NIS.Data.Complement_List)Session["Complement_List"];
}

<style type="text/css">
    .dataArea td {
        border-bottom: 1px solid rgba(20%,20%,40%,0.5);
        text-align: left;
        height: 26px;
    }
</style>

<div class="funcArea">
    <div style="padding-bottom:10px;">
        <span style="color:blue;font-size:26px;">查詢EKG資料</span>
        <input type="text" id="stDate" value="@(DateTime.Now.ToString("yyyy/MM/dd"))" onchange="SearchTime();" />
        <input type="text" id="stTime" value="@(DateTime.Now.AddMinutes(-3).ToString("HH:mm"))" onchange="SearchTime();" />
        @WebTool.complementList_Status(complement_List.Status, pf.InDate.ToString("MM/dd/yyyy HH:mm"), @DateTime.Now.ToString("yyyy/MM/dd"), "stDate", "stTime", false)
        ~
        <label id="endTime">@DateTime.Now.ToString("HH:mm")</label>分 &nbsp 導程:&nbsp

        <select id="ChooseLEAD">
            <option value="I">I</option>
            <option value="II" selected>II</option>
            <option value="III">III</option>
            <option value="V">V</option>
            <option value="aVL">aVL</option>
            <option value="aVR">aVR</option>
            <option value="aVF">aVF</option>
        </select>&nbsp
        <input type="button" value="查詢" onclick="Search()" />
    </div>
    <div class="dataArea" style="overflow:hidden;height:100%;">
        <table border="0" cellpadding="4" cellspacing="1" style="width:100%;">
            <tr>
                <th>EKG</th>
            </tr>
            <tr>
                <td style="text-align:center;">
                    <div id="CutECK" style="display:none;">
                        <input type="button" value="截圖" onclick="toCutImg();" />
                        <div style="color:red;">※截圖完畢視窗會自己關閉!請勿自行關閉視窗。</div>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div style="overflow-x:auto;overflow-y:hidden;position:relative;" id="ImgArea">
                        <div style="text-align:center;color:red;">※請選擇需要的時間，並按查詢。</div>
                    </div>
                    @*//要裁剪的座標和寬高*@
                    @Html.Hidden("x1", 40)
                    @Html.Hidden("y1", 0)
                    @Html.Hidden("width", 900)
                    @Html.Hidden("height", 300)
                </td>
            </tr>
            <tr></tr>
        </table>
    </div>
</div>

<div class="loading" id="cover"></div>
<div class="loading" id="loading">
    <label for="lab">Loading...</label><br />
    <img src="~/Images/loading.gif" alt="" border="0" />
</div>

<script type="text/javascript">
    var ImgData, img, VS_TIME;
    $(function () {
        // 加入focus事件
        $(window).focus(function () {
            window.opener.parent.check_session();
        }).resize(function () {
            $("#ImgArea").outerWidth($(this).outerWidth() - 10);
        }).trigger("resize");
        setGridColor();

        $('#ImgArea').scroll(function (e) {
            if (!!img)
                img.setOptions({ 'x1': $(this).scrollLeft() + 40, 'y1': 0, 'x2': $(this).scrollLeft() + 940, 'y2': 300 });
        });

        //SetDateTime($("#stDate"), $("#stTime"))
    });

    //格行換色
    function setGridColor() {
        var tr = $('.dataArea tr');
        var color = '#ABC8E2';
        for (var i = 0; i < tr.length; i++) {
            if ($(tr[i]).css('display') != 'none') {
                $(tr[i]).css('background', color);
                if (color == '#ABC8E2')
                    color = '#E1E6FA';
                else
                    color = '#ABC8E2';
            }
        }
        $('.head').css('background', '#85A5CC');
    }

    //查詢時間修改時預設結束時間加3分鐘
    function SearchTime() {
        var temp = new Date($('#stDate').val() + ' ' + $('#stTime').val());
        temp.setMinutes(temp.getMinutes() + 3);
        var htemp = temp.getHours().toString(), mtemp = temp.getMinutes().toString();
        if (htemp.length < 2)
            htemp = '0' + htemp;
        if (mtemp.length < 2)
            mtemp = '0' + mtemp;

        $('#endTime').html(htemp + ":" + mtemp);
    }

    function Search() {
        $(".loading").fadeIn(500);
        $('#CutECK').hide();
        $.ajax({
            type: 'POST',
            url: '@Url.Content("~/CareRecord/SearchECKImage")',
            data: {
                'SearchDateTime': $('#stDate').val() + ' ' + $('#stTime').val(),
                'LEADS': $('#ChooseLEAD option:selected').val()
            },
            cache: false,
            success: function (data) {
                ImgData = data;
                $('#ImgArea').html('<image id="sourceImage" src="data:image/png;base64,' + ImgData + '" style="height:300px;" />');
                img = $('#sourceImage').imgAreaSelect({
                    instance: true,
                    movable: false,
                    //不可縮放selection area
                    resizable: false,
                    //不會重新開始一個新的selection area
                    persistent: true,
                    //selection area的寬高比例
                    aspectRatio: '1:1',
                    //selection area的預設寬高
                    x1: 40, y1: 0, x2: 940, y2: 300,
                    parent: '#ImgArea'
                });
            },
            complete: function () {
                $('#CutECK').show();
                $(".loading").fadeOut(500);
            }
        });
    }



    function toCutImg() {
        var getdatetime = moment($('#stDate').val() + " " + $('#stTime').val());
        if ($('#ImgArea').scrollLeft() > 8997 && $('#ImgArea').scrollLeft() < 17994) {
            getdatetime.add(1, 'minutes');
        }
        if ($('#ImgArea').scrollLeft() > 17994) {
            getdatetime.add(2, 'minutes');
        }
        var vs_time = getdatetime.format('HH:mm');

        //VS_TIME = vs_time + " ";
        //var vs_content = vs_time + " ";
        //用 vs_time 傳入取得該時間點 Vital Sign 數值
        //vs_content += "HR:80/min, RR:16/min, SPO2:97%, BP:128/67";
        //window.opener.document.getElementById('record_com').value += vs_content;

        if (!!ImgData && !!img) {
            $(".loading").fadeIn(500);
            var p = img.getSelection();
            $.ajax({
                type: 'POST',
                url: '@Url.Content("~/CareRecord/CutECKImage")',
                data: {
                    'ImgDate': ImgData,
                    'x': p.x1,
                    'y': p.y1,
                    'width': p.width,
                    'height': p.height,
                },
                success: function (data) {
                    GetVitalSign(vs_time);
                    window.opener.document.getElementById('@ViewData["openerDataId"]').value = data;
                    $(window.opener.document.getElementById('@ViewData["openerImgId"]')).html('<image src="data:image/png;base64,' + data + '" style="height:300px;" />');
                },
                complete: function () {
                    window.close();
                }
            });

        }
        //GetVitalSign()
    }
    //GetVitalSign()

    function GetVitalSign(vs_time) {
        $.ajax({
            type: 'POST',
            url: '@Url.Content("~/CareRecord/GetVitalSign1")',
            async: false,
            data: {
                'vs_date': $('#stDate').val(),
                //'vs_time': $('#stTime').val()
                'vs_time': vs_time
            },
            success: function (data) {
                var vs_content = data;
                window.opener.document.getElementById('record_com').value = vs_content;
                ////var vs_content = data
                //for (var i in data) {

                //    for (var i = 0; i < data.length; i++) {
                //        var vs_content = this[i].toString();
                //        //var vs_content = "HR:80/min, RR:16/min, SPO2:97%, BP:128/67";
                //        window.opener.document.getElementById('record_com').value += vs_content;
                //    }

                //}
            },
            complete: function () {
                //window.close();
            }
        });
    }

    //綁定DateTimePicker
    function SetDateTime(DateObj, TimeObj) {
        DateObj.prop('readonly', true).css({ 'width': '80px', 'font-size': '12px' });
        TimeObj.prop('readonly', true).css({ 'width': '50px', 'font-size': '12px' });
        DateObj.datetimepicker({
            altField: TimeObj,
            beforeShowDay: function (date) {
                switch (date.getDay()) {
                    case 6:
                        return [true, 'satday'];
                        break;
                    case 0:
                        return [true, 'sunday'];
                        break;
                    default:
                        return [true, ''];
                        break;
                }
            },
            inline: true,
            showAnim: "slideDown",
            controlType: myControl,
            maxDateTime: new Date(),
        });
    }

</script>