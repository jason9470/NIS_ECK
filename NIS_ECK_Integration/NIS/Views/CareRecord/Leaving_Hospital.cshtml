@using System.Data;
@{
    ViewBag.Title = "Leaving_Hospital";
    Layout = "~/Views/Layout/FormLayout.cshtml";
    DataTable dt_care_plan_master = ViewBag.dt_care_plan_master;
    DataTable dt_care_plan_object = ViewBag.dt_care_plan_object;
    string msg = ViewBag.msg;
    //日期選擇器，鎖定時間
    NIS.Data.PatientInfo pf = (NIS.Data.PatientInfo)Session["PatInfo"];
    NIS.Data.Complement_List complement_List = (NIS.Data.Complement_List)Session["Complement_List"];
}
<style type="text/css">
    .dataArea td {
        border-bottom: 1px solid rgba(20%,20%,40%,0.5);
        text-align: left;
        height:26px;
    }
</style>

<script type="text/javascript">
    $(function () {
        // 加入focus事件
        $(window).focus(function () {
            window.opener.parent.check_session();
        });
        setGridColor();
    });

    //格行換色
    function setGridColor() {
        var tr = $('.dataArea tr');
        var color = '#ABC8E2';
        for (var i = 0; i < tr.length; i++) {
            if ($(tr[i]).css('display') != 'none') {
                $(tr[i]).css('background', color);
                if (color == '#ABC8E2')
                    color = '#E1E6FA';
                else
                    color = '#ABC8E2';
            }
        }
        $('.head').css('background', '#85A5CC');
    }

    function able(id) {
        document.getElementById(id).disabled = false;
        document.getElementById(id).focus();
    }
    function enable(id) {
        document.getElementById(id).disabled = true;
        $('#' + id).val('');
    }

    function div_hidden(id_list) {
        var list = id_list.split(',');
        for (var i = 0 ; i < list.length; i++) {
            $('.' + list[i]).fadeOut(0);
            var input_list = $('.' + list[i] + ' input, .' + list[i] + ' textarea');
            for (var j = 0 ; j < input_list.length; j++) {
                if (input_list[j].type == "textarea" || input_list[j].type == 'text')
                    $(input_list[j]).val('');
                else if  (input_list[j].type == 'radio')
                    input_list[j].checked = false;
                else {
                    if (input_list[j].checked)
                        $(input_list[j]).click();
                }
            }
        }
    }

    function add() {
        var content = '@Html.Raw(msg.Replace("'", ""))';
        var num = $('input[name=rb_leave]:checked').val();
        if (num == undefined) {
            alert('請選擇出院狀態');
            return false;
        }
        else {
            content = content.replace('#leav_date', $('#txt_day').val() + ' ' + $('#txt_time').val());
            if (num == '0')
                content += '經醫師診視允許病人在' + $('#txt_day').val() + ' ' + $('#txt_time').val() + '出院，予以藥物衛教，並告知緊急返診之情形，安排於____/____/____返診。';
            else if (num == '1')
                content += '經醫師診視允許病人在' + $('#txt_day').val() + ' ' + $('#txt_time').val() + '出院，不需安排門診追蹤。';
            else if (num == '2')
                content += '經醫師診視病人於' + $('#txt_day').val() + ' ' + $('#txt_time').val() + '治癒出院。';
            else if (num == '3')
                content += '因病人狀況__________，於' + $('#txt_day').val() + ' ' + $('#txt_time').val() + '病危自動出院。';
            else if (num == '4')
                content += '因病人__________，於' + $('#txt_day').val() + ' ' + $('#txt_time').val() + '非病危自動出院。';
            else if (num == '5')
                content += '經醫師診視病人於' + $('#txt_day').val() + ' ' + $('#txt_time').val() + '轉至' + $('#txt_leave_6').val() + '進行後續照護、治療。';
            else if (num == '6')
                content += '因病人__________，於' + $('#txt_day').val() + ' ' + $('#txt_time').val() + '由醫師__________宣告死亡。';
            else if (num == '7')
                content += '病人於' + $('#txt_day').val() + ' ' + $('#txt_time').val() + '未經請假擅自離院，已通知__________。';
            else if (num == '8')
                content += '因' + $('#txt_leave_other').val() + '，病人於' + $('#txt_day').val() + ' ' + $('#txt_time').val() + '出院。';
            @*window.opener.document.getElementById('span_@ViewBag.id').innerText = window.opener.document.getElementById('span_@ViewBag.id').innerText + content;
            window.opener.document.getElementById('hid_@ViewBag.id').value = window.opener.document.getElementById('hid_@ViewBag.id').value + content;
            window.opener.document.getElementById('@ViewBag.id').innerText = window.opener.document.getElementById('@ViewBag.id').innerText + content;*@
            $('#msg').val(content);
            return true;
        }
    }
</script>

<form action="Leaving_Hospital" method="post">
<div class="funcArea">
    <table border="0" cellpadding="0" cellspacing="0" style="width:100%;">
        <tr>
            <td style="padding-bottom:5px;text-align:center;">
                <span style="color:blue;font-size:26px;">出院通知</span>
            </td>
        </tr>
        <tr>
            <td style="padding:5px 0 5px 0;">
                <div class="dataHeader">
                    <table border="0" cellpadding="4" cellspacing="1" style="width:100%;">
                        <tr>
                            <td style="width:25%;">項目</td>
                            <td style="width:75%;">內容</td>
                        </tr>
                    </table>
                </div>
                <div class="dataArea" style="height:260px;">
                    <table border="0" cellpadding="4" cellspacing="1" style="width:100%;">
                        <tr>
                            <td style="width:25%;">入院時間日期</td>
                            <td style="width:75%;">
                                @ViewBag.Indate
                            </td>
                        </tr>
                        <tr>
                            <td style="width:25%;">出院時間日期</td>
                            <td style="width:75%;">
                                @Html.TextBox("txt_day", DateTime.Now.ToString("yyyy/MM/dd"), new { style = "width:80px", @readonly = "readonly" })
                                @Html.TextBox("txt_time", DateTime.Now.ToString("HH:mm"), new { style = "width:50px", @readonly = "readonly" })
                                @WebTool.complementList_Status(complement_List.Status, pf.InDate.ToString("MM/dd/yyyy HH:mm"), @DateTime.Now.ToString("yyyy/MM/dd"), "txt_day", "txt_time", false)
                                <input type="hidden" id="msg" name="msg" />
                                @*@WebTool.setDateTime("txt_day", "txt_time")*@
                            </td>
                        </tr>
                        <tr>
                            <td style="width:25%;">出院狀態</td>
                            <td style="width:75%;">
                                <div style="height:30px;">
                                    @Html.RadioButton("rb_leave", "0", false, new { id = "rb_leave_1", onclick = "enable('txt_leave_6');enable('txt_leave_other');" })
                                    @Html.Label("rb_leave_1", "出院，需門診追蹤治療")
                                    @Html.RadioButton("rb_leave", "1", false, new { id = "rb_leave_2", onclick = "enable('txt_leave_6');enable('txt_leave_other');" })
                                    @Html.Label("rb_leave_2", "出院，不需門診追蹤治療")
                                </div>
                                <div style="height:30px;">
                                    @Html.RadioButton("rb_leave", "2", false, new { id = "rb_leave_3", onclick = "enable('txt_leave_6');enable('txt_leave_other');" })
                                    @Html.Label("rb_leave_3", "治癒出院")
                                    @Html.RadioButton("rb_leave", "3", false, new { id = "rb_leave_4", onclick = "enable('txt_leave_6');enable('txt_leave_other');" })
                                    @Html.Label("rb_leave_4", "病危自動出院")
                                    @Html.RadioButton("rb_leave", "4", false, new { id = "rb_leave_5", onclick = "enable('txt_leave_6');enable('txt_leave_other');" })
                                    @Html.Label("rb_leave_5", "非病危自動出院")
                                </div>
                                <div style="height:30px;">
                                    @Html.RadioButton("rb_leave", "5", false, new { id = "rb_leave_6", onclick = "able('txt_leave_6');enable('txt_leave_other');" })
                                    @Html.Label("rb_leave_6", "轉院，轉出院所：")
                                    @Html.TextBox("txt_leave_6", "", new { disabled = "disabled" })
                                </div>
                                <div style="height:30px;">
                                    @Html.RadioButton("rb_leave", "6", false, new { id = "rb_leave_7", onclick = "enable('txt_leave_6');enable('txt_leave_other');" })
                                    @Html.Label("rb_leave_7", "死亡")
                                    @Html.RadioButton("rb_leave", "7", false, new { id = "rb_leave_8", onclick = "enable('txt_leave_6');enable('txt_leave_other');" })
                                    @Html.Label("rb_leave_8", "潛逃")
                                    @Html.RadioButton("rb_leave", "8", false, new { id = "rb_leave_other", onclick = "enable('txt_leave_6');able('txt_leave_other');" })
                                    @Html.Label("rb_leave_other", "其他")
                                    @Html.TextBox("txt_leave_other", "", new { disabled = "disabled" })
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td style="width:25%;">未評值目標項目</td>
                            <td style="width:75%;">
                                @foreach (DataRow r in dt_care_plan_master.Rows)
                                {
                                    int i = 0;
                                    
                                    <div style="padding-top:5px;color:blue;">
                                    @r["topicdesc"]
                                    @foreach (DataRow obj_r in dt_care_plan_object.Rows)
                                    {
                                        if (r["recordid"].ToString() == obj_r["recordid"].ToString())
                                        {
                                            <input type="hidden" name="id_list" value="@obj_r["serial"]" />
                                            i++;
                                        <div style="padding:5px 0 0 2px;color:blue;">
                                    @Html.Raw(i.ToString() + ". " + obj_r["alltargetcontent"] + "<br />")
                                        </div>
                                        
                                        <div style="padding:5px 0 5px 0;border-bottom: 1px solid rgba(20%,20%,40%,0.5);">
                                        <label><input type="radio" name="@obj_r["serial"]" value="Y" onclick="div_hidden('span_@obj_r["serial"]');" />已達成</label>
                                        <label><input type="radio" name="@obj_r["serial"]" value="N" onclick="div_hidden('span_@obj_r["serial"]');" />未達成</label>
                                        <label><input type="radio" name="@obj_r["serial"]" value="C" onclick="$('.span_@obj_r["serial"]').fadeIn(500);" />不適用</label>
                                        <span class="span_@obj_r["serial"]" style="display:none;">
                                            ，原因 @Html.TextBox(obj_r["serial"] + "_reason", "", new { style = "width:100px;" })
                                        </span>
                                        </div>
                                        }
                                    }
                                    </div>
                                    
                                }
                            </td>
                        </tr>
                    </table>
                </div>
            </td>
        </tr>
        <tr>
            <td style="padding:5px 0 5px 0;text-align:center;">
                <div class="funcArea">
                    <input type="button" value="儲存" style="width:60px;" onclick="if (add()) { submit();}" />
                    <input type="button" value="取消" style="width:60px;" onclick="if (confirm('確認取消?')) window.close();" />
                </div>
            </td>
        </tr>
    </table>
</div>
</form>